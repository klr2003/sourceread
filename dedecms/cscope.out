cscope 15 /opt/lampp/htdocs/demo/dedecms -q 0000005299 0001864137
	@data/downmix.data.php

1 <?
	gphp


8 #,
dedecms
.
com


9 #,
cyright
 
dedecms


10 #,内容来自
dedecms


	@data/enums/area.php

1 <?
php


2 
glob
 
	g$em_s
;

3 
	g$em_s
 = 
y
();

4 
	g$em_s
[0][] = '1,北京市';

5 
	g$em_s
[1][] = '102,西城区';

6 
	g$em_s
[1][] = '126,崇文区';

7 
	g$em_s
[1][] = '104,宣武区';

8 
	g$em_s
[1][] = '105,朝阳区';

9 
	g$em_s
[1][] = '106,海淀区';

10 
	g$em_s
[1][] = '107,丰台区';

11 
	g$em_s
[1][] = '108,石景山区';

12 
	g$em_s
[1][] = '109,门头沟区';

13 
	g$em_s
[1][] = '110,房山区';

14 
	g$em_s
[1][] = '111,通州区';

15 
	g$em_s
[1][] = '112,顺义区';

16 
	g$em_s
[1][] = '113,昌平区';

17 
	g$em_s
[1][] = '114,大兴区';

18 
	g$em_s
[1][] = '115,平谷县';

19 
	g$em_s
[1][] = '116,怀柔县';

20 
	g$em_s
[1][] = '117,密云县';

21 
	g$em_s
[1][] = '118,延庆县';

22 
	g$em_s
[0][] = '2,上海市';

23 
	g$em_s
[2][] = '201,黄浦区';

24 
	g$em_s
[2][] = '202,卢湾区';

25 
	g$em_s
[2][] = '203,徐汇区';

26 
	g$em_s
[2][] = '204,长宁区';

27 
	g$em_s
[2][] = '205,静安区';

28 
	g$em_s
[2][] = '206,普陀区';

29 
	g$em_s
[2][] = '207,闸北区';

30 
	g$em_s
[2][] = '208,虹口区';

31 
	g$em_s
[2][] = '209,杨浦区';

32 
	g$em_s
[2][] = '210,宝山区';

33 
	g$em_s
[2][] = '211,闵行区';

34 
	g$em_s
[2][] = '212,嘉定区';

35 
	g$em_s
[2][] = '213,浦东新区';

36 
	g$em_s
[2][] = '214,松江区';

37 
	g$em_s
[2][] = '215,金山区';

38 
	g$em_s
[2][] = '216,青浦区';

39 
	g$em_s
[2][] = '217,南汇区';

40 
	g$em_s
[2][] = '218,奉贤区';

41 
	g$em_s
[2][] = '219,崇明县';

42 
	g$em_s
[0][] = '3,天津市';

43 
	g$em_s
[3][] = '301,和平区';

44 
	g$em_s
[3][] = '302,河东区';

45 
	g$em_s
[3][] = '303,河西区';

46 
	g$em_s
[3][] = '304,南开区';

47 
	g$em_s
[3][] = '305,河北区';

48 
	g$em_s
[3][] = '306,红桥区';

49 
	g$em_s
[3][] = '307,塘沽区';

50 
	g$em_s
[3][] = '308,汉沽区';

51 
	g$em_s
[3][] = '309,大港区';

52 
	g$em_s
[3][] = '310,东丽区';

53 
	g$em_s
[3][] = '311,西青区';

54 
	g$em_s
[3][] = '312,北辰区';

55 
	g$em_s
[3][] = '313,津南区';

56 
	g$em_s
[3][] = '314,武清区';

57 
	g$em_s
[3][] = '315,宝坻区';

58 
	g$em_s
[3][] = '316,静海县';

59 
	g$em_s
[3][] = '317,宁河县';

60 
	g$em_s
[3][] = '318,蓟县';

61 
	g$em_s
[0][] = '4,重庆市';

62 
	g$em_s
[4][] = '401,渝中区';

63 
	g$em_s
[4][] = '402,大渡口区';

64 
	g$em_s
[4][] = '403,江北区';

65 
	g$em_s
[4][] = '404,沙坪坝区';

66 
	g$em_s
[4][] = '405,九龙坡区';

67 
	g$em_s
[4][] = '406,南岸区';

68 
	g$em_s
[4][] = '407,北碚区';

69 
	g$em_s
[4][] = '408,万盛区';

70 
	g$em_s
[4][] = '409,双桥区';

71 
	g$em_s
[4][] = '410,渝北区';

72 
	g$em_s
[4][] = '411,巴南区';

73 
	g$em_s
[4][] = '412,万州区';

74 
	g$em_s
[4][] = '413,涪陵区';

75 
	g$em_s
[4][] = '414,黔江区';

76 
	g$em_s
[4][] = '415,永川市';

77 
	g$em_s
[4][] = '416,合川市';

78 
	g$em_s
[4][] = '417,江津市';

79 
	g$em_s
[4][] = '418,南川市';

80 
	g$em_s
[4][] = '419,长寿县';

81 
	g$em_s
[4][] = '420,綦江县';

82 
	g$em_s
[4][] = '421,潼南县';

83 
	g$em_s
[4][] = '422,荣昌县';

84 
	g$em_s
[4][] = '423,璧山县';

85 
	g$em_s
[4][] = '424,大足县';

86 
	g$em_s
[4][] = '425,铜梁县';

87 
	g$em_s
[4][] = '426,梁平县';

88 
	g$em_s
[4][] = '427,城口县';

89 
	g$em_s
[4][] = '428,垫江县';

90 
	g$em_s
[4][] = '429,武隆县';

91 
	g$em_s
[4][] = '430,丰都县';

92 
	g$em_s
[4][] = '431,奉节县';

93 
	g$em_s
[4][] = '432,开县';

94 
	g$em_s
[4][] = '433,云阳县';

95 
	g$em_s
[4][] = '434,忠县';

96 
	g$em_s
[4][] = '435,巫溪县';

97 
	g$em_s
[4][] = '436,巫山县';

98 
	g$em_s
[4][] = '437,石柱县';

99 
	g$em_s
[4][] = '438,秀山县';

100 
	g$em_s
[4][] = '439,酉阳县';

101 
	g$em_s
[4][] = '440,彭水县';

102 
	g$em_s
[0][] = '5,广东省';

103 
	g$em_s
[5][] = '501,广州市';

104 
	g$em_s
[5][] = '502,深圳市';

105 
	g$em_s
[5][] = '503,珠海市';

106 
	g$em_s
[5][] = '504,汕头市';

107 
	g$em_s
[5][] = '505,韶关市';

108 
	g$em_s
[5][] = '506,河源市';

109 
	g$em_s
[5][] = '507,梅州市';

110 
	g$em_s
[5][] = '508,惠州市';

111 
	g$em_s
[5][] = '509,汕尾市';

112 
	g$em_s
[5][] = '510,东莞市';

113 
	g$em_s
[5][] = '511,中山市';

114 
	g$em_s
[5][] = '512,江门市';

115 
	g$em_s
[5][] = '513,佛山市';

116 
	g$em_s
[5][] = '514,阳江市';

117 
	g$em_s
[5][] = '515,湛江市';

118 
	g$em_s
[5][] = '516,茂名市';

119 
	g$em_s
[5][] = '517,肇庆市';

120 
	g$em_s
[5][] = '518,清远市';

121 
	g$em_s
[5][] = '519,潮州市';

122 
	g$em_s
[5][] = '520,揭阳市';

123 
	g$em_s
[5][] = '521,云浮市';

124 
	g$em_s
[0][] = '6,福建省';

125 
	g$em_s
[6][] = '601,福州市';

126 
	g$em_s
[6][] = '602,厦门市';

127 
	g$em_s
[6][] = '603,三明市';

128 
	g$em_s
[6][] = '604,莆田市';

129 
	g$em_s
[6][] = '605,泉州市';

130 
	g$em_s
[6][] = '606,漳州市';

131 
	g$em_s
[6][] = '607,南平市';

132 
	g$em_s
[6][] = '608,龙岩市';

133 
	g$em_s
[6][] = '609,宁德市';

134 
	g$em_s
[0][] = '7,浙江省';

135 
	g$em_s
[7][] = '701,杭州市';

136 
	g$em_s
[7][] = '702,宁波市';

137 
	g$em_s
[7][] = '703,温州市';

138 
	g$em_s
[7][] = '704,嘉兴市';

139 
	g$em_s
[7][] = '705,湖州市';

140 
	g$em_s
[7][] = '706,绍兴市';

141 
	g$em_s
[7][] = '707,金华市';

142 
	g$em_s
[7][] = '708,衢州市';

143 
	g$em_s
[7][] = '709,舟山市';

144 
	g$em_s
[7][] = '710,台州市';

145 
	g$em_s
[7][] = '711,丽水市';

146 
	g$em_s
[0][] = '8,江苏省';

147 
	g$em_s
[8][] = '801,南京市';

148 
	g$em_s
[8][] = '802,徐州市';

149 
	g$em_s
[8][] = '803,连云港市';

150 
	g$em_s
[8][] = '804,淮安市';

151 
	g$em_s
[8][] = '805,宿迁市';

152 
	g$em_s
[8][] = '806,盐城市';

153 
	g$em_s
[8][] = '807,扬州市';

154 
	g$em_s
[8][] = '808,泰州市';

155 
	g$em_s
[8][] = '809,南通市';

156 
	g$em_s
[8][] = '810,镇江市';

157 
	g$em_s
[8][] = '811,常州市';

158 
	g$em_s
[8][] = '812,无锡市';

159 
	g$em_s
[8][] = '813,苏州市';

160 
	g$em_s
[0][] = '9,山东省';

161 
	g$em_s
[9][] = '901,济南市';

162 
	g$em_s
[9][] = '902,青岛市';

163 
	g$em_s
[9][] = '903,淄博市';

164 
	g$em_s
[9][] = '904,枣庄市';

165 
	g$em_s
[9][] = '905,东营市';

166 
	g$em_s
[9][] = '906,潍坊市';

167 
	g$em_s
[9][] = '907,烟台市';

168 
	g$em_s
[9][] = '908,威海市';

169 
	g$em_s
[9][] = '909,济宁市';

170 
	g$em_s
[9][] = '910,泰安市';

171 
	g$em_s
[9][] = '911,日照市';

172 
	g$em_s
[9][] = '912,莱芜市';

173 
	g$em_s
[9][] = '913,德州市';

174 
	g$em_s
[9][] = '914,临沂市';

175 
	g$em_s
[9][] = '915,聊城市';

176 
	g$em_s
[9][] = '916,滨州市';

177 
	g$em_s
[9][] = '917,菏泽市';

178 
	g$em_s
[0][] = '10,辽宁省';

179 
	g$em_s
[10][] = '1001,沈阳市';

180 
	g$em_s
[10][] = '1002,大连市';

181 
	g$em_s
[10][] = '1003,鞍山市';

182 
	g$em_s
[10][] = '1004,抚顺市';

183 
	g$em_s
[10][] = '1005,本溪市';

184 
	g$em_s
[10][] = '1006,丹东市';

185 
	g$em_s
[10][] = '1007,锦州市';

186 
	g$em_s
[10][] = '1008,葫芦岛市';

187 
	g$em_s
[10][] = '1009,营口市';

188 
	g$em_s
[10][] = '1010,盘锦市';

189 
	g$em_s
[10][] = '1011,阜新市';

190 
	g$em_s
[10][] = '1012,辽阳市';

191 
	g$em_s
[10][] = '1013,铁岭市';

192 
	g$em_s
[10][] = '1014,朝阳市';

193 
	g$em_s
[0][] = '11,江西省';

194 
	g$em_s
[11][] = '1101,南昌市';

195 
	g$em_s
[11][] = '1102,景德镇市';

196 
	g$em_s
[11][] = '1103,萍乡市';

197 
	g$em_s
[11][] = '1104,新余市';

198 
	g$em_s
[11][] = '1105,九江市';

199 
	g$em_s
[11][] = '1106,鹰潭市';

200 
	g$em_s
[11][] = '1107,赣州市';

201 
	g$em_s
[11][] = '1108,吉安市';

202 
	g$em_s
[11][] = '1109,宜春市';

203 
	g$em_s
[11][] = '1110,抚州市';

204 
	g$em_s
[11][] = '1111,上饶市';

205 
	g$em_s
[0][] = '12,四川省';

206 
	g$em_s
[12][] = '1201,成都市';

207 
	g$em_s
[12][] = '1202,自贡市';

208 
	g$em_s
[12][] = '1203,攀枝花市';

209 
	g$em_s
[12][] = '1204,泸州市';

210 
	g$em_s
[12][] = '1205,德阳市';

211 
	g$em_s
[12][] = '1206,绵阳市';

212 
	g$em_s
[12][] = '1207,广元市';

213 
	g$em_s
[12][] = '1208,遂宁市';

214 
	g$em_s
[12][] = '1209,内江市';

215 
	g$em_s
[12][] = '1210,乐山市';

216 
	g$em_s
[12][] = '1211,南充市';

217 
	g$em_s
[12][] = '1212,宜宾市';

218 
	g$em_s
[12][] = '1213,广安市';

219 
	g$em_s
[12][] = '1214,达州市';

220 
	g$em_s
[12][] = '1215,巴中市';

221 
	g$em_s
[12][] = '1216,雅安市';

222 
	g$em_s
[12][] = '1217,眉山市';

223 
	g$em_s
[12][] = '1218,资阳市';

224 
	g$em_s
[12][] = '1219,阿坝州';

225 
	g$em_s
[12][] = '1220,甘孜州';

226 
	g$em_s
[12][] = '1221,凉山州';

227 
	g$em_s
[0][] = '13,陕西省';

228 
	g$em_s
[13][] = '3114,西安市';

229 
	g$em_s
[13][] = '1302,铜川市';

230 
	g$em_s
[13][] = '1303,宝鸡市';

231 
	g$em_s
[13][] = '1304,咸阳市';

232 
	g$em_s
[13][] = '1305,渭南市';

233 
	g$em_s
[13][] = '1306,延安市';

234 
	g$em_s
[13][] = '1307,汉中市';

235 
	g$em_s
[13][] = '1308,榆林市';

236 
	g$em_s
[13][] = '1309,安康市';

237 
	g$em_s
[13][] = '1310,商洛地区';

238 
	g$em_s
[0][] = '14,湖北省';

239 
	g$em_s
[14][] = '1401,武汉市';

240 
	g$em_s
[14][] = '1402,黄石市';

241 
	g$em_s
[14][] = '1403,襄樊市';

242 
	g$em_s
[14][] = '1404,十堰市';

243 
	g$em_s
[14][] = '1405,荆州市';

244 
	g$em_s
[14][] = '1406,宜昌市';

245 
	g$em_s
[14][] = '1407,荆门市';

246 
	g$em_s
[14][] = '1408,鄂州市';

247 
	g$em_s
[14][] = '1409,孝感市';

248 
	g$em_s
[14][] = '1410,黄冈市';

249 
	g$em_s
[14][] = '1411,咸宁市';

250 
	g$em_s
[14][] = '1412,随州市';

251 
	g$em_s
[14][] = '1413,仙桃市';

252 
	g$em_s
[14][] = '1414,天门市';

253 
	g$em_s
[14][] = '1415,潜江市';

254 
	g$em_s
[14][] = '1416,神农架';

255 
	g$em_s
[14][] = '1417,恩施州';

256 
	g$em_s
[0][] = '15,河南省';

257 
	g$em_s
[15][] = '1501,郑州市';

258 
	g$em_s
[15][] = '1502,开封市';

259 
	g$em_s
[15][] = '1503,洛阳市';

260 
	g$em_s
[15][] = '1504,平顶山市';

261 
	g$em_s
[15][] = '1505,焦作市';

262 
	g$em_s
[15][] = '1506,鹤壁市';

263 
	g$em_s
[15][] = '1507,新乡市';

264 
	g$em_s
[15][] = '1508,安阳市';

265 
	g$em_s
[15][] = '1509,濮阳市';

266 
	g$em_s
[15][] = '1510,许昌市';

267 
	g$em_s
[15][] = '1511,漯河市';

268 
	g$em_s
[15][] = '1512,三门峡市';

269 
	g$em_s
[15][] = '1513,南阳市';

270 
	g$em_s
[15][] = '1514,商丘市';

271 
	g$em_s
[15][] = '1515,信阳市';

272 
	g$em_s
[15][] = '1516,周口市';

273 
	g$em_s
[15][] = '1517,驻马店市';

274 
	g$em_s
[15][] = '1518,济源市';

275 
	g$em_s
[0][] = '16,河北省';

276 
	g$em_s
[16][] = '1601,石家庄市';

277 
	g$em_s
[16][] = '1602,唐山市';

278 
	g$em_s
[16][] = '1603,秦皇岛市';

279 
	g$em_s
[16][] = '1604,邯郸市';

280 
	g$em_s
[16][] = '1605,邢台市';

281 
	g$em_s
[16][] = '1606,保定市';

282 
	g$em_s
[16][] = '1607,张家口市';

283 
	g$em_s
[16][] = '1608,承德市';

284 
	g$em_s
[16][] = '1609,沧州市';

285 
	g$em_s
[16][] = '1610,廊坊市';

286 
	g$em_s
[16][] = '1611,衡水市';

287 
	g$em_s
[0][] = '17,山西省';

288 
	g$em_s
[17][] = '1701,太原市';

289 
	g$em_s
[17][] = '1702,大同市';

290 
	g$em_s
[17][] = '1703,阳泉市';

291 
	g$em_s
[17][] = '1704,长治市';

292 
	g$em_s
[17][] = '1705,晋城市';

293 
	g$em_s
[17][] = '1706,朔州市';

294 
	g$em_s
[17][] = '1707,晋中市';

295 
	g$em_s
[17][] = '1708,忻州市';

296 
	g$em_s
[17][] = '1709,临汾市';

297 
	g$em_s
[17][] = '1710,运城市';

298 
	g$em_s
[17][] = '1711,吕梁地区';

299 
	g$em_s
[0][] = '18,内蒙古';

300 
	g$em_s
[18][] = '1801,呼和浩特';

301 
	g$em_s
[18][] = '1802,包头市';

302 
	g$em_s
[18][] = '1803,乌海市';

303 
	g$em_s
[18][] = '1804,赤峰市';

304 
	g$em_s
[18][] = '1805,通辽市';

305 
	g$em_s
[18][] = '1806,鄂尔多斯';

306 
	g$em_s
[18][] = '1807,乌兰察布';

307 
	g$em_s
[18][] = '1808,锡林郭勒';

308 
	g$em_s
[18][] = '1809,呼伦贝尔';

309 
	g$em_s
[18][] = '1810,巴彦淖尔';

310 
	g$em_s
[18][] = '1811,阿拉善盟';

311 
	g$em_s
[18][] = '1812,兴安盟';

312 
	g$em_s
[0][] = '19,吉林省';

313 
	g$em_s
[19][] = '1901,长春市';

314 
	g$em_s
[19][] = '1902,吉林市';

315 
	g$em_s
[19][] = '1903,四平市';

316 
	g$em_s
[19][] = '1904,辽源市';

317 
	g$em_s
[19][] = '1905,通化市';

318 
	g$em_s
[19][] = '1906,白山市';

319 
	g$em_s
[19][] = '1907,松原市';

320 
	g$em_s
[19][] = '1908,白城市';

321 
	g$em_s
[19][] = '1909,延边州';

322 
	g$em_s
[0][] = '20,黑龙江';

323 
	g$em_s
[20][] = '2001,哈尔滨市';

324 
	g$em_s
[20][] = '2002,齐齐哈尔';

325 
	g$em_s
[20][] = '2003,鹤岗市';

326 
	g$em_s
[20][] = '2004,双鸭山市';

327 
	g$em_s
[20][] = '2005,鸡西市';

328 
	g$em_s
[20][] = '2006,大庆市';

329 
	g$em_s
[20][] = '2007,伊春市';

330 
	g$em_s
[20][] = '2008,牡丹江市';

331 
	g$em_s
[20][] = '2009,佳木斯市';

332 
	g$em_s
[20][] = '2010,七台河市';

333 
	g$em_s
[20][] = '2011,黑河市';

334 
	g$em_s
[20][] = '2012,绥化市';

335 
	g$em_s
[20][] = '2013,大兴安岭';

336 
	g$em_s
[0][] = '21,安徽省';

337 
	g$em_s
[21][] = '2101,合肥市';

338 
	g$em_s
[21][] = '2102,芜湖市';

339 
	g$em_s
[21][] = '2103,蚌埠市';

340 
	g$em_s
[21][] = '2104,淮南市';

341 
	g$em_s
[21][] = '2105,马鞍山市';

342 
	g$em_s
[21][] = '2106,淮北市';

343 
	g$em_s
[21][] = '2107,铜陵市';

344 
	g$em_s
[21][] = '2108,安庆市';

345 
	g$em_s
[21][] = '2109,黄山市';

346 
	g$em_s
[21][] = '2110,滁州市';

347 
	g$em_s
[21][] = '2111,阜阳市';

348 
	g$em_s
[21][] = '2112,宿州市';

349 
	g$em_s
[21][] = '2113,巢湖市';

350 
	g$em_s
[21][] = '2114,六安市';

351 
	g$em_s
[21][] = '2115,亳州市';

352 
	g$em_s
[21][] = '2116,宣城市';

353 
	g$em_s
[21][] = '2117,池州市';

354 
	g$em_s
[0][] = '22,湖南省';

355 
	g$em_s
[22][] = '2201,长沙市';

356 
	g$em_s
[22][] = '2202,株州市';

357 
	g$em_s
[22][] = '2203,湘潭市';

358 
	g$em_s
[22][] = '2204,衡阳市';

359 
	g$em_s
[22][] = '2205,邵阳市';

360 
	g$em_s
[22][] = '2206,岳阳市';

361 
	g$em_s
[22][] = '2207,常德市';

362 
	g$em_s
[22][] = '2208,张家界市';

363 
	g$em_s
[22][] = '2209,益阳市';

364 
	g$em_s
[22][] = '2210,郴州市';

365 
	g$em_s
[22][] = '2211,永州市';

366 
	g$em_s
[22][] = '2212,怀化市';

367 
	g$em_s
[22][] = '2213,娄底市';

368 
	g$em_s
[22][] = '2214,湘西州';

369 
	g$em_s
[0][] = '23,广西区';

370 
	g$em_s
[23][] = '2301,南宁市';

371 
	g$em_s
[23][] = '2302,柳州市';

372 
	g$em_s
[23][] = '2303,桂林市';

373 
	g$em_s
[23][] = '2304,梧州市';

374 
	g$em_s
[23][] = '2305,北海市';

375 
	g$em_s
[23][] = '2306,防城港市';

376 
	g$em_s
[23][] = '2307,钦州市';

377 
	g$em_s
[23][] = '2308,贵港市';

378 
	g$em_s
[23][] = '2309,玉林市';

379 
	g$em_s
[23][] = '2310,南宁地区';

380 
	g$em_s
[23][] = '2311,柳州地区';

381 
	g$em_s
[23][] = '2312,贺州地区';

382 
	g$em_s
[23][] = '2313,百色地区';

383 
	g$em_s
[23][] = '2314,河池地区';

384 
	g$em_s
[0][] = '24,海南省';

385 
	g$em_s
[24][] = '2401,海口市';

386 
	g$em_s
[24][] = '2402,三亚市';

387 
	g$em_s
[24][] = '2403,五指山市';

388 
	g$em_s
[24][] = '2404,琼海市';

389 
	g$em_s
[24][] = '2405,儋州市';

390 
	g$em_s
[24][] = '2406,琼山市';

391 
	g$em_s
[24][] = '2407,文昌市';

392 
	g$em_s
[24][] = '2408,万宁市';

393 
	g$em_s
[24][] = '2409,东方市';

394 
	g$em_s
[24][] = '2410,澄迈县';

395 
	g$em_s
[24][] = '2411,定安县';

396 
	g$em_s
[24][] = '2412,屯昌县';

397 
	g$em_s
[24][] = '2413,临高县';

398 
	g$em_s
[24][] = '2414,白沙县';

399 
	g$em_s
[24][] = '2415,昌江县';

400 
	g$em_s
[24][] = '2416,乐东县';

401 
	g$em_s
[24][] = '2417,陵水县';

402 
	g$em_s
[24][] = '2418,保亭县';

403 
	g$em_s
[24][] = '2419,琼中县';

404 
	g$em_s
[0][] = '25,云南省';

405 
	g$em_s
[25][] = '2501,昆明市';

406 
	g$em_s
[25][] = '2502,曲靖市';

407 
	g$em_s
[25][] = '2503,玉溪市';

408 
	g$em_s
[25][] = '2504,保山市';

409 
	g$em_s
[25][] = '2505,昭通市';

410 
	g$em_s
[25][] = '2506,思茅地区';

411 
	g$em_s
[25][] = '2507,临沧地区';

412 
	g$em_s
[25][] = '2508,丽江地区';

413 
	g$em_s
[25][] = '2509,文山州';

414 
	g$em_s
[25][] = '2510,红河州';

415 
	g$em_s
[25][] = '2511,西双版纳';

416 
	g$em_s
[25][] = '2512,楚雄州';

417 
	g$em_s
[25][] = '2513,大理州';

418 
	g$em_s
[25][] = '2514,德宏州';

419 
	g$em_s
[25][] = '2515,怒江州';

420 
	g$em_s
[25][] = '2516,迪庆州';

421 
	g$em_s
[0][] = '26,贵州省';

422 
	g$em_s
[26][] = '2601,贵阳市';

423 
	g$em_s
[26][] = '2602,六盘水市';

424 
	g$em_s
[26][] = '2603,遵义市';

425 
	g$em_s
[26][] = '2604,安顺市';

426 
	g$em_s
[26][] = '2605,铜仁地区';

427 
	g$em_s
[26][] = '2606,毕节地区';

428 
	g$em_s
[26][] = '2607,黔西南州';

429 
	g$em_s
[26][] = '2608,黔东南州';

430 
	g$em_s
[26][] = '2609,黔南州';

431 
	g$em_s
[0][] = '27,西藏区';

432 
	g$em_s
[27][] = '2701,拉萨市';

433 
	g$em_s
[27][] = '2702,那曲地区';

434 
	g$em_s
[27][] = '2703,昌都地区';

435 
	g$em_s
[27][] = '2704,山南地区';

436 
	g$em_s
[27][] = '2705,日喀则';

437 
	g$em_s
[27][] = '2706,阿里地区';

438 
	g$em_s
[27][] = '2707,林芝地区';

439 
	g$em_s
[0][] = '28,甘肃省';

440 
	g$em_s
[28][] = '2801,兰州市';

441 
	g$em_s
[28][] = '2802,金昌市';

442 
	g$em_s
[28][] = '2803,白银市';

443 
	g$em_s
[28][] = '2804,天水市';

444 
	g$em_s
[28][] = '2805,嘉峪关市';

445 
	g$em_s
[28][] = '2806,武威市';

446 
	g$em_s
[28][] = '2807,定西地区';

447 
	g$em_s
[28][] = '2808,平凉地区';

448 
	g$em_s
[28][] = '2809,庆阳地区';

449 
	g$em_s
[28][] = '2810,陇南地区';

450 
	g$em_s
[28][] = '2811,张掖地区';

451 
	g$em_s
[28][] = '2812,酒泉地区';

452 
	g$em_s
[28][] = '2813,甘南州';

453 
	g$em_s
[28][] = '2814,临夏州';

454 
	g$em_s
[0][] = '29,宁夏区';

455 
	g$em_s
[29][] = '2901,银川市';

456 
	g$em_s
[29][] = '2902,石嘴山市';

457 
	g$em_s
[29][] = '2903,吴忠市';

458 
	g$em_s
[29][] = '2904,固原市';

459 
	g$em_s
[0][] = '30,青海省';

460 
	g$em_s
[30][] = '3001,西宁市';

461 
	g$em_s
[30][] = '3002,海东地区';

462 
	g$em_s
[30][] = '3003,海北州';

463 
	g$em_s
[30][] = '3004,黄南州';

464 
	g$em_s
[30][] = '3005,海南州';

465 
	g$em_s
[30][] = '3006,果洛州';

466 
	g$em_s
[30][] = '3007,玉树州';

467 
	g$em_s
[30][] = '3008,海西州';

468 
	g$em_s
[0][] = '31,新疆区';

469 
	g$em_s
[31][] = '3101,乌鲁木齐';

470 
	g$em_s
[31][] = '3102,克拉玛依';

471 
	g$em_s
[31][] = '3103,石河子市';

472 
	g$em_s
[31][] = '3104,吐鲁番';

473 
	g$em_s
[31][] = '3105,哈密地区';

474 
	g$em_s
[31][] = '3106,和田地区';

475 
	g$em_s
[31][] = '3107,阿克苏';

476 
	g$em_s
[31][] = '3108,喀什地区';

477 
	g$em_s
[31][] = '3109,克孜勒苏';

478 
	g$em_s
[31][] = '3110,巴音郭楞';

479 
	g$em_s
[31][] = '3111,昌吉州';

480 
	g$em_s
[31][] = '3112,博尔塔拉';

481 
	g$em_s
[31][] = '3113,伊犁州';

482 
	g$em_s
[1][] = '3117,东城区';

483 
	g$em_s
[0][] = '32,香港区';

484 
	g$em_s
[0][] = '33,澳门区';

485 
	g$em_s
[0][] = '35,台湾省';

	@data/enums/blood.php

1 <?
php


2 
glob
 
	g$em_bloods
;

3 
	g$em_bloods
 = 
y
();

4 
	g$em_bloods
[1] = 'A';

5 
	g$em_bloods
[2] = 'B';

6 
	g$em_bloods
[3] = 'AB';

7 
	g$em_bloods
[4] = 'O';

	@data/enums/bodytype.php

1 <?
php


2 
glob
 
	g$em_bodytys
;

3 
	g$em_bodytys
 = 
y
();

4 
	g$em_bodytys
[1] = '匀称';

5 
	g$em_bodytys
[2] = '苗条';

6 
	g$em_bodytys
[3] = '健壮';

7 
	g$em_bodytys
[4] = '略胖';

8 
	g$em_bodytys
[5] = '丰满';

9 
	g$em_bodytys
[6] = '瘦小';

10 
	g$em_bodytys
[7] = '高瘦';

	@data/enums/cosize.php

1 <?
php


2 
glob
 
	g$em_cosizes
;

3 
	g$em_cosizes
 = 
y
();

4 
	g$em_cosizes
[1] = '50人以下';

5 
	g$em_cosizes
[2] = '50-200人';

6 
	g$em_cosizes
[3] = '200-500人';

7 
	g$em_cosizes
[4] = '500-2000人';

8 
	g$em_cosizes
[5] = '2000-5000人';

9 
	g$em_cosizes
[6] = '5000人以上';

	@data/enums/datingtype.php

1 <?
php


2 
glob
 
	g$em_dgtys
;

3 
	g$em_dgtys
 = 
y
();

4 
	g$em_dgtys
[1] = '网友';

5 
	g$em_dgtys
[2] = '恋人';

6 
	g$em_dgtys
[3] = '玩伴';

7 
	g$em_dgtys
[4] = '共同兴趣';

8 
	g$em_dgtys
[5] = '男性朋友';

9 
	g$em_dgtys
[6] = '女性朋友';

	@data/enums/drink.php

1 <?
php


2 
glob
 
	g$em_drks
;

3 
	g$em_drks
 = 
y
();

4 
	g$em_drks
[1] = '不喝酒';

5 
	g$em_drks
[2] = '偶尔喝一点';

6 
	g$em_drks
[3] = '喝得很凶';

	@data/enums/education.php

1 <?
php


2 
glob
 
	g$em_edutis
;

3 
	g$em_edutis
 = 
y
();

4 
	g$em_edutis
[1] = '初中以上';

5 
	g$em_edutis
[2] = '高中/中专';

6 
	g$em_edutis
[3] = '大学专科';

7 
	g$em_edutis
[4] = '大学本科';

8 
	g$em_edutis
[5] = '硕士';

9 
	g$em_edutis
[6] = '博士以上';

	@data/enums/house.php

1 <?
php


2 
glob
 
	g$em_hous
;

3 
	g$em_hous
 = 
y
();

4 
	g$em_hous
[1] = '租房';

5 
	g$em_hous
[2] = '一房以上';

6 
	g$em_hous
[3] = '两房以上';

7 
	g$em_hous
[4] = '大户/别墅';

	@data/enums/income.php

1 <?
php


2 
glob
 
	g$em_comes
;

3 
	g$em_comes
 = 
y
();

4 
	g$em_comes
[1] = '低于1000元';

5 
	g$em_comes
[2] = '1000元以上';

6 
	g$em_comes
[3] = '2000元以上';

7 
	g$em_comes
[4] = '4000元以上';

8 
	g$em_comes
[5] = '8000元以上';

9 
	g$em_comes
[6] = '15000以上';

	@data/enums/infotype.php

1 <?
php


2 
glob
 
	g$em_fys
;

3 
	g$em_fys
 = 
y
();

4 
	g$em_fys
[500] = '商品';

5 
	g$em_fys
[501] = '出售';

6 
	g$em_fys
[502] = '求购';

7 
	g$em_fys
[503] = '交换';

8 
	g$em_fys
[504] = '合作';

9 
	g$em_fys
[1000] = '租房';

10 
	g$em_fys
[1001] = '出租';

11 
	g$em_fys
[1002] = '求租';

12 
	g$em_fys
[1003] = '合租';

13 
	g$em_fys
[1500] = '交友';

14 
	g$em_fys
[1501] = '找帅哥';

15 
	g$em_fys
[1502] = '找美女';

16 
	g$em_fys
[1503] = '纯友谊';

17 
	g$em_fys
[1504] = '玩伴';

18 
	g$em_fys
[2000] = '招聘';

19 
	g$em_fys
[2500] = '求职';

20 
	g$em_fys
[3000] = '票务';

21 
	g$em_fys
[3500] = '服务';

22 
	g$em_fys
[4000] = '培训';

	@data/enums/marital.php

1 <?
php


2 
glob
 
	g$em_ms
;

3 
	g$em_ms
 = 
y
();

4 
	g$em_ms
[1] = '未婚';

5 
	g$em_ms
[2] = '已婚';

6 
	g$em_ms
[3] = '离异';

7 
	g$em_ms
[4] = '丧偶';

	@data/enums/nativeplace.php

1 <?
php


2 
glob
 
	g$em_tivs
;

3 
	g$em_tivs
 = 
y
();

4 
	g$em_tivs
[500] = '北京市';

5 
	g$em_tivs
[501] = '西城区';

6 
	g$em_tivs
[502] = '宣武区';

7 
	g$em_tivs
[503] = '朝阳区';

8 
	g$em_tivs
[504] = '海淀区';

9 
	g$em_tivs
[505] = '丰台区';

10 
	g$em_tivs
[506] = '石景山区';

11 
	g$em_tivs
[507] = '门头沟区';

12 
	g$em_tivs
[508] = '房山区';

13 
	g$em_tivs
[509] = '通州区';

14 
	g$em_tivs
[510] = '顺义区';

15 
	g$em_tivs
[511] = '昌平区';

16 
	g$em_tivs
[512] = '大兴区';

17 
	g$em_tivs
[513] = '平谷县';

18 
	g$em_tivs
[514] = '怀柔县';

19 
	g$em_tivs
[515] = '密云县';

20 
	g$em_tivs
[516] = '延庆县';

21 
	g$em_tivs
[517] = '崇文区';

22 
	g$em_tivs
[518] = '东城区';

23 
	g$em_tivs
[1000] = '上海市';

24 
	g$em_tivs
[1001] = '黄浦区';

25 
	g$em_tivs
[1002] = '卢湾区';

26 
	g$em_tivs
[1003] = '徐汇区';

27 
	g$em_tivs
[1004] = '长宁区';

28 
	g$em_tivs
[1005] = '静安区';

29 
	g$em_tivs
[1006] = '普陀区';

30 
	g$em_tivs
[1007] = '闸北区';

31 
	g$em_tivs
[1008] = '虹口区';

32 
	g$em_tivs
[1009] = '杨浦区';

33 
	g$em_tivs
[1010] = '宝山区';

34 
	g$em_tivs
[1011] = '闵行区';

35 
	g$em_tivs
[1012] = '嘉定区';

36 
	g$em_tivs
[1013] = '浦东新区';

37 
	g$em_tivs
[1014] = '松江区';

38 
	g$em_tivs
[1015] = '金山区';

39 
	g$em_tivs
[1016] = '青浦区';

40 
	g$em_tivs
[1017] = '南汇区';

41 
	g$em_tivs
[1018] = '奉贤区';

42 
	g$em_tivs
[1019] = '崇明县';

43 
	g$em_tivs
[1500] = '天津市';

44 
	g$em_tivs
[1501] = '和平区';

45 
	g$em_tivs
[1502] = '河东区';

46 
	g$em_tivs
[1503] = '河西区';

47 
	g$em_tivs
[1504] = '南开区';

48 
	g$em_tivs
[1505] = '河北区';

49 
	g$em_tivs
[1506] = '红桥区';

50 
	g$em_tivs
[1507] = '塘沽区';

51 
	g$em_tivs
[1508] = '汉沽区';

52 
	g$em_tivs
[1509] = '大港区';

53 
	g$em_tivs
[1510] = '东丽区';

54 
	g$em_tivs
[1511] = '西青区';

55 
	g$em_tivs
[1512] = '北辰区';

56 
	g$em_tivs
[1513] = '津南区';

57 
	g$em_tivs
[1514] = '武清区';

58 
	g$em_tivs
[1515] = '宝坻区';

59 
	g$em_tivs
[1516] = '静海县';

60 
	g$em_tivs
[1517] = '宁河县';

61 
	g$em_tivs
[1518] = '蓟县';

62 
	g$em_tivs
[2000] = '重庆市';

63 
	g$em_tivs
[2001] = '渝中区';

64 
	g$em_tivs
[2002] = '大渡口区';

65 
	g$em_tivs
[2003] = '江北区';

66 
	g$em_tivs
[2004] = '沙坪坝区';

67 
	g$em_tivs
[2005] = '九龙坡区';

68 
	g$em_tivs
[2006] = '南岸区';

69 
	g$em_tivs
[2007] = '北碚区';

70 
	g$em_tivs
[2008] = '万盛区';

71 
	g$em_tivs
[2009] = '双桥区';

72 
	g$em_tivs
[2010] = '渝北区';

73 
	g$em_tivs
[2011] = '巴南区';

74 
	g$em_tivs
[2012] = '万州区';

75 
	g$em_tivs
[2013] = '涪陵区';

76 
	g$em_tivs
[2014] = '黔江区';

77 
	g$em_tivs
[2015] = '永川市';

78 
	g$em_tivs
[2016] = '合川市';

79 
	g$em_tivs
[2017] = '江津市';

80 
	g$em_tivs
[2018] = '南川市';

81 
	g$em_tivs
[2019] = '长寿县';

82 
	g$em_tivs
[2020] = '綦江县';

83 
	g$em_tivs
[2021] = '潼南县';

84 
	g$em_tivs
[2022] = '荣昌县';

85 
	g$em_tivs
[2023] = '璧山县';

86 
	g$em_tivs
[2024] = '大足县';

87 
	g$em_tivs
[2025] = '铜梁县';

88 
	g$em_tivs
[2026] = '梁平县';

89 
	g$em_tivs
[2027] = '城口县';

90 
	g$em_tivs
[2028] = '垫江县';

91 
	g$em_tivs
[2029] = '武隆县';

92 
	g$em_tivs
[2030] = '丰都县';

93 
	g$em_tivs
[2031] = '奉节县';

94 
	g$em_tivs
[2032] = '开县';

95 
	g$em_tivs
[2033] = '云阳县';

96 
	g$em_tivs
[2034] = '忠县';

97 
	g$em_tivs
[2035] = '巫溪县';

98 
	g$em_tivs
[2036] = '巫山县';

99 
	g$em_tivs
[2037] = '石柱县';

100 
	g$em_tivs
[2038] = '秀山县';

101 
	g$em_tivs
[2039] = '酉阳县';

102 
	g$em_tivs
[2040] = '彭水县';

103 
	g$em_tivs
[2500] = '广东省';

104 
	g$em_tivs
[2501] = '广州市';

105 
	g$em_tivs
[2502] = '深圳市';

106 
	g$em_tivs
[2503] = '珠海市';

107 
	g$em_tivs
[2504] = '汕头市';

108 
	g$em_tivs
[2505] = '韶关市';

109 
	g$em_tivs
[2506] = '河源市';

110 
	g$em_tivs
[2507] = '梅州市';

111 
	g$em_tivs
[2508] = '惠州市';

112 
	g$em_tivs
[2509] = '汕尾市';

113 
	g$em_tivs
[2510] = '东莞市';

114 
	g$em_tivs
[2511] = '中山市';

115 
	g$em_tivs
[2512] = '江门市';

116 
	g$em_tivs
[2513] = '佛山市';

117 
	g$em_tivs
[2514] = '阳江市';

118 
	g$em_tivs
[2515] = '湛江市';

119 
	g$em_tivs
[2516] = '茂名市';

120 
	g$em_tivs
[2517] = '肇庆市';

121 
	g$em_tivs
[2518] = '清远市';

122 
	g$em_tivs
[2519] = '潮州市';

123 
	g$em_tivs
[2520] = '揭阳市';

124 
	g$em_tivs
[2521] = '云浮市';

125 
	g$em_tivs
[3000] = '福建省';

126 
	g$em_tivs
[3001] = '福州市';

127 
	g$em_tivs
[3002] = '厦门市';

128 
	g$em_tivs
[3003] = '三明市';

129 
	g$em_tivs
[3004] = '莆田市';

130 
	g$em_tivs
[3005] = '泉州市';

131 
	g$em_tivs
[3006] = '漳州市';

132 
	g$em_tivs
[3007] = '南平市';

133 
	g$em_tivs
[3008] = '龙岩市';

134 
	g$em_tivs
[3009] = '宁德市';

135 
	g$em_tivs
[3500] = '浙江省';

136 
	g$em_tivs
[3501] = '杭州市';

137 
	g$em_tivs
[3502] = '宁波市';

138 
	g$em_tivs
[3503] = '温州市';

139 
	g$em_tivs
[3504] = '嘉兴市';

140 
	g$em_tivs
[3505] = '湖州市';

141 
	g$em_tivs
[3506] = '绍兴市';

142 
	g$em_tivs
[3507] = '金华市';

143 
	g$em_tivs
[3508] = '衢州市';

144 
	g$em_tivs
[3509] = '舟山市';

145 
	g$em_tivs
[3510] = '台州市';

146 
	g$em_tivs
[3511] = '丽水市';

147 
	g$em_tivs
[4000] = '江苏省';

148 
	g$em_tivs
[4001] = '南京市';

149 
	g$em_tivs
[4002] = '徐州市';

150 
	g$em_tivs
[4003] = '连云港市';

151 
	g$em_tivs
[4004] = '淮安市';

152 
	g$em_tivs
[4005] = '宿迁市';

153 
	g$em_tivs
[4006] = '盐城市';

154 
	g$em_tivs
[4007] = '扬州市';

155 
	g$em_tivs
[4008] = '泰州市';

156 
	g$em_tivs
[4009] = '南通市';

157 
	g$em_tivs
[4010] = '镇江市';

158 
	g$em_tivs
[4011] = '常州市';

159 
	g$em_tivs
[4012] = '无锡市';

160 
	g$em_tivs
[4013] = '苏州市';

161 
	g$em_tivs
[4500] = '山东省';

162 
	g$em_tivs
[4501] = '济南市';

163 
	g$em_tivs
[4502] = '青岛市';

164 
	g$em_tivs
[4503] = '淄博市';

165 
	g$em_tivs
[4504] = '枣庄市';

166 
	g$em_tivs
[4505] = '东营市';

167 
	g$em_tivs
[4506] = '潍坊市';

168 
	g$em_tivs
[4507] = '烟台市';

169 
	g$em_tivs
[4508] = '威海市';

170 
	g$em_tivs
[4509] = '济宁市';

171 
	g$em_tivs
[4510] = '泰安市';

172 
	g$em_tivs
[4511] = '日照市';

173 
	g$em_tivs
[4512] = '莱芜市';

174 
	g$em_tivs
[4513] = '德州市';

175 
	g$em_tivs
[4514] = '临沂市';

176 
	g$em_tivs
[4515] = '聊城市';

177 
	g$em_tivs
[4516] = '滨州市';

178 
	g$em_tivs
[4517] = '菏泽市';

179 
	g$em_tivs
[5000] = '辽宁省';

180 
	g$em_tivs
[5001] = '沈阳市';

181 
	g$em_tivs
[5002] = '大连市';

182 
	g$em_tivs
[5003] = '鞍山市';

183 
	g$em_tivs
[5004] = '抚顺市';

184 
	g$em_tivs
[5005] = '本溪市';

185 
	g$em_tivs
[5006] = '丹东市';

186 
	g$em_tivs
[5007] = '锦州市';

187 
	g$em_tivs
[5008] = '葫芦岛市';

188 
	g$em_tivs
[5009] = '营口市';

189 
	g$em_tivs
[5010] = '盘锦市';

190 
	g$em_tivs
[5011] = '阜新市';

191 
	g$em_tivs
[5012] = '辽阳市';

192 
	g$em_tivs
[5013] = '铁岭市';

193 
	g$em_tivs
[5014] = '朝阳市';

194 
	g$em_tivs
[5500] = '江西省';

195 
	g$em_tivs
[5501] = '南昌市';

196 
	g$em_tivs
[5502] = '景德镇市';

197 
	g$em_tivs
[5503] = '萍乡市';

198 
	g$em_tivs
[5504] = '新余市';

199 
	g$em_tivs
[5505] = '九江市';

200 
	g$em_tivs
[5506] = '鹰潭市';

201 
	g$em_tivs
[5507] = '赣州市';

202 
	g$em_tivs
[5508] = '吉安市';

203 
	g$em_tivs
[5509] = '宜春市';

204 
	g$em_tivs
[5510] = '抚州市';

205 
	g$em_tivs
[5511] = '上饶市';

206 
	g$em_tivs
[6000] = '四川省';

207 
	g$em_tivs
[6001] = '成都市';

208 
	g$em_tivs
[6002] = '自贡市';

209 
	g$em_tivs
[6003] = '攀枝花市';

210 
	g$em_tivs
[6004] = '泸州市';

211 
	g$em_tivs
[6005] = '德阳市';

212 
	g$em_tivs
[6006] = '绵阳市';

213 
	g$em_tivs
[6007] = '广元市';

214 
	g$em_tivs
[6008] = '遂宁市';

215 
	g$em_tivs
[6009] = '内江市';

216 
	g$em_tivs
[6010] = '乐山市';

217 
	g$em_tivs
[6011] = '南充市';

218 
	g$em_tivs
[6012] = '宜宾市';

219 
	g$em_tivs
[6013] = '广安市';

220 
	g$em_tivs
[6014] = '达州市';

221 
	g$em_tivs
[6015] = '巴中市';

222 
	g$em_tivs
[6016] = '雅安市';

223 
	g$em_tivs
[6017] = '眉山市';

224 
	g$em_tivs
[6018] = '资阳市';

225 
	g$em_tivs
[6019] = '阿坝州';

226 
	g$em_tivs
[6020] = '甘孜州';

227 
	g$em_tivs
[6021] = '凉山州';

228 
	g$em_tivs
[6500] = '陕西省';

229 
	g$em_tivs
[6501] = '铜川市';

230 
	g$em_tivs
[6502] = '宝鸡市';

231 
	g$em_tivs
[6503] = '咸阳市';

232 
	g$em_tivs
[6504] = '渭南市';

233 
	g$em_tivs
[6505] = '延安市';

234 
	g$em_tivs
[6506] = '汉中市';

235 
	g$em_tivs
[6507] = '榆林市';

236 
	g$em_tivs
[6508] = '安康市';

237 
	g$em_tivs
[6509] = '商洛地区';

238 
	g$em_tivs
[6510] = '西安市';

239 
	g$em_tivs
[7000] = '湖北省';

240 
	g$em_tivs
[7001] = '武汉市';

241 
	g$em_tivs
[7002] = '黄石市';

242 
	g$em_tivs
[7003] = '襄樊市';

243 
	g$em_tivs
[7004] = '十堰市';

244 
	g$em_tivs
[7005] = '荆州市';

245 
	g$em_tivs
[7006] = '宜昌市';

246 
	g$em_tivs
[7007] = '荆门市';

247 
	g$em_tivs
[7008] = '鄂州市';

248 
	g$em_tivs
[7009] = '孝感市';

249 
	g$em_tivs
[7010] = '黄冈市';

250 
	g$em_tivs
[7011] = '咸宁市';

251 
	g$em_tivs
[7012] = '随州市';

252 
	g$em_tivs
[7013] = '仙桃市';

253 
	g$em_tivs
[7014] = '天门市';

254 
	g$em_tivs
[7015] = '潜江市';

255 
	g$em_tivs
[7016] = '神农架';

256 
	g$em_tivs
[7017] = '恩施州';

257 
	g$em_tivs
[7500] = '河南省';

258 
	g$em_tivs
[7501] = '郑州市';

259 
	g$em_tivs
[7502] = '开封市';

260 
	g$em_tivs
[7503] = '洛阳市';

261 
	g$em_tivs
[7504] = '平顶山市';

262 
	g$em_tivs
[7505] = '焦作市';

263 
	g$em_tivs
[7506] = '鹤壁市';

264 
	g$em_tivs
[7507] = '新乡市';

265 
	g$em_tivs
[7508] = '安阳市';

266 
	g$em_tivs
[7509] = '濮阳市';

267 
	g$em_tivs
[7510] = '许昌市';

268 
	g$em_tivs
[7511] = '漯河市';

269 
	g$em_tivs
[7512] = '三门峡市';

270 
	g$em_tivs
[7513] = '南阳市';

271 
	g$em_tivs
[7514] = '商丘市';

272 
	g$em_tivs
[7515] = '信阳市';

273 
	g$em_tivs
[7516] = '周口市';

274 
	g$em_tivs
[7517] = '驻马店市';

275 
	g$em_tivs
[7518] = '济源市';

276 
	g$em_tivs
[8000] = '河北省';

277 
	g$em_tivs
[8001] = '石家庄市';

278 
	g$em_tivs
[8002] = '唐山市';

279 
	g$em_tivs
[8003] = '秦皇岛市';

280 
	g$em_tivs
[8004] = '邯郸市';

281 
	g$em_tivs
[8005] = '邢台市';

282 
	g$em_tivs
[8006] = '保定市';

283 
	g$em_tivs
[8007] = '张家口市';

284 
	g$em_tivs
[8008] = '承德市';

285 
	g$em_tivs
[8009] = '沧州市';

286 
	g$em_tivs
[8010] = '廊坊市';

287 
	g$em_tivs
[8011] = '衡水市';

288 
	g$em_tivs
[8500] = '山西省';

289 
	g$em_tivs
[8501] = '太原市';

290 
	g$em_tivs
[8502] = '大同市';

291 
	g$em_tivs
[8503] = '阳泉市';

292 
	g$em_tivs
[8504] = '长治市';

293 
	g$em_tivs
[8505] = '晋城市';

294 
	g$em_tivs
[8506] = '朔州市';

295 
	g$em_tivs
[8507] = '晋中市';

296 
	g$em_tivs
[8508] = '忻州市';

297 
	g$em_tivs
[8509] = '临汾市';

298 
	g$em_tivs
[8510] = '运城市';

299 
	g$em_tivs
[8511] = '吕梁地区';

300 
	g$em_tivs
[9000] = '内蒙古';

301 
	g$em_tivs
[9001] = '呼和浩特';

302 
	g$em_tivs
[9002] = '包头市';

303 
	g$em_tivs
[9003] = '乌海市';

304 
	g$em_tivs
[9004] = '赤峰市';

305 
	g$em_tivs
[9005] = '通辽市';

306 
	g$em_tivs
[9006] = '鄂尔多斯';

307 
	g$em_tivs
[9007] = '乌兰察布';

308 
	g$em_tivs
[9008] = '锡林郭勒';

309 
	g$em_tivs
[9009] = '呼伦贝尔';

310 
	g$em_tivs
[9010] = '巴彦淖尔';

311 
	g$em_tivs
[9011] = '阿拉善盟';

312 
	g$em_tivs
[9012] = '兴安盟';

313 
	g$em_tivs
[9500] = '吉林省';

314 
	g$em_tivs
[9501] = '长春市';

315 
	g$em_tivs
[9502] = '吉林市';

316 
	g$em_tivs
[9503] = '四平市';

317 
	g$em_tivs
[9504] = '辽源市';

318 
	g$em_tivs
[9505] = '通化市';

319 
	g$em_tivs
[9506] = '白山市';

320 
	g$em_tivs
[9507] = '松原市';

321 
	g$em_tivs
[9508] = '白城市';

322 
	g$em_tivs
[9509] = '延边州';

323 
	g$em_tivs
[10000] = '黑龙江';

324 
	g$em_tivs
[10001] = '哈尔滨市';

325 
	g$em_tivs
[10002] = '齐齐哈尔';

326 
	g$em_tivs
[10003] = '鹤岗市';

327 
	g$em_tivs
[10004] = '双鸭山市';

328 
	g$em_tivs
[10005] = '鸡西市';

329 
	g$em_tivs
[10006] = '大庆市';

330 
	g$em_tivs
[10007] = '伊春市';

331 
	g$em_tivs
[10008] = '牡丹江市';

332 
	g$em_tivs
[10009] = '佳木斯市';

333 
	g$em_tivs
[10010] = '七台河市';

334 
	g$em_tivs
[10011] = '黑河市';

335 
	g$em_tivs
[10012] = '绥化市';

336 
	g$em_tivs
[10013] = '大兴安岭';

337 
	g$em_tivs
[10500] = '安徽省';

338 
	g$em_tivs
[10501] = '合肥市';

339 
	g$em_tivs
[10502] = '芜湖市';

340 
	g$em_tivs
[10503] = '蚌埠市';

341 
	g$em_tivs
[10504] = '淮南市';

342 
	g$em_tivs
[10505] = '马鞍山市';

343 
	g$em_tivs
[10506] = '淮北市';

344 
	g$em_tivs
[10507] = '铜陵市';

345 
	g$em_tivs
[10508] = '安庆市';

346 
	g$em_tivs
[10509] = '黄山市';

347 
	g$em_tivs
[10510] = '滁州市';

348 
	g$em_tivs
[10511] = '阜阳市';

349 
	g$em_tivs
[10512] = '宿州市';

350 
	g$em_tivs
[10513] = '巢湖市';

351 
	g$em_tivs
[10514] = '六安市';

352 
	g$em_tivs
[10515] = '亳州市';

353 
	g$em_tivs
[10516] = '宣城市';

354 
	g$em_tivs
[10517] = '池州市';

355 
	g$em_tivs
[11000] = '湖南省';

356 
	g$em_tivs
[11001] = '长沙市';

357 
	g$em_tivs
[11002] = '株州市';

358 
	g$em_tivs
[11003] = '湘潭市';

359 
	g$em_tivs
[11004] = '衡阳市';

360 
	g$em_tivs
[11005] = '邵阳市';

361 
	g$em_tivs
[11006] = '岳阳市';

362 
	g$em_tivs
[11007] = '常德市';

363 
	g$em_tivs
[11008] = '张家界市';

364 
	g$em_tivs
[11009] = '益阳市';

365 
	g$em_tivs
[11010] = '郴州市';

366 
	g$em_tivs
[11011] = '永州市';

367 
	g$em_tivs
[11012] = '怀化市';

368 
	g$em_tivs
[11013] = '娄底市';

369 
	g$em_tivs
[11014] = '湘西州';

370 
	g$em_tivs
[11500] = '广西区';

371 
	g$em_tivs
[11501] = '南宁市';

372 
	g$em_tivs
[11502] = '柳州市';

373 
	g$em_tivs
[11503] = '桂林市';

374 
	g$em_tivs
[11504] = '梧州市';

375 
	g$em_tivs
[11505] = '北海市';

376 
	g$em_tivs
[11506] = '防城港市';

377 
	g$em_tivs
[11507] = '钦州市';

378 
	g$em_tivs
[11508] = '贵港市';

379 
	g$em_tivs
[11509] = '玉林市';

380 
	g$em_tivs
[11510] = '南宁地区';

381 
	g$em_tivs
[11511] = '柳州地区';

382 
	g$em_tivs
[11512] = '贺州地区';

383 
	g$em_tivs
[11513] = '百色地区';

384 
	g$em_tivs
[11514] = '河池地区';

385 
	g$em_tivs
[12000] = '海南省';

386 
	g$em_tivs
[12001] = '海口市';

387 
	g$em_tivs
[12002] = '三亚市';

388 
	g$em_tivs
[12003] = '五指山市';

389 
	g$em_tivs
[12004] = '琼海市';

390 
	g$em_tivs
[12005] = '儋州市';

391 
	g$em_tivs
[12006] = '琼山市';

392 
	g$em_tivs
[12007] = '文昌市';

393 
	g$em_tivs
[12008] = '万宁市';

394 
	g$em_tivs
[12009] = '东方市';

395 
	g$em_tivs
[12010] = '澄迈县';

396 
	g$em_tivs
[12011] = '定安县';

397 
	g$em_tivs
[12012] = '屯昌县';

398 
	g$em_tivs
[12013] = '临高县';

399 
	g$em_tivs
[12014] = '白沙县';

400 
	g$em_tivs
[12015] = '昌江县';

401 
	g$em_tivs
[12016] = '乐东县';

402 
	g$em_tivs
[12017] = '陵水县';

403 
	g$em_tivs
[12018] = '保亭县';

404 
	g$em_tivs
[12019] = '琼中县';

405 
	g$em_tivs
[12500] = '云南省';

406 
	g$em_tivs
[12501] = '昆明市';

407 
	g$em_tivs
[12502] = '曲靖市';

408 
	g$em_tivs
[12503] = '玉溪市';

409 
	g$em_tivs
[12504] = '保山市';

410 
	g$em_tivs
[12505] = '昭通市';

411 
	g$em_tivs
[12506] = '思茅地区';

412 
	g$em_tivs
[12507] = '临沧地区';

413 
	g$em_tivs
[12508] = '丽江地区';

414 
	g$em_tivs
[12509] = '文山州';

415 
	g$em_tivs
[12510] = '红河州';

416 
	g$em_tivs
[12511] = '西双版纳';

417 
	g$em_tivs
[12512] = '楚雄州';

418 
	g$em_tivs
[12513] = '大理州';

419 
	g$em_tivs
[12514] = '德宏州';

420 
	g$em_tivs
[12515] = '怒江州';

421 
	g$em_tivs
[12516] = '迪庆州';

422 
	g$em_tivs
[13000] = '贵州省';

423 
	g$em_tivs
[13001] = '贵阳市';

424 
	g$em_tivs
[13002] = '六盘水市';

425 
	g$em_tivs
[13003] = '遵义市';

426 
	g$em_tivs
[13004] = '安顺市';

427 
	g$em_tivs
[13005] = '铜仁地区';

428 
	g$em_tivs
[13006] = '毕节地区';

429 
	g$em_tivs
[13007] = '黔西南州';

430 
	g$em_tivs
[13008] = '黔东南州';

431 
	g$em_tivs
[13009] = '黔南州';

432 
	g$em_tivs
[13500] = '西藏区';

433 
	g$em_tivs
[13501] = '拉萨市';

434 
	g$em_tivs
[13502] = '那曲地区';

435 
	g$em_tivs
[13503] = '昌都地区';

436 
	g$em_tivs
[13504] = '山南地区';

437 
	g$em_tivs
[13505] = '日喀则';

438 
	g$em_tivs
[13506] = '阿里地区';

439 
	g$em_tivs
[13507] = '林芝地区';

440 
	g$em_tivs
[14000] = '甘肃省';

441 
	g$em_tivs
[14001] = '兰州市';

442 
	g$em_tivs
[14002] = '金昌市';

443 
	g$em_tivs
[14003] = '白银市';

444 
	g$em_tivs
[14004] = '天水市';

445 
	g$em_tivs
[14005] = '嘉峪关市';

446 
	g$em_tivs
[14006] = '武威市';

447 
	g$em_tivs
[14007] = '定西地区';

448 
	g$em_tivs
[14008] = '平凉地区';

449 
	g$em_tivs
[14009] = '庆阳地区';

450 
	g$em_tivs
[14010] = '陇南地区';

451 
	g$em_tivs
[14011] = '张掖地区';

452 
	g$em_tivs
[14012] = '酒泉地区';

453 
	g$em_tivs
[14013] = '甘南州';

454 
	g$em_tivs
[14014] = '临夏州';

455 
	g$em_tivs
[14500] = '宁夏区';

456 
	g$em_tivs
[14501] = '银川市';

457 
	g$em_tivs
[14502] = '石嘴山市';

458 
	g$em_tivs
[14503] = '吴忠市';

459 
	g$em_tivs
[14504] = '固原市';

460 
	g$em_tivs
[15000] = '青海省';

461 
	g$em_tivs
[15001] = '西宁市';

462 
	g$em_tivs
[15002] = '海东地区';

463 
	g$em_tivs
[15003] = '海北州';

464 
	g$em_tivs
[15004] = '黄南州';

465 
	g$em_tivs
[15005] = '海南州';

466 
	g$em_tivs
[15006] = '果洛州';

467 
	g$em_tivs
[15007] = '玉树州';

468 
	g$em_tivs
[15008] = '海西州';

469 
	g$em_tivs
[15500] = '新疆区';

470 
	g$em_tivs
[15501] = '乌鲁木齐';

471 
	g$em_tivs
[15502] = '克拉玛依';

472 
	g$em_tivs
[15503] = '石河子市';

473 
	g$em_tivs
[15504] = '吐鲁番';

474 
	g$em_tivs
[15505] = '哈密地区';

475 
	g$em_tivs
[15506] = '和田地区';

476 
	g$em_tivs
[15507] = '阿克苏';

477 
	g$em_tivs
[15508] = '喀什地区';

478 
	g$em_tivs
[15509] = '克孜勒苏';

479 
	g$em_tivs
[15510] = '巴音郭楞';

480 
	g$em_tivs
[15511] = '昌吉州';

481 
	g$em_tivs
[15512] = '博尔塔拉';

482 
	g$em_tivs
[15513] = '伊犁州';

483 
	g$em_tivs
[16000] = '香港区';

484 
	g$em_tivs
[16500] = '澳门区';

485 
	g$em_tivs
[17000] = '台湾省';

	@data/enums/smoke.php

1 <?
php


2 
glob
 
	g$em_smokes
;

3 
	g$em_smokes
 = 
y
();

4 
	g$em_smokes
[1] = '不吸烟';

5 
	g$em_smokes
[2] = '偶尔吸一点';

6 
	g$em_smokes
[3] = '抽得很凶';

	@data/enums/star.php

1 <?
php


2 
glob
 
	g$em_s
;

3 
	g$em_s
 = 
y
();

4 
	g$em_s
[1] = '白羊座';

5 
	g$em_s
[2] = '金牛座';

6 
	g$em_s
[3] = '双子座';

7 
	g$em_s
[4] = '巨蟹座';

8 
	g$em_s
[5] = '狮子座';

9 
	g$em_s
[6] = '处女座';

10 
	g$em_s
[7] = '天枰座';

11 
	g$em_s
[8] = '天蝎座';

12 
	g$em_s
[9] = '射手座';

13 
	g$em_s
[10] = '摩羯座';

14 
	g$em_s
[11] = '水瓶座';

15 
	g$em_s
[12] = '双鱼座';

	@data/enums/system.php

1 <?
php


2 
glob
 
	g$em_syems
;

3 
	g$em_syems
 = 
y
();

4 
	g$em_syems
[0] = '仅用于判断缓存是否存在';

	@data/enums/test.php

1 <?
php


2 
glob
 
	g$em_s
;

3 
	g$em_s
 = 
y
();

4 
	g$em_s
[500] = '大类一';

5 
	g$em_s
[501] = 'son11';

6 
	g$em_s
[502] = 'son12';

7 
	g$em_s
[503] = 'son13';

8 
	g$em_s
[1000] = '大类二';

9 
	g$em_s
[1500] = '大类三';

	@data/enums/vocation.php

1 <?
php


2 
glob
 
	g$em_votis
;

3 
	g$em_votis
 = 
y
();

4 
	g$em_votis
[500] = '互联网';

5 
	g$em_votis
[501] = '网站制作';

6 
	g$em_votis
[502] = '虚心';

7 
	g$em_votis
[503] = 'cms制作';

8 
	g$em_votis
[1000] = '机械';

9 
	g$em_votis
[1001] = '农业机械';

10 
	g$em_votis
[1002] = '机床';

11 
	g$em_votis
[1003] = '纺织设备和器材';

12 
	g$em_votis
[1004] = '风机/排风设备';

	@data/mark/inc_photowatermark_config.php

1 <?
php


2 
	g$pho_mkup
 = '1';

3 
	g$pho_mkdown
 = '1';

4 
	g$pho_mkty
 = '0';

5 
	g$pho_wwidth
 = '120';

6 
	g$pho_wheight
 = '120';

7 
	g$pho_wpos
 = '9';

8 
	g$pho_wxt
 = 'www.dedecms.com';

9 
	g$pho_ftsize
 = '20';

10 
	g$pho_ftc
 = '0,0,0';

11 
	g$pho_mks
 = '100';

12 
	g$pho_dphey
 = '100';

13 
	g$pho_mkimg
 = 'mark.gif';

	@data/module/0cce60bc0238aa03804682c801584991-readme.php

1 <
div
 
	gy
='padding-left:20px;line-height:150%'>

2 <
p
>版权所有 &
cy
;2003-2008，
	gDedeCms
.
	gcom
 保留所有权利。 </
	gp
>

3 <
	gp
>感谢您选择织梦内容管理系统（以下简称
	gDedeCms
），DedeCms是目前国内最强大、最稳定的中小型门户网站建设解决方案之一，居于 
	gPHP
 + 
	gMySQL
 的技术开发，全部源码开放。DedeCm的官方网址是： 
	gwww
.
	gdedecms
.
	gcom
 交流论坛： 
	gbbs
.dedecms.com</p>

4 <
	gp
>为了使你正确并合法的使用本软件，请你在使用前务必阅读清楚下面的协议条款：</p>

5 <
	gp
><
	grg
>一、本授权协议适用且仅适用于 
	gDedeCms
 5.x.x 版本，DedeCms官方对本授权协议的最终解释权。 </strong></p>

6 <
	gp
><
	grg
>二、协议许可的权利 </rg><
	gbr
 />

7 1、您可以在完全遵守本最终用户授权协议的基础上，将本软件应用于非商业用途，而不必支付软件版权授权费用。 <
	gbr
 />

8 2、您可以在协议规定的约束和限制范围内修改 
	gDedeCms
 源代码或界面风格以适应您的网站要求。 <
	gbr
 />

9 3、您拥有使用本软件构建的网站全部内容所有权，并独立承担与这些内容的相关法律义务。 <
	gbr
 />

10 4、获得商业授权之后，您可以将本软件应用于商业用途，同时依据所购买的授权类型中确定的技术支持内容，自购买时刻起，在技术支持期限内拥有通过指定的方式获得指定范围内的技术支持服务。商业授权用户享有反映和提出意见的权力，相关意见将被作为首要考虑，但没有一定被采纳的承诺或保证。 </
	gp
>

11 <
	gp
><
	grg
>三、协议规定的约束和限制 </rg><
	gbr
 />

12 1、未获商业授权之前，不得将本软件用于商业用途（包括但不限于企业网站、经营性网站、以营利为目的或实现盈利的网站）。购买商业授权请登陆 
	gbbs
.
	gdedecms
.
	gcom
 了解最新说明。 <
	gbr
 />

13 2、未经官方许可，不得对本软件或与之关联的商业授权进行出租、出售、抵押或发放子许可证。 <
	gbr
 />

14 3、不管你的网站是否整体使用 
	gDedeCms
 ，还是部份栏目使用 DedeCms，在你使用了 DedeCm的网站主页上必须加上 DedeCm官方网址(
	gwww
.
	gdedecms
.
	gcom
)的链接。 <
	gbr
 />

15 4、未经官方许可，禁止在 
	gDedeCms
 的整体或任何部分基础上以发展任何派生版本、修改版本或第三方版本用于重新分发。 <
	gbr
 />

16 5、如果您未能遵守本协议的条款，您的授权将被终止，所被许可的权利将被收回，并承担相应法律责任。 </
	gp
>

17 <
	gp
><
	grg
>四、有限担保和免责声明 </rg><
	gbr
 />

18 1、本软件及所附带的文件是作为不提供任何明确的或隐含的赔偿或担保的形式提供的。 <
	gbr
 />

19 2、用户出于自愿而使用本软件，您必须了解使用本软件的风险，在尚未购买产品技术服务之前，我们不承诺对免费用户提供任何形式的技术支持、使用担保，也不承担任何因使用本软件而产生问题的相关责任。 <
	gbr
 />

20 3、电子文本形式的授权协议如同双方书面签署的协议一样，具有完全的和等同的法律效力。您一旦开始确认本协议并安装 
	gDedeCms
，即被视为完全理解并接受本协议的各项条款，在享有上述条款授予的权力的同时，受到相关的约束和限制。协议许可范围以外的行为，将直接违反本授权协议并构成侵权，我们有权随时终止授权，责令停止损害，并保留追究相关责任的权力。 <
	gbr
 />

21 4、如果本软件带有其它软件的整合
	gAPI
示范例子包，这些文件版权不属于本软件官方，并且这些文件是没经过授权发布的，请参考相关软件的使用许可合法的使用。</
	gp
>

22 <
	gp
>协议发布时间： 2008年8月20日 
By
 
	gDedeCms
.
	gcom
</p>

23 <
	gp
>&
	gnb
;</p>

	@data/module/1f35620fb42d452fa2bdc1dee1690f92-readme.php

1 <
div
 
	gy
='padding-left:20px;line-height:150%'>

2 <
p
>版权所有 &
cy
;2003-2008，
	gDedeCms
.
	gcom
 保留所有权利。 </
	gp
>

3 <
	gp
>感谢您选择织梦内容管理系统（以下简称
	gDedeCms
），DedeCms是目前国内最强大、最稳定的中小型门户网站建设解决方案之一，居于 
	gPHP
 + 
	gMySQL
 的技术开发，全部源码开放。DedeCm的官方网址是： 
	gwww
.
	gdedecms
.
	gcom
 交流论坛： 
	gbbs
.dedecms.com</p>

4 <
	gp
>为了使你正确并合法的使用本软件，请你在使用前务必阅读清楚下面的协议条款：</p>

5 <
	gp
><
	grg
>一、本授权协议适用且仅适用于 
	gDedeCms
 5.x.x 版本，DedeCms官方对本授权协议的最终解释权。 </strong></p>

6 <
	gp
><
	grg
>二、协议许可的权利 </rg><
	gbr
 />

7 1、您可以在完全遵守本最终用户授权协议的基础上，将本软件应用于非商业用途，而不必支付软件版权授权费用。 <
	gbr
 />

8 2、您可以在协议规定的约束和限制范围内修改 
	gDedeCms
 源代码或界面风格以适应您的网站要求。 <
	gbr
 />

9 3、您拥有使用本软件构建的网站全部内容所有权，并独立承担与这些内容的相关法律义务。 <
	gbr
 />

10 4、获得商业授权之后，您可以将本软件应用于商业用途，同时依据所购买的授权类型中确定的技术支持内容，自购买时刻起，在技术支持期限内拥有通过指定的方式获得指定范围内的技术支持服务。商业授权用户享有反映和提出意见的权力，相关意见将被作为首要考虑，但没有一定被采纳的承诺或保证。 </
	gp
>

11 <
	gp
><
	grg
>三、协议规定的约束和限制 </rg><
	gbr
 />

12 1、未获商业授权之前，不得将本软件用于商业用途（包括但不限于企业网站、经营性网站、以营利为目的或实现盈利的网站）。购买商业授权请登陆 
	gbbs
.
	gdedecms
.
	gcom
 了解最新说明。 <
	gbr
 />

13 2、未经官方许可，不得对本软件或与之关联的商业授权进行出租、出售、抵押或发放子许可证。 <
	gbr
 />

14 3、不管你的网站是否整体使用 
	gDedeCms
 ，还是部份栏目使用 DedeCms，在你使用了 DedeCm的网站主页上必须加上 DedeCm官方网址(
	gwww
.
	gdedecms
.
	gcom
)的链接。 <
	gbr
 />

15 4、未经官方许可，禁止在 
	gDedeCms
 的整体或任何部分基础上以发展任何派生版本、修改版本或第三方版本用于重新分发。 <
	gbr
 />

16 5、如果您未能遵守本协议的条款，您的授权将被终止，所被许可的权利将被收回，并承担相应法律责任。 </
	gp
>

17 <
	gp
><
	grg
>四、有限担保和免责声明 </rg><
	gbr
 />

18 1、本软件及所附带的文件是作为不提供任何明确的或隐含的赔偿或担保的形式提供的。 <
	gbr
 />

19 2、用户出于自愿而使用本软件，您必须了解使用本软件的风险，在尚未购买产品技术服务之前，我们不承诺对免费用户提供任何形式的技术支持、使用担保，也不承担任何因使用本软件而产生问题的相关责任。 <
	gbr
 />

20 3、电子文本形式的授权协议如同双方书面签署的协议一样，具有完全的和等同的法律效力。您一旦开始确认本协议并安装 
	gDedeCms
，即被视为完全理解并接受本协议的各项条款，在享有上述条款授予的权力的同时，受到相关的约束和限制。协议许可范围以外的行为，将直接违反本授权协议并构成侵权，我们有权随时终止授权，责令停止损害，并保留追究相关责任的权力。 <
	gbr
 />

21 4、如果本软件带有其它软件的整合
	gAPI
示范例子包，这些文件版权不属于本软件官方，并且这些文件是没经过授权发布的，请参考相关软件的使用许可合法的使用。</
	gp
>

22 <
	gp
>协议发布时间： 2008年8月20日 
By
 
	gDedeCms
.
	gcom
</p>

23 <
	gp
>&
	gnb
;</p>

	@data/module/572606600345b1a4bb8c810bbae434cc-readme.php

1 <
div
 
	gy
='padding-left:20px;line-height:150%'>

2 <
p
>版权所有 &
cy
;2003-2008，
	gDedeCms
.
	gcom
 保留所有权利。 </
	gp
>

3 <
	gp
>感谢您选择织梦内容管理系统（以下简称
	gDedeCms
），DedeCms是目前国内最强大、最稳定的中小型门户网站建设解决方案之一，居于 
	gPHP
 + 
	gMySQL
 的技术开发，全部源码开放。DedeCm的官方网址是： 
	gwww
.
	gdedecms
.
	gcom
 交流论坛： 
	gbbs
.dedecms.com</p>

4 <
	gp
>为了使你正确并合法的使用本软件，请你在使用前务必阅读清楚下面的协议条款：</p>

5 <
	gp
><
	grg
>一、本授权协议适用且仅适用于 
	gDedeCms
 5.x.x 版本，DedeCms官方对本授权协议的最终解释权。 </strong></p>

6 <
	gp
><
	grg
>二、协议许可的权利 </rg><
	gbr
 />

7 1、您可以在完全遵守本最终用户授权协议的基础上，将本软件应用于非商业用途，而不必支付软件版权授权费用。 <
	gbr
 />

8 2、您可以在协议规定的约束和限制范围内修改 
	gDedeCms
 源代码或界面风格以适应您的网站要求。 <
	gbr
 />

9 3、您拥有使用本软件构建的网站全部内容所有权，并独立承担与这些内容的相关法律义务。 <
	gbr
 />

10 4、获得商业授权之后，您可以将本软件应用于商业用途，同时依据所购买的授权类型中确定的技术支持内容，自购买时刻起，在技术支持期限内拥有通过指定的方式获得指定范围内的技术支持服务。商业授权用户享有反映和提出意见的权力，相关意见将被作为首要考虑，但没有一定被采纳的承诺或保证。 </
	gp
>

11 <
	gp
><
	grg
>三、协议规定的约束和限制 </rg><
	gbr
 />

12 1、未获商业授权之前，不得将本软件用于商业用途（包括但不限于企业网站、经营性网站、以营利为目的或实现盈利的网站）。购买商业授权请登陆 
	gbbs
.
	gdedecms
.
	gcom
 了解最新说明。 <
	gbr
 />

13 2、未经官方许可，不得对本软件或与之关联的商业授权进行出租、出售、抵押或发放子许可证。 <
	gbr
 />

14 3、不管你的网站是否整体使用 
	gDedeCms
 ，还是部份栏目使用 DedeCms，在你使用了 DedeCm的网站主页上必须加上 DedeCm官方网址(
	gwww
.
	gdedecms
.
	gcom
)的链接。 <
	gbr
 />

15 4、未经官方许可，禁止在 
	gDedeCms
 的整体或任何部分基础上以发展任何派生版本、修改版本或第三方版本用于重新分发。 <
	gbr
 />

16 5、如果您未能遵守本协议的条款，您的授权将被终止，所被许可的权利将被收回，并承担相应法律责任。 </
	gp
>

17 <
	gp
><
	grg
>四、有限担保和免责声明 </rg><
	gbr
 />

18 1、本软件及所附带的文件是作为不提供任何明确的或隐含的赔偿或担保的形式提供的。 <
	gbr
 />

19 2、用户出于自愿而使用本软件，您必须了解使用本软件的风险，在尚未购买产品技术服务之前，我们不承诺对免费用户提供任何形式的技术支持、使用担保，也不承担任何因使用本软件而产生问题的相关责任。 <
	gbr
 />

20 3、电子文本形式的授权协议如同双方书面签署的协议一样，具有完全的和等同的法律效力。您一旦开始确认本协议并安装 
	gDedeCms
，即被视为完全理解并接受本协议的各项条款，在享有上述条款授予的权力的同时，受到相关的约束和限制。协议许可范围以外的行为，将直接违反本授权协议并构成侵权，我们有权随时终止授权，责令停止损害，并保留追究相关责任的权力。 <
	gbr
 />

21 4、如果本软件带有其它软件的整合
	gAPI
示范例子包，这些文件版权不属于本软件官方，并且这些文件是没经过授权发布的，请参考相关软件的使用许可合法的使用。</
	gp
>

22 <
	gp
>协议发布时间： 2008年8月20日 
By
 
	gDedeCms
.
	gcom
</p>

23 <
	gp
>&
	gnb
;</p>

	@data/module/72ffa6fabe3c236f9238a2b281bc0f93-readme.php

1 <
div
 
	gy
='padding-left:20px;line-height:150%'>

2 <
p
>版权所有 &
cy
;2003-2008，
	gDedeCms
.
	gcom
 保留所有权利。 </
	gp
>

3 <
	gp
>感谢您选择织梦内容管理系统（以下简称
	gDedeCms
），DedeCms是目前国内最强大、最稳定的中小型门户网站建设解决方案之一，居于 
	gPHP
 + 
	gMySQL
 的技术开发，全部源码开放。DedeCm的官方网址是： 
	gwww
.
	gdedecms
.
	gcom
 交流论坛： 
	gbbs
.dedecms.com</p>

4 <
	gp
>为了使你正确并合法的使用本软件，请你在使用前务必阅读清楚下面的协议条款：</p>

5 <
	gp
><
	grg
>一、本授权协议适用且仅适用于 
	gDedeCms
 5.x.x 版本，DedeCms官方对本授权协议的最终解释权。 </strong></p>

6 <
	gp
><
	grg
>二、协议许可的权利 </rg><
	gbr
 />

7 1、您可以在完全遵守本最终用户授权协议的基础上，将本软件应用于非商业用途，而不必支付软件版权授权费用。 <
	gbr
 />

8 2、您可以在协议规定的约束和限制范围内修改 
	gDedeCms
 源代码或界面风格以适应您的网站要求。 <
	gbr
 />

9 3、您拥有使用本软件构建的网站全部内容所有权，并独立承担与这些内容的相关法律义务。 <
	gbr
 />

10 4、获得商业授权之后，您可以将本软件应用于商业用途，同时依据所购买的授权类型中确定的技术支持内容，自购买时刻起，在技术支持期限内拥有通过指定的方式获得指定范围内的技术支持服务。商业授权用户享有反映和提出意见的权力，相关意见将被作为首要考虑，但没有一定被采纳的承诺或保证。 </
	gp
>

11 <
	gp
><
	grg
>三、协议规定的约束和限制 </rg><
	gbr
 />

12 1、未获商业授权之前，不得将本软件用于商业用途（包括但不限于企业网站、经营性网站、以营利为目的或实现盈利的网站）。购买商业授权请登陆 
	gbbs
.
	gdedecms
.
	gcom
 了解最新说明。 <
	gbr
 />

13 2、未经官方许可，不得对本软件或与之关联的商业授权进行出租、出售、抵押或发放子许可证。 <
	gbr
 />

14 3、不管你的网站是否整体使用 
	gDedeCms
 ，还是部份栏目使用 DedeCms，在你使用了 DedeCm的网站主页上必须加上 DedeCm官方网址(
	gwww
.
	gdedecms
.
	gcom
)的链接。 <
	gbr
 />

15 4、未经官方许可，禁止在 
	gDedeCms
 的整体或任何部分基础上以发展任何派生版本、修改版本或第三方版本用于重新分发。 <
	gbr
 />

16 5、如果您未能遵守本协议的条款，您的授权将被终止，所被许可的权利将被收回，并承担相应法律责任。 </
	gp
>

17 <
	gp
><
	grg
>四、有限担保和免责声明 </rg><
	gbr
 />

18 1、本软件及所附带的文件是作为不提供任何明确的或隐含的赔偿或担保的形式提供的。 <
	gbr
 />

19 2、用户出于自愿而使用本软件，您必须了解使用本软件的风险，在尚未购买产品技术服务之前，我们不承诺对免费用户提供任何形式的技术支持、使用担保，也不承担任何因使用本软件而产生问题的相关责任。 <
	gbr
 />

20 3、电子文本形式的授权协议如同双方书面签署的协议一样，具有完全的和等同的法律效力。您一旦开始确认本协议并安装 
	gDedeCms
，即被视为完全理解并接受本协议的各项条款，在享有上述条款授予的权力的同时，受到相关的约束和限制。协议许可范围以外的行为，将直接违反本授权协议并构成侵权，我们有权随时终止授权，责令停止损害，并保留追究相关责任的权力。 <
	gbr
 />

21 4、如果本软件带有其它软件的整合
	gAPI
示范例子包，这些文件版权不属于本软件官方，并且这些文件是没经过授权发布的，请参考相关软件的使用许可合法的使用。</
	gp
>

22 <
	gp
>协议发布时间： 2008年8月20日 
By
 
	gDedeCms
.
	gcom
</p>

23 <
	gp
>&
	gnb
;</p>

	@data/module/acb8b88eb4a6d4bfc375c18534f9439e-readme.php

1 <
div
 
	gy
='padding-left:20px;line-height:150%'>

2 <
p
>版权所有 &
cy
;2003-2008，
	gDedeCms
.
	gcom
 保留所有权利。 </
	gp
>

3 <
	gp
>感谢您选择织梦内容管理系统（以下简称
	gDedeCms
），DedeCms是目前国内最强大、最稳定的中小型门户网站建设解决方案之一，居于 
	gPHP
 + 
	gMySQL
 的技术开发，全部源码开放。DedeCm的官方网址是： 
	gwww
.
	gdedecms
.
	gcom
 交流论坛： 
	gbbs
.dedecms.com</p>

4 <
	gp
>为了使你正确并合法的使用本软件，请你在使用前务必阅读清楚下面的协议条款：</p>

5 <
	gp
><
	grg
>一、本授权协议适用且仅适用于 
	gDedeCms
 5.x.x 版本，DedeCms官方对本授权协议的最终解释权。 </strong></p>

6 <
	gp
><
	grg
>二、协议许可的权利 </rg><
	gbr
 />

7 1、您可以在完全遵守本最终用户授权协议的基础上，将本软件应用于非商业用途，而不必支付软件版权授权费用。 <
	gbr
 />

8 2、您可以在协议规定的约束和限制范围内修改 
	gDedeCms
 源代码或界面风格以适应您的网站要求。 <
	gbr
 />

9 3、您拥有使用本软件构建的网站全部内容所有权，并独立承担与这些内容的相关法律义务。 <
	gbr
 />

10 4、获得商业授权之后，您可以将本软件应用于商业用途，同时依据所购买的授权类型中确定的技术支持内容，自购买时刻起，在技术支持期限内拥有通过指定的方式获得指定范围内的技术支持服务。商业授权用户享有反映和提出意见的权力，相关意见将被作为首要考虑，但没有一定被采纳的承诺或保证。 </
	gp
>

11 <
	gp
><
	grg
>三、协议规定的约束和限制 </rg><
	gbr
 />

12 1、未获商业授权之前，不得将本软件用于商业用途（包括但不限于企业网站、经营性网站、以营利为目的或实现盈利的网站）。购买商业授权请登陆 
	gbbs
.
	gdedecms
.
	gcom
 了解最新说明。 <
	gbr
 />

13 2、未经官方许可，不得对本软件或与之关联的商业授权进行出租、出售、抵押或发放子许可证。 <
	gbr
 />

14 3、不管你的网站是否整体使用 
	gDedeCms
 ，还是部份栏目使用 DedeCms，在你使用了 DedeCm的网站主页上必须加上 DedeCm官方网址(
	gwww
.
	gdedecms
.
	gcom
)的链接。 <
	gbr
 />

15 4、未经官方许可，禁止在 
	gDedeCms
 的整体或任何部分基础上以发展任何派生版本、修改版本或第三方版本用于重新分发。 <
	gbr
 />

16 5、如果您未能遵守本协议的条款，您的授权将被终止，所被许可的权利将被收回，并承担相应法律责任。 </
	gp
>

17 <
	gp
><
	grg
>四、有限担保和免责声明 </rg><
	gbr
 />

18 1、本软件及所附带的文件是作为不提供任何明确的或隐含的赔偿或担保的形式提供的。 <
	gbr
 />

19 2、用户出于自愿而使用本软件，您必须了解使用本软件的风险，在尚未购买产品技术服务之前，我们不承诺对免费用户提供任何形式的技术支持、使用担保，也不承担任何因使用本软件而产生问题的相关责任。 <
	gbr
 />

20 3、电子文本形式的授权协议如同双方书面签署的协议一样，具有完全的和等同的法律效力。您一旦开始确认本协议并安装 
	gDedeCms
，即被视为完全理解并接受本协议的各项条款，在享有上述条款授予的权力的同时，受到相关的约束和限制。协议许可范围以外的行为，将直接违反本授权协议并构成侵权，我们有权随时终止授权，责令停止损害，并保留追究相关责任的权力。 <
	gbr
 />

21 4、如果本软件带有其它软件的整合
	gAPI
示范例子包，这些文件版权不属于本软件官方，并且这些文件是没经过授权发布的，请参考相关软件的使用许可合法的使用。</
	gp
>

22 <
	gp
>协议发布时间： 2008年8月20日 
By
 
	gDedeCms
.
	gcom
</p>

23 <
	gp
>&
	gnb
;</p>

	@data/module/b437d85a7a7bc778c9c79b5ec36ab9aa-readme.php

1 <
div
 
	gy
='padding-left:20px;line-height:150%'>

2 <
p
>版权所有 &
cy
;2003-2008，
	gDedeCms
.
	gcom
 保留所有权利。 </
	gp
>

3 <
	gp
>感谢您选择织梦内容管理系统（以下简称
	gDedeCms
），DedeCms是目前国内最强大、最稳定的中小型门户网站建设解决方案之一，居于 
	gPHP
 + 
	gMySQL
 的技术开发，全部源码开放。DedeCm的官方网址是： 
	gwww
.
	gdedecms
.
	gcom
 交流论坛： 
	gbbs
.dedecms.com</p>

4 <
	gp
>为了使你正确并合法的使用本软件，请你在使用前务必阅读清楚下面的协议条款：</p>

5 <
	gp
><
	grg
>一、本授权协议适用且仅适用于 
	gDedeCms
 5.x.x 版本，DedeCms官方对本授权协议的最终解释权。 </strong></p>

6 <
	gp
><
	grg
>二、协议许可的权利 </rg><
	gbr
 />

7 1、您可以在完全遵守本最终用户授权协议的基础上，将本软件应用于非商业用途，而不必支付软件版权授权费用。 <
	gbr
 />

8 2、您可以在协议规定的约束和限制范围内修改 
	gDedeCms
 源代码或界面风格以适应您的网站要求。 <
	gbr
 />

9 3、您拥有使用本软件构建的网站全部内容所有权，并独立承担与这些内容的相关法律义务。 <
	gbr
 />

10 4、获得商业授权之后，您可以将本软件应用于商业用途，同时依据所购买的授权类型中确定的技术支持内容，自购买时刻起，在技术支持期限内拥有通过指定的方式获得指定范围内的技术支持服务。商业授权用户享有反映和提出意见的权力，相关意见将被作为首要考虑，但没有一定被采纳的承诺或保证。 </
	gp
>

11 <
	gp
><
	grg
>三、协议规定的约束和限制 </rg><
	gbr
 />

12 1、未获商业授权之前，不得将本软件用于商业用途（包括但不限于企业网站、经营性网站、以营利为目的或实现盈利的网站）。购买商业授权请登陆 
	gbbs
.
	gdedecms
.
	gcom
 了解最新说明。 <
	gbr
 />

13 2、未经官方许可，不得对本软件或与之关联的商业授权进行出租、出售、抵押或发放子许可证。 <
	gbr
 />

14 3、不管你的网站是否整体使用 
	gDedeCms
 ，还是部份栏目使用 DedeCms，在你使用了 DedeCm的网站主页上必须加上 DedeCm官方网址(
	gwww
.
	gdedecms
.
	gcom
)的链接。 <
	gbr
 />

15 4、未经官方许可，禁止在 
	gDedeCms
 的整体或任何部分基础上以发展任何派生版本、修改版本或第三方版本用于重新分发。 <
	gbr
 />

16 5、如果您未能遵守本协议的条款，您的授权将被终止，所被许可的权利将被收回，并承担相应法律责任。 </
	gp
>

17 <
	gp
><
	grg
>四、有限担保和免责声明 </rg><
	gbr
 />

18 1、本软件及所附带的文件是作为不提供任何明确的或隐含的赔偿或担保的形式提供的。 <
	gbr
 />

19 2、用户出于自愿而使用本软件，您必须了解使用本软件的风险，在尚未购买产品技术服务之前，我们不承诺对免费用户提供任何形式的技术支持、使用担保，也不承担任何因使用本软件而产生问题的相关责任。 <
	gbr
 />

20 3、电子文本形式的授权协议如同双方书面签署的协议一样，具有完全的和等同的法律效力。您一旦开始确认本协议并安装 
	gDedeCms
，即被视为完全理解并接受本协议的各项条款，在享有上述条款授予的权力的同时，受到相关的约束和限制。协议许可范围以外的行为，将直接违反本授权协议并构成侵权，我们有权随时终止授权，责令停止损害，并保留追究相关责任的权力。 <
	gbr
 />

21 4、如果本软件带有其它软件的整合
	gAPI
示范例子包，这些文件版权不属于本软件官方，并且这些文件是没经过授权发布的，请参考相关软件的使用许可合法的使用。</
	gp
>

22 <
	gp
>协议发布时间： 2008年8月20日 
By
 
	gDedeCms
.
	gcom
</p>

23 <
	gp
>&
	gnb
;</p>

	@data/module/modulescache.php

1 <?
php


2 
glob
 
	g$lmodus
;

3 
	g$GLOBALS
['allmodules']['0a7bea5dbe571d35def883cbec796437']='0a7bea5dbe571d35def883cbec796437.xml';

4 
	g$GLOBALS
['allmodules']['0cce60bc0238aa03804682c801584991']='0cce60bc0238aa03804682c801584991.xml';

5 
	g$GLOBALS
['allmodules']['1f35620fb42d452fa2bdc1dee1690f92']='1f35620fb42d452fa2bdc1dee1690f92.xml';

6 
	g$GLOBALS
['allmodules']['572606600345b1a4bb8c810bbae434cc']='572606600345b1a4bb8c810bbae434cc.xml';

7 
	g$GLOBALS
['allmodules']['59155be87ea60c5c65ec1f7a46a0fc9d']='59155be87ea60c5c65ec1f7a46a0fc9d.xml';

8 
	g$GLOBALS
['allmodules']['72ffa6fabe3c236f9238a2b281bc0f93']='72ffa6fabe3c236f9238a2b281bc0f93.xml';

9 
	g$GLOBALS
['allmodules']['7badb72a3ff79af2a7112beee60cb970']='7badb72a3ff79af2a7112beee60cb970.xml';

10 
	g$GLOBALS
['allmodules']['867af26e9c1ccf22a1cf67e756cf5acc']='867af26e9c1ccf22a1cf67e756cf5acc.xml';

11 
	g$GLOBALS
['allmodules']['8964eda9013d1df0afea08ed63243436']='8964eda9013d1df0afea08ed63243436.xml';

12 
	g$GLOBALS
['allmodules']['acb8b88eb4a6d4bfc375c18534f9439e']='acb8b88eb4a6d4bfc375c18534f9439e.xml';

13 
	g$GLOBALS
['allmodules']['b437d85a7a7bc778c9c79b5ec36ab9aa']='b437d85a7a7bc778c9c79b5ec36ab9aa.xml';

14 
	g$GLOBALS
['allmodules']['be722dbfa3cb3cb5628aab2d767ff62e']='be722dbfa3cb3cb5628aab2d767ff62e.xml';

15 
	g$GLOBALS
['allmodules']['dfcb5cd4d7bc0e3f7eb655e62dd6bc64']='dfcb5cd4d7bc0e3f7eb655e62dd6bc64.xml';

	@data/safequestions.php

1 <?
php


3 
	g$queis
 = 
y
();

4 
	g$queis
[0] = '没安全提示问题';

9 
	g$queis
[1] = '你最喜欢的格言什么？';

10 
	g$queis
[2] = '你家乡的名称是什么？';

11 
	g$queis
[3] = '你读的小学叫什么？';

12 
	g$queis
[4] = '你的父亲叫什么名字？';

13 
	g$queis
[5] = '你的母亲叫什么名字？';

14 
	g$queis
[6] = '你最喜欢的偶像是谁？';

15 
	g$queis
[7] = '你最喜欢的歌曲是什么？';

22 
funi
 
GSaquei
(
$lid
=0,
$fmme
='safequestion')

24 
glob
 
$queis
;

25 
	g$queis_fm
 = "<selectame='$formname' id='$formname'>";

26 
fܗch
(
$queis
 
as
 
$k
=>
$v
)

28 if(
$k
==
$lid

$queis_fm
 .= "<option value='$k' selected>$v</option>\r\n";

29 
	g$queis_fm
 .= "<option value='$k'>$v</option>\r\n";

31 
	g$queis_fm
 .= "</select>\r\n";

32  
	g$queis_fm
;

	@data/sys_pay.cache.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
("403 Forbidden!");

4 
	g$ymt_
 = 
y
(0 => "tenpay",2 => "alipay",3 => "cbpayment",4 => "yeepay");

5 
	g$ymt_urid
 = 
y
(0 => "",1 => "",2 => "",3 => "",4 => "");

6 
	g$ymt_key
 = 
y
(0 => "",1 => "",2 => "",3 => "",4 => "");

7 
	g$ymt_cuay
 = 
y
(0 => 'CNY',1 => 'CNY',2 => 'CNY',3 => 'CNY',4 => 'CNY');

8 
	g$ymt_exp
 = 
y
(0 => "0.01",1 => "0.00",2 => "0.01",3 => "0.01",4 => "0.00");

9 
	g$ymt_ema
 = 
y
(0 => "webmaster@admin.com",1 => "webmaster@admin.com",2 => "webmaster@admin.com",3 => "webmaster@admin.com",4 => "webmaster@admin.com");

11 
	g$cfg_y_fo
 = 
y
(

12 'me' => 
y
('腾讯财付通','NPS 网上支付系统','支付宝','网银在线','易宝支付'),

13 'ty' => 
y
('tenpay','nps','alipay','cbpayment','yeepay'),

14 'logo' => 
y
('tenpay.jpg','nps.gif','alipay.jpg','cbpayment.gif','yeepay.gif'),

15 'g' => 
y
(

22 'des' => 
y
(

31 
funi
 
mchSCode
(
$rg
,
$ai
='ENCODE')

33 
$key
 = 
subr
(
md5
(
$_SERVER
["HTTP_USER_AGENT"].
$GLOBALS
['cfg_cookie_encode']),8,18);

34 
	g$rg
 = 
$ai
 ='ENCODE' ? 
$rg
 : 
ba64_decode
($string);

35 
	g$n
 = 

(
$key
);

36 
	g$code
 = '';

37 
	g$i
=0; $i<

(
$rg
); $i++)

39 
	g$k
 = 
$i
 % 
$n
;

40 
	g$code
 .
$rg
[
$i
] ^ 
$key
[
$k
];

42 
	g$code
 = 
$ai
 ='DECODE' ? 
$code
 : 
ba64_code
($code);

43  
	g$code
;

	@data/template.rand.php

1 <?
php


4 
	g$cfg_me_nd
 = 0;

7 
	g$cfg_me_r
[] = 'article_article.htm';

8 
	g$cfg_me_r
[] = 'article_article1.htm';

9 
	g$cfg_me_r
[] = 'article_article2.htm';

	@dede/ad_add.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_广告管理');

4 
que_
 
	gDEDEINC
."/typelink.class.php";

5 if(
	$emy
(
$do
))

7 
$do
 = "";

8 
	}
}

10 if(
	g$do
=="save")

13 
$gme
 = 
im
($tagname);

14 
	g$row
 = 
$dsql
->
GO
("Selectypeid From #@__myad whereypeid='$typeid' Andagnameike '$tagname'");

15 if(
is_y
(
$row
))

17 
ShowMsg
("在相同栏目下已经存在同名的标记！","-1");

18 
ex
();

20 
	g$ime
 = 
GMkTime
(
$ime
);

21 
	g$dtime
 = 
GMkTime
(
$dtime
);

22 if(
	g$nmbody
['style']=='code')

24 
$nmbody
 = $normbody['htmlcode'];

26 
if
(
$nmbody
['style']=='txt')

28 
$nmbody
 = "<a href=\"{$normbody['link']}\" font-size=\"{$normbody['size']}\" color=\"{$normbody['color']}\">{$normbody['title']}</a>";

30 
if
(
$nmbody
['style']=='img')

32 if(
emy
(
$nmbody
['width']))

34 
$width
 = "";

38 
	g$width
 = " width=\"{$normbody['width']}\"";

40 i(
emy
(
$nmbody
['height']))

42 
	g$height
 = "";

46 
	g$height
 = "height=\"{$normbody['height']}\"";

48 
	g$nmbody
 = "<a href=\"{$normbody['link']}\"><img src=\"{$normbody['url']}\"$width $height border=\"0\" /></a>";

52 if(
emy
(
$nmbody
['width']))

54 
	g$width
 = "";

58 
	g$width
 = " width=\"{$normbody['width']}\"";

60 i(
emy
(
$nmbody
['height']))

62 
	g$height
 = "";

66 
	g$height
 = "height=\"{$normbody['height']}\"";

68 
	g$nmbody
 = "<object classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\" codebase=\"http://download.Macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,19,0\"$width $height><paramame=\"movie\" value=\"{$normbody['link']}\"/><paramame=\"quality\" value=\"high\"/></object>";

70 
	g$quy
 = "

71 
In
 
Io
 #@
__myad
(
tyid
,
gme
,
adme
,
timet
,
ime
,
dtime
,
nmbody
,
expbody
)

72 
Vues
('$typeid','$tagname','$adname','$timeset','$starttime','$endtime','$normbody','$expbody');

74 
	g$dsql
->
ExecuNeQuy
(
$quy
);

75 
ShowMsg
("成功增加一个广告！","ad_main.php");

76 
ex
();

78 
	g$tDay
 = 
time
();

79 
	g$dDay
 = 
AddDay
(
$tDay
,30);

80 
	g$tDay
 = 
GDeTimeMk
(
$tDay
);

81 
	g$dDay
 = 
GDeTimeMk
(
$dDay
);

82 
ude
 
DedeInude
('templets/ad_add.htm');

	@dede/ad_edit.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_广告管理');

4 
que_
(
DEDEINC
.'/typelink.class.php');

5 if(
	$emy
(
$do
))

7 
$do
 = '';

8 
	}
}

9 
	g$aid
 = 
eg_a
('[^0-9]','',
$aid
);

10 
	g$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? "ad_main.php" : $_COOKIE['ENV_GOBACK_URL'];

12 if(
	g$do
=='delete')

14 
$dsql
->
ExecuNeQuy
("Delete From `#@__myad` whereid='$aid' ");

15 
ShowMsg
("成功删除一则广告代码！",
$ENV_GOBACK_URL
);

16 
ex
();

18 if(
	g$do
=="getjs")

20 
que_
(
DEDEINC
.'/oxwindow.class.php');

21 
	g$jscode
 = "<script src='{$cfg_phpurl}/ad_js.php?aid=$aid'anguage='javascript'></script>";

22 
	g$showhtml
 = "<xmp style='color:#333333;background-color:#ffffff'>\r\n\r\n$jscode\r\n\r\n</xmp>";

23 
	g$showhtml
 .= "预览：<iframeame='testfrm' frameborder='0' src='ad_edit.php?aid={$aid}&dopost=testjs' id='testfrm' width='100%' height='200'></iframe>";

24 
	g$wt
 = "广告管理-获取JS";

25 
	g$wecome_fo
 = "<a href='ad_main.php'><u>广告管理</u></a>::获取JS";

26 
	g$w
 = 
w
 
OxWdow
();

27 
	g$w
->
In
();

28 
	g$w
->
AddT
("以下为选定广告的JS调用代码：");

29 
	g$wfm
 = 
$w
->
GWdow
("hd",
$showhtml
);

30 
	g$w
->
Diy
();

31 
ex
();

33 if(
	g$do
=='testjs')

35 
echo
 "<script src='{$cfg_phpurl}/ad_js.php?aid=$aid&nocache=1'anguage='javascript'></script>";

36 
ex
();

38 if(
	g$do
=='saveedit')

40 
$ime
 = 
GMkTime
($starttime);

41 
	g$dtime
 = 
GMkTime
(
$dtime
);

42 
	g$quy
 = "Update `#@__myad`

43 
t


44 
tyid
='$typeid',

45 
	gadme
='$adname',

46 
	gtimet
='$timeset',

47 
	gime
='$starttime',

48 
	gdtime
='$endtime',

49 
	gnmbody
='$normbody',

50 
	gexpbody
='$expbody'

51 
whe
 
aid
='$aid'

53 
$dsql
->
ExecuNeQuy
(
$quy
);

54 
ShowMsg
("成功更改一则广告代码！",
$ENV_GOBACK_URL
);

55 
ex
();

57 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__myad` whereid='$aid'");

58 
ude
 
DedeInude
('templets/ad_edit.htm');

	@dede/ad_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/datalistcp.class.php');

4 
que_
(
DEDEINC
.'/common.func.php');

5 
tcook
('ENV_GOBACK_URL',
$dedeNowu
,
time
()+3600,'/');

7 
	g$sql
 = "Selectd.aid,ad.tagname,tp.typename,ad.adname,ad.timeset,ad.endtime

8 
From
 `#@
__myad
` 
ad
 

 
jo
 `#@
__y
` 

 

p.
id
d.
tyid


9 
d
 
by
 
ad
.
aid
 
desc
";

11 
$dli
 = 
w
 
DaLiCP
();

12 
	g$dli
->
STem
(
DEDEADMIN
."/templets/ad_main.htm");

13 
	g$dli
->
SSour
(
$sql
);

14 
	g$dli
->
diy
();

16 
funi
 
	$TeTy
(
$ame
)

18 if(
$ame
=="")

24  
$ame
;

26 
	}
}

28 
funi
 
	$TimeSVue
(
$ts
)

30 if(
$ts
==0)

38 
	}
}

	@dede/ajax.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_Edit,a_AccEdit,a_MyEdit');

5 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

7 
AjaxHd
();

10 if(
	g$ai
 == 'show')

12 
$sql
 = "selectitle from #@__archives where id=$aid";

13 
	g$row
 = 
$dsql
->
ge
(
$sql
);

14 
	gecho
 '<puty="xt" id="v_'.
	g$aid
.'"ame="t" vue="'.
	g$row
['title'].'" />';

15 
	gecho
 '<bu onick="poT(\''.
	g$aid
.'\')">提交</button>';

19 
if
(
$ai
 == 'post')

21 
$sql
 = "update #@__archives setitle='$title' where id=$aid";

22 
	g$dsql
->
execunequy
(
$sql
);

23 
	gecho
 '<hf="chives_do.php?aid='.
	g$aid
.'&dopost=editArchives"

24 
	gcڋxtmu
="ShowMenu(event,this,'.$aid.',\''.urlencode($title).'\')">

25 <
u
>'.$t.'</u></
a
>';

	@dede/album_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_New,a_AccNew');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

7 if(
	$emy
(
$do
))

9 
$do
 = '';

10 
	}
}

11 if(
	g$do
 != 'save')

13 
que_
(
DEDEINC
."/dedetag.class.php");

14 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

15 
CˬMyAdd
();

16 
	g$chlid
 = 
emy
(
$chlid
? 0 : 
tv
($channelid);

17 
	g$cid
 = 
emy
(
$cid
? 0 : 
tv
($cid);

20 if(
	g$cid
>0 && 
	g$chlid
==0)

22 
$row
 = 
$dsql
->
GO
("Select channeltype From `#@__arctype` where id='$cid'; ");

23 
	g$chlid
 = 
$row
['channeltype'];

27 if(
	g$chlid
==0)

29 
$chlid
 = 2;

34 
	g$cInfos
 = 
$dsql
->
GO
(" Select * From `#@__channeltype` where id='$channelid' ");

35 
	g$chlid
 = 
$cInfos
['id'];

36 
ude
 
DedeInude
("templets/album_add.htm");

37 
ex
();

43 if(
	g$do
=='save')

45 
que_
(
DEDEINC
.'/image.func.php');

46 
que_
(
DEDEINC
.'/oxwindow.class.php');

48 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

49 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

50 if(
emy
(
$ick
)
	g$ick
 = (
$cfg_c_ick
=='-1' ? 
mt_nd
(50, 200) : $cfg_arc_click);

52 if(!
ist
(
$tyid2
)
	g$tyid2
 = 0;

53 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

54 if(!
ist
(
$me
)
	g$me
 = 0;

55 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

56 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

57 if(!
ist
(
$fmhtml
)
	g$fmhtml
 = 0;

58 if(!
ist
(
$fmz
)
	g$fmz
 = 0;

59 if(!
ist
(
$ddisf
)
	g$ddisf
 = 0;

60 if(!
ist
(
$dz
)
	g$dz
 = 0;

61 if(
emy
(
$ick
)
	g$ick
 = (
$cfg_c_ick
=='-1' ? 
mt_nd
(50, 200) : $cfg_arc_click);

63 if(
	g$tyid
==0)

65 
ShowMsg
("请指定文档的栏目！", "-1");

66 
ex
();

68 if(
emy
(
$chlid
))

70 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

71 
ex
();

73 if(!
CheckChl
(
$tyid
,
$chlid
) )

75 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

76 
ex
();

78 if(!
TePurvw
('a_New'))

80 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的权限！");

84 if(
emy
(
$wr
))
	g$wr
=
$curLog
->
gUrName
();

85 if(
emy
(
$sour
))
	g$sour
='未知';

86 
	g$pubde
 = 
GMkTime
(
$pubde
);

87 
	g$ndde
 = 
time
();

88 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

89 
	g$ismake
 = 
$ishtml
==0 ? -1 : 0;

90 
	g$t
 = 
eg_a
('"', '＂', 
$t
);

91 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

92 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

93 
	g$c
 = 
_subrR
(
$c
,7);

94 
	g$wr
 = 
_subrR
(
$wr
,20);

95 
	g$sour
 = 
_subrR
(
$sour
,30);

96 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

97 
	g$keywds
 = 
_subrR
(
$keywds
,60);

98 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

99 
	g$ur
 = 
GIP
();

100 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

102 
	g$k
 = -1;

104 
	g$admid
 = 
$curLog
->
gUrID
();

107 if(
emy
(
$ddieme
))

109 
	g$ddieme
 = 0;

111 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

114 if(
	g$ddisf
==1 && 
$lpic
=='')

116 if(
ist
(
$imgu1
))

118 
$lpic
 = 
GDDImage
('ddf', 
$imgu1
, 
$im
);

123 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$admid
);

124 if(
emy
(
$cID
))

126 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

127 
ex
();

130 
	g$imgus
 = "{dede:pagestyle maxwidth='$maxwidth'agepicnum='$pagepicnum' ddmaxwidth='$ddmaxwidth'ow='$row' col='$col' value='$pagestyle'/}\r\n";

131 
	g$hase
 = 
l
;

137 if(
	g$fmhtml
==1)

139 
$imagebody
 = 
rashes
($imagebody);

140 
	g$imgus
 .
GCurCڋAlbum
(
$imagebody
,
$cysour
,
$lpiame
);

141 if(
	g$ddisf
==1 && 
$lpic
=='' && !
emy
(
$lpiame
))

143 
$lpic
 = 
$lpiame
;

144 
	g$hase
 = 
ue
;

151 if(
	g$fmz
==1)

153 
ude_
(
DEDEINC
."/zip.class.php");

154 
ude_
(
DEDEADMIN
."/file_class.php");

155 
	g$zfe
 = 
$cfg_bad
.
r_a
(
$cfg_mase
,'',
$zfe
);

156 
	g$tmpzd
 = 
DEDEDATA
.'/ztmp/'.
_subr
(
md5
(
ExecTime
()),16);

157 
	g$ime
 = 
time
();

158 if(
fe_exis
(
$zfe
))

160 @
mkd
(
$tmpzd
,
$GLOBALS
['cfg_dir_purview']);

161 @
chmod
(
$tmpzd
,
$GLOBALS
['cfg_dir_purview']);

162 
	g$z
 = 
w
 
z
();

163 
	g$z
->
ExaA
(
$zfe
,
$tmpzd
);

164 
	g$fm
 = 
w
 
FeMagemt
();

165 
	g$imgs
 = 
y
();

166 
	g$fm
->
GMchFes
(
$tmpzd
,"jpg|g|gif",
$imgs
);

167 
	g$i
 = 0;

168 
fܗch
(
$imgs
 
as
 
$imgd
)

170 
	g$i
++;

171 
	g$vh
 = 
$cfg_image_d
."/".
MyDe
("Y-m",
$ime
);

172 
CeD
(
$vh
);

173 
	g$iu
 = 
$vh
."/".
MyDe
("d",
$ime
).
dd2ch
(MyDe("His",$ime).'-'.
$admid
."-{$i}".
mt_nd
(1000,9999));

174 
	g$iu
 = 
$iu
.
subr
(
$imgd
,-4,4);

175 
	g$imgfe
 = 
$cfg_bad
.
$iu
;

176 
cy
(
$imgd
,
$imgfe
);

177 
uƚk
(
$imgd
);

179 if(
is_fe
(
$imgfe
))

181 
	g$lpiame
 = 
$gey
 > 2 ? 
GImageMDD
(
$iu
,
$cfg_ddimg_width
) : '';

183 if(
	g$i
=='1')

185 if(!
$hase
 && 
$ddisf
==1 && 
$lpic
=='' && 
emy
(
$lpiame
))

187 
$lpiame
 = 
GImageMDD
(
$iu
,
$cfg_ddimg_width
);

190 
	g$fo
 = '';

191 
	g$imgfos
 = 
GImageSize
(
$imgfe
,
$fo
);

192 
	g$imgus
 ."{dede:img ddimg='$lpiame'ext='' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

195 
	g$quy
 = "

196 
INSERT
 
INTO
 #@
__uds
(
t
,
u
,
medty
,
width
,
height
,
aytime
,
fesize
,
uime
,
mid
)

197 
VALUES
 ('{$title}','{$iurl}','1','".$imginfos[0]."','".$imginfos[1]."','0','".filesize($imgfile)."','".$ntime."','$adminid');

199 
	g$dsql
->
ExecuNeQuy
(
$quy
);

200 
	g$fid
 = 
$dsql
->
GLaID
();

201 
AddMyAdd
(
$fid
, 
$iu
);

203 
WImg
(
$imgfe
, 'up');

205 if(!
	g$hase
 && 
	g$ddisf
==1 && 
$lpic
=='')

207 if(
emy
(
$lpiame
))

209 
$lpiame
 = 
$iu
;

210 
	g$lpiame
 = 
GImageMDD
(
$iu
, 
$cfg_ddimg_width
);

212 
	g$lpic
 = 
$lpiame
;

213 
	g$hase
 = 
ue
;

217 if(
	g$dz
==1)

219 
uƚk
(
$zfe
);

221 
	g$fm
->
RmDFes
(
$tmpzd
);

228 if(
is_y
(
$_SESSION
['bigfile_info']))

230 
fܗch
(
$_SESSION
['bigfe_fo'] 
as
 
$k
=>
$v
)

232 
$uefe
 = 
$cfg_bad
.
$v
;

233 if(

(
$v
)<2 || !
fe_exis
(
$uefe
)) ;

234 
	g$fo
 = '';

235 
	g$imgfos
 = 
GImageSize
(
$uefe
, 
$fo
);

236 
	g$lpiame
 = 
$gey
 > 2 ? 
GImageMDD
(
$v
, 
$cfg_ddimg_width
) : '';

237 if(!
	g$hase
 && 
	g$ddisf
==1 && 
$lpic
=='')

239 
$lpic
 = 
emy
(
$lpiame
? 
GImageMDD
(
$v
, 
$cfg_ddimg_width
) : $litpicname;

240 
	g$hase
 = 
ue
;

242 
	g$imgfo
 = !
emy
(
$
{'picfook'.
$k
}) ? ${'picinfook'.$k} : '';

243 
	g$imgus
 ."{dede:img ddimg='$lpiame'ext='$imgfo' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $v {/dede:img}\r\n";

247 
	g$imgus
 = 
addashes
(
$imgus
);

250 
	g$add_f
 = '';

251 
	g$add_v
 = '';

252 if(!
emy
(
$dede_addflds
))

254 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

255 
	g$add_f
 = '';

256 
	g$add_v
 = '';

257 if(
is_y
(
$addflds
))

259 
fܗch
(
$addflds
 
as
 
$v
)

261 if(
	g$v
=='')

265 
	g$vs
 = 
exode
(',',
$v
);

266 if(!
ist
(
$
{
$vs
[0]}))

268 
	g$
{
	g$vs
[0]} = '';

270 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

272 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

276 if(!
ist
(
$
{
$vs
[0]}))

278 
	g$
{
	g$vs
[0]} = '';

280 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$cID
);

282 
	g$add_f
 .','.
$vs
[0];

283 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

289 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

291 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

293 if(
	g$deu
!='' && !
eg
('j',
$ag
))

295 
	g$ag
 = (
$ag
=='' ? 'j' : $flag.',j');

299 if(
eg
('j', 
$ag
)
	g$ismake
 = -1;

301 
	g$quy
 = "INSERT INTO `#@__archives`(id,typeid,typeid2,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

302 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gnpo
,
	gdesti
,
	gkeywds
,
	gfame
,
	gdutyadm
)

303 
VALUES
 ('$arcID','$typeid','$typeid2','$sortrank','$flag','$ismake','$channelid','$arcrank','$click','$money','$title','$shorttitle',

305 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

307 
	g$gr
 = 
$dsql
->
GE
();

308 
	g$dsql
->
ExecuNeQuy
(" Delete From `#@__arctiny` where id='$arcID' ");

309 
ShowMsg
("把数据保存到数据库主表 `#@__chives` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

310 
ex
();

314 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

315 
	g$addb
 = 
im
(
$s
['addtable']);

316 if(
emy
(
$addb
))

318 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

319 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

320 
ShowMsg
("没找到当前模型[{$channelid}]的主表信息，无法完成操作！。","javascript:;");

321 
ex
();

323 
	g$u
 = 
GIP
();

324 
	g$quy
 = "INSERT INTO `$addtable`(aid,typeid,redirecturl,userip,pagestyle,maxwidth,imgurls,row,col,isrm,ddmaxwidth,pagepicnum{$inadd_f})

325 
Vues
('$cID','$tyid','$deu','$u','$gey','$maxwidth','$imgus','$row','$c','$im','$ddmaxwidth','$gium'{
$add_v
}); ";

326 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

328 
	g$gr
 = 
$dsql
->
GE
();

329 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

330 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

331 
ShowMsg
("把数据保存到数据库附加表 `{$addb}` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

332 
ex
();

336 
InTags
(
$gs
,
$cID
);

337 
	g$tU
 = 
MakeA
(
$cID
,
ue
,true);

338 if(
	g$tU
=='')

340 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

342 
CˬMyAdd
(
$cID
, 
$t
);

344 
	g$msg
 = "

346 <
a
 
hf
='bum_add.php?cid=$tyid'><
u
>继续发布图片</u></a>

347 &
nb
;&
	gnb
;

348 <
a
 
	ghf
='chives_do.php?aid=".$cID."&dodArchives'><
u
>更改图集</u></a>

349 &
nb
;&
	gnb
;

350 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>预览文档</u></a>

351 &
nb
;&
	gnb
;

352 <
a
 
	ghf
='log_do.php?cid=$tyid&doiArchives'><
u
>已发布图片管理</u></a>

353 &
nb
;&
	gnb
;

354 
	g$backu


356 
	g$msg
 = "<div sty=\"le-height:36px;height:36px\">{$msg}</div>".
GUpdeTe
();

358 
	g$wt
 = "成功发布一个图集！";

359 
	g$wecome_fo
 = "文章管理::发布图集";

360 
	g$w
 = 
w
 
OxWdow
();

361 
	g$w
->
AddT
("成功发布一个图集：");

362 
	g$w
->
AddMsgIm
(
$msg
);

363 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

364 
	g$w
->
Diy
();

	@dede/album_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_Edit,a_AccEdit,a_MyEdit');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

7 if(
	$emy
(
$do
))

9 
$do
 = '';

10 
	}
}

11 if(
	g$do
!='save')

13 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

14 
que_
(
DEDEINC
."/dedetag.class.php");

15 
CˬMyAdd
();

16 
	g$aid
 = 
tv
(
$aid
);

19 
	g$cQuy
 = "Select ch.typenames channelname,ar.membernamesankname,arc.*

20 
From
 `#@
__chives
` 
c


21 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


22 

 
jo
 `#@
__k
` 

 

r.
nk
=
c
.
k
 
whe
rc.
id
='$aid' ";

23 
$cRow
 = 
$dsql
->
GO
(
$cQuy
);

24 if(!
is_y
(
$cRow
))

26 
ShowMsg
("读取档案基本信息出错!","-1");

27 
ex
();

29 
	g$quy
 = "Se * From `#@__chy` whid='".
$cRow
['channel']."'";

30 
	g$cInfos
 = 
$dsql
->
GO
(
$quy
);

31 if(!
is_y
(
$cInfos
))

33 
ShowMsg
("读取频道配置信息出错!","javascript:;");

34 
ex
();

36 
	g$addb
 = 
$cInfos
['addtable'];

37 
	g$addRow
 = 
$dsql
->
GO
("Select * From `$addtable` whereid='$aid'");

38 
	g$chlid
 = 
$cRow
['channel'];

39 
	g$imgus
 = 
$addRow
["imgurls"];

40 
	g$maxwidth
 = 
$addRow
["maxwidth"];

41 
	g$gey
 = 
$addRow
["pagestyle"];

42 
	g$ow
 = 
$addRow
["row"];

43 
	g$ic
 = 
$addRow
["col"];

44 
	g$im
 = 
$addRow
["isrm"];

45 
	g$ddmaxwidth
 = 
$addRow
["ddmaxwidth"];

46 
	g$gium
 = 
$addRow
["pagepicnum"];

47 
	g$gs
 = 
GTags
(
$aid
);

48 
ude
 
DedeInude
("templets/album_edit.htm");

49 
ex
();

55 if(
	g$do
=='save')

57 
que_
(
DEDEINC
.'/image.func.php');

58 
que_
(
DEDEINC
.'/oxwindow.class.php');

60 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

61 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

62 if(
emy
(
$tyid2
)
	g$tyid2
 = 0;

63 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

64 if(!
ist
(
$me
)
	g$me
 = 0;

65 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

66 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

67 if(!
ist
(
$fmhtml
)
	g$fmhtml
 = 0;

68 if(!
ist
(
$fmz
)
	g$fmz
 = 0;

69 if(!
ist
(
$ddisf
)
	g$ddisf
 = 0;

70 if(!
ist
(
$dz
)
	g$dz
 = 0;

72 if(
	g$tyid
==0)

74 
ShowMsg
("请指定文档的栏目！","-1");

75 
ex
();

77 if(
emy
(
$chlid
))

79 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

80 
ex
();

82 if(!
CheckChl
(
$tyid
,
$chlid
))

84 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

85 
ex
();

87 if(!
TePurvw
('a_Edit'))

89 if(
TePurvw
('a_AccEdit'))

91 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的文档权限！");

95 
CheckArcAdm
(
$id
,
$curLog
->
gUrID
());

100 
	g$pubde
 = 
GMkTime
(
$pubde
);

101 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

102 
	g$ismake
 = 
$ishtml
==0 ? -1 : 0;

103 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

104 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

105 
	g$c
 = 
_subrR
(
$c
,7);

106 
	g$wr
 = 
_subrR
(
$wr
,20);

107 
	g$sour
 = 
_subrR
(
$sour
,30);

108 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

109 
	g$keywds
 = 
im
(
_subrR
(
$keywds
,60));

110 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

111 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

113 
	g$k
 = -1;

115 
	g$admid
 = 
$curLog
->
gUrID
();

118 if(
emy
(
$ddieme
))

120 
	g$ddieme
 = 0;

122 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

125 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

127 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

129 if(
	g$deu
!='' && !
eg
('j',
$ag
))

131 
	g$ag
 = (
$ag
=='' ? 'j' : $flag.',j');

135 if(
eg
('j', 
$ag
)
	g$ismake
 = -1;

137 
	g$quy
 = "

138 
upde
 `#@
__chives
` 
t


139 
tyid
='$typeid',

140 
	gtyid2
='$typeid2',

141 
	gs܌k
='$sortrank',

142 
	gag
='$flag',

143 
	gick
='$click',

144 
	gismake
='$ismake',

145 
	gk
='$arcrank',

146 
	gmey
='$money',

147 
	gt
='$title',

148 
	gc
='$color',

149 
	gsour
='$source',

150 
	gwr
='$writer',

151 
	glpic
='$litpic',

152 
	gpubde
='$pubdate',

153 
	gnpo
='$notpost',

154 
	gdesti
='$description',

155 
	gkeywds
='$keywords',

156 
	gsh܉
='$shorttitle',

157 
	gfame
='$filename',

158 
	gdutyadm
='$adminid'

159 
whe
 
id
='$id'; ";

161 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

163 
ShowMsg
("更新数据库chives表时出错，请检查！".
$dsql
->
GE
(),"javascript:;");

164 
ex
();

167 
	g$imgus
 = "{dede:pagestyle maxwidth='$maxwidth'agepicnum='$pagepicnum' ddmaxwidth='$ddmaxwidth'ow='$row' col='$col' value='$pagestyle'/}\r\n";

168 
	g$hase
 = 
l
;

173 
	g$i
=1;$i<=120;$i++)

175 if!
ist
(
$
{'imgu'.
$i
}) ) ;

176 
	g$fo
 = '';

177 
	g$ifo
 = 
r_a
("'", "`", 
rashes
(
$
{'imgmsg'.
$i
}));

178 
	g$iu
 = 
rashes
(
$
{'imgu'.
$i
});

179 
	g$ddu
 = 
rashes
(
$
{'imgddu'.
$i
});

180 if(
eg_mch
("/swfud/i", 
$ddu
)
	g$ddu
 = '';

181 
	g$imgfe
 = 
$cfg_bad
.
$iu
;

182 
	g$limgfe
 = 
$cfg_bad
.
$ddu
;

184 if
ist
(
$
{'imgfe'.
$i
}&& 
is_uded_fe
(${'imgfile'.$i}) )

186 
	g$tmpFe
 = 
$
{'imgfe'.
$i
};

188 
	g$imgfos
 = @
GImageSize
(
$tmpFe
, 
$fo
);

189 if(!
is_y
(
$imgfos
))

191 
	g$imgfos
 = @
GImageSize
(
$imgfe
, 
$fo
);

192 
	g$imgus
 ."{dede:img ddimg='$ddu'ext='$ifo' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

195 
move_uded_fe
(
$tmpFe
, 
$imgfe
);

196 
	g$imgfos
 = @
GImageSize
(
$imgfe
, 
$fo
);

197 if(
	g$ddu
==
$iu
)

199 
$lpiame
 = 
$gey
 > 2 ? 
GImageMDD
(
$iu
, 
$cfg_ddimg_width
) : '';

200 
	g$limgfe
 = 
$cfg_bad
.
$lpiame
;

204 if(
	g$cfg_ddimg_fu
=='Y'
ImageResizeNew
(
$imgfe
, 
$cfg_ddimg_width
, 
$cfg_ddimg_height
, 
$limgfe
);

205 
ImageResize
(
$imgfe
, 
$cfg_ddimg_width
, 
$cfg_ddimg_height
, 
$limgfe
);

206 
	g$lpiame
 = 
$ddu
;

208 
	g$imgus
 ."{dede:img ddimg='$lpiame'ext='$ifo' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

213 
	g$ifo
 = 
r_a
("'", "`", 
rashes
(
$
{'imgmsg'.
$i
}));

214 
	g$iu
 = 
rashes
(
$
{'imgu'.
$i
});

215 
	g$ddu
 = 
rashes
(
$
{'imgddu'.
$i
});

216 if(
eg_mch
("/swfud/i", 
$ddu
))

218 
	g$ddu
 = 
$gey
 > 2 ? 
GImageMDD
(
$iu
, 
$cfg_ddimg_width
) : '';

220 
	g$imgfos
 = @
GImageSize
(
$imgfe
, 
$fo
);

221 
	g$imgus
 ."{dede:img ddimg='$ddu'ext='$ifo' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

228 if(
	g$fmhtml
==1 && !
emy
(
$imagebody
))

230 
$imagebody
 = 
rashes
($imagebody);

231 
	g$imgus
 .
GCurCڋAlbum
(
$imagebody
,
$cysour
,
$lpiame
);

232 if(
	g$ddisf
==1 && 
$lpic
=="" && !
emy
(
$lpiame
))

234 
$lpic
 = 
$lpiame
;

235 
	g$hase
 = 
ue
;

242 if(
	g$fmz
==1)

244 
ude_
(
DEDEINC
."/zip.class.php");

245 
ude_
(
DEDEADMIN
."/file_class.php");

246 
	g$zfe
 = 
$cfg_bad
.
r_a
(
$cfg_mase
,'',
$zfe
);

247 
	g$tmpzd
 = 
DEDEDATA
.'/ztmp/'.
_subr
(
md5
(
ExecTime
()),16);

248 
	g$ime
 = 
time
();

249 if(
fe_exis
(
$zfe
))

252 @
mkd
(
$tmpzd
,
$GLOBALS
['cfg_dir_purview']);

253 @
chmod
(
$tmpzd
,
$GLOBALS
['cfg_dir_purview']);

254 
	g$z
 = 
w
 
z
();

255 
	g$z
->
ExaA
(
$zfe
,
$tmpzd
);

256 
	g$fm
 = 
w
 
FeMagemt
();

257 
	g$imgs
 = 
y
();

258 
	g$fm
->
GMchFes
(
$tmpzd
,"jpg|g|gif",
$imgs
);

259 
	g$i
 = 0;

260 
fܗch
(
$imgs
 
as
 
$imgd
)

262 
	g$i
++;

263 
	g$vh
 = 
$cfg_image_d
."/".
MyDe
("Y-m",
$ime
);

264 
CeD
(
$vh
);

265 
	g$iu
 = 
$vh
."/".
MyDe
("d",
$ime
).
dd2ch
(MyDe("His",$ime).'-'.
$admid
."-{$i}".
mt_nd
(1000,9999));

266 
	g$iu
 = 
$iu
.
subr
(
$imgd
,-4,4);

267 
	g$imgfe
 = 
$cfg_bad
.
$iu
;

268 
cy
(
$imgd
,
$imgfe
);

269 
uƚk
(
$imgd
);

270 if(
is_fe
(
$imgfe
))

272 
	g$lpiame
 = 
$gey
 > 2 ? 
GImageMDD
(
$iu
,
$cfg_ddimg_width
) : '';

273 
	g$fo
 = '';

274 
	g$imgfos
 = 
GImageSize
(
$imgfe
,
$fo
);

275 
	g$imgus
 ."{dede:img ddimg='$lpiame'ext='' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

278 
	g$quy
 = "

279 
INSERT
 
INTO
 #@
__uds
(
t
,
u
,
medty
,
width
,
height
,
aytime
,
fesize
,
uime
,
mid
)

280 
VALUES
 ('{$title}','{$iurl}','1','".$imginfos[0]."','".$imginfos[1]."','0','".filesize($imgfile)."','".$ntime."','$adminid');

282 
	g$dsql
->
ExecuNeQuy
(
$quy
);

283 if(!
	g$hase
 && 
	g$ddisf
==1

284 && 
$lpic
=="" && !
emy
(
$lpiame
))

286 if
fe_exis
(
$cfg_bad
.
$lpiame
) )

288 
$lpic
 = 
$lpiame
;

289 
	g$hase
 = 
ue
;

294 if(
	g$dz
==1)

296 
uƚk
(
$zfe
);

298 
	g$fm
->
RmDFes
(
$tmpzd
);

305 if(
is_y
(
$_SESSION
['bigfile_info']))

307 
fܗch
(
$_SESSION
['bigfe_fo'] 
as
 
$k
=>
$v
)

309 
$uefe
 = 
$cfg_bad
.
$v
;

310 if(

(
$v
)<2 || !
fe_exis
(
$uefe
)) ;

311 
	g$fo
 = '';

312 
	g$imgfos
 = 
GImageSize
(
$uefe
, 
$fo
);

313 
	g$lpiame
 = 
$gey
 > 2 ? 
GImageMDD
(
$v
, 
$cfg_ddimg_width
) : '';

314 
	g$imgfo
 = !
emy
(
$
{'picfook'.
$k
}) ? ${'picinfook'.$k} : '';

315 
	g$imgus
 ."{dede:img ddimg='$lpiame'ext='$imgfo' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $v {/dede:img}\r\n";

319 
	g$imgus
 = 
addashes
(
$imgus
);

322 
	g$add_f
 = '';

323 
	g$add_v
 = '';

324 if(!
emy
(
$dede_addflds
))

326 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

327 
	g$add_f
 = '';

328 
	g$add_v
 = '';

329 if(
is_y
(
$addflds
))

331 
fܗch
(
$addflds
 
as
 
$v
)

333 if(
	g$v
=='')

337 
	g$vs
 = 
exode
(',',
$v
);

338 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

340 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

342 if(!
ist
(
$
{
$vs
[0]}))

344 
	g$
{
	g$vs
[0]} = '';

346 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$id
);

348 
	g$add_f
 .",`{$vs[0]}` = '".
$
{
$vs
[0]}."'";

354 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

355 
	g$addb
 = 
im
(
$s
['addtable']);

356 if(
	g$addb
!='')

358 
$u
 = 
GIP
();

359 
	g$quy
 = "Update `$addtable`

360 
t
 
tyid
='$typeid',

361 
	ggey
='$pagestyle',

362 
	gmaxwidth
 = '$maxwidth',

363 
	gddmaxwidth
 = '$ddmaxwidth',

364 
	ggium
 = '$pagepicnum',

365 
	gimgus
='$imgurls',

366 
	grow
='$row',

367 
	gc
='$col',

368 
	gim
='$im'{
$add_f
},

369 
	gdeu
='$redirecturl',

370 
	gur
 = '$useip'

371 
whe
 
aid
='$id'; ";

372 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

374 
ShowMsg
("更新附加表 `$addb` 时出错，请检查原因！".
$dsql
->
GE
(),"javascript:;");

375 
ex
();

380 
UpIndexKey
(
$id
,
$k
,
$tyid
,
$s܌k
,
$gs
);

381 
	g$cU
 = 
MakeA
(
$id
,
ue
,true);

382 if(
	g$cU
=='')

384 
$cU
 = 
$cfg_phpu
."/view.php?aid=$id";

386 
CˬMyAdd
(
$id
, 
$t
);

388 
	g$msg
 =

390 <
a
 
hf
='bum_add.php?cid=$tyid'><
u
>继续发布图片</u></a>

391 &
nb
;&
	gnb
;

392 <
a
 
	ghf
='chives_do.php?aid=".$id."&dodArchives'><
u
>查看更改</u></a>

393 &
nb
;&
	gnb
;

394 <
a
 
	ghf
='$cU' 
rg
='_bnk'><
u
>预览文档</u></a>

395 &
nb
;&
	gnb
;

396 <
a
 
	ghf
='log_do.php?cid=$tyid&doiArchives'><
u
>管理已发布图片</u></a>

397 &
nb
;&
	gnb
;

398 
	g$backu


401 
	g$wt
 = "成功更改图集！";

402 
	g$wecome_fo
 = "文章管理::更改图集";

403 
	g$w
 = 
w
 
OxWdow
();

404 
	g$w
->
AddT
("成功更改一个图集：");

405 
	g$w
->
AddMsgIm
(
$msg
);

406 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

407 
	g$w
->
Diy
();

	@dede/album_testhtml.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
AjaxHd
();

4 
	g$myhtml
 = 
UnicodeU2Gbk
(
rashes
(
$myhtml
));

5 
	gecho
 "<div class='coolbg61'>[<a href='#' onclick='javascript:HideObj(\"_myhtml\")'>关闭</a>]</div>\r\n";

6 
eg_mch_l
("/(c|SRC)=[\"|'| ]{0,}(hp:\/\/(.*)\.(gif|jpg|jg|g))/isU",
$myhtml
,
$img_y
);

7 
	g$img_y
 = 
y_unique
(
$img_y
[2]);

8 
	gecho
 "<div class='coolbg62'><xmp>";

9 
	gecho
 "捕获的图片：\r\n";

10 
t_r
(
$img_y
);

11 
	gecho
 "</xmp></div>\r\n";

	@dede/api_ucenter.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('api_ucenter');

4 if(!
funi_exis
('fe_put_cڋs')){ 
funi
 
fe_put_cڋs
(
$fame
, 
$s
)

6 
	g$
 = @
fݒ
(
$fame
, 'w');

7 @
fwre
(
$
, 
$s
);

8 @
fo
(
$
);

9  
	gTRUE
;

11 
que_
(
DEDEINC
.'/dedetemplate.class.php');

12 if(
fe_exis
(
DEDEROOT
.'/uc_client/client.php'))

14 if(!
defed
('UC_API')
defe
('UC_API', '');

15 
ude_
 
	gDEDEROOT
.'/uc_client/client.php';

19 
ShowMsg
('请安装UCenter模块!',-1);

20 
ex
();

23 
	g$do
 = 
i_gpc
('dopost','R');

25 
	g$uc
 = 
w
 
i_u
(
$do
);

27 as
	ci_u


29 
v
 
	m$ai
;

30 
v
 
	m$d
;

31 
v
 
	m$cfig
;

34 
funi
 
__cڡru
(
$ac
 = '')

36 
$ai
 = 'uc_'.(
emy
(
$ac
)||(!
_y
($ac,
y
('l','ed'))? 'show' : 
im
($ac));

37 
	m$this
->
	md
 = 
w
 
DedeTeme
();

38 
	m$this
->
	mcfig
 = 
DEDEINC
.'/common.inc.php';

39 
	m$this
->
$ai
();

43 
funi
 
i_u
(
$ac
 = '')

45 
$this
->
__cڡru
(
$ac
);

48 
funi
 
	$uc_l
()

50 
$uc_tgs
 = 
	`i_gpc
('uc_setings','P');

52 if(!
	`ist
(
$uc_tgs
['authkey']|| 
	`emy
($uc_setings['authkey']))

54 
	`ShowMsg
('请填写uc创始人密码!',-1);

55 
	`ex
();

58 
$uc_tgs
['upi'] = 
	`eg_a
("/\/$/", '', 
	`im
($uc_setings['ucapi']));

60 if(
	`emy
(
$uc_tgs
['upi']|| !
	`eg_mch
("/^(http:\/\/)/i", $uc_setings['ucapi']))

62 
	`ShowMsg
('请填正确的服务端地址以http://开头!',-1);

63 
	`ex
();

67 if(!
$uc_tgs
['ucip'])

69 
$mp
 = @
	`r_u
(
$uc_tgs
['ucapi']);

70 
$uc_tgs
['upi'] = 
	`ghobyme
(
$mp
['host']);

71 if(
	`2lg
(
$uc_tgs
['upi']=-1 || ip2lg($uc_tgs['upi']==
FALSE
)

73 
$uc_tgs
['ucip'] = '127.0.0.1';

78 
$ucfo
 = 
	`i_fݒ
(
$uc_tgs
['ucapi'].'/index.php?m=app&a=ucinfo', 500, '', '', 1, $uc_setings['ucip']);

79 
	`li
(
$us
, 
$ucvsi
, 
$u
, 
$uccht
, 
$ucdbcht
, 
$ys

	`exode
('|', 
$ucfo
);

81 if(
$us
 != 'UC_STATUS_OK')

83 
	`ShowMsg
('uc服务端地址无效,请仔细检查您安装的uc服务端地址!',-1);

84 
	`ex
();

88 
$ucdbcht
 = 
	`ow
($ucdbch? 
	`r_a
('-', '', $ucdbcharset) : $ucdbcharset);

89 if(
UC_CLIENT_VERSION
 > 
$ucvsi
)

91 
	`ShowMsg
('uc服务端版本不一致,您当前的uc客服端版本为:'.
UC_CLIENT_VERSION
.',而服务端版本为:'.
$ucvsi
.'!',-1);

92 
	`ex
();

94 
	`if
(
$ucdbcht
 != 'utf8')

96 
	`ShowMsg
('uc服务端编码为:'.
$ucdbcht
.'与DedeCMS编码不一致!要求您的uc服务端编码为:utf8编码.',-1);

97 
	`ex
();

100 
$p_gmes
 = 'agmes[me]='.
	`ucode
('<a href="{url}"arget="_blank">{title}</a>').'&'.

101 'agmes[flds][t]='.
	`ucode
('标题').'&'.

102 'agmes[flds][wr]='.
	`ucode
('作者').'&'.

103 'agmes[flds][pubde]='.
	`ucode
('时间').'&'.

104 'agmes[flds][u]='.
	`ucode
('地址');

106 
$poda
 = 'm&add&ucfound=&ucfoundpw='.
	`ucode
(
$uc_tgs
['authkey']).'&y=OTHER&ame='.ucode(
$GLOBALS
['cfg_webme']).'&pu='.ucode($GLOBALS['cfg_baho']).'&p=&pcht=utf-8&pdbcht=utf8&'.
$p_gmes
.'&a='.
UC_CLIENT_RELEASE
;

108 
$uccfig
 = 
	`i_fݒ
(
$uc_tgs
['upi'].'/dex.php', 500, 
$poda
, '', 1, $uc_setings['ucip']);

110 if(
	`rr
(
$uccfig
,'<?xml'))

112 
$mp
 = 
	`exode
('<?xml', 
$uccfig
);

113 
$uccfig
 = 
$mp
[0]; 
	`unt
($temp);

116 if(
	`emy
(
$uccfig
))

118 
	`ShowMsg
('请填写有效的配置信息!',-1);

119 
	`ex
();

121 
	`if
(
$uccfig
 == '-1')

123 
	`ShowMsg
('创始人密码错误!',-1);

124 
	`ex
();

128 
	`li
(
$uthkey
, 
$pid

	`exode
('|', 
$uccfig
);

129 if(
	`emy
(
$uthkey
||my(
$pid
))

131 
	`ShowMsg
('数据获取失败!',-1);

132 
	`ex
();

134 
	`if
(
$suced
 = 
	`i_wre_cfig
(
$uccfig
."|".
$uc_tgs
['upi']."|".$uc_tgs['uc'], 
$this
->
cfig
))

136 
	`ShowMsg
('安装成功!',-1);

137 
	`ex
();

141 
	`ShowMsg
('写入配置数据失败!'.
$this
->
cfig
.' 请设置可写权限!',-1);

142 
	`ex
();

146 
	}
}

148 
funi
 
	$uc_ed
()

150 
$uc_tgs
 = 
	`i_gpc
('uc_setings','P');

151 
$uc_dbss
 = 
$uc_tgs
['dbss'] ='********' ? 
UC_DBPW
 : $uc_setings['dbpass'];

152 
$
 = 
	`fݒ
(
$this
->
cfig
, 'r');

153 
$cڋ
 = 
	`d
(
$
, 
	`fesize
(
$this
->
cfig
));

154 
$cڋ
 = 
	`im
($content);

155 
$cڋ
 = 
	`subr
($content, -2) == '?>' ? substr($content, 0, -2) : $content;

156 
$cڋ
 = 
	`rr
($cڋ, '_|cfg_|GLOBALS'? 
	`r_a
('_|cfg_|GLOBALS','cfg_|GLOBALS',$content) : $content;

157 
	`fo
(
$
);

159 
$c
 = '';

160 if(
$uc_tgs
['connect'])

162 
$uc_dblk
 = @
	`mysql_c
(
$uc_tgs
['dbho'], $uc_tgs['dbur'], 
$uc_dbss
, 1);

163 if(!
$uc_dblk
)

165 
	`ShowMsg
('数据库连接失败!',-1);

166 
	`ex
();

168 
	`mysql_o
(
$uc_dblk
);

171 
$c
 = 'mysql';

172 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_DBHOST',\s*'.*?'\);/i", "defe('UC_DBHOST', '".
$uc_tgs
['dbhost']."');");

173 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_DBUSER',\s*'.*?'\);/i", "defe('UC_DBUSER', '".
$uc_tgs
['dbuser']."');");

174 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_DBPW',\s*'.*?'\);/i", "defe('UC_DBPW', '".
$uc_dbss
."');");

175 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_DBNAME',\s*'.*?'\);/i", "defe('UC_DBNAME', '".
$uc_tgs
['dbname']."');");

176 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_DBTABLEPRE',\s*'.*?'\);/i", "defe('UC_DBTABLEPRE', '`".
$uc_tgs
['dbname'].'`.'.$uc_setings['dbtablepre']."');");

179 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_CONNECT',\s*'.*?'\);/i", "define('UC_CONNECT', '$connect');");

180 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_KEY',\s*'.*?'\);/i", "defe('UC_KEY', '".
$uc_tgs
['authkey']."');");

181 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_API',\s*'.*?'\);/i", "defe('UC_API', '".
$uc_tgs
['ucapi']."');");

182 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_IP',\s*'.*?'\);/i", "defe('UC_IP', '".
$uc_tgs
['ucip']."');");

183 
$cڋ
 = 
	`i__cfig
($cڋ, "/defe\('UC_APPID',\s*'?.*?'?\);/i", "defe('UC_APPID', '".
UC_APPID
."');");

184 
$cڋ
 .= '?>';

186 if(
$
 = @
	`fݒ
(
$this
->
cfig
, 'w'))

188 @
	`fwre
(
$
, 
	`im
(
$cڋ
));

189 @
	`fo
(
$
);

190 
	`ShowMsg
('配置已经更改!',-1);

191 
	`ex
();

193 
	`ShowMsg
('写入配置数据失败!'.
$this
->
cfig
.' 请设置可写权限!',-1);

194 
	`ex
();

196 
	}
}

198 
funi
 
	$uc_show
()

200 
$this
->
d
->
	`Assign
('uc_cfig_fe',$this->
cfig
);

202 if(!
	`defed
('UC_APPID'))

204 
$this
->
d
->
	`LdTeme
(
DEDEADMIN
.'/templets/api_ucenter_install.htm');

208 
$uc_i_ݒ
 = 
l
;

209 
$uy
 = 
	`uc_p_ls
();

210 
	`fܗch
(
$uy
 
as
 
$ay
)

212 if(
$ay
['pid'] =
UC_APPID
)

214 
$uc_i_ݒ
 = 
ue
;

219 if(!
$uc_i_ݒ
)

221 
	`ShowMsg
("DedeCMS没找到正确的uc配置！",-1);

222 
	`ex
();

226 
	`li
(
$dbme
,
$dbb˴e

	`exode
('.',
	`r_a
('`','',
UC_DBTABLEPRE
));

227 
$uc_tgs
 = 
	`y
('pid' => 
UC_APPID
, 'upi' => 
UC_API
, 'c' => 
UC_CONNECT
, 'dbho' => 
UC_DBHOST
, 'dbur' => 
UC_DBUSER
,'dbss' => 
UC_DBPW
, 'dbme' => 
$dbme
, 'dbb˴e' => 
$dbb˴e
,'uc' => 
UC_IP
,'authkey' => 
UC_KEY
);

229 
$this
->
d
->
	`Assign
('uc_tgs',
$uc_tgs
);

230 
$this
->
d
->
	`LdTeme
(
DEDEADMIN
.'/templets/api_ucenter_edit.htm');

232 
$this
->
d
->
	`Diy
();

233 
	`ex
();

234 
	}
}

239 
funi
 
i_fݒ
(
$u
, 
$lim
 = 0, 
$po
 = '', 
$cook
 = '', 
$bysock
 = 
FALSE
, 
$
 = '', 
$timeout
 = 15, 
$block
 = 
TRUE
)

241 
$tu
 = '';

242 
	g$mches
 = 
r_u
(
$u
);

243 
	g$ho
 = 
$mches
['host'];

244 
	g$th
 = 
$mches
['path'] ? $matches['path'].($matches['query'] ? '?'.$matches['query'] : '') : '/';

245 
	g$pt
 = !
emy
(
$mches
['port']) ? $matches['port'] : 80;

247 if(
	g$po
)

249 
	g$out
 = "POST $path HTTP/1.0\r\n";

250 
	g$out
 .= "Accept: */*\r\n";

252 
	g$out
 .= "Accept-Language: zh-cn\r\n";

253 
	g$out
 .= "Content-Type:pplication/x-www-form-urlencoded\r\n";

254 
	g$out
 .= "User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n";

255 
	g$out
 .= "Host: $host\r\n";

256 
	g$out
 .'Cڋ-Lgth: '.

(
$po
)."\r\n";

257 
	g$out
 .= "Connection: Close\r\n";

258 
	g$out
 .= "Cache-Control:o-cache\r\n";

259 
	g$out
 .= "Cookie: $cookie\r\n\r\n";

260 
	g$out
 .
$po
;

262 
	g$out
 = "GET $path HTTP/1.0\r\n";

263 
	g$out
 .= "Accept: */*\r\n";

265 
	g$out
 .= "Accept-Language: zh-cn\r\n";

266 
	g$out
 .= "User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n";

267 
	g$out
 .= "Host: $host\r\n";

268 
	g$out
 .= "Connection: Close\r\n";

269 
	g$out
 .= "Cookie: $cookie\r\n\r\n";

271 
	g$
 = @
fsockݒ
((
$ho
 ? $ho : 
$
), 
$pt
, 
$o
, 
$rr
, 
$timeout
);

272 if(!
	g$
)

276 
am_t_blockg
(
$
, 
$block
);

277 
am_t_timeout
(
$
, 
$timeout
);

278 @
fwre
(
$
, 
$out
);

279 
	g$us
 = 
am_g_ma_da
(
$
);

280 if(!
	g$us
['timed_out'])

282 !
of
(
$
))

284 if((
	g$hd
 = @
fgs
(
$
)&& (
$hd
 == "\r\n" || $header == "\n"))

290 
	g$
 = 
l
;

291 !
of
(
$
&& !
	g$
)

293 
	g$da
 = 
d
(
$
, (
$lim
 == 0 || $limit > 8192 ? 8192 : $limit));

294 
	g$tu
 .
$da
;

295 if(
	g$lim
)

297 
	g$lim
 -

(
$da
);

298 
	g$
 = 
$lim
 <= 0;

302 @
fo
(
$
);

303  
	g$tu
;

307 
funi
 
	$i_wre_cfig
(
$cfig
, 
$fe
)

309 
$sucss
 = 
l
;

310 
	`li
(
$uthkey
, 
$pid
, 
$ucdbho
, 
$ucdbme
, 
$ucdbur
, 
$ucdbpw
, 
$ucdbcht
, 
$uab˴e
, 
$uccht
, 
$upi
, 
$uc

	`exode
('|', 
$cfig
);

312 if(
$cڋ
 = 
	`fe_g_cڋs
(
$fe
))

314 
$cڋ
 = 
	`im
($content);

315 
$cڋ
 = 
	`subr
($content, -2) == '?>' ? substr($content, 0, -2) : $content;

316 
$cڋ
 = 
	`rr
($cڋ, '_|cfg_|GLOBALS'? 
	`r_a
('_|cfg_|GLOBALS','cfg_|GLOBALS',$content) : $content;

317 
$lk
 = 
	`mysql_c
(
$ucdbho
, 
$ucdbur
, 
$ucdbpw
, 1);

318 
$uc_ce
 = 
$lk
 && 
	`mysql__db
(
$ucdbme
, $link) ? 'mysql' : '';

319 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_CONNECT',\s*'.*?'\);/i", "define('UC_CONNECT', '$uc_connnect');");

320 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_DBHOST',\s*'.*?'\);/i", "define('UC_DBHOST', '$ucdbhost');");

321 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_DBUSER',\s*'.*?'\);/i", "define('UC_DBUSER', '$ucdbuser');");

322 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_DBPW',\s*'.*?'\);/i", "define('UC_DBPW', '$ucdbpw');");

323 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_DBNAME',\s*'.*?'\);/i", "define('UC_DBNAME', '$ucdbname');");

324 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_DBCHARSET',\s*'.*?'\);/i", "define('UC_DBCHARSET', '$ucdbcharset');");

325 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_DBTABLEPRE',\s*'.*?'\);/i", "define('UC_DBTABLEPRE', '`$ucdbname`.$uctablepre');");

326 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_DBCONNECT',\s*'.*?'\);/i", "define('UC_DBCONNECT', '0');");

327 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_KEY',\s*'.*?'\);/i", "define('UC_KEY', '$appauthkey');");

328 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_API',\s*'.*?'\);/i", "define('UC_API', '$ucapi');");

329 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_CHARSET',\s*'.*?'\);/i", "define('UC_CHARSET', '$uccharset');");

330 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_IP',\s*'.*?'\);/i", "define('UC_IP', '$ucip');");

331 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_APPID',\s*'?.*?'?\);/i", "define('UC_APPID', '$appid');");

332 
$cڋ
 = 
	`i__cfig
($content, "/define\('UC_PPP',\s*'?.*?'?\);/i", "define('UC_PPP', '20');");

333 
$cڋ
 .= "\r\n".'?>';

335 if(@
	`fe_put_cڋs
(
$fe
, 
$cڋ
))

337 
$sucss
 = 
ue
;

340  
$sucss
;

341 
	}
}

343 
funi
 
	$i__cfig
(
$s
, 
$fd
, 
$a
)

345 if(
	`eg_mch
(
$fd
, 
$s
))

347 
$s
 = 
	`eg_a
(
$fd
, 
$a
, $s);

350 
$s
 ."\r\n".
$a
;

352  
$s
;

353 
	}
}

355 
funi
 
i_gpc
(
$k
, 
$v
='R')

357 
$v
)

359 'G': 
$v
 = &
$_GET
; ;

360 'P': 
$v
 = &
$_POST
; ;

361 'C': 
$v
 = &
$_COOKIE
; ;

362 'R': 
$v
 = &
$_REQUEST
; ;

364  
ist
(
$v
[
$k
]? 
	g$v
[$k] : 
NULL
;

	@dede/archives_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('a_New,a_AccNew');

4 
que_
(
DEDEINC
.'/customfields.func.php');

5 
que_
(
DEDEADMIN
.'/inc/inc_archives_functions.php');

7 if(
	$emy
(
$do
))

9 
$do
 = '';

10 
	}
}

11 if(
	g$do
 != 'save')

13 
que_
(
DEDEINC
.'/dedetag.class.php');

14 
que_
(
DEDEADMIN
.'/inc/inc_catalog_options.php');

15 
CˬMyAdd
();

16 
	g$chlid
 = 
emy
(
$chlid
? 0 : 
tv
($channelid);

17 
	g$cid
 = 
emy
(
$cid
? 0 : 
tv
($cid);

20 if(
	g$cid
 > 0 && 
	g$chlid
 == 0)

22 
$row
 = 
$dsql
->
GO
("Select channeltype From `#@__arctype` where id='$cid'; ");

23 
	g$chlid
 = 
$row
['channeltype'];

27 if(
	g$chlid
==0)

29 
ShowMsg
('无法识别模型信息，因此无法操作！', '-1');

30 
ex
();

35 
	g$cInfos
 = 
$dsql
->
GO
(" Select * From `#@__channeltype` where id='$channelid' ");

36 
	g$chlid
 = 
$cInfos
['id'];

37 
ude
 
DedeInude
('templets/archives_add.htm');

38 
ex
();

44 if(
	g$do
=='save')

46 
que_
(
DEDEINC
.'/image.func.php');

47 
que_
(
DEDEINC
.'/oxwindow.class.php');

49 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

50 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

51 if(
emy
(
$ick
)
	g$ick
 = (
$cfg_c_ick
=='-1' ? 
mt_nd
(50, 200) : $cfg_arc_click);

53 if(
emy
(
$tyid2
)
	g$tyid2
 = 0;

54 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

55 if(!
ist
(
$me
)
	g$me
 = 0;

56 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

57 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

58 if(
emy
(
$ick
)
	g$ick
 = (
$cfg_c_ick
=='-1' ? 
mt_nd
(50, 200) : $cfg_arc_click);

60 if(
	g$tyid
==0)

62 
ShowMsg
('请指定文档的栏目！', '-1');

63 
ex
();

65 if(
emy
(
$chlid
))

67 
ShowMsg
('文档为非指定的类型，请检查你发布内容的表单是否合法！', '-1');

68 
ex
();

70 if(!
CheckChl
(
$tyid
,
$chlid
) )

72 
ShowMsg
('你所选择的栏目与当前模型不相符，请选择白色的选项！', '-1');

73 
ex
();

75 if(!
TePurvw
('a_New'))

77 
CheckCog
(
$tyid
, "对不起，你没有操作栏目 {$typeid} 的权限！");

81 if(
emy
(
$wr
)
	g$wr
 = 
$curLog
->
gUrName
();

82 if(
emy
(
$sour
)
	g$sour
 = '未知';

83 
	g$pubde
 = 
GMkTime
(
$pubde
);

84 
	g$ndde
 = 
time
();

85 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

86 
	g$ismake
 = 
$ishtml
 == 0 ? -1 : 0;

87 
	g$t
 = 
eg_a
('"', '＂', 
$t
);

88 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

89 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

90 
	g$c
 = 
_subrR
(
$c
,7);

91 
	g$wr
 = 
_subrR
(
$wr
,20);

92 
	g$sour
 = 
_subrR
(
$sour
,30);

93 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

94 
	g$keywds
 = 
_subrR
(
$keywds
,60);

95 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

96 
	g$ur
 = 
GIP
();

97 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

99 
	g$k
 = -1;

101 
	g$admid
 = 
$curLog
->
gUrID
();

104 if(
emy
(
$ddieme
))

106 
	g$ddieme
 = 0;

108 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

111 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$admid
);

113 if(
emy
(
$cID
))

115 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

116 
ex
();

120 
	g$add_f
 = 
$add_v
 = '';

121 if(!
emy
(
$dede_addflds
))

123 
	g$addflds
 = 
exode
(';', 
$dede_addflds
);

124 if(
is_y
(
$addflds
))

126 
fܗch
(
$addflds
 
as
 
$v
)

128 if(
	g$v
=='') ;

129 
	g$vs
 = 
exode
(',', 
$v
);

130 if(
	g$vs
[1]=='htmext' || 
$vs
[1]=='textdata')

132 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]}, 
$desti
, 
$lpic
, 
$keywds
, $vs[1]);

136 if(!
ist
(
$
{
$vs
[0]})
	g$
{
	g$vs
[0]} = '';

137 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]}, $vs[1], 
$cID
);

139 
	g$add_f
 .','.
$vs
[0];

140 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

146 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

148 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

150 if(
	g$deu
!='' && !
eg
('j',
$ag
))

152 
	g$ag
 = (
$ag
=='' ? 'j' : $flag.',j');

156 if(
eg
('j', 
$ag
)
	g$ismake
 = -1;

158 
	g$quy
 = "INSERT INTO `#@__archives`(id,typeid,typeid2,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

159 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gnpo
,
	gdesti
,
	gkeywds
,
	gfame
,
	gdutyadm
)

160 
VALUES
 ('$arcID','$typeid','$typeid2','$sortrank','$flag','$ismake','$channelid','$arcrank','$click','$money','$title','$shorttitle',

163 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

165 
	g$gr
 = 
$dsql
->
GE
();

166 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

167 
ShowMsg
("把数据保存到数据库主表 `#@__chives` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

168 
ex
();

172 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

173 
	g$addb
 = 
im
(
$s
['addtable']);

174 if(!
emy
(
$addb
))

176 
	g$u
 = 
GIP
();

177 
	g$quy
 = "INSERT INTO `{$addtable}`(aid,typeid,redirecturl,userip{$inadd_f}) Values('$arcID','$typeid','$redirecturl','$useip'{$inadd_v})";

178 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

180 
	g$gr
 = 
$dsql
->
GE
();

181 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

182 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

183 
ShowMsg
("把数据保存到数据库附加表 `{$addb}` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

184 
ex
();

189 
InTags
(
$gs
, 
$cID
);

190 
	g$tU
 = 
MakeA
(
$cID
, 
ue
,rue);

191 if(
	g$tU
=='')

193 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

195 
CˬMyAdd
(
$cID
, 
$t
);

197 
	g$msg
 = " 　　请选择你的后续操作：

198 <
a
 
hf
='chives_add.php?cid=$tyid'><
u
>继续发布文档</u></a>

199 &
nb
;&
	gnb
;

200 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文档</u></a>

201 &
nb
;&
	gnb
;

202 <
a
 
	ghf
='chives_do.php?aid=".$cID."&dodArchives'><
u
>更改文档</u></a>

203 &
nb
;&
	gnb
;

204 <
a
 
	ghf
='log_do.php?cid=$tyid&doiArchives'><
u
>已发布文档管理</u></a>

205 &
nb
;&
	gnb
;

206 
	g$backu


208 
	g$msg
 = "<div sty=\"le-height:36px;height:36px\">{$msg}</div>".
GUpdeTe
();

210 
	g$wt
 = '成功发布文档！';

211 
	g$wecome_fo
 = '文档管理::发布文档';

212 
	g$w
 = 
w
 
OxWdow
();

213 
	g$w
->
AddT
('成功发布文档：');

214 
	g$w
->
AddMsgIm
(
$msg
);

215 
	g$wfm
 = 
$w
->
GWdow
('hd', '&nb;', 
l
);

216 
	g$w
->
Diy
();

	@dede/archives_do.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEADMIN
.'/inc/inc_batchup.php');

4 
que_
(
DEDEADMIN
.'/inc/inc_archives_functions.php');

5 
que_
(
DEDEINC
.'/typelink.class.php');

6 
que_
(
DEDEINC
.'/arc.archives.class.php');

7 
	g$ENV_GOBACK_URL
 = (
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? 'content_list.php' : $_COOKIE['ENV_GOBACK_URL']);

9 if(
	$emy
(
$do
))

11 
	`ShowMsg
('对不起，你没指定运行参数！','-1');

12 
	`ex
();

13 
	}
}

14 
	g$aid
 = 
ist
(
$aid
? 
eg_a
('[^0-9]','',$aid) : '';

20 if(
	g$do
=='editArchives')

22 
$quy
 = "Selectrc.id,arc.typeid,ch.maintable,ch.editcon

23 
From
 `#@
__y
` 
c


24 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


25 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


26 
whe
 
c
.
id
='$aid' ";

27 
$row
 = 
$dsql
->
GO
(
$quy
);

28 
	g$gu
 = 
$row
['editcon'];

29 if(
	g$gu
=='')

31 
$gu
='article_edit.php';

33 
hd
("location:{$gurl}?aid=$aid");

34 
ex
();

41 if(
	g$do
=="viewArchives")

43 
$aid
 = 
eg_a
('[^0-9]','',$aid);

46 
	g$quy
 = "Selectrc.*,ch.maintable,ch.addtable,ch.issystem,ch.editcon,

47 

.
tyd
,
	g
.
	gtyme
,.
	gcܪk
,.
	gmu
,.
	gmu2
,.
	git
,.
	gmese
,.
	gsh
,.
seu


48 
	gFrom
 `#@
	g__y
` 
c


49 

 
	gjo
 `#@
	g__y
` 

 

 
	g
.
	gid
=
c
.
tyid


50 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=

.
chy


51 
whe
 
c
.
id
='$aid' ";

52 
$ow
 = 
$dsql
->
GO
(
$quy
);

53 
	g$ow
['mab'] = ( 
im
(
$ow
['maintable'])=='' ? '#@__archives' :rim($trow['maintable']) );

54 if(
	g$ow
['issystem'] != -1)

56 
$cQuy
 = "Selectrc.*,tp.typedir,tp.typename,tp.corank,tp.namerule,tp.namerule2,tp.ispart,tp.moresite,tp.sitepath,tp.siteurl

57 
om
 `{
$ow
['mab']}` 
c
 

 
jo
 `#@
__y
` 

 

rc.
tyid
p.
id


58 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl
 
whe
rc.id='$aid' ";

59 
$cRow
 = 
$dsql
->
GO
(
$cQuy
);

60 if(
	g$cRow
['ismake']==-1 || 
$cRow
['corank']!=0 || $arcRow['arcrank']!=0 || ($arcRow['typeid']==0 && $arcRow['channel']!=-1) || $arcRow['money']>0)

62 
echo
 "<scriptanguage='javascript'>location.href='{$cfg_phpurl}/view.php?aid={$aid}';</script>";

63 
ex
();

68 
	g$cRow
['id'] = 
$aid
;

69 
	g$cRow
['tyid'] = 
$ow
['typeid'];

70 
	g$cRow
['ndde'] = 
$ow
['senddate'];

71 
	g$cRow
['title'] = '';

72 
	g$cRow
['ismake'] = 1;

73 
	g$cRow
['k'] = 
$ow
['corank'];

74 
	g$cRow
['mu'] = 
$ow
['namerule'];

75 
	g$cRow
['tyd'] = 
$ow
['typedir'];

76 
	g$cRow
['money'] = 0;

77 
	g$cRow
['filename'] = '';

78 
	g$cRow
['mese'] = 
$ow
['moresite'];

79 
	g$cRow
['seu'] = 
$ow
['siteurl'];

80 
	g$cRow
['sh'] = 
$ow
['sitepath'];

82 
	g$cu
 = 
GFeU
(
$cRow
['id'],$arcRow['typeid'],$arcRow['senddate'],$arcRow['title'],$arcRow['ismake'],$arcRow['arcrank'],

83 
$cRow
['namerule'],$arcRow['typedir'],$arcRow['money'],$arcRow['filename'],$arcRow['moresite'],$arcRow['siteurl'],$arcRow['sitepath']);

84 
	g$cfe
 = 
GFeU
(
$cRow
['id'],$arcRow['typeid'],$arcRow['senddate'],$arcRow['title'],

85 
$cRow
['ismake'],$arcRow['arcrank'],$arcRow['namerule'],$arcRow['typedir'],$arcRow['money'],$arcRow['filename']);

86 if(
egi
('^hp:',
$cfe
))

88 
	g$cfe
 = 
egi_a
("^hp://([^/]*)/",'/',
$cfe
);

90 
	g$uefe
 = 
GTruePh
().
$cfe
;

91 if(!
fe_exis
(
$uefe
))

93 
MakeA
(
$aid
,
ue
);

95 
	gecho
 "<snguage='javast'>loti.hf='$cu"."?".
time
()."';</script>";

96 
ex
();

102 if(
	g$do
=="uploadLitpic")

104 
$upfe
 = 
AdmUd
('lpic', 'imag', 0, 
l
 );

105 if(
	g$upfe
=='-1')

107 
$msg
 = "<scriptanguage='javascript'>

108 

.
documt
.
gEmtById
('udwa').
y
.
diy
 = 'none';

109 
t
('你没指定要上传的文件或文件大小超过限制！');

110 </
	gst
>";

112 if(
	g$upfe
=='-2')

114 
$msg
 = "<scriptanguage='javascript'>

115 

.
documt
.
gEmtById
('udwa').
y
.
diy
 = 'none';

116 
t
('上传文件失败，请检查原因！');

117 </
	gst
>";

119 if(
	g$upfe
=='0')

121 
$msg
 = "<scriptanguage='javascript'>

122 

.
documt
.
gEmtById
('udwa').
y
.
diy
 = 'none';

123 
t
('文件类型不正确！');

124 </
	gst
>";

128 if(!
emy
(
$cfg_upic_cut
&& 
	g$cfg_upic_cut
=='N')

130 
$msg
 = "<scriptanguage='javascript'>

131 

.
documt
.
gEmtById
('udwa').
y
.
diy
 = 'none';

132 
	g
.
	gdocumt
.
gEmtById
('piame').
	gvue
 = '{$upfile}';

133 if(
	g
.
	gdocumt
.
gEmtById
('divpicview'))

135 
	g
.
	gdocumt
.
gEmtById
('divpicvw').
	gy
.
	gwidth
 = '150px';

136 
	g
.
	gdocumt
.
gEmtById
('divpicvw').
	grHTML
 = \"<img src='{$upfile}?n' width='150' />\";

138 </
	gst
>";

142 
	g$msg
 = "<scriptanguage='javascript'>

143 

.
documt
.
gEmtById
('udwa').
y
.
diy
 = 'none';

144 
	gwdow
.
ݒ
('imagecut.php?f=picname&isupload=yes&file={$upfile}', 'popUpImagesWin', 'scrollbars=yes,resizable=yes,statebar=no,width=800,height=600,left=150,op=50');

145 </
	gst
>";

148 
echo
 
	g$msg
;

149 
ex
();

155 if(
	g$do
=="commendArchives")

157 
CheckPurvw
('a_Commend,sys_ArcBatch');

158 if!
emy
(
$aid
&&my(
$qr
) )

160 
	g$qr
 = 
$aid
;

162 if(
	g$qr
=='')

164 
ShowMsg
("参数无效！",
$ENV_GOBACK_URL
);

165 
ex
();

167 
	g$cids
 = 
eg_a
('[^0-9,]','',eg_a('`',',',
$qr
));

168 
	g$quy
 = "Selectrc.id,arc.typeid,ch.issystem,ch.maintable,ch.addtable From `#@__arctiny`rc

169 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


170 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=

.
chy


171 
whe
 
c
.
id
 

(
$cids
) ";

172 
$dsql
->
SQuy
(
$quy
);

173 
	g$dsql
->
Execu
();

174 
	g$row
 = 
$dsql
->
GAay
())

176 
$aid
 = 
$row
['id'];

177 if(
	g$row
['issystem']!=-1)

179 
$mab
 = ( 
im
(
$row
['maintable'])=='' ? '#@__archives' :rim($row['maintable']) );

180 
	g$r
 = 
$dsql
->
GO
("Select flag From `{$maintable}` where id='$aid' ");

181 
	g$ag
 = (
$r
['flag']=='' ? 'c' : $arr['flag'].',c');

182 
	g$dsql
->
ExecuNeQuy
(" Update `{$maintable}` set `flag`='$flag' where id='{$aid}' ");

186 
	g$mab
 = 
im
(
$row
['addtable']);

187 
	g$r
 = 
$dsql
->
GO
("Select flag From `{$maintable}` whereid='$aid' ");

188 
	g$ag
 = (
$r
['flag']=='' ? 'c' : $arr['flag'].',c');

189 
	g$dsql
->
ExecuNeQuy
(" Update `{$maintable}` set `flag`='$flag' whereid='{$aid}' ");

192 
ShowMsg
("成功把所选的文档设为推荐！",
$ENV_GOBACK_URL
);

193 
ex
();

200 if(
	g$do
=="makeArchives")

202 
CheckPurvw
('sys_MakeHtml,sys_ArcBatch');

203 if!
emy
(
$aid
&&my(
$qr
) )

205 
	g$qr
 = 
$aid
;

207 if(
	g$qr
=='')

209 
ShowMsg
('参数无效！',
$ENV_GOBACK_URL
);

210 
ex
();

212 
que_
(
DEDEADMIN
.'/inc/inc_archives_functions.php');

213 
	g$qrs
 = 
exode
('`',
$qr
);

214 
	g$i
 = 0;

215 
fܗch
(
$qrs
 
as
 
$aid
)

217 
	g$i
++;

218 
	g$geu
 = 
MakeA
(
$aid
,
l
);

220 
ShowMsg
("成功更新指定 $个文件...",
$ENV_GOBACK_URL
);

221 
ex
();

228 if(
	g$do
=="checkArchives")

230 
CheckPurvw
('a_Check,a_AccCheck,sys_ArcBatch');

231 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

232 if!
emy
(
$aid
&&my(
$qr
) )

234 
	g$qr
 = 
$aid
;

236 if(
	g$qr
=='')

238 
ShowMsg
("参数无效！",
$ENV_GOBACK_URL
);

239 
ex
();

241 
	g$cids
 = 
eg_a
('[^0-9,]','',eg_a('`',',',
$qr
));

242 
	g$quy
 = "Selectrc.id,arc.typeid,ch.issystem,ch.maintable,ch.addtable From `#@__arctiny`rc

243 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


244 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=

.
chy


245 
whe
 
c
.
id
 

(
$cids
) ";

246 
$dsql
->
SQuy
(
$quy
);

247 
	g$dsql
->
Execu
('ckall');

248 
	g$row
 = 
$dsql
->
GAay
('ckall'))

250 
$aid
 = 
$row
['id'];

252 
	g$mab
 = ( 
im
(
$row
['maintable'])=='' ? '#@__archives' :rim($row['maintable']) );

253 
	g$dsql
->
ExecuNeQuy
("Update `#@__arctiny` setrcrank='0' where id='$aid' ");

254 if(
	g$row
['issystem']==-1)

256 
$dsql
->
ExecuNeQuy
("Upd`".
im
(
$row
['addtable'])."` setrcrank='0' whereid='$aid' ");

260 
	g$dsql
->
ExecuNeQuy
("Upd`$mab` srk='0', dutyadm='".
$curLog
->
gUrID
()."' where id='$aid' ");

262 
	g$geu
 = 
MakeA
(
$aid
,
l
);

264 
ShowMsg
("成功审核指定的文档！",
$ENV_GOBACK_URL
);

265 
ex
();

272 if(
	g$do
=="delArchives")

274 
CheckPurvw
('a_Del,a_AccDel,a_MyDel,sys_ArcBatch');

275 
que_
(
DEDEINC
."/oxwindow.class.php");

276 if(
emy
(
$fmdo
))

278 
	g$fmdo
 = '';

282 if(
	g$fmdo
=='yes')

284 if!
emy
(
$aid
&&my(
$qr
) )

286 
$qr
 = 
$aid
;

288 if(
	g$qr
=='')

290 
ShowMsg
("参数无效！",
$ENV_GOBACK_URL
);

291 
ex
();

293 
	g$qrs
 = 
exode
("`",
$qr
);

294 
	g$okaids
 = 
Aay
();

296 
fܗch
(
$qrs
 
as
 
$aid
)

298 if(!
ist
(
$okaids
[
$aid
]))

300 
DArc
(
$aid
);

304 
	g$okaids
[
$aid
] = 1;

307 
ShowMsg
("成功删除指定的文档！",
$ENV_GOBACK_URL
);

308 
ex
();

314 
	g$wt
 = "文档管理-删除文档";

315 
	g$wecome_fo
 = "<hf='".
$ENV_GOBACK_URL
."'>文档管理</a>::删除文档";

316 
	g$w
 = 
w
 
OxWdow
();

317 
	g$w
->
In
("archives_do.php","js/blank.js","POST");

318 
	g$w
->
AddHidd
("fmdo","yes");

319 
	g$w
->
AddHidd
("do",
$do
);

320 
	g$w
->
AddHidd
("qr",
$qr
);

321 
	g$w
->
AddHidd
("aid",
$aid
);

322 
	g$w
->
AddT
("你确实要删除“ $qstr 和 $aid ”这些文档？");

323 
	g$wfm
 = 
$w
->
GWdow
("ok");

324 
	g$w
->
Diy
();

331 if(
	g$do
=='moveArchives')

333 
CheckPurvw
('sys_ArcBatch');

334 if(
emy
(
$ty
))

336 
que_
(
DEDEINC
.'/typelink.class.php');

337 if!
emy
(
$aid
&&my(
$qr
) )

339 
	g$qr
 = 
$aid
;

341 
AjaxHd
();

342 
	g$chlid
 = 
emy
(
$chlid
) ? 0 : $channelid;

343 
	g$
 = 
w
 
TyLk
(
$aid
);

344 
	g$tyOis
 = 
$
->
GOiAay
(0, 
$adm_logs
, 
$chlid
);

345 
	g$tyOis
 = "<selectame='totype' style='width:90%'>

346 <
ti
 
vue
='0'>请选择移动到的位置...</ti>\
r
\
n


347 
$tyOis


348 </

>";

351 
$divme
 = 'moveArchives';

352 
	gecho
 "<div class='title' onmousemove=\"DropMoveHand('{$divname}', 225);\" onmousedown=\"DropStartHand();\" onmouseup=\"DropStopHand();\">\r\n";

353 
	gecho
 " <div class='titLeft'>移动文档</div>\r\n";

354 
	gecho
 " <div class='titRight'><img src='img/ico-close.gif' style='cursor:pointer;' onclick='HideObj(\"{$divname}\");ChangeFullDiv(\"hide\");'lt='关闭'itle='关闭' /></div>\r\n";

355 
	gecho
 "</div>\r\n";

356 
	gecho
 "<formame='quickeditform'ction='archives_do.php' method='post'>\r\n";

357 
	gecho
 "<inputype='hidden'ame='dopost' value='{$dopost}' />\r\n";

358 
	gecho
 "<inputype='hidden'ame='qstr' value='{$qstr}' />\r\n";

359 
	gecho
 "<table width='100%' style='margin-top:6px;z-index:9000;'>\r\n";

361 <

 
	gheight
='28'>

362 <
td
 
width
="80" 
ass
='ble'>&
nb
;目标栏目：</
	gtd
>

363 <
td
 
	gass
='bline'>

364 <?
php
 
echo
 
$tyOis
; ?>

365 </
	gtd
>

366 </
	g
>

367 <

 
	gheight
='32'>

368 <
td
 
width
="80" 
ass
='ble'>&
nb
;文档
	gID
：</
	gtd
>

369 <
td
 
	gass
='bline'>

370 <
put
 
ty
='xt' 
me
='tmpids' 
vue
="<?phech$qr; ?>" 
y
='width:310px;overflow:hidden;' />

371 <
br
 />

373 </
td
>

374 </

>

375 <

 
height
='32'>

376 <
td
 
cޥ
='2' 
ign
='' 
y
='padding-top:12px'>

377 <
put
 
me
="imageFld" 
ty
="image" 
c
="img/bu_ok.gif" 
width
="60" 
height
="22" 
ass
="" 
bd
="0" 
y
="cursor:pointer" />

378 &
nb
;&
	gnb
;

379 <
img
 
	gc
="img/bu_back.gif" 
width
="60" 
height
="22" 
bd
="0" 
ick
='HideObj("<?phech$divme; ?>");ChgeFuDiv("hide");' 
y
="cursor:pointer" />

380 </
td
>

381 </
td
>

382 </

>

383 </
b
>

384 </
fm
>

385 <?
php


390 
	g$ty
 = 
eg_a
('[^0-9]','',
$ty
);

391 
	g$tyInfos
 = 
$dsql
->
GO
("Selectp.channeltype,tp.ispart,tp.channeltype,ch.maintable,ch.addtable From `#@__arctype`peft join `#@__channeltype` ch on ch.id=tp.channeltype wherep.id='$totype' ");

392 if(!
is_y
(
$tyInfos
))

394 
ShowMsg
('参数错误！','-1');

395 
ex
();

397 if(
	g$tyInfos
['ispart']!=0)

399 
ShowMsg
('文档保存的栏目必须为最终列表栏目！','-1');

400 
ex
();

402 if(
emy
(
$tyInfos
['maintable']))

404 
	g$tyInfos
['maintable'] = '#@__archives';

406 
	g$cids
 = 
eg_a
('[^0-9,]','',eg_a('`',',',
$qr
));

407 
	g$c
 = '';

408 
	g$j
 = 0;

409 
	g$okids
 = 
y
();

410 
	g$dsql
->
SQuy
("Select id,typeid From `{$typeInfos['maintable']}` where id in($arcids) And channel='{$typeInfos['channeltype']}' ");

411 
	g$dsql
->
Execu
();

412 
	g$row
 = 
$dsql
->
GAay
())

414 if(
$row
['tyid']!=
$ty
)

416 
$dsql
->
ExecuNeQuy
("Update `#@__arctiny` Setypeid='$totype' where id='{$row['id']}' ");

417 
	g$dsql
->
ExecuNeQuy
("Update `{$typeInfos['maintable']}` Setypeid='$totype' where id='{$row['id']}' ");

418 
	g$dsql
->
ExecuNeQuy
("Update `{$typeInfos['addtable']}` Setypeid='$totype' whereid='{$row['id']}' ");

419 
	g$okids
[] = 
$row
['id'];

420 
	g$j
++;

424 
fܗch
(
$okids
 
as
 
$aid
)

426 
	g$c
 = 
w
 
Archives
(
$aid
);

427 
	g$c
->
MakeHtml
();

429 
ShowMsg
("成功移动 $j 个文档！", 
$ENV_GOBACK_URL
);

430 
ex
();

437 if(
	g$do
=='return')

439 
CheckPurvw
('a_Del,a_AccDel,a_MyDel,sys_ArcBatch');

440 
que_
(
DEDEINC
."/oxwindow.class.php");

442 if!
emy
(
$aid
&&my(
$qr
) )

444 
	g$qr
 = 
$aid
;

446 if(
	g$qr
=='')

448 
ShowMsg
("参数无效！","recycling.php");

449 
ex
();

451 
	g$qrs
 = 
exode
("`",
$qr
);

452 
fܗch
(
$qrs
 
as
 
$aid
)

454 
	g$dsql
->
ExecuNeQuy
("Update `#@__archives` setrcrank='-1',ismake='0' where id='$aid'");

455 
	g$dsql
->
ExecuNeQuy
("Update `#@__arctiny` set `arcrank` = '-1' where id = '$aid'; ");

457 
ShowMsg
("成功还原指定的文档！","recycling.php");

458 
ex
();

464 if(
	g$do
=='clear')

466 
CheckPurvw
('a_Del,a_AccDel,a_MyDel,sys_ArcBatch');

467 
que_
(
DEDEINC
."/oxwindow.class.php");

468 if(
emy
(
$fmdo
))

470 
	g$fmdo
 = '';

474 if(
	g$fmdo
=='yes')

476 if!
emy
(
$aid
&&my(
$qr
) )

478 
$qr
 = 
$aid
;

480 if(
	g$qr
=='')

482 
ShowMsg
("参数无效！","recycling.php");

483 
ex
();

485 
	g$qrs
 = 
exode
(",",
$qr
);

486 
	g$okaids
 = 
Aay
();

487 
fܗch
(
$qrs
 
as
 
$aid
)

489 if(!
ist
(
$okaids
[
$aid
]))

491 
DArc
(
$aid
,"OK");

495 
	g$okaids
[
$aid
] = 1;

498 
ShowMsg
("成功删除指定的文档！","recycling.php");

499 
ex
();

503 
	g$dsql
->
SQuy
("SELECT id FROM `#@__archives` WHERE `arcrank` = '-2'");

504 
	g$dsql
->
Execu
();

505 
	g$qr
 = '';

506 
	g$row
 = 
$dsql
->
GAay
())

508 
$qr
 .
$row
['id'].",";

509 
	g$aid
 = 
$row
['id'];

511 
	g$num
 = 
$dsql
->
GTٮRow
();

512 if(
emy
(
$num
))

514 
ShowMsg
("对不起，未发现相关文档！","recycling.php");

515 
ex
();

517 
	g$wt
 = "文档管理-清空所有文档";

518 
	g$wecome_fo
 = "<a href='recycling.php'>文档回收站</a>::清空所有文档";

519 
	g$w
 = 
w
 
OxWdow
();

520 
	g$w
->
In
("archives_do.php","js/blank.js","POST");

521 
	g$w
->
AddHidd
("fmdo","yes");

522 
	g$w
->
AddHidd
("do",
$do
);

523 
	g$w
->
AddHidd
("qr",
$qr
);

524 
	g$w
->
AddHidd
("aid",
$aid
);

525 
	g$w
->
AddT
("本次操作将清空回收站<font color='#FF0000'>所有共 $num 篇文档</font><br>你确实要永久删除“ $qstr ”这些文档？");

526 
	g$wfm
 = 
$w
->
GWdow
("ok");

527 
	g$w
->
Diy
();

535 if(
	g$do
=='del')

537 
CheckPurvw
('a_Del,a_AccDel,a_MyDel,sys_ArcBatch');

538 
que_
(
DEDEINC
."/oxwindow.class.php");

539 if(
emy
(
$fmdo
))

541 
	g$fmdo
 = '';

545 if(
	g$fmdo
=='yes')

547 if!
emy
(
$aid
&&my(
$qr
) )

549 
$qr
 = 
$aid
;

551 if(
	g$qr
=='')

553 
ShowMsg
("参数无效！","recycling.php");

554 
ex
();

556 
	g$qrs
 = 
exode
("`",
$qr
);

557 
	g$okaids
 = 
Aay
();

559 
fܗch
(
$qrs
 
as
 
$aid
)

561 if(!
ist
(
$okaids
[
$aid
]))

563 
DArc
(
$aid
,"OK");

567 
	g$okaids
[
$aid
] = 1;

570 
ShowMsg
("成功删除指定的文档！","recycling.php");

571 
ex
();

577 
	g$wt
 = "文档管理-删除文档";

578 
	g$wecome_fo
 = "<a href='recycling.php'>文档管理</a>::删除文档";

579 
	g$w
 = 
w
 
OxWdow
();

580 
	g$w
->
In
("archives_do.php","js/blank.js","POST");

581 
	g$w
->
AddHidd
("fmdo","yes");

582 
	g$w
->
AddHidd
("do",
$do
);

583 
	g$w
->
AddHidd
("qr",
$qr
);

584 
	g$w
->
AddHidd
("aid",
$aid
);

585 
	g$w
->
AddT
("你确实要永久删除“ $qstr 和 $aid ”这些文档？");

586 
	g$wfm
 = 
$w
->
GWdow
("ok");

587 
	g$w
->
Diy
();

594 if(
	g$do
=='quickEdit')

596 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

597 
AjaxHd
();

598 
	g$quy
 = "Select ch.typenames channelname,ch.addtable,ar.membernamesankname,arc.*

599 
From
 `#@
__chives
` 
c


600 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


601 

 
jo
 `#@
__k
` 

 

r.
nk
=
c
.
k
 
whe
rc.
id
='$aid' ";

602 
$cRow
 = 
$dsql
->
GO
(
$quy
);

604 
	g$divme
 = 'quickEdit';

605 
	gecho
 "<div class='title' onmousemove=\"DropMoveHand('{$divname}', 225);\" onmousedown=\"DropStartHand();\" onmouseup=\"DropStopHand();\">\r\n";

606 
	gecho
 " <div class='titLeft'>快速属性编辑</div>\r\n";

607 
	gecho
 " <div class='titRight'><img src='img/ico-close.gif' style='cursor:pointer;' onclick='HideObj(\"{$divname}\");ChangeFullDiv(\"hide\");'lt='关闭'itle='关闭' /></div>\r\n";

608 
	gecho
 "</div>\r\n";

609 
	gecho
 "<formame='quickeditform'ction='archives_do.php?dopost=quickEditSave&aid={$aid}' method='post'>\r\n";

610 
	gecho
 "<inputype='hidden'ame='addtable' value='{$arcRow['addtable']}' />\r\n";

611 
	gecho
 "<inputype='hidden'ame='oldtypeid' value='{$arcRow['typeid']}' />\r\n";

612 
	gecho
 "<table width='100%' style='margin-top:6px;z-index:9000;'>\r\n";

614 <

 
	gheight
='32'>

615 <
td
 
width
="80" 
ass
='ble'>&
nb
;所属栏目：</
	gtd
>

616 <
td
 
	gass
='bline'>

617 <?
php


618 
$tyOis
 = 
GOiLi
(
$cRow
['tyid'],
$curLog
->
gUrChl
(), $arcRow['channel']);

619 
	gecho
 "<selectame='typeid' style='width:70%'>\r\n";

620 if(
	g$cRow
["tyid"]=="0"
echo
 "<option value='0' selected>请选择栏目...</option>\r\n";

621 
echo
 
	g$tyOis
;

622 
	gecho
 "</select>";

624 </
	gtd
>

625 </
	g
>

626 <

 
	gheight
='28'>

627 <
td
 
width
="80" 
ass
='ble'>&
nb
;属 性：</
	gtd
>

628 <
td
 
	gass
='bline'>

629 <
put
 
ty
='hidd' 
me
='dag' 
vue
='<?phech$cRow['
ag
']; ?>' />

630 <?
php


631 
$dsql
->
SQuy
("Select * From `#@__arcatt` order by sortidsc");

632 
	g$dsql
->
Execu
();

633 
	g$ow
 = 
$dsql
->
GObje
())

635 if(
$ow
->
t
=='j' || $trow->att=='p') ;

636 if(
eg
(
$ow
->
t
,
$cRow
['flag']))

637 
	gecho
 "<input class='np'ype='checkbox'ame='flags[]' id='flags{$trow->att}' value='{$trow->att}' checked='checked' />{$trow->attname}.{$trow->att}";

639 
	gecho
 "<input class='np'ype='checkbox'ame='flags[]' id='flags{$trow->att}' value='{$trow->att}' />{$trow->attname}.{$trow->att}";

642 </
	gtd
>

643 </
	g
>

644 <

 
	gheight
='32'>

645 <
td
 
width
="80" 
ass
='ble'>&
nb
;标 题：</
	gtd
>

646 <
td
 
	gass
='bline'>

647 <
put
 
me
="t" 
ty
="xt" 
id
="t" 
vue
="<?phech$cRow['t']; ?>" 
y
="width:90%" />

648 </
td
>

649 </

>

650 <

 
height
='32'>

651 <
td
 
width
="80" 
ass
='ble'>&
nb
;简略标题：</
	gtd
>

652 <
td
 
	gass
='bline'>

653 <
put
 
me
="sh܉" 
ty
="xt" 
id
="sh܉" 
vue
="<?phech$cRow['sh܉']; ?>" 
y
="width:60%" />

654 </
td
>

655 </

>

656 <

 
height
='32'>

657 <
td
 
width
="80" 
ass
='ble'>&
nb
;阅读权限：</
	gtd
>

658 <
td
 
	gass
='bline'>

659 <

 
me
="k" 
id
="k" 
y
="width:120px">

660 <
ti
 
vue
='<?phpcho $arcRow["arcrank"]?>'>

661 <?
php
 
echo
 
$cRow
["nkme"]?> </
ti
>

662 <?
php


663 
$unk
 = 
$curLog
->
gUrRk
();

665 
	g$dsql
->
SQuy
("Select * from `#@__arcrank` wheredminrank<='$urank'");

666 
	g$dsql
->
Execu
();

667 
	g$row
 = 
$dsql
->
GObje
()){

668 
echo
 " <ti vue='".
$row
->
nk
."'>".$row->
membme
."</option>\r\n";

671 </
	g
>

672 需要金币：<
put
 
	gme
="mey" 
ty
="xt" 
id
="mey" 
vue
="<?phech$cRow["
mey
"]; ?>" 
y
="width:80px" />

673 </
td
>

674 </

>

675 <

 
height
='32'>

676 <
td
 
width
="80" 
ass
='ble'>&
nb
;关键字：</
	gtd
>

677 <
td
 
	gass
='bline'>

678 <
put
 
me
="keywds" 
ty
="xt" 
id
="keywds" 
vue
="<?phech$cRow['keywds']; ?>" 
y
="width:70%" />

679 </
td
>

680 </

>

681 <

 
height
='32'>

682 <
td
 
cޥ
='2' 
ign
='' 
y
='padding-top:12px'>

683 <
put
 
me
="imageFld" 
ty
="image" 
c
="img/bu_ok.gif" 
width
="60" 
height
="22" 
ass
="" 
bd
="0" 
y
="cursor:pointer" />

684 &
nb
;&
	gnb
;

685 <
img
 
	gc
="img/bu_back.gif" 
width
="60" 
height
="22" 
bd
="0" 
ick
='HideObj("<?phech$divme; ?>");ChgeFuDiv("hide");' 
y
="cursor:pointer" />

686 </
td
>

687 </
td
>

688 </

>

689 </
b
>

690 </
fm
>

691 <?
php


698 if(
	g$do
=='quickEditSave')

700 
que_
(
DEDEADMIN
.'/inc/inc_archives_functions.php');

702 if(!
TePurvw
('a_Edit'))

704 if(
TePurvw
('a_AccEdit'))

706 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的文档权限！");

710 
CheckArcAdm
(
$aid
,
$curLog
->
gUrID
());

713 
	g$t
 = 
htmleclchs
(
_subrR
(
$t
,
$cfg_t_maxn
));

714 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

715 
	g$keywds
 = 
im
(
_subrR
(
$keywds
,60));

716 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

718 
	g$k
 = -1;

720 
	g$admid
 = 
$curLog
->
gUrID
();

723 
	g$ag
 = 
ist
(
$ags
? 
jo
(',', $flags) : '';

724 if(!
emy
(
$ag
))

726 if(
eg
('p', 
$dag
)
	g$ag
 .= ',p';

727 if(
eg
('j', 
$dag
)
	g$ag
 .= ',j';

731 
	g$ag
 = 
$dag
;

734 
	g$quy
 = "update `#@__archives` set

735 
tyid
 = '$typeid',

736 
	gag
 = '$flag',

737 
	gk
 = '$arcrank',

738 
	gmey
 = '$money',

739 
	gt
 = '$title',

740 
	gsh܉
 = '$shorttitle',

741 
	gkeywds
 = '$keywords',

742 
	gdutyadm
 = '$adminid'

743 
whe
 
id
 = '$aid'; ";

746 
	g$dsql
->
ExecuNeQuy
(
$quy
);

748 
	g$dsql
->
ExecuNeQuy
(" Update `#@__arctiny` setypeid='$typeid',arcrank='$arcrank' where id='$aid' ");

750 if(
	g$tyid
 !
$dtyid
)

752 
$addb
 = 
im
($addtable);

753 if(
emy
(
$addb
)
	g$addb
 = '#@__addonarticle';

754 
	g$addb
 = 
egi_a
("[^a-z0-9__#@-]", "", 
$addb
);

755 
	g$dsql
->
ExecuNeQuy
(" Update `$addtable` setypeid='$typeid' whereid='$aid' ");

758 
	g$tU
 = 
MakeA
(
$aid
, 
ue
,rue);

760 
	g$backu
 = !
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? $_COOKIE['ENV_GOBACK_URL'] : '-1';

761 
ShowMsg
('成功更新一篇文档的基本信息！', 
$backu
);

762 
ex
();

768 if(
	g$do
=="makekw")

770 
ude_
(
DEDEINC
.'/splitword.class.php');

771 
CheckPurvw
('a_Commend,sys_ArcBatch');

772 if!
emy
(
$aid
&&my(
$qr
) )

774 
	g$qr
 = 
$aid
;

776 if(
	g$qr
=='')

778 
ShowMsg
("参数无效！", 
$ENV_GOBACK_URL
);

779 
ex
();

781 
	g$
 = 
w
 
SWd
();

782 
	g$cids
 = 
eg_a
('[^0-9,]','',eg_a('`',',',
$qr
));

783 
	g$quy
 = "Selectrc.*,ddt.* From `#@__archives`rceft join `#@__addonarticle`ddt onddt.aid=arc.id whererc.id in($arcids) Andrc.channel=1 ";

784 
	g$dsql
->
SQuy
(
$quy
);

785 
	g$dsql
->
Execu
();

786 
	g$row
 = 
$dsql
->
GAay
())

789 if(
im
(
$row
['keywords']) !='' ) ;

791 
	g$aid
 = 
$row
['id'];

792 
	g$keywds
 = '';

793 
	g$t
 = 
$row
['title'];

794 
	g$desti
 = 
$row
['description'];

795 
	g$body
 = 
_subr
(
$row
['body'], 5000);

796 if(
	g$cfg_so_ng
 == 'utf-8')

798 
$t
 = 
utf82gb
($title);

799 
	g$body
 = 
utf82gb
(
$body
);

801 
	g$t˚dexs
 = 
exode
(' ',
eg_a
("/#p#|#e#/",'',
$
->
GIndexText
(
$t
)));

802 
	g$ldexs
 = 
exode
(' ',
eg_a
("/#p#|#e#/",'',
$
->
GIndexText
(
Html2Text
(
$body
),500)));

803 if(
is_y
(
$ldexs
&& is_y(
$t˚dexs
))

805 
fܗch
(
$t˚dexs
 
as
 
$k
)

807 if(

(
$keywds
.
$k
)>=30) ;

808 
	g$keywds
 .
$k
.',';

810 
fܗch
(
$ldexs
 
as
 
$k
)

812 if(

(
$keywds
.
$k
)>=30) ;

813 if(!
_y
(
$k
,
$t˚dexs
)
	g$keywds
 .= $k.',';

816 
	g$keywds
 = 
addashes
(
$keywds
);

817 
	g$desti
 = 
r_a
('　', ' ', 
im
(
$desti
));

818 
	g$desti
 = 
r_a
('［', ' ', 
$desti
);

819 
	g$desti
 = 
r_a
('］', ' ', 
$desti
);

820 
	g$desti
 = 
eg_a
("[ \r\n\t]{1,}", ' ', 
$desti
);

821 
	g$desti
 = 
r_a
('关键字', '', 
$desti
);

822 
	g$desti
 = 
r_a
('关键词', '', 
$desti
);

823 
	g$desti
 = 
addashes
(
$desti
);

824 
	g$dsql
->
ExecuNeQuy
(" Update `#@__archives` set `keywords`='$keywords',`description`='$description' where id='{$aid}' ");

826 
	g$
->
Cˬ
();

827 
	g$
 = 
nu
;

828 
ShowMsg
("成功分析指定文档的关键词！",
$ENV_GOBACK_URL
);

829 
ex
();

835 if(
	g$do
=='attsAdd')

837 
CheckPurvw
('a_Commend,sys_ArcBatch');

838 if!
emy
(
$aid
&&my(
$qr
) )

840 
	g$qr
 = 
$aid
;

842 if(
	g$qr
=='')

844 
ShowMsg
("参数无效！",
$ENV_GOBACK_URL
);

845 
ex
();

847 if(
emy
(
$agme
))

849 
ShowMsg
("必须指定要添加的属性！",
$ENV_GOBACK_URL
);

850 
ex
();

852 
	g$cids
 = 
eg_a
('[^0-9,]','',eg_a('`', ',', 
$qr
));

853 
	g$quy
 = "Selectrc.id,arc.typeid,ch.issystem,ch.maintable,ch.addtable From `#@__arctiny`rc

854 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


855 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=

.
chy


856 
whe
 
c
.
id
 

(
$cids
) ";

857 
$dsql
->
SQuy
(
$quy
);

858 
	g$dsql
->
Execu
();

859 
	g$row
 = 
$dsql
->
GAay
())

861 
$aid
 = 
$row
['id'];

862 if(
	g$row
['issystem'] != -1)

864 
$mab
 = ( 
im
(
$row
['maintable'])=='' ? '#@__archives' :rim($row['maintable']) );

865 
	g$r
 = 
$dsql
->
GO
("Select flag From `{$maintable}` where id='$aid' ");

866 
	g$ag
 = (
$r
['ag']=='' ? 
$agme
 : $arr['flag'].','.$flagname);

867 
	g$dsql
->
ExecuNeQuy
(" Update `{$maintable}` set `flag`='$flag' where id='{$aid}' ");

871 
	g$mab
 = 
im
(
$row
['addtable']);

872 
	g$r
 = 
$dsql
->
GO
("Select flag From `{$maintable}` whereid='$aid' ");

873 
	g$ag
 = (
$r
['ag']=='' ? 
$agme
 : $arr['flag'].','.$flagname);

874 
	g$dsql
->
ExecuNeQuy
(" Update `{$maintable}` set `flag`='$flag' whereid='{$aid}' ");

877 
ShowMsg
("成功对选中文档增加指定的属性！",
$ENV_GOBACK_URL
);

878 
ex
();

884 if(
	g$do
=='attsDel')

886 
CheckPurvw
('a_Commend,sys_ArcBatch');

887 if!
emy
(
$aid
&&my(
$qr
) )

889 
	g$qr
 = 
$aid
;

891 if(
	g$qr
=='')

893 
ShowMsg
("参数无效！", 
$ENV_GOBACK_URL
);

894 
ex
();

896 if(
emy
(
$agme
))

898 
ShowMsg
("必须指定要删除的属性！", 
$ENV_GOBACK_URL
);

899 
ex
();

901 
	g$cids
 = 
eg_a
('[^0-9,]','',eg_a('`', ',', 
$qr
));

902 
	g$quy
 = "Selectrc.id,arc.typeid,ch.issystem,ch.maintable,ch.addtable From `#@__arctiny`rc

903 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


904 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=

.
chy


905 
whe
 
c
.
id
 

(
$cids
) ";

906 
$dsql
->
SQuy
(
$quy
);

907 
	g$dsql
->
Execu
();

908 
	g$row
 = 
$dsql
->
GAay
())

910 
$aid
 = 
$row
['id'];

911 if(
	g$row
['issystem'] != -1)

913 
$idme
 = 'id';

914 
	g$mab
 = ( 
im
(
$row
['maintable'])=='' ? '#@__archives' :rim($row['maintable']) );

915 
	g$r
 = 
$dsql
->
GO
("Select flag From `{$maintable}` where id='$aid' ");

919 
	g$idme
 = 'aid';

920 
	g$mab
 = 
im
(
$row
['addtable']);

921 
	g$r
 = 
$dsql
->
GO
("Select flag From `{$maintable}` whereid='$aid' ");

923 
	g$ag
 = 
$r
['flag'];

924 if(
im
(
$ag
)=='' || !
eg
(
$agme
, $flag) )

930 
	g$ags
 = 
exode
(',', 
$ag
);

931 
	g$okags
 = 
y
();

932 
fܗch
(
$ags
 
as
 
$f
)

934 if(
	g$f
 !
$agme

$okags
[] = 
$f
;

937 
	g$ag
 = 
im
(
jo
(',', 
$okags
));

938 
	g$dsql
->
ExecuNeQuy
(" Update `{$maintable}` set `flag`='$flag' where {$idname}='{$aid}' ");

940 
ShowMsg
("成功对选中文档删除指定的属性！", 
$ENV_GOBACK_URL
);

941 
ex
();

947 if(
	g$do
=='attsDlg')

949 if!
emy
(
$aid
&&my(
$qr
) )

951 
$qr
 = 
$aid
;

953 
	g$dojobme
 = (
$dojob
=='attsDel' ? '批量删除属性' : '批量增加属性');

954 
AjaxHd
();

956 
	g$divme
 = 'attsDlg';

957 
	gecho
 "<div class='title' onmousemove=\"DropMoveHand('{$divname}', 225);\" onmousedown=\"DropStartHand();\" onmouseup=\"DropStopHand();\">\r\n";

958 
	gecho
 " <div class='titLeft'>{$dojobname}</div>\r\n";

959 
	gecho
 " <div class='titRight'><img src='img/ico-close.gif' style='cursor:pointer;' onclick='HideObj(\"{$divname}\");ChangeFullDiv(\"hide\");'lt='关闭'itle='关闭' /></div>\r\n";

960 
	gecho
 "</div>\r\n";

961 
	gecho
 "<formame='quickeditform'ction='archives_do.php' method='post'>\r\n";

962 
	gecho
 "<inputype='hidden'ame='dopost' value='{$dojob}' />\r\n";

963 
	gecho
 "<inputype='hidden'ame='qstr' value='{$qstr}' />\r\n";

964 
	gecho
 "<table width='100%' style='margin-top:6px;z-index:9000;'>\r\n";

966 <

 
	gheight
='28'>

967 <
td
 
width
="80" 
ass
='ble'>&
nb
;属 性：</
	gtd
>

968 <
td
 
	gass
='bline'>

969 <
put
 
ty
='hidd' 
me
='dag' 
vue
='<?phech$cRow['
ag
']; ?>' />

970 <?
php


971 
$dsql
->
SQuy
("Select * From `#@__arcatt` order by sortidsc");

972 
	g$dsql
->
Execu
();

973 
	g$ow
 = 
$dsql
->
GObje
())

975 if(
$ow
->
t
=='j' || $trow->att=='p') ;

976 
	gecho
 "<input class='np'ype='radio'ame='flagname' id='flags{$trow->att}' value='{$trow->att}' />{$trow->attname}.{$trow->att}";

979 </
	gtd
>

980 </
	g
>

981 <

 
	gheight
='32'>

982 <
td
 
width
="80" 
ass
='ble'>&
nb
;文档
	gID
：</
	gtd
>

983 <
td
 
	gass
='bline'>

984 <
put
 
ty
='xt' 
me
='tmpids' 
vue
="<?phech$qr; ?>" 
y
='width:310px;overflow:hidden;' />

985 </
td
>

986 </

>

987 <

 
height
='32'>

988 <
td
 
cޥ
='2' 
ign
='' 
y
='padding-top:12px'>

989 <
put
 
me
="imageFld" 
ty
="image" 
c
="img/bu_ok.gif" 
width
="60" 
height
="22" 
ass
="" 
bd
="0" 
y
="cursor:pointer" />

990 &
nb
;&
	gnb
;

991 <
img
 
	gc
="img/bu_back.gif" 
width
="60" 
height
="22" 
bd
="0" 
ick
='HideObj("<?phech$divme; ?>");ChgeFuDiv("hide");' 
y
="cursor:pointer" />

992 </
td
>

993 </
td
>

994 </

>

995 </
b
>

996 </
fm
>

997 <?
php


1003 if(
	g$do
=='getCatMap')

1005 
que_
(
DEDEINC
.'/typeunit.class.selector.php');

1006 
AjaxHd
();

1008 
	g$divme
 = 'getCatMap';

1009 
	gecho
 "<div class='title' style='cursor:default;'>\r\n";

1010 
	gecho
 " <div class='titLeft'>栏目快速选择器</div>\r\n";

1011 
	gecho
 " <div class='titRight'><img src='img/ico-close.gif' style='cursor:pointer;' onclick='HideObj(\"{$divname}\");ChangeFullDiv(\"hide\");'lt='关闭'itle='关闭' /></div>\r\n";

1012 
	gecho
 "</div>\r\n";

1013 
	g$tus
 = 
w
 
TyUnSe
();

1015 <
fm
 
	gme
='quickl' 
ai
='javast:;' 
mhod
='get'>

1016 <
div
 
ass
='quicksel'>

1017 <?
php
 
$tus
->
LiATy
(
$chlid
); ?>

1018 </
	gdiv
>

1019 <
div
 
	gign
='' 
ass
='quickselfoot'>

1020 <
img
 
c
="img/bu_ok.gif" 
ick
="gSC('<?phech$rgid; ?>');" 
width
="60" 
height
="22" 
ass
="" 
bd
="0" 
y
="cursor:pointer" />

1021 &
nb
;&
	gnb
;

1022 <
img
 
	gc
="img/bu_back.gif" 
ick
='HideObj("<?phech$divme; ?>");ChgeFuDiv("hide");' 
width
="60" 
height
="22" 
bd
="0" 
y
="cursor:pointer" />

1023 </
div
>

1024 </
fm
>

1025 <?
php


	@dede/archives_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_Edit,a_AccEdit,a_MyEdit');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

7 if(
	$emy
(
$do
))

9 
$do
 = '';

10 
	}
}

11 if(
	g$do
!='save')

13 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

14 
que_
(
DEDEINC
."/dedetag.class.php");

15 
CˬMyAdd
();

16 
	g$aid
 = 
tv
(
$aid
);

19 
	g$cQuy
 = "Select ch.typenames channelname,ar.membernamesankname,arc.*

20 
From
 `#@
__chives
` 
c


21 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


22 

 
jo
 `#@
__k
` 

 

r.
nk
=
c
.
k
 
whe
rc.
id
='$aid'

25 
$cRow
 = 
$dsql
->
GO
(
$cQuy
);

26 if(!
is_y
(
$cRow
))

28 
ShowMsg
("读取档案基本信息出错!","-1");

29 
ex
();

32 
	g$quy
 = "Se * From `#@__chy` whid='".
$cRow
['channel']."'";

33 
	g$cInfos
 = 
$dsql
->
GO
(
$quy
);

34 if(!
is_y
(
$cInfos
))

36 
ShowMsg
("读取频道配置信息出错!","javascript:;");

37 
ex
();

39 
	g$addb
 = 
$cInfos
['addtable'];

40 
	g$addRow
 = 
$dsql
->
GO
("Select * From `$addtable` whereid='$aid'");

41 
	g$chlid
 = 
$cRow
['channel'];

42 
	g$gs
 = 
GTags
(
$aid
);

43 
ude
 
DedeInude
("templets/archives_edit.htm");

44 
ex
();

50 if(
	g$do
=='save')

52 
que_
(
DEDEINC
.'/image.func.php');

53 
que_
(
DEDEINC
.'/oxwindow.class.php');

54 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

55 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

57 if(
emy
(
$tyid2
)
	g$tyid2
 = 0;

58 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

59 if(!
ist
(
$me
)
	g$me
 = 0;

60 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

61 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

62 if(!
ist
(
$wr
)
	g$wr
 = '';

64 if(
	g$tyid
==0)

66 
ShowMsg
("请指定文档的栏目！","-1");

67 
ex
();

69 if(
emy
(
$chlid
))

71 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

72 
ex
();

74 if(!
CheckChl
(
$tyid
,
$chlid
))

76 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

77 
ex
();

79 if(!
TePurvw
('a_Edit'))

81 if(
TePurvw
('a_AccEdit'))

83 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的文档权限！");

87 
CheckArcAdm
(
$id
,
$curLog
->
gUrID
());

92 
	g$pubde
 = 
GMkTime
(
$pubde
);

93 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

94 
	g$ismake
 = 
$ishtml
==0 ? -1 : 0;

95 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

96 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

97 
	g$c
 = 
_subrR
(
$c
,7);

98 
	g$wr
 = 
_subrR
(
$wr
,20);

99 
	g$sour
 = 
_subrR
(
$sour
,30);

100 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

101 
	g$keywds
 = 
im
(
_subrR
(
$keywds
,60));

102 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

103 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

105 
	g$k
 = -1;

107 
	g$admid
 = 
$curLog
->
gUrID
();

110 if(
emy
(
$ddieme
))

112 
	g$ddieme
 = 0;

114 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

117 
	g$add_f
 = '';

118 
	g$add_v
 = '';

119 if(!
emy
(
$dede_addflds
))

121 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

122 
	g$add_f
 = '';

123 
	g$add_v
 = '';

124 if(
is_y
(
$addflds
))

126 
fܗch
(
$addflds
 
as
 
$v
)

128 if(
	g$v
=='')

132 
	g$vs
 = 
exode
(',',
$v
);

133 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

135 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

138 if(!
ist
(
$
{
$vs
[0]}))

140 
	g$
{
	g$vs
[0]} = '';

142 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$id
);

144 
	g$add_f
 .",`{$vs[0]}` = '".
$
{
$vs
[0]}."'";

150 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

152 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

154 if(
	g$deu
!='' && !
eg
('j',
$ag
))

156 
	g$ag
 = (
$ag
=='' ? 'j' : $flag.',j');

160 if(
eg
('j', 
$ag
)
	g$ismake
 = -1;

162 
	g$Quy
 = "update `#@__archives` set

163 
tyid
='$typeid',

164 
	gtyid2
='$typeid2',

165 
	gs܌k
='$sortrank',

166 
	gag
='$flag',

167 
	gnpo
='$notpost',

168 
	gick
='$click',

169 
	gismake
='$ismake',

170 
	gk
='$arcrank',

171 
	gmey
='$money',

172 
	gt
='$title',

173 
	gc
='$color',

174 
	gwr
='$writer',

175 
	gsour
='$source',

176 
	glpic
='$litpic',

177 
	gpubde
='$pubdate',

178 
	gdesti
='$description',

179 
	gkeywds
='$keywords',

180 
	gsh܉
='$shorttitle',

181 
	gfame
='$filename',

182 
	gdutyadm
='$adminid'

183 
whe
 
id
='$id'; ";

184 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

186 
ShowMsg
("更新数据库archives表时出错，请检查！","-1");

187 
ex
();

190 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

191 
	g$addb
 = 
im
(
$s
['addtable']);

192 if(
	g$addb
!='')

194 
$u
 = 
GIP
();

195 
	g$iquy
 = "update `$addtable` setypeid='$typeid'{$inadd_f},redirecturl='$redirecturl',userip='$useip' whereid='$id' ";

196 if(!
	g$dsql
->
ExecuNeQuy
(
$iquy
))

198 
ShowMsg
("更新附加表 `$addtable` 时出错，请检查原因！","javascript:;");

199 
ex
();

204 
UpIndexKey
(
$id
,
$k
,
$tyid
,
$s܌k
,
$gs
);

205 
	g$tU
 = 
MakeA
(
$id
,
ue
,true);

206 if(
	g$tU
=='')

208 
$tU
 = 
$cfg_phpu
."/view.php?aid=$id";

210 
CˬMyAdd
(
$id
, 
$t
);

212 
	g$msg
 = "

214 <
a
 
hf
='chives_add.php?cid=$tyid'><
u
>发布新文档</u></a>

215 &
nb
;&
	gnb
;

216 <
a
 
	ghf
='chives_do.php?aid=".$id."&dodArchives'><
u
>查看更改</u></a>

217 &
nb
;&
	gnb
;

218 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文档</u></a>

219 &
nb
;&
	gnb
;

220 <
a
 
	ghf
='log_do.php?cid=$tyid&doiArchives'><
u
>管理文档</u></a>

221 &
nb
;&
	gnb
;

222 
	g$backu


225 
	g$wt
 = "成功更改文档！";

226 
	g$wecome_fo
 = "文档管理::更改文档";

227 
	g$w
 = 
w
 
OxWdow
();

228 
	g$w
->
AddT
("成功更改文档：");

229 
	g$w
->
AddMsgIm
(
$msg
);

230 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

231 
	g$w
->
Diy
();

	@dede/archives_sg_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_New,a_AccNew');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

7 if(
	$emy
(
$do
))

9 
$do
 = '';

10 
	}
}

11 if(
	g$do
!='save')

13 
que_
(
DEDEINC
."/dedetag.class.php");

14 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

15 
CˬMyAdd
();

16 
	g$chlid
 = 
emy
(
$chlid
? 0 : 
tv
($channelid);

17 
	g$cid
 = 
emy
(
$cid
? 0 : 
tv
($cid);

20 if(
	g$cid
 > 0 && 
	g$chlid
 == 0)

22 
$row
 = 
$dsql
->
GO
("Select channeltype From `#@__arctype` where id='$cid'; ");

23 
	g$chlid
 = 
$row
['channeltype'];

27 if(
	g$chlid
==0)

29 
ShowMsg
("无法识别模型信息，因此无法操作！","-1");

30 
ex
();

35 
	g$cInfos
 = 
$dsql
->
GO
(" Select * From `#@__channeltype` where id='$channelid' ");

36 
	g$chlid
 = 
$cInfos
['id'];

37 
ude
 
DedeInude
("templets/archives_sg_add.htm");

38 
ex
();

44 if(
	g$do
=='save')

46 
que_
(
DEDEINC
.'/image.func.php');

47 
que_
(
DEDEINC
.'/oxwindow.class.php');

49 if(
	g$tyid
==0)

51 
ShowMsg
("请指定文档的栏目！","-1");

52 
ex
();

54 if(
emy
(
$chlid
))

56 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

57 
ex
();

59 if(!
CheckChl
(
$tyid
,
$chlid
) )

61 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

62 
ex
();

64 if(!
TePurvw
('a_New'))

66 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的权限！");

69 if(
emy
(
$wr
))
	g$wr
=
$curLog
->
gUrName
();

70 if(
emy
(
$sour
))
	g$sour
='未知';

71 if(
emy
(
$ags
)
	g$ag
 = '';

72 
	g$ag
 = 
jo
(',',
$ags
);

73 
	g$ndde
 = 
time
();

74 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

75 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

77 
	g$k
 = -1;

79 
	g$admid
 = 
$curLog
->
gUrID
();

80 
	g$ur
 = 
GIP
();

82 if(
emy
(
$ddieme
))

84 
	g$ddieme
 = 0;

86 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

89 
	g$cID
 = 
GIndexKey
(0,
$tyid
,
$ndde
,
$chlid
,$ndde,
$admid
);

91 if(
emy
(
$cID
))

93 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

94 
ex
();

98 
	g$add_f
 = '';

99 
	g$add_v
 = '';

100 if(!
emy
(
$dede_addflds
))

102 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

103 
	g$add_f
 = '';

104 
	g$add_v
 = '';

105 if(
is_y
(
$addflds
))

107 
fܗch
(
$addflds
 
as
 
$v
)

109 if(
	g$v
=='')

113 
	g$vs
 = 
exode
(',',
$v
);

114 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

116 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

120 if(!
ist
(
$
{
$vs
[0]}))

122 
	g$
{
	g$vs
[0]} = '';

124 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$cID
);

126 
	g$add_f
 .','.
$vs
[0];

127 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

133 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

135 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

139 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

140 
	g$addb
 = 
im
(
$s
['addtable']);

141 if(!
emy
(
$addb
))

143 
	g$quy
 = "INSERT INTO `{$addtable}`(aid,typeid,channel,arcrank,mid,click,title,senddate,flag,litpic,userip{$inadd_f})

144 
Vues
('$cID','$tyid','$chlid','$k','$admid','0','$t','$ndde','$ag','$lpic','$ur'{
$add_v
})";

145 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

147 
	g$gr
 = 
$dsql
->
GE
();

148 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

149 
ShowMsg
("把数据保存到数据库附加表 `{$addb}` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

150 
ex
();

155 
	g$tU
 = 
MakeA
(
$cID
,
ue
,true);

156 if(
	g$tU
=='')

158 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

160 
CˬMyAdd
(
$cID
, 
$t
);

162 
	g$msg
 = "

164 <
a
 
hf
='chives_sg_add.php?cid=$tyid'><
u
>继续发布文档</u></a>

165 &
nb
;&
	gnb
;

166 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文档</u></a>

167 &
nb
;&
	gnb
;

168 <
a
 
	ghf
='chives_do.php?aid=".$cID."&dodArchives'><
u
>更改文档</u></a>

169 &
nb
;&
	gnb
;

170 <
a
 
	ghf
='cڋ_sg_li.php?cid=$tyid&chlid={$chlid}&doiArchives'><
u
>已发布文档管理</u></a>

171 &
nb
;&
	gnb
;

172 <
a
 
	ghf
='log_ma.php'><
u
>网站栏目管理</u></a>

175 
$wt
 = "成功发布文档！";

176 
	g$wecome_fo
 = "文档管理::发布文档";

177 
	g$w
 = 
w
 
OxWdow
();

178 
	g$w
->
AddT
("成功发布文档：");

179 
	g$w
->
AddMsgIm
(
$msg
);

180 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

181 
	g$w
->
Diy
();

	@dede/archives_sg_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_Edit,a_AccEdit,a_MyEdit');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

7 if(
	$emy
(
$do
))

9 
$do
 = '';

10 
	}
}

11 if(
	g$do
!='save')

13 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

14 
que_
(
DEDEINC
."/dedetag.class.php");

15 
CˬMyAdd
();

16 
	g$aid
 = 
tv
(
$aid
);

19 
	g$cQuy
 = "Select ch.*,arc.* From `#@__arctiny`rc

20 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl
 
whe
rc.id='$aid' ";

22 
$cInfos
 = 
$dsql
->
GO
(
$cQuy
);

23 if(!
is_y
(
$cInfos
))

25 
ShowMsg
("读频道模型信息出错！","-1");

26 
ex
();

29 
	g$addb
 = 
$cInfos
['addtable'];

30 
	g$addRow
 = 
$dsql
->
GO
("Selectrc.*,ar.membernamesankname From `$addtable`rceft join `#@__arcrank`r onr.rank=arc.arcrank whererc.aid='$aid'");

31 
	g$chlid
 = 
$cInfos
['channel'];

32 
	g$gs
 = 
GTags
(
$aid
);

33 
ude
 
DedeInude
('templets/archives_sg_edit.htm');

34 
ex
();

40 if(
	g$do
=='save')

42 
que_
(
DEDEINC
.'/image.func.php');

43 
que_
(
DEDEINC
.'/oxwindow.class.php');

44 if(
	g$tyid
==0)

46 
ShowMsg
("请指定文档的栏目！","-1");

47 
ex
();

49 if(
emy
(
$chlid
))

51 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

52 
ex
();

54 if(!
CheckChl
(
$tyid
,
$chlid
))

56 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

57 
ex
();

59 if(!
TePurvw
('a_Edit'))

61 if(
TePurvw
('a_AccEdit'))

63 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的文档权限！");

67 
CheckArcAdm
(
$id
,
$curLog
->
gUrID
());

71 if(
emy
(
$ags
)
	g$ag
 = '';

72 
	g$ag
 = 
jo
(',',
$ags
);

73 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

74 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

76 
	g$k
 = -1;

78 
	g$admid
 = 
$curLog
->
gUrID
();

81 if(
emy
(
$ddieme
))

83 
	g$ddieme
 = 0;

85 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

88 
	g$add_f
 = '';

89 
	g$add_v
 = '';

90 if(!
emy
(
$dede_addflds
))

92 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

93 
	g$add_f
 = '';

94 
	g$add_v
 = '';

95 if(
is_y
(
$addflds
))

97 
fܗch
(
$addflds
 
as
 
$v
)

99 if(
	g$v
=='')

103 
	g$vs
 = 
exode
(',',
$v
);

104 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

106 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

109 if(!
ist
(
$
{
$vs
[0]}))

111 
	g$
{
	g$vs
[0]} = '';

113 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$id
);

115 
	g$add_f
 .",`{$vs[0]}` = '".
$
{
$vs
[0]}."'";

121 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

123 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

126 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

127 
	g$addb
 = 
im
(
$s
['addtable']);

128 if(
	g$addb
!='')

130 
$iquy
 = "update `$addtable` setypeid='$typeid',arcrank='$arcrank',title='$title',flag='$flag',litpic='$litpic'{$inadd_f} whereid='$id' ";

131 if(!
	g$dsql
->
ExecuNeQuy
(
$iquy
))

133 
ShowMsg
("更新附加表 `$addtable` 时出错，请检查原因！","javascript:;");

134 
ex
();

139 
UpIndexKey
(
$id
,
$k
,
$tyid
,
$s܌k
,'');

140 
	g$tU
 = 
MakeA
(
$id
,
ue
,true);

141 if(
	g$tU
=='')

143 
$tU
 = 
$cfg_phpu
."/view.php?aid=$id";

145 
CˬMyAdd
(
$id
, 
$t
);

147 
	g$msg
 = "

149 <
a
 
hf
='chives_sg_add.php?cid=$tyid'><
u
>发布新文档</u></a>

150 &
nb
;&
	gnb
;

151 <
a
 
	ghf
='chives_do.php?aid=".$id."&dodArchives'><
u
>查看更改</u></a>

152 &
nb
;&
	gnb
;

153 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文档</u></a>

154 &
nb
;&
	gnb
;

155 <
a
 
	ghf
='log_do.php?cid=$tyid&chlid={$chlid}&doiArchives'><
u
>管理文档</u></a>

156 &
nb
;&
	gnb
;

157 <
a
 
	ghf
='log_ma.php'><
u
>网站栏目管理</u></a>

160 
$wt
 = "成功更改文档！";

161 
	g$wecome_fo
 = "文档管理::更改文档";

162 
	g$w
 = 
w
 
OxWdow
();

163 
	g$w
->
AddT
("成功更改文档：");

164 
	g$w
->
AddMsgIm
(
$msg
);

165 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

166 
	g$w
->
Diy
();

	@dede/article_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('a_New,a_AccNew');

4 
que_
(
DEDEINC
.'/customfields.func.php');

5 
que_
(
DEDEADMIN
.'/inc/inc_archives_functions.php');

6 if(
fe_exis
(
DEDEDATA
.'/template.rand.php'))

8 
que_
(
DEDEDATA
.'/template.rand.php');

10 if(
	$emy
(
$do
))

12 
$do
 = '';

13 
	}
}

15 if(
	g$do
!='save')

17 
que_
(
DEDEINC
."/dedetag.class.php");

18 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

19 
CˬMyAdd
();

20 
	g$chlid
 = 
emy
(
$chlid
? 0 : 
tv
($channelid);

21 
	g$cid
 = 
emy
(
$cid
? 0 : 
tv
($cid);

23 if(
emy
(
$gu
)
	g$gu
 = '';

25 
	g$keywds
 = 
$wr
 = 
$sour
 = 
$body
 = 
$desti
 = 
$t
 = '';

28 if(
eg
('^hp://',
$gu
))

30 
que_
(
DEDEADMIN
."/inc/inc_coonepage.php");

31 
	g$das
 = 
CoOPage
(
$gu
);

32 
exa
(
$das
);

36 if(
	g$cid
>0 && 
	g$chlid
==0)

38 
$row
 = 
$dsql
->
GO
("Select channeltype From `#@__arctype` where id='$cid'; ");

39 
	g$chlid
 = 
$row
['channeltype'];

43 if(
	g$chlid
==0)

45 
$chlid
 = 1;

50 
	g$cInfos
 = 
$dsql
->
GO
(" Select * From `#@__channeltype` where id='$channelid' ");

51 
ude
 
DedeInude
("templets/article_add.htm");

52 
ex
();

58 if(
	g$do
=='save')

60 
que_
(
DEDEINC
.'/image.func.php');

61 
que_
(
DEDEINC
.'/oxwindow.class.php');

62 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

63 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

65 if(
emy
(
$tyid2
)
	g$tyid2
 = '';

66 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

67 if(!
ist
(
$me
)
	g$me
 = 0;

68 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

69 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

70 if(
emy
(
$ick
)
	g$ick
 = (
$cfg_c_ick
=='-1' ? 
mt_nd
(50, 200) : $cfg_arc_click);

72 if(
emy
(
$tyid
))

74 
ShowMsg
("请指定文档的栏目！","-1");

75 
ex
();

77 if(
emy
(
$chlid
))

79 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

80 
ex
();

82 if(!
CheckChl
(
$tyid
,
$chlid
))

84 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

85 
ex
();

87 if(!
TePurvw
('a_New'))

89 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的权限！");

93 if(
emy
(
$wr
))
	g$wr
=
$curLog
->
gUrName
();

94 if(
emy
(
$sour
))
	g$sour
='未知';

95 
	g$pubde
 = 
GMkTime
(
$pubde
);

96 
	g$ndde
 = 
time
();

97 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

98 
	g$ismake
 = 
$ishtml
==0 ? -1 : 0;

99 
	g$t
 = 
eg_a
('"', '＂', 
$t
);

100 
	g$t
 = 
htmleclchs
(
_subrR
(
$t
,
$cfg_t_maxn
));

101 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

102 
	g$c
 = 
_subrR
(
$c
,7);

103 
	g$wr
 = 
_subrR
(
$wr
,20);

104 
	g$sour
 = 
_subrR
(
$sour
,30);

105 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

106 
	g$keywds
 = 
_subrR
(
$keywds
,60);

107 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

108 
	g$ur
 = 
GIP
();

110 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

112 
	g$k
 = -1;

114 
	g$admid
 = 
$curLog
->
gUrID
();

117 if(
emy
(
$ddieme
))

119 
	g$ddieme
 = 0;

122 
	g$lpic
 = 
GDDImage
('ne', 
$piame
, 
$ddieme
);

125 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$admid
);

127 if(
emy
(
$cID
))

129 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

130 
ex
();

132 if(
im
(
$t
) == '')

134 
ShowMsg
('标题不能为空', '-1');

135 
ex
();

139 
	g$body
 = 
AlyHtmlBody
(
$body
,
$desti
,
$lpic
,
$keywds
,'htmltext');

142 if(
	g$ty
=='auto')

144 
$body
 = 
SpLgBody
($body,
$size
*1024,"#p#分页标题#e#");

148 
	g$add_f
 = 
$add_v
 = '';

149 if(!
emy
(
$dede_addflds
))

151 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

152 if(
is_y
(
$addflds
))

154 
fܗch
(
$addflds
 
as
 
$v
)

156 if(
	g$v
=='') ;

157 
	g$vs
 = 
exode
(',',
$v
);

158 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

160 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

164 if(!
ist
(
$
{
$vs
[0]})
	g$
{
	g$vs
[0]} = '';

165 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$cID
);

167 
	g$add_f
 .','.
$vs
[0];

168 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

174 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

176 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

178 if(
	g$deu
!='' && !
eg
('j',
$ag
))

180 
	g$ag
 = (
$ag
=='' ? 'j' : $flag.',j');

184 if(
eg
('j', 
$ag
)
	g$ismake
 = -1;

187 
	g$quy
 = "INSERT INTO `#@__archives`(id,typeid,typeid2,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

188 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gnpo
,
	gdesti
,
	gkeywds
,
	gfame
,
	gdutyadm
)

189 
VALUES
 ('$arcID','$typeid','$typeid2','$sortrank','$flag','$ismake','$channelid','$arcrank','$click','$money',

193 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

195 
	g$gr
 = 
$dsql
->
GE
();

196 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

197 
ShowMsg
("把数据保存到数据库主表 `#@__chives` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

198 
ex
();

202 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

203 
	g$addb
 = 
im
(
$s
['addtable']);

204 if(
emy
(
$addb
))

206 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

207 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

208 
ShowMsg
("没找到当前模型[{$channelid}]的主表信息，无法完成操作！。","javascript:;");

209 
ex
();

211 
	g$u
 = 
GIP
();

212 
	g$m
 = 
emy
(
$m
) ? '' : $templet;

213 
	g$quy
 = "INSERT INTO `{$addtable}`(aid,typeid,redirecturl,templet,userip,body{$inadd_f}) Values('$arcID','$typeid','$redirecturl','$templet','$useip','$body'{$inadd_v})";

214 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

216 
	g$gr
 = 
$dsql
->
GE
();

217 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

218 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

219 
ShowMsg
("把数据保存到数据库附加表 `{$addb}` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

220 
ex
();

224 
InTags
(
$gs
,
$cID
);

225 
	g$tU
 = 
MakeA
(
$cID
,
ue
,true);

226 if(
	g$tU
=='')

228 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

230 
CˬMyAdd
(
$cID
, 
$t
);

232 
	g$msg
 = " 　　请选择你的后续操作：

233 <
a
 
hf
='tie_add.php?cid=$tyid'><
u
>继续发布文章</u></a>

234 &
nb
;&
	gnb
;

235 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文章</u></a>

236 &
nb
;&
	gnb
;

237 <
a
 
	ghf
='chives_do.php?aid=".$cID."&dodArchives'><
u
>更改文章</u></a>

238 &
nb
;&
	gnb
;

239 <
a
 
	ghf
='log_do.php?cid=$tyid&doiArchives'><
u
>已发布文章管理</u></a>

240 &
nb
;&
	gnb
;

241 
	g$backu


243 
	g$msg
 = "<div sty=\"le-height:36px;height:36px\">{$msg}</div>".
GUpdeTe
();

244 
	g$wt
 = "成功发布文章！";

245 
	g$wecome_fo
 = "文章管理::发布文章";

246 
	g$w
 = 
w
 
OxWdow
();

247 
	g$w
->
AddT
("成功发布文章：");

248 
	g$w
->
AddMsgIm
(
$msg
);

249 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

250 
	g$w
->
Diy
();

	@dede/article_coonepage_rule.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

5 if(
	$emy
(
$ai
))

7 
$ai
 = '';

8 
	}
}

13 if(
	g$ai
 == 'add')

15 
$row
 = 
$dsql
->
GO
("Select * From `#@__co_onepage` where urlike '$url' ");

16 if(
is_y
(
$row
))

18 
	gecho
 "系统已经存在这个网址的条目！";

21 
	g$quy
 = " Insert into `#@__co_onepage`(`url`,`title`,`issource`,`lang`,`rule`) Values('$url','$title','$issource','$lang','$rule'); ";

22 
	g$dsql
->
ExecuNequy
(
$quy
);

23 
echo
 
	g$dsql
->
GE
();

30 if(
	g$ai
 == 'del')

32 if(!
eg
(',',
$ids
))

34 
$quy
 = "Delete From `#@__co_onepage` where id='$ids' ";

38 
	g$quy
 = "Delete From `#@__co_onepage` where id in($ids) ";

40 
	g$dsql
->
ExecuNequy
(
$quy
);

46 if(
	g$ai
 == 'editsave')

48 
$quy
 = "Update `#@__co_onepage` set `url`='$url',`title`='$title',`issource`='$issource',`lang`='$lang',`rule`='$rule' where id='$id' ";

49 
	g$dsql
->
ExecuNequy
(
$quy
);

50 
echo
 
	g$dsql
->
GE
();

55 if(
	g$ai
 == 'editload')

57 
$row
 = 
$dsql
->
GO
("Select * From `#@__co_onepage` where id='$id' ");

58 
AjaxHd
();

60 <
fm
 
	gme
='addfm' 
ai
='tie_coڕage_ru.php' 
mhod
='post'>

61 <
put
 
ty
='hidd' 
me
='id' 
vue
='<?phpcho $id; ?>' />

62 <
put
 
ty
='hidd' 
me
='ai' 
vue
='editsave' />

63 <
b
 
width
="430" 
bd
="0" 
Υacg
="0" 
ηddg
="0">

64 <

>

65 <
td
 
width
="102" 
height
="30">网站名称：</td>

66 <
td
 
width
="302"><
put
 
me
="t" 
ty
="xt" 
id
="t" 
y
="width:200px" 
vue
="<?phpcho $row['title']; ?>" /></td>

67 <
td
 
width
="26" 
ign
=""><
a
 
hf
="javast:CloEdNode()"><
img
 
c
="img/o.gif" width="12" 
height
="12" 
bd
="0" /></a></td>

68 </

>

69 <

>

70 <
td
 
height
="30">原内容编码：</td>

71 <
td
 
cޥ
="2">

72 <
put
 
ty
="dio" 
me
="ng" 
vue
="gb2312" <?
php
 
echo
 (
$row
['lang']=='gb2312' ? ' checked="checked" ' : ''); ?> />

73 
	gGB2312
/
	gGBK


74 <
put
 
	gty
="dio" 
me
="ng" 
vue
="utf-8" <?
php
 
echo
 (
$row
['lang']=='utf-8' ? ' checked="checked" ' : ''); ?> />

75 
	gUTF
-8

76 </
	gtd
>

77 </
	g
>

78 <
	g
>

79 <
td
 
	gheight
="30">用作文章来源：</td>

80 <
td
 
cޥ
="2">

81 <
put
 
ty
="dio" 
me
="issour" 
vue
="0" <?
php
 
echo
 (
$row
['issource']==0 ? ' checked="checked" ' : ''); ?> />

83 <
put
 
	gme
="issour" 
ty
="dio" 
vue
="1" <?
php
 
echo
 (
$row
['issource']==1 ? ' checked="checked" ' : ''); ?> />

85 </
	gtd
>

86 </
	g
>

87 <
	g
>

88 <
td
 
	gheight
="30">网站网址：</td>

89 <
td
 
cޥ
="2">

90 <
put
 
me
="u" 
ty
="xt" 
id
="u" 
vue
="<?phech$row['u']; ?>" 
y
="width:200px" />

91 </
td
>

92 </

>

93 <

>

94 <
td
 
height
="30">&
nb
;</
	gtd
>

95 <
td
 
	gcޥ
="2">

96 使用不带
hp
及任何附加目录的网址<
br
 />

97 如：
ws
.
dedecms
.
com


98 </
td
>

99 </

>

100 <

>

101 <
td
 
height
="30">采集规则：</td>

102 <
td
 
cޥ
="2">仅针对文章内容，格式：前面
HTML
{@
body
}后面
HMTL
</td>

103 </

>

104 <

>

105 <
td
 
height
="90">&
nb
;</
	gtd
>

106 <
td
 
	gcޥ
="2"><
xa
 
me
="ru" 
y
="width:300px;height:80px"><?
php
 
echo
 
$row
['ru']; ?></
	gxa
></
	gtd
>

107 </
	g
>

108 <
	g
>

109 <
td
 
	gheight
="32">&
nb
;</
	gtd
>

110 <
td
 
	gcޥ
="2"><
put
 
ass
="nbt" 
ty
="subm" 
me
="Subm" 
vue
="保存规则" />　

111 <
put
 
ty
="t" 
ass
="nbt" 
me
="Subm2" 
vue
="重置" /></
td
>

112 </

>

113 </
b
>

114 </
fm
>

115 <?
php


116 
ex
();

122 
	g$sql
 = "";

123 
	g$sql
 = "Select id,url,title,lang,issource From `#@__co_onepage` order by id desc";

124 
	g$dli
 = 
w
 
DaLiCP
();

125 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/article_coonepage_rule.htm");

126 
	g$dli
->
SSour
(
$sql
);

127 
	g$dli
->
Diy
();

	@dede/article_description_main.php

1 <?
	gphp


2 @
ob_t
();

3 @
t_time_lim
(3600);

4 
que_
(
dme
(
__FILE__
)."/config.php");

5 
CheckPurvw
('sys_Keyword');

6 if(
emy
(
$dojob
)
	g$dojob
 = '';

7 if(
	g$dojob
=='')

9 
ude
 
DedeInude
("templets/article_description_main.htm");

10 
ex
();

14 if(
emy
(
$tdd
))

16 
	g$tdd
 = 0;

18 if(
emy
(
$gesize
))

20 
	g$gesize
 = 100;

22 if(
emy
(
$tٮnum
))

24 
	g$tٮnum
 = 0;

26 if(
emy
(
$sid
))

28 
	g$sid
 = 0;

30 if(
emy
(
$eid
))

32 
	g$eid
 = 0;

34 if(
emy
(
$dojob
))

36 
	g$dojob
 = 'des';

38 
	g$b
 = 
eg_a
("[^0-9a-zA-Z_#@]","",
$b
);

39 
	g$fld
 = 
eg_a
("[^0-9a-zA-Z_\[\]]","",
$fld
);

40 
	g$chl
 = 
tv
(
$chl
);

41 if(
	g$dsize
>250)

43 
	g$dsize
 = 250;

46 
	g$tjnum
 = 0;

49 if(
	g$dojob
=='des')

52 if(
emy
(
$tٮnum
))

54 
$addquy
 = "";

55 if(
	g$sid
!=0)

57 
$addquy
 .= " And id>='$sid' ";

59 if(
	g$eid
!=0)

61 
$addquy
 .= " And id<='$eid' ";

63 
	g$tjQuy
 = "Select count(*)s dd From #@__archives where channel='{$channel}' $addquery";

64 
	g$row
 = 
$dsql
->
GO
(
$tjQuy
);

65 
	g$tٮnum
 = 
$row
['dd'];

67 if(
	g$tٮnum
 > 0)

69 
	g$addquy
 = "";

70 if(
	g$sid
!=0)

72 
$addquy
 .= " And #@__archives.id>='$sid' ";

74 if(
	g$eid
!=0)

76 
$addquy
 .= " And #@__archives.id<='$eid' ";

78 
	g$fquy
 = "Select #@__archives.id,#@__archives.title,#@__archives.description,{$table}.{$field}

79 
From
 #@
__chives
 

 
jo
 {
$b
} 

 {$b}.
aid
=#@__chives.
id


80 
whe
 #@
__chives
.
chl
='{$chl}' 
$addquy
 
lim
 
$tdd
,
	g$gesize
 ; ";

81 
	g$dsql
->
SQuy
(
$fquy
);

82 
	g$dsql
->
Execu
();

83 
	g$row
=
$dsql
->
GAay
())

85 
$body
 = 
$row
[
$fld
];

86 
	g$desti
 = 
$row
['description'];

87 if(

(
$desti
)>10 || 
	g$desti
=='-')

91 
	g$bodyxt
 = 
eg_a
("/#p#|#e#|副标题|分页标题/isU","",
Html2Text
(
$body
));

92 if(

(
$bodyxt
< 
	g$msize
)

96 
	g$des
 = 
im
(
addashes
(
_subr
(
$bodyxt
,
$dsize
)));

97 if(

(
$des
)<3)

99 
	g$des
 = "-";

101 
	g$dsql
->
ExecuNeQuy
("Update #@__archives set description='{$des}' where id='{$row['id']}';");

105 
	g$tdd
 = 
$tdd
 + 
$gesize
;

106 if(
	g$tٮnum
 > 
	g$tdd
)

108 
	g$tjn
 = 

(
$tdd
/
$tٮnum
) * 100 );

111 
	g$tjn
=100;

112 
ShowMsg
('完成所有任务', 'javascript:;');

113 
ex
();

115 
	g$dvn
 = 
$tjn
 * 2;

116 
	g$tja
 = "<div style='width:200;height:15;border:1px solid #898989;text-align:left'><div style='width:$dvlen;height:15;background-color:#829D83'></div></div>";

117 
	g$tja
 .= "<br/>完成处理文档总数的：$tjlen %，继续执行任务...";

118 
	g$nu
 = "article_description_main.php?totalnum=$totalnum&startdd={$startdd}&pagesize=$pagesize&table={$table}&field={$field}&dsize={$dsize}&msize={$msize}&channel={$channel}&dojob={$dojob}";

119 
ShowMsg
(
$tja
,
$nu
,0,500);

120 
ex
();

124 
ShowMsg
('完成所有任务', 'javascript:;');

125 
ex
();

130 if(
	g$dojob
=='page')

132 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

134 
	g$addquy
 = "";

135 if(
	g$sid
!=0)

137 
$addquy
 .= "ndid>='$sid' ";

139 if(
	g$eid
!=0)

141 
$addquy
 .= "ndid<='$eid' ";

145 if(
	g$tٮnum
==0)

147 
$sql
 = "Select count(*)s dd From $table where 1 $addquery";

148 
	g$row
 = 
$dsql
->
GO
(
$sql
);

149 
	g$tٮnum
 = 
$row
['dd'];

153 if(
	g$tٮnum
 > 
	g$tdd
+
	g$gesize
)

155 
	g$limSql
 = "imit $startdd,$pagesize";

157 if((
	g$tٮnum
-
	g$tdd
)>0)

159 
	g$limSql
 = "im $tdd,".(
$tٮnum
 - 
$tdd
);

163 
	g$limSql
 = "";

165 
	g$tjnum
 = 
$tdd
;

166 if(
	g$limSql
!="")

168 
$fquy
 = "Selectid,$field From $table where 1 $addquery $limitSql ;";

169 
	g$dsql
->
SQuy
(
$fquy
);

170 
	g$dsql
->
Execu
();

171 
	g$row
=
$dsql
->
GAay
())

173 
$tjnum
++;

174 
	g$body
 = 
$row
[
$fld
];

175 
	g$aid
 = 
$row
['aid'];

176 if(

(
$body
< 
	g$msize
)

180 if(!
eg_mch
("/#p#/iU",
$body
))

182 
	g$body
 = 
SpLgBody
(
$body
,
$cfg_uto_size
*1024,"#p#分页标题#e#");

183 
	g$body
 = 
addashes
(
$body
);

184 
	g$dsql
->
ExecuNeQuy
("Update $table set $field='$body' whereid='$aid' ; ");

190 if(
	g$tٮnum
>0)

192 
	g$tjn
 = 

(
$tjnum
/
$tٮnum
) * 100 );

196 
	g$tjn
=100;

199 
	g$dvn
 = 
$tjn
 * 2;

201 
	g$tja
 = "<div style='width:200;height:15;border:1px solid #898989;text-align:left'><div style='width:$dvlen;height:15;background-color:#829D83'></div></div>";

202 
	g$tja
 .= "<br/>完成处理文档总数的：$tjlen %，继续执行任务...";

204 if(
	g$tjnum
 < 
	g$tٮnum
)

206 
	g$nu
 = "tie_desti_ma.php?tٮnum=$tٮnum&tdd=".(
$tdd
+
$gesize
)."&pagesize=$pagesize&table={$table}&field={$field}&dsize={$dsize}&msize={$msize}&channel={$channel}&dojob={$dojob}";

207 
ShowMsg
(
$tja
,
$nu
,0,500);

208 
ex
();

212 
ShowMsg
('完成所有任务', 'javascript:;');

213 
ex
();

	@dede/article_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_Edit,a_AccEdit,a_MyEdit');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

6 if(
fe_exis
(
DEDEDATA
.'/template.rand.php'))

8 
que_
(
DEDEDATA
.'/template.rand.php');

10 if(
	$emy
(
$do
))

12 
$do
 = '';

13 
	}
}

15 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

16 if(
	g$do
!='save')

18 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

19 
que_
(
DEDEINC
."/dedetag.class.php");

20 
CˬMyAdd
();

23 
	g$quy
 = "Select ch.typenames channelname,ar.membernamesankname,arc.*

24 
From
 `#@
__chives
` 
c


25 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


26 

 
jo
 `#@
__k
` 

 

r.
nk
=
c
.
k
 
whe
rc.
id
='$aid' ";

27 
$cRow
 = 
$dsql
->
GO
(
$quy
);

28 if(!
is_y
(
$cRow
))

30 
ShowMsg
("读取档案基本信息出错!","-1");

31 
ex
();

33 
	g$quy
 = "Se * From `#@__chy` whid='".
$cRow
['channel']."'";

34 
	g$cInfos
 = 
$dsql
->
GO
(
$quy
);

35 if(!
is_y
(
$cInfos
))

37 
ShowMsg
("读取频道配置信息出错!","javascript:;");

38 
ex
();

40 
	g$addb
 = 
$cInfos
['addtable'];

41 
	g$addRow
 = 
$dsql
->
GO
("Select * From `$addtable` whereid='$aid'");

42 if(!
is_y
(
$addRow
))

44 
ShowMsg
("读取附加信息出错!","javascript:;");

45 
ex
();

47 
	g$chlid
 = 
$cRow
['channel'];

48 
	g$gs
 = 
GTags
(
$aid
);

49 
ude
 
DedeInude
("templets/article_edit.htm");

50 
ex
();

56 if(
	g$do
=='save')

58 
que_
(
DEDEINC
.'/image.func.php');

59 
que_
(
DEDEINC
.'/oxwindow.class.php');

60 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

61 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

63 if(
emy
(
$tyid2
)
	g$tyid2
 = 0;

64 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

65 if(!
ist
(
$me
)
	g$me
 = 0;

66 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

67 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

69 if(
emy
(
$tyid
))

71 
ShowMsg
("请指定文档的栏目！","-1");

72 
ex
();

74 if(
emy
(
$chlid
))

76 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

77 
ex
();

79 if(!
CheckChl
(
$tyid
,
$chlid
))

81 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

82 
ex
();

84 if(!
TePurvw
('a_Edit'))

86 if(
TePurvw
('a_AccEdit'))

88 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的文档权限！");

92 
CheckArcAdm
(
$id
,
$curLog
->
gUrID
());

98 
	g$pubde
 = 
GMkTime
(
$pubde
);

99 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

100 
	g$ismake
 = 
$ishtml
==0 ? -1 : 0;

101 
	g$t
 = 
htmleclchs
(
_subrR
(
$t
,
$cfg_t_maxn
));

102 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

103 
	g$c
 = 
_subrR
(
$c
,7);

104 
	g$wr
 = 
_subrR
(
$wr
,20);

105 
	g$sour
 = 
_subrR
(
$sour
,30);

106 
	g$desti
 = 
_subrR
(
$desti
,250);

107 
	g$keywds
 = 
im
(
_subrR
(
$keywds
,60));

108 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

109 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

111 
	g$k
 = -1;

113 
	g$admid
 = 
$curLog
->
gUrID
();

116 if(
emy
(
$ddieme
))

118 
	g$ddieme
 = 0;

120 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

123 
	g$body
 = 
AlyHtmlBody
(
$body
,
$desti
,
$lpic
,
$keywds
,'htmltext');

126 
	g$add_f
 = '';

127 
	g$add_v
 = '';

128 if(!
emy
(
$dede_addflds
))

130 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

131 
	g$add_f
 = '';

132 
	g$add_v
 = '';

133 if(
is_y
(
$addflds
))

135 
fܗch
(
$addflds
 
as
 
$v
)

137 if(
	g$v
=='')

141 
	g$vs
 = 
exode
(',',
$v
);

142 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

144 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

147 if(!
ist
(
$
{
$vs
[0]}))

149 
	g$
{
	g$vs
[0]} = '';

151 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$id
);

153 
	g$add_f
 .",`{$vs[0]}` = '".
$
{
$vs
[0]}."'";

159 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

161 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

163 if(
	g$deu
!='' && !
eg
('j',
$ag
))

165 
	g$ag
 = (
$ag
=='' ? 'j' : $flag.',j');

169 if(
eg
('j', 
$ag
)
	g$ismake
 = -1;

171 
	g$quy
 = "update #@__archives set

172 
tyid
='$typeid',

173 
	gtyid2
='$typeid2',

174 
	gs܌k
='$sortrank',

175 
	gag
='$flag',

176 
	gick
='$click',

177 
	gismake
='$ismake',

178 
	gk
='$arcrank',

179 
	gmey
='$money',

180 
	gt
='$title',

181 
	gc
='$color',

182 
	gwr
='$writer',

183 
	gsour
='$source',

184 
	glpic
='$litpic',

185 
	gpubde
='$pubdate',

186 
	gnpo
='$notpost',

187 
	gdesti
='$description',

188 
	gkeywds
='$keywords',

189 
	gsh܉
='$shorttitle',

190 
	gfame
='$filename',

191 
	gdutyadm
='$adminid'

192 
whe
 
id
='$id'; ";

194 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

196 
ShowMsg
('更新数据库archives表时出错，请检查',-1);

197 
ex
();

200 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

201 
	g$addb
 = 
im
(
$s
['addtable']);

202 if(
	g$addb
!='')

204 
$u
 = 
GIP
();

205 
	g$m
 = 
emy
(
$m
) ? '' : $templet;

206 
	g$iquy
 = "update `$addtable` setypeid='$typeid',body='$body'{$inadd_f},redirecturl='$redirecturl',templet='$templet',userip='$useip' whereid='$id'";

207 if(!
	g$dsql
->
ExecuNeQuy
(
$iquy
))

209 
ShowMsg
("更新附加表 `$addtable` 时出错，请检查原因！","javascript:;");

210 
ex
();

215 
UpIndexKey
(
$id
,
$k
,
$tyid
,
$s܌k
,
$gs
);

216 
	g$tU
 = 
MakeA
(
$id
,
ue
,true);

217 if(
	g$tU
=='')

219 
$tU
 = 
$cfg_phpu
."/view.php?aid=$id";

221 
CˬMyAdd
(
$id
, 
$t
);

224 
	g$msg
 = "

226 <
a
 
hf
='tie_add.php?cid=$tyid'><
u
>发布新文章</u></a>

227 &
nb
;&
	gnb
;

228 <
a
 
	ghf
='chives_do.php?aid=".$id."&dodArchives'><
u
>查看更改</u></a>

229 &
nb
;&
	gnb
;

230 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文章</u></a>

231 &
nb
;&
	gnb
;

232 <
a
 
	ghf
='log_do.php?cid=$tyid&doiArchives'><
u
>管理文章</u></a>

233 &
nb
;&
	gnb
;

234 
	g$backu


237 
	g$wt
 = "成功更改文章！";

238 
	g$wecome_fo
 = "文章管理::更改文章";

239 
	g$w
 = 
w
 
OxWdow
();

240 
	g$w
->
AddT
("成功更改文章：");

241 
	g$w
->
AddMsgIm
(
$msg
);

242 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

243 
	g$w
->
Diy
();

	@dede/article_keywords_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Keyword');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 if(
	$emy
(
$do
))

8 
$do
 = '';

9 
	}
}

12 if(
	g$do
=='saveall')

14 
$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? "article_keywords_main.php" : $_COOKIE['ENV_GOBACK_URL'];

15 if(!
ist
(
$aids
))

17 
ShowMsg
("你没有选择要更改的东东！",
$ENV_GOBACK_URL
);

18 
ex
();

20 
fܗch
(
$aids
 
as
 
$aid
)

22 
	g$u
 = 
$
{'u_'.
$aid
};

23 
	g$ud
 = 
$
{'ud_'.
$aid
};

24 
	g$keywd
 = 
$
{'keywd_'.
$aid
};

27 if(!
emy
(
$
{'isd_'.
$aid
}))

29 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__keywords` whereid='$aid'");

34 
	g$ad
 = 
$
{'ad_'.
$aid
};

35 
	g$a
 = 
emy
(
$
{'iou_'.
$aid
}) ? 1 : 0;

36 if(
	g$ad
!=
$a
)

38 
$quy1
 = "update `#@__keywords` set sta='$sta',rpurl='$rpurl' whereid='$aid' ";

39 
	g$dsql
->
ExecuNeQuy
(
$quy1
);

44 if(
	g$u
!=
$ud
)

46 
$quy1
 = "update `#@__keywords` setpurl='$rpurl' whereid='$aid' ";

47 
	g$dsql
->
ExecuNeQuy
(
$quy1
);

50 
ShowMsg
("完成指定的更改！",
$ENV_GOBACK_URL
);

51 
ex
();

55 if(
	g$do
=='add')

57 
$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? "-1" : $_COOKIE['ENV_GOBACK_URL'];

58 
	g$keywd
 = 
im
(
$keywd
);

59 
	g$nk
 = 
eg_a
('[^0-9]','',
$nk
);

60 if(
	g$keywd
=='')

62 
ShowMsg
("关键字不能为空！",-1);

63 
ex
();

65 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__keywords` where keywordike '$keyword'");

66 if(
is_y
(
$row
))

68 
ShowMsg
("关键字已存在库中！","-1");

69 
ex
();

71 
	g$quy
 = "INSERT INTO `#@__keywords`(keyword,rank,sta,rpurl) VALUES ('$keyword','$rank','1','$rpurl');";

72 
	g$dsql
->
ExecuNeQuy
(
$quy
);

73 
ShowMsg
("成功增加一个关键字！",
$ENV_GOBACK_URL
);

74 
ex
();

76 if(
	$emy
(
$keywd
))

78 
$keywd
 = '';

79 
$addquy
 = '';

80 
	}
}

83 
	g$addquy
 = " where keywordike '%$keyword%' ";

86 
	g$sql
 = "Select * from `#@__keywords` $addquery order byank desc";

87 
	g$dli
 = 
w
 
DaLiCP
();

88 
	g$dli
->
	ggeSize
 = 20;

89 
	g$dli
->
SPam
("keywd",
$keywd
);

90 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/article_keywords_main.htm");

91 
	g$dli
->
SSour
(
$sql
);

92 
	g$dli
->
Diy
();

94 
funi
 
	$GS
(
$a
)

96 if(
$a
==1)

104 
	}
}

	@dede/article_keywords_make.php

1 <?
	gphp


2 @
ob_t
();

3 @
t_time_lim
(3600);

4 
que_
(
dme
(
__FILE__
).'/config.php');

5 
CheckPurvw
('sys_Keyword');

6 if(
	$emy
(
$do
))

8 
$do
 = '';

9 
	}
}

12 if(
	g$do
=='analyse')

14 
echo
 "正在读取关键字数据库...<br/>\r\n";

15 
ush
();

16 
	g$ws
 = 
$w
 = 
$wew
 = "";

17 
	g$dsql
->
SQuy
("Select * from `#@__keywords`");

18 
	g$dsql
->
Execu
();

19 
	g$row
 = 
$dsql
->
GObje
())

21 if(
$row
->
a
==1)

23 
$ws
[
$row
->
keywd
] = 1;

27 
	g$w
[
$row
->
keywd
] = 1;

30 
	gecho
 "完成关键字数据库的载入！<br/>\r\n";

31 
ush
();

32 
	gecho
 "读取档案数据库，并对禁用的关键字和生字进行处理...<br/>\r\n";

33 
ush
();

34 
	g$dsql
->
SQuy
("Select id,keywords from `#@__archives`");

35 
	g$dsql
->
Execu
();

36 
	g$row
 = 
$dsql
->
GObje
())

38 
$keywds
 = 
exode
(',',
im
(
$row
->
keywds
));

39 
	g$ü
 = 
l
;

40 
	g$mykey
 = '';

41 if(
is_y
(
$keywds
))

43 
fܗch
(
$keywds
 
as
 
$v
)

45 
	g$v
 = 
im
(
$v
);

46 if(
	g$v
=='')

50 if(
ist
(
$ws
[
$v
]))

52 
	g$mykey
 .
$v
." ";

54 if(
ist
(
$wew
[
$v
]))

56 
	g$mykey
 .
$v
.' ';

57 
	g$wew
[
$v
]++;

59 if(
ist
(
$w
[
$v
]))

61 
	g$ü
 = 
ue
;

65 
	g$mykey
 .
$v
." ";

66 
	g$wew
[
$v
] = 1;

71 
	gecho
 "完成档案数据库的处理！<br/>\r\n";

72 
ush
();

73 if(
is_y
(
$wew
))

75 
	gecho
 "对关键字进行排序...<br/>\r\n";

76 
ush
();

77 
st
(
$wew
);

78 
	gecho
 "把关键字保存到数据库...<br/>\r\n";

79 
ush
();

80 
fܗch
(
$wew
 
as
 
$k
=>
$v
)

82 if(

(
$k
)>20)

86 
	g$dsql
->
SQuy
("In I`#@__keywds`(keywd,nk,a,uVues('".
addashes
(
$k
)."','$v','1','')");

87 
	g$dsql
->
Execu
();

89 
	gecho
 "完成关键字的导入！<br/>\r\n";

90 
ush
();

91 
p
(1);

95 
	gecho
 "没发现任何新的关键字！<br/>\r\n";

96 
ush
();

97 
p
(1);

99 
ShowMsg
('完成所有操作，现在转到关键字列表页！','article_keywords_main.php');

100 
ex
();

103 if(
	g$do
=='fetch')

105 
que_
(
DEDEINC
."/splitword.class.php");

106 if(
emy
(
$tdd
))

108 
	g$tdd
 = 0;

110 if(
emy
(
$gesize
))

112 
	g$gesize
 = 20;

114 if(
emy
(
$tٮnum
))

116 
	g$tٮnum
 = 0;

120 if(
	g$tٮnum
==0)

122 
$row
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__archives` where channel='1' ");

123 
	g$tٮnum
 = 
$row
['dd'];

127 if(
	g$tٮnum
 > 
	g$tdd
+
	g$gesize
)

129 
	g$limSql
 = "imit $startdd,$pagesize";

131 if((
	g$tٮnum
-
	g$tdd
)>0)

133 
	g$limSql
 = "im $tdd,".(
$tٮnum
 - 
$tdd
);

137 
	g$limSql
 = '';

139 
	g$tjnum
 = 
$tdd
;

140 if(
	g$limSql
!='')

142 
$fquy
 = "Selectrc.id,arc.title,arc.keywords,addon.body From `#@__archives`rc

143 

 
jo
 `#@
__addڬtie
` 
add
 

dd.
aid
=
c
.
id
 
whe
rc.
chl
='1' 
$limSql
 ";

144 
$dsql
->
SQuy
(
$fquy
);

145 
	g$dsql
->
Execu
();

146 
	g$
 = 
w
 
SWd
();

147 
	g$row
=
$dsql
->
GObje
())

149 if(
$row
->
keywds
!='')

153 
	g$tjnum
++;

154 
	g$id
 = 
$row
->
id
;

155 
	g$keywds
 = "";

156 if(
	g$cfg_so_ng
 == 'utf-8')

158 
$row
->
t
 = 
utf82gb
($row->title);

159 
	g$row
->
	gbody
 = 
utf82gb
(
$row
->
body
);

161 
	g$t˚dexs
 = 
exode
(' ',
im
(
$
->
GIndexText
(
$row
->
t
)));

162 
	g$ldexs
 = 
exode
(' ',
im
(
$
->
GIndexText
(
Html2Text
(
$row
->
body
),500)));

163 if(
is_y
(
$ldexs
&& is_y(
$t˚dexs
))

165 
fܗch
(
$t˚dexs
 
as
 
$k
)

167 if(

(
$keywds
)>=30)

173 
	g$keywds
 .
$k
.",";

176 
fܗch
(
$ldexs
 
as
 
$k
)

178 if(

(
$keywds
)>=30)

182 if(!
_y
(
$k
,
$t˚dexs
))

184 
	g$keywds
 .
$k
.",";

188 
	g$keywds
 = 
addashes
(
$keywds
);

189 if(
	g$keywds
=='')

191 
$keywds
 = ',';

193 
	g$dsql
->
ExecuNeQuy
("update `#@__archives` set keywords='$keywords' where id='$id'");

195 
	g$
->
Cˬ
();

196 
unt
(
$
);

200 if(
	g$tٮnum
>0)

202 
	g$tjn
 = 

(
$tjnum
/
$tٮnum
) * 100 );

206 
	g$tjn
=100;

209 
	g$dvn
 = 
$tjn
 * 2;

210 
	g$tja
 = "<div style='width:200;height:15;border:1px solid #898989;text-align:left'><div style='width:$dvlen;height:15;background-color:#829D83'></div></div>";

211 
	g$tja
 .= "<br/>完成处理文档总数的：$tjlen %，位置：{$startdd}，继续执行任务...";

213 if(
	g$tjnum
 < 
	g$tٮnum
)

215 
	g$nu
 = "tie_keywds_make.php?do=tch&tٮnum=$tٮnum&tdd=".(
$tdd
+
$gesize
)."&pagesize=$pagesize";

216 
ShowMsg
(
$tja
,
$nu
,0,500);

220 
ShowMsg
("完成所有任务！","javascript:;");

222 
ex
();

225 
ude
 
DedeInude
('templets/article_keywords_make.htm');

	@dede/article_keywords_select.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 if(
	$emy
(
$keywds
))

8 
$keywds
 = "";

9 
	}
}

11 
	g$sql
 = "Select * from #@__keywords order byank desc";

12 
	g$dli
 = 
w
 
DaLiCP
();

13 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/article_keywords_select.htm");

14 
	g$dli
->
	ggeSize
 = 300;

15 
	g$dli
->
SPam
("f",
$f
);

16 
	g$dli
->
SSour
(
$sql
);

17 
	g$dli
->
Diy
();

19 
funi
 
	$GS
(
$a
)

21 if(
$a
==1)

29 
	}
}

31 
funi
 
	$GM
(
$a
)

33 if(
$a
==1)

41 
	}
}

	@dede/article_select_sw.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
hd
("Pragma:no-cache");

4 
hd
("Cache-Control:no-cache");

5 
hd
("Expires:0");

8 if(
	g$t
=='source')

10 
$m_fe
 = 
DEDEDATA
."/admin/source.txt";

11 
	g$lsours
 = 
fe
(
$m_fe
);

12 
	gecho
 "<div class='coolbg4'>[<a href=\"javascript:OpenMyWin('article_source_edit.php');ClearDivCt('mysource');\">设置</a>]&nbsp;";

13 
	gecho
 "[<a href='#' onclick='javascript:HideObj(\"mysource\");ChangeFullDiv(\"hide\");'>关闭</a>]</div>\r\n<div class='wsselect'>\r\n";

14 
fܗch
(
$lsours
 
as
 
$v
)

16 
	g$v
 = 
im
(
$v
);

17 if(
	g$v
!="")

19 
echo
 "<a href='#' onclick='javascript:PutSource(\"$v\")'>$v</a> | \r\n";

22 
	gecho
 "</div><div class='coolbg5'>&nbsp;</div>";

27 
	g$m_fe
 = 
DEDEDATA
."/admin/writer.txt";

28 
	gecho
 "<div class='coolbg4'>[<a href=\"javascript:OpenMyWin('article_writer_edit.php');ClearDivCt('mywriter');\">设置</a>]&nbsp;";

29 
	gecho
 "[<a href='#' onclick='javascript:HideObj(\"mywriter\");ChangeFullDiv(\"hide\");'>关闭</a>]</div>\r\n<div class='wsselect'>\r\n";

30 if(
fesize
(
$m_fe
)>0)

32 
	g$
 = 
fݒ
(
$m_fe
,'r');

33 
	g$r
 = 
d
(
$
,
fesize
(
$m_fe
));

34 
fo
(
$
);

35 
	g$rs
 = 
exode
(',',
$r
);

36 
fܗch
(
$rs
 
as
 
$r
)

38 
	g$r
 = 
im
(
$r
);

39 if(
	g$r
!="")

41 
echo
 "<a href='#' onclick='javascript:PutWriter(\"$str\")'>$str</a> | ";

45 
	gecho
 "</div><div class='coolbg5'>&nbsp;</div>\r\n";

	@dede/article_source_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/oxwindow.class.php");

4 
CheckPurvw
('sys_Source');

5 if(
	$emy
(
$do
))

7 
$do
 = '';

8 
	}
}

9 if(
	$emy
(
$lsour
))

11 
$lsour
 = '';

12 
	}
}

15 
	g$lsour
 = 
rashes
(
$lsour
);

17 
	g$m_fe
 = 
DEDEDATA
."/admin/source.txt";

20 if(
	g$do
=='save')

22 
$
 = 
fݒ
(
$m_fe
,'w');

23 
ock
(
$
,3);

24 
fwre
(
$
,
$lsour
);

25 
fo
(
$
);

26 
	gecho
 "<script>alert('Save OK!');</script>";

29 if(
emy
(
$lsour
&& 
fesize
(
$m_fe
)>0)

31 
	g$
 = 
fݒ
(
$m_fe
,'r');

32 
	g$lsour
 = 
d
(
$
,
fesize
(
$m_fe
));

33 
fo
(
$
);

35 
	g$wt
 = "文章来源管理";

36 
	g$wecome_fo
 = "文章来源管理";

37 
	g$w
 = 
w
 
OxWdow
();

38 
	g$w
->
In
('article_source_edit.php','js/blank.js','POST');

39 
	g$w
->
AddHidd
('dopost','save');

40 
	g$w
->
AddT
("每行保存一个来源：");

41 
	g$w
->
AddMsgIm
("<textareaame='allsource' id='allsource' style='width:100%;height:300px'>$allsource</textarea>");

42 
	g$wfm
 = 
$w
->
GWdow
('ok');

43 
	g$w
->
Diy
();

	@dede/article_string_mix.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/oxwindow.class.php');

4 
CheckPurvw
('sys_StringMix');

5 if(
	$emy
(
$do
))

7 
$do
 = '';

8 
	}
}

9 if(
	$emy
(
$lsour
))

11 
$lsour
 = '';

12 
	}
}

15 
	g$lsour
 = 
rashes
(
$lsour
);

17 
	g$m_fe
 = 
DEDEDATA
."/downmix.data.php";

20 if(
	g$do
=="save")

22 
$
 = 
fݒ
(
$m_fe
,'w');

23 
ock
(
$
,3);

24 
fwre
(
$
,
$lsour
);

25 
fo
(
$
);

26 
	gecho
 "<script>alert('Save OK!');</script>";

30 if(
emy
(
$lsour
&& 
fesize
(
$m_fe
)>0)

32 
	g$
 = 
fݒ
(
$m_fe
,'r');

33 
	g$lsour
 = 
d
(
$
,
fesize
(
$m_fe
));

34 
fo
(
$
);

36 
	g$wt
 = "防采集混淆字符串管理";

37 
	g$wecome_fo
 = "防采集混淆字符串管理";

38 
	g$w
 = 
w
 
OxWdow
();

39 
	g$w
->
In
('article_string_mix.php','js/blank.js','POST');

40 
	g$w
->
AddHidd
('dopost','save');

41 
	g$w
->
AddT
("如果你要启用字符串混淆来防采集，请在文档模板需要的字段加上 function='RndString(@me)' 属性，如：{dede:fieldame='body' function='RndString(@me)'/}。");

42 
	g$w
->
AddMsgIm
("<textareaame='allsource' id='allsource' style='width:100%;height:300px'>$allsource</textarea>");

43 
	g$wfm
 = 
$w
->
GWdow
('ok');

44 
	g$w
->
Diy
();

	@dede/article_template_rand.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/oxwindow.class.php');

4 
CheckPurvw
('sys_StringMix');

5 if(
emy
(
$do
)
	g$do
 = '';

6 
	g$mes
 = 
emy
(
$mes
? '' : 
rashes
($templates);

7 
	g$m_fe
 = 
DEDEDATA
.'/template.rand.php';

10 
	g$okmsg
 = '';

12 if(
	g$do
=='save')

14 
$
 = 
fݒ
(
$m_fe
,'w');

15 
ock
(
$
,3);

16 
fwre
(
$
,
$mes
);

17 
fo
(
$
);

18 
	g$okmsg
 = '成功保存配置信息 AT:('.
MyDe
('H:i:s', 
time
()).')';

21 if(
	g$do
=='makeold')

23 
t_time_lim
(3600);

24 if(!
fe_exis
(
$m_fe
))

26 
AjaxHd
();

27 
	gecho
 "配置文件不存在！";

28 
ex
();

30 
que_
(
$m_fe
);

31 if(
	g$cfg_me_nd
==0)

33 
AjaxHd
();

34 
	gecho
 "系统没开启允许随机模板的选项！";

35 
ex
();

37 
	g$tٮTmp
 = 
cou
(
$cfg_me_r
) - 1;

38 if
	g$tٮTmp
 < 1 )

40 
AjaxHd
();

41 
	gecho
 "随机模板的数量必须为2个或以上！";

42 
ex
();

44 
	g$i
=0; $i < 10; $i++)

46 
	g$mp
 = 
$cfg_me_r
[
mt_nd
(0, 
$tٮTmp
)];

47 
	g$dsql
->
ExecuNeQuy
(" Update `#@__addonarticle` setemplet='$temp' where RIGHT(aid, 1)='$i' ");

49 
AjaxHd
();

50 
	gecho
 "全部随机操作成功！";

51 
ex
();

54 if(
	g$do
=='clearold')

56 
$dsql
->
ExecuNeQuy
(" Update `#@__addonarticle` setemplet='' ");

57 
	g$dsql
->
ExecuNeQuy
(" OPTIMIZE TABLE `#@__addonarticle` ");

58 
AjaxHd
();

59 
	gecho
 "全部清除操作成功！";

60 
ex
();

65 if(
emy
(
$mes
&& 
fesize
(
$m_fe
)>0)

67 
	g$
 = 
fݒ
(
$m_fe
,'r');

68 
	g$mes
 = 
d
(
$
,
fesize
(
$m_fe
));

69 
fo
(
$
);

71 
	g$wt
 = "随机模板防采集设置";

72 
	g$wecome_fo
 = "随机模板防采集设置";

74 
	g$msg
 = "

75 <
lk
 
hf
='img/ba.css' 
l
='ysht' 
ty
='text/css' />

76 <
st
 
nguage
='javast' 
c
='js/main.js'></script>

77 <
st
 
nguage
='javast' 
c
='../include/dedeajax2.js'></script>

78 <
st
 
nguage
='javascript'>

79 
funi
 
	$DoRd
(
jobme
)

81 
	`ChgeFuDiv
('show');

82 \
	`$DE
('ldg').
y
.
diy
 = 'block';

83 
v
 
myajax
 = 
w
 
	`DedeAjax
(\
	`$DE
('tmpct'));

84 
myajax
.
	`SdG2
('tie_me_nd.php?do='+
jobme
);

85 \
	`$DE
('ldg').
y
.
diy
 = 'none';

86 
	`ChgeFuDiv
('hide');

87 
	}
}

88 </
	gst
>

89 <
div
 
	gid
='ldg' 
y
='z-index:3000;top:160;left:300;position:absolute;display:none;'>

90 <
img
 
c
='img/loadinglit.gif' /> 请稍后，正在操作中...

91 </
div
>

92 <
b
 
width
='98%' 
ign
='center'>

93 <

>

94 <
td
 
height
='28'>

96 &
nb
; <
a
 
	ghf
='#' 
ick
='DoRd(\"maked\")'>[<
u
>设置全部</u>]</a>

97 &
nb
; <
a
 
	ghf
='#' 
ick
='DoRd(\"rd\")'>[<
u
>取消全部</u>]</a>

98 &
nb
; <

 
	gid
='tmp' 
y
='c:d;ft-weight:bd'>
$okmsg
</span>

99 </
td
>

100 </

>

101 <

>

102 <
td
 
bgc
='#F1F9D7'><
b
>请按说明修改设置：</b></td>

103 </

>

104 <

>

105 <
td
><
xa
 
me
='mes' 
id
='mes' 
y
='width:100%;height:250px'>
$mes
</textarea></td>

106 </

>

107 </
b
>";

109 
$w
 = 
w
 
OxWdow
();

110 
	g$w
->
In
('article_template_rand.php','js/blank.js','POST');

111 
	g$w
->
AddHidd
('dopost','save');

112 
	g$w
->
AddT
("本设置仅适用于系统默认的文章模型，设置后发布文章时会自动按指定的模板随机获取一个，如果不想使用此功能，把它设置为空即可！");

113 
	g$w
->
AddMsgIm
(
$msg
);

114 
	g$wfm
 = 
$w
->
GWdow
('ok');

115 
	g$w
->
Diy
();

	@dede/article_test_same.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 @
t_time_lim
(0);

4 
CheckPurvw
('sys_ArcBatch');

5 if(
emy
(
$do
)
	g$do
 = '';

6 if(
	g$do
=='analyse')

8 
$r
 = 
$dsql
->
ge
("select maintable from `#@__channeltype` where id='$channelid' ");

9 if(
is_y
(
$r
)) {

10 
	g$mab
 = 
$r
['maintable'];

12 
showmsg
('频道id不正确，无法处理！','javascript:;');

13 
ex
();

15 
	g$dsql
->
SQuy
("Select count(title)s dd,title From `$maintable` where channel='$channelid' group byitle order by dd descimit 0, $pagesize");

16 
	g$dsql
->
Execu
();

17 
	g$rc
 = 0;

18 
ude
 
DedeInude
('templets/article_result_same.htm');

19 
ex
();

22 if(
	g$do
=='delsel')

24 
que_
(
dme
(
__FILE__
)."/../include/typelink.class.php");

25 
que_
(
dme
(
__FILE__
)."/inc/inc_batchup.php");

27 if(
emy
(
$ts
))

29 
hd
("Content-Type:ext/html; charset={$cfg_ver_lang}");

30 
	gecho
 "<meta http-equiv=\"Content-Type\" content=\"text/html; charset={$cfg_ver_lang}\">\r\n";

31 
	gecho
 "没有指定删除的文档！";

32 
ex
();

35 
	g$tss
 = 
l
('`',
$ts
);

37 if(
	g$chlid
 < -1) {

38 
	g$dby
 = (
$dty
=='delnew' ? " order byid desc " : " order byidsc ");

41 
	g$dby
 = (
$dty
=='delnew' ? " order by id desc " : " order by idsc ");

44 
	g$tٮc
 = 0;

46 
fܗch
(
$tss
 
as
 
$t
)

48 
	g$t
 = 
im
(
$t
);

49 
	g$t
 = 
addashes

$t
=='' ? '' : 
udecode
($title) );

50 if(
	g$chlid
 < -1) {

51 
	g$q1
 = "Selectids id,title From `$maintable` where channel='$channelid'nditle='$title' $orderby ";

54 
	g$q1
 = "Select id,title From `$maintable` where channel='$channelid'nditle='$title' $orderby ";

56 
	g$dsql
->
SQuy
(
$q1
);

57 
	g$dsql
->
Execu
();

58 
	g$rownum
 = 
$dsql
->
GTٮRow
();

59 if(
	g$rownum
 < 2) ;

60 
	g$i
 = 1;

61 
	g$row
 = 
$dsql
->
GObje
())

63 
$i
++;

64 
	g$id
 = 
$row
->
id
;

65 
	g$
 = 
$row
->
t
;

66 if(
	g$i
 > 
	g$rownum
) ;

67 
	g$tٮc
++;

68 
DArc
(
$id
, 'OFF');

71 
	g$dsql
->
execunequy
(" OPTIMIZE TABLE `$maintable`; ");

72 
ShowMsg
("一共删除了[{$totalarc}]篇重复的文档！","javascript:;");

73 
ex
();

77 
	g$chlfos
 = 
y
();

78 
	g$dsql
->
tquy
("select id,typename,maintable,addtable from `#@__channeltype` ");

79 
	g$dsql
->
execu
();

80 
	g$row
 = 
$dsql
->
gy
()
$chlfos
[] = 
$row
;

82 
ude
 
DedeInude
('templets/article_test_same.htm');

	@dede/article_test_title.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
AjaxHd
();

4 if(
emy
(
$t
|| 
	g$cfg_check_t
=='N')

6 
ex
;

8 
	g$row
 = 
$dsql
->
GO
("Select id From `#@__archives` whereitleike '$t' ");

9 if(
	$is_y
(
$row
))

11 
echo
 "提示：系统已经存在标题为 '<a href='../plus/view.php?aid={$row['id']}' style='color:red'arget='_blank'><u>$t</u></a>' 的文档。[<a href='#' onclick='javascript:HideObj(\"mytitle\")'>关闭</a>]";

12 
	}
}

	@dede/article_writer_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/oxwindow.class.php');

4 
CheckPurvw
('sys_Writer');

5 if(
	$emy
(
$do
))

7 
$do
 = '';

8 
	}
}

9 if(
	$emy
(
$lwr
))

11 
$lwr
 = '';

12 
	}
}

15 
	g$lwr
 = 
rashes
(
$lwr
);

17 
	g$m_fe
 = 
DEDEDATA
."/admin/writer.txt";

20 if(
	g$do
=="save")

22 
$
 = 
fݒ
(
$m_fe
,'w');

23 
ock
(
$
,3);

24 
fwre
(
$
,
$lwr
);

25 
fo
(
$
);

26 
	gecho
 "<script>alert('Save OK!');</script>";

30 if(
emy
(
$lwr
&& 
fesize
(
$m_fe
)>0)

32 
	g$
 = 
fݒ
(
$m_fe
,'r');

33 
	g$lwr
 = 
d
(
$
,
fesize
(
$m_fe
));

34 
fo
(
$
);

36 
	g$wt
 = "文章作者管理";

37 
	g$wecome_fo
 = "文章作者管理";

38 
	g$w
 = 
w
 
OxWdow
();

39 
	g$w
->
In
('article_writer_edit.php','js/blank.js','POST');

40 
	g$w
->
AddHidd
('dopost','save');

41 
	g$w
->
AddT
("把作者姓名用半角逗号“,”分开：");

42 
	g$w
->
AddMsgIm
("<textareaame='allwriter' id='allwriter' style='width:100%;height:300px'>$allwriter</textarea>");

43 
	g$wfm
 = 
$w
->
GWdow
('ok');

44 
	g$w
->
Diy
();

	@dede/baidunews.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

4 if(
	$emy
(
$do
))

6 
ude
 
DEDEADMIN
.'/templets/baidunews.htm';

7 
	}

	g}


9 
	g$baiduws
 = "<?xmvsi=\"1.0\"ncodg=\"".
$cfg_so_ng
."\" ?>\n";

10 
	g$baiduws
 .= "<document>\n";

11 
	g$baiduws
 .= "<webSite>$cfg_webname </webSite>\n";

12 
	g$baiduws
 .= "<webMaster>$cfg_adminemail </webMaster>\n";

13 
	g$baiduws
 .= "<updatePeri>$cfg_updateperi </updatePeri>\n";

15 
	g$lim
 = 
$cfg_baiduws_lim
;

16 if(
	g$lim
 > 100 || $limit < 1)

18 
	g$lim
 = 100;

21 
	g$quy
 = "select maintable.*,ddtable.body,rctype.typename

22 
om
 #@
__chives
 
mab


23 

 
jo
 #@
__addڬtie
 
addb
 

ddb.
aid
=
mab
.
id


24 

 
jo
 #@
__y
 
y
 

ry.
ID
=
mab
.
tyid


25 
whe
 
mab
.
chl
=1 
d
 mab.
k
!=-1 
d
 
by
 mab.
pubde
 
desc
 
lim
 
$lim


27 
$dsql
->
SQuy
(
$quy
);

28 
	g$dsql
->
Execu
();

29 
	g$row
 = 
$dsql
->
GAay
())

31 
$t
 = 
htmleclchs
(
$row
['title']);

32 
	g$row1
 = 
GOArchive
(
$row
['id']);

33 if(
os
(
$row1
['cu'],'hp://'==
l
)

35 
$lk
 = (
$cfg_baho
=='' ? 'hp://'.
$_SERVER
["HTTP_HOST"].
$cfg_cmh
 : $cfg_baho).
$row1
['arcurl'];

38 
	g$lk
 = 
$row1
['arcurl'];

40 
	g$lk
 = 
htmleclchs
(
$lk
);

41 
	g$desti
 = 
htmleclchs
(
r_gs
(
$row
['description']));

42 
	g$xt
 = 
htmleclchs
(
r_gs
(
$row
['body']));

43 
	g$image
 = 
$row
['litpic'] =='' ? '' :$row['litpic'];

44 if(
	g$image
 !'' && 
os
(
$image
, 'hp://'==
l
)

46 
$image
 = (
$cfg_baho
=='' ? 'hp://'.
$_SERVER
["HTTP_HOST"].
$cfg_cmh
 : $cfg_basehost).$image;

50 
	g$keywds
 = 
htmleclchs
(
$row
['keywords']);

51 
	g$gy
 = 
htmleclchs
(
$row
['typename']);

52 
	g$auth
 = 
htmleclchs
(
$row
['writer']);

53 
	g$sour
 = 
htmleclchs
(
$row
['source']);

54 
	g$pubde
 = 
htmleclchs
(
gmde
('Y-m-d H:i',
$row
['pubde'] + 
$cfg_i_time
 * 3600));

56 
	g$baiduws
 .= "<item>\n";

57 
	g$baiduws
 .= "<title>$title </title>\n";

58 
	g$baiduws
 .= "<link>$link </link>\n";

59 
	g$baiduws
 .= "<description>$description </description>\n";

60 
	g$baiduws
 .= "<text>$text </text>\n";

61 
	g$baiduws
 .= "<image>$image </image>\n";

63 
	g$baiduws
 .= "<keywords>$keywords </keywords>\n";

64 
	g$baiduws
 .= "<category>$category </category>\n";

65 
	g$baiduws
 .= "<author>$author </author>\n";

66 
	g$baiduws
 .= "<source>$source </source>\n";

67 
	g$baiduws
 .= "<pubDate>$pubdate </pubDate>\n";

68 
	g$baiduws
 .= "</item>\n";

70 
	g$baiduws
 .= "</document>\n";

72 
	g$
 = 
fݒ
(
dme
(
__FILE__
).'/'.
$fame
,'w');

73 
fwre
(
$
,
$baiduws
);

74 
fo
(
$
);

75 
showmsg
("<a href='{$filename}'arget=\"_blank\">{$filename} make success</a>",'javascript:;');

	@dede/cards_make.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Card');

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

9 if(
	g$do
 == '')

11 
ude
(
DEDEADMIN
."/templets/cards_make.htm");

15 
if
(
$do
 == 'make')

17 
$row
 = 
$dsql
->
GO
("Select * From #@__moneycard_record order byid desc");

18 !
is_y
(
$row
? 
	g$tid
=100000 : 
$tid
=$row['aid']+100000;

19 
	g$row
 = 
$dsql
->
GO
("Select * From #@__moneycard_type whereid='$cardtype'");

20 
	g$mey
 = 
$row
['money'];

21 
	g$num
 = 
$row
['num'];

22 
	g$mtime
 = 
time
();

23 
	g$utime
 = 0;

24 
	g$id
 = 
$rdty
;

25 
	g$tid
++;

26 
	g$did
 = 
$tid
+
$mnum
;

28 
hd
("Content-Type:ext/html; charset={$cfg_soft_lang}");

30 ;
	g$tid
<
	g$did
;$startid++)

32 
	g$rdid
 = 
$efix
.
$tid
.'-';

33 
	g$p
=0;$p<
	g$pwdgr
;$p++)

35 
	g$i
=0; $< 
	g$pwdn
; $i++)

37 if(
	g$y
==1)

39 
$c
 = 
mt_nd
(49,57); 
	g$c
 = 
chr
($c);

43 
	g$c
 = 
mt_nd
(65,90);

44 if(
	g$c
==79)

46 
$c
 = 'M';

50 
	g$c
 = 
chr
(
$c
);

53 
	g$rdid
 .
$c
;

55 if(
	g$p
<
	g$pwdgr
-1)

57 
	g$rdid
 .= '-';

60 
	g$quy
 = "Insert into #@__moneycard_record(ctid,cardid,uid,isexp,mtime,utime,money,num)

61 
Vues
('$ctid','$cardid','0','0','$mtime','$utime','$money','$num'); ";

62 
	g$dsql
->
ExecuNeQuy
(
$quy
);

63 
	gecho
 "成功生成点卡：{$cardid}<br/>";

65 
	gecho
 "成功生成 {$mnum} 个点卡！";

	@dede/cards_manage.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
.'/datalistcp.class.php');

5 
	g$addsql
 = '';

6 if(
	$ist
(
$ixp
))

8 
$addsql
 = " where isexp='$isexp' ";

9 
	}
}

10 
	g$sql
 = "Select * From #@__moneycard_record $addsql order byid desc";

11 
	g$dli
 = 
w
 
DaLiCP
();

12 
	g$dli
->
	ggeSize
 = 25;

13 if(
	$ist
(
$ixp
))

15 
$dli
->
	`SPam
("ixp",
$ixp
);

16 
	}
}

17 
	g$dli
->
	gdsql
->
SQuy
("Select * From #@__moneycard_type ");

18 
	g$dli
->
	gdsql
->
Execu
('ts');

19 
	g$rw
 = 
$dli
->
dsql
->
GAay
('ts'))

21 
$TyNames
[
$rw
['tid']] = $rw['pname'];

23 
	g$lfe
 = 
DEDEADMIN
."/templets/cards_manmage.htm";

26 
	g$dli
->
STeme
(
$lfe
);

27 
	g$dli
->
SSour
(
$sql
);

28 
	g$dli
->
Diy
();

30 
funi
 
	$GMembID
(
$mid
)

32 
glob
 
$dsql
;

33 if(
$mid
==0)  '0';

34 
$row
 = 
$dsql
->
	`GO
("Select userid From #@__member where mid='$mid' ");

35 if(
	`is_y
(
$row
))  "<a href='member_view.php?mid={$mid}'>".$row['userid']."</a>";

37 
	}
}

38 
funi
 
	$GUDe
(
$time
=0)

40 if(!
	`emy
(
$time
))

42  
	`GDeMk
(
$time
);

46 
	}
}

47 
funi
 
	$GS
(
$a
)

49 if(
$a
==1)  '已售出';

50 if(
$a
==-1)  '已使用';

52 
	}
}

	@dede/cards_type.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('member_Type');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

10 if(
	g$do
=="save")

12 
$tID
 = 1;

13 
	g$dID
 = 
$idd
;

14 ;
	g$tID
<=
$dID
;$startID++)

16 
	g$quy
 = '';

17 
	g$tid
 = 
$
{'ID_'.
$tID
};

18 
	g$ame
 = 
$
{'ame_'.
$tID
};

19 
	g$mey
 = 
$
{'mey_'.
$tID
};

20 
	g$num
 = 
$
{'num_'.
$tID
};

21 if(
ist
(
$
{'check_'.
$tID
}))

23 if(
	g$ame
!='')

25 
$quy
 = "update #@__moneycard_type setname='$pname',money='$money',num='$num' whereid='$tid'";

26 
	g$dsql
->
ExecuNeQuy
(
$quy
);

27 
	g$quy
 = "update #@__moneycard_record set money='$money',num='$num' where ctid='$tid' ; ";

28 
	g$dsql
->
ExecuNeQuy
(
$quy
);

33 
	g$quy
 = "Delete From #@__moneycard_type whereid='$tid' ";

34 
	g$dsql
->
ExecuNeQuy
(
$quy
);

35 
	g$quy
 = "Delete From #@__moneycard_record where ctid='$tid' And isexp<>-1 ; ";

36 
	g$dsql
->
ExecuNeQuy
(
$quy
);

41 if(
ist
(
$check_w
&& 
	g$ame_w
!='')

43 
$quy
 = "Insert Into #@__moneycard_type(num,pname,money) Values('{$num_new}','{$pname_new}','{$money_new}');";

44 
	g$dsql
->
ExecuNeQuy
(
$quy
);

46 
hd
("Content-Type:ext/html; charset={$cfg_soft_lang}");

47 
	gecho
 "<script>lert('成功更新点卡产品分类表！'); </script>";

50 
que_
(
DEDEADMIN
."/templets/cards_type.htm");

	@dede/catalog_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/typelink.class.php");

5 if(
	$emy
(
$lity
))

7 
$lity
='';

8 
	}
}

9 if(
	$emy
(
$do
))

11 
$do
 = '';

12 
	}
}

13 if(
	$emy
(
$upy
))

15 
$upy
 = 0;

16 
	}
}

17 if(
	$emy
(
$chlid
))

19 
$chlid
 = 1;

20 
	}
}

21 if(
	$ist
(
$chy
))

23 
$chlid
 = 
$chy
;

24 
	}
}

25 
	g$id
 = 
emy
(
$id
? 0 :
tv
($id);

26 
	g$id
 = 
emy
(
$id
? 0 :
tv
($reid);

27 
	g$nid
 = 'article';

29 if(
	g$id
==0 && 
$id
==0)

31 
CheckPurvw
('t_New');

35 
	g$checkID
 = 
emy
(
$id
? 
$id
 : $id;

36 
CheckPurvw
('t_AccNew');

37 
CheckCog
(
$checkID
, '你无权在本栏目下创建子类！');

40 if(
	$emy
(
$myrow
))

42 
$myrow
 = 
	`y
();

43 
	}
}

44 
	g$dsql
->
SQuy
("select id,typename,nid from `#@__channeltype` where id<>-1 And isshow=1 order by id");

45 
	g$dsql
->
Execu
();

46 
	g$row
=
$dsql
->
	$GObje
())

48 
$chlAay
[
$row
->
id
]['tyme'] = $row->
tyme
;

49 
$chlAay
[
$row
->
id
]['nid'] = $row->
nid
;

50 if(
$row
->
id
==
$chlid
)

52 
$nid
 = 
$row
->
nid
;

54 
	}
}

55 if(
	g$do
=='quick')

57 
ude
 
DedeInude
('templets/catalog_add_quick.htm');

58 
ex
();

63 if(
	g$do
=='savequick')

65 
$mpdex
 = "{style}/index_{$nid}.htm";

66 
	g$mi
 = "{style}/list_{$nid}.htm";

67 
	g$mie
 = "{style}/article_{$nid}.htm";

68 
	g$quyTeme
 = "insert into `#@__arctype`(reid,topid,sortrank,typename,typedir,isdefault,defaultname,issend,channeltype,

69 
mpdex
,
	gmi
,
	gmie
,
	gmodme
,
	gmu
,
	gmu2
,
	git
,
	gcܪk
,
	gdesti
,
	gkeywds
,
	gٙ
,
	gmese
,
	gseu
,
	gsh
,
	gishidd
,`
	goss
`,`
	gossid
`,`
	gcڋ
`,`
	gsmys
`)

70 
Vues
('~reid~','~topid~','~rank~','~typename~','~typedir~','$isdefault','$defaultname','$issend','$channeltype',

72 
fܗch
(
$_POST
 
as
 
$k
=>
$v
)

74 if(
eg
('^poty',
$k
))

76 
$k
 = 
r_a
('posttype','',$k);

82 
	g$nk
 = 
$
{'nk'.
$k
};

83 
	g$ttyme
 = 
im
(
$
{'tty'.
$k
});

84 
	g$sty
 = 
im
(
$
{'sty'.
$k
});

85 
	g$ttyd
 = 
GPy
(
rashes
(
$ttyme
));

86 
	g$ttyd
 = 
$㽩h
=='' ? 
$xtd
.'/'.
$ttyd
 : '/'.$toptypedir;

87 if(
emy
(
$ttyme
))

91 
	g$sql
 = 
r_a
('~id~','0',
$quyTeme
);

92 
	g$sql
 = 
r_a
('~tid~','0',
$sql
);

93 
	g$sql
 = 
r_a
('~nk~',
$nk
,
$sql
);

94 
	g$sql
 = 
r_a
('~tyme~',
$ttyme
,
$sql
);

95 
	g$sql
 = 
r_a
('~tyd~',
$ttyd
,
$sql
);

96 
	g$dsql
->
ExecuNeQuy
(
$sql
);

97 
	g$tid
 = 
$dsql
->
GLaID
();

98 if(
	g$tid
>0 && 
	g$sty
!='')

100 
$stys
 = 
exode
(',',
$sty
);

101 
fܗch
(
$stys
 
as
 
$k
=>
$v
)

103 
$v
 = 
im
($v);

104 if(
	g$v
=='')

108 
	g$tyd
 = 
$ttyd
.'/'.
GPy
(
rashes
(
$v
));

109 
	g$sql
 = 
r_a
('~id~',
$tid
,
$quyTeme
);

110 
	g$sql
 = 
r_a
('~tid~',
$tid
,
$sql
);

111 
	g$sql
 = 
r_a
('~nk~',
$k
,
$sql
);

112 
	g$sql
 = 
r_a
('~tyme~',
$v
,
$sql
);

113 
	g$sql
 = 
r_a
('~tyd~',
$tyd
,
$sql
);

114 
	g$dsql
->
ExecuNeQuy
(
$sql
);

118 
UpDeCCache
();

119 
ShowMsg
('成功增加指定栏目！','catalog_main.php');

120 
ex
();

125 if(
	g$do
=='save')

127 
$smys
 = '';

128 if(
emy
(
$smy
)
	g$smy
 = '';

129 if(
is_y
(
$smy
)
	g$smys
 = 
jo
(',',$smalltype);

131 if(!
ist
(
$sh
)
	g$sh
 = '';

133 if(
	g$tid
==0 && 
$id
>0
$tid
 = $reid;

135 if(
	g$it
!=0
$oss
 = 0;

137 
	g$desti
 = 
Html2Text
(
$desti
,1);

138 
	g$keywds
 = 
Html2Text
(
$keywds
,1);

140 if(
	g$it
 != 2 )

143 if(
$㽩h
=='cmh'
$xtd
 = '{cmspath}';

144 if(
	g$㽩h
=='bath'
$xtd
 = '';

146 if(
	g$upy
==1 || 
$tyd
=='')

148 
$tyd
 = 
GPy
(
rashes
(
$tyme
));

150 
	g$tyd
 = 
$xtd
.'/'.
$tyd
;

151 
	g$tyd
 = 
eg_a
("/{1,}", "/", 
$tyd
);

155 if(
	g$id
==0 && 
$mese
==1)

157 
$sh
 = 
$tyd
;

160 if(
	g$seu
!='')

162 
$seu
 = 
eg_a
("/$","",$siteurl);

163 if(!
egi
("hp://",
$seu
))

165 
ShowMsg
("你绑定的二级域名无效，请用(http://host)的形式！","-1");

166 
ex
();

168 if(
egi
(
$cfg_baho
,
$seu
))

170 
ShowMsg
("你绑定的二级域名与当前站点是同一个域，不需要绑定！","-1");

171 
ex
();

177 if(
	g$it
 != 2)

179 
$ue_tyd
 = 
r_a
("{cmh}",
$cfg_cmh
,
$tyd
);

180 
	g$ue_tyd
 = 
eg_a
("/{1,}","/",
$ue_tyd
);

181 if(!
CeD
(
$ue_tyd
))

183 
ShowMsg
("创建目录 {$true_typedir} 失败，请检查你的路径是否存在问题！","-1");

184 
ex
();

188 
	g$_quy
 = "insert into `#@__arctype`(reid,topid,sortrank,typename,typedir,isdefault,defaultname,issend,channeltype,

189 
mpdex
,
	gmi
,
	gmie
,
	gmodme
,
	gmu
,
	gmu2
,

190 
	git
,
	gcܪk
,
	gdesti
,
	gkeywds
,
	gٙ
,
	gmese
,
	gseu
,
	gsh
,
	gishidd
,`
	goss
`,`
	gossid
`,`
	gcڋ
`,`
	gsmys
`)

191 
Vues
('$reid','$topid','$sortrank','$typename','$typedir','$isdefault','$defaultname','$issend','$channeltype',

195 if(!
	g$dsql
->
ExecuNeQuy
(
$_quy
))

197 
ShowMsg
("保存目录数据时失败，请检查你的输入资料是否存在问题！","-1");

198 
ex
();

200 
UpDeCCache
();

201 if(
	g$id
>0)

203 
PutCook
('ϡCid',
GTid
(
$id
),3600*24,'/');

205 
ShowMsg
("成功创建一个分类！","catalog_main.php");

206 
ex
();

212 if(
	g$do
=='')

214 
$chlid
 = 1;

215 
	g$isnd
 = 1;

216 
	g$cܪk
 = 0;

217 
	g$id
 = 0;

218 
	g$tid
 = 0;

219 
	g$tyd
 = '';

220 
	g$mese
 = 0;

221 if(
	g$id
>0)

223 
	g$myrow
 = 
$dsql
->
GO
(" Selectp.*,ch.typenames ctypename From `#@__arctype`peft join `#@__channeltype` ch on ch.id=tp.channeltype wherep.id=$id ");

224 
	g$chlid
 = 
$myrow
['channeltype'];

225 
	g$isd
 = 
$myrow
['issend'];

226 
	g$cܪk
 = 
$myrow
['corank'];

227 
	g$tid
 = 
$myrow
['topid'];

228 
	g$tyd
 = 
$myrow
['typedir'];

232 
	g$mese
 = 
emy
(
$myrow
['moresite']) ? 0 : $myrow['moresite'];

235 
ude
 
DedeInude
('templets/catalog_add.htm');

	@dede/catalog_del.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

5 
CheckPurvw
('t_Del,t_AccDel');

6 
que_
(
DEDEINC
.'/typeunit.class.admin.php');

7 
que_
(
DEDEINC
.'/oxwindow.class.php');

8 
	g$id
 = 
im
(
eg_a
('[^0-9]','',
$id
));

11 
CheckCog
(
$id
,"你无权删除本栏目！");

12 if(
	$emy
(
$do
))

14 
$do
='';

15 
	}
}

16 if(
	g$do
=='ok')

18 
$ut
 = 
w
 
TyUn
();

19 
	g$ut
->
DTy
(
$id
,
$dfe
);

20 
UpDeCCache
();

21 
ShowMsg
("成功删除一个栏目！","catalog_main.php");

22 
ex
();

24 
	g$dsql
->
SQuy
("Seyme,tyd From #@__y whid=".
$id
);

25 
	g$row
 = 
$dsql
->
GO
();

26 
	g$wt
 = "删除栏目确认";

27 
	g$wecome_fo
 = "<a href='catalog_main.php'>栏目管理</a> &gt;&gt; 删除栏目确认";

28 
	g$w
 = 
w
 
OxWdow
();

29 
	g$w
->
In
('catalog_del.php','js/blank.js','POST');

30 
	g$w
->
AddHidd
('id',
$id
);

31 
	g$w
->
AddHidd
('dopost','ok');

32 
	g$w
->
AddT
("你要确实要删除栏目： [{$row['typename']}] 吗？");

33 
	g$w
->
AddIm
('栏目的文件保存目录：',
$row
['typedir']);

34 
	g$w
->
AddIm
('是否删除文件：',"<inputype='radio'ame='delfile' class='np' value='no' checked='1' />否 &nbsp;<inputype='radio'ame='delfile' class='np' value='yes' />是");

35 
	g$wfm
 = 
$w
->
GWdow
('ok');

36 
	g$w
->
Diy
();

	@dede/catalog_do.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 if(
	$emy
(
$do
))

5 
	`ShowMsg
("对不起，请指定栏目参数！","catalog_main.php");

6 
	`ex
();

7 
	}
}

8 
	g$cid
 = 
emy
(
$cid
? 0 : 
tv
($cid);

9 
	g$chlid
 = 
emy
(
$chlid
? 0 : 
tv
($channelid);

15 if(
	g$do
=="addArchives")

18 if(
emy
(
$cid
&&my(
$chlid
))

20 
hd
("location:article_add.php");

21 
ex
();

23 if(!
emy
(
$chlid
))

26 
	g$row
 = 
$dsql
->
GO
("Selectddcon from #@__channeltype where id='$channelid'");

31 
	g$row
 = 
$dsql
->
GO
("Select ch.addcon from `#@__arctype`peft join `#@__channeltype` ch on ch.id=tp.channeltype wherep.id='$cid' ");

33 
	g$gu
 = 
$row
["addcon"];

34 if(
	g$gu
=="")

36 
ShowMsg
("对不起，你指的栏目可能有误！","catalog_main.php");

37 
ex
();

41 
hd
("location:{$gurl}?channelid={$channelid}&cid={$cid}");

42 
ex
();

49 if(
	g$do
=="listArchives")

51 if(!
emy
(
$gu
))

53 if(
emy
(
$k
))

55 
$k
 = '';

57 
	g$gu
 = 
r_a
('..','',
$gu
);

58 
hd
("location:{$gurl}?arcrank={$arcrank}&cid={$cid}");

59 
ex
();

61 if(
	g$cid
>0)

63 
	g$row
 = 
$dsql
->
GO
("Select #@__arctype.typename,#@__channeltype.typenames channelname,#@__channeltype.id,#@__channeltype.mancon from #@__arctypeeft join #@__channeltype on #@__channeltype.id=#@__arctype.channeltype where #@__arctype.id='$cid'");

64 
	g$gu
 = 
$row
["mancon"];

65 
	g$chlid
 = 
$row
["id"];

66 
	g$tyme
 = 
$row
["typename"];

67 
	g$chame
 = 
$row
["channelname"];

68 if(
	g$gu
=="")

70 
ShowMsg
("对不起，你指的栏目可能有误！","catalog_main.php");

71 
ex
();

74 if(
	g$chlid
>0)

77 
	g$row
 = 
$dsql
->
GO
("Selectypename,id,mancon from #@__channeltype where id='$channelid'");

78 
	g$gu
 = 
$row
["mancon"];

79 
	g$chlid
 = 
$row
["id"];

80 
	g$tyme
 = "";

81 
	g$chame
 = 
$row
["typename"];

84 if(
emy
(
$gu
))

86 
	g$gu
 = 'content_list.php';

88 
hd
("location:{$gurl}?channelid={$channelid}&cid={$cid}");

89 
ex
();

96 if(
	g$do
=="viewTemplet")

98 
hd
("loti:l.php?th=/".
$cfg_df_y
);

99 
ex
();

106 if(
	g$do
=="guestbook")

108 
ShowMsg
("正在跳转到留言本&gt;&gt;", "{$cfg_phpurl}/guestbook.php?gotopagerank=admin");

109 
ex
();

116 if(
	g$do
=="viewSgPage")

118 
que_
(
DEDEINC
."/arc.listview.class.php");

119 
	g$lv
 = 
w
 
LiVw
(
$cid
);

120 
	g$geu
 = 
$lv
->
MakeHtml
();

121 
ShowMsg
("更新缓冲，请稍后...",
$geu
);

122 
ex
();

129 if(
	g$do
=="upRank")

132 
CheckPurvw
('t_Edit,t_AccEdit');

135 
CheckCog
(
$cid
,"你无权更改本栏目！");

136 
	g$row
 = 
$dsql
->
GO
("Selecteid,sortrank From #@__arctype where id='$cid'");

137 
	g$id
 = 
$row
['reid'];

138 
	g$s܌k
 = 
$row
['sortrank'];

139 
	g$row
 = 
$dsql
->
GO
("Select sortrank From #@__arctype where sortrank<=$sortrank Andeid=$reid order by sortrank desc ");

140 if(
is_y
(
$row
))

142 
	g$s܌k
 = 
$row
['sortrank']-1;

143 
	g$dsql
->
ExecuNeQuy
("update #@__arctype set sortrank='$sortrank' where id='$cid'");

145 
UpDeCCache
();

146 
ShowMsg
("操作成功，返回目录...","catalog_main.php");

147 
ex
();

149 if(
	g$do
=="upRankAll")

152 
CheckPurvw
('t_Edit');

153 
	g$row
 = 
$dsql
->
GO
("Select id From #@__arctype order by id desc");

154 if(
is_y
(
$row
))

156 
	g$maxID
 = 
$row
['id'];

157 
	g$i
=1;$i<=
$maxID
;$i++)

159 if(
ist
(
$
{'s܌k'.
$i
}))

161 
	g$dsql
->
ExecuNeQuy
("Upd#@__y s s܌k='".(
$
{'s܌k'.
$i
})."' where id='{$i}';");

165 
UpDeCCache
();

166 
ShowMsg
("操作成功，正在返回...","catalog_main.php");

167 
ex
();

174 if(
	g$do
=="upcatcache")

176 
UpDeCCache
();

177 
	g$sql
 = " TRUNCATE TABLE `#@__arctiny`";

178 
	g$dsql
->
execunequy
(
$sql
);

181 
	g$sql
 = "insert into `#@__arctiny`(id,ypeid,ypeid2,rcrank, channel, senddate, sortrank, mid) 

182 
Se
 
id
, 
	gtyid
, 
	gtyid2
, 
	gk
, 
	gchl
, 
	gndde
, 
	gs܌k
, 
mid
 
	gom
 `#@
	g__chives
` ";

183 
	g$dsql
->
execunequy
(
$sql
);

186 
	g$dsql
->
SQuy
("Select id,addtable From `#@__channeltype` where id < -1 ");

187 
	g$dsql
->
Execu
();

188 
	g$d߼ay
 = 
y
();

189 
	g$row
 = 
$dsql
->
GAay
())

191 
$tb
 = 
r_a
('#@__', 
$cfg_dbefix
, 
$row
['addtable']);

192 if(
emy
(
$tb
|| 
ist
(
$d߼ay
[$tb]) )

198 
	g$sql
 = "insert into `#@__arctiny`(id,ypeid,ypeid2,rcrank, channel, senddate, sortrank, mid) 

199 
Se
 
aid
, 
	gtyid
, 0, 
	gk
, 
	gchl
, 
	gndde
, 0, 
mid
 
	gom
 `
	g$tb
` ";

200 
	g$rs
 = 
$dsql
->
execunequy
(
$sql
);

201 
	g$d߼ay
[
$tb
] = 1;

205 
ShowMsg
("操作成功，正在返回...","catalog_main.php");

206 
ex
();

213 if(
	g$do
=="GetJs")

215 
hd
("location:makehtml_js.php");

216 
ex
();

223 if(
	g$do
=="GetSunListsMenu")

225 
$urChl
 = 
$curLog
->
gUrChl
();

226 
que_
(
DEDEINC
."/typeunit.class.menu.php");

227 
AjaxHd
();

228 
PutCook
('ϡCidMu',
$cid
,3600*24,"/");

229 
	g$tu
 = 
w
 
TyUn
(
$urChl
);

230 
	g$tu
->
LogicLiASunTy
(
$cid
,"　");

237 if(
	g$do
=="GetSunLists")

239 
que_
(
DEDEINC
."/typeunit.class.admin.php");

240 
AjaxHd
();

241 
PutCook
('ϡCid',
$cid
,3600*24,"/");

242 
	g$tu
 = 
w
 
TyUn
();

243 
	g$tu
->
	gdsql
 = 
$dsql
;

244 
	gecho
 " <table width='100%' border='0' cellspacing='0' cellpadding='0'>\r\n";

245 
	g$tu
->
LogicLiASunTy
(
$cid
,"　");

246 
	gecho
 " </table>\r\n";

247 
	g$tu
->
Clo
();

253 if(
	g$do
 == 'unitCatalog')

255 
CheckPurvw
('t_Move');

256 
que_
(
DEDEINC
.'/oxwindow.class.php');

257 
que_
(
DEDEINC
.'/typelink.class.php');

258 
que_
(
DEDEINC
.'/channelunit.func.php');

259 if(
emy
(
$xtjob
))

261 
	g$tyid
 = 
ist
(
$tyid
? 
tv
($typeid) : 0;

262 
	g$row
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__arctype` whereeid='$typeid' ");

263 
	g$
 = 
w
 
TyLk
(
$tyid
);

264 
	g$tyme
 = 
$
->
TyInfos
['typename'];

265 
	g$id
 = 
$
->
TyInfos
['reid'];

266 
	g$chlid
 = 
$
->
TyInfos
['channeltype'];

267 if(!
emy
(
$row
['dd']))

269 
ShowMsg
("栏目： $typename($typeid) 有子栏目，不能进行合并操作！", '-1');

270 
ex
();

272 
	g$tyOis
 = 
$
->
GOiAay
(0, 0, 
$chlid
);

273 
	g$wt
 = '合并栏目';

274 
	g$wecome_fo
 = "<a href='catalog_main.php'>栏目管理</a> &gt;&gt; 合并栏目";

275 
	g$w
 = 
w
 
OxWdow
();

276 
	g$w
->
In
('catalog_do.php', 'js/blank.js', 'POST');

277 
	g$w
->
AddHidd
('dopost', 'unitCatalog');

278 
	g$w
->
AddHidd
('tyid', 
$tyid
);

279 
	g$w
->
AddHidd
('chlid', 
$chlid
);

280 
	g$w
->
AddHidd
('nextjob', 'unitok');

281 
	g$w
->
AddT
("合并目录时不会删除原来的栏目目录，合并后需手动更新目标栏目的文档HTML和列表HTML。");

282 
	g$w
->
AddIm
('你选择的栏目是：', "<font color='red'>$typename($typeid)</font>");

283 
	g$w
->
AddIm
('你希望合并到那个栏目？', "<selectame='unittype'>\r\n{$typeOptions}\r\n</select>");

284 
	g$w
->
AddIm
('注意事项：', '栏目不能有下级子栏目，只允许子级到更高级或同级或不同父级的情况。');

285 
	g$wfm
 = 
$w
->
GWdow
('ok');

286 
	g$w
->
Diy
();

287 
ex
();

291 if(
	g$tyid
==
$unty
)

293 
ShowMsg
("天哪，同一栏目如何合并，不是欺负人嘛！", '-1');

294 
ex
();

296 if(
IsPt
(
$unty
, 
$tyid
))

298 
ShowMsg
('不能从父类合并到子类！', 'catalog_main.php');

299 
ex
();

301 
	g$row
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

302 
	g$addb
 = (
emy
(
$row
['addtable']) ? '#@__addonarticle' : $row['addtable'] );

303 
	g$dsql
->
ExecuNeQuy
("Update `#@__arctiny` setypeid='$unittype' whereypeid='$typeid' ");

304 
	g$dsql
->
ExecuNeQuy
("Update `#@__feedback` setypeid='$unittype' whereypeid='$typeid' ");

305 
	g$dsql
->
ExecuNeQuy
("Update `#@__archives` setypeid='$unittype' whereypeid='$typeid' ");

306 
	g$dsql
->
ExecuNeQuy
("Update `#@__archives` setypeid2='$unittype' whereypeid2='$typeid' ");

307 
	g$dsql
->
ExecuNeQuy
("Update `#@__addonspec` setypeid='$unittype' whereypeid='$typeid' ");

308 
	g$dsql
->
ExecuNeQuy
("Update `$addtable` setypeid='$unittype' whereypeid='$typeid' ");

309 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctype` where id='$typeid' ");

310 
UpDeCCache
();

311 
ShowMsg
('成功合并指定栏目！', 'catalog_main.php');

312 
ex
();

319 if(
	g$do
 == 'moveCatalog')

321 
CheckPurvw
('t_Move');

322 
que_
(
DEDEINC
.'/oxwindow.class.php');

323 
que_
(
DEDEINC
.'/typelink.class.php');

324 
que_
(
DEDEINC
.'/channelunit.func.php');

325 if(
emy
(
$xtjob
))

327 
	g$
 = 
w
 
TyLk
(
$tyid
);

328 
	g$tyme
 = 
$
->
TyInfos
['typename'];

329 
	g$id
 = 
$
->
TyInfos
['reid'];

330 
	g$chlid
 = 
$
->
TyInfos
['channeltype'];

331 
	g$tyOis
 = 
$
->
GOiAay
(0,0,
$chlid
);

332 
	g$wt
 = "移动栏目";

333 
	g$wecome_fo
 = "<a href='catalog_main.php'>栏目管理</a> &gt;&gt; 移动栏目";

334 
	g$w
 = 
w
 
OxWdow
();

335 
	g$w
->
In
('catalog_do.php', 'js/blank.js', 'POST');

336 
	g$w
->
AddHidd
('dopost', 'moveCatalog');

337 
	g$w
->
AddHidd
('tyid', 
$tyid
);

338 
	g$w
->
AddHidd
('chlid', 
$chlid
);

339 
	g$w
->
AddHidd
('nextjob', 'unitok');

340 
	g$w
->
AddT
("移动目录时不会删除原来已创建的列表，移动后需重新对栏目创建HTML。");

341 
	g$w
->
AddIm
('你选择的栏目是：',"$typename($typeid)");

342 
	g$w
->
AddIm
('你希望移动到那个栏目？',"<selectame='movetype'>\r\n<option value='0'>移动为顶级栏目</option>\r\n$typeOptions\r\n</select>");

343 
	g$w
->
AddIm
('注意事项：','不允许从父级移动到子级目录，只允许子级到更高级或同级或不同父级的情况。');

344 
	g$wfm
 = 
$w
->
GWdow
('ok');

345 
	g$w
->
Diy
();

346 
ex
();

350 if(
	g$tyid
==
$movy
)

352 
ShowMsg
('移对对象和目标位置相同！', 'catalog_main.php');

353 
ex
();

355 if(
IsPt
(
$movy
, 
$tyid
))

357 
ShowMsg
('不能从父类移动到子类！', 'catalog_main.php');

358 
ex
();

360 
	g$dsql
->
ExecuNeQuy
(" Update `#@__arctype` seteid='$movetype' where id='$typeid' ");

361 
UpDeCCache
();

362 
ShowMsg
('成功移动目录！', 'catalog_main.php');

363 
ex
();

	@dede/catalog_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/typelink.class.php");

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

8 
	g$id
 = 
ist
(
$id
? 
	$tv
(
$id
) : 0;

11 
	`CheckPurvw
('t_Edit,t_AccEdit');

14 
	`CheckCog
(
$id
, '你无权更改本栏目！');

19 if(
$do
=="save")

22 
$desti
 = 
	`Html2Text
($description,1);

23 
$keywds
 = 
	`Html2Text
($keywords,1);

24 
$usql
 = 
$smys
 = '';

25 if(
	`ist
(
$smy
&& 
	`is_y
($smalltype))

27 
$smys
 = 
	`jo
(',',
$smy
);

29 if(
$tid
==0)

31 
$sh
 = 
$tyd
;

32 
$usql
 = " ,siteurl='$siteurl',sitepath='$sitepath',ishidden='$ishidden' ";

34 if(
$it
!=0)

36 
$oss
 = 0;

38 
$upquy
 = "Update `#@__arctype` set

39 
isnd
='$issend',

40 
s܌k
='$sortrank',

41 
tyme
='$typename',

42 
tyd
='$typedir',

43 
isdeu
='$isdefault',

44 
deume
='$defaultname',

45 
isnd
='$issend',

46 
ishidd
='$ishidden',

47 
chy
='$channeltype',

48 
mpdex
='$tempindex',

49 
mi
='$templist',

50 
mie
='$temparticle',

51 
mu
='$namerule',

52 
mu2
='$namerule2',

53 
it
='$ispart',

54 
cܪk
='$corank',

55 
desti
='$description',

56 
keywds
='$keywords',

57 
ٙ
='$seotitle',

58 
mese
='$moresite',

59 `
oss
`='$cross',

60 `
cڋ
`='$content',

61 `
ossid
`='$crossid',

62 `
smys
`='$smalltypes'

63 
$usql


64 
whe
 
id
='$id' ";

66 if(!
$dsql
->
	`ExecuNeQuy
(
$upquy
))

68 
	`ShowMsg
("保存当前栏目更改时失败，请检查你的输入资料是否存在问题！","-1");

69 
	`ex
();

73 if(
$tid
>0 && 
$isnd
==1)

75 
$dsql
->
	`ExecuNeQuy
("Update `#@__arctype` set issend='$issend' where id='$topid'; ");

77 
$ks
 = " id i(".
	`GSIds
(
$id
).")";

80 if(
$tid
==0 && 
	`eg
(',',
$ks
))

82 
$upquy
 = "Update `#@__arctype` set moresite='$moresite', siteurl='$siteurl',sitepath='$sitepath',ishidden='$ishidden' where 1=1 And $slinks";

83 
$dsql
->
	`ExecuNeQuy
(
$upquy
);

87 if(!
	`emy
(
$uext
))

89 
$upquy
 = "Update `#@__arctype` set

90 
isnd
='$issend',

91 
deume
='$defaultname',

92 
chy
='$channeltype',

93 
mpdex
='$tempindex',

94 
mi
='$templist',

95 
mie
='$temparticle',

96 
mu
='$namerule',

97 
mu2
='$namerule2',

98 
ishidd
='$ishidden'

99 
whe
 1=1 
And
 
$ks
";

100 if(!
$dsql
->
	`ExecuNeQuy
(
$upquy
))

102 
	`ShowMsg
("更改当前栏目成功，但更改下级栏目属性时失败！","-1");

103 
	`ex
();

106 
	`UpDeCCache
();

107 
	`ShowMsg
("成功更改一个分类！","catalog_main.php");

108 
	`ex
();

109 
	}
}

110 i(
	g$do
=="savetime")

112 
$usql
 = '';

113 
	g$ks
 = " id i(".
GSIds
(
$id
).")";

116 if(
	g$tid
==0 && 
$mese
==1)

118 
$sh
 = 
$tyd
;

119 
	g$usql
 = " ,sitepath='$sitepath' ";

120 if(
eg
(',',
$ks
))

122 
	g$upquy
 = "Update `#@__arctype` set sitepath='$sitepath' where $slinks";

123 
	g$dsql
->
ExecuNeQuy
(
$upquy
);

127 if(
	g$tid
 > 0 && 
	g$isnd
==1)

129 
$dsql
->
ExecuNeQuy
("Update `#@__arctype` set issend='$issend' where id='$topid'; ");

132 
	g$upquy
 = "Update `#@__arctype` set

133 
isnd
='$issend',

134 
	gs܌k
='$sortrank',

135 
	gtyd
='$typedir',

136 
	gtyme
='$typename',

137 
	gisdeu
='$isdefault',

138 
	gdeume
='$defaultname',

139 
	git
='$ispart',

140 
	gcܪk
='$cܪk' 
$usql


141 
whe
 
id
='$id' ";

143 if(!
$dsql
->
ExecuNeQuy
(
$upquy
))

145 
ShowMsg
("保存当前栏目更改时失败，请检查你的输入资料是否存在问题！","-1");

146 
ex
();

148 
UpDeCCache
();

149 
ShowMsg
("成功更改一个分类！","catalog_main.php");

150 
ex
();

154 
	g$dsql
->
SQuy
("Selectp.*,ch.typenames ctypename From `#@__arctype`peft join `#@__channeltype` ch on ch.id=tp.channeltype wherep.id=$id");

155 
	g$myrow
 = 
$dsql
->
GO
();

156 
	g$tid
 = 
$myrow
['topid'];

157 if(
	g$tid
>0)

159 
	g$trow
 = 
$dsql
->
GO
("Select moresite,siteurl,sitepath From `#@__arctype` where id=$topid");

160 
fܗch
(
$trow
 
as
 
$k
=>
$v
)

162 if(!
eg
("[0-9]",
$k
))

164 
$myrow
[
$k
] = 
$v
;

170 
	g$chlid
 = 
$myrow
['channeltype'];

171 
	g$dsql
->
SQuy
("select id,typename,nid from `#@__channeltype` where id<>-1 And isshow=1 order by id");

172 
	g$dsql
->
Execu
();

173 
	g$row
=
$dsql
->
	$GObje
())

175 
$chlAay
[
$row
->
id
]['tyme'] = $row->
tyme
;

176 
$chlAay
[
$row
->
id
]['nid'] = $row->
nid
;

177 if(
$row
->
id
==
$chlid
)

179 
$nid
 = 
$row
->
nid
;

181 
	}
}

182 
PutCook
('ϡCid',
GTid
(
$id
),3600*24,"/");

183 if(
	g$do
 == 'time')

186 <
fm
 
me
="fm1" 
ai
="log_ed.php" 
mhod
="po" 
Subm
="return checkSubmit();">

187 <
put
 
ty
="hidd" 
me
="do" 
vue
="savetime" />

188 <
put
 
ty
="hidd" 
me
="id" 
vue
="<?phpcho $id; ?>" />

189 <
put
 
ty
="hidd" 
me
="tid" 
vue
="<?phpcho $myrow['topid']; ?>" />

190 <
put
 
ty
="hidd" 
me
="mese" 
vue
="<?phpcho $myrow['moresite']; ?>" />

191 <
b
 
width
="100%" 
bd
="0" 
ηddg
="0" 
Υacg
="0">

192 <

>

193 <
td
 
ass
='ble' 
height
="26" 
ign
="" 
cޥ
="2">

194 <
a
 
hf
='log_ed.php?id=<?phech$id; ?>'><
u
>当前是快捷编辑模式，如果您要修改更详细的参数，请使用高级模式&
gt
;&
	ggt
;</
	gu
></
	ga
>

195 </
	gtd
>

196 </
	g
>

197 <
	g
>

198 <
td
 
	gwidth
="150" 
ass
='ble' 
height
="26" 
ign
="center">是否支持投稿：</td>

199 <
td
 
ass
='ble'> <
put
 
ty
='dio' 
me
='isnd' 
vue
='0' css='' <?
php
 if(
$myrow
['isnd']=="0"
echo
 " checked='1' ";?> />

200 不支持&
	gnb
; <
put
 
	gty
='dio' 
me
='isnd' 
vue
='1' 
ass
='' <?
php
 if(
$myrow
['isnd']=="1"
echo
 " checked='1' ";?> />

201 支持 </
	gtd
>

202 </
	g
>

204 <
	g
>

205 <
td
 
	gass
='ble' 
height
="26" 
ign
=""><
ft
 
c
='red'>内容模型：</font> </td>

206 <
td
 
ass
='bline'>

207 <?
php


208 
fܗch
(
$chlAay
 
as
 
$k
=>
$r
)

210 if(
$k
==
$chlid

echo
 "{$arr['typename']} | {$arr['nid']}";

213 <
a
 
	ghf
='log_ed.php?id=<?phech$id; ?>'><
u
>[修改]</u></a>

214 </
td
>

215 </

>

216 <

>

217 <
td
 
ass
='ble' 
height
="26" 
ign
=""><
ft
 
c
='red'>栏目名称：</font></td>

218 <
td
 
ass
='ble'><
put
 
me
="tyme" 
ty
="xt" 
id
="tyme" 
size
="30" 
vue
="<?phpcho $myrow['typename']?>" class="iptxt" /></td>

219 </

>

220 <

>

221 <
td
 
ass
='ble' 
height
="26" 
ign
="center"> 排列顺序： </td>

222 <
td
 
ass
='ble'> <
put
 
me
="s܌k" 
size
="6" 
ty
="xt" 
vue
="<?phpcho $myrow['sortrank']?>" class="iptxt" />

223 （由低 -&
gt
; 高） </
	gtd
>

224 </
	g
>

225 <
	g
>

226 <
td
 
	gass
='ble' 
height
="26" 
ign
="center">浏览权限：</td>

227 <
td
 
ass
='ble'> <

 
me
="cܪk" 
id
="cܪk" 
y
="width:100">

228 <?
php


229 
$dsql
->
SQuy
("Select * from #@__arcrank whereank >= 0");

230 
	g$dsql
->
Execu
();

231 
	g$row
 = 
$dsql
->
GObje
())

233 if(
$myrow
['cܪk']==
$row
->
nk
)

234 
echo
 "<ti vue='".
$row
->
nk
."' seed>".$row->
membme
."</option>\r\n";

236 
	gecho
 "<ti vue='".
	g$row
->
	gnk
."'>".$row->
	gmembme
."</option>\r\n";

239 </
	g
>

240 (仅限制栏目里的文档浏览权限</
	gtd
>

241 </
	g
>

242 <
	g
>

243 <
td
 
	gass
='ble' 
height
="26" 
ign
="center">文件保存目录：</td>

244 <
td
 
ass
='ble'><
put
 
me
="tyd" 
ty
="xt" 
id
="tyd" 
vue
="<?phech$myrow['tyd']?>" 
y
="width:300px" class="iptxt" /></td>

245 </

>

246 <

>

247 <
td
 
height
="26" 
ign
="" 
ass
='bline'>栏目列表选项：</td>

248 <
td
 
ass
='ble'> <
put
 
ty
='dio' 
me
='isdeu' 
vue
='1' css=''<?
php
 if(
$myrow
['isdeu']==1
echo
 " checked='1' ";?>/>

250 <
put
 
	gty
='dio' 
me
='isdeu' 
vue
='0' 
ass
=''<?
php
 if(
$myrow
['isdeu']==0
echo
 " checked='1' ";?>/>

252 <
put
 
	gty
='dio' 
me
='isdeu' 
vue
='-1' 
ass
=''<?
php
 if(
$myrow
['isdeu']==-1
echo
 " checked='1' ";?>/>

253 使用动态页 </
	gtd
>

254 </
	g
>

255 <
	g
>

256 <
td
 
	gass
='ble' 
height
="26" 
ign
="center">默认页的名称： </td>

257 <
td
 
ass
='ble'><
put
 
me
="deume" 
ty
="xt" 
vue
="<?phpcho $myrow['defaultname']?>" class="iptxt" /></td>

258 </

>

259 <

>

260 <
td
 
height
="26" 
ass
='ble' 
ign
="center">栏目属性：</td>

261 <
td
 
ass
='bline'>

262 <
put
 
me
="it" 
ty
="dio" 
id
="dio" 
vue
="0" 
ass
=''<?
php
 if(
$myrow
['it']==0
echo
 " checked='1' ";?>/>

263 最终列表栏目（允许在本栏目发布文档，并生成文档列表）<
	gbr
>

264 <
put
 
	gme
="it" 
ty
="dio" 
id
="dio2" 
vue
="1" 
ass
=''<?
php
 if(
$myrow
['it']==1
echo
 " checked='1' ";?>/>

266 频道封面（栏目本身不允许发布文档）<
	gbr
>

267 <
put
 
	gme
="it" 
ty
="dio" 
id
="dio3" 
vue
="2" 
ass
=''<?
php
 if(
$myrow
['it']==2
echo
 " checked='1' ";?>/>

268 外部连接（在"文件保存目录"处填写网址） </
	gtd
>

269 </
	g
>

270 <
	g
>

271 <
td
 
	gign
="" 
cޥ
="2" 
height
="54" 
bgc
='#FAFEE0'>

272 <
put
 
me
="imageFld" 
ty
="image" 
c
="img/bu_ok.gif" 
width
="60" 
height
="22" 
bd
="0" 
ass
="np"/>

273 &
nb
;&
	gnb
;&nbsp;

274 <
a
 
	gt
='关闭' 
ick
='CloMsg()'><
img
 
c
="img/bu_back.gif" 
width
="60" 
height
="22" 
bd
="0"></a>

275 </
td
>

276 </

>

277 </
b
>

278 </
fm
>

279 <?
php


280 
ex
();

284 
ude
 
DedeInude
('templets/catalog_edit.htm');

	@dede/catalog_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/typeunit.class.admin.php");

4 
	g$urChl
 = 
$curLog
->
gUrChl
();

5 
ude
 
DedeInude
('templets/catalog_main.htm');

	@dede/catalog_menu.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/typeunit.class.menu.php");

4 
	g$urChl
 = 
$curLog
->
gUrChl
();

5 if(
	$emy
(
$ݒd
))

7 
$ݒd
=-1;

8 
	}
}

9 if(
	g$urChl
>0)

11 
	g$ݒd
=
$urChl
;

13 if(
	g$curLog
->
	gadmSty
=='dedecms')

15 
ude
 
DedeInude
('templets/catalog_menu.htm');

16 
ex
();

20 
ude
 
DedeInude
('templets/catalog_menu2.htm');

21 
ex
();

	@dede/catalog_move.php

1 <?
php


2 
que_
('config.php');

3 
CheckPurvw
('t_Move');

4 
que_
(
DEDEINC
.'/oxwindow.class.php');

5 
que_
(
DEDEINC
.'/typelink.class.php');

6 
	g$tyid
 = 
ist
(
$tyid
? 
	$tv
(
$tyid
) : 0;

7 if(
	$emy
(
$do
))

9 
$do
 = 'movelist';

10 
	}
}

11 
	g$row
 = 
$dsql
->
GO
(" Selecteid,typename,channeltype From `#@__arctype` where id='$typeid' ");

12 
	g$tyme
 = 
$row
['typename'];

13 
	g$id
 = 
$row
['reid'];

14 
	g$chlid
 = 
$row
['channeltype'];

17 if(
	g$do
=='moveok')

19 if(
$tyid
==
$movy
)

21 
ShowMsg
('移对对象和目标位置相同！','catalog_main.php');

22 
ex
();

24 if(
IsPt
(
$movy
,
$tyid
,
$dsql
))

26 
ShowMsg
('不能从父类移动到子类！','catalog_main.php');

27 
ex
();

29 
	g$dsql
->
ExecuNeQuy
("Update `#@__arctype` seteid='$movetype' where id='$typeid'");

30 
UpDeCCache
();

31 
ShowMsg
('成功移动目录！','catalog_main.php');

32 
ex
();

35 
funi
 
	$IsPt
(
$myid
,
$tid
,
$dsql
)

37 
$row
 = 
$dsql
->
	`GO
("select id,reid,topid from #@__arctype whereopid='$myid' or id='$myid'");

38 if(
$row
['id']==
$tid
)

40  
ue
;

42 if(
$row
['reid']==0)

44  
l
;

48  
	`IsPt
(
$row
['id'],
$tid
,
$dsql
);

50 
	}
}

52 
	g$
 = 
w
 
TyLk
(
$tyid
);

53 
	g$tyOis
 = 
$
->
GOiAay
(0,0,
$chlid
);

54 
	g$wt
 = "移动栏目";

55 
	g$wecome_fo
 = "<a href='catalog_main.php'>栏目管理</a> &gt;&gt; 移动栏目";

56 
	g$w
 = 
w
 
OxWdow
();

57 
	g$w
->
In
('catalog_move.php','js/blank.js','POST');

58 
	g$w
->
AddHidd
('tyid',
$tyid
);

59 
	g$w
->
AddHidd
('dopost','moveok');

60 
	g$w
->
AddT
("移动目录时不会删除原来已创建的列表，移动后需重新对栏目创建HTML。");

61 
	g$w
->
AddIm
('你选择的栏目是：',"$typename($typeid)");

62 
	g$w
->
AddIm
('你希望移动到那个栏目？',"<selectame='movetype'>\r\n<option value='0'>移动为顶级栏目</option>\r\n$typeOptions\r\n</select>");

63 
	g$w
->
AddIm
('注意事项：','不允许从父级移动到子级目录，只允许子级到更高级或同级或不同父级的情况。');

64 
	g$wfm
 = 
$w
->
GWdow
('ok');

65 
	g$w
->
Diy
();

	@dede/co_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('co_AddNote');

4 if(
	$emy
(
$
))

6 
$
 = "";

7 
	}
}

8 if(
	$emy
(
$exru
))

10 
$exru
 = "";

11 
	}
}

17 if(
	$emy
(
$
))

19 
	`que_
(
DEDEADMIN
."/templets/co_add_step0.htm");

20 
	`ex
();

21 
	}
}

22 if(
	g$
==1)

24 
que_
(
DEDEADMIN
."/templets/co_add_step1.htm");

25 
ex
();

32 if(
	g$
==2)

35 if(
$do
=='test')

37 
ude
(
DEDEINC
."/dedecollection.class.php");

38 
	g$ume
 = (!
ist
(
$ume
) ? 0 : 1);

39 
	g$licfig
 = "{dede:noteinfootename=\\\"$notename\\\" channelid=\\\"$channelid\\\" macthtype=\\\"$macthtype\\\"

40 
fu
=\\\"$refurl\\\" sourcelang=\\\"$sourcelang\\\" cosort=\\\"$cosort\\\" isref=\\\"$isref\\\"xptime=\\\"$exptime\\\" usemore=\\\"$usemore\\\" /}

42 {
dede
:
liru
 
sourty
=\\\"$sourcetype\\\"ssurl=\\\"$rssurl\\\"egxurl=\\\"$regxurl\\\"

43 
tid
=\\\"$startid\\\"ndid=\\\"$endid\\\"ddv=\\\"$addv\\\" urlrule=\\\"$urlrule\\\"

44 
muhas
=\\\"$musthas\\\"othas=\\\"$nothas\\\"istpic=\\\"$listpic\\\" usemore=\\\"$usemore\\\"}

45 {
dede
:
addus
}
$addus
{/dede:addurls}

46 {
dede
:
bchru
}
$bchru
{/dede:batchrule}

47 {
dede
:
gxru
}
$gxru
{/dede:regxrule}

48 {
dede
:
t
}
$t
{/dede:areastart}

49 {
dede
:
d
}
$d
{/dede:areaend}

50 {/
dede
:
liru
}\
r
\
n
";

51 
$tmicfig
 = 
rashes
(
$licfig
);

52 
	g$nْame
 = 
rashes
(
$nْame
);

53 if(
	g$sourty
=='rss' && 
$fu
='')

55 
$fu
 = 
$rssu
;

57 
	g$fu
 = 
rashes
(
$fu
);

58 
	g$rmsg
 = '';

61 if(
	g$sourty
=='rss')

63 
$lks
 = 
GRssLks
(
rashes
(
$rssu
));

64 
	g$demage
 = 
$rssu
;

68 
	g$lks
 = 
y
();

69 
	g$lis
 = 
GUFromLiRu
(
$gxu
,
rashes
(
$addus
),
$tid
,
$did
,
$addv
,
$ume
,rashes(
$bchru
));

70 if(
ist
(
$lis
[0][0]))

72 
	g$demage
 = 
$lis
[0][0];

73 
	g$dc
 = 
w
 
DedeCi
();

74 
	g$dc
->
LdLiCfig
(
$tmicfig
);

75 
	g$liu
 = '';

76 
	g$lks
 = 
$dc
->
Telis
(
$liu
);

77 
	g$rmsg
 = 
$dc
->
rSg
;

81 
	g$demage
 = '没有匹配到适合的列表页!';

84 
que_
(
DEDEADMIN
."/templets/co_add_step1_test.htm");

85 
ex
();

91 
	g$row
 = 
$dsql
->
GO
("Selectid,channelid From `#@__co_note` where isok=0 Andotenameike '$notename' ");

92 if(!
is_y
(
$row
))

94 
	g$uime
 = 
time
();

95 
	g$licfig
 = 
udecode
(
$licfig
);

96 
	g$quy
 = " INSERT INTO `#@__co_note`(`channelid`,`notename`,`sourcelang`,`uptime`,`cotime`,`pnum`,`isok`,`usemore`,`listconfig`,`itemconfig`)

97 
VALUES
 ('$channelid','$notename','$sourcelang','$uptime','0','0','0','$usemore','$listconfig',''); ";

98 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

99 if(!
	g$rs
)

101 
ShowMsg
("保存信息时出现错误！".
$dsql
->
GE
(),"-1");

102 
ex
();

104 
	g$nid
 = 
$dsql
->
GLaID
();

108 
	g$chlid
=
$row
['channelid'];

109 
	g$uime
 = 
time
();

110 if(
emy
(
$eq
))

112 
	g$eq
 = 1;

114 if(
emy
(
$extyid
))

116 
	g$extyid
 = 0;

118 if(
emy
(
$ii
))

120 
	g$ii
 = 0;

122 
	g$ume
 = (!
ist
(
$ume
) ? 0 : 1);

123 
	g$quy
 = " update `#@__co_note` set

124 `
chlid
`='$channelid',

125 `
	gnْame
`='$notename',

126 `
	gsourng
`='$sourcelang',

127 `
	guime
`='$uptime',

128 `
	gisok
`='1',

129 `
	gume
`='$usemore',

130 `
	glicfig
`='$licfig' 
whe
 
nid
='$nid'; ";

131 
	g$dsql
->
ExecuNeQuy
(
$quy
);

132 
	g$nid
 = 
$row
['nid'];

134 if(!
ist
(
$evwu
))

136 
	g$evwu
 = '';

138 
que_
(
DEDEINC
.'/dedetag.class.php');

139 
que_
(
DEDEADMIN
."/templets/co_add_step2.htm");

140 
ex
();

148 if(
	g$
==5)

153 
$emcfig
 = "{dede:sppage sptype=\\'$sptype\\'}$sppage{/dede:sppage}\r\n";

154 
	g$emcfig
 .= "{dede:previewurl}$previewurl{/dede:previewurl}\r\n";

155 
	g$emcfig
 .= "{dede:keywordtrim}$keywordtrim{/dede:keywordtrim}\r\n";

156 
	g$emcfig
 .= "{dede:descriptiontrim}$descriptiontrim{/dede:descriptiontrim}\r\n";

157 
	g$fs
 = 
exode
(',','value,match,isunit,isdown,trim,function');

158 
fܗch
(
$flds
 
as
 
$fld
)

160 
fܗch
(
$fs
 
as
 
$f
)

162 
	g$GLOBALS
[
$f
.'_'.
$fld
] = (!
ist
(
$GLOBALS
[$f.'_'.$field]) ? '' : $GLOBALS[$f.'_'.$field]);

164 
	g$mchr
 = 
$GLOBALS
["mch_".
$fld
];

165 
	g$imr
 = 
$GLOBALS
["im_".
$fld
];

166 
	g$imr
 = 
im
(
r_a
('&nb;','#n#',
$imr
));

167 
	g$mchr
 = 
im
(
r_a
('&nb;','#n#',
$mchr
));

168 if(
	g$imr
!='' && !
egi
('{dede:im',
$imr
))

170 
	g$imr
 = " {dede:trim}$trimstr{/dede:trim}\r\n";

172 
	g$emcfig
 ."{dede:em fld=\\'".
$fld
."\\' vue=\\'".
$GLOBALS
["value_".$field]."\\' isunit=\\'".$GLOBALS["isunit_".$field]."\\' isdown=\\'".$GLOBALS["isdown_".$field]."\\'}

173 {
dede
:
mch
}".$matchstr."{/dede:match}

174 
$imr


175 {
dede
:
funi
}".$GLOBALS["
funi_
".$field]."{/dede:function}

176 {/
dede
:
em
}\
r
\
n
";

178 
$dsql
->
ExecuNeQuy
("Update `#@__co_note` set itemconfig='$itemconfig' whereid='$nid' ");

180 
que_
(
DEDEINC
.'/dedecollection.class.php');

181 
que_
(
DEDEADMIN
."/templets/co_add_step2_test.htm");

182 
ex
();

184 if(
	g$
==6)

186 
$dsql
->
ExecuNeQuy
("Update `#@__co_note` set isok='1' whereid='$nid' ");

187 
ShowMsg
("成功设置一个规则！","co_main.php");

188 
ex
();

190 if(
	g$
==7)

192 
$dsql
->
ExecuNeQuy
("Update `#@__co_note` set isok='1' whereid='$nid' ");

193 
ShowMsg
("成功设置一个规则，现在转向采集页面！","co_gather_start.php?nid=$nid");

194 
ex
();

	@dede/co_do.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/oxwindow.class.php");

4 if(!
	$ist
(
$nid
))

6 
$nid
=0;

7 
	}
}

8 
	g$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
["ENV_GOBACK_URL"]) ? "co_url.php" : $_COOKIE["ENV_GOBACK_URL"];

15 if(
	g$do
=="delete")

17 
CheckPurvw
('co_Del');

18 
	g$nid
 = 
tv
(
$nid
);

19 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__co_htmls` whereid='$nid'");

20 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__co_note` whereid='$nid'");

21 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__co_urls` whereid='$nid'");

22 
ShowMsg
("成功删除一个节点!","co_main.php");

23 
ex
();

31 if(
	g$do
=="clear")

33 
CheckPurvw
('co_Del');

34 if(!
ist
(
$ids
))

36 
	g$ids
='';

38 if(
emy
(
$ids
))

40 if(!
emy
(
$nid
))

42 
	g$nid
 = 
tv
(
$nid
);

43 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__co_htmls` whereid='$nid'");

45 
ShowMsg
("成功清空一个节点采集的内容!","co_main.php");

46 
ex
();

50 if(!
emy
(
$shash
))

52 
	g$dsql
->
SQuy
("Selectid,url From `#@__co_htmls` whereid in($ids) ");

53 
	g$dsql
->
Execu
();

54 
	g$r
 = 
$dsql
->
GAay
())

56 
$nhash
 = 
md5
(
$r
['url']);

57 
	g$nid
 = 
$row
['nid'];

58 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__co_urls ` whereid='$nid' And hash='$nhash' ");

61 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__co_htmls` whereid in($ids) ");

62 
ShowMsg
("成功删除指定的网址内容!",
$ENV_GOBACK_URL
);

63 
ex
();

66 if(
	g$do
=="clearct")

68 
CheckPurvw
('co_Del');

69 if(!
emy
(
$ids
))

71 
	g$dsql
->
ExecuNeQuy
("Update `#@__co_htmls` set isdown=0,result='' whereid in($ids) ");

73 
ShowMsg
("成功清除所有内容!",
$ENV_GOBACK_URL
);

74 
ex
();

80 if(
	g$do
=="clearall")

82 
CheckPurvw
('co_Del');

83 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__co_htmls` ");

84 
ShowMsg
("成功清空所有采集的临时内容!","co_main.php");

85 
ex
();

92 if(
	g$do
=="replace")

96 
$rg
 = 
im
($rpstring);

97 if(
	g$gty
=='string')

99 
$dsql
->
ExecuNeQuy
("Update `#@__co_htmls` set `result`=REPLACE(`result`,'$fdstring','$rpstring') whereid='$nid' ");

104 if(
emy
(
$ok
))

106 
	g$fdrg
 = 
rashes
(
$fdrg
);

107 
	g$rg
 = 
rashes
(
$rg
);

108 
	g$hiddvue
 = "<textareaame='fdstring' style='display:none'>{$fdstring}</textarea>\r\n<textareaame='rpstring' style='display:none'>{$rpstring}</textarea>\r\n";

109 
	g$fdrg
 = 
r_a
("\\/","#ASZZ#",
$fdrg
);

110 
	g$fdrg
 = 
r_a
('/',"\\/",
$fdrg
);

111 
	g$fdrg
 = 
r_a
('#ASZZ#',"\\/",
$fdrg
);

112 
	g$su
 = 
$rs
 = 
rashes
($rs);

113 if(
	g$fdrg
!='')

115 
$su
 = 
im
(
eg_a
("/$fdrg/isU",
$rg
,
$rs
));

117 
	g$wt
 = "采集管理-内容替换";

118 
	g$wecome_fo
 = "<a href='co_main.php'>采集管理</a>::内容替换";

119 
	g$w
 = 
w
 
OxWdow
();

120 
	g$w
->
In
("co_do.php","js/blank.js","POST");

121 
	g$w
->
AddHidd
('do',
$do
);

122 
	g$w
->
AddHidd
('nid',
$nid
);

123 
	g$w
->
AddHidd
('regtype','regex');

124 
	g$w
->
AddHidd
('aid',
$aid
);

125 
	g$w
->
AddHidd
('rpok','ok');

126 
	g$w
->
AddT
("内容替换操作确认：如果下面结果正确，点击确认，系统将替换当前节点所有内容！{$hiddenrpvalue}");

127 
	g$w
->
AddIm
("原来的内容：","<textareaame='rs' style='width:90%;height:250px'>{$rs}</textarea>\r\n");

128 
	g$w
->
AddIm
("按规则替换后的内容：","<textareaame='okrs' style='width:90%;height:250px'>{$result}</textarea>\r\n");

129 
	g$wfm
 = 
$w
->
GWdow
("ok");

130 
	g$w
->
Diy
();

131 
ex
();

135 if(
	g$fdrg
!='')

137 
$dsql
->
SQuy
("Select `aid`,`result` From `#@__co_htmls` whereid='$nid' ");

138 
	g$dsql
->
Execu
();

139 
	g$row
 = 
$dsql
->
GAay
())

141 
$fdrg
 = 
rashes
($fdstring);

142 
	g$rg
 = 
rashes
(
$rg
);

143 
	g$fdrg
 = 
r_a
("\\/","#ASZZ#",
$fdrg
);

144 
	g$fdrg
 = 
r_a
('/',"\\/",
$fdrg
);

145 
	g$fdrg
 = 
r_a
('#ASZZ#',"\\/",
$fdrg
);

146 
	g$su
 = 
im
(
eg_a
("/$fdrg/isU",
$rg
,
$row
['result']));

147 
	g$su
 = 
addashes
(
$su
);

148 
	g$dsql
->
ExecuNeQuy
("Update `#@__co_htmls` set `result`='$result' whereid='{$row['aid']}' ");

153 
ShowMsg
("成功替换当前节点所有数据！","co_view.php?aid=$aid");

154 
ex
();

161 if(
	g$do
=="copy")

163 
CheckPurvw
('co_AddNote');

164 if(
emy
(
$mynْame
))

166 
	g$wt
 = "采集管理-复制节点";

167 
	g$wecome_fo
 = "<a href='co_main.php'>采集管理</a>::复制节点";

168 
	g$w
 = 
w
 
OxWdow
();

169 
	g$w
->
In
("co_do.php","js/blank.js","POST");

170 
	g$w
->
AddHidd
("do",
$do
);

171 
	g$w
->
AddHidd
("nid",
$nid
);

172 
	g$w
->
AddT
("请输入新节点名称：");

173 
	g$w
->
AddIm
("新节点名称：","<inputype='text'ame='mynotename' value='' size='30' />");

174 
	g$wfm
 = 
$w
->
GWdow
("ok");

175 
	g$w
->
Diy
();

176 
ex
();

178 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__co_note` whereid='$nid'");

179 
fܗch
(
$row
 
as
 
$k
=>
$v
)

181 if(!
ist
(
$$k
))

183 
$$k
 = 
addashes
(
$v
);

186 
	g$ume
 = (
emy
(
$ume
) ? '0' : $usemore);

187 
	g$Quy
 = " INSERT INTO `#@__co_note`(`channelid`,`notename`,`sourcelang`,`uptime`,`cotime`,`pnum`,`isok`,`listconfig`,`itemconfig`,`usemore`)

188 
VALUES
 ('$channelid','$mynotename','$sourcelang','".time()."','0','0','0','$listconfig','$itemconfig','$usemore'); ";

189 
	g$dsql
->
ExecuNeQuy
(
$Quy
);

190 
ShowMsg
("成功复制一个节点!",
$ENV_GOBACK_URL
);

191 
ex
();

198 if(
	g$do
=="testrss")

200 
CheckPurvw
('co_AddNote');

201 
	g$msg
 = '';

202 if(
	g$rssu
=='')

204 
$msg
 = '你没有指定RSS地址！';

208 
ude
(
DEDEINC
."/dedecollection.func.php");

209 
	g$r
 = 
GRssLks
(
$rssu
);

210 
	g$msg
 = "从 {$rssurl} 发现的网址：<br />";

211 
	g$i
=1;

212 if(
is_y
(
$r
))

214 
fܗch
(
$r
 
as
 
$
)

216 
	g$msg
 .= "<hr size='1' />\r\n";

217 
	g$msg
 .= "link: {$ar['link']}<br />title: {$ar['title']}<br />image: {$ar['image']}\r\n";

218 
	g$i
++;

222 
	g$wt
 = "采集管理-测试";

223 
	g$wecome_fo
 = "<a href='co_main.php'>采集管理</a>::RSS地址测试";

224 
	g$w
 = 
w
 
OxWdow
();

225 
	g$w
->
AddMsgIm
(
$msg
);

226 
	g$wfm
 = 
$w
->
GWdow
("hand");

227 
	g$w
->
Diy
();

228 
ex
();

235 if(
	g$do
=="testregx")

237 
CheckPurvw
('co_AddNote');

238 
	g$msg
 = '';

239 if(
	g$gxu
=='')

241 
$msg
 = '你没有指定匹配的网址！';

245 
ude
(
DEDEINC
."/dedecollection.func.php");

246 
	g$msg
 = "匹配的网址：<br />";

247 
	g$lis
 = 
GUFromLiRu
(
$gxu
,'',
$tid
,
$did
,
$addv
);

248 
fܗch
(
$lis
 
as
 
$su
)

250 
	g$msg
 .
$su
[0]."<br />\r\n";

253 
	g$wt
 = "采集管理-测试匹配规则";

254 
	g$wecome_fo
 = "<a href='co_main.php'>采集管理</a>::测试匹配列表网址规则";

255 
	g$w
 = 
w
 
OxWdow
();

256 
	g$w
->
AddMsgIm
(
$msg
);

257 
	g$wfm
 = 
$w
->
GWdow
("hand");

258 
	g$w
->
Diy
();

259 
ex
();

266 if(
	g$do
=="coall")

268 
CheckPurvw
('co_PlayNote');

269 
	g$mrow
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__co_htmls` ");

270 
	g$tٮnum
 = 
$mrow
['dd'];

271 if(
	g$tٮnum
==0)

273 
ShowMsg
("没发现可下载的内容！","-1");

274 
ex
();

276 
	g$wt
 = "采集管理-采集未下载内容";

277 
	g$wecome_fo
 = "<a href='co_main.php'>采集管理</a>::采集未下载内容";

278 
	g$w
 = 
w
 
OxWdow
();

279 
	g$w
->
In
("co_gather_start_action.php","js/blank.js","GET");

280 
	g$w
->
AddHidd
('startdd','0');

281 
	g$w
->
AddHidd
('pagesize','5');

282 
	g$w
->
AddHidd
('sptime','0');

283 
	g$w
->
AddHidd
('nid','0');

284 
	g$w
->
AddHidd
('tٮnum',
$tٮnum
);

285 
	g$w
->
AddMsgIm
("本操作会检测并下载‘<a href='co_url.php'><u>临时内容</u></a>’中所有未下载的内容，是否继续？");

286 
	g$wfm
 = 
$w
->
GWdow
("ok");

287 
	g$w
->
Diy
();

288 
ex
();

	@dede/co_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('co_EditNote');

4 
que_
(
DEDEINC
.'/dedetag.class.php');

5 
	g$nid
 = (
ist
(
$nid
? 
	$tv
(
$nid
) : '');

6 if(
$nid
=='')

8 
	`ShowMsg
('参数无效!','-1');

9 
	`ex
();

10 
	}
}

11 if(
	$emy
(
$do
))

13 
$do
 = '';

14 
	}
}

19 if(
	g$do
=='ve' || 
$do
=='saveandtest')

21 
$ume
 = (!
ist
($usemore) ? 0 : 1);

22 
	g$licfig
 = "{dede:noteinfootename=\\\"$notename\\\" channelid=\\\"$channelid\\\" macthtype=\\\"$macthtype\\\"

23 
fu
=\\\"$refurl\\\" sourcelang=\\\"$sourcelang\\\" cosort=\\\"$cosort\\\"

24 
ief
=\\\"$isref\\\"xptime=\\\"$exptime\\\" usemore=\\\"$usemore\\\" /}

25 {
dede
:
liru
 
sourty
=\\\"$sourcetype\\\"ssurl=\\\"$rssurl\\\"egxurl=\\\"$regxurl\\\"

26 
tid
=\\\"$startid\\\"ndid=\\\"$endid\\\"ddv=\\\"$addv\\\" urlrule=\\\"$urlrule\\\" musthas=\\\"$musthas\\\"

27 
nhas
=\\\"$nothas\\\"istpic=\\\"$listpic\\\" usemore=\\\"$usemore\\\"}

28 {
dede
:
addus
}
$addus
{/dede:addurls}

29 {
dede
:
bchru
}
$bchru
{/dede:batchrule}

30 {
dede
:
gxru
}
$gxru
{/dede:regxrule}

31 {
dede
:
t
}
$t
{/dede:areastart}

32 {
dede
:
d
}
$d
{/dede:areaend}

33 {/
dede
:
liru
}\
r
\
n
";

34 
$emcfig
 = "{dede:sppage sptype=\\'$sptype\\'}$sppage{/dede:sppage}\r\n";

35 
	g$emcfig
 .= "{dede:previewurl}$previewurl{/dede:previewurl}\r\n";

36 
	g$emcfig
 .= "{dede:keywordtrim}$keywordtrim{/dede:keywordtrim}\r\n";

37 
	g$emcfig
 .= "{dede:descriptiontrim}$descriptiontrim{/dede:descriptiontrim}\r\n";

38 
	g$fs
 = 
exode
(',','value,match,isunit,isdown,trim,function');

39 
fܗch
(
$flds
 
as
 
$fld
)

41 
fܗch
(
$fs
 
as
 
$f
)

43 
	g$GLOBALS
[
$f
.'_'.
$fld
] = (!
ist
(
$GLOBALS
[$f.'_'.$field]) ? '' : $GLOBALS[$f.'_'.$field]);

45 
	g$mchr
 = 
$GLOBALS
["mch_".
$fld
];

46 
	g$imr
 = 
$GLOBALS
["im_".
$fld
];

47 
	g$imr
 = 
im
(
r_a
('&nb;','#n#',
$imr
));

48 
	g$mchr
 = 
im
(
r_a
('&nb;','#n#',
$mchr
));

49 if(
	g$imr
!='' && !
egi
('{dede:im',
$imr
))

51 
	g$imr
 = " {dede:trim}$trimstr{/dede:trim}\r\n";

53 
	g$emcfig
 ."{dede:em fld=\\'".
$fld
."\\' vue=\\'".
$GLOBALS
["value_".$field]."\\' isunit=\\'".$GLOBALS["isunit_".$field]."\\' isdown=\\'".$GLOBALS["isdown_".$field]."\\'}

54 {
dede
:
mch
}".$matchstr."{/dede:match}

55 
$imr


56 {
dede
:
funi
}".$GLOBALS["
funi_
".$field]."{/dede:function}

57 {/
dede
:
em
}";

59 
$uime
 = 
time
();

60 if(
emy
(
$eq
))

62 
	g$eq
 = 1;

64 if(
emy
(
$extyid
))

66 
	g$extyid
 = 0;

68 if(
emy
(
$ii
))

70 
	g$ii
 = 0;

72 
	g$quy
 = " update `#@__co_note` set

73 `
chlid
`='$channelid',

74 `
	gnْame
`='$notename',

75 `
	gsourng
`='$sourcelang',

76 `
	guime
`='$uptime',

77 `
	gisok
`='1',

78 `
	gume
`='$usemore',

79 `
	glicfig
`='$listconfig',

80 `
	gemcfig
`='$itemconfig'

81 
whe
 
nid
='$nid'; ";

82 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

83 
echo
 
	g$dsql
->
GE
();

84 if(
	g$dext
=='save')

86 
ShowMsg
("成功保存配置！","co_main.php");

90 
que_
(
dme
(
__FILE__
)."/co_test_rule.php");

92 
ex
();

94 
	g$r
 = 
$dsql
->
GO
("Select * from `#@__co_note` whereid='$nid'");

97 if(
im
(
$r
['itemconfig'])=='')

99 
$chlid
 = 
$r
['channelid'];

100 
	g$nid
 = 
$r
['nid'];

101 if(!
ist
(
$evwu
))

103 
	g$evwu
 = '';

105 
que_
(
DEDEINC
.'/dedetag.class.php');

106 
que_
(
DEDEADMIN
."/templets/co_add_step2.htm");

107 
ex
();

109 
	g$ume
 = 
$r
['usemore'];

110 
	g$nْame
 = 
$r
['notename'];

111 
	g$nes
 = 
y
();

112 
	g$dsql
->
FeResu
();

113 
	g$d
 = 
w
 
DedeTagP
();

114 
	g$d2
 = 
w
 
DedeTagP
();

115 
	g$d
->
LdSg
(
$r
['listconfig'].$arr['itemconfig']);

116 
	g$chlid
 = 
$r
['channelid'];

117 
	g$nes
['keywordtrim'] = '';

118 
	g$nes
['descriptiontrim'] = '';

119 
fܗch
(
$d
->
CTags
 
as
 
$tid
 => 
$ag
)

121 if(
$ag
->
GName
()=='item')

123 
$f
 = 
$ag
->
GA
('field');

124 
	g$nes
[
$f
]['em'] = 
$ag
;

125 
	g$d2
->
LdSg
(
$ag
->
GIText
());

126 
	g$nes
[
$f
]['trim'] = '';

127 
fܗch
(
$d2
->
CTags
 
as
 
$ag2
)

129 if(
	g$ag2
->
GName
()=='trim')

131 
$nes
[
$f
]['im'] ."{dede:im=\"".
$ag2
->
GA
('a')."\"}".$ag2->
GIText
()."{/dede:trim}\r\n";

133 if(
	g$ag2
->
GName
()=='match')

135 
$nes
[
$f
]['mch'] = 
$ag2
->
GIText
()."\r\n";

137 if(
	g$ag2
->
GName
()=='function')

139 
$nes
[
$f
]['funi'] = 
$ag2
->
GIText
()."\r\n";

143 if(
	g$ag
->
GName
()=='keywordtrim')

145 
$nes
['keywdim'] = 
$ag
->
GIText
();

147 if(
	g$ag
->
GName
()=='descriptiontrim')

149 
$nes
['destiڌim'] = 
$ag
->
GIText
();

151 if(
	g$ag
->
GName
()=='noteinfo')

153 
$nefo
 = 
$ag
;

155 if(
	g$ag
->
GName
()=='listrule')

157 
$liru
 = 
$ag
;

158 
	g$d2
->
LdSg
(
$ag
->
GIText
());

159 
	g$addus
 = 
$d2
->
GTagByName
('addurls');

160 
	g$gxru
 = 
$d2
->
GTagByName
('regxrule');

161 
	g$t
 = 
$d2
->
GTagByName
('areastart');

162 
	g$d
 = 
$d2
->
GTagByName
('areaend');

163 
	g$bchru
 = 
$d2
->
GTagByName
('batchrule');

165 if(
	g$ag
->
GName
()=='sppage')

167 
$ge
 = 
$ag
;

169 if(
	g$ag
->
GName
()=='previewurl')

171 
$evwu
 = 
im
(
$ag
->
GIText
());

174 if(!
ist
(
$evwu
))

176 
	g$evwu
 = '';

178 
que_
(
DEDEADMIN
.'/templets/co_edit.htm');

	@dede/co_edit_text.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('co_EditNote');

4 if(
	$emy
(
$job
))

6 
$job
='';

7 
	}
}

8 if(
	g$job
=='')

10 
que_
(
DEDEINC
."/oxwindow.class.php");

11 
	g$wt
 = "更改采集规则";

12 
	g$wecome_fo
 = "<a href='co_main.php'><u>采集点管理</u></a>::更改采集规则 - 专家更改模式";

13 
	g$w
 = 
w
 
OxWdow
();

14 
	g$w
->
In
("co_edit_text.php","js/blank.js","POST");

15 
	g$w
->
AddHidd
("job","yes");

16 
	g$w
->
AddHidd
("nid",
$nid
);

17 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__co_note` whereid='$nid' ");

18 
	g$w
->
AddT
("索引与基本信息配置：");

19 
	g$w
->
AddMsgIm
("<textareaame='listconfig' style='width:100%;height:200px'>{$row['listconfig']}</textarea>");

20 
	g$w
->
AddT
("字段配置：");

21 
	g$w
->
AddMsgIm
("<textareaame='itemconfig' style='width:100%;height:300px'>{$row['itemconfig']}</textarea>");

22 
	g$wfm
 = 
$w
->
GWdow
("ok");

23 
	g$w
->
Diy
();

24 
ex
();

28 
CheckPurvw
('co_EditNote');

29 
	g$quy
 = "update `#@__co_note` setistconfig='$listconfig',itemconfig='$itemconfig' whereid='$nid' ";

30 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

31 
ShowMsg
("成功修改一个规则!","co_main.php");

32 
ex
();

	@dede/co_export.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('co_Export');

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

8 if(
	g$do
!='done')

10 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

11 
	g$tٮcc
 = 
$chlid
 = 
$ume
 = 0;

12 if(!
emy
(
$nid
))

14 
	g$mrow
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__co_htmls` whereid='$nid' And isdown='1' ");

15 
	g$tٮcc
 = 
$mrow
['dd'];

16 
	g$ow
 = 
$dsql
->
GO
("Select channelid,usemore From `#@__co_note` whereid='$nid' ");

17 
	g$chlid
 = 
$ow
['channelid'];

18 
	g$ume
 = 
$ow
['usemore'];

22 
	g$mrow
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__co_htmls` where isdown='1' ");

23 
	g$tٮcc
 = 
$mrow
['dd'];

25 
ude
 
DedeInude
("templets/co_export.htm");

26 
ex
();

30 
que_
(
DEDEINC
.'/dedecollection.class.php');

31 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 0;

32 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

33 
	g$go
 = 
ist
(
$go
&& 
is_numic
($pageno) ? $pageno : 1;

34 
	g$tid
 = 
ist
(
$tid
&& 
is_numic
($startid) ? $startid : 0;

35 
	g$did
 = 
ist
(
$did
&& 
is_numic
($endid) ? $endid : 0;

36 if(!
ist
(
$makehtml
))

38 
	g$makehtml
 = 0;

40 if(!
ist
(
$lyt
))

42 
	g$lyt
 = 0;

44 if(!
ist
(
$ut
))

46 
	g$ut
 = 0;

48 if(!
ist
(
$auty
))

50 
	g$auty
 = 0;

52 
	g$co
 = 
w
 
DedeCi
();

53 
	g$co
->
LdNe
(
$nid
);

54 
	g$dway
 = ((
$co
->
neInfos
['cosort']=='desc' || $co->noteInfos['cosort']=='asc') ? $co->noteInfos['cosort'] : 'desc');

55 if(
	g$chlid
==0 && 
$tyid
==0)

57 
ShowMsg
('请指定默认导出栏目或频道ID！','javascript:;');

58 
ex
();

60 if(
	g$chlid
==0)

62 
$row
 = 
$dsql
->
GO
("Select ch.* From `#@__arctype`peft join `#@__channeltype` ch on ch.id=tp.channeltype wherep.id='$typeid'; ");

66 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__channeltype` where id='$channelid'; ");

68 if(!
is_y
(
$row
))

70 
	gecho
 "找不到频道内容模型信息，无法完成操作！";

71 
ex
();

75 
	g$chlid
 = 
$row
['id'];

76 
	g$mab
 = 
$row
['maintable'];

77 
	g$addb
 = 
$row
['addtable'];

78 if(
emy
(
$mab
))

80 
	g$mab
 = '#@__archives';

82 if(
emy
(
$addb
))

84 
	gecho
 "找不主表配置信息，无法完成操作！";

85 
ex
();

87 
	g$admid
 = 
$curLog
->
gUrID
();

90 
	g$dexSqlTeme
 = "INSERT INTO `#@__arctiny`(`arcrank`,`typeid`,`channel`,`senddate`,`sortrank`) VALUES ('$arcrank','@typeid@' ,'$channelid','@senddate@', '@sortrank@'); ";

93 
	g$maSqlTeme
 = "INSERT INTO `$maintable`(id,typeid,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,color,writer,source,litpic,pubdate,senddate,mid,description,keywords)

94 
VALUES
 ('@aid@','@typeid@','@sortrank@','@flag@','0','$channelid','$arcrank','0','0','@title@','','','@writer@','@source@','@litpic@','@pubdate@','@senddate@','$adminid','@description@','@keywords@'); ";

97 
	g$add_f
 = 
$add_v
 = '';

98 
	g$d
 = 
w
 
DedeTagP
();

99 
	g$d
->
SNameS
('field','<','>');

100 
	g$d
->
LdSg
(
$row
['fieldset']);

101 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

103 
	g$ame
 = 
$ag
->
GTagName
();

104 
	g$add_f
 .= ",`$tname`";

105 
	g$n٣nd
 = 
$ag
->
GA
('notsend');

106 
	g$fldty
 = 
$ag
->
GA
('type');

107 if(
	g$n٣nd
==1)

110 if(
$ag
->
GA
('default')!='')

112 
$dfvue
 = 
$ag
->
GA
('default');

114 if(
	g$fldty
=='t'||
$fldty
=='float'||$fieldtype=='number')

116 
$dfvue
 = '0';

118 if(
	g$fldty
=='dtime')

120 
$dfvue
 = 
time
();

124 
	g$dfvue
 = '';

126 
	g$add_v
 .= ",'$dfvalue'";

130 
	g$add_v
 .= ",'@$tname@'";

133 
	g$addSqlTeme
 = "INSERT INTO `{$addtable}`(`aid`,`typeid`{$inadd_f}) Values('@aid@','@typeid@'{$inadd_v})";

136 
	g$d
 = 
w
 
DedeTagP
();

137 
	g$tٮge
 = 
$tٮcc
/
$gesize
;

138 
	g$tdd
 = (
$go
-1* 
$gesize
;

139 if(!
emy
(
$nid
))

141 
	g$dsql
->
SQuy
("Select * From `#@__co_htmls` whereid='$nid' And isdown='1' order byid $orderwayimit $startdd,$pagesize");

145 
	g$dsql
->
SQuy
("Select * From `#@__co_htmls` where isdown='1' order byid $orderwayimit $startdd,$pagesize");

147 
	g$dsql
->
Execu
();

148 
	g$row
 = 
$dsql
->
GObje
())

150 if(
im
(
$row
->
su
==''))

155 
	g$yid
 = (
$auty
==1 && 
$row
->
tyid
 !0? $row->tyid : 
$tyid
;

156 
	g$dexSql
 = 
r_a
('@tyid@',
$yid
,
$dexSqlTeme
);

157 
	g$maSql
 = 
r_a
('@tyid@',
$yid
,
$maSqlTeme
);

158 
	g$addSql
 = 
r_a
('@tyid@',
$yid
,
$addSqlTeme
);

159 
	g$d
->
LdSg
(
$row
->
su
);

160 
	g$exid
 = 
$row
->
aid
;

161 if(!
is_y
(
$d
->
CTags
))

167 
	g$pubde
 = 
$s܌k
 = 
time
();

168 
	g$t
 = 
$row
->
t
;

169 
	g$lpic
 = '';

170 
fܗch
 (
$d
->
CTags
 
as
 
$ag
)

172 
	g$emName
 = 
$ag
->
GA
('name');

173 if(
	g$emName
 ='t' && 
$ut
==0)

175 
$t
 = 
im
(
$ag
->
GIText
());

176 if(
	g$t
=='')

178 
$t
 = 
$row
->
t
;

181 if(
	g$emName
 == 'pubdate')

183 
$pubde
 = 
im
(
$ag
->
GIText
());

184 if(
eg
("[^0-9]",
$pubde
))

186 
	g$pubde
 = 
$s܌k
 = 
GMkTime
(
$pubde
);

190 
	g$pubde
 = 
$s܌k
 = 
time
();

193 if(
	g$emName
 == 'litpic')

195 
$lpic
 = 
im
(
$ag
->
GIText
());

200 
	g$t
 = 
addashes
(
$t
);

201 if(
	g$lyt
)

203 
	g$row
 = 
$dsql
->
GO
("Select count(ID)s dd From `$maintable` whereitleike '$title'");

204 if(
	g$row
['dd']>0)

206 
	gecho
 "数据库已存在标题为: {$title} 的文档，程序阻止了此本条内容导入<br />\r\n";

212 
	g$ndde
 = 
time
();

213 
	g$ag
 = '';

214 if(
	g$lpic
!='')

216 
$ag
 = 'p';

220 if(
	g$ndcc
>0)

222 
	g$rag
 = 
mt_nd
(1,
$ndcc
);

223 if(
	g$rag
==
$ndcc
)

225 
$ag
 = ($flag=='' ? 'c' : $flag.',c');

228 
	g$dexSql
 = 
r_a
('@ndde@',
$ndde
,
$dexSql
);

229 
	g$dexSql
 = 
r_a
('@s܌k@',
$s܌k
,
$dexSql
);

230 
	g$maSql
 = 
r_a
('@ag@',
$ag
,
$maSql
);

231 
	g$maSql
 = 
r_a
('@s܌k@',
$s܌k
,
$maSql
);

232 
	g$maSql
 = 
r_a
('@pubde@',
$pubde
,
$maSql
);

233 
	g$maSql
 = 
r_a
('@ndde@',
$ndde
,
$maSql
);

234 
	g$maSql
 = 
r_a
('@t@',
_subr
(
$t
, 60),
$maSql
);

235 
	g$addSql
 = 
r_a
('@s܌k@',
$s܌k
,
$addSql
);

236 
	g$addSql
 = 
r_a
('@ndde@',
$ndde
,
$addSql
);

239 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

241 if(
	g$ag
->
GName
()!='field')

245 
	g$emme
 = 
$ag
->
GA
('name');

246 
	g$emvue
 = 
addashes
(
im
(
$ag
->
GIText
()));

247 
	g$maSql
 = 
r_a
("@$emme@",
$emvue
,
$maSql
);

248 
	g$addSql
 = 
r_a
("@$emme@",
$emvue
,
$addSql
);

252 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$dexSql
);

253 if(
	g$rs
)

255 
	g$aid
 = 
$dsql
->
GLaID
();

256 
	g$maSql
 = 
r_a
('@aid@',
$aid
,
$maSql
);

257 
	g$addSql
 = 
r_a
('@aid@',
$aid
,
$addSql
);

258 
	g$maSql
 = 
eg_a
('@([a-z0-9]{1,})@','',
$maSql
);

259 
	g$addSql
 = 
eg_a
('@([a-z0-9]{1,})@','',
$addSql
);

260 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$maSql
);

261 if(!
	g$rs
)

263 
	gecho
 "导入 '$t' 时错误：".
	g$dsql
->
GE
()."<br />";

264 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$aid' ");

268 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$addSql
);

269 if(!
	g$rs
)

271 
	gecho
 "导入 '$t' 时错误：".
	g$dsql
->
GE
()."<br />";

272 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$aid' ");

273 
	g$dsql
->
ExecuNeQuy
("Delete From `$maintable` where id='$aid' ");

277 
	g$dsql
->
ExecuNeQuy
("update `#@__co_htmls` set isexport=1 whereid='$exid' ");

281 if(
	g$tٮge
 <
$go
)

283 if(
$chlid
>0 && 
$makehtml
==1)

285 if
$auty
==0 && !
emy
(
$nid
) )

287 
$mhtml
 = "makehtml_archives_action.php?typeid=$typeid&startid=$startid&endid=$endid&pagesize=20";

288 
ShowMsg
("完成数据导入，准备生成文档HTML...",
$mhtml
);

289 
ex
();

293 
ShowMsg
("完成所有数据导入，请手工更新HTML！","javascript:;");

294 
ex
();

299 
ShowMsg
("完成所有数据导入！","javascript:;");

300 
ex
();

305 if(
	g$tٮge
>0)

307 
	g$rs
 = 
subr
((
$go
/
$tٮge
 * 100),0,2);

311 
	g$rs
 = 100;

313 
	g$go
++;

314 
	g$gou
 = "co_export.php?dopost=done&nid=$nid&totalcc=$totalcc&channelid=$channelid&pageno=$pageno";

315 
	g$gou
 .= "&nid=$nid&typeid=$typeid&autotype=$autotype&arcrank=$arcrank&pagesize=$pagesize&randcc=$randcc";

316 
	g$gou
 .= "&startid=$startid&endid=$endid&onlytitle=$onlytitle&usetitle=$usetitle&makehtml=$makehtml";

317 
ShowMsg
("完成 {$rs}% 导入，继续执行操作...",
$gou
,'',500);

318 
ex
();

	@dede/co_export_corule.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('co_EditNote');

4 
que_
(
DEDEINC
."/oxwindow.class.php");

5 
	g$nid
 = 
eg_a
('[^0-9]','',
$nid
);

6 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__co_note` whereid='$nid'");

7 
	g$necfig
 = "{dede:licfig}\r\n".
$row
['listconfig']."\r\n{/dede:listconfig}\r\n\r\n";

8 
	g$necfig
 ."{dede:emcfig}\r\n".
$row
['itemconfig']."\r\n{/dede:itemconfig}";

9 if(
emy
(
$exty
|| 
	g$exty
=='base64')

11 
$necfig
 = "BASE64:".
ba64_code
($noteconfig).":END";

12 
	g$exmsg
 = " &nbsp; <a href='co_export_corule.php?nid={$nid}&extype=text'>【导出为普通格式】</a> ";

16 
	g$exmsg
 = " &nbsp; <a href='co_export_corule.php?nid={$nid}&extype=base64'>【导出为Base64格式】</a> ";

18 
	g$wt
 = "导出采集规则";

19 
	g$wecome_fo
 = "<a href='co_main.php'><u>采集节点管理</u></a>::导出采集规则 $exmsg";

20 
	g$w
 = 
w
 
OxWdow
();

21 
	g$w
->
In
();

22 
	g$w
->
AddT
("以下为规则 [{$row['notename']}] 的文本配置，你可以共享给你的朋友：");

23 
	g$wfm
 = 
$w
->
GWdow
("hd","<xme='cfig' sty='width:100%;height:450px;wd-wp: bak-wd;wd-bak:bak-l;'>".
$necfig
."</textarea>");

24 
	g$w
->
Diy
();

	@dede/co_gather_start.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/dedecollection.class.php");

4 if(!
	$emy
(
$nid
))

6 
$
 = '采集指定节点：';

7 
$nid
 = 
	`tv
($nid);

8 
$co
 = 
w
 
	`DedeCi
();

9 
$co
->
	`LdNe
(
$nid
);

10 
$row
 = 
$dsql
->
	`GO
("Select count(aid)s dd From `#@__co_htmls` whereid='$nid'; ");

11 if(
$row
['dd']==0)

13 
$unum
 = "没有记录或从来没有采集过这个节点！";

17 
$unum
 = "共有 {$row['dd']} 个历史种子网址！<a href='javascript:SubmitNew();'>[<u>更新种子网址，并采集</u>]</a>";

19 
	}
}

22 
	g$
 = '监控式采集：';

23 
	g$unum
 = "没指定采集节点，将使用检测新内容采集模式！";

25 
ude
 
DedeInude
('templets/co_gather_start.htm');

	@dede/co_gather_start_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('co_PlayNote');

4 
que_
(
DEDEINC
.'/dedecollection.class.php');

5 if(
	g$tٮnum
==0)

7 
ShowMsg
('获取到的网址为零：可能是规则不对或没发现新内容！','javascript:;');

8 
ex
();

10 if(!
	$ist
(
$dt
))

12 
$dt
 = 
$tdd
;

13 
	}
}

14 if(
	$emy
(
$nckpic
))

16 
$nckpic
 = 0;

17 
	}
}

18 if(
	g$tٮnum
 > 
	g$tdd
+
	g$gesize
)

20 
	g$limSql
 = "imit $startdd,$pagesize ";

24 
	g$limSql
 = "im $tdd,".(
$tٮnum
 - 
$tdd
);

26 if(
	g$tٮnum
 - 
	g$tdd
 < 1)

28 if(
emy
(
$nid
))

30 
	g$dsql
->
ExecuNeQuy
("Upd`#@__co_ne` s cime='".
time
()."'; ");

34 
	g$dsql
->
ExecuNeQuy
("Upd`#@__co_ne` s cime='".
time
()."' whereid='$nid'; ");

36 
ShowMsg
('完成当前下载任务！','javascript:;');

37 
ex
();

39 
	g$co
 = 
w
 
DedeCi
();

40 if(!
	$emy
(
$nid
))

42 
$co
->
	`LdNe
(
$nid
);

43 
	}
}

46 if(!
	$emy
(
$nid
))

48 
$dsql
->
	`SQuy
("Selectid,nid,url,isdown,litpic From `#@__co_htmls` whereid=$nid $limitSql ");

49 
	}
}

52 
	g$dsql
->
SQuy
("Selectid,nid,url,isdown,litpic From `#@__co_htmls` $limitSql ");

54 
	g$dsql
->
Execu
(99);

55 
	g$tjnum
 = 
$tdd
;

56 
	g$row
 = 
$dsql
->
	$GObje
(99))

58 if(
$row
->
isdown
==0)

60 if(
	`emy
(
$nid
))

62 
$co
->
	`LdNe
(
$row
->
nid
);

64 
$co
->
	`DownU
(
$row
->
aid
,$row->
u
,$row->
lpic
);

66 
$tjnum
++;

67 if(
$time
>0
	`p
($sptime);

68 
	}
}

69 if(
	g$tٮnum
-
	g$dt
!=0)

71 
$tjn
 = 

((
$tjnum
-
$dt
)/(
$tٮnum
-$oldstart)) * 100 );

72 
	g$dvn
 = 
$tjn
 * 2;

73 
	g$tja
 = "<div style='width:200;height:15;border:1px solid #898989;text-align:left'><div style='width:$dvlen;height:15;background-color:#829D83'></div></div>";

74 
	g$tja
 .= "<br/>完成当前任务的：$tjlen %，继续执行任务...";

76 if(
	g$tjnum
 < 
	g$tٮnum
)

78 
ShowMsg
(
$tja
,"co_gh_t_ai.php?nckpic=$nckpic&time=$time&nid=$nid&dt=$dt&tٮnum=$tٮnum&tdd=".(
$tdd
+
$gesize
)."&pagesize=$pagesize","",0);

79 
ex
();

83 if(
emy
(
$nid
))

85 
	g$dsql
->
ExecuNeQuy
("Upd`#@__co_ne` s cime='".
time
()."'; ");

89 
	g$dsql
->
ExecuNeQuy
("Upd`#@__co_ne` s cime='".
time
()."' whereid='$nid'; ");

91 
ShowMsg
("完成当前下载任务！","javascript:;");

92 
ex
();

	@dede/co_get_corule.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('co_AddNote');

4 if(
	$emy
(
$job
))

6 
$job
='';

7 
	}
}

8 if(
	g$job
=='')

10 
que_
(
DEDEINC
."/../include/oxwindow.class.php");

11 
	g$wt
 = "导入采集规则";

12 
	g$wecome_fo
 = "<a href='co_main.php'><u>采集点管理</u></a>::导入采集规则";

13 
	g$w
 = 
w
 
OxWdow
();

14 
	g$w
->
In
("co_get_corule.php","js/blank.js","POST");

15 
	g$w
->
AddHidd
("job","yes");

16 
	g$w
->
AddT
("请在下面输入你要导入的文本配置：(建议用base64编码[支持不编码的规则，但不兼容旧版规则])");

17 
	g$w
->
AddMsgIm
("<textareaame='notes' style='width:100%;height:300px'></textarea>");

18 
	g$wfm
 = 
$w
->
GWdow
("ok");

19 
	g$w
->
Diy
();

20 
ex
();

24 
CheckPurvw
('co_AddNote');

25 
que_
(
DEDEINC
."/dedetag.class.php");

26 
	g$nes
 = 
im
(
$nes
);

29 if(
eg
('^BASE64:',
$nes
))

31 if(!
eg
(':END$',
$nes
))

33 
ShowMsg
('该规则不合法，Base64格式的采集规则为：BASE64:base64编码后的配置:END !','-1');

34 
ex
();

36 
	g$ness
 = 
exode
(':',
$nes
);

37 
	g$nes
 = 
$ness
[1];

38 
	g$nes
 = 
ba64_decode
(
eg_a
("[\r\n\]",'',
$nes
)
OR
 
d
('配置字符串有错误！');

42 
	g$nes
 = 
rashes
(
$nes
);

44 
	g$d
 = 
w
 
DedeTagP
();

45 
	g$d
->
LdSg
(
$nes
);

46 if(!
is_y
(
$d
->
CTags
))

48 
ShowMsg
('该规则不合法，无法导入!','-1');

49 
ex
();

51 
	g$ag1
 = 
$d
->
GTagByName
('listconfig');

52 
	g$ag2
 = 
$d
->
GTagByName
('itemconfig');

53 
	g$licfig
 = 
$ag1
->
GIText
();

54 
	g$emcfig
 = 
addashes
(
$ag2
->
GIText
());

55 
	g$d
->
LdSg
(
$licfig
);

56 
	g$licfig
 = 
addashes
(
$licfig
);

57 
	g$nefo
 = 
$d
->
GTagByName
('noteinfo');

58 if(!
is_obje
(
$nefo
))

60 
ShowMsg
("该规则不合法，无法导入!","-1");

61 
ex
();

63 
fܗch
(
$nefo
->
CAribu
->
Ims
 
as
 
$k
=>
$v
)

65 
$$k
 = 
addashes
(
$v
);

67 
	g$uime
 = 
time
();

68 if(
emy
(
$eq
))

70 
	g$eq
 = 1;

72 if(
emy
(
$extyid
))

74 
	g$extyid
 = 0;

76 if(
emy
(
$ii
))

78 
	g$ii
 = 0;

80 
	g$quy
 = " INSERT INTO `#@__co_note`(`channelid`,`notename`,`sourcelang`,`uptime`,`cotime`,`pnum`,`isok`,`usemore`,`listconfig`,`itemconfig`)

81 
VALUES
 ('$channelid','$notename','$sourcelang','$uptime','0','0','0','$usemore','$listconfig','$itemconfig'); ";

82 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

83 if(!
	g$rs
)

85 
ShowMsg
("保存信息时出现错误！".
$dsql
->
GE
(),"-1");

86 
ex
();

88 
ShowMsg
("成功导入一个规则!","co_main.php");

89 
ex
();

	@dede/co_getsource_url_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('co_PlayNote');

4 
que_
(
DEDEINC
.'/dedecollection.class.php');

5 if(
	$emy
(
$ii
))

7 
$ii
 = 0;

8 
	}
}

9 if(
	$emy
(
$glt
))

11 
$glt
 = 0;

12 
	}
}

13 if(
	$emy
(
$tٮnum
))

15 
$tٮnum
 = 0;

16 
	}
}

17 if(
	$emy
(
$nckpic
))

19 
$nckpic
 = 0;

20 
	}
}

21 
	g$nid
 = (
ist
(
$nid
? 
	$tv
(
$nid
) : 0);

27 if(
$ii
==0)

29 
$mrow
 = 
$dsql
->
	`GO
("Select count(*)s dd From `#@__co_htmls` whereid='$nid' ");

30 
$tٮnum
 = 
$mrow
['dd'];

31 
$gu
 = "co_gather_start_action.php?notckpic=$notckpic&islisten=$islisten&nid=$nid&startdd=$startdd&pagesize=$pagesize&sptime=$sptime";

32 if(
$tٮnum
 <= 0)

34 
	`ShowMsg
("你指定的模式为：<font color='red'>[下载种子网址中未下载内容]</font>，<br />使用这个模式节点必须已经有种子网址，否则请使用其它模式！","javascript:;");

35 
	`ex
();

39 
	`ShowMsg
("检测节点正常，现转向网页采集...",
$gu
."&totalnum=$totalnum");

40 
	`ex
();

42 
	}
}

48 if(
	g$ii
==1)

50 
$gu
 = "co_gather_start_action.php?notckpic=$notckpic&islisten=1&nid=$nid&startdd=$startdd&pagesize=$pagesize&sptime=$sptime";

51 
	g$guLi
 = "co_getsource_url_action.php?islisten=1&nid=0&pagesize=$pagesize&sptime=$sptime";

53 if(!
emy
(
$nid
))

55 
	g$co
 = 
w
 
DedeCi
();

56 
	g$co
->
LdNe
(
$nid
);

57 
	g$limLi
 = 
$co
->
GSourU
(1,0,100);

58 
	g$row
 = 
$co
->
dsql
->
GO
("Select count(aid)s dd From `#@__co_htmls` whereid='$nid' ");

59 
	g$tٮnum
 = 
$row
['dd'];

60 if(
	g$tٮnum
==0)

62 
ShowMsg
("在这节点中没发现有新内容....","javascript:;");

63 
ex
();

67 
ShowMsg
("已获得所有种子网址，转向网页采集...",
$gu
."&totalnum=$totalnum");

68 
ex
();

74 
	g$cuos
 = (
ist
(
$cuos
? 
tv
($curpos) : 0);

75 
	g$row
 = 
$dsql
->
GO
("Selectid From `#@__co_note` order byidscimit $curpos,1");

76 
	g$id
 = 
$row
['nid'];

77 if(!
is_y
(
$row
))

79 
ShowMsg
("完成所有节点检测....","co_gh_t_ai.php?nckpic=0&time=0&nid=0&tdd=0&gesize=5&tٮnum=".
$tٮnum
);

80 
ex
();

84 
	g$co
 = 
w
 
DedeCi
();

85 
	g$co
->
LdNe
(
$id
);

86 
	g$limLi
 = 
$co
->
GSourU
(1,0,100);

87 
	g$cuos
++;

88 
ShowMsg
("已检测节点{$id} )，继续下一个节点...",
$guLi
."&curpos=$curpos");

89 
ex
();

100 
	g$gu
 = "co_gather_start_action.php?notckpic=$notckpic&islisten=$islisten&nid=$nid&startdd=$startdd&pagesize=$pagesize&sptime=$sptime";

101 
	g$guLi
 = "co_getsource_url_action.php?islisten=$islisten&nid=$nid&startdd=$startdd&pagesize=$pagesize&sptime=$sptime";

102 
	g$co
 = 
w
 
DedeCi
();

103 
	g$co
->
LdNe
(
$nid
);

104 
	g$limLi
 = 
$co
->
GSourU
(
$ii
,
$glt
,
$gesize
);

105 if(
	g$limLi
==0)

107 
$row
 = 
$co
->
dsql
->
GO
("Select count(aid)s dd From `#@__co_htmls` whereid='$nid'");

108 
	g$tٮnum
 = 
$row
['dd'];

109 
ShowMsg
("已获得所有种子网址，转向网页采集...",
$gu
."&totalnum=$totalnum");

110 
ex
();

112 if(
	g$limLi
>0)

114 
ShowMsg
("采集列表剩余：{$limLi} 个页面，继续采集...",
$guLi
."&glt=".(
$glt
+
$gesize
),0,100);

115 
ex
();

	@dede/co_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

5 
	g$sql
 = "Select co.nid,co.channelid,co.notename,co.sourcelang,co.uptime,co.cotime,co.pnum,ch.typename";

6 
	g$sql
 .= " From `#@__co_note` coeft join `#@__channeltype` ch on ch.id=co.channelid order by co.nid desc";

7 
	g$dli
 = 
w
 
DaLiCP
();

8 
	g$dli
->
STem
(
DEDEADMIN
."/templets/co_main.htm");

9 
	g$dli
->
SSour
(
$sql
);

10 
	g$dli
->
diy
();

12 
funi
 
	$GDePage
(
$mktime
)

14  
$mktime
=='0' ? '从未采集过' : 
	`MyDe
('Y-m-d',$mktime);

15 
	}
}

17 
funi
 
	$TjUNum
(
$nid
)

19 
glob
 
$dsql
;

20 
$row
 = 
$dsql
->
	`GO
("Select count(*)s dd From `#@__co_htmls` whereid='$nid' ");

21  
$row
['dd'];

22 
	}
}

	@dede/co_test_rule.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/dedecollection.class.php");

4 
	g$nid
 = 
tv
(
$nid
);

5 
	g$co
 = 
w
 
DedeCi
();

6 
	g$co
->
LdNe
(
$nid
);

7 
ude
 
DedeInude
('templets/co_test_rule.htm');

8 
ex
();

	@dede/co_url.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

5 
	g$whe
 = "";

6 if(!
	$ist
(
$nid
))

8 
$nid
="";

9 
	}
}

10 if(!
	$emy
(
$nid
))

12 
$whe
 = " where cu.nid='$nid' ";

13 
	}
}

14 if(
	$emy
(
$sml
))

16 
$sml
 = 0;

17 
	}
}

18 if(
	g$nid
!='')

20 
$exptbt
 = "

21 <
put
 
ty
='bu' 
me
='b0' 
vue
='导出内容' 
ass
='coolbgp'

22 
y
='width:80px' 
Click
=\"location.href='co_export.php?nid=$nid';\" />

23 <
put
 
ty
='bu' 
me
='b0' 
vue
='采集本节点' 
ass
='coolbgp'

24 
y
='width:80px' 
Click
=\"location.href='co_gather_start.php?nid=$nid';\" />

29 
	g$exptbt
 = "";

31 
	g$sql
 = "Select cu.aid,cu.nid,cu.isexports isex,cu.title,cu.url,cu.dtime,cu.isdown,cn.notename,tp.typename From `#@__co_htmls` cu

32 

 
jo
 `#@
__co_ne
` 

 

 cn.
nid
=
cu
.nid

33 

 
jo
 `#@
__y
` 

 

p.
id
=
cu
.
tyid


34 
$whe
 
d
 
by
 
cu
.
aid
 
desc
";

35 
$dli
 = 
w
 
DaLiCP
();

36 
	g$dli
->
SPam
("nid",
$nid
);

37 
	g$dli
->
SPam
("sml",
$sml
);

38 if(
	g$sml
==0)

40 
$dli
->
STeme
(
DEDEADMIN
."/templets/co_url.htm");

44 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/co_url_2.htm");

46 
	g$dli
->
SSour
(
$sql
);

47 
	g$dli
->
diy
();

49 
funi
 
	$IsDownLd
(
$isd
)

51 if(
$isd
=="0")

59 
	}
}

61 
funi
 
	$IsExDa
(
$ix
)

63 if(
$ix
==0)

71 
	}
}

	@dede/co_view.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/dedecollection.class.php");

4 
	g$backu
 = 
ist
(
$_COOKIE
['ENV_GOBACK_URL']) ? $_COOKIE['ENV_GOBACK_URL'] : "co_url.php";

5 if(
	$emy
(
$ai
))

7 
$ai
='';

8 
	}
}

9 if(
	g$aid
=='')

11 
ShowMsg
('参数无效!','-1');

12 
ex
();

16 if(
	g$ai
=="save")

18 
$su
 = '';

19 
	g$i
=0;$< 
	g$did
;$i++)

21 
	g$su
 ."{dede:fldame=\\'".
$
{"noteid_$i"}."\\'}".${"value_$i"}."{/dede:field}\r\n";

23 
	g$dsql
->
ExecuNeQuy
("Update `#@__co_htmls` setesult='$result' whereid='$aid'; ");

24 
ShowMsg
("成功保存一条记录！",
$backu
);

25 
ex
();

27 
	g$dsql
->
SSql
("Select * from `#@__co_htmls` whereid='$aid'");

28 
	g$dsql
->
Execu
();

29 
	g$row
 = 
$dsql
->
GObje
();

30 
	g$isdown
 = 
$row
->
isdown
;

31 
	g$nid
 = 
$row
->
nid
;

32 
	g$u
 = 
$row
->
u
;

33 
	g$dtime
 = 
$row
->
dtime
;

34 
	g$body
 = 
$row
->
su
;

35 
	g$lpic
 = 
$row
->
lpic
;

36 
	g$flds
 = 
y
();

37 if(
	g$isdown
==0)

39 
$co
 = 
w
 
DedeCi
();

40 
	g$co
->
LdNe
(
$nid
);

41 
	g$co
->
DownU
(
$aid
,
$u
,
$lpic
);

42 
	g$co
->
	gdsql
->
SSql
("Select * from `#@__co_htmls` whereid='$aid'");

43 
	g$co
->
	gdsql
->
Execu
();

44 
	g$row
 = 
$co
->
dsql
->
GObje
();

45 
	g$isdown
 = 
$row
->
isdown
;

46 
	g$nid
 = 
$row
->
nid
;

47 
	g$u
 = 
$row
->
u
;

48 
	g$dtime
 = 
$row
->
dtime
;

49 
	g$body
 = 
$row
->
su
;

50 
	g$lpic
 = 
$row
->
lpic
;

52 
	g$d
 = 
w
 
DedeTagP
();

53 
	g$d
->
SNameS
("dede","{","}");

54 
	g$d
->
LdSg
(
$body
);

55 
ude
 
DedeInude
('templets/co_view.htm');

	@dede/config.php

1 <?
php


2 
defe
('DEDEADMIN', 
eg_a
("[/\\]{1,}", '/', 
dme
(
__FILE__
) ) );

3 
que_
(
DEDEADMIN
.'/../include/common.inc.php');

4 
que_
(
DEDEINC
.'/userlogin.class.php');

5 
hd
('Cache-Control:private');

6 
	g$dsql
->
	gCheck
 = 
l
;

7 
	g$dsql
->
SLgLk
();

10 
	g$dedeNowu
 = 
$s_stName
 = '';

11 
	g$isUOn
 = @
i_g
('allow_url_fopen');

12 
	g$dedeNowu
 = 
GCurU
();

13 
	g$dedeNowus
 = 
exode
('?', 
$dedeNowu
);

14 
	g$s_stName
 = 
$dedeNowus
[0];

17 
	g$curLog
 = 
w
 
urLog
();

18 if(
	g$curLog
->
gUrID
()==-1)

20 
hd
("loti:log.php?gage=".
ucode
(
$dedeNowu
));

21 
ex
();

23 if(
	g$cfg_dede_log
=='Y')

25 
$s_nogfe
 = '_main|_list';

26 
	g$s_edlogfe
 = 'sys_|file_';

27 
	g$s_mhod
 = 
ist
(
$_SERVER
['REQUEST_METHOD']) ? $_SERVER['REQUEST_METHOD'] : '';

28 
	g$s_quy
 = 
ist
(
$dedeNowus
[1]) ? $dedeNowurls[1] : '';

29 
	g$s_stNames
 = 
exode
('/',
$s_stName
);

30 
	g$s_stNames
 = 
$s_stNames
[
cou
($s_scriptNames)-1];

31 
	g$s_ur
 = 
GIP
();

32 if
	g$s_mhod
=='POST' || (!
egi
(
$s_nogfe
,
$s_stNames
&& 
	g$s_quy
!=''||gi(
$s_edlogfe
,$s_scriptNames) )

34 
	g$quy
 = "INSERT INTO `#@__log`(adminid,filename,method,query,cip,dtime)

35 
VALUES
 ('".$cuserLogin->getUserID()."','{$s_scriptNames}','{$s_method}','".addslashes($s_query)."','{$s_userip}','".time()."');";

36 
	g$dsql
->
ExecuNeQuy
(
$quy
);

41 
	g$che1
 = 
DEDEDATA
.'/cache/inc_catalog_base.inc';

42 if(!
	$fe_exis
(
$che1
)
	`UpDeCCache
();

43 
$cheFe
 = 
DEDEDATA
.'/che/admt_'.
$curLog
->
urID
.'.inc';

44 if(
	$fe_exis
(
$cheFe
)
	`que_
($cacheFile);

47 
funi
 
	$UpDeCCache
()

49 
glob
 
$dsql
, 
$cfg_mui_se
, 
$che1
, 
$cheFe
, 
$curLog
;

50 
$che2
 = 
DEDEDATA
.'/cache/channelsonlist.inc';

51 
$che3
 = 
DEDEDATA
.'/cache/channeltoplist.inc';

52 
$dsql
->
	`SQuy
("Select id,reid,channeltype,issend From `#@__arctype`");

53 
$dsql
->
	`Execu
();

54 
$1
 = 
	`fݒ
(
$che1
,'w');

55 
$phph
 = '?';

56 
$1Hd
 = "<{$phph}php\r\nglobal \$_Cs;\r\n\$_Cs=array();\r\n";

57 
	`fwre
(
$1
,
$1Hd
);

58 
$row
=
$dsql
->
	`GObje
())

60 
	`fwre
(
$1
,"\$_Cs[{$row->id}]=array({$row->reid},{$row->channeltype},{$row->issend});\r\n");

62 
	`fwre
(
$1
,"{$phph}>");

63 
	`fo
(
$1
);

64 
$curLog
->
	`ReWreAdmChl
();

65 @
	`uƚk
(
$che2
);

66 @
	`uƚk
(
$che3
);

67 
	}
}

69 
funi
 
	$DedeInude
(
$fame
,
$ibs
=
l
)

71  
$ibs
 ? 
$fame
 : 
DEDEADMIN
.'/'.$filename;

72 
	}
}

	@dede/content_att.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Att');

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

9 if(
	g$do
=="save")

11 
$tID
 = 1;

12 
	g$dID
 = 
$idd
;

13 ; 
	g$tID
<=
$dID
; $startID++)

15 
	g$t
 = 
$
{'t_'.
$tID
};

16 
	g$ame
 = 
$
{'ame_'.
$tID
};

17 
	g$stid
 = 
$
{'stid_'.
$tID
};

18 
	g$quy
 = "update `#@__arcatt` set `attname`='$attname',`sortid`='$sortid' wherett='$att' ";

19 
	g$dsql
->
ExecuNeQuy
(
$quy
);

21 
	gecho
 "<script>lert('成功更新自定文档义属性表！'); </script>";

24 
ude
 
DedeInude
('templets/content_att.htm');

	@dede/content_batch_up.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/typelink.class.php');

4 
ude
 
DedeInude
('templets/content_batch_up.htm');

	@dede/content_batchup_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_ArcBatch');

4 
que_
(
DEDEINC
."/typelink.class.php");

5 
que_
(
DEDEADMIN
."/inc/inc_batchup.php");

6 @
t_time_lim
(0);

12 if(
	$emy
(
$tid
))

14 
$tid
 = 0;

15 
	}
}

16 if(
	$emy
(
$did
))

18 
$did
 = 0;

19 
	}
}

20 if(
	$emy
(
$ime
))

22 
$ime
 = 0;

23 
	}
}

24 if(
	$emy
(
$tyid
))

26 
$tyid
 = 0;

27 
	}
}

29 if(
	g$ai
=="makehtml")

31 
$jumpu
 = "makehtml_archives_action.php?endid=$endid&startid=$startid";

32 
	g$jumpu
 .= "&typeid=$typeid&pagesize=20&seltime=$seltime";

33 
	g$jumpu
 ."&ime=".
ucode
(
$ime
)."&ime=".ucode(
$dtime
);

34 
hd
("Location: $jumpurl");

35 
ex
();

38 
	g$gwhe
 = " where 1 ";

39 if(
	g$tid
 >0 )

41 
	g$gwhe
 .= " And id>= $startid ";

43 if(
	g$did
 > 
	g$tid
)

45 
	g$gwhe
 .= " And id<= $endid ";

48 
	g$idsql
 = '';

49 if(
	g$tyid
!=0)

51 
$ids
 = 
GSIds
(
$tyid
);

52 
	g$gwhe
 .= " Andypeid in($ids) ";

54 if(
	g$ime
==1)

56 
$t1
 = 
GMkTime
(
$ime
);

57 
	g$t2
 = 
GMkTime
(
$dtime
);

58 
	g$gwhe
 .= " And (senddate >= $t1 And senddate <= $t2) ";

62 if(!
	$emy
(
$heightde
))

64 
$ai
=
$heightde
;

65 
	}
}

68 if(
	g$ai
=='check')

70 if(
emy
(
$tid
||my(
$did
) || $endid < $startid)

72 
ShowMsg
('该操作必须指定起始ID！','javascript:;');

73 
ex
();

75 
	g$jumpu
 = "makehtml_archives_action.php?endid=$endid&startid=$startid";

76 
	g$jumpu
 .= "&typeid=$typeid&pagesize=20&seltime=$seltime";

77 
	g$jumpu
 ."&ime=".
ucode
(
$ime
)."&ime=".ucode(
$dtime
);

78 
	g$dsql
->
SQuy
("Select id,arcrank From `#@__arctiny` $gwhere");

79 
	g$dsql
->
Execu
('c');

80 
	g$row
 = 
$dsql
->
GObje
('c'))

82 if(
$row
->
k
==-1)

84 
$dsql
->
ExecuNeQuy
("Update `#@__arctiny` setrcrank=0 where id='{$row->id}'");

85 
	g$dsql
->
ExecuNeQuy
("Update `#@__archives` setrcrank=0 where id='{$row->id}'");

88 
ShowMsg
("完成数据库的审核处理，准备更新HTML...",
$jumpu
);

89 
ex
();

93 if(
	g$ai
=='del')

95 if(
emy
(
$tid
||my(
$did
) || $endid < $startid)

97 
ShowMsg
('该操作必须指定起始ID！','javascript:;');

98 
ex
();

100 
	g$dsql
->
SQuy
("Select id From `#@__archives` $gwhere");

101 
	g$dsql
->
Execu
('x');

102 
	g$tdd
 = 0;

103 
	g$row
 = 
$dsql
->
GObje
('x'))

105 if(
DArc
(
$row
->
id
))

107 
$tdd
++;

110 
ShowMsg
("成功删除 $tdd 条记录！","javascript:;");

111 
ex
();

115 if(
	g$ai
=='delnulltitle')

117 
$dsql
->
SQuy
("Select id From `#@__archives` whererim(title)='' ");

118 
	g$dsql
->
Execu
('x');

119 
	g$tdd
 = 0;

120 
	g$row
 = 
$dsql
->
GObje
('x'))

122 if(
DArc
(
$row
->
id
))

124 
$tdd
++;

127 
ShowMsg
("成功删除 $tdd 条记录！","javascript:;");

128 
ex
();

132 if(
	g$ai
=='delnullbody')

134 
$dsql
->
SQuy
("Selectid From `#@__addonarticle` where LENGTH(body) < 10 ");

135 
	g$dsql
->
Execu
('x');

136 
	g$tdd
 = 0;

137 
	g$row
 = 
$dsql
->
GObje
('x'))

139 if(
DArc
(
$row
->
aid
))

141 
$tdd
++;

144 
ShowMsg
("成功删除 $tdd 条记录！","javascript:;");

145 
ex
();

149 if(
	g$ai
=='modddpic')

151 
$dsql
->
ExecuNeQuy
("Update `#@__archives` setitpic='' whererim(litpic)='litpic' ");

152 
ShowMsg
("成功修正缩略图错误！","javascript:;");

153 
ex
();

157 if(
	g$ai
=='move')

159 if(
emy
(
$tyid
))

161 
ShowMsg
('该操作必须指定栏目！','javascript:;');

162 
ex
();

164 
	g$tyd
 = 
$dsql
->
GO
("Select * From #@__arctype where id='$typeid'; ");

165 
	g$tyw
 = 
$dsql
->
GO
("Select * From #@__arctype where id='$newtypeid'; ");

166 if(!
is_y
(
$tyw
))

168 
ShowMsg
("无法检测移动到的新栏目的信息，不能完成操作！","javascript:;");

169 
ex
();

171 if(
	g$tyw
['ispart']!=0)

173 
ShowMsg
("你不能把数据移动到非最终列表的栏目！","javascript:;");

174 
ex
();

176 if(
	g$tyw
['chy']!=
$tyd
['channeltype'])

178 
ShowMsg
("不能把数据移动到内容类型不同的栏目！","javascript:;");

179 
ex
();

181 
	g$gwhe
 ." And chl='".
$tyw
['channeltype']."' Anditleike '%$keyword%'";

183 
	g$ch
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id={$typenew['channeltype']} ");

184 
	g$addb
 = 
$ch
['addtable'];

186 
	g$dsql
->
SQuy
("Select id From `#@__archives` $gwhere");

187 
	g$dsql
->
Execu
('m');

188 
	g$tdd
 = 0;

189 
	g$row
 = 
$dsql
->
GObje
('m'))

191 
$rs
 = 
$dsql
->
ExecuNeQuy
("Update `#@__arctiny` setypeid='$newtypeid' where id='{$row->id}'");

192 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("Update `#@__archives` setypeid='$newtypeid' where id='{$row->id}'");

193 if(
	g$addb
!='')

195 
$dsql
->
ExecuNeQuy
("Update `$addtable` setypeid='$newtypeid' whereid='{$row->id}' ");

197 if(
	g$rs
)

199 
	g$tdd
++;

201 
DArc
(
$row
->
id
,
ue
);

204 if(
	g$tdd
>0)

206 
	g$jumpu
 = "makehtml_archives_action.php?endid=$endid&startid=$startid";

207 
	g$jumpu
 .= "&typeid=$newtypeid&pagesize=20&seltime=$seltime";

208 
	g$jumpu
 ."&ime=".
ucode
(
$ime
)."&ime=".ucode(
$dtime
);

209 
ShowMsg
("成功移动 $tdd 条记录，准备重新生成HTML...",
$jumpu
);

213 
ShowMsg
("完成操作，没移动任何数据...","javascript:;");

218 if(
	g$ai
=='delnulltitle')

220 
$dsql
->
SQuy
("Select id From #@__archives whererim(title)='' ");

221 
	g$dsql
->
Execu
('x');

222 
	g$tdd
 = 0;

223 
	g$row
 = 
$dsql
->
GObje
('x'))

225 if(
DArc
(
$row
->
id
))

227 
$tdd
++;

230 
ShowMsg
("成功删除 $tdd 条记录！","javascript:;");

231 
ex
();

235 if(
	g$ai
=='modddpic')

237 
$dsql
->
ExecuNeQuy
("Update #@__archives setitpic='' whererim(litpic)='litpic' ");

238 
ShowMsg
("成功修正缩略图错误！","javascript:;");

239 
ex
();

	@dede/content_i_list.php

1 <?
php


2 
	g$s_tms
 = "templets/content_i_list.htm";

3 
ude
(
dme
(
__FILE__
)."/content_list.php");

	@dede/content_list.php

1 <?
php


8 
que_
(
dme
(
__FILE__
).'/config.php');

9 
que_
(
DEDEINC
.'/typelink.class.php');

10 
que_
(
DEDEINC
.'/datalistcp.class.php');

11 
que_
(
DEDEADMIN
.'/inc/inc_list_functions.php');

13 
	g$cid
 = 
ist
(
$cid
? 
	$tv
(
$cid
) : 0;

15 
$chlid
 = 
	`ist
($chlid? 
	$tv
(
$chlid
) : 0;

17 
$mid
 = 
	`ist
($mid? 
	$tv
(
$mid
) : 0;

19 if(!
	`ist
(
$keywd
)) $keyword = '';

21 if(!
	`ist
(
$ag
)) $flag = '';

23 if(!
	`ist
(
$k
)) $arcrank = '';

25 if(!
	`ist
(
$do
)) $dopost = '';

28 
	`CheckPurvw
('a_List,a_AccList,a_MyList');

31 
$urCogSql
 = '';

32 if(
	`TePurvw
('a_List'))

35 
	}
}

36 if(
TePurvw
('a_AccList'))

38 if(
	g$cid
==0 && 
$cfg_adm_chl
 == 'array')

40 
$adm_log
 = 
jo
(',', 
$adm_logs
);

41 
	g$urCogSql
 = "rc.typeid in($admin_catalog) ";

45 
CheckCog
(
$cid
, '你无权浏览非指定栏目的内容！');

49 
	g$admid
 = 
$curLog
->
gUrID
();

50 
	g$mab
 = '#@__archives';

51 
tcook
('ENV_GOBACK_URL', 
$dedeNowu
, 
time
()+3600, '/');

52 
	g$
 = 
w
 
TyLk
(
$cid
);

57 if(
emy
(
$tٮsu
&&my(
$keywd
&&my(
$dby
&& 
	$emy
(
$ag
))

59 
$tyQuys
 = 
	`y
();

61 if(!
	`emy
(
$urCogSql
))

63 
$tyQuys
[] = 
	`r_a
('c.', '', 
$urCogSql
);

66 if(!
	`emy
(
$chlid
&&my(
$cid
))

68 
$tyQuys
[] = " channel = '$channelid' ";

72 
$tyQuys
[] = " channel>0 ";

75 if(!
	`emy
(
$k
))

77 
$tyQuys
[] = "rcrank='$arcrank' ";

81 
$tyQuys
[] = "rcrank > -2 ";

84 if(!
	`emy
(
$mid
))

86 
$tyQuys
[] = " mid='$mid' ";

89 if(!
	`emy
(
$cid
))

91 
$tyQuys
[] = "yid in(".
	`GSIds
(
$cid
).") ";

94 if(
	`cou
(
$tyQuys
)>0)

96 
$tyQuy
 = "wh".
	`jo
(' And ',
$tyQuys
);

99 
$r
 = 
$dsql
->
	`GO
("Select count(*)s dd From `#@__arctiny` $tinyQuery ");

101 
$tٮsu
 = 
$r
['dd'];

102 
	}
}

104 if(
	g$cid
==0)

106 if(
$chlid
==0)

108 
$posime
 = '所有栏目&gt;';

112 
	g$row
 = 
$
->
dsql
->
GO
("Select id,typename,maintable From `#@__channeltype` where id='$channelid'");

113 
	g$posime
 = 
$row
['typename']." &gt; ";

114 
	g$mab
 = 
$row
['maintable'];

115 
	g$chlid
 = 
$row
['id'];

120 
	g$posime
 = 
r_a
(
$cfg_li_symb
," &gt; ",
$
->
GPosiName
())." &gt; ";

124 if(
emy
(
$chlid
)

125 && 
ist
(
$
->
TyInfos
['channeltype']))

127 
	g$chlid
 = 
$
->
TyInfos
['channeltype'];

129 if(
	g$chlid
 < -1 )

131 
hd
("location:content_sg_list.php?cid=$cid&channelid=$channelid&keyword=$keyword");

132 
ex
();

135 
	g$tiڬr
 = 
$
->
GOiAay
(
$cid
, 
$adm_logs
, 
$chlid
);

136 
	g$wheSql
 = 
emy
(
$chlid
) ? " whererc.channel > 0 Andrc.arcrank > -2 " : " whererc.channel = '$channelid' Andrc.arcrank > -2 ";

138 
	g$agsA
 = '';

139 
	g$dsql
->
Execu
('f', 'Select * From `#@__arcatt` order by sortidsc');

140 
	g$ow
 = 
$dsql
->
GAay
('f'))

142 
$agsA
 .(
$ow
['t']==
$ag
 ? "<option value='{$frow['att']}' selected>{$frow['attname']}</option>\r\n" : "<option value='{$frow['att']}'>{$frow['attname']}</option>\r\n");

146 if(!
	$emy
(
$urCogSql
))

148 
$wheSql
 ." And ".
$urCogSql
;

149 
	}
}

150 if(!
	$emy
(
$mid
))

152 
$wheSql
 .= " Andrc.mid = '$mid' ";

153 
	}
}

154 if(
	g$keywd
 != '')

156 
$wheSql
 .= " And ( CONCAT(arc.title,arc.writer)ike '%$keyword%') ";

158 if(
	g$ag
 != '')

160 
$wheSql
 .= " And FIND_IN_SET('$flag',rc.flag) ";

162 if(
	g$cid
 != 0)

164 
$wheSql
 .' Andrc.tyid i('.
GSIds
(
$cid
).')';

166 if(
	g$k
 != '')

168 
$wheSql
 .= " Andrc.arcrank = '$arcrank' ";

169 
	g$CheckUrSd
 = "<puty='bu' css='cobgp' onClick=\"loti='log_do.php?cid=".
$cid
."&dopost=listArchives&gurl=content_list.php';\" value='所有文档' />";

173 
	g$CheckUrSd
 = "<puty='bu' css='cobgp' onClick=\"loti='log_do.php?cid=".
$cid
."&dopost=listArchives&arcrank=-1&gurl=content_list.php';\" value='稿件审核' />";

176 
	g$dby
 = 
emy
(
$dby
? 'id' : 
egi_a
("[^a-z0-9]", "", $orderby);

177 
	g$dbyFld
 = 'c.'.
$dby
;

179 
	g$quy
 = "Selectrc.id,arc.typeid,arc.senddate,arc.flag,arc.ismake,

180 
c
.
chl
,
	gc
.
	gk
,c.
	gick
,c.
	gt
,c.
	gc
,c.
	glpic
,c.
	gpubde
,c.
	gmid
,

181 
	g
.
	gtyme
,
	gch
.
tyme
 
as
 
	gchame
,
	gmb
.
ume

admme


182 
	gom
 `
	g$mab
` 
c


183 

 
	gjo
 `#@
	g__y
` 

 

 
	g
.
	gid
=
c
.
tyid


184 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


185 

 
jo
 `#@
__memb
` 
mb
 

 mb.
mid
=
c
.mid

186 
$wheSql


187 
d
 
by
 
$dbyFld
 
desc
";

189 if(
emy
(
$f
|| !
eg
('fm', $f)
	g$f
 = 'form1.arcid1';

192 
	g$dli
 = 
w
 
DaLiCP
();

193 
	g$dli
->
	ggeSize
 = 30;

196 
	g$dli
->
SPam
('dopost', 'listArchives');

197 
	g$dli
->
SPam
('keywd', 
$keywd
);

198 if(!
emy
(
$mid
)
	g$dli
->
SPam
('mid', $mid);

199 
	g$dli
->
SPam
('cid', 
$cid
);

200 
	g$dli
->
SPam
('ag', 
$ag
);

201 
	g$dli
->
SPam
('dby', 
$dby
);

202 
	g$dli
->
SPam
('k', 
$k
);

203 
	g$dli
->
SPam
('chlid', 
$chlid
);

204 
	g$dli
->
SPam
('f', 
$f
);

207 if(
emy
(
$s_tms
)
	g$s_tms
 = 'templets/content_list.htm';

208 
	g$dli
->
STeme
(
DEDEADMIN
.'/'.
$s_tms
);

211 
	g$dli
->
SSour
(
$quy
);

214 
	g$dli
->
Diy
();

215 
	g$dli
->
Clo
();

	@dede/content_s_list.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('spec_List');

4 
	g$s_tms
 = "templets/content_s_list.htm";

5 
	g$chlid
 = -1;

6 
ude
(
dme
(
__FILE__
)."/content_list.php");

	@dede/content_select_list.php

1 <?
php


2 
	g$s_tms
 = "templets/content_select_list.htm";

3 
ude
(
dme
(
__FILE__
)."/content_list.php");

	@dede/content_sg_list.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
	g$cid
 = 
ist
(
$cid
? 
	$tv
(
$cid
) : 0;

4 
$chlid
 = 
	`ist
($chlid? 
	$tv
(
$chlid
) : 0;

5 
$mid
 = 
	`ist
($mid? 
	$tv
(
$mid
) : 0;

6 if(!
	$ist
(
$keywd
))

8 
$keywd
 = '';

9 
	}
}

10 if(!
	$ist
(
$k
))

12 
$k
 = '';

13 
	}
}

15 if(
emy
(
$cid
&& 
	$emy
(
$chlid
))

17 
	`ShowMsg
("该页面必须指定栏目ID或内容模型ID才能浏览！","javascript:;");

18 
	`ex
();

19 
	}
}

22 
CheckPurvw
('a_List,a_AccList,a_MyList');

25 if(
TePurvw
('a_List'))

29 if(
TePurvw
('a_AccList'))

31 if(
	g$cid
==0)

33 
$ucid
 = 
$cid
 = 
$curLog
->
gUrChl
();

37 
CheckCog
(
$cid
,"你无权浏览非指定栏目的内容！");

41 
	g$admid
 = 
$curLog
->
gUrID
();

42 
	g$mab
 = '#@__archives';

43 
que_
(
DEDEINC
."/typelink.class.php");

44 
que_
(
DEDEINC
."/datalistcp.class.php");

45 
que_
(
DEDEADMIN
."/inc/inc_list_functions.php");

46 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

47 
	g$
 = 
w
 
TyLk
(
$cid
);

48 
	g$lib
 = 
im
(
$
->
TyInfos
['addtable']);

49 if!
emy
(
$chlid
&& !emy(
$ucid
&& 
	g$
->
	gTyInfos
['channeltype'] != $channelid)

51 
ShowMsg
('你没权限访问此页！','javascript:;');

52 
ex
();

55 if(
	g$cid
==0)

57 
$row
 = 
$
->
dsql
->
GO
("Selectypename,addtable From `#@__channeltype` where id='$channelid'");

58 
	g$posime
 = 
$row
['typename']." &gt; ";

59 
	g$lib
 = 
$row
['addtable'];

63 
	g$posime
 = 
r_a
(
$cfg_li_symb
," &gt; ",
$
->
GPosiName
())." &gt; ";

66 
	g$tiڬr
 = 
$
->
GOiAay
(
$cid
,
$adm_logs
,
$chlid
);

68 
	g$wheSql
 = 
$chlid
==0 ? " whererc.channel < -1 " : " whererc.channel = '$channelid' ";

70 if(!
	$emy
(
$mid
))

72 
$wheSql
 .= " Andrc.mid = '$mid' ";

73 
	}
}

75 if(
	g$keywd
!='')

77 
$wheSql
 .= " And (arc.titleike '%$keyword%') ";

80 if(
	g$cid
!=0)

82 
$wheSql
 ." Andrc.tyid i(".
GSIds
(
$cid
).")";

85 if(
	g$k
!='')

87 
$wheSql
 .= " Andrc.arcrank = '$arcrank' ";

88 
	g$CheckUrSd
 = "<inputype='button' class='coolbgp' onClick=\"location='content_sg_list.php?cid={$cid}&channelid={$channelid}&dopost=listArchives';\" value='所有文档' />";

92 
	g$CheckUrSd
 = "<inputype='button' class='coolbgp' onClick=\"location='content_sg_list.php?cid={$cid}&channelid={$channelid}&dopost=listArchives&arcrank=-1';\" value='稿件审核' />";

95 
	g$quy
 = "Selectrc.aid,arc.aids id,arc.typeid,arc.arcrank,arc.flag,arc.senddate,arc.channel,arc.title,arc.mid,arc.click,tp.typename,ch.typenames channelname,adm.useridsdminname

96 
om
 `
$lib
` 
c


97 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


98 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


99 

 
jo
 `#@
__memb
` 
adm
 

dm.
mid
=
c
.mid

100 
$wheSql


101 
d
 
by
 
c
.
aid
 
desc
";

102 
$dli
 = 
w
 
DaLiCP
();

103 
	g$dli
->
	ggeSize
 = 20;

104 
	g$dli
->
SPam
("dopost","listArchives");

105 
	g$dli
->
SPam
("keywd",
$keywd
);

106 
	g$dli
->
SPam
("cid",
$cid
);

107 
	g$dli
->
SPam
("chlid",
$chlid
);

108 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/content_sg_list.htm");

109 
	g$dli
->
SSour
(
$quy
);

110 
	g$dli
->
Diy
();

111 
	g$dli
->
Clo
();

	@dede/content_tj.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_ArcTj');

4 
	g$row1
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__arctiny` ");

5 
	g$row2
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__feedback` ");

6 
	g$row3
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__member` ");

8 
funi
 
	$GArchives
(
$dsql
,
$dty
)

10 
$ime
 = 
	`time
() - (24*3600*30);

11 if(
$dty
=='monthFeedback' ||$ordertype=='monthHot')

13 
$swhe
 = " where senddate>$starttime ";

17 
$swhe
 = "";

19 if(
	`egi
('edback',
$dty
))

21 
$dsql
 = " order by scores desc ";

25 
$dsql
 = " order by click desc ";

27 
$quy
 = "Select id,title,click,scores From #@__archives $swhere $ordersqlimit 0,20 ";

28 
$dsql
->
	`SQuy
(
$quy
);

29 
$dsql
->
	`Execu
('ga');

30 
$row
 = 
$dsql
->
	`GObje
('ga'))

32 if(
	`egi
('edback',
$dty
))

34 
$mefo
 = "[<rg='_bnk' hf='".
$GLOBALS
['cfg_phpurl']."/feedback.php?aid={$row->id}'><u>评论：{$row->scores}</u></a>]";

38 
$mefo
 = "[点击：{$row->click}]";

40 
echo
 "·<a href='archives_do.php?aid={$row->id}&dopost=viewArchives'arget='_blank'>";

41 
echo
 
	`_subr
(
$row
->
t
,30)."</a>{$moreinfo}<br/>\r\n";

43 
	}
}

44 
ude
 
DedeInude
('templets/content_tj.htm');

	@dede/diy_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_New');

4 
	g$mysql_vsi
 = 
$dsql
->
GVsi
();

5 
	g$mysql_vsis
 = 
exode
(".",
im
(
$mysql_vsi
));

6 
	g$mysql_vsi
 = 
$mysql_vsis
[0].".".$mysql_versions[1];

7 if(
	$emy
(
$ai
))

9 
$row
 = 
$dsql
->
	`GO
("Select diyid From #@__diyforms order by diyid descimit 0,1 ");

10 if(
	`is_y
(
$row
))

12 
$wdiyid
 = 
$row
['diyid']+1;

16 
$wdiyid
 = 1;

18 
	`ude
(
DEDEADMIN
."/templets/diy_add.htm");

19 
	}
}

22 if(
eg
("[^0-9-]",
$diyid
)||
emy
($diyid))

24 
ShowMsg
("<font color=red>'自定义表单diyid'</font>必须为数字！","-1");

25 
ex
();

27 if(
	g$b
=="")

29 
ShowMsg
("表名不能为空！","-1");

30 
ex
();

32 
	g$public
 = 
ist
(
$public
&& 
is_numic
($public) ? $public : 0;

33 
	g$me
 = 
htmleclchs
(
$me
);

34 
	g$row
 = 
$dsql
->
GO
("Select * from #@__diyforms where diyid='$diyid' Or `table`ike '$table' Orameike '$name' ");

35 if(
is_y
(
$row
))

37 
ShowMsg
("可能自定义表单的‘diyid’、‘名称’在数据库中已存在，不能重复使用！","-1");

38 
ex
();

40 
	g$quy
 = "SHOW TABLES FROM {$dsql->dbName} ";

41 
	g$dsql
->
SQuy
(
$quy
);

42 
	g$dsql
->
execu
();

43 
	g$row
 = 
$dsql
->
gy
())

45 if(
emy
(
$row
[0]))

47 
$row
[0] = '';

49 if(
	g$b
 =
$row
[0])

51 
showmsg
('指定的表在数据库中重复', '-1');

52 
ex
();

55 
	g$sql
 = "CREATE TABLE IF NOT EXISTS `$table`(

56 `
id
` (10
NOT
 
NULL
 
auto_emt
,

57 `
	gifcheck
` 
tyt
(1
NOT
 
NULL
  '0',

59 if(
	g$mysql_vsi
 < 4.1)

61 
	g$sql
 .= " PRIMARY KEY (`id`)\r\n) TYPE=MyISAM; ";

65 
	g$sql
 ." PRIMARY KEY (`id`)\r\nENGINE=MyISAM DEFAULT CHARSET=".
$cfg_db_nguage
."; ";

67 
	g$dsql
->
tquy
(
$sql
);

68 if(
	g$dsql
->
execunequy
())

70 
	g$quy
 = "insert into #@__diyforms (`diyid`, `name`, `table`, `info`, `listtemplate`, `viewtemplate`, `posttemplate`, `public` ) values ('$diyid', '$name', '$table', '', '$listtemplate', '$viewtemplate', '$posttemplate', '$public')";

71 
	g$dsql
->
SQuy
(
$quy
);

72 
	g$dsql
->
execunequy
();

73 
showmsg
('自定义表单创建成功，请自行添加字段', 'diy_main.php');

77 
showmsg
('自定义表单创建失败', '-1');

	@dede/diy_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_Edit');

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 
que_
(
DEDEINC
."/oxwindow.class.php");

6 if(
	$emy
(
$do
))

8 
$do
="";

9 
	}
}

10 
	g$diyid
 = (
emy
(
$diyid
? 0 : 
tv
($diyid));

15 if(
	g$do
=="save")

17 
$public
 = 
ist
($public&& 
is_numic
($public) ? $public : 0;

18 
	g$me
 = 
htmleclchs
(
$me
);

19 
	g$quy
 = "update `#@__diyforms` setame = '$name',isttemplate='$listtemplate', viewtemplate='$viewtemplate',osttemplate='$posttemplate',ublic='$public' where diyid='$diyid' ";

20 
	g$dsql
->
ExecuNeQuy
(
$quy
);

21 
ShowMsg
("成功更改一个自定义表单！","diy_main.php");

22 
ex
();

27 if(
	g$do
=="delete")

29 @
t_time_lim
(0);

30 
CheckPurvw
('c_Del');

31 
	g$row
 = 
$dsql
->
GO
("Select * From #@__diyforms where diyid='$diyid'");

32 if(
emy
(
$job
))

34 
	g$job
="";

38 if(
	g$job
=="")

40 
$wt
 = "自定义表单管理-删除自定义表单";

41 
	g$wecome_fo
 = "<a href='diy_main.php'>自定义表单管理</a>::删除自定义表单";

42 
	g$w
 = 
w
 
OxWdow
();

43 
	g$w
->
In
("diy_edit.php","js/blank.js","POST");

44 
	g$w
->
AddHidd
("job","yes");

45 
	g$w
->
AddHidd
("do",
$do
);

46 
	g$w
->
AddHidd
("diyid",
$diyid
);

47 
	g$w
->
AddT
("！将删除所有与该自定义表单相关的文件和数据<b/>你确实要删除 \"".
$row
['name']."\" 这个自定义表单？");

48 
	g$wfm
 = 
$w
->
GWdow
("ok");

49 
	g$w
->
Diy
();

50 
ex
();

54 if(
	g$job
=="yes")

56 
$row
 = 
$dsql
->
GO
("Se `b` From `#@__diyfms` whdiyid='$diyid'",
MYSQL_ASSOC
);

57 if(!
is_y
(
$row
))

59 
ShowMsg
("你所指定的自定义表单信息不存在!","-1");

60 
ex
();

64 
	g$dsql
->
ExecuNeQuy
("DROP TABLE IF EXISTS `{$row['table']}`;");

67 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__diyforms` where diyid='$diyid'");

68 
ShowMsg
("成功删除一个自定义表单！","diy_main.php");

69 
ex
();

76 
	g$row
 = 
$dsql
->
GO
("Select * From #@__diyforms where diyid='$diyid'");

77 
ude
 
	gDEDEADMIN
."/templets/diy_edit.htm";

	@dede/diy_field_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

6 
que_
(
DEDEADMIN
.'/inc/inc_admin_channel.php');

7 if(
	$emy
(
$ai
))

9 
$ai
 = '';

10 
	}
}

11 
	g$mysql_vsi
 = 
$dsql
->
GVsi
();

12 
	g$mysql_vsis
 = 
exode
(".",
im
(
$mysql_vsi
));

13 
	g$mysql_vsi
 = 
$mysql_vsis
[0].".".$mysql_versions[1];

17 if(
	g$ai
=='save')

20 
$fldme
 = 
ow
($fieldname);

21 
	g$row
 = 
$dsql
->
GO
("Select `table`,`info` From #@__diyforms where diyid='$diyid'");

22 
	g$fldt
 = 
$row
['info'];

23 
que_
(
DEDEINC
."/dedetag.class.php");

24 
	g$d
 = 
w
 
DedeTagP
();

25 
	g$d
->
SNameS
("field","<",">");

26 
	g$d
->
LdSour
(
$fldt
);

27 
	g$ueTab
 = 
$row
['table'];

30 
	g$dfvue
 = 
im
(
$vdeu
);

31 
	g$iu
 = (
$iu
==1 ? "true" : "false");

32 
	g$mxn
 = 
$maxngth
;

35 
	g$fldfos
 = 
GFldMake
(
$dty
,
$fldme
,
$dfvue
,
$mxn
);

36 
	g$absql
 = 
$fldfos
[0];

37 
	g$buideTy
 = 
$fldfos
[1];

39 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(" ALTER TABLE `$trueTable` ADD $ntabsql ");

41 if(!
	g$rs
)

43 
	g$gr
 = 
$dsql
->
GE
();

44 
ShowMsg
("增加字段失败，错误提示为：".
$gr
,"javascript:;");

45 
ex
();

47 
	g$ok
 = 
l
;

50 if(
is_y
(
$d
->
CTags
))

53 
fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

55 if(
$fldme
 =
ow
(
$ag
->
GName
()))

57 
$d
->
Assign
(
$gid
,
rashes
(
$fldrg
),
l
);

58 
	g$ok
 = 
ue
;

62 
	g$okg
 = 
$ok
 ? 
$d
->
GResuNP
(: 
$fldt
."\n".
rashes
(
$fldrg
);

67 
	g$okg
 = 
$fldt
."\n".
rashes
(
$fldrg
);

69 
	g$addli
 = 
GAddFldLi
(
$d
,
$okg
);

70 
	g$okg
 = 
addashes
(
$okg
);

71 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("Update #@__diyforms set `info`='$oksetting' where diyid='$diyid' ");

72 if(!
	g$rs
)

74 
	g$g
 = 
$dsql
->
GE
();

75 
ShowMsg
("保存节点配置出错！".
$g
,"javascript:;");

76 
ex
();

78 
ShowMsg
("成功增加一个字段！","diy_edit.php?diyid=$diyid");

79 
ex
();

86 
	g$row
 = 
$dsql
->
GO
("Select `table` From #@__diyforms where diyid='$diyid'");

87 
	g$ueTab
 = 
$row
['table'];

88 
	g$bsql
 = "CREATE TABLE IF NOT EXISTS `$trueTable`(

89 `
id
` (10
NOT
 
NULL
 
auto_emt
,

90 `
ifcheck
` 
	$tyt
(1
NOT
 
NULL
  '0',

92 if(
$mysql_vsi
 < 4.1)

94 
$bsql
 .= " PRIMARY KEY (`id`)\r\n) TYPE=MyISAM; ";

95 
	}
}

98 
	g$bsql
 ." PRIMARY KEY (`id`)\r\nENGINE=MyISAM DEFAULT CHARSET=".
$cfg_db_nguage
."; ";

100 
	g$dsql
->
ExecuNeQuy
(
$bsql
);

103 
	g$flds
 = 
y
();

104 
	g$rs
 = 
$dsql
->
SQuy
("show fields from `$trueTable`");

105 
	g$dsql
->
Execu
('a');

106 
	g$ow
 = 
$dsql
->
GAay
('a',
MYSQL_ASSOC
))

108 
	g$flds
[
ow
(
$ow
['Field'])] = 1;

110 
	g$f
 = '';

111 
fܗch
(
$flds
 
as
 
$k
=>
$v
)

113 
$f
 .($f=='' ? 
$k
 : ' '.$k);

115 
que_
(
DEDEADMIN
."/templets/diy_field_add.htm");

	@dede/diy_field_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

6 
que_
(
DEDEINC
."/dedetag.class.php");

7 
que_
(
DEDEADMIN
."/inc/inc_admin_channel.php");

8 if(
	$emy
(
$ai
))

10 
$ai
 = '';

11 
	}
}

14 
	g$mysql_vsi
 = 
$dsql
->
GVsi
();

15 
	g$mysql_vsis
 = 
exode
(".",
im
(
$mysql_vsi
));

16 
	g$mysql_vsi
 = 
$mysql_vsis
[0].".".$mysql_versions[1];

17 
	g$row
 = 
$dsql
->
GO
("Select `table`,`info` From #@__diyforms where diyid='$diyid'");

18 
	g$fldt
 = 
$row
['info'];

19 
	g$ueTab
 = 
$row
['table'];

20 
	g$d
 = 
w
 
DedeTagP
();

21 
	g$d
->
SNameS
("field","<",">");

22 
	g$d
->
LdSour
(
$fldt
);

23 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

25 if(
ow
(
$ag
->
GName
())==ow(
$ame
))

32 
	g$ds
 = 
fe
(
DEDEADMIN
."/inc/fieldtype.txt");

33 
	$fܗch
(
$ds
 
as
 
$d
)

35 
$dds
 = 
	`exode
(',',
	`im
(
$d
));

36 
$fldtys
[
$dds
[0]] = $dds[1];

37 
	}
}

43 if(
	g$ai
=='save')

46 if(!
ist
(
$fldtys
[
$dty
]))

48 
ShowMsg
("你修改的是系统专用类型的数据，禁止操作！","-1");

49 
ex
();

53 
	g$bsql
 = "CREATE TABLE IF NOT EXISTS `$trueTable`(

54 `
id
` (10
NOT
 
NULL
 
auto_emt
,

55 `
	gifcheck
` 
tyt
(1
NOT
 
NULL
  '0',

57 if(
	g$mysql_vsi
 < 4.1)

59 
	g$bsql
 .= " PRIMARY KEY (`id`)\r\n) TYPE=MyISAM; ";

63 
	g$bsql
 ." PRIMARY KEY (`id`)\r\nENGINE=MyISAM DEFAULT CHARSET=".
$cfg_db_nguage
."; ";

65 
	g$dsql
->
ExecuNeQuy
(
$bsql
);

68 
	g$flds
 = 
y
();

69 
	g$rs
 = 
$dsql
->
SQuy
("show fields from `$trueTable`");

70 
	g$dsql
->
Execu
('a');

71 
	g$ow
 = 
$dsql
->
GAay
('a',
MYSQL_ASSOC
))

73 
	g$flds
[ 
ow
(
$ow
['Field']) ] = $nrow['Type'];

77 
	g$dfvue
 = 
$vdeu
;

78 
	g$iu
 = (
$iu
==1 ? "true" : "false");

79 
	g$mxn
 = 
$maxngth
;

80 
	g$fldme
 = 
ow
(
$ame
);

83 
	g$fldfos
 = 
GFldMake
(
$dty
,
$fldme
,
$dfvue
,
$mxn
);

84 
	g$absql
 = 
$fldfos
[0];

85 
	g$buideTy
 = 
$fldfos
[1];

86 
	g$bsql
 = '';

89 
fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

91 if(
im
(
$fldme
)=rim(
ow
(
$ag
->
GName
())))

94 if(
ist
(
$flds
[
$fldme
]&& $flds[$fldme]!=
$buideTy
)

96 
$bsql
 = "ALTER TABLE `$ueTab` CHANGE `$fldme` ".
$absql
;

97 
	g$dsql
->
ExecuNeQuy
(
$bsql
);

99 if(!
ist
(
$flds
[
$fldme
]))

101 
	g$bsql
 = "ALTER TABLE `$ueTab` ADD ".
$absql
;

102 
	g$dsql
->
ExecuNeQuy
(
$bsql
);

106 
	g$bsql
 = '';

108 
	g$d
->
Assign
(
$gid
,
rashes
(
$fldrg
),
l
);

112 
	g$okg
 = 
$d
->
GResuNP
();

114 
	g$okg
 = 
addashes
(
$okg
);

115 
	g$dsql
->
ExecuNeQuy
("Update #@__diyforms set info='$oksetting' where diyid='$diyid' ");

116 
ShowMsg
("成功更改一个字段的配置！","diy_edit.php?diyid={$diyid}");

117 
ex
();

124 if(
	g$ai
=="delete")

127 
fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

129 if(
ow
(
$ag
->
GName
())==ow(
$ame
))

131 
$d
->
Assign
(
$gid
,"#@Delete@#");

134 
	g$okg
 = 
addashes
(
$d
->
GResuNP
());

135 
	g$dsql
->
ExecuNeQuy
("Update #@__diyforms set info='$oksetting' where diyid='$diyid' ");

136 
	g$dsql
->
ExecuNeQuy
("ALTER TABLE `$trueTable` DROP `$fname` ");

137 
ShowMsg
("成功删除一个字段！","diy_edit.php?diyid=$diyid");

138 
ex
();

140 
que_
(
DEDEADMIN
."/templets/diy_field_edit.htm");

	@dede/diy_list.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_New');

4 
	g$diyid
 = 
ist
(
$diyid
&& 
is_numic
($diyid) ? $diyid : 0;

5 
	g$ai
 = 
ist
(
$ai
&& 
_y
($ai, 
y
('post', 'list', 'edit', 'check', 'delete')) ? $action : '';

6 if(
	$emy
(
$diyid
))

8 
	`showMsg
("非法操作!", 'javascript:;');

9 
	`ex
();

10 
	}
}

11 
que_
 
	gDEDEINC
.'/diyform.cls.php';

12 
	g$diy
 = 
w
 
diyfm
(
$diyid
);

13 if(
	g$ai
 == 'post')

15 if(
emy
(
$do
))

17 
$pofm
 = 
$diy
->
gFm
('post','','admin');

18 
ude
 
	gDEDEADMIN
.'/templets/diy_post.htm';

20 
if
(
$do
 == 2)

22 
$dede_flds
 = 
emy
($dede_flds? '' : 
im
($dede_fields);

23 
	g$dede_fldshash
 = 
emy
(
$dede_fldshash
? '' : 
im
($dede_fieldshash);

24 if(!
emy
(
$dede_flds
))

26 if(
	g$dede_fldshash
 !
md5
(
$dede_flds
.
$cfg_cook_code
))

28 
showMsg
("数据校验不对，程序返回", '-1');

29 
ex
();

32 
	g$diyfm
 = 
$dsql
->
gO
("select * from #@__diyforms where diyid=$diyid");

33 if(!
is_y
(
$diyfm
))

35 
showmsg
("自定义表单不存在", '-1');

36 
ex
();

38 
	g$addv
 = 
$addvue
 = '';

39 if(!
emy
(
$dede_flds
))

41 
	g$fldr
 = 
exode
(';', 
$dede_flds
);

42 if(
is_y
(
$fldr
))

44 
fܗch
(
$fldr
 
as
 
$fld
)

46 if(
	g$fld
 == '')

50 
	g$fldfo
 = 
exode
(',', 
$fld
);

51 if(
	g$fldfo
[1] ='htmext' || 
$fldfo
[1] == 'textdata')

53 
$
{
$fldfo
[0]} = 
frst
(
rashes
(${$fieldinfo[0]}));

54 
	g$
{
	g$fldfo
[0]} = 
addashes
(
$
{
$fldfo
[0]});

55 
	g$
{
	g$fldfo
[0]} = 
gFldVue
(
$
{
$fldfo
[0]}, $fieldinfo[1],0,'add','','member');

59 
	g$
{
	g$fldfo
[0]} = 
gFldVue
(
$
{
$fldfo
[0]}, $fieldinfo[1],0,'add','','member');

61 
	g$addv
 .', `'.
$fldfo
[0].'`';

62 
	g$addvue
 .", '".
$
{
$fldfo
[0]}."'";

66 
	g$quy
 = "insert into `{$diy->table}` (`id`, `ifcheck` $addvar) values (NULL, 0 $addvalue)";

67 if(
	g$dsql
->
execunequy
(
$quy
))

69 
	g$go
 = "diy_list.php?action=list&diyid={$diy->diyid}";

70 
showmsg
('发布成功', 
$go
);

74 
showmsg
('对不起，发布不成功', '-1');

77 }
if
(
$ai
 == 'list')

79 
ude_
 
DEDEINC
.'/datalistcp.class.php';

80 
	g$quy
 = "select * from {$diy->table} order by id desc";

81 
	g$di
 = 
w
 
DaLiCP
();

82 
	g$di
->
	ggeSize
 = 10;

83 
	g$di
->
SPam
('action', 'list');

84 
	g$di
->
SPam
('diyid', 
$diyid
);

85 
	g$di
->
STeme
(
DEDEADMIN
.'/templets/diy_list.htm');

86 
	g$di
->
SSour
(
$quy
);

87 
	g$fldli
 = 
$diy
->
gFldLi
();

88 
	g$di
->
Diy
();

89 }
if
(
$ai
 == 'edit')

91 if(
emy
(
$do
))

93 
$id
 = 
ist
($id&& 
is_numic
($id) ? $id : 0;

94 if(
emy
(
$id
))

96 
showMsg
('非法操作！未指定id', 'javascript:;');

97 
ex
();

99 
	g$quy
 = "select * from {$diy->table} where id=$id";

100 
	g$row
 = 
$dsql
->
ge
(
$quy
);

101 if(!
is_y
(
$row
))

103 
showmsg
("你访问的记录不存在或未经审核", '-1');

104 
ex
();

106 
	g$pofm
 = 
$diy
->
gFm
('ed', 
$row
, 'admin');

107 
	g$fldli
 = 
$diy
->
gFldLi
();

108 
	g$c1
 = 
$row
['ifcheck'] == 1 ? 'checked' : '';

109 
	g$c2
 = 
$row
['ifcheck'] == 0 ? 'checked' : '';

110 
ude
 
	gDEDEADMIN
.'/templets/diy_edit_content.htm';

112 
if
(
$do
 == 2)

114 
$dede_flds
 = 
emy
($dede_flds? '' : 
im
($dede_fields);

115 
	g$dede_fldshash
 = 
emy
(
$dede_fldshash
? '' : 
im
($dede_fieldshash);

116 if(!
emy
(
$dede_flds
))

118 if(
	g$dede_fldshash
 !
md5
(
$dede_flds
.
$cfg_cook_code
))

120 
showMsg
("数据校验不对，程序返回", '-1');

121 
ex
();

124 
	g$diyfm
 = 
$dsql
->
gO
("select * from #@__diyforms where diyid=$diyid");

125 if(!
is_y
(
$diyfm
))

127 
showmsg
("自定义表单不存在", '-1');

128 
ex
();

130 
	g$addsql
 = '';

131 if(!
emy
(
$dede_flds
))

133 
	g$fldr
 = 
exode
(';', 
$dede_flds
);

134 if(
is_y
(
$fldr
))

136 
fܗch
(
$fldr
 
as
 
$fld
)

138 if(
	g$fld
 == '')

142 
	g$fldfo
 = 
exode
(',', 
$fld
);

143 if(
	g$fldfo
[1] ='htmext' || 
$fldfo
[1] == 'textdata')

145 
$
{
$fldfo
[0]} = 
frst
(
rashes
(${$fieldinfo[0]}));

146 
	g$
{
	g$fldfo
[0]} = 
addashes
(
$
{
$fldfo
[0]});

147 
	g$
{
	g$fldfo
[0]} = 
gFldVue
(
$
{
$fldfo
[0]}, $fieldinfo[1],0,'add','','member');

151 
	g$
{
	g$fldfo
[0]} = 
gFldVue
(
$
{
$fldfo
[0]}, $fieldinfo[1],0,'add','','member');

153 
	g$addsql
 .'`'.
$fldfo
[0]."`='".
$
{$fieldinfo[0]}."',";

157 
	g$quy
 = "update `$diy->table` set $addsql ifcheck='$ifcheck' where id=$id";

158 if(
	g$dsql
->
execunequy
(
$quy
))

160 
	g$go
 = "diy_list.php?action=list&diyid={$diy->diyid}";

161 
showmsg
('编辑成功', 
$go
);

165 
showmsg
('编辑成功', '-1');

168 }
if
(
$ai
 == 'check')

170 if(
is_y
(
$id
))

172 
$ids
 = 
imode
(',', 
$id
);

176 
showmsg
('未选中要操作的内容', '-1');

177 
ex
();

179 
	g$quy
 = "update `$diy->table` set ifcheck=1 where id in ($ids)";

180 if(
	g$dsql
->
execunequy
(
$quy
))

182 
showmsg
('审核成功', "diy_list.php?action=list&diyid={$diy->diyid}");

186 
showmsg
('审核失败', "diy_list.php?action=list&diyid={$diy->diyid}");

188 }
if
(
$ai
 == 'delete')

190 if(
is_y
(
$id
))

192 
$ids
 = 
imode
(',', 
$id
);

195 
showmsg
('未选中要操作的内容', '-1');

196 
ex
();

198 
	g$quy
 = "delete from `$diy->table` where id in ($ids)";

199 if(
	g$dsql
->
execunequy
(
$quy
))

201 
showmsg
('删除成功', "diy_list.php?action=list&diyid={$diy->diyid}");

205 
showmsg
('删除失败', "diy_list.php?action=list&diyid={$diy->diyid}");

209 
showmsg
('未定义操作', "-1");

	@dede/diy_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_List');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
que_
(
DEDEINC
."/common.func.php");

6 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

7 
	g$sql
 = "Select `diyid`,`name`,`table` From #@__diyforms order by diyidsc";

8 
	g$dli
 = 
w
 
DaLiCP
();

9 
	g$dli
->
STem
(
DEDEADMIN
."/templets/diy_main.htm");

10 
	g$dli
->
SSour
(
$sql
);

11 
	g$dli
->
diy
();

12 
	g$dli
->
Clo
();

	@dede/erraddsave.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/datalistcp.class.php');

4 
que_
(
DEDEINC
.'/common.func.php');

6 if(
	$emy
(
$do
))

8 
$do
 ='';

9 
	}
}

10 if(
	$emy
(
$fmdo
))

12 
$fmdo
 = '';

13 
	}
}

15 
funi
 
	$uame
(
$mid
)

17 
glob
 
$dsql
;

18 if(!
	`ist
(
$mid
|| 
	`emy
($mid))

21 
	`ex
();

25 
$sql
 = "Select uname From `#@__member` WHERE `mid` = '$mid'";

26 
$row
 = 
$dsql
->
	`GO
(
$sql
);

27  
$row
['uname'];

28 
	`ex
();

30 
	`ex
();

31 
	}
}

33 
funi
 
	$tyme
(
$me
)

35 
$me
)

37 
$me
 == 1:

38  
$me
 = "错别字";

40 
$me
 == 2:

41  
$me
 = "成语运用不当";

43 
$me
 == 3:

44  
$me
 = "专业术语写法不规则";

46 
$me
 == 4:

47  
$me
 = "产品与图片不符";

49 
$me
 == 5:

50  
$me
 = "事实年代以及内容错误";

52 
$me
 == 6:

53  
$me
 = "事实年代以及内容错误";

55 
$me
 == 7:

56  
$me
 = "其他错误";

59  
$me
 = "未知错误";

62 
	}
}

64 if(
	g$do
 == "delete")

66 if(
$id
=='')

68 
ShowMsg
("参数无效！","-1");

69 
ex
();

73 if(
	g$fmdo
=='yes')

75 
$id
 = 
exode
("`",$id);

76 
fܗch
 (
$id
 
as
 
$v
)

78 
	g$quy
 = "DELETE FROM `#@__erradd` WHERE `id` = '$var'";

79 
	g$dsql
->
ExecuNeQuy
(
$quy
);

81 
ShowMsg
("成功删除指定的文档！","erraddsave.php");

82 
ex
();

88 
que_
(
DEDEINC
."/oxwindow.class.php");

89 
	g$wt
 = "删除";

90 
	g$wecome_fo
 = "<a href='erraddsave.php'>错误管理</a>::删除错误";

91 
	g$w
 = 
w
 
OxWdow
();

92 
	g$w
->
In
("erraddsave.php","js/blank.js","POST");

93 
	g$w
->
AddHidd
("fmdo","yes");

94 
	g$w
->
AddHidd
("do",
$do
);

95 
	g$w
->
AddHidd
("id",
$id
);

96 
	g$w
->
AddT
("你确实要删除“ $id ”这些错误提示？");

97 
	g$wfm
 = 
$w
->
GWdow
("ok");

98 
	g$w
->
Diy
();

99 
ex
();

101 
ex
();

104 
	g$sql
 = "Select * From `#@__erradd`";

105 
	g$dli
 = 
w
 
DaLiCP
();

106 
	g$dli
->
STem
(
DEDEADMIN
."/templets/erradd.htm");

107 
	g$dli
->
SSour
(
$sql
);

108 
	g$dli
->
diy
();

	@dede/exit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 
que_
(
DEDEINC
.'/userlogin.class.php');

4 
	g$curLog
 = 
w
 
urLog
();

5 
	g$curLog
->
exUr
();

6 if(
	$emy
(
$edo
))

8 
	`hd
('location:index.php');

9 
	}
}

12 
	g$msg
 = "<scriptanguage='javascript'>

13 if(
documt
.
l

wdow
.
ݒ
=
ue
;

14 
	gwdow
.
o
();

15 </
	gst
>";

16 
echo
 
	g$msg
;

	@dede/feedback_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Feedback');

4 
	g$id
 = 
ist
(
$id
&& 
is_numic
($id) ? $id : 0;

5 
	g$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL'])? "feedback_main.php" : $_COOKIE['ENV_GOBACK_URL'];

6 if(
	$emy
(
$do
))

8 
$do
 = "";

9 
	}
}

10 if(
	g$do
=='edit')

12 
$msg
 = 
_subrR
($msg,2500);

13 
	g$admmsg
 = 
im
(
$admmsg
);

14 if(
	g$admmsg
!="")

16 
$admmsg
 = 
_subrR
($adminmsg,1500);

17 
	g$admmsg
 = 
r_a
("<","&;",
$admmsg
);

18 
	g$admmsg
 = 
r_a
(">","&gt;",
$admmsg
);

19 
	g$admmsg
 = 
r_a
(" ","&nb;&nb;",
$admmsg
);

20 
	g$admmsg
 = 
r_a
("\r\n","<br/>\n",
$admmsg
);

21 
	g$msg
 = 
$msg
."<br/>\n"."<font color=red>管理员回复： $adminmsg</font>\n";

23 
	g$quy
 = "update `#@__feedback` set username='$username',msg='$msg',ischeck=1 where id=$id";

24 
	g$dsql
->
ExecuNeQuy
(
$quy
);

25 
ShowMsg
("成功回复一则留言！",
$ENV_GOBACK_URL
);

26 
ex
();

28 
	g$quy
 = "select * from `#@__feedback` where id=$id";

29 
	g$row
 = 
$dsql
->
GO
(
$quy
);

30 
ude
 
DedeInude
('templets/feedback_edit.htm');

	@dede/feedback_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

5 
CheckPurvw
('sys_Feedback');

6 
que_
(
DEDEINC
."/datalistcp.class.php");

7 
que_
(
DEDEINC
."/typelink.class.php");

8 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

10 
funi
 
	$IsCheck
(
$
)

12  
$
==1 ? "[已审核]" : "<font color='red'>[未审核]</font>";

13 
	}
}

15 if(!
	$emy
(
$job
))

17 
$ids
 = 
	`eg_a
("[^0-9,]",'',
$fid
);

18 if(
	`emy
(
$ids
))

20 
	`ShowMsg
("你没选中任何选项！",
$_COOKIE
['ENV_GOBACK_URL'],0,500);

21 
ex
;

23 
	}
}

26 
	g$job
 = '';

30 if
	g$job
 == 'del' )

32 
$quy
 = "Delete From `#@__feedback` where id in($ids) ";

33 
	g$dsql
->
ExecuNeQuy
(
$quy
);

34 
ShowMsg
("成功删除指定的评论!",
$_COOKIE
['ENV_GOBACK_URL'],0,500);

35 
ex
();

38 if
	g$job
 == 'delall' )

40 
$dsql
->
SQuy
("Select ip From `#@__feedback` where id in ($ids) ");

41 
	g$dsql
->
Execu
();

42 
	g$s
 = '';

43 
	g$row
 = 
$dsql
->
GAay
())

45 
$s
 .= ($ips=='' ? " ip = '{$row['ip']}' " : " Or ip = '{$row['ip']}' ");

47 if(
	g$s
!='')

49 
$quy
 = "Delete From `#@__feedback` where $ips ";

50 
	g$dsql
->
ExecuNeQuy
(
$quy
);

52 
ShowMsg
("成功删除指定相同IP的所有评论!",
$_COOKIE
['ENV_GOBACK_URL'],0,500);

53 
ex
();

56 if(
	g$job
=='check')

58 
$quy
 = "Update `#@__feedback` set ischeck=1 where id in($ids) ";

59 
	g$dsql
->
ExecuNeQuy
(
$quy
);

60 
ShowMsg
("成功审核指定评论!",
$_COOKIE
['ENV_GOBACK_URL'],0,500);

61 
ex
();

66 
	g$bgc
 = '';

67 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

68 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

69 
	g$keywd
 = !
ist
(
$keywd
) ? '' : $keyword;

70 
	g$
 = !
ist
(
$
) ? '' : $ip;

72 
	g$
 = 
w
 
TyLk
(
$tyid
);

73 
	g$ݒy
 = 
$
->
GOiAay
(
$tyid
,
$adm_logs
,0);

75 
	g$addsql
 = (
$tyid
 !0 ? " Andyid i(".
GSIds
($typeid).")" : '');

76 
	g$addsql
 .(
$aid
 != 0 ? " Andid=$aid " : '');

77 
	g$addsql
 .(
$
 != '' ? " And ipike '$ip' " : '');

78 
	g$quyrg
 = "select * from `#@__feedback` where msgike '%$keyword%' $addsql order by dtime desc";

80 
	g$dli
 = 
w
 
DaLiCP
();

81 
	g$dli
->
	ggeSize
 = 15;

82 
	g$dli
->
SPam
('aid', 
$aid
);

83 
	g$dli
->
SPam
('', 
$
);

84 
	g$dli
->
SPam
('tyid', 
$tyid
);

85 
	g$dli
->
SPam
('keywd', 
$keywd
);

86 
	g$dli
->
STeme
(
DEDEADMIN
.'/templets/feedback_main.htm');

87 
	g$dli
->
SSour
(
$quyrg
);

88 
	g$dli
->
Diy
();

	@dede/file_class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('');

8 as
	cFeMagemt


10 
v
 
	m$baD
="";

11 
v
 
	m$aiveD
="";

15 
v
 
	m$lowDeD
=0;

18 
funi
 
	$In
()

20 
glob
 
$cfg_bad
, 
$aivh
;

21 
$this
->
baD
 = 
$cfg_bad
;

22 
$this
->
aiveD
 = 
$aivh
;

26 
funi
 
	$RameFe
(
$dme
,
$wme
)

28 
$dme
 = 
$this
->
baD
.$this->
aiveD
."/".$oldname;

29 
$wme
 = 
$this
->
baD
.$this->
aiveD
."/".$newname;

30 if((
$wme
!=
$dme
&& 
	`is_wrab
($oldname))

32 
	`me
(
$dme
,
$wme
);

34 
	`ShowMsg
("成功更改一个文件名！","fe_mage_ma.php?aivh=".
$this
->
aiveD
);

36 
	}
}

39 
funi
 
	$NewD
(
$dme
)

41 
$wd
 = 
$dme
;

42 
$dme
 = 
$this
->
baD
.$this->
aiveD
."/".$dirname;

43 if(
	`is_wrab
(
$this
->
baD
.$this->
aiveD
))

45 
	`MkdA
(
$dme
,
$GLOBALS
['cfg_dir_purview']);

46 
	`CloF
();

47 
	`ShowMsg
("成功创建一个新目录！","fe_mage_ma.php?aivh=".
$this
->
aiveD
."/".
$wd
);

52 
	`ShowMsg
("创建新目录失败，因为这个位置不允许写入！","fe_mage_ma.php?aivh=".
$this
->
aiveD
);

55 
	}
}

58 
funi
 
	$MoveFe
(
$mfe
,
$mth
)

60 if(
$mth
!="" && !
	`eg
("\.\.",$mpath))

62 
$dfe
 = 
$this
->
baD
.$this->
aiveD
."/$mfile";

63 
$mth
 = 
	`r_a
("\\","/",$mpath);

64 
$mth
 = 
	`eg_a
("/{1,}","/",$mpath);

65 if(!
	`eg
("^/",
$mth
))

67 
$mth
 = 
$this
->
aiveD
."/".$mpath;

69 
$uh
 = 
$this
->
baD
.
$mth
;

70 if(
	`is_adab
(
$dfe
&& is_adab(
$uh
&& 
	`is_wrab
($truepath))

72 if(
	`is_d
(
$uh
))

74 
	`cy
(
$dfe
,
$uh
."/$mfile");

78 
	`MkdA
(
$uh
,
$GLOBALS
['cfg_dir_purview']);

79 
	`CloF
();

80 
	`cy
(
$dfe
,
$uh
."/$mfile");

82 
	`uƚk
(
$dfe
);

83 
	`ShowMsg
("成功移动文件！","file_manage_main.php?activepath=$mpath",0,1000);

88 
	`ShowMsg
("移动文件 $oldfile -&gt; $truepath/$mfile 失败，可能是某个位置权限不足！","file_manage_main.php?activepath=$mpath",0,1000);

94 
	`ShowMsg
("对不起，你移动的路径不合法！","-1",0,5000);

97 
	}
}

104 
funi
 
	$RmDFes
(
$d
)

106 if(!
	`is_d
(
$d
))

110 
$dh
 = 
	`d
(
$d
);

111 
$fame
 = 
$dh
->
	`ad
())

113 if(
$fame
 == "." || $filename == "..")

117 if(
	`is_fe
("$indir/$filename"))

119 @
	`uƚk
("$indir/$filename");

123 
$this
->
	`RmDFes
("$indir/$filename");

126 
$dh
->
	`o
();

127 @
	`rmd
(
$d
);

128 
	}
}

137 
funi
 
	$GMchFes
(
$d
,
$fxp
,&
$f
)

139 
$dh
 = 
	`d
(
$d
);

140 
$fame
 = 
$dh
->
	`ad
())

142 
$uefe
 = 
$d
.'/'.
$fame
;

143 if(
$fame
 == "." || $filename == "..")

147 if(
	`is_d
(
$uefe
))

149 
$this
->
	`GMchFes
(
$uefe
,
$fxp
,
$f
);

151 if(
	`eg_mch
("/\.(".
$fxp
.")/i",
$fame
))

153 
$f
[] = 
$uefe
;

156 
$dh
->
	`o
();

157 
	}
}

165 
funi
 
	$DeFe
(
$fame
)

167 
$fame
 = 
$this
->
baD
.$this->
aiveD
."/$filename";

168 if(
	`is_fe
(
$fame
))

170 @
	`uƚk
(
$fame
); 
$t
="文件";

174 
$t
 = "目录";

175 if(
$this
->
lowDeD
==1)

177 
$this
->
	`RmDFes
(
$fame
);

180 
	`ShowMsg
("成功删除一个".
$t
."！","fe_mage_ma.php?aivh=".
$this
->
aiveD
);

182 
	}
}

186 as
	cSU


188 
v
 
	m$tٮsize
=0;

190 
funi
 
	$checksize
(
$d
)

192 
$dh
=
	`d
(
$d
);

193 
$fame
=
$dh
->
	`ad
())

195 if(!
	`eg
("^\.",
$fame
))

197 if(
	`is_d
("$indir/$filename"))

199 
$this
->
	`checksize
("$indir/$filename");

203 
$this
->
tٮsize
=$this->tٮsiz+ 
	`fesize
("$indir/$filename");

209 
funi
 
	$tkb
(
$size
)

211 
$size
=$size/1024;

213 if(
$size
>0)

215 
	`li
(
$t1
,
$t2
)=
	`exode
(".",
$size
);

216 
$size
=
$t1
.".".
	`subr
(
$t2
,0,1);

218  
$size
;

219 
	}
}

221 
funi
 
	$tmb
(
$size
)

223 
$size
=$size/1024/1024;

224 if(
$size
>0)

226 
	`li
(
$t1
,
$t2
)=
	`exode
(".",
$size
);

227 
$size
=
$t1
.".".
	`subr
(
$t2
,0,2);

229  
$size
;

230 
	}
}

	@dede/file_manage_control.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_文件管理器');

4 
que
(
DEDEINC
."/oxwindow.class.php");

5 
que_
(
DEDEADMIN
.'/file_class.php');

6 
	g$aivh
 = 
r_a
("..","",
$aivh
);

7 
	g$aivh
 = 
eg_a
("^/{1,}","/",
$aivh
);

8 if(
	g$aivh
 == "/")

10 
$aivh
 = "";

12 if(
	g$aivh
 == "")

14 
$th
 = 
$cfg_bad
;

18 
	g$th
 = 
$cfg_bad
.
$aivh
;

22 
	g$fmm
 = 
w
 
FeMagemt
();

23 
	g$fmm
->
In
();

28 if(
	g$fmdo
=="rename")

30 
$fmm
->
RameFe
(
$dfame
,
$wfame
);

38 if(
	g$fmdo
=="newdir")

40 
$fmm
->
NewD
(
$wth
);

48 if(
	g$fmdo
=="move")

50 
$fmm
->
MoveFe
(
$fame
,
$wth
);

58 if(
	g$fmdo
=="del")

60 
$fmm
->
DeFe
(
$fame
);

68 if(
	g$fmdo
=="edit")

70 
$fame
 = 
r_a
("..","",$filename);

71 
	g$fe
 = "$cfg_basedir$activepath/$filename";

72 
	g$r
 = 
rashes
(
$r
);

73 
	g$
 = 
fݒ
(
$fe
,"w");

74 
uts
(
$
,
$r
);

75 
fo
(
$
);

76 if(
emy
(
$backu
))

78 
ShowMsg
("成功保存一个文件！","file_manage_main.php?activepath=$activepath");

82 
ShowMsg
("成功保存文件！",
$backu
);

84 
ex
();

110 if(
	g$fmdo
=="upload")

112 
$j
=0;

113 
	g$i
=1;$i<=50;$i++)

115 
	g$upfe
 = "upfe".
$i
;

116 
	g$upfe_me
 = "upfe".
$i
."_name";

117 if(!
ist
(
$
{
$upfe
}|| !ist(${
$upfe_me
}))

121 
	g$upfe
 = 
$
{
$upfe
};

122 
	g$upfe_me
 = 
$
{
$upfe_me
};

123 if(
is_uded_fe
(
$upfe
))

125 if(!
fe_exis
(
$cfg_bad
.
$aivh
."/".
$upfe_me
))

127 
move_uded_fe
(
$upfe
,
$cfg_bad
.
$aivh
."/".
$upfe_me
);

129 @
uƚk
(
$upfe
);

130 
	g$j
++;

133 
ShowMsg
("成功上传 $j 个文件到: $activepath","file_manage_main.php?activepath=$activepath");

134 
ex
();

138 if(
	g$fmdo
=="space")

140 if(
$aivh
=="")

142 
$eh
 = "所有目录";

146 
	g$eh
 = 
$aivh
;

148 
	g$t˚fo
 = "目录 <a href='file_manage_main.php?activepath=$activepath'><b><u>$ecpath</u></b></a> 空间使用状况：<br/>";

149 
	g$wt
 = "文件管理";

150 
	g$wecome_fo
 = "文件管理::空间大小检查 [<a href='file_manage_main.php?activepath=$activepath'>文件浏览器</a>]</a>";

151 
	g$aivh
=
$cfg_bad
.
$aivh
;

152 
	g$a
 = 
w
 
SU
;

153 
	g$a
->
checksize
(
$aivh
);

154 
	g$tٮ
=
$a
->
tٮsize
;

155 
	g$tٮkb
=
$a
->
tkb
(
$tٮ
);

156 
	g$tٮmb
=
$a
->
tmb
(
$tٮ
);

157 
	g$w
 = 
w
 
OxWdow
();

158 
	g$w
->
In
("","js/blank.js","POST");

159 
	g$w
->
AddT
(
$t˚fo
);

160 
	g$w
->
AddMsgIm
("　　$totalmb M<br/>　　$totalkb KB<br/>　　$total 字节");

161 
	g$wfm
 = 
$w
->
GWdow
("");

162 
	g$w
->
Diy
();

	@dede/file_manage_main.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_文件管理器');

4 if(!
	$ist
(
$aivh
))

6 
$aivh
=
$cfg_cmh
;

7 
	}
}

8 
	g$th
 = "";

9 
	g$aivh
 = 
r_a
("..","",
$aivh
);

10 
	g$aivh
 = 
eg_a
("^/{1,}","/",
$aivh
);

11 if(
	g$aivh
 == "/")

13 
$aivh
 = "";

15 if(
	g$aivh
 == "")

17 
$th
 = 
$cfg_bad
;

21 
	g$th
 = 
$cfg_bad
.
$aivh
;

23 
	g$aiveu
 = 
$aivh
;

24 if(
	$egi
(
$cfg_ms_d
,
$aivh
))

26 
$iems
 = 
ue
;

27 
	}
}

30 
	g$iems
 = 
l
;

32 
ude
 
DedeInude
('templets/file_manage_main.htm');

	@dede/file_manage_view.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_文件管理器');

4 
que_
(
DEDEINC
."/oxwindow.class.php");

5 
	g$aivh
 = 
r_a
("..","",
$aivh
);

6 
	g$aivh
 = 
eg_a
("^/{1,}","/",
$aivh
);

7 if(
	g$aivh
 == "/")

9 
$aivh
 = "";

11 if(
	g$aivh
 == "")

13 
$th
 = 
$cfg_bad
;

17 
	g$th
 = 
$cfg_bad
.
$aivh
;

22 if(
	g$fmdo
=="rename")

24 if(
$aivh
=="")

26 
$ndrg
 = "根目录";

28 
	g$ndrg
 = 
$aivh
;

29 
	g$wt
 = "文件管理";

30 
	g$wecome_fo
 = "文件管理::更改文件名 [<a href='file_manage_main.php?activepath=$activepath'>文件浏览器</a>]</a>";

31 
	g$w
 = 
w
 
OxWdow
();

32 
	g$w
->
In
("file_manage_control.php","js/blank.js","POST");

33 
	g$w
->
AddHidd
("fmdo",
$fmdo
);

34 
	g$w
->
AddHidd
("aivh",
$aivh
);

35 
	g$w
->
AddHidd
("fame",
$fame
);

36 
	g$w
->
AddT
("更改文件名，当前路径：$ndirstring");

37 
	g$w
->
AddIm
("旧名称：","<inputame='oldfilename'ype='input' id='oldfilename' size='40' value='$filename'>");

38 
	g$w
->
AddIm
("新名称：","<inputame='newfilename'ype='input' size='40' id='newfilename'>");

39 
	g$wfm
 = 
$w
->
GWdow
("ok");

40 
	g$w
->
Diy
();

44 if(
	g$fmdo
=="newdir")

46 if(
$aivh
=="")

48 
$aivhme
="根目录";

52 
	g$aivhme
=
$aivh
;

54 
	g$wt
 = "文件管理";

55 
	g$wecome_fo
 = "文件管理::新建目录 [<a href='file_manage_main.php?activepath=$activepath'>文件浏览器</a>]</a>";

56 
	g$w
 = 
w
 
OxWdow
();

57 
	g$w
->
In
("file_manage_control.php","js/blank.js","POST");

58 
	g$w
->
AddHidd
("fmdo",
$fmdo
);

59 
	g$w
->
AddHidd
("aivh",
$aivh
);

60 
	g$w
->
AddT
("当前目录 $activepathname ");

61 
	g$w
->
AddIm
("新目录：","<inputame='newpath'ype='input' id='newpath'>");

62 
	g$wfm
 = 
$w
->
GWdow
("ok");

63 
	g$w
->
Diy
();

67 if(
	g$fmdo
=="move")

69 
$wt
 = "文件管理";

70 
	g$wecome_fo
 = "文件管理::移动文件 [<a href='file_manage_main.php?activepath=$activepath'>文件浏览器</a>]</a>";

71 
	g$w
 = 
w
 
OxWdow
();

72 
	g$w
->
In
("file_manage_control.php","js/blank.js","POST");

73 
	g$w
->
AddHidd
("fmdo",
$fmdo
);

74 
	g$w
->
AddHidd
("aivh",
$aivh
);

75 
	g$w
->
AddHidd
("fame",
$fame
);

76 
	g$w
->
AddT
("新位置前面不加'/'表示相对于当前位置，加'/'表示相对于根目录。");

77 
	g$w
->
AddIm
("被移动文件：",
$fame
);

78 
	g$w
->
AddIm
("当前位置：",
$aivh
);

79 
	g$w
->
AddIm
("新位置：","<inputame='newpath'ype='input' id='newpath' size='40'>");

80 
	g$wfm
 = 
$w
->
GWdow
("ok");

81 
	g$w
->
Diy
();

85 if(
	g$fmdo
=="del")

87 
$wt
 = "文件管理";

88 
	g$wecome_fo
 = "文件管理::删除文件 [<a href='file_manage_main.php?activepath=$activepath'>文件浏览器</a>]</a>";

89 
	g$w
 = 
w
 
OxWdow
();

90 
	g$w
->
In
("file_manage_control.php","js/blank.js","POST");

91 
	g$w
->
AddHidd
("fmdo",
$fmdo
);

92 
	g$w
->
AddHidd
("aivh",
$aivh
);

93 
	g$w
->
AddHidd
("fame",
$fame
);

94 if(@
is_d
(
$cfg_bad
.
$aivh
."/$filename"))

96 
	g$wmsg
 = "你确信要删除目录：$filename 吗？";

100 
	g$wmsg
 = "你确信要删除文件：$filename 吗？";

102 
	g$w
->
AddT
("删除文件确认");

103 
	g$w
->
AddMsgIm
(
$wmsg
,"50");

104 
	g$wfm
 = 
$w
->
GWdow
("ok");

105 
	g$w
->
Diy
();

109 if(
	g$fmdo
=="edit")

111 if(!
ist
(
$backu
))

113 
$backu
 = "";

116 
	g$aivh
 = 
r_a
("..","",
$aivh
);

117 
	g$fame
 = 
r_a
("..","",
$fame
);

118 
	g$fe
 = "$cfg_basedir$activepath/$filename";

119 
	g$cڋ
 = "";

120 if(
is_fe
(
$fe
))

122 
	g$
 = 
fݒ
(
$fe
,"r");

123 
	g$cڋ
 = 
d
(
$
,
fesize
(
$fe
));

124 
fo
(
$
);

125 
	g$cڋ
 = 
htmleclchs
(
$cڋ
);

127 
	g$cڋVw
 = "<textareaame='str' style='width:100%;height:450px;background:#F3FCE2;'>$content</textarea>\r\n";

128 
	g$GLOBALS
['fame'] = 
$fame
;

129 
	g$p
 = 
w
 
DedeTagP
();

130 
	g$p
->
LdTeme
(
DEDEADMIN
."/templets/file_edit.htm");

131 
	g$p
->
diy
();

165 if(
	g$fmdo
=="newfile")

167 
$cڋ
 = "";

168 
	g$GLOBALS
['filename'] = "newfile.txt";

169 
	g$cڋVw
 = "<textareaame='str' style='width:100%;height:400'></textarea>\r\n";

170 
	g$p
 = 
w
 
DedeTagP
();

171 
	g$p
->
LdTeme
(
DEDEADMIN
."/templets/file_edit.htm");

172 
	g$p
->
diy
();

176 if(
	g$fmdo
=="upload")

178 
$p
 = 
w
 
DedeTagP
();

179 
	g$p
->
LdTeme
(
DEDEADMIN
."/templets/file_upload.htm");

180 
	g$p
->
diy
();

	@dede/file_pic_view.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('pic_view');

4 if(
	$emy
(
$aivh
))

6 
$aivh
=
$cfg_meds_d
;

7 
	}
}

8 
	g$aivh
 = 
eg_a
("/{1,}","/",
$aivh
);

9 
	g$uePh
 = 
$cfg_bad
.
$aivh
;

10 
	g$liSize
=5;

11 
ude
 
DedeInude
('templets/file_pic_view.htm');

13 
funi
 
	$GPPh
(
$nowPh
)

15 if(
$nowPh
==""||$nowPath=="/")

17 
	`echo
("当前为根目录\n");

21 
$ds
 = 
	`l
("/",
$nowPh
);

22 
$nowPh
 = "";

23 
$i
=1;$i<
	`cou
(
$ds
)-1;$i++)

25 
$nowPh
 ."/".
$ds
[
$i
];

27 
	`echo
("<hf=\"pic_vw.php?aivh=".
$nowPh
."\">转到上级目录</a>\n");

29 
	}
}

31 
funi
 
	$LiPic
(
$uePh
,
$nowPh
)

33 
glob
 
$liSize
;

34 
$c
=0;

35 
$rowdd
=0;

36 
$rowdd
++;

37 
$imgfe
="";

38 
$uePh
 = 
	`eg_a
("/$","",eg_a("\\{1,}","/",
	`im
($truePath)));

39 
$nowPh
 = 
	`eg_a
("/$","",eg_a("/{1,}","/",
	`im
($nowPath)));

40 
$dh
 = 
	`d
(
$uePh
);

41 
	`echo
("<trlign='center'>\n");

42 
$fame
=
$dh
->
	`ad
())

44 if(!
	`eg
("\.$",
$fame
))

46 
$fuName
 = 
$uePh
."/".
$fame
;

47 
$feU
 = 
$nowPh
."/".
$fame
;

48 if(
	`is_d
(
$fuName
))

50 if(
$c
%
$liSize
==0&&$col!=0)

52 
	`echo
("</tr>\n<trlign='center'>\n");

53 
$i
=
$rowdd
-
$liSize
;$i<$rowdd;$i++)

55 
	`echo
("<td>".
$fi
[
$i
]."</td>\n");

57 
	`echo
("</tr>\n<trlign='center'>\n");

59 
$le
 = "

60 <
td
>

61 <
b
 
width
='106' 
height
='106' 
bd
='0' 
ηddg
='0' 
Υacg
='1' 
bgc
='#CCCCCC'>

62 <

><
td
 
ign
='' 
bgc
='#FFFFFF'>

63 <
a
 
hf
='pic_view.php?activepath=".$fileUrl."'>

64 <
img
 
c
='img/pic_d.gif' 
width
='44' 
height
='42' 
bd
='0'>

65 </
a
></
td
></

></
b
></td>";

66 
$fi
[
$rowdd
] = 
$fame
;

67 
$c
++;

68 
$rowdd
++;

69 
echo
 
$le
;

71 if(
	`IsImg
(
$fame
))

73 if(
$c
%
$liSize
==0&&$col!=0)

75 
	`echo
("</tr>\n<trlign='center'>\n");

76 
$i
=
$rowdd
-
$liSize
;$i<$rowdd;$i++)

78 
	`echo
("<td>".
$fi
[
$i
]."</td>\n");

80 
	`echo
("</tr>\n<trlign='center'>\n");

82 
$le
 = "

83 <
td
>

84 <
b
 
width
='106' 
height
='106' 
bd
='0' 
ηddg
='0' 
Υacg
='1' 
bgc
='#CCCCCC'>

85 <

>

86 <
td
 
ign
='' 
bgc
='#FFFFFF'>

88 </
td
>

89 </

></
b
></
td
>";

90 
$fi
[
$rowdd
] = 
$fame
;

91 
$c
++;

92 
$rowdd
++;

93 
echo
 
$le
;

97 
	`echo
("</tr>\n");

98 if(!
	`emy
(
$fi
))

100 
	`echo
("<trlign='center'>\n");

101 
$t
 = (
$rowdd
-1)%
$liSize
;

102 if(
$t
==0)

104 
$t
=
$liSize
;

106 
$i
=
$rowdd
-
$t
;$i<$rowdd;$i++)

108 
	`echo
("<td>".
$fi
[
$i
]."</td>\n");

110 
	`echo
("</tr>\n");

112 
	}
}

114 
funi
 
	$GImgFe
(
$uePh
,
$nowPh
,
$feName
)

116 
$toW
=102;

117 
$toH
=102;

118 
$cFe
 = 
$uePh
."/".
$feName
;

119 
$fo
 = "";

120 
$da
 = 
	`GImageSize
(
$cFe
,
$fo
);

121 
$cW
=
$da
[0];

122 
$cH
=
$da
[1];

123 if(
$toW
>=
$cW
&&
$toH
>=
$cH
)

125 
$oW
=
$cW
;

126 
$oH
=
$cH
;

130 
$toWH
=
$toW
/
$toH
;

131 
$cWH
=
$cW
/
$cH
;

132 if(
$toWH
<=
$cWH
)

134 
$oW
=
$toW
;

135 
$oH
=
$oW
*(
$cH
/
$cW
);

139 
$oH
=
$toH
;

140 
$oW
=
$oH
*(
$cW
/
$cH
);

143 ("<hf='".
$nowPh
."/".
$feName
."'g='_bnk'><img src='".$nowPh."/".$feName."' width='".
$oW
."' height='".
$oH
."' border='0'></a>");

144 
	}
}

146 
funi
 
	$IsImg
(
$feName
)

148 if(
	`eg
("\.(jpg|gif|g)$",
$feName
))  1;

150 
	}
}

	@dede/freelist_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_FreeList');

4 if(!
	$ist
(
$tys
))

6 
$tys
 = '';

7 
	}
}

8 if(!
	$ist
(
$nodeu
))

10 
$nodeu
 = '0';

11 
	}
}

15 if(
	g$do
=='addnew')

17 
$ts
 = "agesize='$pagesize' col='$col'itlelen='$titlelen' orderby='$orderby' orderway='$order' ";

18 
	g$y
 = '';

19 
	g$edtime
 = 
time
();

20 if(
emy
(
$chl
))

22 
showmsg
('频道类型不能为空','-1');

23 
ex
();

25 if(
is_y
(
$tys
))

27 
fܗch
(
$tys
 
as
 
$v

	g$y
 .= $v.' ';

29 if(
	g$y
!='')

31 
$ts
 ."y='".
im
(
$y
)."' ";

33 if(!
emy
(
$tyid
))

35 
	g$ts
 .= "ypeid='$typeid' ";

37 if(!
emy
(
$chl
))

39 
	g$ts
 .= " channel='$channel' ";

41 if(!
emy
(
$subday
))

43 
	g$ts
 .= " subday='$subday' ";

45 if(!
emy
(
$tn
))

47 
	g$ts
 .= " keyword='$keyword' ";

49 if(!
emy
(
$t
))

51 
	g$ts
 .= "tt='$att' ";

53 
	g$ùext
 = 
im
(
$ùext
);

54 if(!
emy
(
$ùext
))

56 
	g$ùext
 = 
rashes
(
$ùext
);

58 
	g$liTag
 = "{dede:list $atts}$innertext{/dede:list}";

59 
	g$liTag
 = 
addashes
(
$liTag
);

60 
	g$quy
 = "

61 
INSERT
 
INTO
 `#@
__li
`(`
t
` , `
	gmu
` , `
	glid
` , `
	gdeuɷge
` , `
	gnodeu
` , `
	gm
` , `
	gedtime
` , `
	gick
` , `
	glig
` , `
	gkeywd
` , `
	gdesti
`)

62 
VALUES
 ('$title','$namerule','$listdir','$defaultpage','$nodefault','$templet','$edtime','0','$listTag','$keyword','$description');

64 
	g$dsql
->
ExecuNeQuy
(
$quy
);

65 
ShowMsg
("成功增加一个自由列表!","freemenu_main.php");

66 
ex
();

72 if(
	g$do
=='edit')

74 
$ts
 = "agesize='$pagesize' col='$col'itlelen='$titlelen' orderby='$orderby' orderway='$order' \r\n";

75 
	g$y
 = '';

76 
	g$edtime
 = 
time
();

77 if(
is_y
(
$tys
))

79 
fܗch
(
$tys
 
as
 
$v
)

81 
	g$y
 .
$v
.' ';

84 if(
	g$y
!='')

86 
$ts
 ."y='".
im
(
$y
)."' ";

88 if(!
emy
(
$tyid
))

90 
	g$ts
 .= "ypeid='$typeid' ";

92 if(!
emy
(
$chl
))

94 
	g$ts
 .= " channel='$channel' ";

96 if(!
emy
(
$subday
))

98 
	g$ts
 .= " subday='$subday' ";

100 if(!
emy
(
$tn
))

102 
	g$ts
 .= " keyword='$keyword' ";

104 if(!
emy
(
$t
))

106 
	g$ts
 .= "tt='$att' ";

108 
	g$ùext
 = 
im
(
$ùext
);

109 if(!
emy
(
$ùext
))

111 
	g$ùext
 = 
rashes
(
$ùext
);

113 
	g$liTag
 = "{dede:list $atts}$innertext{/dede:list}";

114 
	g$liTag
 = 
addashes
(
$liTag
);

115 
	g$quy
 = "

116 
Upde
 `#@
__li
` 
t


117 
t
='$t', 
	gmu
='$namerule',

118 
	glid
='$lid', 
	gdeuɷge
='$defaultpage',

119 
	gnodeu
='$nodeu', 
	gm
='$templet',

120 
	gedtime
='$edtime', 
	glig
='$liTag', 
	gkeywd
='$keyword',

121 
	gdesti
='$desti' 
whe
 
aid
='$aid';

123 
	g$dsql
->
ExecuNeQuy
(
$quy
);

124 
ShowMsg
("成功更改一个自由列表!","freemenu_main.php");

125 
ex
();

	@dede/freelist_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_FreeList');

4 if(
	$emy
(
$do
))

6 
que_
 
DEDEINC
.'/typelink.class.php';

7 
ude
 
	`DedeInude
('templets/freelist_add.htm');

8 
	`ex
();

9 
	}
}

10 if(
	g$do
=='save')

12 if(!
ist
(
$tys
)) $types = '';

13 if(!
ist
(
$nodeu
)
	g$nodeu
 = '0';

14 
	g$ts
 = "agesize='$pagesize' col='$col'itlelen='$titlelen' orderby='$orderby' orderway='$order' ";

15 
	g$y
 = '';

16 
	g$edtime
 = 
time
();

17 if(
emy
(
$chl
))

19 
showmsg
('频道类型不能为空','-1');

20 
ex
();

22 if(
is_y
(
$tys
))

24 
fܗch
(
$tys
 
as
 
$v

	g$y
 .= $v.' ';

26 if(
	g$y
!=''
$ts
 ."y='".
im
(
$y
)."' ";

28 if(!
emy
(
$tyid
)
	g$ts
 .= "ypeid='$typeid' ";

30 if(!
emy
(
$chl
)
	g$ts
 .= " channel='$channel' ";

32 if(!
emy
(
$subday
)
	g$ts
 .= " subday='$subday' ";

34 if(!
emy
(
$keywdc
)
	g$ts
 .= " keyword='$keywordarc' ";

36 if(!
emy
(
$t
)
	g$ts
 .= "tt='$att' ";

38 
	g$ùext
 = 
im
(
$ùext
);

39 if(!
emy
(
$ùext
)
	g$ùext
 = 
rashes
($innertext);

41 
	g$liTag
 = "{dede:list $atts}$innertext{/dede:list}";

42 
	g$liTag
 = 
addashes
(
$liTag
);

43 
	g$quy
 = "

44 
INSERT
 
INTO
 `#@
__li
`(`
t
` , `
	gmu
` , `
	glid
` , `
	gdeuɷge
` , `
	gnodeu
` , `
	gm
` , `
	gedtime
`, `
	gmaxge
` , `
	gick
` , `
	glig
` , `
	gkeywds
` , `
	gdesti
`)

45 
VALUES
 ('$title','$namerule','$listdir','$defaultpage','$nodefault','$templet','$edtime', '$maxpage','0','$listTag','$keywords','$description');

47 
	g$dsql
->
ExecuNeQuy
(
$quy
);

48 
ShowMsg
("成功增加一个自由列表!", "freelist_main.php");

49 
ex
();

	@dede/freelist_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
	$emy
(
$do
))

5 
que_
 
DEDEINC
.'/typelink.class.php';

6 
que_
 
DEDEINC
.'/dedetag.class.php';

7 
$aid
 = 
	`ist
($aid&& 
	`is_numic
($aid) ? $aid : 0;

8 
$row
 = 
$dsql
->
	`GO
("Select * From `#@__freelist` whereid='$aid' ");

9 
$d
 = 
w
 
	`DedeTagP
();

10 
$d
->
	`SNameS
("dede","{","}");

11 
$d
->
	`LdSour
("--".
$row
['listtag']."--");

12 
$ag
 = 
$d
->
	`GTag
('list');

13 
ude
 
	`DedeInude
('templets/freelist_edit.htm');

14 
	`ex
();

15 
	}
}

16 if
	g$do
=='save' )

18 if(!
ist
(
$tys
)) $types = '';

19 if(!
ist
(
$nodeu
)
	g$nodeu
 = '0';

20 
	g$ts
 = "agesize='$pagesize' col='$col'itlelen='$titlelen' orderby='$orderby' orderway='$order' \r\n";

21 
	g$y
 = '';

22 
	g$edtime
 = 
time
();

23 if(
is_y
(
$tys
))

25 
fܗch
(
$tys
 
as
 
$v

	g$y
 .= $v.' ';

27 if(
	g$y
!=''
$ts
 ."y='".
im
(
$y
)."' ";

29 if(!
emy
(
$tyid
)
	g$ts
 .= "ypeid='$typeid' ";

31 if(!
emy
(
$chl
)
	g$ts
 .= " channel='$channel' ";

33 if(!
emy
(
$subday
)
	g$ts
 .= " subday='$subday' ";

35 if(!
emy
(
$keywdc
)
	g$ts
 .= " keyword='$keywordarc' ";

37 if(!
emy
(
$t
)
	g$ts
 .= "tt='$att' ";

39 
	g$ùext
 = 
im
(
$ùext
);

40 if(!
emy
(
$ùext
)
	g$ùext
 = 
rashes
($innertext);

42 
	g$liTag
 = "{dede:list $atts}$innertext{/dede:list}";

43 
	g$liTag
 = 
addashes
(
$liTag
);

44 
	g$quy
 = "

45 
Upde
 `#@
__li
` 
t


46 
t
='$t', 
	gmu
='$namerule',

47 
	glid
='$lid', 
	gdeuɷge
='$defaultpage',

48 
	gnodeu
='$nodeu', 
	gm
='$templet',

49 
	gedtime
='$edtime', `
	gmaxge
`='$maxge', 
	glig
='$liTag', 
	gkeywds
='$keywords',

50 
	gdesti
='$desti' 
whe
 
aid
='$aid';

52 
	g$dsql
->
ExecuNeQuy
(
$quy
);

53 
ShowMsg
("成功更改一个自由列表!","freelist_main.php");

54 
ex
();

	@dede/freelist_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_FreeList');

4 
que_
 
	gDEDEINC
.'/channelunit.func.php';

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 if(
	$emy
(
$gesize
))

8 
$gesize
 = 18;

9 
	}
}

10 if(
	$emy
(
$go
))

12 
$go
 = 1;

13 
	}
}

14 if(
	$emy
(
$do
))

16 
$do
 = '';

17 
	}
}

18 if(
	$emy
(
$dby
))

20 
$dby
 = 'aid';

21 
	}
}

22 if(
	$emy
(
$keywd
))

24 
$keywd
 = '';

25 
$addg
 = '';

26 
$addsql
 = '';

27 
	}

	g}


29 
	g$addg
 = '&keywd='.
ucode
(
$keywd
);

30 
	g$addsql
 = " whereitleike '%$keyword%' ";

34 if(
	g$do
=='getlist')

36 
AjaxHd
();

37 
GTagLi
(
$dsql
,
$go
,
$gesize
,
$dby
);

38 
ex
();

42 if(
	g$do
=='del')

44 
$aid
 = 
eg_a
("[^0-9]","",$aid);

45 
	g$dsql
->
ExecuNeQuy
("Delete From #@__freelist whereid='$aid'; ");

46 
AjaxHd
();

47 
GTagLi
(
$dsql
,
$go
,
$gesize
,
$dby
);

48 
ex
();

52 if(
	g$do
=='')

54 
$row
 = 
$dsql
->
GO
("Select count(*)s dd From #@__freelist $addsql ");

55 
	g$tٮRow
 = 
$row
['dd'];

56 
ude
(
DEDEADMIN
."/templets/freelist_main.htm");

67 
funi
 
GTagLi
(
$dsql
,
$go
,
$gesize
,
$dby
='aid')

69 
glob
 
$cfg_phpu
,
$addsql
;

70 
	g$t
 = (
$go
-1* 
$gesize
;

71 
	g$thd
 ="<table width='98%' border='0' cellpadding='1' cellspacing='1'lign='center' class='tbtitle' style='background:#E2F5BC;margin-bottom:5px;'>

72 <

 
ign
='' 
bgc
='#FBFCE2'>

73 <
td
 
width
='5%' 
ass
='tbame'><
a
 
hf
='#' 
ick
=\"ReloadPage('aid')\"><u>ID</u></a></td>

74 <
td
 
width
='20%' 
ass
='tbsname'>列表名称</td>

75 <
td
 
width
='20%' 
ass
='tbsname'>模板文件</td>

76 <
td
 
width
='5%' 
ass
='tbame'><
a
 
hf
='#' 
ick
=\"ReloadPage('click')\"><u>点击</u></a></td>

77 <
td
 
width
='15%' 
ass
='tbsname'>创建时间</td>

78 <
td
 
ass
='tbsname'>管理</td>

79 </

>\
r
\
n
";

80 
echo
 
$thd
;

81 
	g$dsql
->
SQuy
("Selectid,title,templet,click,edtime,namerule,listdir,defaultpage,nodefault From #@__freelist $addsql order by $orderby descimit $start,$pagesize ");

82 
	g$dsql
->
Execu
();

83 
	g$row
 = 
$dsql
->
GAay
())

85 
$liu
 = 
GFeLiU
(
$row
['aid'],$row['namerule'],$row['listdir'],$row['defaultpage'],$row['nodefault']);

86 
	g$le
 = "

87 <

 
ign
='' 
bgc
='#FFFFFF' 
MouMove
=\"javascript:this.bgColor='#FCFEDA';\" onMouseOut=\"javascript:this.bgColor='#FFFFFF';\">

88 <
td
>{
$row
['aid']}</td>

89 <
td
> <
a
 
hf
='$liu' 
rg
='_bnk'>{
$row
['title']}</a> </td>

90 <
td
> {
$row
['templet']} </td>

91 <
td
> {
$row
['click']} </td>

92 <
td
>".MyDe("
y
-
m
-
d
",$row['edtime'])."</td>

93 <
td
> <
a
 
hf
='#' 
ick
='EdNe({$row['
aid
']})'>更改</a> |

94 <
a
 
hf
='#' 
ick
='CeNe({$row['
aid
']})'>更新</a> |

95 <
a
 
hf
='#' 
ick
='DNe({$row['
aid
']})'>删除</a>

96 </
td
>

97 </

>";

98 
echo
 
$le
;

100 
	gecho
 "</table>\r\n";

	@dede/freemenu_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_FreeList');

4 
que_
 
	gDEDEINC
.'/channelunit.func.php';

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 if(
	$emy
(
$gesize
))

8 
$gesize
 = 18;

9 
	}
}

10 if(
	$emy
(
$go
))

12 
$go
 = 1;

13 
	}
}

14 if(
	$emy
(
$do
))

16 
$do
 = '';

17 
	}
}

18 if(
	$emy
(
$dby
))

20 
$dby
 = 'aid';

21 
	}
}

22 if(
	$emy
(
$keywd
))

24 
$keywd
 = '';

25 
$addg
 = '';

26 
$addsql
 = '';

27 
	}

	g}


29 
	g$addg
 = '&keywd='.
ucode
(
$keywd
);

30 
	g$addsql
 = " whereitleike '%$keyword%' ";

34 if(
	g$do
=='getlist')

36 
AjaxHd
();

37 
GTagLi
(
$dsql
,
$go
,
$gesize
,
$dby
);

38 
ex
();

42 if(
	g$do
=='del')

44 
$aid
 = 
eg_a
("[^0-9]","",$aid);

45 
	g$dsql
->
ExecuNeQuy
("Delete From #@__freelist whereid='$aid'; ");

46 
AjaxHd
();

47 
GTagLi
(
$dsql
,
$go
,
$gesize
,
$dby
);

48 
ex
();

52 if(
	g$do
=='')

54 
$row
 = 
$dsql
->
GO
("Select count(*)s dd From #@__freelist $addsql ");

55 
	g$tٮRow
 = 
$row
['dd'];

56 
ude
(
DEDEADMIN
."/templets/freemenu_main.htm");

67 
funi
 
GTagLi
(
$dsql
,
$go
,
$gesize
,
$dby
='aid')

69 
glob
 
$cfg_phpu
,
$addsql
;

70 
	g$t
 = (
$go
-1* 
$gesize
;

71 
	g$thd
 ="<table width='98%' border='0' cellpadding='1' cellspacing='1'lign='center' class='tbtitle' style='background:#E2F5BC;margin-bottom:5px;'>

72 <

 
ign
='' 
bgc
='#FBFCE2'>

73 <
td
 
width
='5%' 
ass
='tbame'><
a
 
hf
='#' 
ick
=\"ReloadPage('aid')\"><u>ID</u></a></td>

74 <
td
 
width
='20%' 
ass
='tbsname'>列表名称</td>

75 <
td
 
width
='20%' 
ass
='tbsname'>模板文件</td>

76 <
td
 
width
='5%' 
ass
='tbame'><
a
 
hf
='#' 
ick
=\"ReloadPage('click')\"><u>点击</u></a></td>

77 <
td
 
width
='15%' 
ass
='tbsname'>创建时间</td>

78 <
td
 
ass
='tbsname'>管理</td>

79 </

>\
r
\
n
";

80 
echo
 
$thd
;

81 
	g$dsql
->
SQuy
("Selectid,title,templet,click,edtime,namerule,listdir,defaultpage,nodefault From #@__freelist $addsql order by $orderby descimit $start,$pagesize ");

82 
	g$dsql
->
Execu
();

83 
	g$row
 = 
$dsql
->
GAay
())

85 
$liu
 = 
GFeLiU
(
$row
['aid'],$row['namerule'],$row['listdir'],$row['defaultpage'],$row['nodefault']);

86 
	g$le
 = "

87 <

 
ign
='' 
bgc
='#FFFFFF' 
MouMove
=\"javascript:this.bgColor='#FCFEDA';\" onMouseOut=\"javascript:this.bgColor='#FFFFFF';\">

88 <
td
>{
$row
['aid']}</td>

89 <
td
> <
a
 
hf
='$liu' 
rg
='_bnk'>{
$row
['title']}</a> </td>

90 <
td
> {
$row
['templet']} </td>

91 <
td
> {
$row
['click']} </td>

92 <
td
>".MyDe("
y
-
m
-
d
",$row['edtime'])."</td>

93 <
td
> <
a
 
hf
='#' 
ick
='EdNe({$row['
aid
']})'>更改</a> |

94 <
a
 
hf
='#' 
ick
='CeNe({$row['
aid
']})'>更新</a> |

95 <
a
 
hf
='#' 
ick
='DNe({$row['
aid
']})'>删除</a>

96 </
td
>

97 </

>";

98 
echo
 
$le
;

100 
	gecho
 "</table>\r\n";

	@dede/friendlink_add.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_友情链接模块');

4 if(
	$emy
(
$do
))

6 
$do
="";

7 
	}
}

8 if(
	g$do
=="add")

10 
$dtime
 = 
time
();

11 if(
is_uded_fe
(
$logoimg
))

13 
	g$mes
 = 
l
("\.",
$logoimg_me
);

14 
	g$sh܊ame
 = ".".
$mes
[
cou
($names)-1];

15 if(!
egi
("(jpg|gif|g)$",
$sh܊ame
))

17 
	g$sh܊ame
 = '.gif';

19 
	g$fame
 = 
MyDe
("ymdHis",
time
()).
mt_nd
(1000,9999).
	g$sh܊ame
;

20 
	g$imgu
 = 
$cfg_meds_d
."/flink";

21 if(!
is_d
(
$cfg_bad
.
$imgu
))

23 
MkdA
(
$cfg_bad
.
$imgu
,
$cfg_d_purvw
);

24 
CloF
();

26 
	g$imgu
 = 
$imgu
."/".
$fame
;

27 
move_uded_fe
(
$logoimg
,
$cfg_bad
.
$imgu


 
d
("复制文件到:".$cfg_basedir.$imgurl."失败");

28 @
uƚk
(
$logoimg
);

32 
	g$imgu
 = 
$logo
;

36 if(
emy
(
$tyid
|| 
eg
("[^0-9]", $typeid))

38 
	g$tyid
 = 0;

39 
	g$dsql
->
ExecuNeQuy
("ALTER TABLE `#@__flinktype` CHANGE `ID` `id` MEDIUMINT( 8 ) UNSIGNED DEFAULT NULL AUTO_INCREMENT; ");

42 
	g$quy
 = "Insert Into `#@__flink`(sortrank,url,webname,logo,msg,email,typeid,dtime,ischeck)

43 
Vues
('$sortrank','$url','$webname','$imgurl','$msg','$email','$typeid','$dtime','$ischeck'); ";

44 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

45 
	g$bu
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? "friendlink_main.php" : $_COOKIE['ENV_GOBACK_URL'];

46 if(
	g$rs
)

48 
ShowMsg
("成功增加一个链接!",
$bu
,0,500);

49 
ex
();

53 
ShowMsg
("增加链接时出错，请向官方反馈，原因：".
$dsql
->
GE
(),"javascript:;");

54 
ex
();

57 
ude
 
DedeInude
('templets/friendlink_add.htm');

	@dede/friendlink_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_友情链接模块');

4 
	g$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? 'friendlink_main.php' : $_COOKIE['ENV_GOBACK_URL'];

5 if(
	$emy
(
$do
))

7 
$do
 = "";

8 
	}
}

9 if(
	$ist
(
$lid
))

11 
$aids
 = 
	`exode
(',',
$lid
);

12 if(
	`cou
(
$aids
)==1)

14 
$id
 = 
$aids
[0];

15 
$do
 = "delete";

17 
	}
}

18 if(
	g$do
=="delete")

20 
$id
 = 
eg_a
("[^0-9]","",$id);

21 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__flink` where id='$id'");

22 
ShowMsg
("成功删除一个链接！",
$ENV_GOBACK_URL
);

23 
ex
();

25 if(
	g$do
=="delall")

27 
$aids
 = 
exode
(',',$aids);

28 if(
ist
(
$aids
&& 
is_y
($aids))

30 
fܗch
(
$aids
 
as
 
$aid
)

32 
	g$aid
 = 
eg_a
("[^0-9]","",
$aid
);

33 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__flink` where id='$aid'");

35 
ShowMsg
("成功删除指定链接！",
$ENV_GOBACK_URL
);

36 
ex
();

40 
ShowMsg
("你没选定任何链接！",
$ENV_GOBACK_URL
);

41 
ex
();

44 if(
	g$do
=="saveedit")

46 
$id
 = 
eg_a
("[^0-9]","",$id);

47 
	g$quy
 = "Update `#@__flink` set sortrank='$sortrank',url='$url',webname='$webname',logo='$logo',msg='$msg',

48 
ema
='$ema',
	gtyid
='$tyid',
	gischeck
='$ischeck' 
whe
 
id
='$id' ";

49 
$dsql
->
ExecuNeQuy
(
$quy
);

50 
ShowMsg
("成功更改一个链接！",
$ENV_GOBACK_URL
);

51 
ex
();

53 
	g$myLk
 = 
$dsql
->
GO
("Select #@__flink.*,#@__flinktype.typename From #@__flinkeft join #@__flinktype on #@__flink.typeid=#@__flinktype.id where #@__flink.id=$id");

54 
ude
 
DedeInude
('templets/friendlink_edit.htm');

	@dede/friendlink_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/datalistcp.class.php');

4 
tcook
('ENV_GOBACK_URL', 
$dedeNowu
, 
time
()+3600, '/');

6 if(
emy
(
$keywd
)
	g$keywd
 = '';

7 if(
	$emy
(
$ischeck
)) {

8 
$ischeck
 = 0;

9 
$ischeckSql
 = '';

10 
	}
} {

11 if(
	g$ischeck
==-1
$ischeckSql
 = " And ischeck < 1 ";

12 
	g$ischeckSql
 = " And ischeck='$ischeck' ";

15 
	g$lCheckA
 = 
y
(0=>'不限类型', -1=>'未审核', 1=>'内页', 2=>'首页');

17 
	g$sql
 = "Select * From `#@__flink` where CONCAT(`url`,`webname`,`email`)ike '%$keyword%' $ischeckSql order by dtime desc";

19 
	g$dli
 = 
w
 
DaLiCP
();

20 
	g$dli
->
SPam
('keywd', 
$keywd
);

21 
	g$dli
->
SPam
('ischeck', 
$ischeck
);

22 
	g$dli
->
STem
(
DEDEADMIN
.'/templets/friendlink_main.htm');

23 
	g$dli
->
SSour
(
$sql
);

24 
	g$dli
->
diy
();

26 
funi
 
	$GPic
(
$pic
)

28 if(
$pic
=='')  '无图标';

30 
	}
}

32 
funi
 
	$GS
(
$a
)

34 if(
$a
==1)  '内页';

35 if(
$a
==2)  '首页';

37 
	}
}

	@dede/friendlink_type.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
	$emy
(
$do
))

5 
$do
 = '';

6 
	}
}

8 if(
	g$do
=="save")

10 
$tID
 = 1;

11 
	g$dID
 = 
$idd
;

12 ;
	g$tID
<=
$dID
;$startID++)

14 
	g$quy
 = '';

15 
	g$tid
 = 
$
{'ID_'.
$tID
};

16 
	g$ame
 = 
$
{'ame_'.
$tID
};

17 if(
ist
(
$
{'check_'.
$tID
}))

19 if(
	g$ame
!='')

21 
$quy
 = "update `#@__flinktype` setypename='$pname' where id='$tid' ";

22 
	g$dsql
->
ExecuNeQuy
(
$quy
);

27 
	g$quy
 = "Delete From `#@__flinktype` where id='$tid' ";

28 
	g$dsql
->
ExecuNeQuy
(
$quy
);

32 if(
ist
(
$check_w
&& 
	g$ame_w
!='')

34 
$quy
 = "Insert Into `#@__flinktype`(typename) Values('{$pname_new}');";

35 
	g$dsql
->
ExecuNeQuy
(
$quy
);

37 
hd
("Content-Type:ext/html; charset={$cfg_soft_lang}");

38 
	gecho
 "<script>lert('成功更新友情链接网站分类表！'); </script>";

41 
ude
 
DedeInude
('templets/friendlink_type.htm');

	@dede/getdedesysmsg.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/dedehttpdown.class.php');

4 
AjaxHd
();

5 
	g$dhd
 = 
w
 
DedeHpDown
();

6 
	g$dhd
->
OnU
('http://www.dedecms.com/officialinfo.html');

7 
	g$r
 = 
im
(
$dhd
->
GHtml
());

8 
	g$dhd
->
Clo
();

9 if(
	g$cfg_so_ng
=='utf-8') {

10 
$r
 = 
gb2utf8
($str);

12 
echo
 
	g$r
;

	@dede/imagecut.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
	g$ai
 = 
ist
(
$ai
? 
	$im
(
$ai
) : '';

4 if(
	$emy
(
$ai
))

6 if(!@
	`is_fe
(
$cfg_bad
.
$fe
))

8 
	`ShowMsg
("对不起，必须选择站内的图片才能进行裁剪！<br />点击'<a href='/include/dialog/select_images.php?f=form1.picname&imgstick=small'>站内选择</a>', 上传或选择一个图片，然后才能进行裁剪！", "../include/dialog/select_images.php?f=form1.picname&imgstick=small", 0 , 10000);

9 
	`ex
();

11 
ude
 
DEDEADMIN
.'/templets/imagecut.htm';

12 
	`ex
();

13 
	}
}

14 
if
(
$ai
 == 'cut')

16 
que_
(
DEDEINC
.'/image.func.php');

18 if(!@
is_fe
(
$cfg_bad
.
$fe
))

20 
ShowMsg
('对不起，请重新选择裁剪图片！', '-1');

21 
ex
();

23 if(
emy
(
$width
))

25 
ShowMsg
('对不起，请选择裁剪图片的尺寸！', '-1');

26 
ex
();

28 if(
emy
(
$height
))

30 
ShowMsg
('对不起，请选择裁剪图片的尺寸！', '-1');

31 
ex
();

33 
	g$imgfo
 = 
gimagesize
(
$cfg_bad
.
$fe
);

34 
	g$imgw
 = 
$imgfo
[0];

35 
	g$imgh
 = 
$imgfo
[1];

36 
	g$mp
 = 400/
$imgw
;

37 
	g$wwidth
 = 400;

38 
	g$wheight
 = 
$imgh
 * 
$mp
;

39 
	g$cFe
 = 
$cfg_bad
.
$fe
;

40 
	g$thumb
 = 
imageuec
(
$wwidth
, 
$wheight
);

41 
	g$thumba
 = 
imageuec
(
$width
, 
$height
);

43 
	g$imgfo
['mime'])

46 
$sour
 = 
imageomjg
(
$cFe
);

49 
$sour
 = 
imageomgif
(
$cFe
);

52 
$sour
 = 
imageomg
(
$cFe
);

55 
ShowMsg
('对不起，裁剪图片类型不支持请选择其他类型图片！', '-1');

59 
imagecysized
(
$thumb
, 
$sour
, 0, 0, 0, 0 , 
$wwidth
, 
$wheight
, 
$imgw
, 
$imgh
);

60 
imagecy
(
$thumba
, 
$thumb
, 0, 0, 
$
, 
$t
, 
$wwidth
, 
$wheight
);

62 
	g$ddn
 = 
subr
(
$cFe
, -3);

64 
	g$ddpicok
 = 
$ObjJs
 = '';

65 if
emy
(
$isud
) )

67 
	g$ddpicok
 = 
eg_a
("\.".
$ddn
."$", '-.'.$ddn, 
$fe
);

68 
	g$ObjJs
 = " var backObj = window.opener.document.form1.picname;

69 
v
 
vObj
 = 
wdow
.
ݒ
.
documt
.
gEmtById
('divpicvw');\
	gr
\
	gn
";

73 
	g$ddpicok
 = 
$fe
;

74 
	g$ObjJs
 = " var backObj = window.opener.parent.document.form1.picname;

75 
v
 
vObj
 = 
wdow
.
ݒ
.

.
documt
.
gEmtById
('divpicvw');\
	gr
\
	gn
";

78 
	g$ddpicoku
 = 
$cfg_bad
.
$ddpicok
;

80 
	g$imgfo
['mime'])

83 
imagejg
(
$thumba
, 
$ddpicoku
, 85);

86 
imagegif
(
$thumba
, 
$ddpicoku
);

89 
imagng
(
$thumba
, 
$ddpicoku
);

92 
ShowMsg
("对不起，裁剪图片类型不支持请选择其他类型图片！", "-1");

97 if(
	g$wwidth
 > 
	g$cfg_ddimg_width
 || 
	g$wheight
 > 
	g$cfg_ddimg_height
)

99 
ImageResize
(
$ddpicoku
, 
$cfg_ddimg_width
, 
$cfg_ddimg_height
);

103 if
emy
(
$isud
) )

105 
	g$quy
 = "INSERT INTO `#@__uploads`(title,url,mediatype,width,height,playtime,filesize,uptime,mid)

106 
VALUES
 ('$ddpicok','$ddpicok','1','0','0','0','".filesize($ddpicokurl)."','".time()."','".$cuserLogin->getUserID()."'); ";

107 
	g$dsql
->
ExecuNeQuy
(
$quy
);

108 
	g$fid
 = 
$dsql
->
GLaID
();

109 
AddMyAdd
(
$fid
, 
$ddpicok
);

113 <
SCRIPT
 
	gnguage
=
JavaSt
>

114 
funi
 
RuImg
(
img
)

116 <?
php
 
echo
 
$ObjJs
; ?>

117 
	gbackObj
.
	gvue
 = 
img
;

118 if(
	gvObj
)

120 
	gvObj
.
	gy
.
	gwidth
 = '150px';

121 
	gvObj
.
	grHTML
 = "<img src='"+
img
+"?n' width='150' />";

123 if(
	gdocumt
.
	gl
) {

124 
	gwdow
.
	gݒ
=
ue
;

126 
	gwdow
.
o
();

128 
RuImg
("<?phpcho $ddpicok; ?>");

129 </
	gSCRIPT
>

130 <?
	gphp


	@dede/inc/inc_admin_channel.php

1 <?
php


3 
funi
 
	$GFldMake
(
$dty
,
$fldme
,
$dfvue
,
$mxn
)

5 
$flds
 = 
	`y
();

6 if(
$dty
=="int"||$dtype=="datetime")

8 if(
$dfvue
=="" || 
	`eg
("[^0-9-]",$dfvalue))

10 
$dfvue
 = 0;

12 
$flds
[0] = " `$fieldname` int(11) NOT NULL default '$dfvalue';";

13 
$flds
[1] = "int(11)";

15 if(
$dty
=="stepselect")

17 if(
$dfvue
=="" || 
	`eg
("[^0-9]",$dfvalue))

19 
$dfvue
 = 0;

21 
$flds
[0] = " `$fieldname` smallint(5) UNSIGNED NOT NULL default '$dfvalue';";

22 
$flds
[1] = "smallint(5)";

24 if(
$dty
=="float")

26 if(
$dfvue
=="" || 
	`eg
("[^0-9\.-]",$dfvalue))

28 
$dfvue
 = 0;

30 
$flds
[0] = " `$fieldname` float NOT NULL default '$dfvalue';";

31 
$flds
[1] = "float";

33 if(
$dty
=="img"||$dtype=="media"||$dtype=="addon"||$dtype=="imgfile")

35 if(
	`emy
(
$dfvue
))

37 
$dfvue
 = '';

39 if(
$mxn
=="")

41 
$mxn
 = 200;

43 if(
$mxn
 > 255)

45 
$mxn
 = 100;

47 
$flds
[0] = " `$fieldname` varchar($mxlen) NOT NULL default '$dfvalue';";

48 
$flds
[1] = "varchar($mxlen)";

50 if(
$dty
=="multitext"||$dtype=="htmltext")

52 
$flds
[0] = " `$fieldname` mediumtext;";

53 
$flds
[1] = "mediumtext";

55 if(
$dty
=="textdata")

57 if(
	`emy
(
$dfvue
))

59 
$dfvue
 = '';

61 
$flds
[0] = " `$fieldname` varchar(100) NOT NULL default '';";

62 
$flds
[1] = "varchar(100)";

64 if(
$dty
=="textchar")

66 if(
	`emy
(
$dfvue
))

68 
$dfvue
 = '';

70 
$flds
[0] = " `$fieldname` char(100) NOT NULL default '$dfvalue';";

71 
$flds
[1] = "char(100)";

73 if(
$dty
=="checkbox")

75 
$dfvue
 = 
	`r_a
(',',"','",$dfvalue);

76 
$dfvue
 = "'".$dfvalue."'";

77 
$flds
[0] = " `$fieldname` set($dfvalue) NULL;";

78 
$flds
[1] = "set($dfvalue)";

80 if(
$dty
=="select" || $dtype=="radio")

82 
$dfvue
 = 
	`r_a
(',',"','",$dfvalue);

83 
$dfvue
 = "'".$dfvalue."'";

84 
$flds
[0] = " `$fieldname`num($dfvalue) NULL;";

85 
$flds
[1] = "enum($dfvalue)";

89 if(
	`emy
(
$dfvue
))

91 
$dfvue
 = '';

93 if(
	`emy
(
$mxn
))

95 
$mxn
 = 100;

97 if(
$mxn
 > 255)

99 
$mxn
 = 250;

101 
$flds
[0] = " `$fieldname` varchar($mxlen) NOT NULL default '$dfvalue';";

102 
$flds
[1] = "varchar($mxlen)";

104  
$flds
;

105 
	}
}

108 
funi
 
	$GAddFldLi
(&
$d
,&
$okg
)

110 
$okli
 = '';

111 
$d
->
	`SNameS
("field","<",">");

112 
$d
->
	`LdSour
(
$okg
);

113 if(
	`is_y
(
$d
->
CTags
))

115 
	`fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

117 if(
$ag
->
	`GA
('islist')==1)

119 
$okli
 .($okli=='' ? 
	`ow
(
$ag
->
	`GName
()) : ','.strtolower($ctag->GetName()) );

123  
$okli
;

124 
	}
}

	@dede/inc/inc_archives_all.php

1 <?
php


4 
funi
 
	$GFmIm
(
$ag
)

6 
$fldme
 = 
$ag
->
	`GName
();

7 
$fmem
 = "

8 <
b
 
width
=\"800\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">

9 <

>

10 <
td
 
width
=\"80\">~name~</td>

11 <
td
 
width
=\"720\">~form~</td>

12 </

>

13 </
b
>\
r
\
n
";

14 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

15 if(
$ùext
!="")

17 if(
$ag
->
	`GA
("type")=='select')

19 
$myfmIm
 = '';

20 
$ems
 = 
	`exode
(',',
$ùext
);

21 
$myfmIm
 = "<selectame='$fieldname' style='width:150px'>";

22 
	`fܗch
(
$ems
 
as
 
$v
)

24 
$v
 = 
	`im
($v);

25 if(
$v
!='')

27 
$myfmIm
.= "<option value='$v'>$v</option>\r\n";

30 
$myfmIm
 .= "</select>\r\n";

31 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

32 
$fmem
 = 
	`r_a
("~fm~",
$myfmIm
,$formitem);

33  
$fmem
;

35 if(
$ag
->
	`GA
("type")=='radio')

37 
$myfmIm
 = '';

38 
$ems
 = 
	`exode
(',',
$ùext
);

39 
	`fܗch
(
$ems
 
as
 
$v
)

41 
$v
 = 
	`im
($v);

42 
$i
 = 0;

43 if(
$v
!='')

45 if(
$i
==0)

47 
$myfmIm
 .= "<inputype='radio'ame='$fieldname' class='np' value='$v' checked>$v\r\n";

51 
$myfmIm
 .= "<inputype='radio'ame='$fieldname' class='np' value='$v'>$v\r\n";

55 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

56 
$fmem
 = 
	`r_a
("~fm~",
$myfmIm
,$formitem);

57  
$fmem
;

61 
$fmem
 = 
	`r_a
('~me~',
$ag
->
	`GA
('itemname'),$formitem);

62 
$fmem
 = 
	`r_a
('~fm~',
$ùext
,$formitem);

63 
$fmem
 = 
	`r_a
('@value','',$formitem);

64  
$fmem
;

67 if(
$ag
->
	`GA
("type")=="htmltext"||$ctag->GetAtt("type")=="textdata")

69 
$fmem
 = "";

70 
$fmem
 ."<b width=\"800\" bd=\"0\" clacg=\"0\" caddg=\"0\"><><td width=\"80\">".
$ag
->
	`GA
('itemname')."</td><td>";

71 
$fmem
 .
	`GEd
(
$fldme
,'',350,'Basic','string');

72 
$fmem
 .= "</td></tr></table>\r\n";

73  
$fmem
;

75 if(
$ag
->
	`GA
("type")=="multitext")

77 
$ùext
 = "<textareaame='$fieldname' id='$fieldname' style='width:100%;height:80'></textarea>\r\n";

78 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

79 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

80  
$fmem
;

82 if(
$ag
->
	`GA
("type")=="datetime")

84 
$nowtime
 = 
	`GDeTimeMk
(
	`time
());

85 
$ùext
 = "<inputame=\"$fieldname\" value=\"$nowtime\"ype=\"text\" id=\"$fieldname\" style=\"width:200\">";

86 
$ùext
 .= "<inputame=\"selPubtime\"ype=\"button\" id=\"selkeyword\" value=\"选择\" onClick=\"showCalendar('$fieldname', 'Y-m-d H:i:00', '24');\">";

87 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

88 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

89  
$fmem
;

91 if(
$ag
->
	`GA
("type")=="img")

93 
$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' sty='width:300'><pume='".
$fldme
."_bt'ype='button' value='浏览...' onClick=\"SelectImage('form1.$fieldname','big')\">\r\n";

94 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

95 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

96  
$fmem
;

98 if(
$ag
->
	`GA
("type")=="media")

100 
$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' sty='width:300'><pume='".
$fldme
."_bt'ype='button' value='浏览...' onClick=\"SelectMedia('form1.$fieldname')\">\r\n";

101 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

102 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

103  
$fmem
;

105 if(
$ag
->
	`GA
("type")=="addon")

107 
$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' sty='width:300'><pume='".
$fldme
."_bt'ype='button' value='浏览...' onClick=\"SelectSoft('form1.$fieldname')\">\r\n";

108 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

109 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

110  
$fmem
;

112 if(
$ag
->
	`GA
("type")=="media")

114 
$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' sty='width:300'><pume='".
$fldme
."_bt'ype='button' value='浏览...' onClick=\"SelectMedia('form1.$fieldname')\">\r\n";

115 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

116 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

117  
$fmem
;

121 if(
$ag
->
	`GA
('deu')!=""
$dfvue
 = $ctag->GetAtt('default');

122 
$dfvue
 = "";

123 
$ùext
 = "<inputype='text'ame='$fieldname' id='$fieldname' style='width:200' value='$dfvalue'>\r\n";

124 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

125 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

126  
$fmem
;

128 
	}
}

131 
funi
 
GFldVue
(
$dvue
,
$dty
,
$aid
=0,
$job
='add',
$addv
='')

133 
glob
 
$cfg_cook_code
,
$cfg_d_purvw
;

134 if(
	g$dty
=="int")

136 
$dvue
 = 
im
(
eg_a
("[^0-9]","",$dvalue));

137 if(
	g$dvue
=="")

139 
$dvue
 = 0;

141  
	g$dvue
;

143 if(
	g$dty
=="float")

145 
$dvue
 = 
im
(
eg_a
("[^0-9\.]","",$dvalue));

146 if(
	g$dvue
=="")

148 
$dvue
 = 0;

150  
	g$dvue
;

152 if(
	g$dty
=="datetime")

154  
GMkTime
(
$dvue
);

156 if(
	g$dty
=="textdata")

158 if(
$job
=='edit')

160 
$addvDs
 = 
exode
('/',
$addv
);

161 
	g$addvD
 = 
eg_a
("/".
$addvDs
[
cou
($addvDs)-1]."$","",
$addv
);

162 
	g$md
 = 
$GLOBALS
['cfg_bad'].
$addvD
;

163 if(!
is_d
(
$md
))

165 
MkdA
(
$md
,
$GLOBALS
['cfg_dir_purview']);

167 
	g$
 = 
fݒ
(
$GLOBALS
['cfg_bad'].
$addv
,"w");

168 
fwre
(
$
,
rashes
(
$dvue
));

169 
fo
(
$
);

170 
CloF
();

171  
	g$addv
;

175 
	g$h
 = 
$GLOBALS
['cfg_cmspath']."/data/textdata";

176 
	g$h
 = 

(
$aid
/5000);

177 if(!
is_d
(
$GLOBALS
['cfg_bad'].
$h
))

179 
MkdA
(
$GLOBALS
['cfg_bad'].
$h
,
$cfg_d_purvw
);

181 if(!
is_d
(
$GLOBALS
['cfg_bad'].
$h
.'/'.
$h
))

183 
MkdA
(
$GLOBALS
['cfg_bad'].
$h
.'/'.
$h
,
$cfg_d_purvw
);

185 
	g$h
 = 
$h
.'/'.
$h
;

186 
	g$fame
 = "{$h}/{$aid}-".
_subr
(
md5
(
$cfg_cook_code
),0,16).".txt";

187 
	g$
 = 
fݒ
(
$GLOBALS
['cfg_bad'].
$fame
,"w");

188 
fwre
(
$
,
rashes
(
$dvue
));

189 
fo
(
$
);

190 
CloF
();

191  
	g$fame
;

194 if(
	g$dty
=="img")

196 
$iu
 = 
rashes
(
$dvue
);

197 if(
im
(
$iu
)=="")

201 
	g$iu
 = 
im
(
r_a
(
$GLOBALS
['cfg_baho'],"",
$iu
));

202 
	g$imgu
 = "{dede:imgext='' width='' height=''} ".
$iu
." {/dede:img}";

203 if(
egi
("^hp://",
$iu
&& 
	g$GLOBALS
['isUrlOpen'])

206 
	g$imgs
 = "";

207 if(
	g$isUOn
)

209 
	g$imgs
 = 
GRemeImage
(
$iu
,
$GLOBALS
['adminid']);

210 if(
is_y
(
$imgs
))

212 
	g$imgu
 = "{dede:imgext='' width='".
$imgs
[1]."' height='".$reimgs[2]."'} ".$reimgs[0]." {/dede:img}";

217 
	g$imgu
 = "{dede:imgext='' width='' height=''} ".
$iu
." {/dede:img}";

220 if(
	g$iu
!="")

223 
$imgfe
 = 
$GLOBALS
['cfg_bad'].
$iu
;

224 if(
is_fe
(
$imgfe
))

226 
	g$imgfos
 = 
GImageSize
(
$imgfe
,&
$fo
);

227 
	g$imgu
 = "{dede:imgext='' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}";

230  
addashes
(
$imgu
);

234  
	g$dvue
;

239 
funi
 
	$GFmImVue
(
$ag
,
$fvue
)

241 
$fldme
 = 
$ag
->
	`GName
();

242 
$fmem
 = "

243 <
b
 
width
=\"800\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">

244 <

>

245 <
td
 
width
=\"80\">~name~</td>

246 <
td
 
width
=\"720\">~form~</td>

247 </

>

248 </
b
>\
r
\
n
";

249 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

250 if(
$ùext
!="")

252 if(
$ag
->
	`GA
("type")=='select')

254 
$myfmIm
 = '';

255 
$ems
 = 
	`exode
(',',
$ùext
);

256 
$myfmIm
 = "<selectame='$fieldname' style='width:150px'>";

257 
	`fܗch
(
$ems
 
as
 
$v
)

259 
$v
 = 
	`im
($v);

260 if(
$v
!='')

262 if(
$fvue
==
$v
)

264 
$myfmIm
.= "<option value='$v' selected>$v</option>\r\n";

268 
$myfmIm
.= "<option value='$v'>$v</option>\r\n";

272 
$myfmIm
 .= "</select>\r\n";

273 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

274 
$fmem
 = 
	`r_a
("~fm~",
$myfmIm
,$formitem);

275  
$fmem
;

277 if(
$ag
->
	`GA
("type")=='radio')

279 
$myfmIm
 = '';

280 
$ems
 = 
	`exode
(',',
$ùext
);

281 
	`fܗch
(
$ems
 
as
 
$v
)

283 
$v
 = 
	`im
($v);

284 if(
$v
!='')

286 if(
$fvue
==
$v
)

288 
$myfmIm
.= "<inputype='radio'ame='$fieldname' class='np' value='$v' checked>$v\r\n";

292 
$myfmIm
.= "<inputype='radio'ame='$fieldname' class='np' value='$v'>$v\r\n";

296 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

297 
$fmem
 = 
	`r_a
("~fm~",
$myfmIm
,$formitem);

298  
$fmem
;

302 
$fmem
 = 
	`r_a
('~me~',
$ag
->
	`GA
('itemname'),$formitem);

303 
$fmem
 = 
	`r_a
('~fm~',
$ùext
,$formitem);

304 
$fmem
 = 
	`r_a
('@vue',
$fvue
,$formitem);

305  
$fmem
;

310 if(
$ag
->
	`GA
("type")=="textdata")

312 if(
	`is_fe
(
$GLOBALS
['cfg_bad'].
$fvue
))

314 
$
 = 
	`fݒ
(
$GLOBALS
['cfg_bad'].
$fvue
,'r');

315 
$okfvue
 = "";

316 !
	`of
(
$
))

318 
$okfvue
 .
	`fgs
(
$
,1024);

320 
	`fo
(
$
);

324 
$okfvue
="";

326 
$fmem
 = "<b width=\"800\" bd=\"0\" clacg=\"0\" caddg=\"0\"><><td width=\"80\">".
$ag
->
	`GA
('itemname')."</td>\r\n";

327 
$fmem
 ."<td>\r\n".
	`GEd
(
$fldme
,
$okfvue
,350,'Basic','string')."</td>\r\n";

328 
$fmem
 .= "</tr></table>\r\n";

329 
$fmem
 .= "<inputype='hidden'ame='{$fieldname}_file' value='{$fvalue}'>\r\n";

330  
$fmem
;

332 if(
$ag
->
	`GA
("type")=="htmltext")

334 
$fmem
 = "<b width=\"800\" bd=\"0\" clacg=\"0\" caddg=\"0\"><><td width=\"80\">".
$ag
->
	`GA
('itemname')."</td>\r\n";

335 
$fmem
 ."<td>\r\n".
	`GEd
(
$fldme
,
$fvue
,350,'Basic','string')."</td>\r\n";

336 
$fmem
 .= "</tr></table>\r\n";

337  
$fmem
;

339 if(
$ag
->
	`GA
("type")=="multitext")

341 
$ùext
 = "<textareaame='$fieldname' id='$fieldname' style='width:100%;height:80'>$fvalue</textarea>\r\n";

342 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

343 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

344  
$fmem
;

346 if(
$ag
->
	`GA
("type")=="datetime")

348 
$nowtime
 = 
	`GDeTimeMk
(
$fvue
);

349 
$ùext
 = "<inputame=\"$fieldname\" value=\"$nowtime\"ype=\"text\" id=\"$fieldname\" style=\"width:200\">";

350 
$ùext
 .= "<inputame=\"selPubtime\"ype=\"button\" id=\"selkeyword\" value=\"选择\" onClick=\"showCalendar('$fieldname', 'Y-m-d H:i:00', '24');\">";

351 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

352 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

353  
$fmem
;

355 if(
$ag
->
	`GA
("type")=="img")

357 
$nd
 = 
w
 
	`DedeTagP
();

358 
$nd
->
	`LdSour
(
$fvue
);

359 if(!
	`is_y
(
$nd
->
CTags
))

361 
$nd
->
	`Cˬ
();

362 
$fvue
 = "";

364 
$ag
 = 
$nd
->
	`GTag
("img");

365 
$fvue
 = 
	`im
(
$ag
->
	`GIText
());

366 
$ùext
 = "<puty='xt'ame='$fldme' vue='$fvue' id='$fldme' sty='width:300'><pume='".
$fldme
."_bt'ype='button' value='浏览...' onClick=\"SelectImage('form1.$fieldname','big')\">\r\n";

367 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

368 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

369  
$fmem
;

371 if(
$ag
->
	`GA
("type")=="media")

373 
$ùext
 = "<puty='xt'ame='$fldme' vue='$fvue' id='$fldme' sty='width:300'><pume='".
$fldme
."_bt'ype='button' value='浏览...' onClick=\"SelectMedia('form1.$fieldname')\">\r\n";

374 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

375 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

376  
$fmem
;

378 if(
$ag
->
	`GA
("type")=="addon")

380 
$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' vue='$fvue' sty='width:300'><pume='".
$fldme
."_bt'ype='button' value='浏览...' onClick=\"SelectSoft('form1.$fieldname')\">\r\n";

381 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

382 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

383  
$fmem
;

387 
$ùext
 = "<inputype='text'ame='$fieldname' id='$fieldname' style='width:200' value='$fvalue'>\r\n";

388 
$fmem
 = 
	`r_a
("~me~",
$ag
->
	`GA
('itemname'),$formitem);

389 
$fmem
 = 
	`r_a
("~fm~",
$ùext
,$formitem);

390  
$fmem
;

392 
	}
}

	@dede/inc/inc_archives_functions.php

1 <?
php


2 
que_
(
DEDEINC
.'/dedehttpdown.class.php');

3 
que_
(
DEDEINC
.'/image.func.php');

4 
que_
(
DEDEINC
.'/archives.func.php');

5 
que_
(
DEDEINC
.'/arc.partview.class.php');

6 
	g$backu
 = !
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? $_COOKIE['ENV_GOBACK_URL'] : '';

7 
	g$backu
 = 
eg
('cڋ_', 
$backu
) ? "<a href='$backurl'>[<u>记忆的列表页</u>]</a> &nbsp;" : '';

8 if(!
	$ist
(
$_NOT_ARCHIVES
))

10 
	`que_
(
DEDEINC
.'/customfields.func.php');

11 
	}
}

13 
funi
 
	$GCurCڋAlbum
(
$body
, 
$rfu
, &
$fdd
)

15 
glob
 
$dsql
,
$cfg_mui_se
,
$cfg_baho
,
$cfg_ddimg_width
;

16 
glob
 
$cfg_bad
,
$gey
,
$curLog
,
$cfg_add_vy
;

17 
	`que_
(
DEDEINC
.'/dedecollection.func.php');

18 if(
	`emy
(
$cfg_ddimg_width
)) $cfg_ddimg_width = 320;

19 
$rsimg
 = '';

20 
$cfg_udd
 = 
$GLOBALS
['cfg_image_dir'];

21 
$cfg_bad
 = 
$GLOBALS
['cfg_basedir'];

22 
$baho
 = 'hp://'.
$_SERVER
['HTTP_HOST'];

23 
$img_y
 = 
	`y
();

24 
	`eg_mch_l
("/(c)=[\"|'| ]{0,}(hp:\/\/([^>]*)\.(gif|jpg|g))/isU",
$body
,
$img_y
);

25 
$img_y
 = 
	`y_unique
($img_array[2]);

26 
$imgU
 = 
$cfg_udd
.'/'.
	`MyDe
(
$cfg_add_vy
, 
	`time
());

27 
$imgPh
 = 
$cfg_bad
.
$imgU
;

28 if(!
	`is_d
(
$imgPh
.'/'))

30 
	`MkdA
(
$imgPh
,
$GLOBALS
['cfg_dir_purview']);

31 
	`CloF
();

33 
$mliSecd
 = 'co'.
	`dd2ch

	`MyDe
('ymdHis',
	`time
())) ;

34 
	`fܗch
(
$img_y
 
as
 
$key
=>
$vue
)

36 
$vue
 = 
	`im
($value);

37 if(
	`egi
(
$baho
,
$vue
) || !eregi("^http://", $value)

38 || (
$cfg_baho
 !
$baho
 && 
	`egi
($cfg_baho,
$vue
)))

42 
$y
 = 
	`subr
(
$vue
, -4, 4);

43 if!
	`egi
("\.(gif|jpg|g)",
$y
) )

45 
$y
 = ".jpg";

47 
$dFeName
 = 
$imgPh
.'/'.
$mliSecd
.'-'.
$key
.
$y
;

48 
$iu
 = 
$imgU
.'/'.
$mliSecd
.'-'.
$key
.
$y
;

50 
$rs
 = 
	`DownImageKp
(
$vue
, 
$rfu
, 
$dFeName
, '', 0, 30);

51 if(
$rs
)

53 
$fo
 = '';

54 
$imgfos
 = 
	`GImageSize
(
$dFeName
, 
$fo
);

55 
$fsize
 = 
	`fesize
(
$dFeName
);

56 
$fame
 = 
$mliSecd
.'-'.
$key
.
$y
;

58 
$quy
 = "INSERT INTO `#@__uploads`(arcid,title,url,mediatype,width,height,playtime,filesize,uptime,mid)

59 
	`VALUES
 ('0','$filename','$iurl','1','{$imginfos[0]}','$imginfos[1]','0','$fsize','".time()."','".$cuserLogin->getUserID()."'); ";

60 
$dsql
->
	`ExecuNeQuy
(
$quy
);

61 
$fid
 = 
$dsql
->
	`GLaID
();

62 
	`AddMyAdd
(
$fid
, 
$iu
);

63 if(
$gey
 > 2)

65 
$lpiame
 = 
	`GImageMDD
(
$iu
, 
$cfg_ddimg_width
);

69 
$lpiame
 = 
$iu
;

71 if(
	`emy
(
$fdd
&& !emy(
$lpiame
))

73 
$fdd
 = 
$lpiame
;

74 if(!
	`fe_exis
(
$cfg_bad
.
$fdd
))

76 
$fdd
 = 
$iu
;

79 @
	`WImg
(
$dFeName
, 'down');

80 
$rsimg
 ."{dede:img ddimg='$lpiame'ext='' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

83  
$rsimg
;

84 
	}
}

87 
funi
 
	$GCurCڋ
(
$body
)

89 
glob
 
$cfg_mui_se
,
$cfg_baho
,
$cfg_bad
,
$cfg_image_d
;

90 
$cfg_udd
 = 
$cfg_image_d
;

91 
$htd
 = 
w
 
	`DedeHpDown
();

92 
$baho
 = "hp://".
$_SERVER
["HTTP_HOST"];

93 
$img_y
 = 
	`y
();

94 
	`eg_mch_l
("/c=[\"|'|\s]{0,}(hp:\/\/([^>]*)\.(gif|jpg|g))/isU",
$body
,
$img_y
);

95 
$img_y
 = 
	`y_unique
($img_array[1]);

96 
$imgU
 = 
$cfg_udd
.'/'.
	`MyDe
("ymd",
	`time
());

97 
$imgPh
 = 
$cfg_bad
.
$imgU
;

98 if(!
	`is_d
(
$imgPh
.'/'))

100 
	`MkdA
(
$imgPh
,
$GLOBALS
['cfg_dir_purview']);

101 
	`CloF
();

103 
$mliSecd
 = 
	`MyDe
('His',
	`time
());

104 
	`fܗch
(
$img_y
 
as
 
$key
=>
$vue
)

106 if(
	`egi
(
$baho
,
$vue
))

110 if(
$cfg_baho
!=
$baho
 && 
	`egi
($cfg_baho,
$vue
))

114 if(!
	`egi
("^hp://",
$vue
))

118 
$htd
->
	`OnU
(
$vue
);

119 
$y
 = 
$htd
->
	`GHd
("content-type");

120 
$y
 = 
	`subr
(
$vue
,-4,4);

121 if(!
	`egi
("\.(jpg|gif|g)",
$y
))

123 if(
$y
=='image/gif')

125 
$y
 = ".gif";

127 if(
$y
=='image/png')

129 
$y
 = ".png";

133 
$y
 = '.jpg';

136 
$mliSecdN
 = 
	`dd2ch
(
$mliSecd
.
	`mt_nd
(1000,8000));

137 
$vue
 = 
	`im
($value);

138 
$dFeName
 = 
$imgPh
.'/'.
$mliSecdN
.'-'.
$key
.
$y
;

139 
$feu
 = 
$imgU
.'/'.
$mliSecdN
.'-'.
$key
.
$y
;

140 
$rs
 = 
$htd
->
	`SaveToB
(
$dFeName
);

141 if(
$rs
)

143 if(
$cfg_mui_se
 == 'Y')

145 
$feu
 = 
$cfg_baho
.$fileurl;

147 
$body
 = 
	`r_a
(
$vue
,
$feu
,$body);

148 @
	`WImg
(
$dFeName
, 'down');

151 
$htd
->
	`Clo
();

152  
$body
;

153 
	}
}

156 
funi
 
	$GRemeImage
(
$u
,
$uid
=0)

158 
glob
 
$cfg_bad
, 
$cfg_image_d
, 
$cfg_add_vy
;

159 
$cfg_udd
 = 
$cfg_image_d
;

160 
$vues
 = 
	`Aay
();

161 
$ok
 = 
l
;

162 
$htd
 = 
w
 
	`DedeHpDown
();

163 
$htd
->
	`OnU
(
$u
);

164 
$r
 = 
	`Aay
("image/pjpeg", "image/jpeg", "image/gif", "image/png", "image/xpng", "image/wbmp");

165 if(!
	`_y
(
$htd
->
	`GHd
("cڋ-ty"),
$r
))

171 
$imgU
 = 
$cfg_udd
.'/'.
	`MyDe
(
$cfg_add_vy
, 
	`time
());

172 
$imgPh
 = 
$cfg_bad
.
$imgU
;

173 
	`CeD
(
$imgU
);

174 
$y
 = 
$htd
->
	`GHd
("content-type");

175 if(
$y
=="image/gif")

177 
$y
 = '.gif';

179 if(
$y
=="image/png")

181 
$y
 = '.png';

183 if(
$y
=="image/wbmp")

185 
$y
 = '.bmp';

189 
$y
 = '.jpg';

191 
$dme
 = 
	`dd2ch
(
$uid
.'_'.
	`MyDe
('mdHis',
	`time
()).
	`mt_nd
(1000,9999));

192 
$dueName
 = 
$imgPh
.'/'.
$dme
.
$y
;

193 
$feu
 = 
$imgU
.'/'.
$dme
.
$y
;

194 
$ok
 = 
$htd
->
	`SaveToB
(
$dueName
);

195 @
	`WImg
(
$dueName
, 'down');

196 if(
$ok
)

198 
$da
 = 
	`GImageSize
(
$dueName
);

199 
$vues
[0] = 
$feu
;

200 
$vues
[1] = 
$da
[0];

201 
$vues
[2] = 
$da
[1];

204 
$htd
->
	`Clo
();

205  (
$ok
 ? 
$vues
 : '');

206 
	}
}

209 
funi
 
	$GRemeFsh
(
$u
,
$uid
=0)

211 
glob
 
$cfg_add_vy
, 
$cfg_med_d
, 
$cfg_bad
;

212 
$cfg_udd
 = 
$cfg_med_d
;

213 
$vues
 = '';

214 
$r
 = 'application/x-shockwave-flash';

215 
$htd
 = 
w
 
	`DedeHpDown
();

216 
$htd
->
	`OnU
(
$u
);

217 if(
$htd
->
	`GHd
("cڋ-ty")!=
$r
)

223 
$imgU
 = 
$cfg_udd
.'/'.
	`MyDe
(
$cfg_add_vy
, 
	`time
());

224 
$imgPh
 = 
$cfg_bad
.
$imgU
;

225 
	`CeD
(
$imgU
);

226 
$y
 = '.swf';

227 
$mliSecd
 = 
$uid
.'_'.
	`MyDe
('mdHis',
	`time
());

228 
$dFeName
 = 
$imgPh
.'/'.
$mliSecd
.
$y
;

229 
$feu
 = 
$imgU
.'/'.
$mliSecd
.
$y
;

230 
$ok
 = 
$htd
->
	`SaveToB
(
$dFeName
);

231 if(
$ok
)

233 
$vues
 = 
$feu
;

236 
$htd
->
	`Clo
();

237  
$vues
;

238 
	}
}

241 
funi
 
	$CheckChl
(
$tyid
,
$chlid
)

243 
glob
 
$dsql
;

244 if(
$tyid
==0)

246  
ue
;

248 
$row
 = 
$dsql
->
	`GO
("Select ispart,channeltype From `#@__arctype` where id='$typeid' ");

249 if(
$row
['it']!=0 || $row['chy']!=
$chlid
)

251  
l
;

255  
ue
;

257 
	}
}

260 
funi
 
	$CheckArcAdm
(
$aid
,
$admid
)

262 
glob
 
$dsql
;

263 
$row
 = 
$dsql
->
	`GO
("Select mid From `#@__archives` where id='$aid' ");

264 if(
$row
['mid']!=
$admid
)

266  
l
;

270  
ue
;

272 
	}
}

275 
funi
 
	$SpLgBody
(
$mybody
,
$size
,
$g
)

277 if(
	`
(
$mybody
)<
$size
)

279  
$mybody
;

281 
$mybody
 = 
	`rashes
($mybody);

282 
$bds
 = 
	`exode
('<',
$mybody
);

283 
$ageBody
 = '';

284 
$iab
 = 0;

285 
$mybody
 = '';

286 
	`fܗch
(
$bds
 
as
 
$i
=>
$k
)

288 if(
$i
==0)

290 
$ageBody
 .
$bds
[
$i
]; ;

292 
$bds
[
$i
] = "<".$bds[$i];

293 if(
	`
(
$bds
[
$i
])>6)

295 
$ame
 = 
	`subr
(
$bds
[
$i
],1,5);

296 if(
	`ow
(
$ame
)=='table')

298 
$iab
++;

300 if(
	`ow
(
$ame
)=='/tabl')

302 
$iab
--;

304 if(
$iab
>0)

306 
$ageBody
 .
$bds
[
$i
]; ;

310 
$ageBody
 .
$bds
[
$i
];

315 
$ageBody
 .
$bds
[
$i
];

317 if(
	`
(
$ageBody
)>
$size
)

319 
$mybody
 .
$ageBody
.
$g
;

320 
$ageBody
 = '';

323 if(
$ageBody
!='')

325 
$mybody
 .
$ageBody
;

327  
	`addashes
(
$mybody
);

328 
	}
}

331 
funi
 
	$MakeA
(
$aid
, 
$mkdex
=
l
, 
$ismakesign
=false)

333 
glob
 
$vs
, 
$tyid
;

334 
	`que_
(
DEDEINC
.'/arc.archives.class.php');

335 if(
$ismakesign

$vs
['makesign'] = 'yes';

336 
$c
 = 
w
 
	`Archives
(
$aid
);

337 
$u
 = 
$c
->
	`MakeHtml
();

338  
$u
;

339 
	}
}

342 
funi
 
	$GDDImgFromBody
(&
$body
)

344 
$lpic
 = '';

345 
	`eg_mch_l
("/(c)=[\"|'| ]{0,}([^>]*\.(gif|jpg|bmp|g))/isU",
$body
,
$img_y
);

346 
$img_y
 = 
	`y_unique
($img_array[2]);

347 if(
	`cou
(
$img_y
)>0)

349 
$piame
 = 
	`eg_a
("/[\"|'| ]{1,}/", '', 
$img_y
[0]);

350 if(
	`eg
("_l\.",
$piame
))

352 
$lpic
 = 
$piame
;

356 
$lpic
 = 
	`GDDImage
('ddf',
$piame
,1);

359  
$lpic
;

360 
	}
}

363 
funi
 
	$GDDImage
(
$lpic
,
$piame
,
$ieme
)

365 
glob
 
$curLog
,
$cfg_ddimg_width
,
$cfg_ddimg_height
,
$cfg_bad
,
$ddcfg_image_d
,
$cfg_add_vy
;

366 
$ime
 = 
	`time
();

367 if(
$lpic
 != 'none' || $litpic != 'ddfirst') &&

368 !
	`emy
(
$_FILES
[
$lpic
]['tmp_me']&& 
	`is_uded_fe
($_FILES[$litpic]['tmp_name']))

371 
$iy
 = 0;

372 
$r
 = 
	`Aay
("image/pjpeg","image/jpeg","image/gif","image/png");

373 
$_FILES
[
$lpic
]['ty'] = 
	`ow
(
	`im
($_FILES[$litpic]['type']));

374 if(!
	`_y
(
$_FILES
[
$lpic
]['ty'],
$r
))

376 
	`ShowMsg
("上传的图片格式错误，请使用JPEG、GIF、PNG格式的其中一种！","-1");

377 
	`ex
();

379 
$vh
 = 
$ddcfg_image_d
.'/'.
	`MyDe
(
$cfg_add_vy
, 
$ime
);

381 
	`CeD
(
$vh
);

382 
$fuU
 = 
$vh
.'/'.
	`dd2ch
(
	`MyDe
('mdHis',
$ime
).
$curLog
->
	`gUrID
().
	`mt_nd
(1000,9999));

383 if(
	`ow
(
$_FILES
[
$lpic
]['type'])=="image/gif")

385 
$fuU
 = $fullUrl.".gif";

387 if(
	`ow
(
$_FILES
[
$lpic
]['type'])=="image/png")

389 
$fuU
 = $fullUrl.".png";

393 
$fuU
 = $fullUrl.".jpg";

396 @
	`move_uded_fe
(
$_FILES
[
$lpic
]['tmp_me'],
$cfg_bad
.
$fuU
);

397 
$lpic
 = 
$fuU
;

399 if(
$GLOBALS
['cfg_ddimg_fu']=='Y'@
	`ImageResizeNew
(
$cfg_bad
.
$fuU
,
$cfg_ddimg_width
,
$cfg_ddimg_height
);

400 @
	`ImageResize
(
$cfg_bad
.
$fuU
,
$cfg_ddimg_width
,
$cfg_ddimg_height
);

402 
$img
 = 
$cfg_bad
.
$lpic
;

408 
$piame
 = 
	`im
($picname);

409 if(
$ieme
==1 && 
	`egi
("^hp://",
$piame
))

411 
$lpic
 = 
$piame
;

413 
$ddfos
 = 
	`GRemeImage
(
$lpic
,
$curLog
->
	`gUrID
());

415 if(!
	`is_y
(
$ddfos
))

417 
$lpic
 = '';

421 
$lpic
 = 
$ddfos
[0];

422 if(
$ddfos
[1] > 
$cfg_ddimg_width
 || $ddfos[2] > 
$cfg_ddimg_height
)

424 if(
$GLOBALS
['cfg_ddimg_fu']=='Y'@
	`ImageResizeNew
(
$cfg_bad
.
$lpic
,
$cfg_ddimg_width
,
$cfg_ddimg_height
);

425 @
	`ImageResize
(
$cfg_bad
.
$lpic
,
$cfg_ddimg_width
,
$cfg_ddimg_height
);

431 if(
$lpic
=='ddf' && !
	`egi
("^hp://",
$piame
))

433 
$dpic
 = 
$cfg_bad
.
$piame
;

434 
$lpic
 = 
	`r_a
('.','-.',
$piame
);

435 if(
$GLOBALS
['cfg_ddimg_fu']=='Y'@
	`ImageResizeNew
(
$dpic
,
$cfg_ddimg_width
,
$cfg_ddimg_height
,
$cfg_bad
.
$lpic
);

436 @
	`ImageResize
(
$dpic
,
$cfg_ddimg_width
,
$cfg_ddimg_height
,
$cfg_bad
.
$lpic
);

437 if(!
	`is_fe
(
$cfg_bad
.
$lpic
)) $litpic = '';

441 
$lpic
 = 
$piame
;

442  
$lpic
;

446 if(
$lpic
=='litpic' || $litpic=='ddfirst')

448 
$lpic
 = '';

450  
$lpic
;

451 
	}
}

454 
funi
 
	$GFmImA
(
$ag
)

456  
	`GFmIm
(
$ag
,'admin');

457 
	}
}

460 
funi
 
GFldVueA
(
$dvue
,
$dty
,
$aid
=0,
$job
='add',
$addv
='')

462  
GFldVue
(
$dvue
,
$dty
,
$aid
,
$job
,
$addv
,'admin');

466 
funi
 
	$GFmImVueA
(
$ag
,
$fvue
)

468  
	`GFmImVue
(
$ag
,
$fvue
,'admin');

469 
	}
}

472 
funi
 
PrtAutoFldsAdd
(&
$fldt
,
$ldty
='all')

474 
$d
 = 
w
 
DedeTagP
();

475 
	g$d
->
SNameS
('field','<','>');

476 
	g$d
->
LdSour
(
$fldt
);

477 
	g$dede_addflds
 = '';

478 if(
is_y
(
$d
->
CTags
))

480 
fܗch
(
$d
->
CTags
 
as
 
$tid
=>
$ag
)

482 if(
$ldty
!='autofield'

483 || (
$ldty
=='autofld' && 
$ag
->
GA
('autofield')==1) )

485 
$dede_addflds
 .$dede_addflds=="" ? 
$ag
->
GName
().",".$ag->
GA
('type') : ";".$ctag->GetName().",".$ctag->GetAtt('type') );

486 
echo
 
GFmImA
(
$ag
);

490 
	gecho
 "<puty='hidd'ame='dede_addflds' vue=\"".
	g$dede_addflds
."\">\r\n";

494 
funi
 
PrtAutoFldsEd
(&
$fldt
,&
$fldVues
,
$ldty
='all')

496 
$d
 = 
w
 
DedeTagP
();

497 
	g$d
->
SNameS
("field","<",">");

498 
	g$d
->
LdSour
(
$fldt
);

499 
	g$dede_addflds
 = "";

500 if(
is_y
(
$d
->
CTags
))

502 
fܗch
(
$d
->
CTags
 
as
 
$tid
=>
$ag
)

504 if(
$ldty
!='autofield'

505 || (
$ldty
=='autofld' && 
$ag
->
GA
('autofield')==1) )

507 
$dede_addflds
 .$dede_addflds=='' ? 
$ag
->
GName
().",".$ag->
GA
('type') : ";".$ctag->GetName().",".$ctag->GetAtt('type') );

508 
echo
 
GFmImVueA
(
$ag
,
$fldVues
[$ag->
GName
()]);

512 
	gecho
 "<puty='hidd'ame='dede_addflds' vue=\"".
	g$dede_addflds
."\">\r\n";

517 
funi
 
AlyHtmlBody
(
$body
,&
$desti
,&
$lpic
,&
$keywds
,
$dty
='')

519 
glob
 
$autޙpic
,
$me
,
$dlk
,
$autokey
,
$cfg_baho
,
$cfg_au_desti
,
$id
,
$t
,
$cfg_so_ng
;

520 
	g$autޙpic
 = (
emy
(
$autޙpic
) ? '' : $autolitpic);

521 
	g$body
 = 
rashes
(
$body
);

524 if(
	g$me
==1)

526 
$body
 = 
GCurCڋ
($body);

530 if(
	g$dlk
==1)

532 
$baho
 = "hp://".
$_SERVER
['HTTP_HOST'];

533 
	g$body
 = 
r_a
(
$cfg_baho
,'#baho#',
$body
);

534 
	g$body
 = 
r_a
(
$baho
,'#2baho2#',
$body
);

535 
	g$body
 = 
eg_a
("/(<a[ \t\r\n]{1,}hf=[\"']{0,}hp:\/\/[^\/]([^>]*)>)|(<\/a>)/isU","",
$body
);

536 
	g$body
 = 
r_a
('#baho#',
$cfg_baho
,
$body
);

537 
	g$body
 = 
r_a
('#2baho2#',
$baho
,
$body
);

541 if(
	g$desti
=='' && 
$cfg_au_desti
>0)

543 
$desti
 = 
_subr
(
html2xt
(
$body
),
$cfg_au_desti
);

544 
	g$desti
 = 
im
(
eg_a
('/#p#|#e#/','',
$desti
));

545 
	g$desti
 = 
addashes
(
$desti
);

549 if(
	g$autޙpic
==1 && 
$lpic
=='')

551 
$lpic
 = 
GDDImgFromBody
(
$body
);

555 if(
	g$autokey
==1 && 
$keywds
=='')

557 
$subje
 = 
$t
;

558 
	g$mesge
 = 
$body
;

559 if(
	g$cfg_so_ng
 == 'utf-8')

561 
$subje
 = 
utf82gb
(
$t
);

562 
	g$mesge
 = 
utf82gb
(
$mesge
);

564 
ude_
(
DEDEINC
.'/splitword.class.php');

565 
	g$keywds
 = '';

566 
	g$
 = 
w
 
SWd
();

567 
	g$t˚dexs
 = 
exode
(' ',
eg_a
("/#p#|#e#/",'',
$
->
GIndexText
(
$subje
)));

568 
	g$ldexs
 = 
exode
(' ',
eg_a
("/#p#|#e#/",'',
$
->
GIndexText
(
Html2Text
(
$mesge
),500)));

569 if(
is_y
(
$ldexs
&& is_y(
$t˚dexs
))

571 
fܗch
(
$t˚dexs
 
as
 
$k
)

573 if(

(
$keywds
.
$k
)>=60)

579 
	g$keywds
 .
$k
.',';

582 
fܗch
(
$ldexs
 
as
 
$k
)

584 if(

(
$keywds
.
$k
)>=60)

588 if(!
_y
(
$k
,
$t˚dexs
))

590 
	g$keywds
 .
$k
.',';

594 
	g$
->
Cˬ
();

595 
	g$
 = 
nu
;

597 
	g$body
 = 
GFldVueA
(
$body
,
$dty
,
$id
);

598 
	g$body
 = 
addashes
(
$body
);

599  
	g$body
;

603 
funi
 
	$GImageMDD
(
$fame
, 
$maxwidth
)

605 
glob
 
$curLog
, 
$dsql
, 
$cfg_ddimg_height
, 
$cfg_ddimg_fu
;

606 
$ddn
 = 
	`subr
(
$fame
, -3);

607 
$ddpicok
 = 
	`eg_a
("\.".
$ddn
."$", "-.".$ddn, 
$fame
);

608 
$toFe
 = 
$GLOBALS
['cfg_bad'].
$ddpicok
;

610 if(
$cfg_ddimg_fu
=='Y'
	`ImageResizeNew
(
$GLOBALS
['cfg_bad'].
$fame
, 
$maxwidth
, 
$cfg_ddimg_height
, 
$toFe
);

611 
	`ImageResize
(
$GLOBALS
['cfg_bad'].
$fame
, 
$maxwidth
, 
$cfg_ddimg_height
, 
$toFe
);

614 
$fsize
 = 
	`fesize
(
$toFe
);

615 
$ddpicoks
 = 
	`exode
('/', 
$ddpicok
);

616 
$fame
 = 
$ddpicoks
[
	`cou
($ddpicoks)-1];

617 
$quy
 = "INSERT INTO `#@__uploads`(arcid,title,url,mediatype,width,height,playtime,filesize,uptime,mid)

618 
	`VALUES
 ('0','$filename','$ddpicok','1','0','0','0','$fsize','".time()."','".$cuserLogin->getUserID()."'); ";

619 
$dsql
->
	`ExecuNeQuy
(
$quy
);

620 
$fid
 = 
$dsql
->
	`GLaID
();

621 
	`AddMyAdd
(
$fid
, 
$ddpicok
);

623  
$ddpicok
;

624 
	}
}

635 
funi
 
UdOImage
(
$uame
,
$hdu
='',
$ieme
=1,
$
='')

637 
glob
 
$curLog
,
$cfg_bad
,
$cfg_image_d
,
$t
, 
$dsql
;

638 if(
	g$
!='')

640 
$t
 = 
$
;

642 
	g$ime
 = 
time
();

643 
	g$fame
 = '';

644 
	g$im_up
 = 
l
;

645 
	g$hdu
 = 
im
(
$hdu
);

648 if(!
emy
(
$_FILES
[
$uame
]['tmp_me']&& 
is_uded_fe
($_FILES[$upname]['tmp_name']))

650 
	g$iy
 = 0;

651 
	g$r
 = 
Aay
("image/pjpeg","image/jpeg","image/gif","image/png");

652 
	g$_FILES
[
$uame
]['ty'] = 
ow
(
im
(
$_FILES
[$upname]['type']));

653 if(!
_y
(
$_FILES
[
$uame
]['ty'],
$r
))

655 
ShowMsg
("上传的图片格式错误，请使用JPEG、GIF、PNG格式的其中一种！","-1");

656 
ex
();

658 if(!
emy
(
$hdu
&& !
egi
("^hp://",$hdu&& 
fe_exis
(
$cfg_bad
.$handurl) )

660 if(!
is_obje
(
$dsql
))

662 
	g$dsql
 = 
w
 
DedeSql
();

664 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__uploads` where urlike '$handurl' ");

665 
	g$fuU
 = 
egi_a
("\.([a-z]*)$","",
$hdu
);

669 
	g$vh
 = 
$cfg_image_d
.'/'.
rime
("%Y-%m",
$ime
);

670 
CeD
(
$vh
);

671 
	g$fuU
 = 
$vh
.'/'.
rime
("%d",
$ime
).
dd2ch
(rime("%H%M%S",$ime).'0'.
$curLog
->
gUrID
().'0'.
mt_nd
(1000,9999));

673 if(
ow
(
$_FILES
[
$uame
]['type'])=="image/gif")

675 
$fuU
 = $fullUrl.".gif";

677 if(
ow
(
$_FILES
[
$uame
]['type'])=="image/png")

679 
$fuU
 = $fullUrl.".png";

683 
	g$fuU
 = 
$fuU
.".jpg";

687 @
move_uded_fe
(
$_FILES
[
$uame
]['tmp_me'],
$cfg_bad
.
$fuU
);

688 
	g$fame
 = 
$fuU
;

691 @
WImg
(
$imgfe
,'up');

692 
	g$im_up
 = 
ue
;

698 if(
	g$hdu
=='')

704 if(
	g$ieme
==1 && 
egi
("^hp://",
$hdu
))

706 
	g$ddfos
 = 
GRemeImage
(
$hdu
,
$curLog
->
gUrID
());

707 if(!
is_y
(
$ddfos
))

709 
	g$lpic
 = "";

713 
	g$fame
 = 
$ddfos
[0];

715 
	g$im_up
 = 
ue
;

721 
	g$fame
 = 
$hdu
;

724 
	g$imgfe
 = 
$cfg_bad
.
$fame
;

725 if(
is_fe
(
$imgfe
&& 
	g$im_up
 && 
	g$fame
!='')

727 
$fo
 = "";

728 
	g$imgfos
 = 
GImageSize
(
$imgfe
,
$fo
);

731 
	g$quy
 = "

732 
INSERT
 
INTO
 #@
__uds
(
t
,
u
,
medty
,
width
,
height
,
aytime
,
fesize
,
uime
,
mid
)

733 
VALUES
 ('$title','$filename','1','".$imginfos[0]."','".$imginfos[1]."','0','".filesize($imgfile)."','".time()."','".$cuserLogin->getUserID()."');

735 
	g$dsql
->
ExecuNeQuy
(
$quy
);

737  
	g$fame
;

740 
funi
 
	$GUpdeTe
()

742 
glob
 
$cID
, 
$tyid
, 
$cfg_make_dt
, 
$cfg_makedex
, 
$cfg_make_ext
;

743 
$vue
 = 
$di
 = '';

744 if(
$cfg_makedex
=='Y' || 
$cfg_make_dt
=='Y' || 
$cfg_make_ext
=='Y')

746 if(
$cfg_make_ext
=='Y' && !
	`emy
(
$tyid
)
$di
 = 'makeprenext';

747 if(
$cfg_makedex
=='Y'
$di
 .
	`emy
($dolist) ? 'makeindex' : ',makeindex';

748 if(
$cfg_make_dt
=='Y'
$di
 .
	`emy
($dolist) ? 'makeparenttype' : ',makeparenttype';

749 
$dis
 = 
	`exode
(',', 
$di
);

750 
$jumpU
 = "sk_do.php?tyid={$tyid}&aid={$cID}&do={$dis[0]}&xtdo=".
	`eg_a
(
$dis
[0]."[,]{0,1}", '', 
$di
);

751 
$vue
 = "<table width='80%' style='border:1px dashed #cdcdcd;margin-left:20px;margin-bottom:15px' id='tgtable'lign='left'><tr><td bgcolor='#EBF5C9'>&nbsp;<strong>正在进行相关内容更新，请完成前不要进行其它操作：</strong>\r\n</td></tr>\r\n";

752 
$vue
 .= "<tr><td>\r\n<iframeame='stafrm' frameborder='0' id='stafrm' width='100%' height='200px' src='$jumpUrl'></iframe>\r\n</td></tr>\r\n";

753 
$vue
 .= "</table>";

757 
$vue
 = '';

759  
$vue
;

760 
	}
}

	@dede/inc/inc_batchup.php

1 <?
php


2 
funi
 
DArc
(
$aid
,
$ty
='ON',
$lyfe
=
l
)

4 
glob
 
$dsql
,
$cfg_cook_code
,
$cfg_mui_se
,
$cfg_meds_d
;

5 
glob
 
	g$curLog
,
	g$cfg_ud_swch
,
	g$cfg_de
,
	g$cfg_bad
;

6 
glob
 
	g$adm_logs
, 
	g$cfg_adm_chl
;

8 if(
	g$cfg_de
 ='N'
$ty
 = 'OK';

9 if(
emy
(
$aid
))  ;

10 
	g$aid
 = 
eg_a
("[^0-9]", '', 
$aid
);

11 
	g$
 = 
$cu
 = '';

14 
	g$quy
 = "Select ch.maintable,ch.addtable,ch.nid,ch.issystem From `#@__arctiny`rc

15 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


16 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl
 
whe
rc.id='$aid' ";

17 
$row
 = 
$dsql
->
GO
(
$quy
);

18 
	g$nid
 = 
$row
['nid'];

19 
	g$mab
 = (
im
(
$row
['maintable'])=='' ? '#@__archives' :rim($row['maintable']));

20 
	g$addb
 = 
im
(
$row
['addtable']);

21 
	g$issyem
 = 
$row
['issystem'];

24 if(
	g$issyem
==-1)

26 
$cQuy
 = "Selectrc.*,tp.* from `$addtable`rceft join `#@__arctype`p onrc.typeid=tp.id whererc.aid='$aid' ";

30 
	g$cQuy
 = "Selectrc.*,tp.*,arc.idsid from `$maintable`rceft join `#@__arctype`p onrc.typeid=tp.id whererc.id='$aid' ";

33 
	g$cRow
 = 
$dsql
->
GO
(
$cQuy
);

36 if(!
TePurvw
('a_Del,sys_ArcBatch'))

38 if(
TePurvw
('a_AccDel'))

40 if!
_y
(
$cRow
['tyid'], 
$adm_logs
&& (
cou
($adm_logs!0 || 
$cfg_adm_chl
 != 'all') )

42  
l
;

45 if(
TePurvw
('a_MyDel'))

47 if(
	g$cRow
['mid'] !
$curLog
->
gUrID
())

49  
l
;

54  
	gl
;

59 if(
	g$issyem
 =-1
$ty
 = 'OK';

60 if(!
is_y
(
$cRow
) 
	gl
;

63 if(
	g$cfg_de
 ='Y' && 
$ty
 == 'ON')

65 
$dsql
->
ExecuNeQuy
("Update `$maintable` setrcrank='-2' where id='$aid' ");

66 
	g$dsql
->
ExecuNeQuy
("Update `#@__arctiny` set `arcrank` = '-2' where id = '$aid'; ");

71 if(!
	g$lyfe
)

74 if(
	g$cfg_ud_swch
 == 'Y')

76 
$dsql
->
Execu
("me", "SELECT * FROM `#@__uploads` WHERErcid = '$aid'");

77 
	g$row
 = 
$dsql
->
GAay
('me'))

79 
$addfe
 = 
$row
['url'];

80 
	g$aid
 = 
$row
['aid'];

81 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__uploads` whereid = '$aid' ");

82 
	g$upfe
 = 
$cfg_bad
.
$addfe
;

83 if(@
fe_exis
(
$upfe
)@
uƚk
($upfile);

86 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$aid'");

87 if(
	g$addb
 != '')

89 
$dsql
->
ExecuNeQuy
("Delete From `$addtable` whereid='$aid' ");

91 if(
	g$issyem
 != -1)

93 
$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$aid' ");

95 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__feedback` whereid='$aid' ");

96 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_stow` whereid='$aid' ");

97 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__taglist` whereid='$aid' ");

98 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__erradd` whereid='$aid' ");

102 
	g$fameh
 = 
DEDEDATA
."/xtda/".(

(
$aid
/5000))."/{$aid}-".
subr
(
md5
(
$cfg_cook_code
),0,16).".txt";

103 if(@
is_fe
(
$fameh
)@
uƚk
($filenameh);

107 if(
emy
(
$cRow
['mey'])
	g$cRow
['money'] = 0;

108 if(
emy
(
$cRow
['ismake'])
	g$cRow
['ismake'] = 1;

109 if(
emy
(
$cRow
['k'])
	g$cRow
['arcrank'] = 0;

110 if(
emy
(
$cRow
['fame'])
	g$cRow
['filename'] = '';

113 if(
	g$cRow
['ismake']==-1 || 
$cRow
['arcrank']!=0 || $arcRow['typeid']==0 || $arcRow['money']>0)

115  
ue
;

119 
	g$GLOBALS
['cfg_multi_site'] = 'N';

120 
	g$cu
 = 
GFeU
(
$cRow
['aid'],$arcRow['typeid'],$arcRow['senddate'],$arcRow['title'],$arcRow['ismake'],

121 
$cRow
['arcrank'],$arcRow['namerule'],$arcRow['typedir'],$arcRow['money'],$arcRow['filename']);

122 if(!
eg
("\?", 
$cu
))

124 
	g$htmlfe
 = 
GTruePh
().
r_a
(
$GLOBALS
['cfg_baho'],'',
$cu
);

125 if(
fe_exis
(
$htmlfe
&& !
is_d
($htmlfile))

127 @
uƚk
(
$htmlfe
);

128 
	g$cus
 = 
exode
(".", 
$htmlfe
);

129 
	g$ame
 = 
$cus
[
cou
($arcurls)-1];

130 
	g$ame
 = 
eg_a
("(\.$ame)$", "", 
$htmlfe
);

131 
	g$i
=2; $i<=100; $i++)

133 
	g$htmlfe
 = 
$ame
."_{$i}.".
$ame
;

134 if@
fe_exis
(
$htmlfe
@
uƚk
($htmlfile);

140  
	gue
;

144 
funi
 
GTruePh
(
$ser
='', 
$sh
='')

146 
$uh
 = 
$GLOBALS
['cfg_basedir'];

147  
	g$uh
;

	@dede/inc/inc_catalog_options.php

1 <?
php


2 
funi
 
	$GOiLi
(
$lid
=0, 
$urCog
=0, 
$chy
=0)

4 
glob
 
$OiAayLi
, 
$chls
, 
$dsql
, 
$cfg_adm_chl
, 
$adm_logs
;

6 
$dsql
->
	`SQuy
("Select id,typename From `#@__channeltype` ");

7 
$dsql
->
	`Execu
();

8 
$chls
 = 
	`Aay
();

9 
$row
 = 
$dsql
->
	`GObje
()
$chls
[$row->
id
] = $row->
tyme
;

11 
$OiAayLi
 = '';

14 if(
$lid
 > 0)

16 
$row
 = 
$dsql
->
	`GO
("Select id,typename,ispart,channeltype From `#@__arctype` where id='$selid'");

17 if(
$row
['it']==1
$OiAayLi
 .= "<option value='".$row['id']."' class='option1' selected='selected'>".$row['typename']."(封面频道)</option>\r\n";

18 
$OiAayLi
 ."<ti vue='".
$row
['id']."' selected='selected'>".$row['typename']."</option>\r\n";

22 if
$cfg_adm_chl
=='array' )

24 if(
	`cou
(
$adm_logs
)==0)

26 
$quy
 = "Select id,typename,ispart,channeltype From `#@__arctype` where 1=2 ";

30 
$adm_log
 = 
	`jo
(',', 
$adm_logs
);

31 
$dsql
->
	`SQuy
("Selecteid From `#@__arctype` where id in($admin_catalog) group byeid ");

32 
$dsql
->
	`Execu
();

33 
$tidr
 = '';

34 
$row
 = 
$dsql
->
	`GObje
())

36 if(
$row
->
id
==0) ;

37 
$tidr
 .($tidr=='' ? 
$row
->
id
 : ','.$row->reid);

39 
$adm_log
 .','.
$tidr
;

40 
$adm_logs
 = 
	`exode
(',', 
$adm_log
);

41 
$adm_logs
 = 
	`y_unique
($admin_catalogs);

42 
$adm_log
 = 
	`jo
(',', 
$adm_logs
);

43 
$quy
 = "Select id,typename,ispart,channeltype From `#@__arctype` where id in($admin_catalog) Andeid=0 And ispart<>2 ";

48 
$quy
 = "Select id,typename,ispart,channeltype From `#@__arctype` where ispart<>2 Andeid=0 order by sortranksc ";

51 
$dsql
->
	`SQuy
(
$quy
);

52 
$dsql
->
	`Execu
();

54 
$row
=
$dsql
->
	`GObje
())

56 
$sCs
 = '';

57 
	`LogicGOiAay
(
$row
->
id
, '─', 
$chy
, 
$dsql
, 
$sCs
);

58 if(
$sCs
 != '')

60 if(
$row
->
it
==1
$OiAayLi
 ."<ti vue='".$row->
id
."' css='ti1'>".$row->
tyme
."(封面频道)</option>\r\n";

61 if(
$row
->
it
==2
$OiAayLi
 .= '';

62 if
	`emy
(
$chy
&& 
$row
->
it
 !0 ) 
$OiAayLi
 ."<ti vue='".$row->
id
."' css='ti2'>".$row->
tyme
."(".
$chls
[$row->
chy
].")</option>\r\n";

63 
$OiAayLi
 ."<ti vue='".
$row
->
id
."' css='ti3'>".$row->
tyme
."</option>\r\n";

64 
$OiAayLi
 .
$sCs
;

68 if(
$row
->
it
==0 && (!
	`emy
(
$chy
&& $row->
chy
==$channeltype) )

70 
$OiAayLi
 ."<ti vue='".
$row
->
id
."' css='ti3'>".$row->
tyme
."</option>\r\n";

74  
$OiAayLi
;

75 
	}
}

76 
funi
 
	$LogicGOiAay
(
$id
,
$
,
$chy
,&
$dsql
, &
$sCs
)

78 
glob
 
$OiAayLi
, 
$chls
, 
$cfg_adm_chl
, 
$adm_logs
;

79 
$dsql
->
	`SQuy
("Se id,tyme,it,chy From `#@__y` whid='".
$id
."' And ispart<>2 order by sortranksc");

80 
$dsql
->
	`Execu
(
$id
);

81 
$row
=
$dsql
->
	`GObje
(
$id
))

83 if(
$cfg_adm_chl
 !'l' && !
	`_y
(
$row
->
id
, 
$adm_logs
))

87 if(
$row
->
chy
==
$chy
 && $row->
it
==1)

89 
$sCs
 ."<ti vue='".
$row
->
id
."' css='ti1'>$".$row->
tyme
."</option>\r\n";

91 if(
$row
->
chy
==
$chy
 && $row->
it
==0|| 
	`emy
($channeltype) )

93 
$sCs
 ."<ti vue='".
$row
->
id
."' css='ti3'>$".$row->
tyme
."</option>\r\n";

95 
	`LogicGOiAay
(
$row
->
id
,
$
.'─',
$chy
,
$dsql
, 
$sCs
);

97 
	}
}

	@dede/inc/inc_coonepage.php

1 <?
php


3 
que_
(
DEDEINC
.'/charset.func.php');

4 
funi
 
	$CoOPage
(
$gu
)

6 
glob
 
$dsql
,
$cfg_au_desti
, 
$cfg_so_ng
;

7 
$das
 = 
	`y
('title' => '','body' => '','source' => '','writer' => '','description' => '','keywords' => '');

8 
$das
['sour'] = 
	`eg_a
("/hp:\/\//i","",
$gu
);

9 
$das
['sour'] = 
	`eg_a
("/\/(.*)$/i","",$redatas['source']);

10 
$row
 = 
$dsql
->
	`GO
("Se * From `#@__co_ڕage` whuik'".
$das
['source']."' ");

11 
$s
 = 
$e
 = '';

12 if(
	`is_y
(
$row
))

14 
	`li
(
$s
,
$e

	`exode
('{@body}',
$row
['rule']);

15 
$s
 = 
	`im
($s);

16 
$e
 = 
	`im
($e);

17 if(
$row
['issource']==1)

19 
$das
['sour'] = 
$row
['title'];

22 
$htd
 = 
w
 
	`DedeHpDown
();

23 
$htd
->
	`OnU
(
$gu
);

24 
$body
 = 
$htd
->
	`GHtml
();

25 if(
$body
!='')

28 if(
$cfg_so_ng
=='utf-8')

30 if(
$row
['lang']=='gb2312')

32 
$body
 = 
	`gb2utf8
($body);

35 if(
$cfg_so_ng
=='gb2312')

37 if(
$row
['lang']=='utf-8')

39 
$body
 = 
	`utf82gb
($body);

44 
$r
 = 
	`y
();

45 
	`eg_mch
("/<t>(.*)<\/t>/isU",
$body
,
$r
);

46 if(
	`ist
(
$r
[1]))

48 
$das
['t'] = 
$r
[1];

52 
$r
 = 
	`y
();

53 
	`eg_mch
("/<ma[\s]+me=['\"]keywds['\"] cڋ=['\"](.*)['\"]/isU",
$body
,
$r
);

54 if(
	`ist
(
$r
[1]))

56 
$das
['keywds'] = 
	`_subr
(
	`html2xt
(
$r
[1]),30);

60 
$r
 = 
	`y
();

61 
	`eg_mch
("/<ma[\s]+me=['\"]desti['\"] cڋ=['\"](.*)['\"]/isU",
$body
,
$r
);

62 if(
	`ist
(
$r
[1]))

64 
$das
['desti'] = 
	`_subr
(
	`html2xt
(
$r
[1]),
$cfg_au_desti
);

68 if(
$s
!='' && 
$e
!='')

70 
$das
['body'] = 
	`GHtmlAaA
(
$s
,
$e
,
$body
);

71 if(
$das
['body']!='' && $redatas['description']=='')

73 
$das
['desti'] = 
	`_subr
(
	`html2xt
($das['body']),
$GLOBALS
['cfg_auot_description']);

77  
$das
;

78 
	}
}

81 
funi
 
	$GHtmlAaA
(
$s
,
$e
,&
$html
)

83 if(
$html
==""||
$s
=="")

87 
$post
 = @
	`os
(
$html
,
$s
);

88 if(
$post
===
l
)

92 
$pond
 = 
	`os
(
$html
,
$e
,
$post
);

93 if(
$pond
 > 
$post
 && $pond!==
l
)

95  
	`subr
(
$html
,
$post
+
	`
(
$s
),
$pond
-$posstart-strlen($s));

100 
	}
}

	@dede/inc/inc_list_functions.php

1 <?
php


2 if(!
	$ist
(
$giGlobs
))

4 
	`que_
(
	`dme
(
__FILE__
)."/../../include/common.inc.php");

5 
	}
}

8 
	g$s
 = 
y
();

9 
	g$dsql
->
Execu
('n', 'Select * from `#@__arcatt` ');

10 
	g$r
 = 
$dsql
->
GAay
('n'))

12 
$s
[
$r
['att']] = $arr['attname'];

14 
funi
 
	$IsCommdArchives
(
$iscommd
)

16 
glob
 
$s
;

17 
$
 = '';

18 
	`fܗch
(
$s
 
as
 
$k
=>
$v
)

20 
$v
 = 
	`_subr
($v, 2);

21 
$
 .(
	`eg
(
$k
, 
$iscommd
? ' '.
$v
 : '');

23 
$
 = 
	`im
($sn);

24 if(
$
=='')

28 
	}
}

31 
funi
 
	$GCommdT
(
$t
,
$iscommd
)

37  
$t
;

38 
	}
}

41 
	g$GLOBALS
['RndTrunID'] = 1;

42 
funi
 
	$GC
(
$c1
,
$c2
)

44 
$GLOBALS
['RndTrunID']++;

45 if(
$GLOBALS
['RndTrunID']%2==0)

47  
$c1
;

51  
$c2
;

53 
	}
}

56 
funi
 
	$CheckPic
(
$piame
)

58 if(
$piame
!="")

60  
$piame
;

66 
	}
}

69 
funi
 
	$IsHtmlArchives
(
$ismake
)

71 if(
$ismake
==1)

75 if(
$ismake
==-1)

83 
	}
}

86 
funi
 
	$GRkName
(
$k
)

88 
glob
 
$cAay
,
$dsql
;

89 if(!
	`is_y
(
$cAay
))

91 
$dsql
->
	`SQuy
("Select * from `#@__arcrank` ");

92 
$dsql
->
	`Execu
();

93 
$row
 = 
$dsql
->
	`GObje
())

95 
$cAay
[
$row
->
nk
]=$row->
membme
;

98 if(
	`ist
(
$cAay
[
$k
]))

100  
$cAay
[
$k
];

106 
	}
}

109 
funi
 
	$IsPicArchives
(
$piame
)

111 if(
$piame
 != '')

119 
	}
}

	@dede/inc/inc_menu.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../config.php");

5 
	g$addt
 = '';

8 if(
	g$cfg_adm_chl
 = 'y' && 
cou
(
$adm_logs
) > 0)

10 
$adm_log
 = 
jo
(',', 
$adm_logs
);

11 
	g$dsql
->
SQuy
(" Select channeltype From `#@__arctype` where id in({$admin_catalog}) group by channeltype ");

15 
	g$dsql
->
SQuy
(" Select channeltype From `#@__arctype` group by channeltype ");

17 
	g$dsql
->
Execu
();

18 
	g$ndoChl
 = '';

19 
	g$row
 = 
$dsql
->
	$GObje
())

21 
$ndoChl
 .($ndoChl=='' ? 
$row
->
chy
 : ','.$row->channeltype);

22 
	}
}

23 if(
emy
(
$ndoChl
)
	g$ndoChl
 = 1;

24 
	g$dsql
->
SQuy
("Select id,typename,addcon,mancon From `#@__channeltype` where id in({$candoChannel}) And id<>-1 And isshow=1 order by idsc");

25 
	g$dsql
->
Execu
();

26 
	g$row
 = 
$dsql
->
	$GObje
())

28 
$addt
 .= " <m:itemame='{$row->typename}' ischannel='1'ink='{$row->mancon}?channelid={$row->id}'inkadd='{$row->addcon}?channelid={$row->id}' channelid='{$row->id}'ank=''arget='main' />\r\n";

29 
	}
}

32 
	g$admMu1
 = 
$admMu2
 = '';

33 if(
	g$curLog
->
gUrTy
() >= 10)

35 
$admMu1
 = "<m:top item='1_'ame='频道模型' display='block'ank='t_List,t_AccList,c_List,temp_One'>

36 <
m
:
em
 
me
='内容模型管理' 
lk
='mychl_ma.php' 
nk
='c_Li' 
rg
='main' />

37 <
m
:
em
 
me
='单页文档管理' 
lk
='ms_e.php' 
nk
='mp_O' 
rg
='main'/>

38 <
m
:
em
 
me
='联动类别管理' 
lk
='_ma.php' 
nk
='c_Spe' 
rg
='main' />

39 <
m
:
em
 
me
='自由列表管理' 
lk
='li_ma.php' 
nk
='c_Li' 
rg
='main' />

40 <
m
:
em
 
me
='自定义表单' 
lk
='diy_ma.php' 
nk
='c_Li' 
rg
='main' />

41 </
m
:
t
>

43 
$admMu2
 = "<m:top item='7_'ame='模板管理' display='none'ank='temp_One,temp_Other,temp_MyTag,temp_test,temp_All'>

44 <
m
:
em
 
me
='默认模板管理' 
lk
='ms_ma.php' 
nk
='mp_A' 
rg
='main'/>

45 <
m
:
em
 
me
='标签源码管理' 
lk
='ms_gsour.php' 
nk
='mp_A' 
rg
='main'/>

46 <
m
:
em
 
me
='自定义宏标记' 
lk
='myg_ma.php' 
nk
='mp_MyTag' 
rg
='main'/>

47 <
m
:
em
 
me
='智能标记向导' 
lk
='myg_g_guide.php' 
nk
='mp_Oth' 
rg
='main'/>

48 <
m
:
em
 
me
='全局标记测试' 
lk
='g_.php' 
nk
='mp_Te' 
rg
='main'/>

49 </
m
:
t
>

51 <
m
:
t
 
em
='10_' 
me
='系统设置' 
diy
='ne' 
nk
='sys_User,sys_Group,sys_Edit,sys_Log,sys_Data'>

52 <
m
:
em
 
me
='系统基本参数' 
lk
='sys_fo.php' 
nk
='sys_Ed' 
rg
='main' />

53 <
m
:
em
 
me
='系统用户管理' 
lk
='sys_adm_ur.php' 
nk
='sys_Ur' 
rg
='main' />

54 <
m
:
em
 
me
='用户组设定' 
lk
='sys_group.php' 
nk
='sys_Group' 
rg
='main' />

55 <
m
:
em
 
me
='系统日志管理' 
lk
='log_li.php' 
nk
='sys_Log' 
rg
='main' />

56 <
m
:
em
 
me
='图片水印设置' 
lk
='sys_fo_mk.php' 
nk
='sys_Ed' 
rg
='main' />

57 <
m
:
em
 
me
='自定义文档属性' 
lk
='cڋ_t.php' 
nk
='sys_A' 
rg
='main' />

58 <
m
:
em
 
me
='软件频道设置' 
lk
='so_cfig.php' 
nk
='sys_SoCfig' 
rg
='main' />

59 <
m
:
em
 
me
='防采集串混淆' 
lk
='tie_rg_mix.php' 
nk
='sys_SgMix' 
rg
='main' />

60 <
m
:
em
 
me
='随机模板设置' 
lk
='tie_me_nd.php' 
nk
='sys_SgMix' 
rg
='main' />

61 <
m
:
em
 
me
='计划任务管理' 
lk
='sys_sk.php' 
nk
='sys_Task' 
rg
='main' />

62 <
m
:
em
 
me
='数据库备份/还原' 
lk
='sys_da.php' 
nk
='sys_Da' 
rg
='main' />

63 <
m
:
em
 
me
='SQL命令行工具' 
lk
='sys_sql_quy.php' 
nk
='sys_Da' 
rg
='main' />

64 <
m
:
em
 
me
='文件校验[S]' 
lk
='sys_vifs.php' 
nk
='sys_vify' 
rg
='main' />

65 <
m
:
em
 
me
='病毒扫描[S]' 
lk
='sys_㋡.php' 
nk
='sys_vify' 
rg
='main' />

66 <
m
:
em
 
me
='系统错误修复[S]' 
lk
='sys_.php' 
nk
='sys_vify' 
rg
='main' />

67 </
m
:
t
>

69 <
m
:
t
 
em
='10_6_' 
me
='支付工具' 
diy
='ne' 
nk
='sys_Data'>

70 <
m
:
em
 
me
='点卡产品分类' 
lk
='rds_ty.php' 
nk
='sys_Da' 
rg
='main' />

71 <
m
:
em
 
me
='点卡产品管理' 
lk
='rds_mage.php' 
nk
='sys_Da' 
rg
='main' />

72 <
m
:
em
 
me
='会员产品分类' 
lk
='memb_ty.php' 
nk
='sys_Da' 
rg
='main' />

73 <
m
:
em
 
me
='会员消费记录' 
lk
='memb_ݔis.php' 
nk
='sys_Da' 
rg
='main' />

74 <
m
:
em
 
me
='商店订单记录' 
lk
='shs_ݔis.php' 
nk
='sys_Da' 
rg
='main' />

75 <
m
:
em
 
me
='支付接口设置' 
lk
='sys_fo_y.php' 
nk
='sys_Da' 
rg
='main' />

76 <
m
:
em
 
me
='配货方式设置' 
lk
='shs_divy.php' 
nk
='sys_Da' 
rg
='main' />

77 <
m
:
em
 
me
='汇款账号设置' 
lk
='shs_bk.php' 
nk
='sys_Da' 
rg
='main' />

78 </
m
:
t
>

83 
$musMa
 = "

86 <
m
:
t
 
em
='1_' 
me
='常用操作' 
diy
='block'>

87 <
m
:
em
 
me
='网站栏目管理' 
lk
='log_ma.php' 
ischl
='1' 
addt
='创建栏目' 
lkadd
='log_add.php?lity' 
nk
='t_Li,t_AccLi' 
rg
='main' />

88 <
m
:
em
 
me
='所有档案列表' 
lk
='cڋ_li.php' 
nk
='a_Li,a_AccLi' 
rg
='main' />

89 <
m
:
em
 
me
='等审核的档案' 
lk
='cڋ_li.php?k=-1' 
nk
='a_Check,a_AccCheck' 
rg
='main' />

90 <
m
:
em
 
me
='我发布的文档' 
lk
='cڋ_li.php?mid=".$curLog->gUrID()."' 
nk
='a_Li,a_AccLi,a_MyLi' 
rg
='main' />

91 <
m
:
em
 
me
='评论管理' 
lk
='edback_ma.php' 
nk
='sys_Fdback' 
rg
='main' />

92 <
m
:
em
 
me
='内容回收站' 
lk
='cyg.php' 
ischl
='1' 
addt
='清空回收站' 
addico
='img/gtk-d.g' 
lkadd
='chives_do.php?do=r&aido' 
nk
='a_Li,a_AccLi,a_MyLi' 
rg
='main' />

93 </
m
:
t
>

95 <
m
:
t
 
em
='1_' 
me
='内容管理' 
diy
='block'>

96 
$addt


97 <
m
:
em
 
me
='专题管理' 
ischl
='1' 
lk
='cڋ_s_li.php' 
lkadd
='ec_add.php' 
chlid
='-1' 
nk
='ec_New' 
rg
='main' />

98 </
m
:
t
>

100 <
m
:
t
 
em
='1_' 
me
='附件管理' 
diy
='ne' 
nk
='sys_Upload,sys_MyUpload,plus_文件管理器'>

101 <
m
:
em
 
me
='上传新文件' 
lk
='med_add.php' 
nk
='' 
rg
='main' />

102 <
m
:
em
 
me
='附件数据管理' 
lk
='med_ma.php' 
nk
='sys_Ud,sys_MyUd' 
rg
='main' />

103 <
m
:
em
 
me
='文件式管理器' 
lk
='med_ma.php?do=femag' 
nk
='us_文件管理器' 
rg
='main' />

104 </
m
:
t
>

106 
$admMu1


108 <
m
:
t
 
em
='3_' 
me
='采集管理' 
diy
='ne' 
nk
='co_NewRule,co_ListNote,co_ViewNote,co_Switch,co_GetOut'>

109 <
m
:
em
 
me
='采集节点管理' 
lk
='co_ma.php' 
nk
='co_LiNe' 
rg
='main' />

110 <
m
:
em
 
me
='临时内容管理' 
lk
='co_u.php' 
nk
='co_VwNe' 
rg
='main' />

111 <
m
:
em
 
me
='导入采集规则' 
lk
='co_g_cu.php' 
nk
='co_GOut' 
rg
='main'/>

112 <
m
:
em
 
me
='监控采集模式' 
lk
='co_gh_t.php' 
nk
='co_GOut' 
rg
='main'/>

113 <
m
:
em
 
me
='采集未下载内容' 
lk
='co_do.php?do=c' 
nk
='co_GOut' 
rg
='main'/>

114 </
m
:
t
>

116 <
m
:
t
 
em
='1_3_3' 
me
='批量维护' 
diy
='block'>

117 <
m
:
em
 
me
='更新系统缓存' 
lk
='sys_che_up.php' 
nk
='sys_ArcBch' 
rg
='main' />

118 <
m
:
em
 
me
='文档批量维护' 
lk
='cڋ_bch_up.php' 
nk
='sys_ArcBch' 
rg
='main' />

119 <
m
:
em
 
me
='搜索关键词维护' 
lk
='ch_keywds_ma.php' 
nk
='sys_Keywd' 
rg
='main' />

120 <
m
:
em
 
me
='文档关键词维护' 
lk
='tie_keywds_ma.php' 
nk
='sys_Keywd' 
rg
='main' />

121 <
m
:
em
 
me
='重复文档检测' 
lk
='tie__me.php' 
nk
='sys_ArcBch' 
rg
='main' />

122 <
m
:
em
 
me
='自动摘要|分页' 
lk
='tie_desti_ma.php' 
nk
='sys_Keywd' 
rg
='main' />

123 <
m
:
em
 
me
='TAG标签管理' 
lk
='gs_ma.php' 
nk
='sys_Keywd' 
rg
='main' />

124 <
m
:
em
 
me
='数据库内容替换' 
lk
='sys_da_a.php' 
nk
='sys_ArcBch' 
rg
='main' />

125 </
m
:
t
>

127 <
m
:
t
 
em
='5_' 
me
='自动任务' 
nshowl
='1' 
diy
='block' 
nk
='sys_MakeHtml'>

128 <
m
:
em
 
me
='一键更新网站' 
lk
='makehtml_l.php' 
nk
='sys_MakeHtml' 
rg
='main' />

129 <
m
:
em
 
me
='更新系统缓存' 
lk
='sys_che_up.php' 
nk
='sys_ArcBch' 
rg
='main' />

130 </
m
:
t
>

132 <
m
:
t
 
em
='5_' 
me
='HTML更新' 
nshowl
='1' 
diy
='ne' 
nk
='sys_MakeHtml'>

133 <
m
:
em
 
me
='更新主页HTML' 
lk
='makehtml_homage.php' 
nk
='sys_MakeHtml' 
rg
='main' />

134 <
m
:
em
 
me
='更新栏目HTML' 
lk
='makehtml_li.php' 
nk
='sys_MakeHtml' 
rg
='main' />

135 <
m
:
em
 
me
='更新文档HTML' 
lk
='makehtml_chives.php' 
nk
='sys_MakeHtml' 
rg
='main' />

136 <
m
:
em
 
me
='更新网站地图' 
lk
='makehtml_m_guide.php' 
nk
='sys_MakeHtml' 
rg
='main' />

137 <
m
:
em
 
me
='更新RSS文件' 
lk
='makehtml_rss.php' 
nk
='sys_MakeHtml' 
rg
='main' />

138 <
m
:
em
 
me
='获取JS文件' 
lk
='makehtml_js.php' 
nk
='sys_MakeHtml' 
rg
='main' />

139 <
m
:
em
 
me
='更新专题HTML' 
lk
='makehtml_ec.php' 
nk
='sys_MakeHtml' 
rg
='main' />

140 </
m
:
t
>

142 <
m
:
t
 
em
='6_' 
me
='会员管理' 
diy
='ne' 
nk
='member_List,member_Type'>

143 <
m
:
em
 
me
='注册会员列表' 
lk
='memb_ma.php' 
nk
='memb_Li' 
rg
='main' />

144 <
m
:
em
 
me
='会员级别设置' 
lk
='memb_nk.php' 
nk
='memb_Ty' 
rg
='main' />

145 <
m
:
em
 
me
='积分头衔设置' 
lk
='memb_sces.php' 
nk
='memb_Ty' 
rg
='main' />

146 <
m
:
em
 
me
='会员短信管理' 
lk
='memb_pm.php' 
nk
='memb_Ty' 
rg
='main' />

147 <
m
:
em
 
me
='会员类别管理' 
lk
='memb_mty.php' 
nk
='memb_Ty' 
rg
='main' />

148 </
m
:
t
>

150 
$admMu2


152 <
m
:
t
 
em
='1_10_7_' 
me
='系统帮助' 
diy
='none'>

153 <
m
:
em
 
me
='参考文档' 
lk
='hp://hp.dedecms.com' 
nk
='' 
rg
='_blank' />

154 <
m
:
em
 
me
='推荐主机商' 
lk
='hp://www.dedecms.com/idc/' 
nk
='' 
rg
='_blank' />

155 <
m
:
em
 
me
='官方交流论坛' 
lk
='hp://bbs.dedecms.com' 
nk
='' 
rg
='_blank' />

156 </
m
:
t
>

	@dede/inc/inc_menu_func.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../config.php");

3 
que_
(
DEDEINC
."/dedetag.class.php");

5 
	g$hdTem
 = "<dl class='bitem'><dt onClick='showHide(\"items~cc~\")'><b>~channelname~</b></dt>

6 <
dd
 
y
='diy:~diy~' 
ass
='sem' 
id
='items~cc~'>

7 <
ul
 
ass
='semu'>\
r
\
n
";

9 
$foTem
 = "</ul>\r\n</dd>\r\n</dl>\r\n";

11 
	g$emTem
 = "<li>~link~</li>\r\n";

13 
funi
 
GMus
(
$uk
,
$tos
='main')

15 
glob
 
$ݒem
,
$hdTem
,
$foTem
,
$emTem
;

16 if(
	g$tos
=='main')

18 
$ݒem
 = (
emy
($openitem) ? 1 : $openitem);

19 
	g$mus
 = 
$GLOBALS
['menusMain'];

21 if(
	g$tos
=='module')

23 
$ݒem
 = 100;

24 
	g$mus
 = 
$GLOBALS
['menusMoudle'];

26 
	g$d
 = 
w
 
DedeTagP
();

27 
	g$d
->
SNameS
('m','<','>');

28 
	g$d
->
LdSour
(
$mus
);

29 
	g$d2
 = 
w
 
DedeTagP
();

30 
	g$d2
->
SNameS
('m','<','>');

31 
	g$m
 = 0;

32 
fܗch
(
$d
->
CTags
 
as
 
$i
=>
$ag
)

34 if(
$ag
->
GName
()=='t' && ($ag->
GA
('nk')=='' || 
TePurvw
($ctag->GetAtt('rank')) ))

36 if(
$ݒem
!=999 && !
eg
($ݒem.'_',
$ag
->
GA
('em')&& 
	g$ݒem
!=100) ;

37 
	g$m
++;

38 
	gecho
 "<!-- Im ".(
	g$m
+1)." Strat -->\r\n";

39 
	g$htmp
 = 
r_a
("~chame~",
$ag
->
GA
("me"),
$hdTem
);

40 if(
emy
(
$ݒem
|| 
	g$ݒem
==100)

42 if(
$ag
->
GA
('notshowall')=='1') ;

43 
	g$htmp
 = 
r_a
('~diy~',
$ag
->
GA
('diy'),
$htmp
);

47 if(
	g$ݒem
==
$ag
->
GA
('em'|| 
eg
(
$ݒem
.'_',$ctag->GetAtt('item')) || $openitem=='-1')

48 
$htmp
 = 
r_a
('~display~','block',$htmp);

50 
	g$htmp
 = 
r_a
('~diy~','ne',
$htmp
);

52 
	g$htmp
 = 
r_a
('~cc~',
$m
.'_'.
$ݒem
,
$htmp
);

53 
echo
 
	g$htmp
;

54 
	g$d2
->
LdSour
(
$ag
->
IText
);

55 
fܗch
(
$d2
->
CTags
 
as
 
$j
=>
$ag2
)

57 
$ischl
 = 
im
(
$ag2
->
GA
('ischannel'));

58 if(
	g$ag2
->
GName
()=='em' && (
$ag2
->
GA
('nk')=='' || 
TePurvw
($ctag2->GetAtt('rank')) ) )

60 
$lk
 = "<hf='".
$ag2
->
GA
('link')."'arget='".$ctag2->GetAtt('target')."'>".$ctag2->GetAtt('name')."</a>";

61 if(
	g$ischl
=='1')

63 if(
$ag2
->
GA
('addalt')!='') {

64 
$addt
 = 
$ag2
->
GA
('addalt');

67 
	g$addt
 = '录入新内容';

70 if(
	g$ag2
->
GA
('addico')!='') {

71 
$addico
 = 
$ag2
->
GA
('addico');

74 
	g$addico
 = 'img/gtk-sadd.png';

78 
	g$lk
 = " <div class='items'>

79 <
div
 
ass
='l'>
$lk
</div>\
r
\
n


80 <
div
 
ass
='flrct'>

81 <
a
 
hf
='".$ag2->GA('
lkadd
')."' 
rg
='".$ag2->GA('rg')."'><
img
 
c
='$addico' 
t
='$addt' 
t
='$addalt'/></a>

82 </
div
>

83 </
div
>\
r
\
n
";

88 
	g$lk
 .= "\r\n";

90 
	g$emtmp
 = 
r_a
('~lk~',
$lk
,
$emTem
);

91 
echo
 
	g$emtmp
;

94 
echo
 
	g$foTem
;

95 
	gecho
 "<!-- Im ".(
	g$m
+1)." End -->\r\n";

	@dede/inc/inc_menu_map.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../config.php");

5 
	g$my
 = 
y
(1=>'文档相关',2=>'系统设置',3=>'必须辅助功能',4=>'网站更新操作',5=>'会员相关',6=>'基本模块插件');

8 
	g$addt
 = '';

9 
	g$dsql
->
SQuy
("Select id,typename,addcon,mancon From `#@__channeltype` where id<>-1 And isshow=1 order by idsc");

10 
	g$dsql
->
Execu
();

11 
	g$row
 = 
$dsql
->
	$GObje
())

13 
$addt
 .= " <m:itemame='{$row->typename}' ischannel='1'ink='{$row->mancon}?channelid={$row->id}'inkadd='{$row->addcon}?channelid={$row->id}' channelid='{$row->id}'ank=''arget='main' />\r\n";

14 
	}
}

16 
	g$musMa
 = "

19 <
m
:
t
 
mem
='1' 
em
='1_' 
me
='常用操作' 
diy
='block'>

20 <
m
:
em
 
me
='网站栏目管理' 
lk
='log_ma.php' 
ischl
='1' 
addt
='创建栏目' 
lkadd
='log_add.php?lity' 
nk
='t_Li,t_AccLi' 
rg
='main' />

21 <
m
:
em
 
me
='所有档案列表' 
lk
='cڋ_li.php' 
nk
='a_Li,a_AccLi' 
rg
='main' />

22 <
m
:
em
 
me
='等审核的档案' 
lk
='cڋ_li.php?k=-1' 
nk
='a_Check,a_AccCheck' 
rg
='main' />

23 <
m
:
em
 
me
='我发布的文档' 
lk
='cڋ_li.php?mid=".$curLog->gUrID()."' 
nk
='a_Li,a_AccLi,a_MyLi' 
rg
='main' />

24 <
m
:
em
 
me
='评论管理' 
lk
='edback_ma.php' 
nk
='sys_Fdback' 
rg
='main' />

25 <
m
:
em
 
me
='内容回收站' 
lk
='cyg.php' 
ischl
='1' 
addt
='清空回收站' 
addico
='img/gtk-d.g' 
lkadd
='chives_do.php?do=r&aido' 
nk
='a_Li' 
rg
='main' />

26 </
m
:
t
>

28 <
m
:
t
 
mem
='1' 
em
='1_' 
me
='内容管理' 
diy
='block'>

29 
$addt


30 <
m
:
em
 
me
='专题管理' 
ischl
='1' 
lk
='cڋ_s_li.php' 
lkadd
='ec_add.php' 
chlid
='-1' 
nk
='ec_New' 
rg
='main' />

31 </
m
:
t
>

33 <
m
:
t
 
mem
='1' 
em
='1_' 
me
='频道模型' 
diy
='block' 
nk
='t_List,t_AccList,c_List,temp_One'>

34 <
m
:
em
 
me
='内容模型管理' 
lk
='mychl_ma.php' 
nk
='c_Li' 
rg
='main' />

35 <
m
:
em
 
me
='单页文档管理' 
lk
='ms_e.php' 
nk
='mp_O' 
rg
='main'/>

36 <
m
:
em
 
me
='联动类别管理' 
lk
='_ma.php' 
nk
='c_Spe' 
rg
='main' />

37 <
m
:
em
 
me
='自由列表管理' 
lk
='li_ma.php' 
nk
='c_Li' 
rg
='main' />

38 <
m
:
em
 
me
='自定义表单' 
lk
='diy_ma.php' 
nk
='c_Li' 
rg
='main' />

39 </
m
:
t
>

41 <
m
:
t
 
mem
='3' 
em
='3_' 
me
='采集管理' 
diy
='ne' 
nk
='co_NewRule,co_ListNote,co_ViewNote,co_Switch,co_GetOut'>

42 <
m
:
em
 
me
='采集节点管理' 
lk
='co_ma.php' 
nk
='co_LiNe' 
rg
='main' />

43 <
m
:
em
 
me
='临时内容管理' 
lk
='co_u.php' 
nk
='co_VwNe' 
rg
='main' />

44 <
m
:
em
 
me
='导入采集规则' 
lk
='co_g_cu.php' 
nk
='co_GOut' 
rg
='main'/>

45 <
m
:
em
 
me
='监控采集模式' 
lk
='co_gh_t.php' 
nk
='co_GOut' 
rg
='main'/>

46 <
m
:
em
 
me
='采集未下载内容' 
lk
='co_do.php?do=c' 
nk
='co_GOut' 
rg
='main'/>

47 </
m
:
t
>

49 <
m
:
t
 
mem
='3' 
em
='1_3_3' 
me
='批量维护' 
diy
='block'>

50 <
m
:
em
 
me
='更新系统缓存' 
lk
='sys_che_up.php' 
nk
='sys_ArcBch' 
rg
='main' />

51 <
m
:
em
 
me
='文档批量维护' 
lk
='cڋ_bch_up.php' 
nk
='sys_ArcBch' 
rg
='main' />

52 <
m
:
em
 
me
='搜索关键词维护' 
lk
='ch_keywds_ma.php' 
nk
='sys_Keywd' 
rg
='main' />

53 <
m
:
em
 
me
='文档关键词维护' 
lk
='tie_keywds_ma.php' 
nk
='sys_Keywd' 
rg
='main' />

54 <
m
:
em
 
me
='自动摘要|分页' 
lk
='tie_desti_ma.php' 
nk
='sys_Keywd' 
rg
='main' />

55 <
m
:
em
 
me
='TAG标签管理' 
lk
='gs_ma.php' 
nk
='sys_Keywd' 
rg
='main' />

56 <
m
:
em
 
me
='数据库内容替换' 
lk
='sys_da_a.php' 
nk
='sys_ArcBch' 
rg
='main' />

57 </
m
:
t
>

59 <
m
:
t
 
mem
='4' 
em
='5_' 
me
='自动任务' 
nshowl
='1' 
diy
='block' 
nk
='sys_MakeHtml'>

60 <
m
:
em
 
me
='一键更新网站' 
lk
='makehtml_l.php' 
nk
='sys_MakeHtml' 
rg
='main' />

61 <
m
:
em
 
me
='更新系统缓存' 
lk
='sys_che_up.php' 
nk
='sys_ArcBch' 
rg
='main' />

62 </
m
:
t
>

64 <
m
:
t
 
mem
='4' 
em
='5_' 
me
='HTML更新' 
nshowl
='1' 
diy
='ne' 
nk
='sys_MakeHtml'>

65 <
m
:
em
 
me
='更新主页HTML' 
lk
='makehtml_homage.php' 
nk
='sys_MakeHtml' 
rg
='main' />

66 <
m
:
em
 
me
='更新栏目HTML' 
lk
='makehtml_li.php' 
nk
='sys_MakeHtml' 
rg
='main' />

67 <
m
:
em
 
me
='更新文档HTML' 
lk
='makehtml_chives.php' 
nk
='sys_MakeHtml' 
rg
='main' />

68 <
m
:
em
 
me
='更新网站地图' 
lk
='makehtml_m_guide.php' 
nk
='sys_MakeHtml' 
rg
='main' />

69 <
m
:
em
 
me
='更新RSS文件' 
lk
='makehtml_rss.php' 
nk
='sys_MakeHtml' 
rg
='main' />

70 <
m
:
em
 
me
='获取JS文件' 
lk
='makehtml_js.php' 
nk
='sys_MakeHtml' 
rg
='main' />

71 <
m
:
em
 
me
='更新专题HTML' 
lk
='makehtml_ec.php' 
nk
='sys_MakeHtml' 
rg
='main' />

72 </
m
:
t
>

74 <
m
:
t
 
mem
='3' 
em
='1_6_' 
me
='附件管理' 
diy
='ne' 
nk
='sys_Upload,sys_MyUpload,plus_文件管理器'>

75 <
m
:
em
 
me
='上传新文件' 
lk
='med_add.php' 
nk
='' 
rg
='main' />

76 <
m
:
em
 
me
='附件数据管理' 
lk
='med_ma.php' 
nk
='sys_Ud,sys_MyUd' 
rg
='main' />

77 <
m
:
em
 
me
='文件式管理器' 
lk
='med_ma.php?do=femag' 
nk
='us_文件管理器' 
rg
='main' />

78 </
m
:
t
>

80 <
m
:
t
 
mem
='5' 
em
='6_' 
me
='会员管理' 
diy
='ne' 
nk
='member_List,member_Type'>

81 <
m
:
em
 
me
='会员类别管理' 
lk
='memb_mty.php' 
nk
='memb_Ty' 
rg
='main' />

82 <
m
:
em
 
me
='注册会员列表' 
lk
='memb_ma.php' 
nk
='memb_Li' 
rg
='main' />

83 <
m
:
em
 
me
='会员级别设置' 
lk
='memb_nk.php' 
nk
='memb_Ty' 
rg
='main' />

84 <
m
:
em
 
me
='积分头衔设置' 
lk
='memb_sces.php' 
nk
='memb_Ty' 
rg
='main' />

85 <
m
:
em
 
me
='会员短信管理' 
lk
='memb_pm.php' 
nk
='memb_Ty' 
rg
='main' />

86 </
m
:
t
>

88 <
m
:
t
 
mem
='2' 
em
='10_' 
me
='系统设置' 
diy
='ne' 
nk
='sys_User,sys_Group,sys_Edit,sys_Log,sys_Data'>

89 <
m
:
em
 
me
='系统基本参数' 
lk
='sys_fo.php' 
nk
='sys_Ed' 
rg
='main' />

90 <
m
:
em
 
me
='系统用户管理' 
lk
='sys_adm_ur.php' 
nk
='sys_Ur' 
rg
='main' />

91 <
m
:
em
 
me
='用户组设定' 
lk
='sys_group.php' 
nk
='sys_Group' 
rg
='main' />

92 <
m
:
em
 
me
='系统日志管理' 
lk
='log_li.php' 
nk
='sys_Log' 
rg
='main' />

93 <
m
:
em
 
me
='图片水印设置' 
lk
='sys_fo_mk.php' 
nk
='sys_Ed' 
rg
='main' />

94 <
m
:
em
 
me
='自定义文档属性' 
lk
='cڋ_t.php' 
nk
='sys_A' 
rg
='main' />

95 <
m
:
em
 
me
='软件频道设置' 
lk
='so_cfig.php' 
nk
='sys_SoCfig' 
rg
='main' />

96 <
m
:
em
 
me
='防采集串混淆' 
lk
='tie_rg_mix.php' 
nk
='sys_SgMix' 
rg
='main' />

97 <
m
:
em
 
me
='来源管理' 
lk
='tie_sour_ed.php' 
nk
='sys_Sour' 
rg
='main' />

98 <
m
:
em
 
me
='作者管理' 
lk
='tie_wr_ed.php' 
nk
='sys_Wr' 
rg
='main' />

99 <
m
:
em
 
me
='随机模板设置' 
lk
='tie_me_nd.php' 
nk
='sys_SgMix' 
rg
='main' />

100 <
m
:
em
 
me
='计划任务管理' 
lk
='sys_sk.php' 
nk
='sys_Task' 
rg
='main' />

101 <
m
:
em
 
me
='数据库备份/还原' 
lk
='sys_da.php' 
nk
='sys_Da' 
rg
='main' />

102 <
m
:
em
 
me
='SQL命令行工具' 
lk
='sys_sql_quy.php' 
nk
='sys_Da' 
rg
='main' />

103 <
m
:
em
 
me
='文件校验[S]' 
lk
='sys_vifs.php' 
nk
='sys_vify' 
rg
='main' />

104 <
m
:
em
 
me
='病毒扫描[S]' 
lk
='sys_㋡.php' 
nk
='sys_vify' 
rg
='main' />

105 </
m
:
t
>

107 <
m
:
t
 
mem
='5' 
em
='10_6_' 
me
='支付工具' 
diy
='ne' 
nk
='sys_Data'>

108 <
m
:
em
 
me
='点卡产品分类' 
lk
='rds_ty.php' 
nk
='sys_Da' 
rg
='main' />

109 <
m
:
em
 
me
='点卡产品管理' 
lk
='rds_mage.php' 
nk
='sys_Da' 
rg
='main' />

110 <
m
:
em
 
me
='会员产品分类' 
lk
='memb_ty.php' 
nk
='sys_Da' 
rg
='main' />

111 <
m
:
em
 
me
='会员消费记录' 
lk
='memb_ݔis.php' 
nk
='sys_Da' 
rg
='main' />

112 <
m
:
em
 
me
='商店订单记录' 
lk
='shs_ݔis.php' 
nk
='sys_Da' 
rg
='main' />

113 <
m
:
em
 
me
='支付接口设置' 
lk
='sys_fo_y.php' 
nk
='sys_Da' 
rg
='main' />

114 <
m
:
em
 
me
='配货方式设置' 
lk
='shs_divy.php' 
nk
='sys_Da' 
rg
='main' />

115 <
m
:
em
 
me
='汇款账号设置' 
lk
='shs_bk.php' 
nk
='sys_Da' 
rg
='main' />

116 </
m
:
t
>

118 <
m
:
t
 
mem
='2' 
em
='10_7_' 
me
='模板管理' 
diy
='ne' 
nk
='temp_One,temp_Other,temp_MyTag,temp_test,temp_All'>

119 <
m
:
em
 
me
='默认模板管理' 
lk
='ms_ma.php' 
nk
='mp_A' 
rg
='main'/>

120 <
m
:
em
 
me
='标签源码管理' 
lk
='ms_gsour.php' 
nk
='mp_A' 
rg
='main'/>

121 <
m
:
em
 
me
='自定义宏标记' 
lk
='myg_ma.php' 
nk
='mp_MyTag' 
rg
='main'/>

122 <
m
:
em
 
me
='智能标记向导' 
lk
='myg_g_guide.php' 
nk
='mp_Oth' 
rg
='main'/>

123 <
m
:
em
 
me
='全局标记测试' 
lk
='g_.php' 
nk
='mp_Te' 
rg
='main'/>

124 </
m
:
t
>

129 
$ust
 = '';

130 
	g$dsql
->
SQuy
("Select * From `#@__plus` where isshow=1 order byidsc");

131 
	g$dsql
->
Execu
();

132 
	g$row
 = 
$dsql
->
	$GObje
()) {

133 
$ust
 .
$row
->
murg
."\r\n";

134 
	}
}

136 
	g$musMa
 .= "

137 <
m
:
t
 
mem
='6' 
me
='模块管理' 
c
='6,' 
diy
='block'>

138 <
m
:
em
 
me
='模块管理' 
lk
='modu_ma.php' 
nk
='sys_modu' 
rg
='main' />

139 <
m
:
em
 
me
='上传新模块' 
lk
='modu_ud.php' 
nk
='sys_modu' 
rg
='main' />

140 <
m
:
em
 
me
='模块生成向导' 
lk
='modu_make.php' 
nk
='sys_modu' 
rg
='main' />

141 </
m
:
t
>

143 <
m
:
t
 
mem
='6' 
em
='7' 
me
='辅助插件' 
diy
='block'>

144 <
m
:
em
 
me
='插件管理器' 
lk
='us_ma.php' 
nk
='10' 
rg
='main' />

145 
$ust


146 </
m
:
t
>

149 
$mrg
 = '';

150 
	g$d
 = 
w
 
DedeTagr
();

151 
	g$d
->
SNameS
('m','<','>');

152 
	g$d
->
LdSg
(
$musMa
);

153 
fܗch
(
$my
 
as
 
$k
=>
$bigme
)

155 
$mrg
 .= "<dl class='maptop'>\r\n";

156 
	g$mrg
 .= "<dt class='bigitem'>$bigname</dt>\r\n";

157 
	g$mrg
 .= "<dd>\r\n";

158 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

160 if(
	g$ag
->
GA
('mem')==
$k
)

162 
$mrg
 .= "<dl class='mapitem'>\r\n";

163 
	g$mrg
 ."<dt>".
$ag
->
GA
('name')."</dt>\r\n";

164 
	g$mrg
 .= "<dd>\r\n<ul class='item'>\r\n";

165 
	g$d2
 = 
w
 
DedeTagP
();

166 
	g$d2
->
SNameS
('m','<','>');

167 
	g$d2
->
LdSour
(
$ag
->
IText
);

168 
fܗch
(
$d2
->
CTags
 
as
 
$j
=>
$ag2
)

170 
$mrg
 ."<li><hf='".
$ag2
->
GA
('link')."'arget='".$ctag2->GetAtt('target')."'>".$ctag2->GetAtt('name')."</a></li>\r\n";

172 
	g$mrg
 .= "</ul>\r\n</dd>\r\n</dl>\r\n";

175 
	g$mrg
 .= "</dd>\r\n</dl>\r\n";

	@dede/inc/inc_menu_module.php

1 <?
php


3 
que_
(
dme
(
__FILE__
)."/../config.php");

16 
	g$moduˣt
 = '';

17 
	g$dsql
->
SQuy
("Select * From `#@__sys_module` order by id desc");

18 
	g$dsql
->
Execu
();

19 
	g$row
 = 
$dsql
->
	$GObje
()) {

20 
$moduˣt
 .
$row
->
murg
."\r\n";

21 
	}
}

24 
	g$ust
 = '';

25 
	g$dsql
->
SQuy
("Select * From `#@__plus` where isshow=1 order byidsc");

26 
	g$dsql
->
Execu
();

27 
	g$row
 = 
$dsql
->
	$GObje
()) {

28 
$row
->
murg
 = 
	`r_a
('plus_友情链接', 'plus_友情链接模块', $row->menustring);

29 
$ust
 .
$row
->
murg
."\r\n";

30 
	}
}

32 
	g$admMu
 = '';

33 if(
	g$curLog
->
gUrTy
() >= 10)

35 
$admMu
 = "<m:topame='模块管理' c='6,' display='block'>

36 <
m
:
em
 
me
='模块管理' 
lk
='modu_ma.php' 
nk
='sys_modu' 
rg
='main' />

37 <
m
:
em
 
me
='上传新模块' 
lk
='modu_ud.php' 
nk
='sys_modu' 
rg
='main' />

38 <
m
:
em
 
me
='模块生成向导' 
lk
='modu_make.php' 
nk
='sys_modu' 
rg
='main' />

39 </
m
:
t
>";

42 
$musMoud
 = "

44 
$admMu


45 <
m
:
t
 
em
='7' 
me
='辅助插件' 
diy
='block'>

46 <
m
:
em
 
me
='插件管理器' 
lk
='us_ma.php' 
nk
='10' 
rg
='main' />

47 
$ust


48 </
m
:
t
>

50 
$moduˣt


	@dede/index.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
.'/dedetag.class.php');

4 
	g$deuIcoFe
 = 
DEDEROOT
.'/data/admin/quickmenu.txt';

5 
	g$myIcoFe
 = 
DEDEROOT
.'/da/adm/quickmu-'.
$curLog
->
gUrID
().'.txt';

7 if(!
	$fe_exis
(
$myIcoFe
)) {

8 
$myIcoFe
 = 
$deuIcoFe
;

9 
	}
}

10 
que
(
DEDEADMIN
.'/inc/inc_menu_map.php');

11 
ude
(
DEDEADMIN
.'/templets/index2.htm');

12 
ex
();

	@dede/index_body.php

1 <?
php


2 
que
(
dme
(
__FILE__
).'/config.php');

3 
que
(
DEDEINC
.'/image.func.php');

4 
que
(
DEDEINC
.'/dedetag.class.php');

5 
	g$deuIcoFe
 = 
DEDEROOT
.'/data/admin/quickmenu.txt';

6 
	g$myIcoFe
 = 
DEDEROOT
.'/da/adm/quickmu-'.
$curLog
->
gUrID
().'.txt';

7 if(!
fe_exis
(
$myIcoFe
)
	g$myIcoFe
 = 
$deuIcoFe
;

10 if(
	$emy
(
$do
))

12 
	`que
(
DEDEINC
.'/inc/inc_fun_funAdmin.php');

13 
$vLockFe
 = 
DEDEROOT
.'/data/admin/ver.txt';

14 
$
 = 
	`fݒ
(
$vLockFe
,'r');

15 
$upTime
 = 
	`im
(
	`d
(
$
,64));

16 
	`fo
(
$
);

17 
$oktime
 = 
	`subr
(
$upTime
,0,4).'-'.substr($upTime,4,2).'-'.substr($upTime,6,2);

18 
$offU
 = 
	`SpGNewInfo
();

19 
$dedecmsidc
 = 
DEDEROOT
.'/data/admin/idc.txt';

20 
$
 = 
	`fݒ
(
$dedecmsidc
,'r');

21 
$dedeIDC
 = 
	`d
(
$
,
	`fesize
(
$dedecmsidc
));

22 
	`fo
(
$
);

23 
ude
 
	`DedeInude
('templets/index_body.htm');

24 
	`ex
();

25 
	}
}

30 if(
	g$do
=='addnew')

32 if(
emy
(
$lk
||my(
$t
))

34 
ShowMsg
("链接网址或标题不能为空！","-1");

35 
ex
();

38 
	g$
 = 
fݒ
(
$myIcoFe
,'r');

39 
	g$d
 = 
im
(
d
(
$
,
fesize
(
$myIcoFe
)));

40 
fo
(
$
);

42 
	g$lk
 = 
eg_a
("['\"]",'`',
$lk
);

43 
	g$t
 = 
eg_a
("['\"]",'`',
$t
);

44 
	g$ico
 = 
eg_a
("['\"]",'`',
$ico
);

45 
	g$d
 .= "\r\n<menu:item ico=\"{$ico}\"ink=\"{$link}\"itle=\"{$title}\" />";

47 
	g$myIcoFeTrue
 = 
DEDEROOT
.'/da/adm/quickmu-'.
$curLog
->
gUrID
().'.txt';

48 
	g$
 = 
fݒ
(
$myIcoFeTrue
,'w');

49 
fwre
(
$
,
$d
);

50 
fo
(
$
);

52 
ShowMsg
("成功增加一个项目！","dex_body.php?".
time
());

53 
ex
();

59 if(
	g$do
=='editsave')

61 
$quickmu
 = 
rashes
($quickmenu);

63 
	g$myIcoFeTrue
 = 
DEDEROOT
.'/da/adm/quickmu-'.
$curLog
->
gUrID
().'.txt';

64 
	g$
 = 
fݒ
(
$myIcoFeTrue
,'w');

65 
fwre
(
$
,
$quickmu
);

66 
fo
(
$
);

68 
ShowMsg
("成功修改快捷操作项目！","dex_body.php?".
time
());

69 
ex
();

75 if(
	g$do
=='editshow')

77 
$
 = 
fݒ
(
$myIcoFe
,'r');

78 
	g$d
 = 
im
(
d
(
$
,
fesize
(
$myIcoFe
)));

79 
fo
(
$
);

81 <
fm
 
	gme
='edfm' 
ai
='dex_body.php' 
mhod
='post'>

82 <
put
 
ty
='hidd' 
me
='do' 
vue
='editsave' />

83 <
b
 
width
="100%" 
bd
="0" 
Υacg
="0" 
ηddg
="0">

84 <

>

85 <
td
 
height
='28' 
background
="img/tbg.gif">

86 <
div
 
y
='t:'><
b
>修改快捷操作项</b></div>

87 <
div
 
y
='float:right;padding:3px 10px 0 0;'>

88 <
a
 
hf
="javast:CloTab('edTab')"><
img
 
c
="img/o.gif" 
width
="12" 
height
="12" 
bd
="0" /></a>

89 </
div
>

90 </
td
>

91 </

>

92 <

><
td
 
y
="height:6px;ft-size:1px;bd-t:1px sid #8DA659">&
nb
;</
	gtd
></
	g
>

93 <
	g
>

94 <
	gtd
>

95 按原格式修改/增加
	gXML
项。

96 </
	gtd
>

97 </
	g
>

98 <
	g
>

99 <
td
 
	gign
='center'>

100 <
xa
 
me
="quickmu" 
rows
="10" 
cs
="50" 
y
="width:98%;height:220px"><?
php
 
echo
 
$d
; ?></
	gxa
>

101 </
	gtd
>

102 </
	g
>

103 <
	g
>

104 <
td
 
	gheight
="45" 
ign
="center">

105 <
put
 
ty
="subm" 
me
="Subm" 
vue
="保存项目" 
ass
=" cobg" 
y
="width:80px;cursor:pointer" />

106 &
nb
;

107 <
put
 
	gty
="t" 
me
="t" 
vue
="重设" 
ass
=" cobg" 
y
="width:50px;cursor:pointer" />

108 </
td
>

109 </

>

110 </
b
>

111 </
fm
>

112 <?
php


113 
ex
();

119 if(
	g$do
=='getRightSide')

121 
$quy
 = " Select count(*)s dd From `#@__member` ";

122 
	g$row1
 = 
$dsql
->
GO
(
$quy
);

123 
	g$quy
 = " Select count(*)s dd From `#@__feedback` ";

124 
	g$row2
 = 
$dsql
->
GO
(
$quy
);

126 
	g$chANames
 = 
y
();

127 
	g$quy
 = "Select id,ypename From `#@__channeltype` ";

128 
	g$dsql
->
Execu
('c', 
$quy
);

129 
	g$row
 = 
$dsql
->
GAay
('c'))

131 
$chANames
[
$row
['id']] = $row['typename'];

134 
	g$quy
 = "Select count(channel)s dd, channel From `#@__arctiny` group by channel ";

135 
	g$lArc
 = 0;

136 
	g$chA
 = 
y
();

137 
	g$dsql
->
Execu
('a', 
$quy
);

138 
	g$row
 = 
$dsql
->
GAay
('a'))

140 
$lArc
 +
$row
['dd'];

141 
	g$row
['tyme'] = 
$chANames
[
$row
['channel']];

142 
	g$chA
[] = 
$row
;

145 
	g$quy
 = "Selectrc.id,rc.arcrank,rc.title,rc.channel, ch.editcon From `#@__archives`rc

146 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
 = 
c
.
chl


147 
whe
 
c
.
k
<>-2 
d
 
by
rc.
id
 
desc
 
lim
 0, 6 ";

148 
	g$cA
 = 
y
();

149 
	g$dsql
->
Execu
('m', 
$quy
);

150 
	g$row
 = 
$dsql
->
GAay
('m'))

152 
$cA
[] = 
$row
;

154 
AjaxHd
();

156 <
dl
 
	gass
='dbox'>

157 <
dt
 
ass
='rside'>

158 <
div
 
ass
='l'>信息统计</div>

159 </
dt
>

160 <
dd
 
ass
='intable'>

161 <
b
 
width
="100%" 
ass
="dboxtable">

162 <

>

163 <
td
 
width
='50%' 
ass
='nline'> 会员数： </td>

164 <
td
 
ass
='ƚe'> <?
php
 
echo
 
$row1
['dd']; ?> </
	gtd
>

165 </
	g
>

166 <
	g
>

167 <
td
 
	gass
='nline'> 文档数： </td>

168 <
td
 
ass
='ƚe'> <?
php
 
echo
 
$lArc
; ?> </
	gtd
>

169 </
	g
>

170 <?
php


171 
fܗch
(
$chA
 
as
 
$row
)

174 <
	g
>

175 <
td
 
	gass
='ƚe'> <?
php
 
echo
 
$row
['tyme']; ?>： </
	gtd
>

176 <
td
 
	gass
='ƚe'> <?
php
 
echo
 
$row
['dd']; ?>&
	gnb
; </
	gtd
>

177 </
	g
>

178 <?
	gphp


181 <
	g
>

182 <
	gtd
> 评论数： </td>

183 <
	gtd
> <?
php
 
echo
 
	g$row2
['dd']; ?> </td>

184 </
	g
>

185 </
	gb
>

186 </
	gdd
>

187 </
	gdl
>

189 <
dl
 
	gass
='dbox'>

190 <
dt
 
ass
='rside'>

191 <
div
 
ass
='l'>最新文档</div>

192 </
dt
>

193 <
dd
 
ass
='intable'>

194 <
b
 
width
="100%" 
ass
="dboxtable">

195 <?
php


196 
fܗch
(
$cA
 
as
 
$row
)

198 if(
im
(
$row
['editcon'])=='') {

199 
$row
['editcon'] = 'archives_edit.php';

201 
	g$lkr
 = "·<a href='{$row['editcon']}?aid={$row['id']}&channelid={$row['channel']}'>{$row['title']}</a>";

202 if(
	g$row
['k']==-1
$lkr
 .= "<font color='red'>(未审核)</font>";

204 <
	g
>

205 <
td
 
	gass
='nline'>

206 <?
php
 
echo
 
$lkr
; ?>

207 </
	gtd
>

208 </
	g
>

209 <?
	gphp


212 </
	gb
>

213 </
	gdd
>

214 </
	gdl
>

215 <?
php


216 
ex
();

	@dede/index_menu.php

1 <?
php


2 
que
(
dme
(
__FILE__
).'/config.php');

3 
que
(
DEDEADMIN
.'/inc/inc_menu.php');

4 
que
(
DEDEADMIN
.'/inc/inc_menu_func.php');

5 
	g$ݒem
 = (
emy
(
$ݒem
) ? 1 : $openitem);

6 
ude
 
DedeInude
('templets/index_menu2.htm');

	@dede/index_menu_load.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
AjaxHd
();

4 if(
	g$ݒem
 != 100)

6 
que
(
dme
(
__FILE__
).'/inc/inc_menu.php');

7 
que
(
DEDEADMIN
.'/inc/inc_menu_func.php');

8 
GMus
(
$curLog
->
gUrRk
(),'main');

9 
ex
();

13 
	g$ݒem
 = 0;

14 
que
(
dme
(
__FILE__
).'/inc/inc_menu_module.php');

15 
que
(
DEDEADMIN
.'/inc/inc_menu_func.php');

16 
GMus
(
$curLog
->
gUrRk
(),'module');

17 
ex
();

	@dede/index_menu_module.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

4 if(
	g$curLog
->
	gadmSty
!='dedecms')

6 
hd
("location:index_menu.php?openitem=100");

7 
ex
();

10 
que
(
DEDEADMIN
.'/inc/inc_menu_module.php');

11 
que
(
DEDEADMIN
.'/inc/inc_menu_func.php');

13 <
	ghtml
>

14 <
	ghd
>

15 <
	gt
>
DedeCms
 
	gmu
</title>

16 <
lk
 
	gl
="ysht" 
hf
="img/ba.css" 
ty
="text/css" />

17 <
lk
 
l
="ysht" 
hf
="img/mud.css" 
ty
="text/css" />

18 <
ma
 
hp
-
equiv
="Cڋ-Ty" 
cڋ
="text/html; charset=utf-8" />

19 <
ba
 
rg
="main" />

20 </
hd
>

21 <
st
 
nguage
="javascript">

22 
funi
 
	$showHide
(
objme
)

24 
v
 
obj
 = 
documt
.
	`gEmtById
(
objme
);

25 if(
obj
.
y
.
diy
 == 'block' || obj.style.display =='') obj.style.display = 'none';

26 
obj
.
y
.
diy
 = 'block';

27 
	}
}

28 </
	gst
>

29 <
ba
 
	grg
="main">

30 <
body
 
mg
="0" 
tmg
="0" 
rg
="main">

31 <
b
 
width
='100%' 
height
="100%" 
bd
='0' 
Υacg
='0' 
ηddg
='0'>

32 <

>

33 <
td
 
y
='ddg-:3px;ddg-t:8px' 
vign
="top">

34 <?
php


35 
GMus
(
$curLog
->
gUrRk
(),'module');

37 </
	gtd
>

38 </
	g
>

39 </
	gb
>

40 <
b
 
	gwidth
="120" 
bd
="0" 
ign
="" 
ηddg
="0" 
Υacg
="0">

41 <

><
td
 
height
="6"></td></tr>

42 </
b
>

43 </
body
>

44 </
html
>

	@dede/index_top.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 if(
	g$curLog
->
	gadmSty
=='dedecms')

5 
ude
 
DedeInude
('templets/index_top1.htm');

9 
ude
 
DedeInude
('templets/index_top2.htm');

	@dede/log_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Log');

4 if(
	$emy
(
$do
))

6 
	`ShowMsg
("你没指定任何参数！","javascript:;");

7 
	`ex
();

8 
	}
}

11 if(
	g$do
=="clear")

13 
$dsql
->
ExecuNeQuy
("Delete From #@__log");

14 
ShowMsg
("成功清空所有日志！","log_list.php");

15 
ex
();

17 if(
	g$do
=="del")

19 
$bku
 = 
ist
(
$_COOKIE
['ENV_GOBACK_URL']) ? $_COOKIE['ENV_GOBACK_URL'] : "log_list.php";

20 
	g$ids
 = 
exode
('`',
$ids
);

21 
	g$dquy
 = "";

22 
fܗch
(
$ids
 
as
 
$id
)

24 if(
	g$dquy
=="")

26 
$dquy
 .= "id='$id' ";

30 
	g$dquy
 .= " Orid='$id' ";

33 if(
	g$dquy
!=""
$dquy
 = " where ".$dquery;

34 
	g$dsql
->
ExecuNeQuy
("Delete From #@__log $dquery");

35 
ShowMsg
("成功删除指定的日志！",
$bku
);

36 
ex
();

40 
ShowMsg
("无法识别你的请求！","javascript:;");

41 
ex
();

	@dede/log_list.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Log');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
que_
(
DEDEINC
."/common.func.php");

6 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

7 
	g$sql
 = 
$whe
 = "";

8 if(
	$emy
(
$admid
))

10 
$admid
 = 0;

11 
	}
}

12 if(
	$emy
(
$c
))

14 
$c
 = "";

15 
	}
}

16 if(
	$emy
(
$dtime
))

18 
$dtime
 = 0;

19 
	}
}

20 if(
	g$admid
>0)

22 
	g$whe
 .= " And #@__log.adminid='$adminid' ";

24 if(
	g$c
!="")

26 
$whe
 .= " And #@__log.cipike '%$cip%' ";

28 if(
	g$dtime
>0)

30 
	g$nowtime
 = 
time
();

31 
	g$ime
 = 
$nowtime
 - (
$dtime
*24*3600);

32 
	g$whe
 .= " And #@__log.dtime>'$starttime' ";

34 
	g$sql
 = "Select #@__log.*,#@__admin.userid From #@__log

35 

 
jo
 #@
__adm
 

 #@__adm.
id
=#@
__log
.
admid


36 
whe
 1=1 
$whe
 
d
 
by
 #@
__log
.
lid
 
desc
";

37 
$admli
 = "";

38 
	g$dsql
->
SQuy
("Select id,uname From #@__admin");

39 
	g$dsql
->
Execu
('admin');

40 
	g$myrow
 = 
$dsql
->
GObje
('admin'))

42 
$admli
 .="<option value='{$myrow->id}'>{$myrow->uname}</option>\r\n";

44 
	g$dli
 = 
w
 
DaLiCP
();

45 
	g$dli
->
	ggeSize
 = 20;

46 
	g$dli
->
SPam
("admid",
$admid
);

47 
	g$dli
->
SPam
("c",
$c
);

48 
	g$dli
->
SPam
("dtime",
$dtime
);

49 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/log_list.htm");

50 
	g$dli
->
SSour
(
$sql
);

51 
	g$dli
->
Diy
();

	@dede/login.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 
que_
(
DEDEINC
.'/userlogin.class.php');

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

10 if
is_d
(
dme
(
__FILE__
).'/../install') )

12 if(!
fe_exis
(
dme
(
__FILE__
).'/../install/install_lock.txt') )

14 
	g$
 = 
fݒ
(
dme
(
__FILE__
).'/../l/l_lock.txt', 'w'

 
d
('安装目录无写入权限，无法进行写入锁定文件，请安装完毕删除安装目录！');

15 
fwre
(
$
,'ok');

16 
fo
(
$
);

19 if
fe_exis
("../install/index.php") ) {

20 @
me
("../install/index.php", "../install/index.php.bak");

22 if
fe_exis
("../install/module-install.php") ) {

23 @
me
("../install/module-install.php", "../install/module-install.php.bak");

27 
	g$curu
 = 
GCurU
();

28 if(
egi
('/dede/log',
$curu
))

30 
	g$dmsg
 = '<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color=\'red\'><b>您的管理目录使用默认名称dede，建议在FTP里把它修改为其它名称，那样会更安全！</b></font>';

34 
	g$dmsg
 = '';

38 
	g$admds
 = 
exode
('/',
r_a
("\\",'/',
dme
(
__FILE__
)));

39 
	g$admd
 = 
$admds
[
cou
($admindirs)-1];

40 if(
	g$do
=='login')

42 
$vide
 = 
emy
($vide? '' : 
ow
(
im
($validate));

43 
	g$svi
 = 
ow
(
GCkVdVue
());

44 if(
	g$vide
=='' || 
$vide
 !
$svi
)

46 
RetVdVue
();

47 
ShowMsg
('验证码不正确!','');

51 
	g$curLog
 = 
w
 
urLog
(
$admd
);

52 if(!
emy
(
$urid
&& !emy(
$pwd
))

54 
	g$s
 = 
$curLog
->
checkUr
(
$urid
,
$pwd
);

57 if(
	g$s
==1)

59 
$curLog
->
kpUr
();

60 if(!
emy
(
$gage
))

62 
ShowMsg
('成功登录，正在转向管理管理主页！',
$gage
);

63 
ex
();

67 
ShowMsg
('成功登录，正在转向管理管理主页！',"index.php");

68 
ex
();

73 if(
	g$s
==-1)

75 
ShowMsg
('你的用户名不存在!','');

79 
ShowMsg
('你的密码错误!','');

86 
ShowMsg
('用户和密码没填写完整!','');

90 
ude
('templets/login.htm');

	@dede/makehtml_all.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/channelunit.func.php");

4 
	g$ai
 = (
emy
(
$ai
) ? '' : $action);

7 if(
	g$ai
=='')

9 
que_
(
DEDEADMIN
."/templets/makehtml_all.htm");

10 
ex
();

12 if(
	g$ai
=='make')

15 if(
emy
(
$
))

17 
$
 = 1;

24 if(
	g$
==1)

26 
$ime
 = 
GMkTime
($starttime);

27 
	g$mkvue
 = (
$uy
=='time' ? 
$ime
 : 
$tid
);

28 
OimizeDa
(
$dsql
);

29 
ShowMsg
("完成数据优化，现在开始更新文档！","makehtml_all.php?action=make&step=2&uptype=$uptype&mkvalue=$mkvalue");

30 
ex
();

37 if(
	g$
==2)

39 
ude_
(
DEDEADMIN
."/makehtml_archives_action.php");

40 
ex
();

47 if(
	g$
==3)

49 
ude_
(
DEDEINC
."/arc.partview.class.php");

50 
	g$pv
 = 
w
 
PtVw
();

51 
	g$row
 = 
$pv
->
dsql
->
GO
("Select * From `#@__homepageset` ");

52 
	g$m
 = 
r_a
("{y}",
$cfg_df_y
,
$row
['templet']);

53 
	g$homeFe
 = 
DEDEADMIN
.'/'.
$row
['position'];

54 
	g$homeFe
 = 
r_a
("\\",'/',
$homeFe
);

55 
	g$homeFe
 = 
eg_a
('/{1,}','/',
$homeFe
);

56 
	g$pv
->
STem
(
$cfg_bad
.
$cfg_ms_d
.'/'.
$m
);

57 
	g$pv
->
SaveToHtml
(
$homeFe
);

58 
	g$pv
->
Clo
();

59 
ShowMsg
("完成更新所有文档，现在开始更新栏目页！","makehtml_all.php?action=make&step=4&uptype=$uptype&mkvalue=$mkvalue");

60 
ex
();

67 if(
	g$
==4)

69 
$mkvue
 = 
tv
($mkvalue);

70 
	g$tyidsok
 = 
$tyids
 = 
y
();

71 
	g$admID
 = 
$curLog
->
gUrID
();

72 
	g$mkchefe
 = 
DEDEROOT
."/data/mkall_cache_{$adminID}.php";

73 if(
	g$uy
=='l' || 
emy
(
$mkvue
))

75 
ShowMsg
("不需要进行初处理，现更新所有栏目！","makehtml_list_action.php?gotype=mkallct");

76 
ex
();

80 if(
	g$uy
=='time')

82 
$quy
 = "Se DISTINCTyid From `#@__y` whndd>=".
GMkTime
(
$mkvue
)." Andrcrank>-1";

86 
	g$quy
 = "Select DISTINCTypeid From `#@__arctiny` where id>=$mkvalue Andrcrank>-1";

88 
	g$dsql
->
SQuy
(
$quy
);

89 
	g$dsql
->
Execu
();

90 
	g$row
 = 
$dsql
->
GAay
())

92 
$tyids
[
$row
['typeid']] = 1;

95 
fܗch
(
$tyids
 
as
 
$k
=>
$v
)

97 
$vs
 = 
y
();

98 
	g$vs
 = 
GPtIds
(
$k
);

99 if!
ist
(
$tyidsok
[
$k
]) )

101 
	g$tyidsok
[
$k
] = 1;

103 
fܗch
(
$vs
 
as
 
$k
=>
$v
)

105 if(!
ist
(
$tyidsok
[
$v
]))

107 
$tyidsok
[
$v
] = 1;

112 
	g$
 = 
fݒ
(
$mkchefe
,'w'

 
d
("无法写入缓存文件：{$mkcachefile} 所以无法更新栏目！");

113 if(
cou
(
$tyidsok
)>0)

115 
fwre
(
$
,"<"."?php\r\n");

116 
	g$i
 = -1;

117 
fܗch
(
$tyidsok
 
as
 
$k
=>
$t
)

119 if(
$k
!='')

121 
$i
++;

122 
fwre
(
$
,"\$idArray[$i]={$k};\r\n");

125 
fwre
(
$
,"?".">");

126 
fo
(
$
);

127 
ShowMsg
("完成栏目缓存处理，现转向更新栏目！","makehtml_list_action.php?gotype=mkall");

128 
ex
();

132 
fo
(
$
);

133 
ShowMsg
("没有可更新的栏目，现在作最后数据优化！","makehtml_all.php?action=make&step=10");

134 
ex
();

142 if(
	g$
==10)

144 
$admID
 = 
$curLog
->
gUrID
();

145 
	g$mkchefe
 = 
DEDEDATA
."/mkall_cache_{$adminID}.php";

146 @
uƚk
(
$mkchefe
);

147 
OimizeDa
(
$dsql
);

148 
ShowMsg
("完成所有文件的更新！","javascript:;");

149 
ex
();

155 
funi
 
	$OimizeDa
(
$dsql
)

157 
glob
 
$cfg_dbefix
;

158 
$bs
 = 
	`y
("{$cfg_dbprefix}archives","{$cfg_dbprefix}arctiny");

159 
$dsql
->
	`SQuy
("Select maintable,addtable From `#@__channeltype` ");

160 
$dsql
->
	`Execu
();

161 
$row
 = 
$dsql
->
	`GObje
())

163 
$addb
 = 
	`r_a
('#@__',
$cfg_dbefix
,
$row
->
addb
);

164 if(
$addb
!='' && !
	`_y
($addb,
$bs
)) $tptables[] = $addtable;

166 
$b
 = '';

167 
	`fܗch
(
$bs
 
as
 
$t

$b
 .= ($tptable=='' ? "`{$t}`" : ",`{$t}`" );

168 
$dsql
->
	`ExecuNeQuy
(" OPTIMIZE TABLE $tptable; ");

169 
	}
}

	@dede/makehtml_archives.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/typelink.class.php");

4 
ude
 
DedeInude
('templets/makehtml_archives.htm');

	@dede/makehtml_archives_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_MakeHtml');

4 
que_
(
DEDEINC
."/arc.archives.class.php");

6 
	g$e1
 = 
ExecTime
();

7 
	g$tid
 = (
emy
(
$tid
) ? -1 : $startid);

8 
	g$did
 = (
emy
(
$did
) ? 0 : $endid);

9 
	g$tdd
 = (
emy
(
$tdd
) ? 0 : $startdd);

10 
	g$gesize
 = (
emy
(
$gesize
) ? 20 : $pagesize);

11 
	g$tٮnum
 = (
emy
(
$tٮnum
) ? 0 : $totalnum);

12 
	g$tyid
 = (
emy
(
$tyid
) ? 0 : $typeid);

13 
	g$ime
 = (
emy
(
$ime
) ? 0 : $seltime);

14 
	g$ime
 = (
emy
(
$ime
) ? '' : $stime );

15 
	g$ime
 = (
emy
(
$ime
) ? '' : $etime);

16 
	g$sime
 = (
emy
(
$sime
) ? 0 : $sstime);

17 
	g$mkvue
 = (
emy
(
$mkvue
) ? 0 : $mkvalue);

20 if(!
	$emy
(
$uy
))

22 if(
$uy
!='time')

24 
$tid
 = 
$mkvue
;

26 
$t1
 = 
$mkvue
;

28 
	}
}

31 
	g$uy
 = '';

35 
	g$idsql
 = '';

36 
	g$gwhe
 = (
$tid
==-1 ? " wherercrank=0 " : " where id>=$startid Andrcrank=0 ");

38 if(
	g$did
 > 
	g$tid
 && $startid > 0) {

39 
	g$gwhe
 .= " And id <= $endid ";

42 if(
	g$tyid
!=0) {

43 
$ids
 = 
GSIds
(
$tyid
);

44 
	g$gwhe
 .= " Andypeid in($ids) ";

47 if(
	g$idsql
=='') {

48 
$idsql
 = 
$gwhe
;

51 if(
	g$ime
==1)

53 
$t1
 = 
GMkTime
(
$ime
);

54 
	g$t2
 = 
GMkTime
(
$ime
);

55 
	g$idsql
 .= " And (senddate >= $t1 And senddate <= $t2) ";

57 if(
ist
(
$t1
&& 
	$is_numic
(
$t1
))

59 
$idsql
 .= " And senddate >= $t1 ";

60 
	}
}

63 if(
	g$tٮnum
==0)

65 
$row
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__arctiny` $idsql");

66 
	g$tٮnum
 = 
$row
['dd'];

68 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arccache` ");

72 if(
	g$tٮnum
 > 
	g$tdd
+
	g$gesize
) {

73 
	g$limSql
 = "imit $startdd,$pagesize";

76 
	g$limSql
 = "im $tdd,".(
$tٮnum
 - 
$tdd
);

79 
	g$tjnum
 = 
$tdd
;

80 if(
	$emy
(
$sime
)) {

81 
$sime
 = 
	`time
();

82 
	}
}

85 if(
	g$tٮnum
 > 500 && 
	$emy
(
$tyid
)) {

86 
$dsql
->
	`Execu
('out',"Select id From `#@__arctiny` $idsql order byypeidsc $limitSql");

87 
	}
}

89 
	g$dsql
->
Execu
('out',"Select id From `#@__arctiny` $idsql $limitSql");

92 
	g$row
=
$dsql
->
GObje
('out'))

94 
$tjnum
++;

95 
	g$id
 = 
$row
->
id
;

96 
	g$ac
 = 
w
 
Archives
(
$id
);

97 
	g$ru
 = 
$ac
->
MakeHtml
();

100 
	g$t2
 = 
ExecTime
();

101 
	g$t2
 = (
$t2
 - 
$e1
);

102 
	g$ime
 = 
time
(- 
$sime
;

103 
	g$ime
 = 
numb_fm
((
$ime
 / 60),2);

106 
	g$tjn
 = 
$tٮnum
>0 ? 

(
$tjnum
/$totalnum) * 100 ) : 100;

107 
	g$dvn
 = 
$tjn
 * 2;

108 
	g$tja
 = "<div style='width:200;height:15;border:1px solid #898989;text-align:left'><div style='width:$dvlen;height:15;background-color:#829D83'></div></div>";

109 
	g$tja
 ."<br/>本次用时：".
numb_fm
(
$t2
,2)."，总用时：$im分钟，到达位置：".(
	g$tdd
+
	g$gesize
)."<br/>完成创建文件总数的：$tjlen %，继续执行任务...";

121 if(
	g$tjnum
 < 
	g$tٮnum
)

123 
	g$nu
 = "makehtml_archives_action.php?endid=$endid&startid=$startid&typeid=$typeid";

124 
	g$nu
 ."&tٮnum=$tٮnum&tdd=".(
$tdd
+
$gesize
)."&pagesize=$pagesize";

125 
	g$nu
 ."&ime=$ime&sime=$sime&ime=".
ucode
(
$ime
)."&ime=".ucode(
$ime
)."&uptype=$uptype&mkvalue=$mkvalue";

126 
ShowMsg
(
$tja
,
$nu
,0,100);

127 
ex
();

131 if(
	g$tyid
!='')

133 
ShowMsg
("生成文件：$totalnum 总用时：{$ttime} 分钟，现转向当前栏目更新&gt;&gt;","makehtml_list_action.php?typeid=$typeid&uptype=all&maxpagesize=50&upnext=1");

137 if(
	g$uy
=='') {

138 
ShowMsg
("完成所有创建任务！，生成文件：$totalnum 总用时：{$ttime} 分钟。","javascript:;");

141 
ShowMsg
("完成文档HTML更新任务，现在开始进行主页更新...","makehtml_all.php?action=make&step=3&uptype=$uptype&mkvalue=$mkvalue");

	@dede/makehtml_freelist.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEADMIN
."/templets/makehtml_freelist.htm");

	@dede/makehtml_freelist_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_MakeHtml');

4 
que_
(
DEDEINC
."/arc.freelist.class.php");

5 if(
	$emy
(
$tid
))

7 
$tid
 = 0;

8 
	}
}

9 
	g$ci
 = "id >= $startid ";

10 if(!
emy
(
$did
&& 
	g$did
>=
$tid
)

12 
$ci
 .= " Andid <= $endid ";

14 
hd
("Content-Type:ext/html; charset={$cfg_soft_lang}");

15 
	g$dsql
->
SQuy
("Selectid From #@__freelist where $ci");

16 
	g$dsql
->
Execu
();

17 
	g$row
=
$dsql
->
	$GAay
())

19 
$idAay
[] = 
$row
['aid'];

20 
	}
}

21 if(!
	$ist
(
$go
))

23 
$go
=0;

24 
	}
}

25 if(
	$emy
(
$idAay
))

27 
$idAay
 = '';

28 
	}
}

29 
	g$tٮge
=
cou
(
$idAay
);

30 if(
	$ist
(
$idAay
[
$go
]))

32 
$lid
 = 
$idAay
[
$go
];

33 
	}

	g}


35 
ShowMsg
( "完成所有文件创建！", 'javascript:;');

36 
ex
();

38 
	g$lv
 = 
w
 
FeLi
(
$lid
);

39 
	g$ٮge
 = 
$lv
->
TٮPage
;

40 if(
	$emy
(
$mkge
))

42 
$mkge
 = 1;

43 
	}
}

44 if(
	$emy
(
$maxgesize
))

46 
$maxgesize
 = 50;

47 
	}
}

50 if(
	g$ٮge
<=
$maxgesize
)

52 
$lv
->
MakeHtml
();

53 
	g$fishTy
 = 
ue
;

56 
	g$lv
->
MakeHtml
(
$mkge
,
$maxgesize
);

57 
	g$fishTy
 = 
l
;

58 
	g$mkge
 = 
$mkge
 + 
$maxgesize
;

59 if
	g$mkge
 >(
$ٮge
+1) )

61 
$fishTy
 = 
ue
;

64 
	g$lv
->
Clo
();

65 
	g$xage
 = 
$go
+1;

66 if(
	g$xage
==
$tٮge
)

68 
ShowMsg
( "完成所有文件创建！", 'javascript:;');

72 if(
	g$fishTy
)

74 
	g$gou
 = "makehtml_freelist_action.php?maxpagesize=$maxpagesize&startid=$startid&endid=$endid&pageno=$nextpage";

75 
ShowMsg
("成功创建列表：".
$tid
."，继续进行操作！",
$gou
,0,100);

79 
	g$gou
 = "makehtml_freelist_action.php?mkpage=$mkpage&maxpagesize=$maxpagesize&startid=$startid&endid=$endid&pageno=$pageno";

80 
ShowMsg
("列表：".
$tid
."，继续进行操作...",
$gou
,0,100);

83 
	g$dsql
->
ExecuNeQuy
("Update `#@__freelist` setodefault='1' whereid='$startid';");

	@dede/makehtml_homepage.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_MakeHtml');

4 
que_
(
DEDEINC
."/arc.partview.class.php");

5 if(
	$emy
(
$do
))

7 
$do
 = '';

8 
	}
}

9 if(
	g$do
=="view")

11 
$pv
 = 
w
 
PtVw
();

12 
	g$m
 = 
r_a
("{y}",
$cfg_df_y
,
$m
);

13 
	g$pv
->
STem
(
$cfg_bad
.
$cfg_ms_d
."/".
$m
);

14 
	g$pv
->
Diy
();

15 
ex
();

17 if(
	g$do
=="make")

19 
$homeFe
 = 
DEDEADMIN
."/".
$posi
;

20 
	g$homeFe
 = 
r_a
("\\","/",
$homeFe
);

21 
	g$homeFe
 = 
r_a
("//","/",
$homeFe
);

22 
	g$
 = 
fݒ
(
$homeFe
,"w"

 
d
("你指定的文件名有问题，无法创建文件");

23 
fo
(
$
);

24 if(
	g$vet
==1)

26 
$iquy
 = "update `#@__homepageset` setemplet='$templet',position='$position' ";

27 
	g$dsql
->
ExecuNeQuy
(
$iquy
);

29 
	g$m
 = 
r_a
("{y}",
$cfg_df_y
,
$m
);

30 
	g$pv
 = 
w
 
PtVw
();

31 
	g$GLOBALS
['_arclistEnv'] = 'index';

32 
	g$pv
->
STem
(
$cfg_bad
.
$cfg_ms_d
."/".
$m
);

33 
	g$pv
->
SaveToHtml
(
$homeFe
);

34 
	gecho
 "成功更新主页HTML：".
	g$homeFe
;

35 
	gecho
 "<br/><br/><a href='$position'arget='_blank'>浏览...</a>";

36 
ex
();

38 
	g$row
 = 
$dsql
->
GO
("Select * From #@__homepageset");

39 
ude
 
DedeInude
('templets/makehtml_homepage.htm');

	@dede/makehtml_js.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/typelink.class.php");

4 
ude
 
DedeInude
('templets/makehtml_js.htm');

	@dede/makehtml_js_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_MakeHtml');

4 
que_
(
DEDEINC
."/arc.partview.class.php");

5 if(
	$emy
(
$tyid
))

7 
$tyid
 = 0;

8 
	}
}

9 if(
	$emy
(
$m
))

11 
$m
 = "plus/js.htm";

12 
	}
}

13 if(
	$emy
(
$uy
))

15 
$uy
 = "all";

16 
	}
}

17 if(
	g$uy
 == "all")

19 
$row
 = 
$dsql
->
GO
("Select id From #@__arctype where id>'$typeid' And ispart<>2 order by idscimit 0,1;");

20 if(!
is_y
(
$row
))

22 
	gecho
 "完成所有文件更新！";

23 
ex
();

27 
	g$pv
 = 
w
 
PtVw
(
$row
['id']);

28 
	g$pv
->
STem
(
$cfg_bad
.
$cfg_ms_d
."/".
$m
);

29 
	g$pv
->
SaveToHtml
(
$cfg_bad
.
$cfg_cmh
."/da/js/".
$row
['id'].".js");

30 
	g$tyid
 = 
$row
['id'];

31 
ShowMsg
("成功更新".
$cfg_cmh
."/da/js/".
$row
['id'].".js，继续进行操作！","makehtml_js_action.php?typeid=$typeid",0,100);

32 
ex
();

37 
	g$pv
 = 
w
 
PtVw
(
$tyid
);

38 
	g$pv
->
STem
(
$cfg_bad
.
$cfg_ms_d
."/".
$m
);

39 
	g$pv
->
SaveToHtml
(
$cfg_bad
.
$cfg_cmh
."/da/js/".
$tyid
.".js");

40 
	gecho
 "成功更新".
	g$cfg_cmh
."/da/js/".
	g$tyid
.".js！";

41 
	gecho
 "预览：";

42 
	gecho
 "<hr>";

43 
	gecho
 "<sc='".
	g$cfg_cmh
."/da/js/".
	g$tyid
.".js'></script>";

44 
ex
();

	@dede/makehtml_list.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/typelink.class.php");

4 
ude
 
DedeInude
('templets/makehtml_list.htm');

	@dede/makehtml_list_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_MakeHtml');

4 
que_
(
DEDEROOT
."/data/cache/inc_catalog_base.inc");

5 
que_
(
DEDEINC
."/channelunit.func.php");

7 if(!
ist
(
$uext
)
	g$uext
 = 1;

8 if(
emy
(
$gy
)
	g$gy
 = '';

9 if(
emy
(
$go
)
	g$go
 = 0;

10 if(
emy
(
$mkge
)
	g$mkge
 = 1;

11 if(
emy
(
$tyid
)
	g$tyid
 = 0;

12 if(!
ist
(
$uage
)
	g$uage
 = 0;

13 if(
emy
(
$maxgesize
)
	g$maxgesize
 = 50;

14 
	g$admID
 = 
$curLog
->
gUrID
();

18 if(
	g$gy
=='' || 
$gy
=='mkallct')

20 if(
$uext
==1 || 
$tyid
==0)

22 if(
$tyid
>0) {

23 
$tidss
 = 
GSIds
(
$tyid
,0);

24 
	g$idAay
 = 
exode
(',',
$tidss
);

26 
fܗch
(
$_Cs
 
as
 
$k
=>
$v

$idAay
[] = $k;

29 
	g$idAay
 = 
y
();

30 
	g$idAay
[] = 
$tyid
;

34 if(
	g$gy
=='mkall')

36 
$uage
 = 1;

37 
	g$mkchefe
 = 
DEDEROOT
."/data/mkall_cache_{$adminID}.php";

38 
	g$idAay
 = 
y
();

39 if(
fe_exis
(
$mkchefe
)
que_
($mkcachefile);

43 
	g$tٮge
=
cou
(
$idAay
);

44 if(
	$ist
(
$idAay
[
$go
]))

46 
$tid
 = 
$idAay
[
$go
];

47 
	}
}

50 if(
	g$gy
=='')

52 
ShowMsg
("完成所有列表更新！","javascript:;");

53 
ex
();

55 if(
	g$gy
=='mkl' || 
$gy
=='mkallct')

57 
ShowMsg
("完成所有栏目列表更新，现在作最后数据优化！","makehtml_all.php?action=make&step=10");

58 
ex
();

62 if(
	g$go
==0 && 
$mkge
==1)

64 
$dsql
->
ExecuNeQuy
("Delete From `#@__arccache` ");

67 
	g$u
 = '';

70 if(!
	$emy
(
$tid
))

72 if(!
	`ist
(
$_Cs
[
$tid
]))

74 
	`showmsg
('没有该栏目数据, 可能缓存文件(/data/cache/inc_catalog_base.inc)没有更新, 请检查是否有写入权限');

75 
	`ex
();

77 if(
$_Cs
[
$tid
][1]>0)

79 
	`que_
(
DEDEINC
."/arc.listview.class.php");

80 
$lv
 = 
w
 
	`LiVw
(
$tid
);

84 
	`que_
(
DEDEINC
."/arc.sglistview.class.php");

85 
$lv
 = 
w
 
	`SgLiVw
(
$tid
);

87 if(
$lv
->
TyLk
->
TyInfos
['it']==0 && $lv->TyLk->TyInfos['isdeu']!=-1
$ٮge
 = $lv->
TٮPage
;

88 
$ٮge
 = 1;

90 if(
$ٮge
 <
$maxgesize
 || 
$lv
->
TyLk
->
TyInfos
['ispart']!=0 || $lv->TypeLink->TypeInfos['isdefault']==-1)

92 
$u
 = 
$lv
->
	`MakeHtml
();

93 
$fishTy
 = 
ue
;

97 
$u
 = 
$lv
->
	`MakeHtml
(
$mkge
,
$maxgesize
);

98 
$fishTy
 = 
l
;

99 
$mkge
 = $mkg+ 
$maxgesize
;

100 if
$mkge
 >(
$ٮge
+1
$fishTy
 = 
ue
;

103 
	}
}

105 
	g$xage
 = 
$go
+1;

107 if(
	g$xage
 >
$tٮge
 && 
$fishTy
)

110 if(
$gy
=='')

112 if(
emy
(
$u
){ $u = '../us/li.php?tid='.
$tid
; }

113 
ShowMsg
("完成所有栏目列表更新！<a href='$reurl'arget='_blank'>浏览栏目</a>","javascript:;");

114 
ex
();

116 if(
	g$gy
=='mkl' || 
$gy
=='mkallct')

118 
ShowMsg
("完成所有栏目列表更新，现在作最后数据优化！","makehtml_all.php?action=make&step=10");

119 
ex
();

124 if(
	g$fishTy
)

126 
	g$gou
 = "makehtml_list_action.php?gotype={$gotype}&uppage=$uppage&maxpagesize=$maxpagesize&typeid=$typeid&pageno=$nextpage";

127 
ShowMsg
("成功创建栏目：".
$tid
."，继续进行操作！",
$gou
,0,100);

128 
ex
();

132 
	g$gou
 = "makehtml_list_action.php?gotype={$gotype}&uppage=$uppage&mkpage=$mkpage&maxpagesize=$maxpagesize&typeid=$typeid&pageno=$pageno";

133 
ShowMsg
("栏目：".
$tid
."，继续进行操作...",
$gou
,0,100);

134 
ex
();

	@dede/makehtml_map.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/sitemap.class.php");

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 if(
	$emy
(
$do
))

7 
	`ShowMsg
("参数错误!","-1");

8 
	`ex
();

9 
	}
}

10 
	g$sm
 = 
w
 
SeM
();

11 
	g$mli
 = 
$sm
->
GSeM
(
$do
);

12 if(
	g$do
=="site")

14 
$mu
 = 
$cfg_cmh
."/data/sitemap.html";

15 
	g$tmpfe
 = 
$cfg_bad
.
$cfg_ms_d
."/plus/sitemap.htm";

19 
	g$mu
 = 
$cfg_cmh
."/data/rssmap.html";

20 
	g$tmpfe
 = 
$cfg_bad
.
$cfg_ms_d
."/plus/rssmap.htm";

22 
	g$d
 = 
w
 
DedeTagP
();

23 
	g$d
->
LdTem
(
$tmpfe
);

24 
	g$d
->
SaveTo
(
$cfg_bad
.
$mu
);

25 
	g$d
->
Cˬ
();

26 
	gecho
 "<a href='$murl'arget='_blank'>成功更新文件: $murl 浏览...</a>";

27 
ex
();

	@dede/makehtml_map_guide.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
ude
 
DedeInude
('templets/makehtml_map_guide.htm');

	@dede/makehtml_rss.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
ude
 
DedeInude
('templets/makehtml_rss.htm');

	@dede/makehtml_rss_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_MakeHtml');

4 
que_
(
DEDEINC
."/arc.rssview.class.php");

5 if(
	$emy
(
$tid
))

7 
$tid
 = 0;

8 
	}
}

9 if(
	$emy
(
$maxcd
))

11 
$maxcd
 = 50;

12 
	}
}

13 
	g$row
 = 
$dsql
->
GO
("Select id From `#@__arctype` where id>'$tid' And ispart<>2 order by idscimit 0,1;");

14 if(!
	$is_y
(
$row
))

16 
echo
 "完成所有文件更新！";

17 
	}
}

20 
	g$rv
 = 
w
 
RssVw
(
$row
['id'],
$maxcd
);

21 
	g$rssu
 = 
$rv
->
MakeRss
();

22 
	g$tid
 = 
$row
['id'];

23 
ShowMsg
("成功更新".
$rssu
."，继续进行操作！","makehtml_rss_action.php?tid=$tid&maxrecord=$maxrecord",0,100);

	@dede/makehtml_spec.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_MakeHtml');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

9 if(
	g$do
=="ok")

11 
que_
(
DEDEINC
."/arc.specview.class.php");

12 
	g$
 = 
w
 
ScVw
();

13 
	g$ru
 = 
$
->
MakeHtml
();

14 
	gecho
 "成功生成所有专题HTML列表！<a href='$rurl'arget='_blank'>预览</a>";

15 
ex
();

17 
ude
 
DedeInude
('templets/makehtml_spec.htm');

	@dede/media_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

10 if(
	g$do
=="upload")

12 
que_
(
DEDEINC
."/image.func.php");

13 
	g$r_image
 = 
Aay
("image/pjpeg","image/jpeg","image/gif","image/png","image/x-png","image/wbmp");

14 
	g$r_ash
 = 
Aay
("application/x-shockwave-flash");

15 
	g$okdd
 = 0;

16 
	g$uime
 = 
time
();

17 
	g$admid
 = 
$curLog
->
gUrID
();

18 
	g$i
=0;$i<=40;$i++)

20 if(
ist
(
$
{"upfe".
$i
}&& 
is_uded_fe
(${"upfile".$i}))

22 
	g$fesize
 = 
$
{"upfe".
$i
."_size"};

23 
	g$upfe_ty
 = 
$
{"upfe".
$i
."_type"};

24 
	g$upfe_me
 = 
$
{"upfe".
$i
."_name"};

25 
	g$dth
 = 
MyDe
("ymd",
$uime
);

26 if(
_y
(
$upfe_ty
,
$r_image
))

28 
	g$medty
=1;

29 
	g$vePh
 = 
$cfg_image_d
."/".
$dth
;

31 if(
_y
(
$upfe_ty
,
$r_l
)){

32 
	g$medty
=2;

33 
	g$vePh
 = 
$cfg_h_meds
."/".
$dth
;

35 if(
egi
('audio|med|video',
$upfe_ty
&&gi("\.".
$cfg_soty
."$",
$upfe_me
))

37 
	g$medty
=3;

38 
	g$vePh
 = 
$cfg_h_meds
."/".
$dth
;

40 if(
egi
("\.".
$cfg_soty
."$",
$upfe_me
))

42 
	g$medty
=4;

43 
	g$vePh
 = 
$cfg_so_d
."/".
$dth
;

49 
	g$fame
 = "{$admid}_".
MyDe
("His",
$uime
).
mt_nd
(100,999).
	g$i
;

50 
	g$fs
 = 
exode
(".",
$
{"upfe".
$i
."_name"});

51 
	g$fame
 = 
$fame
.".".
$fs
[
cou
($fs)-1];

52 
	g$fame
 = 
$vePh
."/".
$fame
;

53 if(!
is_d
(
$cfg_bad
.
$vePh
))

55 
MkdA
(
$cfg_bad
.
$vePh
,777);

56 
CloF
();

58 
	g$fufame
 = 
$cfg_bad
.
$fame
;

59 if(
	g$medty
==1)

61 @
move_uded_fe
(
$
{"upfe".
$i
},
$fufame
);

62 
	g$fo
 = '';

63 
	g$da
 = 
gImagesize
(
$fufame
,
$fo
);

64 
	g$width
 = 
$da
[0];

65 
	g$height
 = 
$da
[1];

66 if(
_y
(
$upfe_ty
,
$cfg_pho_tymes
)
WImg
(
$fufame
,'up');

69 @
move_uded_fe
(
$
{"upfe".
$i
},
$fufame
);

71 if(
	g$i
>1)

73 
	g$
 = 
$t
."_".
$i
;

77 
	g$
 = 
$t
;

79 
	g$quy
 = "INSERT INTO `#@__uploads`(title,url,mediatype,width,height,playtime,filesize,uptime,mid)

80 
VALUES
 ('$ntitle','$filename','$mediatype','$width','$height','$playtime','$filesize','$uptime','$adminid'); ";

81 
	g$okdd
++;

82 
	g$dsql
->
ExecuNeQuy
(
$quy
);

85 
ShowMsg
("成功上传 {$okdd} 个文件！","media_main.php");

86 
ex
();

88 
ude
 
DedeInude
('templets/media_add.htm');

	@dede/media_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

5 
CheckPurvw
('sys_Upload,sys_MyUpload');

6 if(
	$emy
(
$do
))

8 
$do
 = "";

9 
	}
}

10 
	g$backu
 = 
ist
(
$_COOKIE
['ENV_GOBACK_URL']) ? $_COOKIE['ENV_GOBACK_URL'] : "javascript:history.go(-1);";

15 if(
	g$do
=='del')

17 
CheckPurvw
('sys_DelUpload');

18 if(
emy
(
$ids
))

20 
	g$ids
="";

22 if(
	g$ids
=="")

24 
$myrow
 = 
$dsql
->
GO
("Se u From #@__udwhaid='".
$aid
."'");

25 
	g$uefe
 = 
$cfg_bad
.
$myrow
['url'];

26 
	g$rs
 = 0;

27 if(!
fe_exis
(
$uefe
)||
	g$myrow
['url']=="")

29 
$rs
 = 1;

33 
	g$rs
 = @
uƚk
(
$uefe
);

35 if(
	g$rs
==1)

37 
$msg
 = "成功删除一个附件！";

38 
	g$dsql
->
ExecuNeQuy
("DFrom #@__udwhaid='".
$aid
."'");

40 
ShowMsg
(
$msg
,
$backu
);

41 
ex
();

45 
	g$ids
 = 
exode
(',',
$ids
);

46 
	g$idquy
 = "";

47 
fܗch
(
$ids
 
as
 
$aid
)

49 if(
	g$idquy
=="")

51 
$idquy
 .= " whereid='$aid' ";

55 
	g$idquy
 .= " Orid='$aid' ";

58 
	g$dsql
->
SQuy
("Selectid,url From #@__uploads $idquery ");

59 
	g$dsql
->
Execu
();

60 
	g$myrow
=
$dsql
->
GAay
())

62 
$uefe
 = 
$cfg_bad
.
$myrow
['url'];

63 
	g$rs
 = 0;

64 if(!
fe_exis
(
$uefe
)||
	g$myrow
['url']=="")

66 
$rs
 = 1;

70 
	g$rs
 = @
uƚk
(
$uefe
);

72 if(
	g$rs
==1)

74 
$dsql
->
ExecuNeQuy
("DFrom #@__udwhaid='".
$myrow
['aid']."'");

77 
ShowMsg
('成功删除选定的文件！',
$backu
);

78 
ex
();

84 if(
	g$do
=='save')

86 if(
$aid
=="")

88 
ex
();

92 
	g$myrow
 = 
$dsql
->
GO
("Se * From #@__udwhaid='".
$aid
."'");

93 if(
	g$myrow
['mid']!=
$curLog
->
gUrID
())

95 
CheckPurvw
('sys_Upload');

99 
	g$addquy
 = "";

100 if(
is_uded_fe
(
$upfe
))

102 if(
	g$medty
==1)

104 
$r
 = 
Aay
("image/pjpeg","image/jpeg","image/gif","image/png","image/xpng","image/wbmp");

105 if(!
_y
(
$upfe_ty
,
$r
))

107 
ShowMsg
("你上传的不是图片类型的文件！","javascript:history.go(-1);");

108 
ex
();

111 if(
	g$medty
==2)

113 
$r
 = 
Aay
("application/x-shockwave-flash");

114 if(!
_y
(
$upfe_ty
,
$r
))

116 
ShowMsg
("你上传的不是Flash类型的文件！","javascript:history.go(-1);");

117 
ex
();

119 }if(
	g$medty
==3)

121 if(!
egi
('audio|med|video',
$upfe_ty
))

123 
ShowMsg
("你上传的为不正确类型的影音文件！","javascript:history.go(-1);");

124 
ex
();

126 if(!
egi
("\.".
$cfg_medty
,
$upfe_me
))

128 
ShowMsg
("你上传的影音文件扩展名无法被识别，请更改系统配置的参数！","javascript:history.go(-1);");

129 
ex
();

133 if(!
egi
("\.".
$cfg_soty
,
$upfe_me
))

135 
ShowMsg
("你上传的附件扩展名无法被识别，请更改系统配置的参数！","javascript:history.go(-1);");

136 
ex
();

141 
	g$nowtime
 = 
time
();

142 
	g$dfe
 = 
$myrow
['url'];

143 
	g$dfes
 = 
exode
('/',
$dfe
);

144 
	g$fufame
 = 
$cfg_bad
.
$dfe
;

145 
	g$dfe_th
 = 
eg_a
(
$dfes
[
cou
($dfes)-1]."$","",
$dfe
);

146 if(!
is_d
(
$cfg_bad
.
$dfe_th
))

148 
MkdA
(
$cfg_bad
.
$dfe_th
,777);

149 
CloF
();

151 @
move_uded_fe
(
$upfe
,
$fufame
);

152 if(
	g$medty
==1)

154 
que_
(
DEDEINC
."/image.func.php");

155 if(
_y
(
$upfe_ty
,
$cfg_pho_tymes
))

157 
WImg
(
$fufame
,'up');

160 
	g$fesize
 = 
$upfe_size
;

161 
	g$imgw
 = 0;

162 
	g$imgh
 = 0;

163 if(
	g$medty
==1)

165 
$fo
 = "";

166 
	g$sizes
[0] = 0; $sizes[1] = 0;

167 
	g$sizes
 = @
gimagesize
(
$fufame
,
$fo
);

168 
	g$imgw
 = 
$sizes
[0];

169 
	g$imgh
 = 
$sizes
[1];

171 if(
	g$imgw
>0)

173 
	g$addquy
 = ",width='$imgw',height='$imgh',filesize='$filesize' ";

177 
	g$addquy
 = ",filesize='$filesize' ";

182 
	g$feu
 = 
$fame
;

186 
	g$quy
 = " update #@__uploads setitle='$title',mediatype='$mediatype',playtime='$playtime'";

187 
	g$quy
 .= "$addquery whereid='$aid' ";

188 
	g$dsql
->
ExecuNeQuy
(
$quy
);

189 
ShowMsg
('成功更改一则附件数据！','med_ed.php?aid='.
$aid
);

190 
ex
();

194 
	g$myrow
 = 
$dsql
->
GO
("Se * From #@__udwhaid='".
$aid
."'");

195 if(!
	$is_y
(
$myrow
))

197 
	`ShowMsg
('错误，找不到此编号的档案！','javascript:;');

198 
	`ex
();

199 
	}
}

200 
ude
 
DedeInude
('templets/media_edit.htm');

	@dede/media_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
que_
(
DEDEINC
."/common.func.php");

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

7 if(
	$emy
(
$do
))

9 
$do
 = '';

10 
	}
}

13 if(
	g$do
=='filemanager')

15 if(
fe_exis
('./file_manage_main.php'))

17 
hd
("location:file_manage_main.php?activepath=$cfg_medias_dir");

21 
ShowMsg
("找不到文件管理器，可能已经卸载!","-1");

23 
ex
();

29 if(
	$emy
(
$keywd
))

31 
$keywd
 = "";

32 
	}
}

33 
	g$addsql
 = " where (u.titleike '%$keyword%' Or u.urlike '%$keyword%') ";

34 if(
	$emy
(
$membty
))

36 
$membty
 = 0;

37 
	}
}

38 if(
	g$membty
==1)

40 
$addsql
 .= " And u.mid>0 ";

42 if(
	g$membty
==2)

44 
$addsql
 .= " And u.mid>0 ";

47 if(
	$emy
(
$medty
))

49 
$medty
 = 0;

50 
	}
}

51 if(
	g$medty
>1)

53 
	g$addsql
 .= " And u.mediatype='$membertype' ";

55 
	g$sql
 = "Select u.aid,u.title,u.url,u.mediatype,u.filesize,u.mid,u.uptime

56 ,
	ga
.
urid
 
as
 
	gadmme
,
	gm
.urid
membme


57 
	gFrom
 #@
__uds
 
u


58 
Le
 
	gjo
 #@
__adm
 
a
 

 
	ga
.
	gid
 = 
u
.
mid


59 
Le
 
jo
 #@
__memb
 
m
 

 m.
mid
 = 
u
.mid

60 
$addsql
 
d
 
by
 
u
.
aid
 
desc
";

61 
$dli
 = 
w
 
DaLiCP
();

62 
	g$dli
->
	ggeSize
 = 20;

63 
	g$dli
->
SPam
("medty",
$medty
);

64 
	g$dli
->
SPam
("keywd",
$keywd
);

65 
	g$dli
->
SPam
("membty",
$membty
);

66 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/media_main.htm");

67 
	g$dli
->
SSour
(
$sql
);

68 
	g$dli
->
Diy
();

70 
funi
 
	$MedTy
(
$tid
,
$nu
)

72 if(
$tid
==1)

76 if(
$tid
==2)

80 if(
$tid
==3)

88 
	}
}

90 
funi
 
	$GFeSize
(
$fs
)

92 
$fs
 = $fs/1024;

93  
	`im
(
	`rtf
("%10.1f",
$fs
)." K");

94 
	}
}

96 
funi
 
	$UdAdm
(
$admid
,
$mid
)

98 if(
$admid
!='')

100  
$admid
;

104  
$mid
;

106 
	}
}

	@dede/member_do.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/oxwindow.class.php");

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

8 if(
	$emy
(
$fmdo
))

10 
$fmdo
 = '';

11 
	}
}

12 
	g$ENV_GOBACK_URL
 = 
ist
(
$_COOKIE
['ENV_GOBACK_URL']) ? 'member_main.php' : '';

18 if(
	g$do
=="delmember")

20 
CheckPurvw
('member_Del');

21 if(
	g$fmdo
=='yes')

23 
$id
 = 
eg_a
('[^0-9]','',$id);

24 
	g$codeok
 = 
subr
(
md5
(
$cfg_cook_code
.
$ndcode
),0,24);

25 if(
	g$codeok
!=
$code
)

27 
ShowMsg
("请填写正确的安全验证串！","member_do.php?id={$id}&dopost=delmember");

28 
ex
();

30 if(!
emy
(
$id
))

33 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__member` where mid='$id'imit 1 ");

34 
	g$rs
 = 0;

35 if(
	g$row
['matt'] == 10)

37 
$ow
 = 
$dsql
->
GO
("Select * From `#@__admin` where id='$id'imit 1 ");

39 if(!
is_y
(
$ow
)
	g$rs
 = 
$dsql
->
ExecuNeQuy2
("Delete From `#@__member` where mid='$id'imit 1");

43 
	g$rs
 = 
$dsql
->
ExecuNeQuy2
("Delete From `#@__member` where mid='$id'imit 1");

45 if(
	g$rs
 > 0)

47 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_tj` where mid='$id'imit 1");

48 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_space` where mid='$id'imit 1");

49 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_company` where mid='$id'imit 1");

50 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_person` where mid='$id'imit 1");

53 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_stow` where mid='$id' ");

54 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_flink` where mid='$id' ");

55 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_guestbook` where mid='$id' ");

56 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_operation` where mid='$id' ");

57 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_pms` whereoid='$id' Or fromid='$id' ");

58 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_friends` where mid='$id' Or fid='$id' ");

59 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_vhistory` where mid='$id' Or vid='$id' ");

60 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__feedback` where mid='$id' ");

61 
	g$dsql
->
ExecuNeQuy
("update `#@__archives` set mid='0' where mid='$id'");

63 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_/.php'
uc_ur_de
(
$row
['userid']);

64 #/
a
}}

68 
ShowMsg
("无法删除此会员，如果这个会员是<b>[管理员]</b>，<b/>必须先删除这个<b>[管理员]</b>才能删除此帐号！", 
$ENV_GOBACK_URL
, 0, 5000);

69 
ex
();

72 
ShowMsg
("成功删除一个会员！",
$ENV_GOBACK_URL
);

73 
ex
();

75 
	g$ndcode
 = 
mt_nd
(10000,99999);

76 
	g$code
 = 
subr
(
md5
(
$cfg_cook_code
.
$ndcode
),0,24);

77 
	g$wt
 = "会员管理-删除会员";

78 
	g$wecome_fo
 = "<hf='".
$ENV_GOBACK_URL
."'>会员管理</a>::删除会员";

79 
	g$w
 = 
w
 
OxWdow
();

80 
	g$w
->
In
("member_do.php","js/blank.js","POST");

81 
	g$w
->
AddHidd
("fmdo","yes");

82 
	g$w
->
AddHidd
("do",
$do
);

83 
	g$w
->
AddHidd
("id",
$id
);

84 
	g$w
->
AddHidd
("ndcode",
$ndcode
);

85 
	g$w
->
AddHidd
("code",
$code
);

86 
	g$w
->
AddT
("你确实要删除(ID:".
$id
.")这个会员?");

87 
	g$w
->
AddMsgIm
("安全验证串：<inputame='safecode'ype='text' id='safecode' size='16' style='width:200px' />&nbsp;(复制本代码： <font color='red'>$safecode</font> )","30");

88 
	g$wfm
 = 
$w
->
GWdow
("ok");

89 
	g$w
->
Diy
();

95 if(
	g$do
=="recommend")

97 
CheckPurvw
('member_Edit');

98 
	g$id
 = 
eg_a
("[^0-9]","",
$id
);

99 if(
	g$mt
==0)

101 
$dsql
->
ExecuNeQuy
("update `#@__member` set matt=1 where mid='$id' And matt<>10imit 1");

102 
ShowMsg
("成功设置一个会员推荐！",
$ENV_GOBACK_URL
);

103 
ex
();

107 
	g$dsql
->
ExecuNeQuy
("update `#@__member` set matt=0 where mid='$id' And matt<>10imit 1");

108 
ShowMsg
("成功取消一个会员推荐！",
$ENV_GOBACK_URL
);

109 
ex
();

116 if(
	g$do
=='edituser')

118 
CheckPurvw
('member_Edit');

119 if(!
ist
(
$_POST
['id'])
ex
('Request Error!');

120 
	g$pwdsql
 = 
emy
(
$pwd
? '' : ",pwd='".
md5
($pwd)."'";

121 if(
emy
(
$x
)
	g$x
 = '男';

123 if(
	g$mt
==10 && 
$dmt
!=10)

125 
ShowMsg
("对不起，为安全起见，不支持直接把前台会员转为管理的操作！", "-1");

126 
ex
();

128 
	g$quy
 = "update `#@__member` set

129 
ema
 = '$email',

130 
	gume
 = '$uname',

131 
	gx
 = '$sex',

132 
	gmt
 = '$matt',

133 
	gmey
 = '$money',

134 
	gsces
 = '$scores',

135 
	gnk
 = '$rank',

136 
	gaa
='$spacesta'

137 
$pwdsql


138 
whe
 
mid
='$id' 
And
 
mt
<>10 ";

139 
$rs
 = 
$dsql
->
ExecuNeQuy2
(
$quy
);

140 if(
	g$rs
==0)

142 
$quy
 = "update `#@__member` set

143 
ema
 = '$email',

144 
	gume
 = '$uname',

145 
	gx
 = '$sex',

146 
	gmey
 = '$money',

147 
	gsces
 = '$scores',

148 
	gnk
 = '$rank',

149 
	gaa
='$spacesta'

150 
$pwdsql


151 
whe
 
mid
='$id' ";

152 
$rs
 = 
$dsql
->
ExecuNeQuy2
(
$quy
);

156 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/api/uc.func.php')

158 
	g$row
 = 
$dsql
->
GO
("SELECT `scores`,`userid` FROM `#@__member` WHERE `mid`='$id' AND `matt`<>10");

159 
	g$amou
 = 
$sces
-
$row
['scores'];

160 
uc_ed_ne
(
$row
['urid'],
$amou
);

162 #/
a
}}

164 
ShowMsg
('成功更改会员资料！', 'memb_vw.php?id='.
$id
);

165 
ex
();

171 if(
	g$do
=="memberlogin")

173 
CheckPurvw
('member_Edit');

174 
PutCook
('DedeUrID',
$id
,1800);

175 
PutCook
('DedeLogTime',
time
(),1800);

176 if(
emy
(
$jumpu
)
hd
("location:../member/index.php");

177 
hd
("location:$jumpurl");

179 
if
(
$do
 == "upoperations")

181 
$nid
 = 
eg_a
('[^0-9,]','',ereg_replace('`',',',$nid));

182 
	g$nid
 = 
exode
(',',
$nid
);

183 if(
is_y
(
$nid
))

185 
fܗch
 (
$nid
 
as
 
$v
)

187 
	g$quy
 = "update `#@__member_operation` set sta = '1' whereid = '$var'";

188 
	g$dsql
->
ExecuNeQuy
(
$quy
);

189 
ShowMsg
("设置成功！","member_operations.php");

190 
ex
();

194 
if
(
$do
 == "okoperations")

196 
$nid
 = 
eg_a
('[^0-9,]','',ereg_replace('`',',',$nid));

197 
	g$nid
 = 
exode
(',',
$nid
);

198 if(
is_y
(
$nid
))

200 
fܗch
 (
$nid
 
as
 
$v
)

202 
	g$quy
 = "update `#@__member_operation` set sta = '2' whereid = '$var'";

203 
	g$dsql
->
ExecuNeQuy
(
$quy
);

204 
ShowMsg
("设置成功！","member_operations.php");

205 
ex
();

	@dede/member_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_List');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

7 if(!
ist
(
$x
)
	g$x
 = '';

8 if(!
ist
(
$mty
)
	g$mty
 = '';

9 if(!
ist
(
$aa
)
	g$aa
 = -10;

11 if(!
ist
(
$keywd
)
	g$keywd
 = '';

12 
	g$keywd
 = 
im
(
FrSrch
(
$keywd
));

14 
	g$mtyfm
 = 
emy
(
$mty
) ? "<option value=''>类型</option>\r\n" : "<option value='$mtype'>$mtype</option>\r\n";

15 
	g$xfm
 = 
emy
(
$x
) ? "<option value=''>性别</option>\r\n" : "<option value='$sex'>$sex</option>\r\n";

16 
	g$stkey
 = 
emy
(
$stkey
? 'mid' : 
egi_a
('[^a-z]','',$sortkey);

18 
	g$aA
 = 
y
(-2=>'限制用户(禁言)', -1=>'未通过审核', 0=>'审核通过，提示填写完整信息', 1=>'没填写详细资料', 2=>'正常使用状态' );

19 
	g$MembTys
 = 
y
();

20 
	g$dsql
->
SQuy
("Selectank,membername From `#@__arcrank` whereank>0 ");

21 
	g$dsql
->
Execu
();

22 
	g$row
 = 
$dsql
->
	$GObje
())

24 
$MembTys
[
$row
->
nk
] = $row->
membme
;

25 
	}
}

27 if(
	g$stkey
=='mid')

29 
$stfm
 = "<option value='mid'>mid/注册时间</option>\r\n";

31 if(
	g$stkey
=='rank')

33 
$stfm
 = "<option value='rank'>会员等级</option>\r\n";

35 if(
	g$stkey
=='money')

37 
$stfm
 = "<option value='money'>会员金币</option>\r\n";

39 if(
	g$stkey
=='scores')

41 
$stfm
 = "<option value='scores'>会员积分</option>\r\n";

45 
	g$stfm
 = "<option value='logintime'>登录时间</option>\r\n";

48 
	g$whes
[] = " (useridike '%$keyword%' Or unameike '%$keyword%' Ormailike '%$keyword%') ";

50 if(
	g$x
 != '')

52 
$whes
[] = " sexike '$sex' ";

55 if(
	g$mty
 != '')

57 
$whes
[] = " mtypeike '$mtype' ";

60 if(
	g$aa
 != -10)

62 
$whes
[] = " spacesta = '$spacesta' ";

65 
	g$wheSql
 = 
jo
(' And ',
$whes
);

66 if(
	g$wheSql
!='')

68 
$wheSql
 = ' where '.$whereSql;

70 
	g$sql
 = "select * From `#@__member` $whereSql order by $sortkey desc ";

71 
	g$dli
 = 
w
 
DaLiCP
();

72 
	g$dli
->
SPam
('x',
$x
);

73 
	g$dli
->
SPam
('aa',
$aa
);

74 
	g$dli
->
SPam
('mty',
$mty
);

75 
	g$dli
->
SPam
('stkey',
$stkey
);

76 
	g$dli
->
SPam
('keywd',
$keywd
);

77 
	g$dli
->
STem
(
DEDEADMIN
."/templets/member_main.htm");

78 
	g$dli
->
SSour
(
$sql
);

79 
	g$dli
->
diy
();

81 
funi
 
	$GMembName
(
$nk
,
$mt
)

83 
glob
 
$MembTys
;

84 if(
	`ist
(
$MembTys
[
$nk
]))

86 if(
$mt
=='ut' " <fڈc='d'>待升级：".
$MembTys
[
$nk
]."</font>";

87  
$MembTys
[
$nk
];

91 if(
$mt
=='ut')  '';

92  
$mt
;

94 
	}
}

96 
funi
 
	$GMA
(
$m
)

98 if(
$m
<1)  '';

99 if(
$m
==10)  "&nbsp;<font color='red'>[管理员]</font>";

101 
	}
}

	@dede/member_mtype.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Type');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

9 if(
	g$do
 == 'save')

11 
$me
 = 
ist
($me? 
im
($name) : '';

14 
	g$me
 = 
eg_a
("/['\"\.\/\*\\\?]/", '', 
$me
);

16 
	g$r
 = 'ENUM(\'个人\',\'企业\'';

17 if(
ist
(
$tys
&& 
is_y
($types))

19 
fܗch
 (
$tys
 
as
 
$ty
)

21 
	g$ty
 = 
eg_a
("/['\"\.\/\*\\\?]/", '', 
$ty
);

22 
	g$r
 .',\''.
$ty
.'\'';

25 
	g$r
 .= ')';

26 if(
	g$me
 != ''){

27 
$r
 = 
r_a
(')', ',\''.
$me
.'\')', $str);

29 
	g$sql
 = " ALTER TABLE `#@__member` CHANGE `mtype` `mtype` $str NOT NULL DEFAULT '个人' ";

31 if(
	g$dsql
->
ExecNeQuy
(
$sql
))

33 
ShowMsg
('会员种类成功', 'member_mtype.php');

34 
ex
();

37 
ShowMsg
('修改会员类别失败', '-1');

38 
	gex
;

43 
	g$sql
 = "desc #@__member";

44 
	g$dsql
->
SQuy
(
$sql
);

45 
	g$dsql
->
Execu
();

46 
	g$row
 = 
$dsql
->
GAay
()) {

47 if(
$row
['Field'] == 'mtype')

49 
$tys
 = 
$row
['Type'];

53 
	g$tys
 = 
r_a
(
y
('um', '(', ')', '\''), '', 
$tys
);

54 
	g$tys
 = 
exode
(',', 
$tys
);

55 
ude
(
DEDEADMIN
.'/templets/member_mtype.htm');

	@dede/member_operations.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Operations');

4 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

5 
que_
(
DEDEINC
.'/datalistcp.class.php');

6 if(
	$emy
(
$buyid
))

8 
$buyid
 = '';

9 
	}
}

10 
	g$addsql
 = " where buyidike '%$buyid%' ";

11 if(
	$ist
(
$a
))

13 
$addsql
 .= " And sta='$sta' ";

14 
	}
}

15 
	g$sql
 = "Select * From `#@__member_operation` $addsql order byid desc";

16 
	g$dli
 = 
w
 
DaLiCP
();

19 
	g$dli
->
	ggeSize
 = 25;

20 
	g$dli
->
SPam
("buyid",
$buyid
);

21 if(
	$ist
(
$a
))

23 
$dli
->
	`SPam
("a",
$a
);

24 
	}
}

25 
	g$dli
->
	gdsql
->
SQuy
("Select * From #@__moneycard_type ");

26 
	g$dli
->
	gdsql
->
Execu
('ts');

27 
	g$rw
 = 
$dli
->
dsql
->
GAay
('ts'))

29 
$TyNames
[
$rw
['tid']] = $rw['pname'];

31 
	g$lfe
 = 
DEDEADMIN
."/templets/member_operations.htm";

34 
	g$dli
->
STeme
(
$lfe
);

35 
	g$dli
->
SSour
(
$sql
);

36 
	g$dli
->
Diy
();

38 
funi
 
	$GMembID
(
$mid
)

40 
glob
 
$dsql
;

41 if(
$mid
==0)

45 
$row
 = 
$dsql
->
	`GO
("Select userid From #@__member where mid='$mid' ");

46 if(
	`is_y
(
$row
))

48  "<hf='memb_vw.php?mid={$mid}'>".
$row
['userid']."</a>";

54 
	}
}

56 
funi
 
	$GPTy
(
$ame
)

58 if(
$ame
=='card')  '点数卡';

59 if(
$ame
=='archive')  '购买文章';

60 if(
$ame
=='stc')  '兑换金币';

62 
	}
}

64 
funi
 
	$GS
(
$a
)

66 if(
$a
==0)

70 if(
$a
==1)

78 
	}
}

	@dede/member_pm.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Pm');

4 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

5 
que_
(
DEDEINC
 .'/datalistcp.class.php');

6 if(!
	$ist
(
$fd
))

8 
$fd
 = '';

9 
	}
}

10 if(!
	$ist
(
$uame
))

12 
$uame
 = '';

13 
	}
}

14 if(!
	$ist
(
$keywd
))

16 
$keywd
 = '';

17 
	}
}

18 if(
	$ist
(
$do
))

20 
$ID
 = 
	`eg_a
("[^0-9]","",$ID);

21 if(
$do
=="d"&&!
	`emy
(
$ID
))

23 
$dsql
->
	`ExecuNeQuy
("DELETE FROM #@__member_pms WHERE id='$ID'");

25 
	}
}

26 
	g$wheSql
 = '';

27 if(!
	$emy
(
$fd
))

29 
$wheSql
 = "WHERE folder='$folder'";

30 
	}
}

31 
	g$pour
 = "收件人";

32 if(
	g$fd
=="box"||
$fd
=='')

34 
$pour
 = "发件人";

36 if(!
	$emy
(
$keywd
))

38 
$wheSql
 ." AND (subjeik'%".
$keywd
."%' OR messageike '%".$keyword."%')";

39 
	}
}

40 if(!
	$emy
(
$uame
))

42 
$wheSql
 ." AND flogidik'%".
$uame
."%'";

43 
	}
}

44 
	g$sql
 = "SELECT * FROM #@__member_pms $whereSql ORDER BY sendtime desc";

45 
	g$dli
 = 
w
 
DaLiCP
();

46 
	g$dli
->
	ggesize
 = 25;

47 
	g$dli
->
SPam
("fd",
$fd
);

48 
	g$dli
->
SPam
("uame",
$uame
);

49 
	g$dli
->
SPam
("keywd",
$keywd
);

50 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/member_pm.htm");

51 
	g$dli
->
SSour
(
$sql
);

52 
	g$dli
->
Diy
();

53 
	g$dli
->
Clo
();

55 
funi
 
	$GFds
(
$me
)

57 if(
$me
=="outbox")

61 if(
$me
=="inbox")

65 
	}
}

67 
funi
 
	$IsRd
(
$me
)

69 
$me
 = 
	`eg_a
("[^0-1]","",$me);

70 if(
$me
)

78 
	}
}

	@dede/member_pmall.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Pm');

4 if(!
	$ist
(
$ai
))

6 
$ai
 = '';

7 
	}
}

8 if(
	g$ai
=="post")

10 
$ogid
 = 'admin';

11 
	g$omid
 = 0;

12 
	g$toid
 = 0;

13 
	g$togid
 = 0;

14 
	g$ndtime
 = 
time
();

15 
	g$wrime
 = 
time
();

16 
	g$subje
 = 
_subrR
(
HtmlR
(
$subje
),70);

17 
	g$mesge
 = 
_subrR
(
HtmlR
(
$mesge
),1000);

18 if(!
ist
(
$subje
)||
emy
($subject))

20 
ShowMsg
('短信标题不能为空!','-1');

21 
ex
();

22 }if(!
ist
(
$mesge
)||
emy
($message))

24 
ShowMsg
('请填写短信内容!','-1');

25 
ex
();

29 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

31 
uc_pm_nd
(0,'',
$subje
,
$mesge
);

32 
ShowMsg
('短信已成功发送','-1'); 
	gex
;

34 #/
a
}}

36 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("INSERT INTO #@__member_pms(floginid,fromid,toid,tologinid,folder,hasview,subject,sendtime,writetime,message,isadmin) VALUES('$floginid','$fromid','$toid','$tologinid','outbox','0','$subject','$sendtime','$writetime','$message','1');");

37 
ShowMsg
('短信已成功发送','-1');

38 
ex
();

40 
que_
(
DEDEADMIN
."/templets/member_pmall.htm");

	@dede/member_rank.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Type');

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

10 if(
	g$do
=='save')

12 
$tID
 = 1;

13 
	g$dID
 = 
$idd
;

14 ;
	g$tID
 <
$dID
;$startID++)

17 
	g$quy
 = '';

18 
	g$id
 = 
$
{"ID_".
$tID
};

19 
	g$me
 = 
$
{"me_".
$tID
};

20 
	g$nk
 = 
$
{"nk_".
$tID
};

21 
	g$mey
 = 
$
{"mey_".
$tID
};

22 
	g$sces
 = 
$
{"sces_".
$tID
};

23 if(
ist
(
$
{"check_".
$tID
}))

25 if(
	g$nk
>0)

27 
	g$quy
 = "update `#@__arcrank` set membername='$name',money='$money',rank='$rank',scores='$scores' where id='$id' ";

32 
	g$quy
 = "Delete From `#@__arcrank` where id='$id' Andank<>10";

34 if(
	g$quy
!='')

36 
$dsql
->
ExecuNeQuy
(
$quy
);

39 if(
ist
(
$check_w
))

41 if(
	g$nk_w
 > 0 && 
	g$me_w
 !'' && 
$nk_w
 > 10)

43 
$quy
 = "Insert Into `#@__arcrank`(`rank`,`membername`,`adminrank`,`money`,`scores`,`purviews`) Values('$rank_new','$name_new','5','$money_new','$scores',''); ";

44 
	g$dsql
->
ExecuNeQuy
(
$quy
);

47 
	gecho
 "<script>lert('成功更新会员等级表！'); </script>";

49 if(
	g$do
 == 'del')

51 
$dsql
->
ExecuNeQuy
("Delete From `#@__arcrank` where id='$id' Andank<>10");

52 
ShowMsg
("删除成功！","member_rank.php");

53 
ex
();

56 
	g$dsql
->
SQuy
("Select * From `#@__arcrank` whereank>0 order byank");

57 
	g$dsql
->
Execu
();

58 
ude
 
DedeInude
('templets/member_rank.htm');

	@dede/member_scores.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Scores');

4 if(!
	$ist
(
$ai
))

6 
$ai
 = '';

7 
	}
}

8 if(
	g$ai
=='save')

10 if(!
emy
(
$add_gl
)&&!emy(
$add_ic
)&&!emy(
$add_ts
))

12 
$gl
 = 
eg_a
("[^0-9]","",
$add_gl
);

13 
	g$add_ic
 = 
eg_a
("[^0-9]","",
$add_ic
);

14 
	g$add_ts
 = 
_subr
(
$add_ts
,15);

15 
	g$dsql
->
ExecuNeQuy
("INSERT INTO `#@__scores`(integral,icon,titles,isdefault) VALUES('$integral','$add_icon','$add_titles','$add_isdefault')");

17 
fܗch
(
$_POST
 
as
 
$rk
=>
$rv
)

19 if(
eg
('-',
$rk
))

21 
$ID
 = 
eg_a
("[^0-9]","",
$rk
);

22 
	g$fdes
 = 
eg_a
("[^a-z]","",
$rk
);

23 
	g$k
 = 
$$rk
;

24 if(
emy
(
$k
))

26 
	g$k
 = 0;

28 
	g$sql
 = 
$fdes
."='".
$k
."'";

29 
	g$dsql
->
ExecuNeQuy
("UPDATE `#@__sces` SET ".
$sql
." WHERE id='{$ID}'");

30 if(
eg
('Ids-',
$rk
))

32 if(
	g$k

	g$dsql
->
ExecuNeQuy
("DELETE FROM `#@__scores` WHERE id='$ID'");

37 
	g$Sces
 = 
y
();

38 
	g$dsql
->
SQuy
("SELECT * FROM `#@__scores` ORDER BY id ASC");

39 
	g$dsql
->
Execu
();

40 
	g$rs
 = 
$dsql
->
	$GAay
())

42 
	`y_push
(
$Sces
,
$rs
);

43 
	}
}

44 
ude
 
DedeInude
('templets/member_scores.htm');

	@dede/member_type.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Type');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

10 if(
	g$do
=="save")

12 
$tID
 = 1;

13 
	g$dID
 = 
$idd
;

14 ;
	g$tID
<=
$dID
;$startID++)

16 
	g$quy
 = '';

17 
	g$aid
 = 
$
{'ID_'.
$tID
};

18 
	g$ame
 = 
$
{'ame_'.
$tID
};

19 
	g$nk
 = 
$
{'nk_'.
$tID
};

20 
	g$mey
 = 
$
{'mey_'.
$tID
};

21 
	g$exime
 = 
$
{'exime_'.
$tID
};

22 if(
ist
(
$
{'check_'.
$tID
}))

24 if(
	g$ame
!='')

26 
$quy
 = "update #@__member_type setname='$pname',money='$money',rank='$rank',exptime='$exptime' whereid='$aid'";

31 
	g$quy
 = "Delete From #@__member_type whereid='$aid' ";

33 if(
	g$quy
!='')

35 
$dsql
->
ExecuNeQuy
(
$quy
);

40 if(
ist
(
$check_w
&& 
	g$ame_w
!='')

42 
$quy
 = "Insert Into #@__member_type(rank,pname,money,exptime) Values('{$rank_new}','{$pname_new}','{$money_new}','{$exptime_new}');";

43 
	g$dsql
->
ExecuNeQuy
(
$quy
);

45 
hd
("Content-Type:ext/html; charset={$cfg_soft_lang}");

46 
	gecho
 "<script>lert('成功更新会员产品分类表！'); </script>";

48 
	g$ks
 = 
y
();

49 
	g$dsql
->
SQuy
("Select * From #@__arcrank whereank>10 ");

50 
	g$dsql
->
Execu
();

51 
	g$row
=
$dsql
->
	$GAay
())

53 
$ks
[
$row
['rank']] = $row['membername'];

54 
	}
}

56 
	g$times
 = 
y
();

57 
	g$times
[7] = '一周';

58 
	g$times
[30] = '一个月';

59 
	g$times
[90] = '三个月';

60 
	g$times
[183] = '半年';

61 
	g$times
[366] = '一年';

62 
	g$times
[32767] = '终身';

64 
que_
(
DEDEADMIN
."/templets/member_type.htm");

	@dede/member_view.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('member_Edit');

4 
	g$ENV_GOBACK_URL
 = 
ist
(
$_COOKIE
['ENV_GOBACK_URL']) ? "member_main.php" : '';

5 
	g$id
 = 
eg_a
("[^0-9]","",
$id
);

6 
	g$row
 = 
$dsql
->
GO
("select * from #@__member where mid='$id'");

8 
	g$aA
 = 
y
(

18 if(
	g$row
['matt']==10)

20 
CheckPurvw
('sys_User');

22 
ude
 
DedeInude
('templets/member_view.htm');

	@dede/module_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_module');

4 
que_
(
dme
(
__FILE__
)."/../include/dedemodule.class.php");

5 
que_
(
dme
(
__FILE__
)."/../include/oxwindow.class.php");

6 if(
emy
(
$ai
)
	g$ai
 = '';

7 
	g$md
 = 
DEDEROOT
.'/data/module';

9 
funi
 
	$TeWreAb
(
$d
)

11 
$tfe
 = '_dedet.txt';

12 
$d
 = 
	`eg_a
('/$','',$d);

13 
$
 = @
	`fݒ
(
$d
.'/'.
$tfe
,'w');

14 if(!
$
 
l
;

17 
	`fo
(
$
);

18 
$rs
 = @
	`uƚk
(
$d
.'/'.
$tfe
);

19 if(
$rs
 
ue
;

20  
l
;

22 
	}
}

24 
funi
 
	$ReWreCfigAuto
()

26 
glob
 
$dsql
;

27 
$cfigfe
 = 
DEDEROOT
.'/data/config.cache.inc.php';

28 if(!
	`is_wrb
(
$cfigfe
))

30 
echo
 "配置文件'{$configfile}'不支持写入，无法修改系统配置参数！";

32 
	`ex
();

34 
$
 = 
	`fݒ
(
$cfigfe
,'w');

35 
	`ock
(
$
,3);

36 
	`fwre
(
$
,"<"."?php\r\n");

37 
$dsql
->
	`SQuy
("Select `varname`,`type`,`value`,`groupid` From `#@__sysconfig` order byidsc ");

38 
$dsql
->
	`Execu
();

39 
$row
 = 
$dsql
->
	`GAay
())

41 if(
$row
['ty']=='numb'
	`fwre
(
$
,"\${$row['varname']} = ".$row['value'].";\r\n");

42 
	`fwre
(
$
,"\${$row['vme']} = '".
	`r_a
("'",'',
$row
['value'])."';\r\n");

44 
	`fwre
(
$
,"?".">");

45 
	`fo
(
$
);

46 
	}
}

51 if(
	g$ai
=='')

53 
$tys
 = 
y
('soft'=>'模块','templets'=>'模板','plus'=>'小插件','patch'=>'补丁');

54 
	g$dm
 = 
w
 
DedeModu
(
$md
);

55 if(
emy
(
$moduty
)
	g$moduty
 = '';

56 
	g$modus
 = 
$dm
->
GModuLi
(
$moduty
);

57 
que_
(
dme
(
__FILE__
)."/templets/module_main.htm");

58 
	g$dm
->
Cˬ
();

59 
ex
();

64 if(
	g$ai
=='setup')

66 
$dm
 = 
w
 
DedeModu
(
$md
);

67 
	g$fos
 = 
$dm
->
GModuInfo
(
$hash
);

69 if(
	g$fos
['u']==''
$fos
['url'] = '&nbsp;';

70 
	g$tMsg
 = (
$fos
['ng']==
$cfg_so_ng
 ? '' : '<br /><font color="red">(这个模块的语言编码与你系统的编码不一致，请向开发者确认它的兼容性)</font>');

72 
	g$fis
 = 
$dm
->
GFeLis
(
$hash
);

73 
	g$fi
 = '';

74 
	g$vds
 = 
y
();

75 
	g$cd
 = 
y
();

76 
fܗch
(
$fis
 
as
 
$v
)

78 if(
emy
(
$v
['name'])) ;

79 if(
	g$v
['type']=='dir')

81 
$v
['type'] = '目录';

82 
	g$cd
[] = 
$v
['name'];

86 
	g$v
['type'] = '文件';

88 
	g$fi
 .= "{$v['type']}|{$v['name']}\r\n";

91 
fܗch
(
$fis
 
as
 
$v
)

93 
	g$vd
 = 
eg_a
('/([^/]*)$','/',
$v
['name']);

94 if(!
eg
('^\.',
$vd
)
	g$vd
 = './';

95 
	g$n
 = 
ue
;

96 
fܗch
(
$cd
 
as
 
$k
=>
$v
)

98 if(
egi
("^".
$v
,
$vd
))

100 
$n
 = 
l
;

104 if(!
ist
(
$vds
[
$vd
]&& 
	g$n
 && 
is_d
($prvdir))

106 
	g$vds
[
$vd
][0] = 1;

107 
	g$vds
[
$vd
][1] = 
TeWreAb
($prvdir);

110 
	g$vd
 = "<table width='350'>\r\n";

111 
	g$vd
 .= "<tr style='background:#D1F5B6'><th width='270'>目录</td><thlign='center'>可写</td></tr>\r\n";

112 
fܗch
(
$vds
 
as
 
$k
=>
$v
)

114 if(
$v

$cw
 = '√';

115 
	g$cw
 = '<font color="red">×</font>';

116 
	g$vd
 .= "<tr><td style='border-bottom:1px solid #D1F5B6'>$k</td>";

117 
	g$vd
 .= "<tdlign='center' style='border-bottom:1px solid #D1F5B6'>$cw</td></tr>\r\n";

119 
	g$vd
 .= "</table>";

121 
	g$w
 = 
w
 
OxWdow
();

122 
	g$w
->
In
("module_main.php","js/blank.js","post");

123 
	g$w
->
	gmaT
 = "模块管理";

124 
	g$w
->
AddT
("<a href='module_main.php'>模块管理</a> &gt;&gt; 安装模块： {$infos['name']}");

125 
	g$w
->
AddHidd
("hash",
$hash
);

126 
	g$w
->
AddHidd
("action",'setupstart');

127 if(
im
(
$fos
['url'])=='') $infos['url'] = '无';

128 
	g$msg
 = "<style>.dtb{border-bottom:1px dotted #cccccc}</style>

129 <
b
 
width
='98%' 
bd
='0' 
Υacg
='0' 
ηddg
='0'>

130 <

>

131 <
td
 
width
='20%' 
height
='28' 
ass
='dtb'>模块名称：</td>

132 <
td
 
width
='80%' 
ass
='dtb'>{
$fos
['name']}</td>

133 </

>

134 <

>

135 <
td
 
height
='28' 
ass
='dtb'>语言：</td>

136 <
td
 
ass
='dtb'>{
$fos
['ng']} {
$tMsg
}</td>

137 </

>

138 <

>

139 <
td
 
height
='28' 
ass
='dtb'>文件大小：</td>

140 <
td
 
ass
='dtb'>{
$fos
['filesize']}</td>

141 </

>

142 <

>

143 <
td
 
height
='28' 
ass
='dtb'>团队名称：</td>

144 <
td
 
ass
='dtb'>{
$fos
['team']}</td>

145 </

>

146 <

>

147 <
td
 
height
='28' 
ass
='dtb'>发布时间：</td>

148 <
td
 
ass
='dtb'>{
$fos
['time']}</td>

149 </

>

150 <

>

151 <
td
 
height
='28' 
ass
='dtb'>电子邮箱：</td>

152 <
td
 
ass
='dtb'>{
$fos
['email']}</td>

153 </

>

154 <

>

155 <
td
 
height
='28' 
ass
='dtb'>官方网址：</td>

156 <
td
 
ass
='dtb'>{
$fos
['url']}</td>

157 </

>

158 <

>

159 <
td
 
height
='28' 
ass
='dtb'>使用协议：</td>

160 <
td
 
ass
='dtb'><
a
 
hf
='modu_ma.php?ai=showadme&hash={$hash}' 
rg
='_blank'>点击浏览...</a></td>

161 </

>

162 <

>

163 <
td
 
height
='30' 
ass
='dtb' 
bgc
='#FCFE9C' 
cޥ
='2'>

164 <
b
>注意事项：</b>

165 安装时请确保文件列表中涉及的目录前可写入权限，此外“后台管理目录”、“后台管理目录/
ms
”目录也必须暂时设置可写入权限。

166 </
td
>

167 </

>

168 <

>

169 <
td
 
height
='30'><
b
>目录权限检测：</b><
br
 /> ../ 为根目录 <br /> ./ 表示当前目录</td>

170 <
td
>

171 
$vd


172 </
td
>

173 </

>

174 <

>

175 <
td
 
height
='30'>模块包含的所有文件列表：</td>

176 <
td
></td>

177 </

>

178 <

>

179 <
td
 
height
='164' 
cޥ
='2'>

180 <
xa
 
me
='fis' 
id
='fis' 
y
='width:90%;height:200px'>{
$fi
}</textarea>

181 </
td
>

182 </

>

183 <

>

184 <
td
 
height
='28'>对于已存在文件处理方法：</td>

185 <
td
>

186 <
put
 
me
='i' 
ty
='dio' 
vue
='1' 
checked
='checked' />

188 <
put
 
me
='i' 
ty
='dio' 
vue
='3' />

190 <
put
 
ty
='dio' 
me
='i' 
vue
='0' />

192 </
td
>

193 </

>

194 </
b
>

196 
$w
->
AddMsgIm
("<div style='padding-left:10px;line-height:150%'>$msg</div>");

197 
	g$wfm
 = 
$w
->
GWdow
("ok","");

198 
	g$w
->
Diy
();

199 
	g$dm
->
Cˬ
();

200 
ex
();

205 if(
	g$ai
=='setupstart')

207 if(!
is_wrb
(
$md
))

209 
ShowMsg
("目录 {$mdir} 不支持写入，这将导致安装程序没法正常创建！","-1");

210 
ex
();

212 
	g$dm
 = 
w
 
DedeModu
(
$md
);

214 
	g$mfos
 = 
$dm
->
GModuInfo
(
$hash
);

215 
exa
(
$mfos
, 
EXTR_SKIP
);

217 
	g$murg
 = 
addashes
(
$dm
->
GSyemFe
(
$hash
,'menustring'));

219 
	g$quy
 = "INSERT INTO `#@__sys_module`(`hashcode` , `modname` , `indexname` , `indexurl` , `ismember` , `menustring` )

220 
VALUES
 ('$hash' , '$name' , '$indexname' , '$indexurl' , '$ismember' , '$menustring' ) ";

222 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("Delete From `#@__sys_module` where hashcodeike '$hash' ");

223 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

224 if(!
	g$rs
)

226 
ShowMsg
('保存数据库信息失败，无法完成安装！'.
$dsql
->
GE
(),'javascript:;');

227 
ex
();

230 
	g$dm
->
WreFes
(
$hash
,
$i
);

231 
	g$fame
 = '';

232 if(!
ist
(
$autotup
|| 
	g$autotup
==0
$fame
 = 
$dm
->
WreSyemFe
(
$hash
,'setup');

233 if(!
ist
(
$autod
|| 
	g$autod
==0
$dm
->
WreSyemFe
(
$hash
,'uninstall');

234 
	g$dm
->
WreSyemFe
(
$hash
,'readme');

235 
	g$dm
->
Cˬ
();

238 if(!
ist
(
$autotup
|| 
	g$autotup
==0)

240 
ude
(
DEDEROOT
.'/da/modu/'.
$fame
);

241 
ex
();

246 
	g$mysql_vsi
 = 
$dsql
->
GVsi
(
ue
);

248 
	g$tupsql
 = 
$dm
->
GSyemFe
(
$hash
,'setupsql40');

250 
	g$tupsql
 = 
egi_a
('ENGINE=MyISAM','TYPE=MyISAM',
$tupsql
);

252 
	g$sql41tmp
 = 'ENGINE=MyISAM DEFAULT CHARSET='.
$cfg_db_nguage
;

254 if(
	g$mysql_vsi
 >= 4.1)

256 
$tupsql
 = 
egi_a
('TYPE=MyISAM',
$sql41tmp
,$setupsql);

261 if(
	g$cfg_cmh
=='/') {

262 
$cfg_cmh
 = '';

264 
	g$rou
 = 
$cfg_baho
.
$cfg_cmh
;

266 
	g$tupsql
 = 
egi_a
('_ROOTURL_',
$rou
,
$tupsql
);

267 
	g$tupsql
 = 
eg_a
("[\r\n]{1,}","\n",
$tupsql
);

269 
	g$sqls
 = 
l
(";[ \t]{0,}\n", 
$tupsql
);

270 
fܗch
(
$sqls
 
as
 
$sql
)

272 if(
im
(
$sql
)!=''
$dsql
->
execunequy
($sql);

275 
ReWreCfigAuto
();

277 
	g$rw
 = "<scriptanguage='javascript'ype='text/javascript'>\r\n";

278 
	g$rw
 .= "if(window.navigator.userAgent.indexOf('MSIE')>=1)op.document.frames.menu.location = 'index_menu_module.php';\r\n";

279 
	g$rw
 .= "elseop.document.getElementById('menu').src = 'index_menu_module.php';\r\n";

280 
	g$rw
 .= "</script>";

281 
echo
 
	g$rw
;

283 
UpDeCCache
();

284 
ShowMsg
('模块安装完成...','module_main.php');

285 
ex
();

291 if(
	g$ai
=='del')

293 
$dm
 = 
w
 
DedeModu
(
$md
);

294 
	g$fos
 = 
$dm
->
GModuInfo
(
$hash
);

296 if(
	g$fos
['u']==''
$fos
['url'] = '&nbsp;';

297 
	g$tMsg
 = (
$fos
['ng']==
$cfg_so_ng
 ? '' : '<br /><font color="red">(这个模块的语言编码与你系统的编码不一致，请向开发者确认它的兼容性)</font>');

299 
	g$w
 = 
w
 
OxWdow
();

300 
	g$w
->
In
("module_main.php","js/blank.js","post");

301 
	g$w
->
	gmaT
 = "模块管理";

302 
	g$w
->
AddT
("<a href='module_main.php'>模块管理</a> &gt;&gt; 删除模块： {$infos['name']}");

303 
	g$w
->
AddHidd
('hash',
$hash
);

304 
	g$w
->
AddHidd
('action','delok');

305 
	g$msg
 = "<style>.dtb{border-bottom:1px dotted #cccccc}</style>

306 <
b
 
width
='750' 
bd
='0' 
Υacg
='0' 
ηddg
='0'>

307 <

>

308 <
td
 
width
='200' 
height
='28' 
ass
='dtb'>模块名称：</td>

309 <
td
 
width
='550' 
ass
='dtb'>{
$fos
['name']}</td>

310 </

>

311 <

>

312 <
td
 
height
='28' 
ass
='dtb'>语言：</td>

313 <
td
 
ass
='dtb'>{
$fos
['ng']} {
$tMsg
}</td>

314 </

>

315 <

>

316 <
td
 
width
='200' 
height
='28' 
ass
='dtb'>文件大小：</td>

317 <
td
 
width
='550' 
ass
='dtb'>{
$fos
['filesize']}</td>

318 </

>

319 <

>

320 <
td
 
height
='28' 
ass
='dtb'>团队名称：</td>

321 <
td
 
ass
='dtb'>{
$fos
['team']}</td>

322 </

>

323 <

>

324 <
td
 
height
='28' 
ass
='dtb'>发布时间：</td>

325 <
td
 
ass
='dtb'>{
$fos
['time']}</td>

326 </

>

327 <

>

328 <
td
 
height
='28' 
ass
='dtb'>电子邮箱：</td>

329 <
td
 
ass
='dtb'>{
$fos
['email']}</td>

330 </

>

331 <

>

332 <
td
 
height
='28' 
ass
='dtb'>官方网址：</td>

333 <
td
 
ass
='dtb'>{
$fos
['url']}</td>

334 </

>

335 <

>

336 <
td
 
height
='28' 
ass
='dtb'>使用协议：</td>

337 <
td
 
ass
='dtb'><
a
 
hf
='modu_ma.php?ai=showadme&hash={$hash}' 
rg
='_blank'>点击浏览...</a></td>

338 </

>

339 <

>

340 <
td
 
height
='28' 
cޥ
='2'>

341 删除模块仅删除这个模块的安装包文件，如果你已经安装，请执行<
a
 
hf
='modu_ma.php?hash={$hash}&ai=unl'><
u
>卸载程序</u></a>来删除！

342 </
td
>

343 </

>

344 </
b
>

346 
$w
->
AddMsgIm
("<div style='padding-left:10px;line-height:150%'>$msg</div>");

347 
	g$wfm
 = 
$w
->
GWdow
("ok","");

348 
	g$w
->
Diy
();

349 
	g$dm
->
Cˬ
();

350 
ex
();

352 if(
	g$ai
=='delok')

354 
$dm
 = 
w
 
DedeModu
(
$md
);

355 
	g$modfe
 = 
$md
."/".
$dm
->
GHashFe
(
$hash
);

356 
uƚk
(
$modfe


 
d
("删除文件 {$modfile} 失败！");

357 
ShowMsg
("成功删除一个模块文件！","module_main.php");

358 
ex
();

363 if(
	g$ai
=='uninstall')

365 
$dm
 = 
w
 
DedeModu
(
$md
);

366 
	g$fos
 = 
$dm
->
GModuInfo
(
$hash
);

368 if(
	g$fos
['u']==''
$fos
['url'] = '&nbsp;';

369 
	g$tMsg
 = (
$fos
['ng']==
$cfg_so_ng
 ? '' : '<br /><font color="red">(这个模块的语言编码与你系统的编码不一致，请向开发者确认它的兼容性)</font>');

371 
	g$fis
 = 
$dm
->
GFeLis
(
$hash
);

372 
	g$fi
 = '';

373 
fܗch
(
$fis
 
as
 
$v
)

375 if(
emy
(
$v
['name'])) ;

376 if(
	g$v
['ty']=='d'
$v
['type'] = '目录';

377 
	g$v
['type'] = '文件';

378 
	g$fi
 .= "{$v['type']}|{$v['name']}\r\n";

380 
	g$w
 = 
w
 
OxWdow
();

381 
	g$w
->
In
("module_main.php","js/blank.js","post");

382 
	g$w
->
	gmaT
 = "模块管理";

383 
	g$w
->
AddT
("<a href='module_main.php'>模块管理</a> &gt;&gt; 卸载模块： {$infos['name']}");

384 
	g$w
->
AddHidd
("hash",
$hash
);

385 
	g$w
->
AddHidd
("action",'uninstallok');

386 
	g$msg
 = "<style>.dtb{border-bottom:1px dotted #cccccc}</style>

387 <
b
 
width
='750' 
bd
='0' 
Υacg
='0' 
ηddg
='0'>

388 <

>

389 <
td
 
width
='200' 
height
='28' 
ass
='dtb'>模块名称：</td>

390 <
td
 
width
='550' 
ass
='dtb'>{
$fos
['name']}</td>

391 </

>

392 <

>

393 <
td
 
height
='28' 
ass
='dtb'>语言：</td>

394 <
td
 
ass
='dtb'>{
$fos
['ng']} {
$tMsg
}</td>

395 </

>

396 <

>

397 <
td
 
width
='200' 
height
='28' 
ass
='dtb'>文件大小：</td>

398 <
td
 
width
='550' 
ass
='dtb'>{
$fos
['filesize']}</td>

399 </

>

400 <

>

401 <
td
 
height
='28' 
ass
='dtb'>团队名称：</td>

402 <
td
 
ass
='dtb'>{
$fos
['team']}</td>

403 </

>

404 <

>

405 <
td
 
height
='28' 
ass
='dtb'>发布时间：</td>

406 <
td
 
ass
='dtb'>{
$fos
['time']}</td>

407 </

>

408 <

>

409 <
td
 
height
='28' 
ass
='dtb'>电子邮箱：</td>

410 <
td
 
ass
='dtb'>{
$fos
['email']}</td>

411 </

>

412 <

>

413 <
td
 
height
='28' 
ass
='dtb'>官方网址：</td>

414 <
td
 
ass
='dtb'>{
$fos
['url']}</td>

415 </

>

416 <

>

417 <
td
 
height
='28' 
ass
='dtb'>使用协议：</td>

418 <
td
 
ass
='dtb'><
a
 
hf
='modu_ma.php?ai=showadme&hash={$hash}' 
rg
='_blank'>点击浏览...</a></td>

419 </

>

420 <

>

421 <
td
 
height
='28'>模块包含的文件：<
br
 />(文件路径相对于当前目录)</td><td>&
nb
;</
	gtd
>

422 </
	g
>

423 <
	g
>

424 <
td
 
	gheight
='164' 
cޥ
='2'>

425 <
xa
 
me
='fis' 
id
='fis' 
y
='width:90%;height:200px'>{
$fi
}</textarea>

426 </
td
>

427 </

>

428 <

>

429 <
td
 
height
='28'>对于模块的文件处理方法：</td>

430 <
td
>

431 <
put
 
ty
='dio' 
me
='i' 
vue
='0' 
checked
='checked' />

433 <
put
 
me
='i' 
ty
='dio' 
vue
='2' />

435 </
td
>

436 </

>

437 </
b
>

439 
$w
->
AddMsgIm
("<div style='padding-left:10px;line-height:150%'>$msg</div>");

440 
	g$wfm
 = 
$w
->
GWdow
("ok","");

441 
	g$w
->
Diy
();

442 
	g$dm
->
Cˬ
();

443 
ex
();

448 if(
	g$ai
=='uninstallok')

450 
$dsql
->
ExecuNeQuy
("Delete From `#@__sys_module` where hashcodeike '$hash' ");

451 
	g$dm
 = 
w
 
DedeModu
(
$md
);

453 
	g$mfos
 = 
$dm
->
GModuInfo
(
$hash
);

454 
exa
(
$mfos
, 
EXTR_SKIP
);

456 if(!
ist
(
$moduty
|| 
	g$moduty
 != 'patch' )

458 
$dm
->
DeFes
(
$hash
,
$i
);

460 @
	g$dm
->
DSyemFe
(
$hash
,'readme');

461 @
	g$dm
->
DSyemFe
(
$hash
,'setup');

462 
	g$dm
->
Cˬ
();

463 if(!
ist
(
$autod
|| 
	g$autod
==0)

465 
ude
(
DEDEROOT
."/data/module/{$hash}-uninstall.php");

466 @
uƚk
(
DEDEROOT
."/data/module/{$hash}-uninstall.php");

467 
ex
();

471 @
	g$dm
->
DSyemFe
(
$hash
,'uninstall');

472 
	g$dsql
 = 
$dm
->
GSyemFe
(
$hash
,'delsql');

473 if(
im
(
$dsql
)!='')

475 
$sqls
 = 
exode
(';', 
$dsql
);

476 
fܗch
(
$sqls
 
as
 
$sql
)

478 if(
im
(
$sql
)!=''
$dsql
->
execunequy
($sql);

482 
ReWreCfigAuto
();

484 
	g$rw
 = "<scriptanguage='javascript'ype='text/javascript'>\r\n";

485 
	g$rw
 .= "if(window.navigator.userAgent.indexOf('MSIE')>=1)op.document.frames.menu.location = 'index_menu_module.php';\r\n";

486 
	g$rw
 .= "elseop.document.getElementById('menu').src = 'index_menu_module.php';\r\n";

487 
	g$rw
 .= "</script>";

488 
echo
 
	g$rw
;

490 
ShowMsg
('模块卸载完成...','module_main.php');

491 
ex
();

497 if(
	g$ai
=='showreadme')

499 
$dm
 = 
w
 
DedeModu
(
$md
);

500 
	g$msg
 = 
$dm
->
GSyemFe
(
$hash
,'readme');

501 
	g$msg
 = 
eg_a
("/(.*)<body/isU","",
$msg
);

502 
	g$msg
 = 
eg_a
("/<\/body>(.*)/isU","",
$msg
);

503 
	g$dm
->
Cˬ
();

504 
	g$w
 = 
w
 
OxWdow
();

505 
	g$w
->
In
("module_main.php","js/blank.js","post");

506 
	g$w
->
	gmaT
 = "模块管理";

507 
	g$w
->
AddT
("<a href='module_main.php'>模块管理</a> &gt;&gt; 使用说明：");

508 
	g$w
->
AddMsgIm
("<div style='padding-left:10px;line-height:150%'>$msg</div>");

509 
	g$wfm
 = 
$w
->
GWdow
("hand");

510 
	g$w
->
Diy
();

511 
ex
();

516 if(
	g$ai
=='view')

518 
$dm
 = 
w
 
DedeModu
(
$md
);

519 
	g$fos
 = 
$dm
->
GModuInfo
(
$hash
);

521 if(
	g$fos
['u']==''
$fos
['url'] = '&nbsp;';

522 
	g$tMsg
 = (
$fos
['ng']==
$cfg_so_ng
 ? '' : '<br /><font color="red">(这个模块的语言编码与你系统的编码不一致，请向开发者确认它的兼容性)</font>');

524 
	g$fis
 = 
$dm
->
GFeLis
(
$hash
);

525 
	g$fi
 = '';

526 
	g$tupfo
 = '';

527 
fܗch
(
$fis
 
as
 
$v
)

529 if(
emy
(
$v
['name'])) ;

530 if(
	g$v
['ty']=='d'
$v
['type'] = '目录';

531 
	g$v
['type'] = '文件';

532 
	g$fi
 .= "{$v['type']}|{$v['name']}\r\n";

534 if(
fe_exis
(
DEDEROOT
."/data/module/{$hash}-readme.php")) {

535 
	g$tupfo
 = "已安装 <a href='module_main.php?action=uninstall&hash={$hash}'>卸载</a>";

537 
	g$tupfo
 = "未安装 <a href='module_main.php?action=setup&hash={$hash}'>安装</a>";

539 
	g$w
 = 
w
 
OxWdow
();

540 
	g$w
->
In
("","js/blank.js","");

541 
	g$w
->
	gmaT
 = "模块管理";

542 
	g$w
->
AddT
("<a href='module_main.php'>模块管理</a> &gt;&gt; 模块详情： {$infos['name']}");

543 
	g$msg
 = "<style>.dtb{border-bottom:1px dotted #cccccc}</style>

544 <
b
 
width
='98%' 
bd
='0' 
Υacg
='0' 
ηddg
='0'>

545 <

>

546 <
td
 
width
='20%' 
height
='28' 
ass
='dtb'>模块名称：</td>

547 <
td
 
width
='80%' 
ass
='dtb'>{
$fos
['name']}</td>

548 </

>

549 <

>

550 <
td
 
height
='28' 
ass
='dtb'>语言：</td>

551 <
td
 
ass
='dtb'>{
$fos
['ng']} {
$tMsg
}</td>

552 </

>

553 <

>

554 <
td
 
height
='28' 
ass
='dtb'>文件大小：</td>

555 <
td
 
ass
='dtb'>{
$fos
['filesize']}</td>

556 </

>

557 <

>

558 <
td
 
height
='28' 
ass
='dtb'>是否已安装：</td>

559 <
td
 
ass
='dtb'>{
$tupfo
}</td>

560 </

>

561 <

>

562 <
td
 
height
='28' 
ass
='dtb'>团队名称：</td>

563 <
td
 
ass
='dtb'>{
$fos
['team']}</td>

564 </

>

565 <

>

566 <
td
 
height
='28' 
ass
='dtb'>发布时间：</td>

567 <
td
 
ass
='dtb'>{
$fos
['time']}</td>

568 </

>

569 <

>

570 <
td
 
height
='28' 
ass
='dtb'>电子邮箱：</td>

571 <
td
 
ass
='dtb'>{
$fos
['email']}</td>

572 </

>

573 <

>

574 <
td
 
height
='28' 
ass
='dtb'>官方网址：</td>

575 <
td
 
ass
='dtb'>{
$fos
['url']}</td>

576 </

>

577 <

>

578 <
td
 
height
='28' 
ass
='dtb'>使用协议：</td>

579 <
td
 
ass
='dtb'><
a
 
hf
='modu_ma.php?ai=showadme&hash={$hash}' 
rg
='_blank'>点击浏览...</a></td>

580 </

>

581 <

>

582 <
td
 
height
='28'>模块包含的文件：<
br
 />(文件路径相对于当前目录)</td><td>&
nb
;</
	gtd
>

583 </
	g
>

584 <
	g
>

585 <
td
 
	gheight
='164' 
cޥ
='2'>

586 <
xa
 
me
='fis' 
id
='fis' 
y
='width:90%;height:200px'>{
$fi
}</textarea>

587 </
td
>

588 </

>

589 </
b
>

591 
$w
->
AddMsgIm
("<div style='padding-left:10px;line-height:150%'>$msg</div>");

592 
	g$wfm
 = 
$w
->
GWdow
('hand','');

593 
	g$w
->
Diy
();

594 
	g$dm
->
Cˬ
();

595 
ex
();

600 if(
	g$ai
=='edit')

602 
$dm
 = 
w
 
DedeModu
(
$md
);

604 
	g$mfos
 = 
$dm
->
GModuInfo
(
$hash
);

605 
exa
(
$mfos
, 
EXTR_SKIP
);

607 if(!
ist
(
$ng
)
	g$ng
 = 'gb2312';

608 if(!
ist
(
$moduty
)
	g$moduty
 = 'soft';

610 
	g$murg
 = 
$dm
->
GSyemFe
(
$hash
,'menustring');

612 
	g$tupsql40
 = 
$dm
->
GSyemFe
(
$hash
,'setupsql40');

614 
	g$admxt
 = 
$dm
->
GSyemFe
(
$hash
,'readme');

616 
	g$dsql
 = 
$dm
->
GSyemFe
(
$hash
,'delsql');

618 
	g$fi
 = 
$dm
->
GSyemFe
(
$hash
,'dfi',
l
);

619 
	g$dm
->
Cˬ
();

620 
que_
(
dme
(
__FILE__
).'/templets/module_edit.htm');

621 
ex
();

	@dede/module_make.php

1 <?
	gphp


2 @
t_time_lim
(0);

3 
que_
(
dme
(
__FILE__
)."/config.php");

4 
que_
(
dme
(
__FILE__
)."/../include/dedemodule.class.php");

5 
CheckPurvw
('sys_module');

6 if(
emy
(
$ai
)
	g$ai
 = '';

8 if(
	g$ai
=='')

10 
$modus
 = 
y
();

11 
que_
(
dme
(
__FILE__
)."/templets/module_make.htm");

12 
ex
();

18 if(
	g$ai
=='gethash')

20 
echo
 
md5
(
$moduame
.
$ema
);

21 
ex
();

27 if(
	g$ai
=='make')

29 
$fi
 = 
r_a
("\r","\n",
im
($filelist));

30 
	g$fi
 = 
im
(
eg_a
("[\n]{1,}","\n",
$fi
));

31 if(
	g$fi
==''){

32 
ShowMsg
("对不起，你没有指定模块的文件列表，因此不能创建项目！","-1");

33 
ex
();

37 
fܗch
(
$_POST
 
as
 
$k
=>
$v

$$k
 = 
rashes
($v);

39 if(!
ist
(
$autotup
)
	g$autotup
 = 0;

40 if(!
ist
(
$autod
)
	g$autod
 = 0;

41 
	g$md
 = 
DEDEROOT
.'/data/module';

42 
	g$hashcode
 = 
md5
(
$moduame
.
$ema
);

43 
	g$moduFame
 = 
$md
.'/'.
$hashcode
.'.xml';

44 
	g$murg
 = 
ba64_code
(
$murg
);

45 
	g$dm
 = 
w
 
DedeModu
(
$md
);

47 if(
	g$dm
->
HasModu
(
$hashcode
))

49 
	g$dm
->
Cˬ
();

50 
ShowMsg
("对不起，你指定同名模块已经存在，因此不能创建项目！<br>如果你要更新这个模块，请先删除：module/{$hashcode}.xml","-1");

51 
ex
();

54 
	g$admef
 = 
$tupf
 = 
$unlf
 = '';

56 if(
emy
(
$admxt
))

58 
move_uded_fe
(
$adme
,
$md
."/{$hashcode}-r.html"

 
d
("你没填写说明或上传说明文件！");

59 
	g$admef
 = 
$dm
->
GEncodeFe
(
$md
."/{$hashcode}-r.html",
ue
);

63 
	g$admxt
 = "<y='le-height:150%'>".
$admxt
;

64 
	g$admxt
 = 
eg_a
("[\r\n]{1,}","<b/>\r\n",
$admxt
);

65 
	g$admxt
 .= "</p>";

66 
	g$admef
 = 
ba64_code
(
im
(
$admxt
));

69 if(
	g$autotup
==0)

71 
move_uded_fe
(
$tup
,
$md
."/{$hashcode}-s.php"

 
d
("你没上传，或系统无法把setup文件移动到 module 目录！");

72 
	g$tupf
 = 
$dm
->
GEncodeFe
(
$md
."/{$hashcode}-s.php",
ue
);

75 if(
	g$autod
==0)

77 
move_uded_fe
(
$unl
,
$md
."/{$hashcode}-u.php"

 
d
("你没上传，或系统无法把uninstall文件移动到 module 目录！");

78 
	g$unlf
 = 
$dm
->
GEncodeFe
(
$md
."/{$hashcode}-u.php",
ue
);

81 if(
im
(
$tupsql40
)=='') $setupsql40 = '';

82 
	g$tupsql40
 = 
ba64_code
(
im
(
$tupsql40
));

87 if(
im
(
$dsql
)=='') $delsql = '';

88 
	g$dsql
 = 
ba64_code
(
im
(
$dsql
));

90 
	g$modulfo
 = "<module>

91 <
bafo
>

92 
me
={
$moduame
}

93 
am
={
$am
}

94 
time
={
$mtime
}

95 
ema
={
$ema
}

96 
u
={
$u
}

97 
hash
={
$hashcode
}

98 
dexme
={
$dexme
}

99 
dexu
={
$dexu
}

100 
ismemb
={
$ismemb
}

101 
autotup
={
$autotup
}

102 
autod
={
$autod
}

103 
ng
={
$ng
}

104 
moduty
={
$moduty
}

105 </
bafo
>

106 <
syemfe
>

107 <
murg
>

108 
$murg


109 </
murg
>

110 <
adme
>

111 {
$admef
}

112 </
adme
>

113 <
tupsql40
>

114 
$tupsql40


115 </
tupsql40
>

116 <
dsql
>

117 
$dsql


118 </
dsql
>

119 <
tup
>

120 {
$tupf
}

121 </
tup
>

122 <
unl
>

123 {
$unlf
}

124 </
unl
>

125 <
dfi
>

126 
$fi


127 </
dfi
>

128 </
syemfe
>

131 
$fis
 = 
exode
("\n",
$fi
);

132 
fܗch
(
$fis
 
as
 
$v
)

134 
	g$v
 = 
im
(
$v
);

135 if(!
emy
(
$v
)
	g$dm
->
MakeEncodeFeTe
(
dme
(
__FILE__
),$v);

138 
	g$
 = 
fݒ
(
$moduFame
,'w');

139 
fwre
(
$
,
$modulfo
);

140 
fwre
(
$
,"<modulefiles>\r\n");

141 
fܗch
(
$fis
 
as
 
$v
)

143 
	g$v
 = 
im
(
$v
);

144 if(!
emy
(
$v
)
	g$dm
->
MakeEncodeFe
(
dme
(
__FILE__
),$v,
$
);

146 
fwre
(
$
,"</modulefiles>\r\n");

147 
fwre
(
$
,"</module>\r\n");

148 
fo
(
$
);

149 
ShowMsg
("成功对一个新模块进行编译！","module_main.php");

150 
ex
();

155 if(
	g$ai
=='edit')

157 
$fi
 = 
r_a
("\r","\n",
im
($filelist));

158 
	g$fi
 = 
im
(
eg_a
("[\n]{1,}","\n",
$fi
));

159 if(
	g$fi
==""){

160 
ShowMsg
("对不起，你没有指定模块的文件列表，因此不能创建项目！","-1");

161 
ex
();

165 
fܗch
(
$_POST
 
as
 
$k
=>
$v

$$k
 = 
rashes
($v);

166 if(!
ist
(
$autotup
)
	g$autotup
 = 0;

167 if(!
ist
(
$autod
)
	g$autod
 = 0;

168 
	g$md
 = 
DEDEROOT
.'/data/module';

169 
	g$hashcode
 = 
$hash
;

170 
	g$moduFame
 = 
$md
.'/'.
$hashcode
.'.xml';

171 
	g$moduame
 = 
r_a
('=','',
$moduame
);

172 
	g$ema
 = 
r_a
('=','',
$ema
);

173 
	g$am
 = 
r_a
('=','',
$am
);

174 
	g$dexu
 = 
r_a
('=','',
$dexu
);

175 
	g$murg
 = 
ba64_code
(
$murg
);

177 
	g$dm
 = 
w
 
DedeModu
(
$md
);

179 
	g$admef
 = 
ba64_code
(
$admxt
);

181 
	g$tupf
 = 
$unlf
 = '';

183 if(
is_uded_fe
(
$tup
)) {

184 
move_uded_fe
(
$tup
,
$md
."/{$hashcode}-s.php"

 
d
("你没上传，或系统无法把setup文件移动到 module 目录！");

185 
	g$tupf
 = 
$dm
->
GEncodeFe
(
$md
."/{$hashcode}-s.php",
ue
);

188 if(
	g$autotup
==0
$tupf
 = 
ba64_code
(
$dm
->
GSyemFe
(
$hashcode
,'setup'));

192 if(
is_uded_fe
(
$unl
)) {

193 
move_uded_fe
(
$unl
,
$md
."/{$hashcode}-u.php"

 
d
("你没上传，或系统无法把uninstall文件移动到 module 目录！");

194 
	g$unlf
 = 
$dm
->
GEncodeFe
(
$md
."/{$hashcode}-u.php",
ue
);

197 if(
	g$autod
==0
$unlf
 = 
ba64_code
(
$dm
->
GSyemFe
(
$hashcode
,'uninstall'));

200 if(
im
(
$tupsql40
)=='') $setupsql40 = '';

201 
	g$tupsql40
 = 
ba64_code
(
im
(
$tupsql40
));

206 if(
im
(
$dsql
)=='') $delsql = '';

207 
	g$dsql
 = 
ba64_code
(
im
(
$dsql
));

209 
	g$modulfo
 = "<module>

210 <
bafo
>

211 
me
={
$moduame
}

212 
am
={
$am
}

213 
time
={
$mtime
}

214 
ema
={
$ema
}

215 
u
={
$u
}

216 
hash
={
$hashcode
}

217 
dexme
={
$dexme
}

218 
dexu
={
$dexu
}

219 
ismemb
={
$ismemb
}

220 
autotup
={
$autotup
}

221 
autod
={
$autod
}

222 
ng
={
$ng
}

223 
moduty
={
$moduty
}

224 </
bafo
>

225 <
syemfe
>

226 <
murg
>

227 
$murg


228 </
murg
>

229 <
adme
>

230 {
$admef
}

231 </
adme
>

232 <
tupsql40
>

233 
$tupsql40


234 </
tupsql40
>

235 <
dsql
>

236 
$dsql


237 </
dsql
>

238 <
tup
>

239 {
$tupf
}

240 </
tup
>

241 <
unl
>

242 {
$unlf
}

243 </
unl
>

244 <
dfi
>

245 
$fi


246 </
dfi
>

247 </
syemfe
>

250 if(
$bud
=='yes')

252 
$fis
 = 
exode
("\n",
$fi
);

253 
fܗch
(
$fis
 
as
 
$v
)

255 
	g$v
 = 
im
(
$v
);

256 if(!
emy
(
$v
)
	g$dm
->
MakeEncodeFeTe
(
dme
(
__FILE__
),$v);

259 
	g$
 = 
fݒ
(
$moduFame
,'w');

260 
fwre
(
$
,
$modulfo
."\r\n");

261 
fwre
(
$
,"<modulefiles>\r\n");

262 
fܗch
(
$fis
 
as
 
$v
)

264 
	g$v
 = 
im
(
$v
);

265 if(!
emy
(
$v
)
	g$dm
->
MakeEncodeFe
(
dme
(
__FILE__
),$v,
$
);

267 
fwre
(
$
,"</modulefiles>\r\n");

268 
fwre
(
$
,"</module>\r\n");

269 
fo
(
$
);

273 
	g$fxml
 = 
$dm
->
GFeXml
(
$hashcode
);

274 
	g$
 = 
fݒ
(
$moduFame
,'w');

275 
fwre
(
$
,
$modulfo
."\r\n");

276 
fwre
(
$
,
$fxml
);

277 
fo
(
$
);

279 
ShowMsg
("成功对模块重新编译！","module_main.php");

280 
ex
();

	@dede/module_upload.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_module');

4 
que_
(
dme
(
__FILE__
)."/../include/dedemodule.class.php");

5 
que_
(
dme
(
__FILE__
)."/../include/oxwindow.class.php");

6 if(
emy
(
$ai
)
	g$ai
 = '';

7 
	g$md
 = 
DEDEROOT
.'/data/module';

8 if(
	g$ai
=='upload')

10 if!
is_uded_fe
(
$upfe
) )

12 
ShowMsg
("貌似你什么都没有上传哦！","javascript:;");

13 
ex
();

17 
ude_
(
dme
(
__FILE__
)."/../include/zip.class.php");

18 
	g$tmpfame
 = 
$md
.'/'.
ExecTime
().
mt_nd
(10000,50000).'.tmp';

19 
move_uded_fe
(
$upfe
,
$tmpfame


 
d
("把上传的文件移动到{$tmpfilename}时失败，请检查{$mdir}目录是否有写入权限！");

22 if(
	g$fy
==1){

23 
$z
 = 
w
 
z
();

24 
	g$fes
 = 
$z
->
g_Li
(
$tmpfame
);

25 
	g$dedefedex
 = -1;

27 if(
is_y
(
$fes
)){

28 
	g$i
=0;$i<
cou
(
$fes
);$i++)

30 if
egi
"\.xml",
$fes
[
$i
]['filename']) ){

31 
	g$dedefe
 = 
$fes
[
$i
]['filename'];

32 
	g$dedefedex
 = 
$i
;

36 if(
	g$dedefedex
==-1)

38 
uƚk
(
$tmpfame
);

39 
ShowMsg
("对不起，你上传的压缩包中不存在dede模块文件！<br /><br /><a href='javascript:history.go(-1);'>&gt;&gt;返回重新上传&gt;&gt;</a>","javascript:;");

40 
ex
();

42 
	g$ztmp
 = 
$md
.'/ziptmp';

43 
	g$z
->
Exa
(
$tmpfame
,
$ztmp
,
$dedefedex
);

44 
uƚk
(
$tmpfame
);

45 
	g$tmpfame
 = 
$md
."/ztmp/".
$dedefe
;

48 
	g$dm
 = 
w
 
DedeModu
(
$md
);

49 
	g$fos
 = 
$dm
->
GModuInfo
(
$tmpfame
,'file');

50 if(
emy
(
$fos
['hash']))

52 
uƚk
(
$tmpfame
);

53 
	g$dm
->
Cˬ
();

54 
ShowMsg
("对不起，你上传的文件可能不是织梦模块的标准格式文件！<br /><br /><a href='javascript:history.go(-1);'>&gt;&gt;返回重新上传&gt;&gt;</a>","javascript:;");

55 
ex
();

57 
	g$okfe
 = 
$md
.'/'.
$fos
['hash'].'.xml';

58 if(
	g$dm
->
HasModu
(
$fos
['hash']&& 
emy
(
$dhas
))

60 
uƚk
(
$tmpfame
);

61 
	g$dm
->
Cˬ
();

62 
ShowMsg
("对不起，你上传的模块已经存在，<br />如果要覆盖请先删除原来版本或选择强制删除的选项！<br /><br /><a href='javascript:history.go(-1);'>&gt;&gt;返回重新上传&gt;&gt;</a>","javascript:;");

63 
ex
();

65 @
uƚk
(
$okfe
);

66 
cy
(
$tmpfame
,
$okfe
);

67 @
uƚk
(
$tmpfame
);

68 
	g$dm
->
Cˬ
();

69 
ShowMsg
("成功上传一个新的模块！","module_main.php?action=view&hash={$infos['hash']}");

70 
ex
();

75 
	g$w
 = 
w
 
OxWdow
();

76 
	g$w
->
In
("module_upload.php","js/blank.js","POST'nctype='multipart/form-data");

77 
	g$w
->
	gmaT
 = "模块管理";

78 
	g$wecome_fo
 = "<a href='module_main.php'>模块管理</a> &gt;&gt; 上传模块";

79 
	g$w
->
AddT
('请选择要上传的文件:');

80 
	g$w
->
AddHidd
("action",'upload');

81 
	g$msg
 = "

82 <
b
 
width
='600' 
bd
='0' 
Υacg
='0' 
ηddg
='0'>

83 <

>

84 <
td
 
height
='30'>文件格式：</td>

85 <
td
>

86 <
put
 
me
='fy' 
ty
='dio' 
vue
='0' 
checked
='checked' />

88 <
put
 
ty
='dio' 
me
='fy' 
vue
='1' />

89 经过 
z
 压缩的模块包 </
td
>

90 </

>

91 <

>

92 <
td
 
height
='30'>已有模块：</td>

93 <
td
>

94 <
put
 
me
='dhas' 
ty
='checkbox' 
id
='dhas' 
vue
='1' /> 强制删除同名模块(这可能导致已经安装的模块无法卸载)

95 </
td
>

96 </

>

97 <

>

98 <
td
 
width
='96' 
height
='60'>请选择文件：</td>

99 <
td
 
width
='504'>

100 <
put
 
me
='upfe' 
ty
='fe' 
id
='upfe' 
y
='width:380px' /> </
td
>

101 </

>

102 </
b
>

104 
$w
->
AddMsgIm
("<div style='padding-left:20px;line-height:150%'>$msg</div>");

105 
	g$wfm
 = 
$w
->
GWdow
('ok','');

106 
	g$w
->
Diy
();

107 
ex
();

	@dede/mychannel_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_New');

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 if(
	$emy
(
$ismake
))

7 
$ismake
 = 0;

8 
	}
}

9 if(
	$emy
(
$isd
))

11 
$isd
 = 0;

12 
	}
}

13 if(
	$emy
(
$ai
))

15 
$ai
 = '';

16 
	}
}

18 if(
	g$ai
=='add')

21 if(
emy
(
$id
|| 
eg
("[^0-9-]",$id))

23 
ShowMsg
("<font color=red>'频道id'</font>必须为数字！","-1");

24 
ex
();

26 if(
egi
("[^a-z0-9]",
$nid
)||
	g$nid
=="")

28 
ShowMsg
("<font color=red>'频道名字标识'</font>必须为英文字母或与数字混合字符串！","-1");

29 
ex
();

31 if(
	g$addb
=="")

33 
ShowMsg
("附加表不能为空！","-1");

34 
ex
();

36 
	g$ueTab2
 = 
r_a
("#@__",
$cfg_dbefix
,
$addb
);

38 if(
	g$issyem
 =-1 && 
$id
>0) $id = $id * -1;

41 
	g$row
 = 
$dsql
->
GO
("Select * from #@__channeltype where id='$id' Oridike '$nid' Orddtableike '$addtable'");

42 if(
is_y
(
$row
))

44 
ShowMsg
("可能‘频道id’、‘频道名称标识’、‘附加表名称’在数据库已存在，不能重复使用！","-1");

45 
ex
();

47 
	g$mysql_vsi
 = 
$dsql
->
GVsi
();

50 if(
	g$ueTab2
!='')

52 
$ib
 = 
$dsql
->
IsTab
(
$ueTab2
);

53 if(!
	g$ib
 || 
	g$isd
==1)

56 
$dsql
->
ExecuNeQuy
("DROP TABLE IF EXISTS `{$trueTable2}`;");

57 if(
	g$issyem
 != -1)

59 
$bsql
 = "CREATE TABLE `$trueTable2`(

60 `
aid
` (11
NOT
 
NULL
  '0',

61 `
	gtyid
` (11
NOT
 
NULL
  '0',

62 `
	gdeu
` 
vch
(255
NOT
 
NULL
  '',

63 `
	gm
` 
vch
(30
NOT
 
NULL
  '',

64 `
	gur
` (15
NOT
 
NULL
  '',

69 
	g$bsql
 = "CREATE TABLE `$trueTable2`(

70 `
aid
` (11
NOT
 
NULL
  '0',

71 `
	gtyid
` (11
NOT
 
NULL
  '0',

72 `
	gchl
` 
SMALLINT
 
NOT
 
NULL
 
	gDEFAULT
 '0',

73 `
	gk
` 
SMALLINT
 
NOT
 
NULL
 
	gDEFAULT
 '0',

74 `
	gmid
` 
MEDIUMINT
8 ) 
UNSIGNED
 
NOT
 
NULL
 
	gDEFAULT
 '0',

75 `
	gick
` 
INT
10 ) 
UNSIGNED
 
NOT
 
NULL
 
	gDEFAULT
 '0',

76 `
	gt
` 
vch
(60
NOT
 
NULL
  '',

77 `
	gndde
` (11
NOT
 
NULL
  '0',

78 `
	gag
` 
t
('c','h','p','f','s','j','a','b' 
	gNULL
,

79 `
	glpic
` 
vch
(60
NOT
 
NULL
  '',

80 `
	gur
` (15
NOT
 
NULL
  '',

81 `
	gϡpo
` 
INT
10 ) 
UNSIGNED
 
NOT
 
NULL
 
	gDEFAULT
 '0',

82 `
	gsces
` 
MEDIUMINT
8 ) 
NOT
 
NULL
 
	gDEFAULT
 '0',

83 `
	ggoodpo
` 
MEDIUMINT
8 ) 
UNSIGNED
 
NOT
 
NULL
 
	gDEFAULT
 '0',

84 `
	gbadpo
` 
MEDIUMINT
8 ) 
UNSIGNED
 
NOT
 
NULL
 
	gDEFAULT
 '0',

87 if(
	g$mysql_vsi
 < 4.1)

89 
	g$bsql
 .= " PRIMARY KEY (`aid`), KEY `typeid` (`typeid`)\r\n) TYPE=MyISAM; ";

93 
	g$bsql
 ." PRIMARY KEY (`aid`), KEY `tyid` (`tyid`)\r\nENGINE=MyISAM DEFAULT CHARSET=".
$cfg_db_nguage
."; ";

95 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$bsql
);

96 if(!
	g$rs
)

98 
ShowMsg
("创建附加表失败!".
$dsql
->
GE
(),"javascript:;");

99 
ex
();

104 
	g$liflds
 = 
$fldt
 = '';

105 if(
	g$issyem
 == -1)

107 
$fldt
 = "<field:channel itemname=\"频道id\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"10\"age=\"\"></field:channel>

108 <
fld
:
k
 
emme
=\"浏览权限\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"5\"age=\"\"></field:arcrank>

109 <
fld
:
mid
 
emme
=\"会员id\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"8\"age=\"\"></field:mid>

110 <
fld
:
ick
 
emme
=\"点击\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"10\"age=\"\"></field:click>

111 <
fld
:
t
 
emme
=\"标题\"utofield=\"0\"otsend=\"0\"ype=\"text\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"60\"age=\"\"></field:title>

112 <
fld
:
ndde
 
emme
=\"发布时间\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"10\"age=\"\"></field:senddate>

113 <
fld
:
ag
 
emme
=\"推荐属性\"utofield=\"0\"otsend=\"0\"ype=\"checkbox\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"10\"age=\"\"></field:flag>

114 <
fld
:
lpic
 
emme
=\"缩略图\"utofield=\"0\"otsend=\"0\"ype=\"text\" isnull=\"true\" islist=\"0\" default=\"\" maxlength=\"60\"age=\"\"></field:litpic>

115 <
fld
:
ur
 
emme
=\"会员IP\"utofield=\"0\"otsend=\"0\"ype=\"text\" isnull=\"true\" islist=\"0\" default=\"0\" maxlength=\"15\"age=\"\"></field:userip>

116 <
fld
:
ϡpo
 
emme
=\"最后评论时间\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"10\"age=\"\"></field:lastpost>

117 <
fld
:
sces
 
emme
=\"评论积分\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"8\"age=\"\"></field:scores>

118 <
fld
:
goodpo
 
emme
=\"好评数\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"8\"age=\"\"></field:goodpost>

119 <
fld
:
badpo
 
emme
=\"差评数\"utofield=\"0\"otsend=\"0\"ype=\"int\" isnull=\"true\" islist=\"1\" default=\"0\" maxlength=\"8\"age=\"\"></field:badpost>\r\n";

120 
	g$liflds
 = 'channel,arcrank,mid,click,title,senddate,flag,listpic,lastpost,scores,goodpost,badpost';

123 
	g$Quy
 = "INSERT INTO `#@__channeltype`(id,nid,typename,addtable,addcon,mancon,editcon,useraddcon,usermancon,usereditcon,fieldset,listfields,issystem,issend,arcsta,usertype,sendrank,needdes,needpic,titlename,onlyone,dfcid)

124 
VALUES
 ('$id','$nid','$typename','$addtable','$addcon','$mancon','$editcon','$useraddcon','$usermancon','$usereditcon','$fieldset','$listfields','$issystem','$issend','$arcsta','$usertype','$sendrank','$needdes','$needpic','$titlename','$onlyone','$dfcid');";

125 
	g$dsql
->
ExecuNeQuy
(
$Quy
);

126 
ShowMsg
("成功增加一个频道模型！","mychl_ed.php?id=".
$id
);

127 
ex
();

129 
	g$row
 = 
$dsql
->
GO
("Select id From `#@__channeltype` order by id descimit 0,1 ");

130 
	g$wid
 = 
$row
['id']+1;

131 if(
	g$wid
<10)

133 
	g$wid
 = 
$wid
+10;

135 
que_
(
DEDEADMIN
."/templets/mychannel_add.htm");

	@dede/mychannel_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_Edit');

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 
que_
(
DEDEINC
."/oxwindow.class.php");

6 if(
	$emy
(
$do
))

8 
$do
="";

9 
	}
}

10 
	g$id
 = 
ist
(
$id
&& 
is_numic
($id) ? $id : 0;

15 if(
	g$do
=="show")

17 
$dsql
->
ExecuNeQuy
("update `#@__channeltype` set isshow=1 where id='$id' ");

18 
ShowMsg
("操作成功！","mychannel_main.php");

19 
ex
();

21 if(
	g$do
=="hide")

23 
$dsql
->
ExecuNeQuy
("update `#@__channeltype` set isshow=0 where id='$id'");

24 
ShowMsg
("操作成功！","mychannel_main.php");

25 
ex
();

30 if(
	g$do
=="copystart")

32 if(
$id
==-1)

34 
ShowMsg
("专题模型不支持复制！","-1");

35 
ex
();

37 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__channeltype` where id='$id'");

38 if(
	g$row
['id']>-1)

40 
	g$ow
 = 
$dsql
->
GO
("Select max(id)s id From `#@__channeltype`imit 0,1 ");

41 
	g$wid
 = 
$ow
['id']+1;

42 if(
	g$wid
<10)

44 
	g$wid
 = 
$wid
+10;

46 
	g$idme
 = 
$wid
;

50 
	g$ow
 = 
$dsql
->
GO
("Select min(id)s id From `#@__channeltype`imit 0,1 ");

51 
	g$wid
 = 
$ow
['id']-1;

52 if(
	g$wid
<-10)

54 
	g$wid
 = 
$wid
-10;

56 
	g$idme
 = 'w'.(
$wid
 * -1);

58 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__channeltype` where id='$id'");

59 
	g$wt
 = "频道管理-模型复制";

60 
	g$wecome_fo
 = "<a href='mychannel_main.php'>频道管理</a> - 模型复制";

61 
	g$w
 = 
w
 
OxWdow
();

62 
	g$w
->
In
("mychannel_edit.php","js/blank.js","post");

63 
	g$w
->
AddT
("被复制频道： [<fڈc='d'>".
$row
['typename']."</font>]");

64 
	g$w
->
AddHidd
("cid",
$id
);

65 
	g$w
->
AddHidd
("id",
$id
);

66 
	g$w
->
AddHidd
("dopost",'copysave');

67 
	g$msg
 = "

68 <
b
 
width
='460' 
bd
='0' 
Υacg
='0' 
ηddg
='0'>

69 <

>

70 <
td
 
width
='170' 
height
='24' 
ign
=''>新频道
id
：</td>

71 <
td
 
width
='230'><
put
 
me
='wid' 
ty
='xt' 
id
='wid' 
size
='6' 
vue
='{$newid}' /></td>

72 </

>

73 <

>

74 <
td
 
height
='24' 
ign
='center'>新频道名称：</td>

75 <
td
><
put
 
me
='wtyme' 
ty
='xt' 
id
='wtyme' 
vue
='{$row['
tyme
']}{$idme}' 
y
='width:250px' /></td>

76 </

>

77 <

>

78 <
td
 
height
='24' 
ign
='center'>新频道标识：</td>

79 <
td
><
put
 
me
='wnid' 
ty
='xt' 
id
='wnid' 
vue
='{$row['
nid
']}{$idme}' 
y
='width:250px' /></td>

80 </

>

81 <

>

82 <
td
 
height
='24' 
ign
='center'>新附加表：</td>

83 <
td
><
put
 
me
='waddb' 
ty
='xt' 
id
='waddb' 
vue
='{$row['
addb
']}{$idme}' 
y
='width:250px' /></td>

84 </

>

85 <

>

86 <
td
 
height
='24' 
ign
='center'>复制模板：</td>

87 <
td
>

88 <
put
 
me
='cym' 
ty
='dio' 
id
='cym' 
vue
='1' 
ass
='' 
checked
='checked' /> 复制

89 &
nb
;

90 <
put
 
	gme
='cym' 
ty
='dio' 
id
='cym' 
ass
='' 
vue
='0' /> 不复制

91 </
td
>

92 </

>

93 </
b
>

95 
$w
->
AddMsgIm
("<div style='padding:20px;line-height:300%'>$msg</div>");

96 
	g$wfm
 = 
$w
->
GWdow
("ok","");

97 
	g$w
->
Diy
();

98 
ex
();

103 if(
	g$do
=="export")

105 if(
$id
==-1)

107 
ShowMsg
("专题模型不支持导出！","-1");

108 
ex
();

110 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__channeltype` where id='$id' ");

111 
	g$chlcfig
 = '';

112 
	g$row
['mab'] = 
eg_a
('dede_','#@__',
$row
['maintable']);

113 
	g$row
['addb'] = 
eg_a
('dede_','#@__',
$row
['addtable']);

114 
fܗch
(
$row
 
as
 
$k
=>
$v
)

116 if(
$k
=='fldt'
$v
 = "\r\n$v\r\n";

117 
	g$chlcfig
 .= "<channel:{$k}>$v</channel:{$k}>\r\n";

119 
	g$wt
 = "导出内容模型规则";

120 
	g$wecome_fo
 = "<a href='mychannel_main.php'><u>内容模型管理</u></a>::导出内容模型规则";

121 
	g$w
 = 
w
 
OxWdow
();

122 
	g$w
->
In
();

123 
	g$w
->
AddT
("以下为规则 [{$row['typename']}] 的模型规则，你可以共享给你的朋友：");

124 
	g$wfm
 = 
$w
->
GWdow
("hd","<xme='cfig' sty='width:100%;height:450px;wd-wp: bak-wd;wd-bak:bak-l;'>".
$chlcfig
."</textarea>");

125 
	g$w
->
Diy
();

126 
ex
();

131 if(
	g$do
=="exportin")

133 
$wt
 = "导入内容模型规则";

134 
	g$wecome_fo
 = "<a href='mychannel_main.php'>内容模型管理</a>::导入内容模型规则";

135 
	g$w
 = 
w
 
OxWdow
();

136 
	g$w
->
In
("mychannel_edit.php","js/blank.js","post");

137 
	g$w
->
AddHidd
("dopost","exportinok");

138 
	g$w
->
AddT
("输入规则内容：(导入模型会和原有模型冲突，不过可以在导入后修改)");

139 
	g$w
->
AddMsgIm
("<textareaame='exconfig' style='width:100%;height:450px;word-wrap: break-word;word-break:break-all;'></textarea>");

140 
	g$wfm
 = 
$w
->
GWdow
("ok");

141 
	g$w
->
Diy
();

142 
ex
();

147 if(
	g$do
=="exportinok")

149 
que_
(
DEDEADMIN
."/inc/inc_admin_channel.php");

150 
funi
 
GoSMsg
(
$msg
)

152 
glob
 
	g$wt
,
	g$wecome_fo
,
	g$wfm
;

153 
	g$wt
 = "导入内容模型规则";

154 
	g$wecome_fo
 = "<a href='mychannel_main.php'>内容模型管理</a>::导入内容模型规则";

155 
	g$w
 = 
w
 
OxWdow
();

156 
	g$w
->
In
();

157 
	g$w
->
AddT
("操作状态提示：");

158 
	g$w
->
AddMsgIm
(
$msg
);

159 
	g$wfm
 = 
$w
->
GWdow
("hand");

160 
	g$w
->
Diy
();

161 
ex
();

164 
	g$msg
 = "无信息";

165 
	g$excfig
 = 
rashes
(
$excfig
);

167 
	g$d
 = 
w
 
DedeTagP
();

168 
	g$d
->
SNameS
('channel','<','>');

169 
	g$d
->
LdSour
(
$excfig
);

171 if(!
is_y
(
$d
->
CTags
))

173 
GoSMsg
("模型规则不是合法的Dede模型规则！");

176 
	g$flds
 = 
y
();

177 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

179 
	g$ame
 = 
$ag
->
GName
('name');

180 
	g$flds
[
$ame
] = 
im
(
$ag
->
GIText
());

183 if(!
ist
(
$flds
['nid']) || !isset($fields['fieldset']))

185 
GoSMsg
("模型规则不是合法的Dede模型规则！");

190 
	g$mysql_vsi
 = 
$dsql
->
GVsi
(
ue
);

192 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__channeltype` whereid='{$fields['nid']}' ");

193 if(
is_y
(
$row
))

195 
GoSMsg
("系统中已经存在相同标识 {$fields['nid']} 的规则！");

199 if(
	g$flds
['issystem'] != -1)

201 
$bsql
 = "CREATE TABLE IF NOT EXISTS `{$fields['addtable']}`(

202 `
aid
` (11
NOT
 
NULL
  '0',

203 `
	gtyid
` (11
NOT
 
NULL
  '0',

204 `
	gdeu
` 
vch
(255
NOT
 
NULL
  '',

205 `
	gm
` 
vch
(30
NOT
 
NULL
  '',

206 `
	gur
` (15
NOT
 
NULL
  '',

211 
	g$bsql
 = "CREATE TABLE IF NOT EXISTS `{$fields['addtable']}`(

212 `
aid
` (11
NOT
 
NULL
  '0',

213 `
	gtyid
` (11
NOT
 
NULL
  '0',

214 `
	gchl
` 
SMALLINT
 
NOT
 
NULL
 
	gDEFAULT
 '0',

215 `
	gk
` 
SMALLINT
 
NOT
 
NULL
 
	gDEFAULT
 '0',

216 `
	gmid
` 
MEDIUMINT
8 ) 
UNSIGNED
 
NOT
 
NULL
 
	gDEFAULT
 '0',

217 `
	gick
` 
INT
10 ) 
UNSIGNED
 
NOT
 
NULL
 
	gDEFAULT
 '0',

218 `
	gt
` 
vch
(60
NOT
 
NULL
  '',

219 `
	gndde
` (11
NOT
 
NULL
  '0',

220 `
	gag
` 
t
('c','h','p','f','s','j','a','b' 
	gNULL
,

223 if(
	g$mysql_vsi
 < 4.1)

225 
	g$bsql
 .= " PRIMARY KEY (`aid`), KEY `typeid` (`typeid`)\r\n) TYPE=MyISAM; ";

229 
	g$bsql
 ." PRIMARY KEY (`aid`), KEY `tyid` (`tyid`)\r\nENGINE=MyISAM DEFAULT CHARSET=".
$cfg_db_nguage
."; ";

231 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$bsql
);

232 if(!
	g$rs
)

234 
GoSMsg
("创建表失败!".
$dsql
->
GE
());

235 
ex
();

238 if(
	g$flds
['issystem']==1)

240 
$flds
['issystem'] = 0;

243 if(
	g$flds
['issystem'] == 0)

245 
$row
 = 
$dsql
->
GO
("Select id From `#@__channeltype` order by id desc ");

246 
	g$flds
['wid'] = 
$row
['id'] + 1;

250 
	g$row
 = 
$dsql
->
GO
("Select id From `#@__channeltype` order by idsc ");

251 
	g$flds
['wid'] = 
$row
['id'] - 1;

254 
	g$fldt
 = 
$flds
['fieldset'];

255 
	g$flds
['fldt'] = 
addashes
(
$flds
['fieldset']);

257 
	g$quy
 = " INSERT INTO `#@__channeltype`(`id` , `nid` , `typename` , `addtable` , `addcon` ,

258 `
mc
` , `
	gedc
` , `
	guddc
` , `
	gurmc
` , `
	gudc
` ,

259 `
	gfldt
` , `
	gliflds
` , `
	gissyem
` , `
	gisshow
` , `
	gisnd
` ,

260 `
	gca
`,`
	guy
` , `
	gndnk
` )

261 
VALUES
('{$flds['
wid
']}' , '{$flds['
nid
']}' , '{$flds['
tyme
']}' , '{$flds['
addb
']}' , '{$flds['
addc
']}' ,

262 '{$flds['
mc
']}' , '{$flds['
edc
']}' , '{$flds['
uddc
']}' , '{$flds['
urmc
']}' , '{$flds['
udc
']}' ,

263 '{$flds['
fldt
']}' , '{$flds['
liflds
']}' , '{$flds['
issyem
']}' , '{$flds['
isshow
']}' , '{$flds['
isnd
']}' ,

264 '{$flds['
ca
']}' , '{$flds['
uy
']}' , '{$flds['
ndnk
']}' ); ";

266 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

268 if(!
	g$rs
)

270 
GoSMsg
("导入模型时发生错误！".
$dsql
->
GE
());

273 
	g$d
 = 
w
 
DedeTagP
();

274 
	g$d
->
SNameS
("field","<",">");

275 
	g$d
->
LdSour
(
$fldt
);

276 
	g$lflds
 = '';

277 if(
is_y
(
$d
->
CTags
))

279 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

282 
	g$dty
 = 
$ag
->
GA
('type');

283 
	g$fldme
 = 
$ag
->
GName
();

284 
	g$dfvue
 = 
$ag
->
GA
('default');

285 
	g$ii
 = 
$ag
->
GA
('islist');

286 
	g$mxn
 = 
$ag
->
GA
('maxlength');

287 
	g$fldfos
 = 
GFldMake
(
$dty
,
$fldme
,
$dfvue
,
$mxn
);

288 
	g$absql
 = 
$fldfos
[0];

289 
	g$buideTy
 = 
$fldfos
[1];

290 if(
	g$ii
!='')

292 
$lflds
 .($lflds=='' ? 
$fldme
 : ','.$fieldname);

294 
	g$dsql
->
ExecuNeQuy
(" ALTER TABLE `{$fields['addtable']}` ADD $ntabsql ");

298 if(
	g$lflds
!='')

300 
$dsql
->
ExecuNeQuy
("Update `#@__channeltype` setistfields='$allfields' where id='{$fields['newid']}' ");

303 
GoSMsg
("成功导入一个模型！");

309 if(
	g$do
=="copysave")

311 
$cid
 = 
tv
($cid);

312 
	g$row
 = 
$dsql
->
GO
("Se * From `#@__chy` whid='$cid' ", 
MYSQL_ASSOC
);

313 
fܗch
(
$row
 
as
 
$k
=>
$v
)

315 
$
{
ow
(
$k
)} = 
addashes
(
$v
);

317 
	g$quy
 = " INSERT INTO `#@__channeltype`(`id` , `nid` , `typename` , `addtable` , `addcon` ,

318 `
mc
` , `
	gedc
` , `
	guddc
` , `
	gurmc
` , `
	gudc
` , `
	gfldt
` , `
	gliflds
` ,

319 `
	gissyem
` , `
	gisshow
` , `
	gisnd
` , `
	gca
`,`
	guy
` , `
	gndnk
` )

320 
VALUES
('$newid' , '$newnid' , '$newtypename' , '$newaddtable' , '$addcon' ,

324 
	g$mysql_vsi
 = 
$dsql
->
GVsi
(
ue
);

325 if(!
	g$dsql
->
IsTab
(
$waddb
))

327 
	g$dsql
->
Execu
('me',"SHOW CREATE TABLE {$dsql->dbName}.{$addtable}");

328 
	g$row
 = 
$dsql
->
GAay
('me', 
MYSQL_BOTH
);

329 
	g$bSu
 = 
$row
[1];

330 
	g$tb
 = 
r_a
('#@__',
$cfg_dbefix
,
$addb
);

331 
	g$bSu
 = 
eg_a
("/CREATE TABLE `$addb`/iU","CREATE TABLE `$waddb`",
$bSu
);

332 
	g$dsql
->
ExecuNeQuy
(
$bSu
);

334 if(
	g$cym
==1)

336 
$tmd
 = 
$cfg_bad
.
$cfg_ms_d
.'/'.
$cfg_df_y
;

337 
cy
("{$tmpletdir}/{$nid}_article.htm","{$tmpletdir}/{$newnid}_article.htm");

338 
cy
("{$tmpletdir}/list_{$nid}.htm","{$tmpletdir}/{$newnid}_list.htm");

339 
cy
("{$tmpletdir}/index_{$nid}.htm","{$tmpletdir}/{$newnid}_index.htm");

341 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

342 if(
	g$rs
)

344 
ShowMsg
("成功复制模型，现转到详细参数页... ","mychannel_edit.php?id={$newid}&dopost=edit");

345 
ex
();

349 
	g$rv
 = 
$dsql
->
GE
();

350 
ShowMsg
("系统出错，请把错误代码发送到官方论坛，以检查原因！<br /> 错误代码：mychannel_edit.php?dopost=savecopy $errv","javascript:;");

351 
ex
();

357 if(
	g$do
=="save")

360 
$fldt
 = 
eg_a
("[\r\n]{1,}","\r\n",$fieldset);

362 
	g$quy
 = "Update `#@__channeltype` set

363 
tyme
 = '$typename',

364 
	gaddb
 = '$addtable',

365 
	gaddc
 = '$addcon',

366 
	gmc
 = '$mancon',

367 
	gedc
 = '$editcon',

368 
	guddc
 = '$useraddcon',

369 
	gurmc
 = '$usermancon',

370 
	gudc
 = '$usereditcon',

371 
	gfldt
 = '$fieldset',

372 
	gliflds
 = '$listfields',

373 
	gisnd
 = '$issend',

374 
	gca
 = '$arcsta',

375 
	guy
 = '$usertype',

376 
	gndnk
 = '$sendrank',

377 
	geddes
 = '$needdes',

378 
	gedpic
 = '$needpic',

379 
	gtme
 = '$titlename',

380 
	glye
 = '$onlyone',

381 
	gdfcid
 = '$dfcid'

382 
whe
 
id
='$id' ";

383 if(
im
(
$fldt
)!='')

385 
$d
 = 
w
 
DedeTagP
();

386 
	g$d
->
SNameS
("field","<",">");

387 
	g$d
->
LdSour
(
rashes
(
$fldt
));

388 if(!
is_y
(
$d
->
CTags
))

390 
ShowMsg
("文本配置参数无效，无法进行解析！","-1");

391 
ex
();

394 
	g$ueTab
 = 
r_a
("#@__",
$cfg_dbefix
,
$addb
);

395 if(!
	g$dsql
->
IsTab
(
$ueTab
))

397 
ShowMsg
("系统找不到你所指定的表 $trueTable ，请手工创建这个表！","-1");

398 
ex
();

400 
	g$dsql
->
ExecuNeQuy
(
$quy
);

401 
ShowMsg
("成功更改一个模型！","mychannel_main.php");

402 
ex
();

407 if(
	g$do
=="gettemplets")

409 
que_
(
DEDEINC
."/oxwindow.class.php");

410 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__channeltype` where id='$id'");

411 
	g$wt
 = "频道管理-查看模板";

412 
	g$wecome_fo
 = "<a href='mychannel_main.php'>频道管理</a>::查看模板";

413 
	g$w
 = 
w
 
OxWdow
();

414 
	g$w
->
In
("","js/blank.js","");

415 
	g$w
->
AddT
("频道：（".
$row
['typename']."）默认模板文件说明：");

416 
	g$deuɋme
 = 
$cfg_ms_d
.'/'.
$cfg_df_y
;

417 
	g$msg
 = "

418 文档模板：{
$deuɋme
}/
tie_
{
$row
['nid']}.
htm


419 <
a
 
hf
='l.php?acd={$cfg_df_y}&aid&fameie_{$row['
nid
']}.htm'>[修改]</a><
br
/>

420 列表模板：{
$deuɋme
}/
li_
{
$row
['nid']}.
htm


421 <
a
 
hf
='l.php?acd={$cfg_df_y}&aid&famei_{$row['
nid
']}.htm'>[修改]</a>

422 <
br
/>

423 频道封面模板：{
$deuɋme
}/
dex_
{
$row
['nid']}.
htm


424 <
a
 
hf
='l.php?acd={$cfg_df_y}&aid&fame=dex_{$row['
nid
']}.htm'>[修改]</a>

426 
$w
->
AddMsgIm
("<div style='padding:20px;line-height:300%'>$msg</div>");

427 
	g$wfm
 = 
$w
->
GWdow
("hand","");

428 
	g$w
->
Diy
();

429 
ex
();

434 if(
	g$do
=="delete")

436 
CheckPurvw
('c_Del');

437 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__channeltype` where id='$id'");

438 if(
	g$row
['issystem'] == 1)

440 
ShowMsg
("系统模型不允许删除！","mychannel_main.php");

441 
ex
();

443 if(
emy
(
$job
))

445 
	g$job
="";

447 if(
	g$job
=="")

449 
que_
(
DEDEINC
."/oxwindow.class.php");

450 
	g$wt
 = "频道管理-删除模型";

451 
	g$wecome_fo
 = "<a href='mychannel_main.php'>频道管理</a>::删除模型";

452 
	g$w
 = 
w
 
OxWdow
();

453 
	g$w
->
In
("mychannel_edit.php","js/blank.js","POST");

454 
	g$w
->
AddHidd
("job","yes");

455 
	g$w
->
AddHidd
("do",
$do
);

456 
	g$w
->
AddHidd
("id",
$id
);

457 
	g$w
->
AddT
("你确实要删除 (".
$row
['typename'].") 这个频道？");

458 
	g$wfm
 = 
$w
->
GWdow
("ok");

459 
	g$w
->
Diy
();

460 
ex
();

462 if(
	g$job
=="yes")

464 
que_
(
DEDEINC
."/typeunit.class.admin.php");

465 
	g$myrow
 = 
$dsql
->
GO
("Seddb From `#@__chy` whid='$id'",
MYSQL_ASSOC
);

466 if(!
is_y
(
$myrow
))

468 
ShowMsg
('你所指定的频道信息不存在!','-1');

469 
ex
();

473 
	g$addb
 = 
r_a
(
$cfg_dbefix
,'',r_a('#@__',$cfg_dbefix,
$myrow
['addtable']));

474 
	g$row
 = 
$dsql
->
GO
("Select count(id)s dd From `#@__channeltype` whereddtableike '{$cfg_dbprefix}{$addtable}' Orddtableike CONCAT('#','@','__','$addtable') ; ");

475 
	g$isExusive2
 = (
$row
['dd']>1 ? 0 : 1 );

478 
	g$tids
 = '';

479 
	g$dsql
->
Execu
('qm',"Select id From `#@__arctype` where channeltype='$id'");

480 
	g$row
 = 
$dsql
->
GAay
('qm'))

482 
$tids
 .($tids=='' ? 
$row
['id'] : ','.$row['id']);

486 if(
	g$tids
!='')

488 
$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` whereypeid in($tids); ");

489 
	g$dsql
->
ExecuNeQuy
("Delete From `{$myrow['maintable']}` whereypeid in($tids); ");

490 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__spec` whereypeid in ($tids); ");

491 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__feedback` whereypeid in ($tids); ");

492 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctype` where id in ($tids); ");

496 if(
	g$isExusive2
==1)

498 
$dsql
->
ExecuNeQuy
("DROP TABLE IF EXISTS `{$cfg_dbprefix}{$addtable}`;");

502 if(
	g$tids
!='' && 
$myrow
['addtable']!='')

504 
$dsql
->
ExecuNeQuy
("Delete From `{$myrow['addtable']}` whereypeid in ($tids); ");

509 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__channeltype` where id='$id' ");

512 
UpDeCCache
(
$dsql
);

513 
ShowMsg
("成功删除一个模型！","mychannel_main.php");

514 
ex
();

521 if(
	g$do
 == 'modifysearch'){

522 if(!
ist
(
$
)) $step=0;

523 if(
emy
(
$
)){

524 
	g$
 = 1;

525 
	g$mid
 = 
tv
(
$mid
);

526 
	g$quy
 = "select mainfields,ddonfields,emplate from #@__advancedsearch where mid='$mid'";

527 
	g$chfo
 = 
$dsql
->
GO
(
$quy
);

528 if(!
is_y
(
$chfo
)){

529 
	g$chfo
['maflds'] = 
$chfo
['addonfields'] = $searchinfo['template'] = '';

531 
	g$chfo
['maflds'] = 
exode
(',', 
$chfo
['mainfields']);

532 
	g$chfo
['addflds'] = 
exode
(',', 
$chfo
['addonfields']);

533 
	g$addfld
 = 
y
();

534 
fܗch
(
$chfo
['addflds'] 
as
 
$k
){

535 
	g$kr
 = 
exode
(':', 
$k
);

536 
	g$addfld
[] = 
$kr
[0];

538 
	g$me
 = 
$chfo
['template'] == '' ? 'advancedsearch.htm' : $searchinfo['template'];

539 
	g$c1
 = 
_y
('iscommd', 
$chfo
['mainfields']) ? 'checked' : '';

540 
	g$c2
 = 
_y
('tyid', 
$chfo
['mainfields']) ? 'checked' : '';

541 
	g$c3
 = 
_y
('wr', 
$chfo
['mainfields']) ? 'checked' : '';

542 
	g$c4
 = 
_y
('sour', 
$chfo
['mainfields']) ? 'checked' : '';

543 
	g$c5
 = 
_y
('ndde', 
$chfo
['mainfields']) ? 'checked' : '';

546 
	g$maflds
 = '<b><puty="checkbox"ame="maflds[]" '.
$c1
.' value="iscommend" class="np" />是否推荐</label>';

547 
	g$maflds
 .'<b><puty="checkbox"ame="maflds[]" '.
$c2
.' value="typeid" class="np" />栏目</label>';

549 
	g$maflds
 .'<b><puty="checkbox"ame="maflds[]" '.
$c3
.' value="writer" class="np" />作者</label>';

550 
	g$maflds
 .'<b><puty="checkbox"ame="maflds[]" '.
$c4
.' value="source" class="np" />来源</label>';

551 
	g$maflds
 .'<b><puty="checkbox"ame="maflds[]" '.
$c5
.' value="senddate" class="np" />发布时间</label>';

559 
	g$quy
 = "select * from `#@__channeltype` where id='$mid'";

560 
	g$chl
 = 
$dsql
->
GO
(
$quy
);

562 
	g$chty
 = 
y
('int', 'datetime', 'float', 'textdata', 'textchar', 'text', 'htmltext', 'multitext', 'select', 'radio', 'checkbox');

563 
	g$addflds
 = '';

564 
	g$d
 = 
w
 
DedeTagP
();

565 
	g$d
->
SNameS
("field","<",">");

566 
	g$d
->
LdSour
(
$chl
['fieldset']);

567 if(
	g$chl
['issystem'] < 0)

569 
	g$checked
 = 
_y
('tyid', 
$addfld
) ? 'checked' : '';

570 
	g$addflds
 .'<b><puty="checkbox"ame="addflds[]" '.
$checked
.' value="typeid" class="np" />栏目</label>';

571 
	g$checked
 = 
_y
('ndde', 
$addfld
) ? 'checked' : '';

572 
	g$addflds
 .'<b><puty="checkbox"ame="addflds[]" '.
$checked
.' value="senddate" class="np" />发布时间</label>';

575 if(
is_y
(
$d
->
CTags
&& !
emy
($dtp->CTags)){

576 
fܗch
(
$d
->
CTags
 
as
 
$ag
){

577 
	g$dy
 = 
$ag
->
GA
('type');

578 
	g$vue
 = 
$ag
->
GName
();

579 if(
	g$chl
['issystem'] < 0)

581 
	g$_oo
 = 
y
('channel','arcrank', 'title', 'senddate', 'mid', 'click', 'flag', 'litpic', 'userip', 'lastpost', 'scores', 'goodpost', 'badpost', 'endtime');

582 if(
_y
(
$vue
, 
$_oo
))

588 
	g$b
 = 
$ag
->
GA
('itemname');

589 if(
_y
(
$dy
, 
$chty
)){

590 
	g$checked
 = 
_y
(
$vue
, 
$addfld
) ? 'checked' : '';

591 
	g$addflds
 .= "<label><inputype=\"checkbox\"ame=\"addonfields[]\" $checked value=\"$value\" class='np' />$label</label>";

595 
que_
(
dme
(
__FILE__
)."/templets/mychannel_modifysearch.htm");

596 }
if
(
$
 == 1){

597 
$quy
 = "select * from `#@__channeltype` where id='$mid'";

598 
	g$chl
 = 
$dsql
->
GO
(
$quy
);

599 if(
emy
(
$addflds
))

601 
	g$addflds
 = '';

603 
	g$me
 = 
im
(
$me
);

604 
	g$fms
 = '<fmi="'.
$cfg_cmh
.'/plus/advancedsearch.php" method="post">';

605 
	g$fms
 .= "<inputype=\"hidden\"ame=\"mid\" value=\"$mid\" />";

606 
	g$fms
 .= "<inputype=\"hidden\"ame=\"dopost\" value=\"search\" />";

607 
	g$fms
 .= "关键词：<inputype=\"text\"ame=\"q\" /><br />";

608 
	g$marg
 = '';

609 if(!
emy
(
$maflds
&& 
is_y
($mainfields)){

610 
	g$marg
 = 
imode
(',', 
$maflds
);

611 
fܗch
(
$maflds
 
as
 
$mafld
){

612 if(
	g$mafld
 == 'typeid'){

613 
que_
(
dme
(
__FILE__
)."/../include/typelink.class.php");

614 
	g$
 = 
w
 
TyLk
(0);

615 
	g$tyOis
 = 
$
->
GOiAay
(0,0,
$mid
);

616 
	g$fms
 .= "<br />栏目：<selectame='typeid' style='width:200'>\r\n";

617 
	g$fms
 .= "<option value='0' selected>--不限栏目--</option>\r\n";

618 
	g$fms
 .
$tyOis
;

619 
	g$fms
 .= "</select>";

620 
	g$fms
 .= "<label><inputype=\"checkbox\"ame=\"includesons\" value=\"1\" />包含子栏目</label><br />";

621 }
if
(
$mafld
 == 'iscommend'){

622 
$fms
 .= "<label><inputype=\"checkbox\"ame=\"iscommend\" value=\"1\" />推荐</label><br />";

623 }
if
(
$mafld
 == 'writer'){

624 
$fms
 .= "作者： <inputype=\"text\"ame=\"writer\" value=\"\" /><br />";

625 }
if
(
$mafld
 == 'source'){

626 
$fms
 .= "来源： <inputype=\"text\"ame=\"source\" value=\"\" /><br />";

627 }
if
(
$mafld
 == 'senddate'){

628 
$fms
 .= "开始时间：<inputype=\"text\"ame=\"startdate\" value=\"\" /><br />";

629 
	g$fms
 .= "结束时间：<inputype=\"text\"ame=\"enddate\" value=\"\" /><br />";

634 
	g$addڡrg
 = '';

636 
	g$
 = 
y
('int','float');

637 
	g$x
 = 
y
('textdata','textchar','text','htmltext','multitext');

639 if(
	g$chl
['issystem'] < 0)

641 
fܗch
(
$addflds
 
as
 
$addfld
)

643 if(
	g$addfld
 == 'typeid'){

644 
que_
(
dme
(
__FILE__
)."/../include/typelink.class.php");

645 
	g$
 = 
w
 
TyLk
(0);

646 
	g$tyOis
 = 
$
->
GOiAay
(0,0,
$mid
);

647 
	g$fms
 .= "<br />栏目：<selectame='typeid' style='width:200'>\r\n";

648 
	g$fms
 .= "<option value='0' selected>--不限栏目--</option>\r\n";

649 
	g$fms
 .
$tyOis
;

650 
	g$fms
 .= "</select>";

651 
	g$fms
 .= "<label><inputype=\"checkbox\"ame=\"includesons\" value=\"1\" />包含子栏目</label><br />";

652 
	g$addڡrg
 .= 'typeid:int,';

653 } 
if
(
$addfld
 == 'senddate') {

654 
$fms
 .= "开始时间：<inputype=\"text\"ame=\"startdate\" value=\"\" /><br />";

655 
	g$fms
 .= "结束时间：<inputype=\"text\"ame=\"enddate\" value=\"\" /><br />";

656 
	g$addڡrg
 .= 'senddate:datetime,';

661 if(
is_y
(
$addflds
&& !
emy
($addonfields)){

663 
	g$quy
 = "select * from #@__channeltype where id='$mid'";

664 
	g$chl
 = 
$dsql
->
GO
(
$quy
);

666 
	g$d
 = 
w
 
DedeTagP
();

667 
	g$d
->
SNameS
("field","<",">");

668 
	g$d
->
LdSour
(
$chl
['fieldset']);

669 
	g$fldr
 = 
$emr
 = 
$tyr
 = 
y
();

670 
fܗch
(
$d
->
CTags
 
as
 
$ag
){

671 
fܗch
(
$addflds
 
as
 
$addfld
){

673 if(
	g$ag
->
GName
(=
$addfld
){

674 if(
$addfld
 == 'typeid' || $addonfield == 'senddate')

678 
	g$fldr
[] = 
$addfld
;

679 
	g$emr
[] = 
$ag
->
GA
('itemname');

680 
	g$tyr
[] = 
$ag
->
GA
('type');

681 
	g$vu
[] = 
$ag
->
GA
('default');

686 
fܗch
(
$fldr
 
as
 
$k
=>
$fld
){

687 
$emme
 = 
$emr
[
$k
];

688 
	g$me
 = 
$fld
;

689 
	g$ty
 = 
$tyr
[
$k
];

690 
	g$tmp
 = 
$me
.':'.
$ty
;

691 if(
_y
(
$ty
, 
$
)){

692 
	g$fms
 ."<b/>$emm: <puty=\"xt\"ame=\"t".
$me
."\" value=\"\" /> 到 <inputype=\"text\"ame=\"end".$name."\" value=\"\" /><br />";

693 }
if
(
_y
(
$ty
, 
$x
)){

694 
	g$fms
 .= "$itemname : <inputype=\"text\"ame=\"$name\" value=\"\" /><br />";

696 }
if
(
$ty
 == 'select'){

697 
$vues
 = 
exode
(',', 
$vu
[
$k
]);

698 if(
is_y
(
$vues
&& !
emy
($values)){

699 
	g$fms
 .= "<br />$itemname : <selectame=\"$name\" ><option value=\"\">不限</option>";

700 
fܗch
(
$vues
 
as
 
$vue
){

701 
	g$fms
 .= "<option value=\"$value\">$value</option>";

703 
	g$fms
 .= "</select>";

705 }
if
(
$ty
 == 'radio'){

706 
$vues
 = 
exode
(',', 
$vu
[
$k
]);

707 if(
is_y
(
$vues
&& !
emy
($values)){

708 
	g$fms
 ."<b/>$emm: <b><puty=\"dio\"ame=\"".
$me
."\" value=\"\" checked />不限</label>";

709 
fܗch
(
$vues
 
as
 
$vue
){

710 
	g$fms
 ."<b><puty=\"dio\"ame=\"".
$me
."\" value=\"$value\" />$value</label>";

713 }
if
(
$ty
 == 'checkbox'){

714 
$vues
 = 
exode
(',', 
$vu
[
$k
]);

715 if(
is_y
(
$vues
&& !
emy
($values)){

716 
	g$fms
 .= "<br />$itemname : ";

717 
fܗch
(
$vues
 
as
 
$vue
){

718 
	g$fms
 ."<b><puty=\"checkbox\"ame=\"".
$me
."[]\" value=\"$value\" />$value</label>";

722 }
if
(
$ty
 == 'datetime'){

723 
$fms
 .= "<br />开始时间：<inputype=\"text\"ame=\"startdate\" value=\"\" /><br />";

724 
	g$fms
 .= "结束时间：<inputype=\"text\"ame=\"enddate\" value=\"\" /><br />";

726 
	g$tmp
 = '';

728 
	g$addڡrg
 .
$tmp
.',';

733 
	g$fms
 .= '<inputype="submit"ame="submit" value="开始搜索" /></form>';

734 
	g$fmssql
 = 
addashes
(
$fms
);

735 
	g$quy
 = "replace into #@__advancedsearch(mid, maintable, mainfields,ddontable,ddonfields, forms,emplate) values('$mid','$maintable','$mainstring','$addontable','$addonstring','$formssql', '$template')";

736 
	g$dsql
->
SQuy
(
$quy
);

737 
	g$dsql
->
execunequy
();

738 
	g$fmshtml
 = 
htmleclchs
(
$fms
);

739 
	gecho
 '<meta http-equiv="Content-Type" content="text/html; charset=gb2312">';

740 
	gecho
 "下面为生成的html表单，请自行复制，根据自己需求修改样式后粘贴到对应的模板中<br><br><xcs=\"100\"ows=\"10\">".
	g$fms
."</textarea>";

741 
	gecho
 '<br />预览：<br /><hr>';

742 
echo
 
	g$fms
;

746 
	gex
;

749 if(
	g$do
 == 'del')

751 
$mid
 = 
tv
($mid);

752 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__advancedsearch` where mid = '$mid'; ");

753 
ShowMsg
("成功删除一个自定义搜索！","mychannel_main.php");

754 
ex
();

756 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__channeltype` where id='$id' ");

757 
que_
(
DEDEADMIN
."/templets/mychannel_edit.htm");

	@dede/mychannel_field_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_New');

4 
que_
(
DEDEADMIN
."/inc/inc_admin_channel.php");

5 
que_
(
DEDEINC
."/dedetag.class.php");

7 if(
	$emy
(
$ai
)) {

8 
$ai
 = '';

9 
	}
}

11 
	g$mysql_vsi
 = 
$dsql
->
GVsi
();

16 if(
	g$ai
=='save')

19 
$dfvue
 = 
im
(
$vdeu
);

20 
	g$iu
 = (
$iu
==1 ? "true" : "false");

21 
	g$mxn
 = 
$maxngth
;

23 if(
eg
('^(|dio|checkbox)$',
$dty
))

25 if(!
eg
(',',
$dfvue
))

27 
ShowMsg
("你设定了字段为 {$dtype} 类型，必须在默认值中指定元素列表，如：'a,b,c' ","-1");

28 
ex
();

32 if(
	g$dty
=='stepselect')

34 
$r
 = 
$dsql
->
GO
("Select * From `#@__stepselect` wheregroup='$fieldname' ");

35 if(!
is_y
(
$r
))

37 
ShowMsg
("你设定了字段为联动类型，但系统中没找到与你定义的字段名相同的联动组名!","-1");

38 
ex
();

43 
	g$row
 = 
$dsql
->
GO
("Select fieldset,addtable,issystem From `#@__channeltype` where id='$id'");

44 
	g$fldt
 = 
$row
['fieldset'];

45 
	g$d
 = 
w
 
DedeTagP
();

46 
	g$d
->
SNameS
("field","<",">");

47 
	g$d
->
LdSour
(
$fldt
);

48 
	g$ueTab
 = 
$row
['addtable'];

51 
	g$fldfos
 = 
GFldMake
(
$dty
,
$fldme
,
$dfvue
,
$mxn
);

52 
	g$absql
 = 
$fldfos
[0];

53 
	g$buideTy
 = 
$fldfos
[1];

54 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(" ALTER TABLE `$trueTable` ADD $ntabsql ");

55 if(!
	g$rs
)

57 
	g$gr
 = 
$dsql
->
GE
();

58 
ShowMsg
("增加字段失败，错误提示为：".
$gr
,"javascript:;");

59 
ex
();

63 
	g$ok
 = 
l
;

64 
	g$fldme
 = 
ow
(
$fldme
);

65 if(
is_y
(
$d
->
CTags
))

67 
fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

69 if(
$fldme
 =
ow
(
$ag
->
GName
()))

71 
$d
->
Assign
(
$gid
,
rashes
(
$fldrg
),
l
);

72 
	g$ok
 = 
ue
;

76 
	g$okg
 = 
$ok
 ? 
$d
->
GResuNP
(: 
$fldt
."\n".
rashes
(
$fldrg
);

80 
	g$okg
 = 
$fldt
."\r\n".
rashes
(
$fldrg
);

83 
	g$addli
 = 
GAddFldLi
(
$d
,
$okg
);

84 
	g$okg
 = 
addashes
(
$okg
);

85 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("Update `#@__channeltype` set fieldset='$oksetting',listfields='$addlist' where id='$id' ");

86 if(!
	g$rs
)

88 
	g$g
 = 
$dsql
->
GE
();

89 
ShowMsg
("保存节点配置出错！".
$g
,"javascript:;");

90 
ex
();

93 
ShowMsg
("成功增加一个字段！","mychannel_edit.php?id={$id}&dopost=edit&openfield=1");

94 
ex
();

102 
	g$row
 = 
$dsql
->
GO
("Select '#@__archives's maintable,addtable From `#@__channeltype` where id='$id'");

104 
	g$ueTab
 = 
$row
['addtable'];

106 
	g$bsql
 = "CREATE TABLE IF NOT EXISTS `$trueTable`( `aid` int(11) NOT NULL default '0',\r\n `typeid` int(11) NOT NULL default '0',\r\n ";

108 if(
	g$mysql_vsi
 < 4.1)

110 
	g$bsql
 ." PRIMARY KEY (`aid`), KEY `".
$ueTab
."_index` (`typeid`)\r\n) TYPE=MyISAM; ";

114 
	g$bsql
 ." PRIMARY KEY (`aid`), KEY `".
$ueTab
."_dex` (`tyid`)\r\nENGINE=MyISAM DEFAULT CHARSET=".
$cfg_db_nguage
."; ";

117 
	g$dsql
->
ExecuNeQuy
(
$bsql
);

120 
	g$flds
 = 
y
();

122 if(
emy
(
$row
['maintable']))

124 
	g$row
['maintable'] = '#@__archives';

127 
	g$rs
 = 
$dsql
->
SQuy
("show fields from `{$row['maintable']}`");

128 
	g$dsql
->
Execu
('a');

129 
	g$ow
 = 
$dsql
->
GAay
('a',
MYSQL_ASSOC
))

131 
	g$flds
[
ow
(
$ow
['Field'])] = 1;

134 
	g$dsql
->
Execu
("a","show fields from `{$row['addtable']}`");

136 
	g$ow
 = 
$dsql
->
GAay
('a',
MYSQL_ASSOC
))

138 if(!
ist
(
$flds
[
ow
(
$ow
['Field'])]))

140 
	g$flds
[
ow
(
$ow
['Field'])] = 1;

144 
	g$f
 = '';

146 
fܗch
(
$flds
 
as
 
$k
=>
$v
)

148 
$f
 .($f=='' ? 
$k
 : ' '.$k);

151 
que_
(
DEDEADMIN
."/templets/mychannel_field_add.htm");

	@dede/mychannel_field_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_New');

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 
que_
(
dme
(
__FILE__
)."/inc/inc_admin_channel.php");

7 if(
	$emy
(
$ai
)) {

8 
$ai
 = '';

9 
	}
}

11 
	g$id
 = 
ist
(
$id
&& 
is_numic
($id) ? $id : 0;

13 
	g$mysql_vsi
 = 
$dsql
->
GVsi
();

16 
	g$row
 = 
$dsql
->
GO
("Select fieldset,''s maintable,addtable,issystem From `#@__channeltype` where id='$id'");

17 
	g$fldt
 = 
$row
['fieldset'];

18 
	g$ueTab
 = 
$row
['addtable'];

20 
	g$d
 = 
w
 
DedeTagP
();

21 
	g$d
->
SNameS
("field","<",">");

22 
	g$d
->
LdSour
(
$fldt
);

23 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

25 if(
ow
(
$ag
->
GName
())==ow(
$ame
))

32 
	g$ds
 = 
fe
(
dme
(
__FILE__
)."/inc/fieldtype.txt");

33 
	$fܗch
(
$ds
 
as
 
$d
)

35 
$dds
 = 
	`exode
(',',
	`im
(
$d
));

36 
$fldtys
[
$dds
[0]] = $dds[1];

37 
	}
}

43 if(
	g$ai
=='save')

45 if(!
ist
(
$fldtys
[
$dty
]))

47 
ShowMsg
("你修改的是系统专用类型的数据，禁止操作！","-1");

48 
ex
();

51 
	g$dfvue
 = 
$vdeu
;

53 if(
eg
('^(|dio|checkbox)',
$dty
))

55 if(!
eg
(',',
$dfvue
))

57 
ShowMsg
("你设定了字段为 {$dtype} 类型，必须在默认值中指定元素列表，如：'a,b,c' ","-1");

58 
ex
();

62 if(
	g$dty
=='stepselect')

64 
$r
 = 
$dsql
->
GO
("Select * From `#@__stepselect` wheregroup='$fieldname' ");

65 if(!
is_y
(
$r
))

67 
ShowMsg
("你设定了字段为联动类型，但系统中没找到与你定义的字段名相同的联动组名!","-1");

68 
ex
();

73 
	g$bsql
 = "CREATE TABLE IF NOT EXISTS `{$row['addtable']}`( `aid` int(11) NOT NULL default '0',\r\n `typeid` int(11) NOT NULL default '0',\r\n ";

74 if(
	g$mysql_vsi
 < 4.1)

76 
	g$bsql
 ." PRIMARY KEY (`aid`), KEY `".
$ueTab
."_index` (`typeid`)\r\n) TYPE=MyISAM; ";

80 
	g$bsql
 ." PRIMARY KEY (`aid`), KEY `".
$ueTab
."_dex` (`tyid`)\r\nENGINE=MyISAM DEFAULT CHARSET=".
$cfg_db_nguage
."; ";

82 
	g$dsql
->
ExecuNeQuy
(
$bsql
);

85 
	g$flds
 = 
y
();

86 
	g$rs
 = 
$dsql
->
SQuy
("show fields from `{$row['addtable']}`");

87 
	g$dsql
->
Execu
('a');

88 
	g$ow
 = 
$dsql
->
GAay
('a',
MYSQL_ASSOC
))

90 
	g$flds
[ 
ow
(
$ow
['Field']) ] = $nrow['Type'];

94 
	g$iu
 = (
$iu
==1 ? "true" : "false");

95 
	g$mxn
 = 
$maxngth
;

96 
	g$fldme
 = 
ow
(
$ame
);

99 
	g$fldfos
 = 
GFldMake
(
$dty
,
$fldme
,
$dfvue
,
$mxn
);

100 
	g$absql
 = 
$fldfos
[0];

101 
	g$buideTy
 = 
$fldfos
[1];

102 
	g$bsql
 = '';

105 
fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

107 if(
$fldme
==
ow
(
$ag
->
GName
()))

109 if(
ist
(
$flds
[
$fldme
]&& $flds[$fldme]!=
$buideTy
)

111 
$bsql
 = "ALTER TABLE `$ueTab` CHANGE `$fldme` ".
$absql
;

112 
	g$dsql
->
ExecuNeQuy
(
$bsql
);

113 }if(!
ist
(
$flds
[
$fldme
]))

115 
	g$bsql
 = "ALTER TABLE `$ueTab` ADD ".
$absql
;

116 
	g$dsql
->
ExecuNeQuy
(
$bsql
);

119 
	g$bsql
 = '';

121 
	g$d
->
Assign
(
$gid
,
rashes
(
$fldrg
),
l
);

125 
	g$okg
 = 
$d
->
GResuNP
();

127 
	g$addli
 = 
GAddFldLi
(
$d
,
$okg
);

128 
	g$okg
 = 
addashes
(
$okg
);

129 
	g$dsql
->
ExecuNeQuy
("Update `#@__channeltype` set fieldset='$oksetting',listfields='$addlist' where id='$id' ");

131 
ShowMsg
("成功更改一个字段的配置！","mychannel_edit.php?id={$id}&dopost=edit&openfield=1");

133 
ex
();

139 if(
	g$ai
=="delete")

141 if(
$row
['issystem']==1)

143 
ShowMsg
("对不起，系统模型的字段不允许删除！","-1");

144 
ex
();

148 
fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

150 if(
ow
(
$ag
->
GName
())==ow(
$ame
))

152 
$d
->
Assign
(
$gid
,"#@Delete@#");

155 
	g$okg
 = 
addashes
(
$d
->
GResuNP
());

157 
	g$dsql
->
ExecuNeQuy
("Update `#@__channeltype` set fieldset='$oksetting' where id='$id' ");

159 
	g$dsql
->
ExecuNeQuy
("ALTER TABLE `$trueTable` DROP `$fname` ");

161 
ShowMsg
("成功删除一个字段！","mychannel_edit.php?id={$id}&dopost=edit&openfield=1");

162 
ex
();

165 
que_
(
DEDEADMIN
."/templets/mychannel_field_edit.htm");

	@dede/mychannel_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_List');

4 
que_
(
DEDEINC
.'/datalistcp.class.php');

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 
	g$sql
 = "Select id,nid,typename,addtable,isshow,issystem From `#@__channeltype` order by id desc";

7 
	g$dli
 = 
w
 
DaLiCP
();

8 
	g$dli
->
STem
(
DEDEADMIN
."/templets/mychannel_main.htm");

9 
	g$dli
->
SSour
(
$sql
);

10 
	g$dli
->
diy
();

12 
funi
 
	$GS
(
$a
,
$id
)

14 if(
$a
==1)

16  (
$id
!=-1 ? "启用 &gt; <a href='mychannel_edit.php?dopost=hide&id=$id'><u>禁用</u></a>" : "固定项目");

22 
	}
}

24 
funi
 
	$IsSyem
(
$s
)

26  
$s
==1 ? "系统" : "自动";

27 
	}
}

	@dede/mytag_add.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('temp_Other');

4 
que_
(
DEDEINC
."/typelink.class.php");

5 if(
	$emy
(
$do
))

7 
$do
 = "";

8 
	}
}

9 if(
	g$do
=="save")

11 
$gme
 = 
im
($tagname);

12 
	g$row
 = 
$dsql
->
GO
("Selectypeid From #@__mytag whereypeid='$typeid' Andagnameike '$tagname'");

13 if(
is_y
(
$row
))

15 
ShowMsg
("在相同栏目下已经存在同名的标记！","-1");

16 
ex
();

18 
	g$ime
 = 
GMkTime
(
$ime
);

19 
	g$dtime
 = 
GMkTime
(
$dtime
);

20 
	g$Quy
 = "Insert Into #@__mytag(typeid,tagname,timeset,starttime,endtime,normbody,expbody)

21 
Vues
('$typeid','$tagname','$timeset','$starttime','$endtime','$normbody','$expbody'); ";

22 
	g$dsql
->
ExecuNeQuy
(
$Quy
);

23 
ShowMsg
("成功增加一个自定义标记！","mytag_main.php");

24 
ex
();

26 
	g$tDay
 = 
time
();

27 
	g$dDay
 = 
AddDay
(
$tDay
,30);

28 
	g$tDay
 = 
GDeTimeMk
(
$tDay
);

29 
	g$dDay
 = 
GDeTimeMk
(
$dDay
);

30 
ude
 
DedeInude
('templets/mytag_add.htm');

	@dede/mytag_edit.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('temp_Other');

4 
que_
(
DEDEINC
."/typelink.class.php");

6 if(
emy
(
$do
)
	g$do
 = '';

7 
	g$aid
 = 
tv
(
$aid
);

8 
	g$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? 'mytag_main.php' : $_COOKIE['ENV_GOBACK_URL'];

10 if(
	g$do
=='delete')

12 
$dsql
->
ExecuNeQuy
("Delete From #@__mytag whereid='$aid'");

13 
ShowMsg
("ɹɾһԶǣ",
$ENV_GOBACK_URL
);

14 
ex
();

16 if(
	g$do
=="saveedit")

18 
$ime
 = 
GMkTime
($starttime);

19 
	g$dtime
 = 
GMkTime
(
$dtime
);

20 
	g$quy
 = "Update `#@__mytag`

21 
t


22 
tyid
='$typeid',

23 
	gtimet
='$timeset',

24 
	gime
='$starttime',

25 
	gdtime
='$endtime',

26 
	gnmbody
='$normbody',

27 
	gexpbody
='$expbody'

28 
whe
 
aid
='$aid' ";

29 
$dsql
->
ExecuNeQuy
(
$quy
);

30 
ShowMsg
("ɹһԶǣ",
$ENV_GOBACK_URL
);

31 
ex
();

33 if(
	g$do
=="getjs")

35 
que_
(
DEDEINC
."/oxwindow.class.php");

36 
	g$jscode
 = "<script src='{$cfg_phpurl}/mytag_js.php?aid=$aid'anguage='javascript'></script>";

37 
	g$showhtml
 = "<xmp style='color:#333333;background-color:#ffffff'>\r\n\r\n$jscode\r\n\r\n</xmp>";

38 
	g$showhtml
 .= "<b>Ԥ</b><iframeame='testfrm' frameborder='0' src='mytag_edit.php?aid={$aid}&dopost=testjs' id='testfrm' width='100%' height='250'></iframe>";

39 
	g$wt
 = "Ƕ-ȡJS";

40 
	g$wecome_fo
 = "<a href='mytag_main.php'><u>Ƕ</u></a>::ȡJS";

41 
	g$w
 = 
w
 
OxWdow
();

42 
	g$w
->
In
();

43 
	g$w
->
AddT
('ΪѡǵJSô룺');

44 
	g$wfm
 = 
$w
->
GWdow
('hd', 
$showhtml
);

45 
	g$w
->
Diy
();

46 
ex
();

48 if(
	g$do
=="testjs")

50 
echo
 "<body bgcolor='#ffffff'>";

51 
	gecho
 "<script src='{$cfg_phpurl}/mytag_js.php?aid=$aid&nocache=1'anguage='javascript'></script>";

52 
ex
();

54 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__mytag` whereid='$aid'");

55 
ude
 
DedeInude
('templets/mytag_edit.htm');

	@dede/mytag_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('temp_Other');

4 
que_
(
DEDEINC
.'/datalistcp.class.php');

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,'/');

7 
	g$sql
 = "Select myt.aid,myt.tagname,tp.typename,myt.timeset,myt.endtime

8 
From
 `#@
__myg
` 
myt
 

 
jo
 `#@
__y
` 

 

p.
id
=myt.
tyid
 
d
 
by
 myt.
aid
 
desc
 ";

9 
$dli
 = 
w
 
DaLiCP
();

10 
	g$dli
->
STem
(
DEDEADMIN
.'/templets/mytag_main.htm');

11 
	g$dli
->
SSour
(
$sql
);

12 
	g$dli
->
diy
();

14 
funi
 
	$TeTy
(
$ame
)

16  
$ame
=='' ? '所有栏目' : $tname;

17 
	}
}

19 
funi
 
	$TimeSVue
(
$ts
)

21  
$ts
==0 ? '不限时间' : '限时标记';

22 
	}
}

	@dede/mytag_tag_guide.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/typelink.class.php");

4 
ude
 
DedeInude
('templets/mytag_tag_guide.htm');

	@dede/mytag_tag_guide_ok.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('temp_Other');

6 
	g$i
 = "";

7 
	g$i
 ."ow='".
$row
."'";

8 
	g$i
 ."n='".
$tn
."'";

9 if(
	g$dby
!='senddate')

11 
$i
 ." ordby='".
$dby
."'";

13 if(
	g$d
!='desc')

15 
$i
 ." ord='".
$d
."'";

17 if(
	g$tyid
>0)

19 
	g$i
 ."yid='".
$tyid
."'";

21 if(
	$ist
(
$cid
))

23 
$i
 ." idli='".
$cid
."'";

24 
	}
}

25 if(
	g$chl
>0)

27 
	g$i
 ." chlid='".
$chl
."'";

29 if(
	g$t
>0)

31 
	g$i
 ."='".
$t
."'";

33 if(
	g$c
>1)

35 
	g$i
 ." c='".
$c
."'";

37 if(
	g$subday
>0)

39 
	g$i
 ." subday='".
$subday
."'";

41 if(!
	$emy
(
$tys
))

43 
$i
 .= "ype='";

44 
	`fܗch
(
$tys
 
as
 
$v
)

46 
$i
 .
$v
.'.';

48 
$i
 .= "'";

49 
	}
}

50 
	g$ùext
 = 
rashes
(
$ùext
);

51 if(
	g$keywd
!="")

53 
$i
 .= " keyword='$keyword'";

55 
	g$fuΏg
 = "{dede:arclist$attlist}

56 
$ùext


57 {/
dede
:
i
}\
r
\
n
";

58 if(
$do
=='savetag')

60 
$fuΏg
 = 
addashes
($fulltag);

61 
	g$gme
 = "auto";

62 
	g$Quy
 = "

63 
In
 
Io
 #@
__myg
(
tyid
,
gme
,
timet
,
ime
,
dtime
,
nmbody
,
expbody
)

64 
Vues
('0','$tagname','0','0','0','$fulltag','');

66 
	g$dsql
->
ExecuNeQuy
(
$Quy
);

67 
	g$id
 = 
$dsql
->
GLaID
();

68 
	g$dsql
->
ExecuNeQuy
("Update #@__mytag setagname='{$tagname}_{$id}' whereid='$id'");

69 
	g$fuΏg
 = "{dede:mytagame='{$tagname}_{$id}' ismake='yes'/}";

71 
ude
 
DedeInude
('templets/mytag_tag_guide_ok.htm');

	@dede/pic_view.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('pic_view');

4 if(
	$emy
(
$aivh
))

6 
$aivh
=
$cfg_meds_d
;

7 
	}
}

8 
	g$aivh
 = 
eg_a
("/{1,}","/",
$aivh
);

9 
	g$uePh
 = 
$cfg_bad
.
$aivh
;

10 
	g$liSize
=5;

11 
ude
 
DedeInude
('templets/pic_view.htm');

13 
funi
 
	$GPPh
(
$nowPh
)

15 if(
$nowPh
==""||$nowPath=="/")

17 
	`echo
("当前为根目录\n");

21 
$ds
 = 
	`l
("/",
$nowPh
);

22 
$nowPh
 = "";

23 
$i
=1;$i<
	`cou
(
$ds
)-1;$i++)

25 
$nowPh
 ."/".
$ds
[
$i
];

27 
	`echo
("<hf=\"pic_vw.php?aivh=".
$nowPh
."\">转到上级目录</a>\n");

29 
	}
}

31 
funi
 
	$LiPic
(
$uePh
,
$nowPh
)

33 
glob
 
$liSize
;

34 
$c
=0;

35 
$rowdd
=0;

36 
$rowdd
++;

37 
$imgfe
="";

38 
$uePh
 = 
	`eg_a
("/$","",eg_a("\\{1,}","/",
	`im
($truePath)));

39 
$nowPh
 = 
	`eg_a
("/$","",eg_a("/{1,}","/",
	`im
($nowPath)));

40 
$dh
 = 
	`d
(
$uePh
);

41 
	`echo
("<trlign='center'>\n");

42 
$fame
=
$dh
->
	`ad
())

44 if(!
	`eg
("\.$",
$fame
))

46 
$fuName
 = 
$uePh
."/".
$fame
;

47 
$feU
 = 
$nowPh
."/".
$fame
;

48 if(
	`is_d
(
$fuName
))

50 if(
$c
%
$liSize
==0&&$col!=0)

52 
	`echo
("</tr>\n<trlign='center'>\n");

53 
$i
=
$rowdd
-
$liSize
;$i<$rowdd;$i++)

55 
	`echo
("<td>".
$fi
[
$i
]."</td>\n");

57 
	`echo
("</tr>\n<trlign='center'>\n");

59 
$le
 = "

60 <
td
>

61 <
b
 
width
='106' 
height
='106' 
bd
='0' 
ηddg
='0' 
Υacg
='1' 
bgc
='#CCCCCC'>

62 <

><
td
 
ign
='' 
bgc
='#FFFFFF'>

63 <
a
 
hf
='pic_view.php?activepath=".$fileUrl."'>

64 <
img
 
c
='img/pic_d.gif' 
width
='44' 
height
='42' 
bd
='0'>

65 </
a
></
td
></

></
b
></td>";

66 
$fi
[
$rowdd
] = 
$fame
;

67 
$c
++;

68 
$rowdd
++;

69 
echo
 
$le
;

71 if(
	`IsImg
(
$fame
))

73 if(
$c
%
$liSize
==0&&$col!=0)

75 
	`echo
("</tr>\n<trlign='center'>\n");

76 
$i
=
$rowdd
-
$liSize
;$i<$rowdd;$i++)

78 
	`echo
("<td>".
$fi
[
$i
]."</td>\n");

80 
	`echo
("</tr>\n<trlign='center'>\n");

82 
$le
 = "

83 <
td
>

84 <
b
 
width
='106' 
height
='106' 
bd
='0' 
ηddg
='0' 
Υacg
='1' 
bgc
='#CCCCCC'>

85 <

>

86 <
td
 
ign
='' 
bgc
='#FFFFFF'>

88 </
td
>

89 </

></
b
></
td
>";

90 
$fi
[
$rowdd
] = 
$fame
;

91 
$c
++;

92 
$rowdd
++;

93 
echo
 
$le
;

97 
	`echo
("</tr>\n");

98 if(!
	`emy
(
$fi
))

100 
	`echo
("<trlign='center'>\n");

101 
$t
 = (
$rowdd
-1)%
$liSize
;

102 if(
$t
==0)

104 
$t
=
$liSize
;

106 
$i
=
$rowdd
-
$t
;$i<$rowdd;$i++)

108 
	`echo
("<td>".
$fi
[
$i
]."</td>\n");

110 
	`echo
("</tr>\n");

112 
	}
}

114 
funi
 
	$GImgFe
(
$uePh
,
$nowPh
,
$feName
)

116 
$toW
=102;

117 
$toH
=102;

118 
$cFe
 = 
$uePh
."/".
$feName
;

119 
$fo
 = "";

120 
$da
 = 
	`GImageSize
(
$cFe
,
$fo
);

121 
$cW
=
$da
[0];

122 
$cH
=
$da
[1];

123 if(
$toW
>=
$cW
&&
$toH
>=
$cH
)

125 
$oW
=
$cW
;

126 
$oH
=
$cH
;

130 
$toWH
=
$toW
/
$toH
;

131 
$cWH
=
$cW
/
$cH
;

132 if(
$toWH
<=
$cWH
)

134 
$oW
=
$toW
;

135 
$oH
=
$oW
*(
$cH
/
$cW
);

139 
$oH
=
$toH
;

140 
$oW
=
$oH
*(
$cW
/
$cH
);

143 ("<hf='".
$nowPh
."/".
$feName
."'g='_bnk'><img src='".$nowPh."/".$feName."' width='".
$oW
."' height='".
$oH
."' border='0'></a>");

144 
	}
}

146 
funi
 
	$IsImg
(
$feName
)

148 if(
	`eg
("\.(jpg|gif|g)$",
$feName
))

156 
	}
}

	@dede/plus_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_plus');

4 
	g$aid
 = 
eg_a
("[^0-9]","",
$aid
);

5 if(
	g$do
=="show")

7 
$dsql
->
ExecuNeQuy
("update #@__plus set isshow=1 whereid='$aid';");

8 
ShowMsg
("成功启用一个插件,请刷新导航菜单!","plus_main.php");

9 
ex
();

11 if(
	g$do
=="hide")

13 
$dsql
->
ExecuNeQuy
("update #@__plus set isshow=0 whereid='$aid';");

14 
ShowMsg
("成功禁用一个插件,请刷新导航菜单!","plus_main.php");

15 
ex
();

17 if(
	g$do
=="delete")

19 if(
emy
(
$job
))

21 
$job
="";

23 if(
	g$job
=="")

25 
que_
(
DEDEINC
."/oxwindow.class.php");

26 
	g$wt
 = "删除插件";

27 
	g$wecome_fo
 = "<a href='plus_main.php'>插件管理</a>::删除插件";

28 
	g$w
 = 
w
 
OxWdow
();

29 
	g$w
->
In
("plus_edit.php","js/blank.js","POST");

30 
	g$w
->
AddHidd
("job","yes");

31 
	g$w
->
AddHidd
("do",
$do
);

32 
	g$w
->
AddHidd
("aid",
$aid
);

33 
	g$w
->
AddT
("你确实要删除'".
$t
."'这个插件？");

34 
	g$w
->
AddMsgIm
("<font color='red'>警告：在这里删除仅仅删除菜单项，要干净删除请在模块管理处删除！<br /><br /> <a href='module_main.php?moduletype=plus'>模块管理&gt;&gt;</a> </font>");

35 
	g$wfm
 = 
$w
->
GWdow
("ok");

36 
	g$w
->
Diy
();

37 
ex
();

39 if(
	g$job
=="yes")

41 
$dsql
->
ExecuNeQuy
("Delete From #@__plus whereid='$aid';");

42 
ShowMsg
("成功删除一个插件,请刷新导航菜单!","plus_main.php");

43 
ex
();

46 if(
	g$do
=="saveedit")

48 
$quy
 = "Update #@__plus setlusname='$plusname',menustring='$menustring',filelist='$filelist' whereid='$aid';";

49 
	g$dsql
->
ExecuNeQuy
(
$quy
);

50 
ShowMsg
("成功更改插件的配置!","plus_main.php");

51 
ex
();

53 
	g$row
 = 
$dsql
->
GO
("Select * From #@__plus whereid='$aid'");

54 
ude
 
DedeInude
('templets/plus_edit.htm');

	@dede/plus_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_plus');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 
	g$sql
 = "Selectid,plusname,writer,isshow From #@__plus order byidsc";

7 
	g$dli
 = 
w
 
DaLiCP
();

8 
	g$dli
->
STem
(
DEDEADMIN
."/templets/plus_main.htm");

9 
	g$dli
->
SSour
(
$sql
);

10 
	g$dli
->
diy
();

12 
funi
 
	$GS
(
$a
,
$id
,
$t
)

14 if(
$a
==1)

16  " &nb; <hf='us_ed.php?dod&aid=$id'><u>修改</u></a> &nb; 启用 &gt; <hf='us_ed.php?do=hide&aid=$id'><u>禁用</u></a> &nb; <hf='us_ed.php?do=de&aid=$id&t=".
	`ucode
(
$t
)."'><u>删除</u></a>";

20  " &nb; <hf='us_ed.php?aid=$id'><u>修改</u></a> &nb; 禁用 &gt; <hf='us_ed.php?do=show&aid=$id'><u>启用</u></a> &nb; <hf='us_ed.php?do=de&aid=$id&t=".
	`ucode
(
$t
)."'><u>册除</u></a>";

22 
	}
}

	@dede/public_guide.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/oxwindow.class.php");

4 if(
	$emy
(
$ai
))

6 
$ai
 = '';

7 
	}
}

13 if(
	g$ai
=='setdefault')

15 
CheckPurvw
('sys_Edit');

16 
	g$dsql
->
ExecuNeQuy
("Update `#@__channeltype` set isdefault=0 where id<>'$cid'");

17 if(
	g$cid
!=0)

19 
$dsql
->
ExecuNeQuy
("Update `#@__channeltype` set isdefault=1 where id='$cid'");

21 
	g$w
 = 
w
 
OxWdow
();

22 
	g$w
->
In
();

23 
	g$w
->
	gmaT
 = "内容发布向导";

24 
	g$wecome_fo
 = "<a href='public_guide.php?action=edit'>内容发布向导</a>";

25 
	g$w
->
AddT
("<a href='public_guide.php?action=edit'>内容发布向导</a> &gt;&gt; 设置默认发布表单");

26 if(
	g$cid
==0)

28 
$msg
 = "

30 <
hr
 
y
='width:90%' 
size
='1' />

31 你目前想要进行的操作： <
a
 
hf
='public_guide.php?action=edit'>返回发布向导页</a>

36 
	g$msg
 = "

38 <
hr
 
y
='width:90%' 
size
='1' />

39 你目前想要进行的操作： <
a
 
hf
='public_guide.php'>转到默认发布表单</a> &
nb
; <
	ghf
='public_guide.php?action=edit'>返回发布向导页</a>

42 
	g$w
->
AddMsgIm
("<div style='padding-left:20px;line-height:150%'>$msg</div>");

43 
	g$wfm
 = 
$w
->
GWdow
("hand");

44 
	g$w
->
Diy
();

45 
ex
();

52 
	g$row
 = 
$dsql
->
GO
("Select id,addcon From `#@__channeltype` where isdefault='1' ");

55 if(
is_y
(
$row
&& 
	g$ai
!='edit')

57 
$addc
 = 
$row
['addcon'];

58 if(
	g$addc
=='')

60 
$addc
='archives_add.php';

62 
	g$chlid
 = 
$row
['id'];

63 
	g$cid
 = 0;

64 
que_
(
DEDEADMIN
.'/'.
$addc
);

65 
ex
();

71 
	g$dsql
->
SQuy
("Select id,typename,mancon,isdefault,addtable From `#@__channeltype` where id<>-1 And isshow=1 ");

72 
	g$dsql
->
Execu
();

74 
ude
 
DedeInude
('templets/public_guide.htm');

77 
funi
 
	$GCogs
(&
$dsql
,
$cid
)

79 
$row
 = 
$dsql
->
	`GO
("Select count(*)s dd From `#@__arctype` where channeltype='$cid' ");

80  (!
	`is_y
(
$row
) ? '0' : $row['dd']);

81 
	}
}

	@dede/recycling.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('a_List,a_AccList,a_MyList');

4 
que_
(
DEDEINC
.'/datalistcp.class.php');

5 if(
	$emy
(
$cid
))

7 
$cid
 = '0';

8 
$wheSql
 = '';

9 
	}
}

10 if(
	g$cid
!=0)

12 
que_
(
DEDEINC
.'/channelunit.func.php');

13 
	g$wheSql
 = " Andrc.tyid i(".
GSIds
(
$cid
).")";

15 
	g$quy
 = "SELECTrc.*,tp.typename FROM `#@__archives` ASrc

16 
LEFT
 
JOIN
 #@
__y
 
AS
 

 
ON
 
c
.
tyid
 =p.
id


17 
WHERE
 
c
.
k
 = '-2' 
$wheSql
 
d
 
by
rc.
id
 
desc
";

18 
$dli
 = 
w
 
DaLiCP
();

19 
	g$dli
->
STem
(
DEDEADMIN
."/templets/recycling.htm");

20 
	g$dli
->
SSour
(
$quy
);

21 
	g$dli
->
diy
();

	@dede/search_keywords_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

4 if(
	$emy
(
$gesize
))

6 
$gesize
 = 30;

7 
	}
}

8 if(
	$emy
(
$go
))

10 
$go
 = 1;

11 
	}
}

12 if(
	$emy
(
$do
))

14 
$do
 = '';

15 
	}
}

16 if(
	$emy
(
$dby
))

18 
$dby
 = 'aid';

19 
	}
}

22 if(
	g$do
=='getlist')

24 
AjaxHd
();

25 
GKeywdLi
(
$dsql
,
$go
,
$gesize
,
$dby
);

26 
ex
();

30 if(
	g$do
=='update')

32 
$aid
 = 
eg_a
("[^0-9]","",$aid);

33 
	g$cou
 = 
eg_a
("[^0-9]","",
$cou
);

34 
	g$keywd
 = 
im
(
$keywd
);

35 
	g$wds
 = 
im
(
$wds
);

36 
	g$dsql
->
ExecuNeQuy
("Update `#@__search_keywords` set keyword='$keyword',spwords='$spwords',count='$count' whereid='$aid';");

37 
AjaxHd
();

38 
GKeywdLi
(
$dsql
,
$go
,
$gesize
,
$dby
);

39 
ex
();

43 if(
	g$do
=='del')

45 
$aid
 = 
eg_a
("[^0-9]","",$aid);

46 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__search_keywords` whereid='$aid';");

47 
AjaxHd
();

48 
GKeywdLi
(
$dsql
,
$go
,
$gesize
,
$dby
);

49 
ex
();

53 if(
	g$do
=='')

55 
$row
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__search_keywords` ");

56 
	g$tٮRow
 = 
$row
['dd'];

57 
ude
(
DEDEADMIN
."/templets/search_keywords_main.htm");

61 
funi
 
GKeywdLi
(
$dsql
,
$go
,
$gesize
,
$dby
='aid')

63 
glob
 
$cfg_phpu
;

64 
	g$t
 = (
$go
-1* 
$gesize
;

65 
	g$thd
 ="<table width='98%' border='0' cellpadding='1' cellspacing='1' bgcolor='#D1DDAA' style='margin-bottom:3px'>

66 <

 
ign
='' 
bgc
='#E9F4D5' 
height
='24'>

67 <
td
 
width
='6%' 
height
='23'><
a
 
hf
='#' 
ick
=\"ReloadPage('aid')\"><u>ID</u></a></td>

68 <
td
 
width
='20%'>关键字</td>

69 <
td
 
width
='35%'>分词结果</td>

70 <
td
 
width
='6%'><
a
 
hf
='#' 
ick
=\"ReloadPage('count')\"><u>频率</u></a></td>

71 <
td
 
width
='6%'><
a
 
hf
='#' 
ick
=\"ReloadPage('result')\"><u>结果</u></a></td>

72 <
td
 
width
='16%'><
a
 
hf
='#' 
ick
=\"ReloadPage('lasttime')\"><u>最后搜索时间</u></a></td>

73 <
td
>管理</td>

74 </

>\
r
\
n
";

75 
echo
 
$thd
;

76 if(
	g$dby
=='su'
$dby
 = $orderby."sc";

77 
	g$dby
 = 
$dby
." desc";

78 
	g$dsql
->
SQuy
("Select * From #@__search_keywords order by $orderbyimit $start,$pagesize ");

79 
	g$dsql
->
Execu
();

80 
	g$row
 = 
$dsql
->
GAay
())

82 
$le
 = "

83 <

 
ign
='' 
bgc
='#FFFFFF' 
MouMove
=\"javascript:this.bgColor='#FCFEDA';\" onMouseOut=\"javascript:this.bgColor='#FFFFFF';\">

84 <
td
 
height
='24'>{
$row
['aid']}</td>

85 <
td
><
put
 
me
='keywd' 
ty
='xt' 
id
='keywd{$row['
aid
']}' 
vue
='{$row['
keywd
']}' 
ass
='ininput'></td>

86 <
td
><
put
 
me
='wds' 
ty
='xt' 
id
='wds{$row['
aid
']}' 
vue
='{$row['
wds
']}' 
ass
='ininput'></td>

87 <
td
><
put
 
me
='cou' 
ty
='xt' 
id
='cou{$row['
aid
']}' 
vue
='{$row['
cou
']}' 
ass
='ininput'></td>

88 <
td
><
a
 
hf
='{$cfg_phpu}/ch.php?kwty=0&keywd=".ucode($row['
keywd
'])."&chtykeywd' 
rg
='_bnk'><
u
>{
$row
['result']}</u></a></td>

89 <
td
>".MyDe("
Y
-
m
-
d
 
H
:
i
:
s
",$row['lasttime'])."</td>

90 <
td
>

91 <
a
 
hf
='#' 
ick
='UpdeNe({$row['
aid
']})'>更新</a> |

92 <
a
 
hf
='#' 
ick
='DNe({$row['
aid
']})'>删除</a>

93 </
td
>

94 </

>";

95 
echo
 
$le
;

97 
	gecho
 "</table>\r\n";

	@dede/shops_bank.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Bank');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

7 if(!
	$ist
(
$do
))

9 
$do
 ='';

10 
	}
}

11 if(
	g$do
 == 'edit')

13 
$pid
 = 
tv
($pid);

14 
	g$row
 = 
$dsql
->
GO
("SELECTid,paytype FROM #@__shops_paytype WHEREid='$pid' LIMIT 0,1");

15 if(!
is_y
(
$row
))

17 
ShowMsg
("方式不存在!","shops_bank.php");

18 
ex
();

20 
	g$des
 = 
addashes
(
$des
);

21 
	g$dsql
->
ExecuNeQuy
("UPDATE #@__shops_paytype SET des='$des' WHEREid='$pid'");

22 
ShowMsg
("成功修改!","shops_bank.php");

23 
ex
();

25 
	g$fos
 = 
y
();

26 
	g$dsql
->
SQuy
("SELECTid,des FROM #@__shops_paytype ORDER BYid ASC");

27 
	g$dsql
->
Execu
();

28 
	g$row
 = 
$dsql
->
	$GAay
())

30 if(
$row
['pid'] > 2 && $row['pid'] < 5)

32 
$fos
[] = 
$row
['des'];

38 
	}
}

39 
ude
(
DEDEADMIN
."/templets/shops_bank.htm");

	@dede/shops_delivery.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('shops_Delivery');

4 
que_
 
	gDEDEINC
.'/datalistcp.class.php';

7 if(!
	$ist
(
$do
))

9 
$do
 ='';

10 
	}
}

11 if(
	g$do
=='add')

13 if
emy
(
$dme
|| (

($dname) > 100) )

15 
ShowMsg
("请填写配送方式名称!","-1");

16 
ex
();

18 
	g$i
 = 
eg_a
("[^.0-9]","",
$i
);

19 if(
	g$i
 < 0.01)

21 
	g$i
 = '0.00';

23 
	g$des
 = 
_subrR
(
$des
,255);

24 
	g$InQuy
 = "INSERT INTO #@__shops_delivery(`dname`,`price`,`des`) VALUES ('$dname','$price','$des');";

25 
	g$su
 = 
$dsql
->
ExecuNeQuy
(
$InQuy
);

26 if(
	g$su
)

28 
ShowMsg
("成功添加一个配送方式!","shops_delivery.php");

32 
ShowMsg
("添加配送方式时发生SQL错误!","-1");

34 
ex
();

35 }
if
(
$do
 == 'del')

37 
$id
 = 
tv
($id);

38 
	g$dsql
->
ExecuNeQuy
("DELETE FROM #@__shops_delivery WHEREid='$id'");

39 
ShowMsg
("已删除当前配送方式!","shops_delivery.php");

40 
ex
();

41 }
if
(
$do
 == 'edit')

43 
fܗch
(
$pid
 
as
 
$id
)

45 
$id
 = 
tv
($id);

46 
	g$row
 = 
$dsql
->
GO
("SELECTid,dname,price,des FROM #@__shops_delivery WHEREid='$id' LIMIT 0,1");

47 if(!
is_y
(
$row
))

51 
	g$dme
 = 
$
{"m_dme".
$id
};

52 
	g$i
 = 
$
{"m_i".
$id
};

53 
	g$des
 = 
$
{"m_des".
$id
};

54 if
emy
(
$dme
|| (

($dname) > 100) )

56 
	g$dme
 = 
addashes
(
$row
['dname']);

58 
	g$i
 = 
eg_a
("[^.0-9]","",
$i
);

59 if(
emy
(
$i
))

61 
	g$i
 = 
$row
['price'];

63 if(
emy
(
$des
))

65 
	g$des
 = 
addashes
(
$row
['des']);

69 
	g$des
 = 
_subrR
(
$des
,255);

71 
	g$dsql
->
ExecuNeQuy
("UPDATE #@__shops_delivery SET dname='$dname',price='$price',des='$des' WHEREid='$id'");

73 
ShowMsg
("成功修改配送方式!","shops_delivery.php");

74 
ex
();

76 
	g$divyr
 = 
y
();

77 
	g$dsql
->
SQuy
("SELECTid,dname,price,des FROM #@__shops_delivery ORDER BY orders ASC");

78 
	g$dsql
->
Execu
();

79 
	g$row
 = 
$dsql
->
	$GAay
())

81 
$divyr
[] = 
$row
;

82 
	}
}

83 
	g$dli
 = 
w
 
DaLiCP
();

84 
	g$dli
->
	ggeSize
 = 25;

87 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/shops_delivery.htm");

88 
	g$dli
->
SSour
("SELECT `pid`,`dname`,`price`,`des` FROM #@__shops_delivery ORDER BY `orders` ASC");

89 
	g$dli
->
Diy
();

	@dede/shops_operations.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('shops_Operations');

4 
que_
(
DEDEINC
.'/datalistcp.class.php');

5 if(
	$ist
(
$do
))

7 
	`CheckPurvw
('shops_Operations_cpanel');

8 if(
$do
 == 'up')

10 
$nids
 = 
	`exode
('`',
$nid
);

11 
$wh
 = '';

12 
	`fܗch
(
$nids
 
as
 
$n
)

14 if(
$wh
=='')

16 
$wh
 = " WHERE oid='$n' ";

20 
$wh
 .= " OR oid='$n' ";

23 
$dsql
->
	`SQuy
("UPDATE #@__shops_orders SET `state`='1' $wh ");

24 
$dsql
->
	`ExecuNeQuy
();

26 
	`if
(
$do
 == 'push')

28 
$nids
 = 
	`exode
('`',
$nid
);

29 
$wh
 = '';

30 
	`fܗch
(
$nids
 
as
 
$n
)

32 if(
$wh
=='')

34 
$wh
 = " WHERE oid='$n' ";

38 
$wh
 .= " OR oid='$n' ";

41 
$dsql
->
	`SQuy
("UPDATE #@__shops_orders SET `state`='2' $wh ");

42 
$dsql
->
	`ExecuNeQuy
();

44 
	`if
(
$do
 == 'ok')

46 
$nids
 = 
	`exode
('`',
$nid
);

47 
$wh
 = '';

48 
	`fܗch
(
$nids
 
as
 
$n
)

50 if(
$wh
=='')

52 
$wh
 = " WHERE oid='$n' ";

56 
$wh
 .= " OR oid='$n' ";

59 
$dsql
->
	`SQuy
("UPDATE #@__shops_orders SET `state`='4' $wh ");

60 
$dsql
->
	`ExecuNeQuy
();

64 
	`ShowMsg
("不充许的操作范围！",
$ENV_GOBACK_URL
);

65 
	`ex
();

67 
	`ShowMsg
("成功更改指定的订单记录！",
$ENV_GOBACK_URL
);

68 
	`ex
();

69 
	}
}

70 
	g$addsql
 = '';

71 if(
	$emy
(
$oid
))

73 
$oid
 = 0;

74 
	}
}

75 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

76 if(
	$ist
(
$buyid
))

78 
$buyid
 = 
	`eg_a
("[^-0-9A-Z]","",$buyid);

79 
$addsql
 = "WHERE s.oid='".
$buyid
."'";

80 
	}
}

81 if(
	$ist
(
$a
))

83 
$addsql
 = "WHERE s.`state`='$sta'";

84 
	}
}

85 
	g$sql
 = "SELECT s.`oid`,s.`cartcount`,s.`price`,s.`state`,s.`stime`,s.priceCount,s.dprice,s.paytype,u.`consignee`,u.`tel`,s.`userid` FROM #@__shops_orders AS s LEFT JOIN #@__shops_userinfo AS u ON s.oid=u.oid $addsql ORDER BY `stime` DESC";

86 
	g$dli
 = 
w
 
DaLiCP
();

87 
	g$dli
->
SPam
("oid",
$oid
);

88 if(
	$ist
(
$a
))

90 
$dli
->
	`SPam
("a",
$a
);

91 
	}
}

92 
	g$lfe
 = 
DEDEADMIN
."/templets/shops_operations.htm";

95 
	g$dli
->
STeme
(
$lfe
);

96 
	g$dli
->
SSour
(
$sql
);

97 
	g$dli
->
Diy
();

99 
funi
 
	$GS
(
$a
)

101 if(
$a
==0)

105 if(
$a
==1)

109 if(
$a
==2)

113 if(
$a
==3)

121 
	}
}

123 
funi
 
	$GsTy
(
$pid
)

125 
glob
 
$dsql
;

126 
$pid
 = 
	`tv
($pid);

127 
$row
 = 
$dsql
->
	`GO
("SELECTaytype FROM #@__shops_paytype WHEREid='$pid'");

128 if(
	`is_y
(
$row
))

130  
$row
['paytype'];

136 
	}
}

138 
funi
 
	$GMembID
(
$mid
)

140 
glob
 
$dsql
;

141 if(
$mid
==0)

145 
$row
 = 
$dsql
->
	`GO
("Select userid From #@__member where mid='$mid' ");

146 if(
	`is_y
(
$row
))

148  "<hf='memb_vw.php?id={$mid}'>".
$row
['userid']."</a>";

154 
	}
}

	@dede/shops_operations_cart.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
CheckPurvw
('shops_Operations');

5 if(!
	$ist
(
$oid
)){

6 
	`ex
("<a href='javascript:window.close()'>无效操作!</a>");

7 
	}
}

8 
	g$oid
 = 
eg_a
("[^-0-9A-Z]","",
$oid
);

9 if(
	$emy
(
$oid
)){

10 
	`ex
("<a href='javascript:window.close()'>无效订单号!</a>");

11 
	}
}

13 
	g$sql
 = "SELECT * FROM #@__shops_products WHERE oid='$oid'";

15 
	g$dli
 = 
w
 
DaLiCP
();

16 
	g$dli
->
	ggeSize
 = 20;

17 
	g$dli
->
SPam
("oid",
$oid
);

18 
	g$dli
->
STeme
(
DEDEADMIN
."/templets/shops_operations_cart.htm");

19 
	g$dli
->
SSour
(
$sql
);

20 
	g$dli
->
Diy
();

21 
	g$dli
->
Clo
();

	@dede/shops_operations_userinfo.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('shops_Operations');

4 if(!
	$ist
(
$oid
)){

5 
	`ex
("<a href='javascript:window.close()'>无效操作!</a>");

6 
	}
}

7 
	g$oid
 = 
eg_a
("[^-0-9A-Z]","",
$oid
);

8 if(
	$emy
(
$oid
)){

9 
	`ex
("<a href='javascript:window.close()'>无效订单号!</a>");

10 
	}
}

11 
	g$rows
 = 
$dsql
->
GO
("SELECT * FROM #@__shops_userinfo WHERE oid='$oid' LIMIT 0,1");

12 if(!
	$is_y
(
$rows
)){

13 
$dsql
->
	`Clo
();

14 
	`ex
("<a href='javascript:window.close()'>该订单下没相关用户信息!</a>");

15 
	}
}

17 
	g$row
 = 
$dsql
->
GO
("SELECTid,dprice FROM #@__shops_orders WHERE oid='$oid'");

18 if(
	$is_y
(
$row
)){

19 
$rs
 = 
$dsql
->
	`GO
("SELECT dname FROM #@__shops_delivery WHEREid='$row[pid]'");

20 
$rows
['dme'] = 
$rs
['dname'];

21 
$rows
['di'] = 
$row
['dprice'];

22 
	}
}

23 
	g$rows
['des'] = 
rashes
(
$rows
['des']);

24 
ude
 
	gDEDEADMIN
."/templets/shops_operations_userinfo.htm";

25 
unt
(
$rows
);

	@dede/soft_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_New,a_AccNew');

4 
que_
(
DEDEINC
.'/customfields.func.php');

5 
que_
(
DEDEADMIN
.'/inc/inc_archives_functions.php');

6 if(
emy
(
$do
)
	g$do
 = '';

8 if(
	g$do
 != 'save')

10 
que_
(
DEDEINC
.'/dedetag.class.php');

11 
que_
(
DEDEADMIN
.'/inc/inc_catalog_options.php');

12 
CˬMyAdd
();

13 
	g$chlid
 = 
emy
(
$chlid
? 0 : 
tv
($channelid);

14 
	g$cid
 = 
emy
(
$cid
? 0 : 
tv
($cid);

17 if(
	g$cid
>0 && 
	g$chlid
==0)

19 
$row
 = 
$dsql
->
GO
("Select channeltype From `#@__arctype` where id='$cid'; ");

20 
	g$chlid
 = 
$row
['channeltype'];

24 if(
	g$chlid
==0)

26 
$chlid
 = 1;

30 
	g$socfig
 = 
$dsql
->
GO
("select * From `#@__softconfig` ");

32 
	g$cInfos
 = 
$dsql
->
GO
(" Select * From `#@__channeltype` where id='$channelid' ");

33 
	g$chlid
 = 
$cInfos
['id'];

34 
ude
 
DedeInude
("templets/soft_add.htm");

35 
ex
();

40 if(
	g$do
=='save')

42 
que_
(
DEDEINC
.'/image.func.php');

43 
que_
(
DEDEINC
.'/oxwindow.class.php');

45 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

46 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

47 if(
emy
(
$ick
)
	g$ick
 = (
$cfg_c_ick
=='-1' ? 
mt_nd
(50, 200) : $cfg_arc_click);

49 if(!
ist
(
$tyid2
)
	g$tyid2
 = 0;

50 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

51 if(!
ist
(
$me
)
	g$me
 = 0;

52 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

53 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

55 if(
	g$tyid
==0)

57 
ShowMsg
("请指定文档的栏目！","-1");

58 
ex
();

60 if(
emy
(
$chlid
))

62 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

63 
ex
();

65 if(!
CheckChl
(
$tyid
,
$chlid
) )

67 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

68 
ex
();

70 if(!
TePurvw
('a_New'))

72 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的权限！");

76 if(
emy
(
$wr
))
	g$wr
=
$curLog
->
gUrName
();

77 if(
emy
(
$sour
))
	g$sour
='未知';

78 
	g$pubde
 = 
GMkTime
(
$pubde
);

79 
	g$ndde
 = 
time
();

80 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

82 if(
	g$ishtml
==0
$ismake
 = -1;

83 
	g$ismake
 = 0;

85 if(
emy
(
$ick
)
	g$ick
 = (
$cfg_c_ick
=='-1' ? 
mt_nd
(50, 200) : $cfg_arc_click);

87 
	g$t
 = 
eg_a
('"', '＂', 
$t
);

88 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

89 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

90 
	g$c
 = 
_subrR
(
$c
,7);

91 
	g$wr
 = 
_subrR
(
$wr
,20);

92 
	g$sour
 = 
_subrR
(
$sour
,30);

93 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

94 
	g$keywds
 = 
_subrR
(
$keywds
,60);

95 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

96 
	g$ur
 = 
GIP
();

97 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

99 
	g$k
 = -1;

101 
	g$admid
 = 
$curLog
->
gUrID
();

104 if(
emy
(
$ddieme
)
	g$ddieme
 = 0;

106 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

109 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$admid
);

110 if(
emy
(
$cID
))

112 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

113 
ex
();

117 
	g$body
 = 
AlyHtmlBody
(
$body
, 
$desti
, 
$lpic
, 
$keywds
, 'htmltext');

120 
	g$add_f
 = '';

121 
	g$add_v
 = '';

122 if(!
emy
(
$dede_addflds
))

124 
	g$addflds
 = 
exode
(';', 
$dede_addflds
);

125 
	g$add_f
 = '';

126 
	g$add_v
 = '';

127 if(
is_y
(
$addflds
))

129 
fܗch
(
$addflds
 
as
 
$v
)

131 if(
	g$v
=='')

135 
	g$vs
 = 
exode
(',',
$v
);

136 if(!
ist
(
$
{
$vs
[0]}))

138 
	g$
{
	g$vs
[0]} = '';

140 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

142 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

146 if(!
ist
(
$
{
$vs
[0]}))

148 
	g$
{
	g$vs
[0]} = '';

150 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$cID
);

152 
	g$add_f
 .','.
$vs
[0];

153 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

159 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

161 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

163 if(
	g$deu
!='' && !
eg
('j',
$ag
))

165 
	g$ag
 = (
$ag
=='' ? 'j' : $flag.',j');

169 if(
eg
('j', 
$ag
)
	g$ismake
 = -1;

171 
	g$Quy
 = "INSERT INTO `#@__archives`(id,typeid,typeid2,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

172 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gnpo
,
	gdesti
,
	gkeywds
,
	gfame
,
	gdutyadm
)

173 
VALUES
 ('$arcID','$typeid','$typeid2','$sortrank','$flag','$ismake','$channelid','$arcrank','$click','$money','$title','$shorttitle',

175 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

177 
	g$gr
 = 
$dsql
->
GE
();

178 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

179 
ShowMsg
("把数据保存到数据库主表 `#@__chives` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

180 
ex
();

184 
	g$us
 = '';

187 
	g$sou1
 = 
rashes
(
$sou1
);

188 
	g$nsosize
 = '';

189 if(
	g$sou1
 != '')

191 
$us
 .= "{dede:link islocal='1'ext='{$servermsg1}'} $softurl1 {/dede:link}\r\n";

192 
	g$autosize
 = 
emy
(
$autosize
? 
l
 : 
ue
;

193 if(
	g$autosize
 && 
emy
(
$sosize
))

195 
	g$nsosize
 = @
fesize
(
$cfg_bad
.
$sou1
);

196 if(
emy
(
$nsosize
)
	g$nsosize
 = '未知';

199 
	g$nsosize
 = 
im
(
rtf
("%0.2f", 
$nsosize
 / 1024 / 1024));

200 
	g$nsosize
 = 
$nsosize
." MB";

206 if(!
emy
(
$nsosize
)
	g$sosize
 = $nsoftsize;

207 if(
emy
(
$sosize
)
	g$sosize
 = '未知';

208 
	g$sosize
 = 
$sosize
.' '.
$un
;

211 
	g$i
=2; $i<=30; $i++)

213 if(!
emy
(
$
{'sou'.
$i
}))

215 
	g$fcfig
 = 
emy
(
$
{'fcfig'.
$i
}? 
l
 : 
ue
;

216 if(
	g$fcfig
)

218 if(
emy
(
$
{'ed'.
$i
})) ;

219 
	g$rvU
 = 
rashes
(
$
{'souf'.
$i
});

220 
	g$rvU
 = 
eg_a
("/$", "", 
$rvU
);

221 
	g$sou
 = 
rashes
(
$
{'sou'.
$i
});

222 if
_subr
(
$sou
, 1) != '/' ) $softurl = '/'.$softurl;

223 
	g$sou
 = 
$rvU
.
$sou
;

227 
	g$sou
 = 
rashes
(
$
{'sou'.
$i
});

229 
	g$rvmsg
 = 
r_a
("'", "", 
rashes
(
$
{'rvmsg'.
$i
}));

230 if(
	g$rvmsg
==''
$rvmsg
 = '下载地址'.
$i
;

231 if(
	g$sou
 != 'http://')

233 
$us
 .= "{dede:linkext='$servermsg'} $softurl {/dede:link}\r\n";

237 
	g$us
 = 
addashes
(
$us
);

240 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

241 
	g$addb
 = 
im
(
$s
['addtable']);

242 if(
emy
(
$addb
))

244 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

245 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

246 
ShowMsg
("没找到当前模型[{$channelid}]的主表信息，无法完成操作！。","javascript:;");

247 
ex
();

249 
	g$dacss
 = 
ist
(
$dacss
&& 
is_numic
($daccess) ? $daccess : 0;

250 
	g$u
 = 
GIP
();

251 
	g$Quy
 = "INSERT INTO `$addtable`(aid,typeid,redirecturl,userip,filetype,language,softtype,accredit,

252 
os
,
	gsonk
,
	gofficlU
,
	gofficlDemo
,
	gsosize
,
	gsolks
,
	godu
,
	gdacss
,
	gedmey
{
	g$add_f
})

253 
VALUES
 ('$arcID','$typeid','$redirecturl','$useip','$filetype','$language','$softtype','$accredit',

254 '$os','$sonk','$officlU','$officlDemo','$sosize','$us','$body','$dacss','$edmey'{
$add_v
});";

255 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

257 
	g$gr
 = 
$dsql
->
GE
();

258 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

259 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

260 
ShowMsg
("把数据保存到数据库附加表 `{$addb}` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

261 
ex
();

265 
InTags
(
$gs
,
$cID
);

266 
	g$cU
 = 
MakeA
(
$cID
,
ue
,true);

267 if(
	g$cU
=='')

269 
$cU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

271 
CˬMyAdd
(
$cID
, 
$t
);

273 
	g$msg
 = "

275 <
a
 
hf
='so_add.php?cid=$tyid'><
u
>继续发布软件</u></a>

276 &
nb
;&
	gnb
;

277 <
a
 
	ghf
='$cU' 
rg
='_bnk'><
u
>查看软件</u></a>

278 &
nb
;&
	gnb
;

279 <
a
 
	ghf
='chives_do.php?aid=".$cID."&dodArchives'><
u
>更改软件</u></a>

280 &
nb
;&
	gnb
;

281 <
a
 
	ghf
='log_do.php?cid=$tyid&doiArchives'><
u
>已发布软件管理</u></a>

282 &
nb
;&
	gnb
;

283 <
a
 
	ghf
='log_ma.php'><
u
>网站栏目管理</u></a>

285 
$msg
 = "<div sty=\"le-height:36px;height:36px\">{$msg}</div>".
GUpdeTe
();

287 
	g$wt
 = "成功发布一个软件！";

288 
	g$wecome_fo
 = "文章管理::发布软件";

289 
	g$w
 = 
w
 
OxWdow
();

290 
	g$w
->
AddT
("成功发布软件：");

291 
	g$w
->
AddMsgIm
(
$msg
);

292 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

293 
	g$w
->
Diy
();

	@dede/soft_config.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_SoftConfig');

4 if(
emy
(
$do
)
	g$do
 = '';

7 if(
	g$do
=="save")

9 if(
$dk
>0 || 
$dfywboy
>0
$gojump
 = 1;

10 
	g$quy
 = "UPDATE `#@__softconfig` SET

11 `
dowy
` = '$downtype' ,

12 `
	ggojump
` ='$gotojump' ,

13 `
	gismese
` = '$ismoresite',

14 `
	giol
` = '$islocal',

15 `
	gses
` = '$sites',

16 `
	gmesedo
` = '$moresitedo',

17 `
	gdk
` = '$dfrank',

18 `
	gdfywboy
` = '$dfywboy',

19 `
	ggnge
` = '$argrange',

20 
	gdownmsg
 = '$downmsg' ";

21 
$dsql
->
ExecuNeQuy
(
$quy
);

22 
ShowMsg
('成功保存参数！', 'soft_config.php');

23 
ex
();

27 
	g$row
 = 
$dsql
->
GO
("select * From `#@__softconfig` ");

28 if(!
	$is_y
(
$row
))

30 
$dsql
->
	`ExecuNeQuy
("INSERT INTO `#@__softconfig`(`downtype`,`ismoresite`,`islocal`,`gotojump`,`sites`,`downmsg`,`moresitedo`,`dfrank`,`dfywboy`, `argrange`)

31 
	`VALUES
 ('1', '0','1', '0', '' ,'$downmsg','1', '0', '0', '0'); ");

32 
$row
['downtype'] = 1;

33 
$row
['ismoresite'] = 0;

34 
$row
['islocal'] = 1;

35 
$row
['gotojump'] = 0;

36 
$row
['sites'] = '';

37 
$row
['moresitedo'] = '1';

38 
$row
['dfrank'] = '0';

39 
$row
['dfywboy'] = '0';

40 
$row
['downmsg'] = '';

41 
$row
['argrange'] = 0;

42 
	}
}

43 
ude
 
DedeInude
('templets/soft_config.htm');

44 
ex
();

	@dede/soft_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_Edit,a_AccEdit,a_MyEdit');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

6 if(
	$emy
(
$do
))

8 
$do
 = '';

9 
	}
}

10 if(
	g$do
!='save')

12 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

13 
que_
(
DEDEINC
."/dedetag.class.php");

14 
CˬMyAdd
();

15 
	g$aid
 = 
eg_a
("[^0-9]",'',
$aid
);

16 
	g$chlid
="3";

19 
	g$cQuy
 = "Select

20 #@
__chy
.
tyme
 
as
 
chame
,

21 #@
__k
.
membme
 
as
 
nkme
,

22 #@
__chives
.*

23 
	gFrom
 #@
__chives


24 

 
	gjo
 #@
__chy
 
	g
 #@
	g__chy
.
	gid
=#@
__chives
.
chl


25 

 
jo
 #@
__k
 

 #@__k.
nk
=#@
__chives
.
k


26 
whe
 #@
__chives
.
id
='$aid'";

27 
$dsql
->
SQuy
(
$cQuy
);

28 
	g$cRow
 = 
$dsql
->
GO
(
$cQuy
);

29 if(!
is_y
(
$cRow
))

31 
ShowMsg
("读取档案基本信息出错!","-1");

32 
ex
();

34 
	g$quy
 = "Se * From `#@__chy` whid='".
$cRow
['channel']."'";

35 
	g$cInfos
 = 
$dsql
->
GO
(
$quy
);

36 if(!
is_y
(
$cInfos
))

38 
ShowMsg
("读取频道配置信息出错!","javascript:;");

39 
ex
();

41 
	g$addb
 = 
$cInfos
['addtable'];

42 
	g$addQuy
 = "Select * From `$addtable` whereid='$aid'";

43 
	g$addRow
 = 
$dsql
->
GO
(
$addQuy
);

44 
	g$wRowS
 = 1;

45 
	g$nFm
 = '';

46 
	g$dacss
 = 
$addRow
['daccess'];

47 
	g$edmey
 = 
$addRow
['needmoney'];

48 if(
	g$addRow
['softlinks'] != '')

50 
$d
 = 
w
 
DedeTagP
();

51 
	g$d
->
LdSour
(
$addRow
['softlinks']);

52 if(
is_y
(
$d
->
CTags
))

54 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

56 if(
	g$ag
->
GName
()=='link')

58 
$iol
 = 
$ag
->
GA
('islocal');

59 if(
	g$iol
 !1
$edmsg
 = "<inputype='checkbox'ame='del{$newRowStart}' value='1' />删除";

60 
	g$edmsg
 = '<pume="l1"y="bu" id="l1" vue="选取" onClick="SeSo(\'fm1.sou'.
$wRowS
.'\')" />';

61 
	g$nFm
 ."<div sty='le-height:36px'>软件地址{$wRowS}：<puty='xt'ame='sou{$wRowS}' sty='width:280px' vue='".
im
(
$ag
->
GIText
())."' />

62 服务器名称：<
put
 
ty
='xt' 
me
='rvmsg{$wRowS}' 
vue
='".$ag->GA("xt")."' 
y
='width:150px' />

63 <
put
 
ty
='hidd' 
me
='iol{$wRowS}' 
vue
='{$islocal}' />

64 
$edmsg


65 </
div
>\
r
\
n
";

66 
$wRowS
++;

70 
	g$d
->
Cˬ
();

72 
	g$chlid
 = 
$cRow
['channel'];

73 
	g$gs
 = 
GTags
(
$aid
);

74 
ude
 
DedeInude
("templets/soft_edit.htm");

75 
ex
();

80 if(
	g$do
=='save')

82 
que_
(
DEDEINC
.'/image.func.php');

83 
que_
(
DEDEINC
.'/oxwindow.class.php');

85 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

86 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

88 if(
emy
(
$tyid2
)
	g$tyid2
 = 0;

89 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

90 if(!
ist
(
$me
)
	g$me
 = 0;

91 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

92 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

94 if(
	g$tyid
==0)

96 
ShowMsg
("请指定文档的栏目！","-1");

97 
ex
();

99 if(
emy
(
$chlid
))

101 
ShowMsg
("文档为非指定的类型，请检查你发布内容的表单是否合法！","-1");

102 
ex
();

104 if(!
CheckChl
(
$tyid
,
$chlid
))

106 
ShowMsg
("你所选择的栏目与当前模型不相符，请选择白色的选项！","-1");

107 
ex
();

109 if(!
TePurvw
('a_Edit'))

111 if(
TePurvw
('a_AccEdit'))

113 
CheckCog
(
$tyid
,"对不起，你没有操作栏目 {$typeid} 的文档权限！");

117 
CheckArcAdm
(
$id
,
$curLog
->
gUrID
());

122 
	g$pubde
 = 
GMkTime
(
$pubde
);

123 
	g$ndde
 = 
time
();

124 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

125 if(
	g$ishtml
==0)

127 
$ismake
 = -1;

131 
	g$ismake
 = 0;

133 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

134 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

135 
	g$c
 = 
_subrR
(
$c
,7);

136 
	g$wr
 = 
_subrR
(
$wr
,20);

137 
	g$sour
 = 
_subrR
(
$sour
,30);

138 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

139 
	g$keywds
 = 
_subrR
(
$keywds
,60);

140 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

141 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

143 
	g$k
 = -1;

145 
	g$admid
 = 
$curLog
->
gUrID
();

148 if(
emy
(
$ddieme
))

150 
	g$ddieme
 = 0;

152 
	g$lpic
 = 
GDDImage
('lpic',
$piame
,
$ddieme
);

155 
	g$add_f
 = '';

156 
	g$add_v
 = '';

157 if(!
emy
(
$dede_addflds
))

159 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

160 
	g$add_f
 = '';

161 
	g$add_v
 = '';

162 if(
is_y
(
$addflds
))

164 
fܗch
(
$addflds
 
as
 
$v
)

166 if(
	g$v
=='')

170 
	g$vs
 = 
exode
(',',
$v
);

171 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

173 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

177 if(!
ist
(
$
{
$vs
[0]}))

179 
	g$
{
	g$vs
[0]} = '';

181 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$id
);

183 
	g$add_f
 .",`{$vs[0]}` = '".
$
{
$vs
[0]}."'";

189 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

191 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

193 if(
	g$deu
!='' && !
eg
('j',
$ag
))

195 
	g$ag
 = (
$ag
=='' ? 'j' : $flag.',j');

199 if(
eg
('j', 
$ag
)
	g$ismake
 = -1;

201 
	g$Quy
 = "Update `#@__archives` set

202 
tyid
='$typeid',

203 
	gtyid2
='$typeid2',

204 
	gs܌k
='$sortrank',

205 
	gag
='$flag',

206 
	gick
='$click',

207 
	gismake
='$ismake',

208 
	gk
='$arcrank',

209 
	gmey
='$money',

210 
	gt
='$title',

211 
	gc
='$color',

212 
	gsour
='$source',

213 
	gwr
='$writer',

214 
	glpic
='$litpic',

215 
	gpubde
='$pubdate',

216 
	gnpo
='$notpost',

217 
	gdesti
='$description',

218 
	gkeywds
='$keywords',

219 
	gsh܉
='$shorttitle',

220 
	gfame
='$filename',

221 
	gdutyadm
='$adminid'

222 
whe
 
id
='$id'; ";

223 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

225 
ShowMsg
("更新数据库archives表时出错，请检查！","-1");

226 
ex
();

230 
	g$us
 = '';

232 
	g$i
=1; $i<=30; $i++)

234 if(!
emy
(
$
{'sou'.
$i
}))

236 
	g$iol
 = 
emy
(
$
{'iol'.
$i
}) ? '' : 1;

237 
	g$id
 = 
emy
(
$
{'d'.
$i
}? 
ue
 : 
l
;

238 
	g$rvmsg
 = 
r_a
("'",'',
rashes
(
$
{'rvmsg'.
$i
}));

239 
	g$sou
 = 
rashes
(
$
{'sou'.
$i
});

241 if(
	g$rvmsg
=='')

243 
$rvmsg
 = '下载地址'.
$i
;

245 if(
	g$sou
 != 'http://')

247 if(
$iol
==1
$us
 .= "{dede:link islocal='$islocal'ext='{$servermsg}'} $softurl {/dede:link}\r\n" ;

248 if(
	g$id

	g$us
 .= "{dede:linkext='$servermsg'} $softurl {/dede:link}\r\n";

253 
	g$us
 = 
addashes
(
$us
);

256 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

257 
	g$addb
 = 
im
(
$s
['addtable']);

258 if(
	g$addb
!='')

260 
$u
 = 
GIP
();

261 
	g$Quy
 = "update `$addtable`

262 
t
 
tyid
 ='$typeid',

263 
	gfy
 ='$filetype',

264 
	gnguage
 ='$language',

265 
	gsoty
 ='$softtype',

266 
	gaced
 ='$accredit',

267 
	gos
 ='$os',

268 
	gsonk
 ='$softrank',

269 
	gofficlU
 ='$officialUrl',

270 
	gofficlDemo
 ='$officialDemo',

271 
	gsosize
 ='$softsize',

272 
	gsolks
 ='$urls',

273 
	gdeu
='$redirecturl',

274 
	gur
 = '$useip',

275 
	gdacss
 = '$daccess',

276 
	gedmey
 = '$needmoney',

277 
	godu
='$body'

278 {
$add_f
}

279 
whe
 
aid
='$id';";

280 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

282 
ShowMsg
("更新数据库附加表ddonsoft 时出错，请检查原因！","-1");

283 
ex
();

288 
UpIndexKey
(
$id
,
$k
,
$tyid
,
$s܌k
,
$gs
);

289 
	g$cU
 = 
MakeA
(
$id
,
ue
);

290 if(
	g$cU
=="")

292 
$cU
 = 
$cfg_phpu
."/view.php?aid=$id";

294 
CˬMyAdd
(
$id
, 
$t
);

296 
	g$msg
 = "

298 <
a
 
hf
='so_add.php?cid=$tyid'><
u
>发布新软件</u></a>

299 &
nb
;&
	gnb
;

300 <
a
 
	ghf
='chives_do.php?aid=".$id."&dodArchives'><
u
>继续修改</u></a>

301 &
nb
;&
	gnb
;

302 <
a
 
	ghf
='$cU' 
rg
='_bnk'><
u
>查看软件</u></a>

303 &
nb
;&
	gnb
;

304 <
a
 
	ghf
='log_do.php?cid=$tyid&doiArchives'><
u
>已发布软件管理</u></a>

305 &
nb
;&
	gnb
;

306 <
a
 
	ghf
='log_ma.php'><
u
>网站栏目管理</u></a>

308 
$wt
 = "成功修改一个软件！";

309 
	g$wecome_fo
 = "文章管理::修改软件";

310 
	g$w
 = 
w
 
OxWdow
();

311 
	g$w
->
AddT
("成功修改软件：");

312 
	g$w
->
AddMsgIm
(
$msg
);

313 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

314 
	g$w
->
Diy
();

	@dede/spec_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_New,a_AccNew');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

6 if(
	$emy
(
$do
))

8 
$do
 = '';

9 
	}
}

10 if(
	g$do
!='save')

12 
que_
(
DEDEINC
.'/dedetag.class.php');

13 
que_
(
DEDEADMIN
.'/inc/inc_catalog_options.php');

14 
CˬMyAdd
();

15 
	g$chlid
 = -1;

16 
	g$cid
 = 
ist
(
$cid
&& 
is_numic
($cid) ? $cid : 0;

19 
	g$cInfos
 = 
$dsql
->
GO
(" Select * From `#@__channeltype` where id='$channelid' ");

20 
ude
 
DedeInude
("templets/spec_add.htm");

21 
ex
();

27 if(
	g$do
=='save')

29 
que_
(
DEDEINC
.'/image.func.php');

30 
que_
(
DEDEINC
.'/oxwindow.class.php');

31 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

32 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

33 if(
emy
(
$ick
)
	g$ick
 = (
$cfg_c_ick
=='-1' ? 
mt_nd
(50, 200) : $cfg_arc_click);

35 
	g$chlid
= -1;

36 
	g$mey
 = 0;

37 if(!
ist
(
$gs
)
	g$gs
 = '';

40 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

41 if(!
ist
(
$me
)
	g$me
 = 0;

42 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

43 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

46 if(
emy
(
$wr
))
	g$wr
=
$curLog
->
gUrName
();

47 if(
emy
(
$sour
))
	g$sour
='未知';

48 
	g$pubde
 = 
GMkTime
(
$pubde
);

49 
	g$ndde
 = 
time
();

50 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

51 if(
	g$ishtml
==0)

53 
$ismake
 = -1;

57 
	g$ismake
 = 0;

59 
	g$t
 = 
eg_a
('"', '＂', 
$t
);

60 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

61 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

62 
	g$c
 = 
_subrR
(
$c
,7);

63 
	g$wr
 = 
_subrR
(
$wr
,20);

64 
	g$sour
 = 
_subrR
(
$sour
,30);

65 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

66 
	g$keywds
 = 
_subrR
(
$keywds
,60);

67 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

68 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

70 
	g$k
 = -1;

72 
	g$admid
 = 
$curLog
->
gUrID
();

75 if(
emy
(
$ddieme
))

77 
	g$ddieme
 = 0;

79 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

82 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$admid
);

83 if(
emy
(
$cID
))

85 
ShowMsg
("无法获得主键，无法进行后续操作！","-1");

86 
ex
();

90 
	g$Quy
 = "INSERT INTO `#@__archives`(id,typeid,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

91 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gnpo
,
	gdesti
,
	gkeywds
,
	gfame
)

92 
VALUES
 ('$arcID','$typeid','$sortrank','$flag','$ismake','$channelid','$arcrank','$click','$money','$title','$shorttitle',

94 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

96 
echo
 
	g$Quy
;

97 
	g$gr
 = 
$dsql
->
GE
();

98 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

99 
ShowMsg
("把数据保存到数据库主表 `#@__chives` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

100 
ex
();

104 
	g$cids
 = '';

105 
	g$nٖi
 = '';

106 
	g$i
=1;$i<=
$cfg_ee
;$i++)

108 if(!
emy
(
$
{'nْame'.
$i
}))

110 
	g$nْame
 = 
r_a
("'","",
im
(
$
{'nْame'.
$i
}));

111 
	g$cid
 = 
im
(
$
{'cid'.
$i
});

112 
	g$c
 = 
im
(
$
{'c'.
$i
});

113 
	g$imgwidth
 = 
im
(
$
{'imgwidth'.
$i
});

114 
	g$imgheight
 = 
im
(
$
{'imgheight'.
$i
});

115 
	g$tn
 = 
im
(
$
{'tn'.
$i
});

116 
	g$fޒ
 = 
im
(
$
{'fޒ'.
$i
});

117 
	g$litmp
 = 
im
(
$
{'litmp'.
$i
});

118 
	g$neid
 = 
im
(
$
{'neid'.
$i
});

119 
	g$iuto
 = 
im
(
$
{'iuto'.
$i
});

120 
	g$keywds
 = 
r_a
("'","",
im
(
$
{'keywds'.
$i
}));

121 
	g$tyid
 = 
im
(
$
{'tyid'.
$i
});

122 if(!
emy
(
$
{'rownum'.
$i
}))

124 
	g$rownum
 = 
im
(
$
{'rownum'.
$i
});

128 
	g$rownum
 = 0;

130 
	g$cid
 = 
eg_a
("[^0-9,]","",
$cid
);

131 
	g$ids
 = 
exode
(",",
$cid
);

132 
	g$okids
 = "";

133 if(
is_y
(
$ids
))

135 
fܗch
(
$ids
 
as
 
$mid
)

137 
	g$mid
 = 
im
(
$mid
);

138 if(
	g$mid
=="")

142 if(!
ist
(
$cids
[
$mid
]))

144 if(
	g$okids
=="")

146 
$okids
 .
$mid
;

150 
	g$okids
 .",".
$mid
;

152 
	g$cids
[
$mid
] = 1;

156 
	g$nٖi
 .= "{dede:specnote imgheight=\\'$imgheight\\' imgwidth=\\'$imgwidth\\'

157 
fޒ
=\\'$fޒ\\' 
tn
=\\'$tn\\' 
c
=\\'$c\\' 
idli
=\\'$okids\\'

158 
me
=\\'$nْame\\' 
neid
=\\'$neid\\' 
iuto
=\'$iuto\'ownum=\\'
$rownum
\\'

159 
keywds
=\\'$keywds\\' 
tyid
=\\'$typeid\\'}

160 
	g$litmp


161 {/
	gdede
:
ee
}\
r
\
n
";

166 
$add_f
 = '';

167 
	g$add_v
 = '';

168 if(!
	$emy
(
$dede_addflds
))

170 
$addflds
 = 
	`exode
(';',
$dede_addflds
);

171 
$add_f
 = '';

172 
$add_v
 = '';

173 if(
	`is_y
(
$addflds
))

175 
	`fܗch
(
$addflds
 
as
 
$v
)

177 if(
$v
=='')

181 
$vs
 = 
	`exode
(',',
$v
);

182 if(
$vs
[1]=='htmltext'||$vs[1]=='textdata')

184 
$
{
$vs
[0]} = 
	`AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

188 if(!
	`ist
(
$
{
$vs
[0]}))

190 
$
{
$vs
[0]} = '';

192 
$
{
$vs
[0]} = 
	`GFldVueA
(${$vs[0]},$vs[1],
$cID
);

194 
$add_f
 .','.
$vs
[0];

195 
$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

198 
	}
}

201 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

203 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

205 
	g$u
 = 
GIP
();

207 
	g$Quy
 = "INSERT INTO `#@__addonspec`(aid,typeid,userip,templet,note{$inadd_f}) VALUES ('$arcID','$typeid','$useip','$templet','$notelist'{$inadd_v});";

208 if(!
	g$dsql
->
	$ExecuNeQuy
(
$Quy
))

210 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

211 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

212 
	`ShowMsg
("把数据保存到数据库附加表ddonspec 时出错，请检查原因！","-1");

213 
	`ex
();

214 
	}
}

217 
InTags
(
$gs
,
$cID
);

218 
	g$tU
 = 
MakeA
(
$cID
,
ue
,true);

219 if(
	g$tU
=='')

221 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

223 
CˬMyAdd
(
$cID
, 
$t
);

225 
	g$msg
 = "

227 <
a
 
hf
='ec_add.php?cid=$tyid'><
u
>创建新专题</u></a>

228 &
nb
;&
	gnb
;

229 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看专题</u></a>

230 &
nb
;&
	gnb
;

231 <
a
 
	ghf
='cڋ_s_li.php'><
u
>已发布专题管理</u></a>

233 
$wt
 = "成功创建专题！";

234 
	g$wecome_fo
 = "文章管理::发布专题";

235 
	g$w
 = 
w
 
OxWdow
();

236 
	g$w
->
AddT
("成功创建专题：");

237 
	g$w
->
AddMsgIm
(
$msg
);

238 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

239 
	g$w
->
Diy
();

	@dede/spec_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('a_Edit,a_AccEdit,a_MyEdit');

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEADMIN
."/inc/inc_archives_functions.php");

6 if(
	$emy
(
$do
))

8 
$do
 = '';

9 
	}
}

10 if(
	g$do
!='save')

12 
que_
(
DEDEADMIN
."/inc/inc_catalog_options.php");

13 
que_
(
DEDEINC
."/dedetag.class.php");

14 
CˬMyAdd
();

15 
	g$aid
 = 
tv
(
$aid
);

16 
	g$chlid
 = -1;

19 
	g$cQuy
 = "Select ch.typenames channelname,ar.membernamesankname,arc.*

20 
From
 `#@
__chives
` 
c


21 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


22 

 
jo
 `#@
__k
` 

 

r.
nk
=
c
.
k
 
whe
rc.
id
='$aid' ";

23 
$cRow
 = 
$dsql
->
GO
(
$cQuy
);

24 if(!
is_y
(
$cRow
))

26 
ShowMsg
("读取档案基本信息出错!","-1");

27 
ex
();

29 
	g$quy
 = "Select * From `#@__channeltype` where id='-1'";

30 
	g$cInfos
 = 
$dsql
->
GO
(
$quy
);

31 if(!
is_y
(
$cInfos
))

33 
ShowMsg
("读取频道配置信息出错!","javascript:;");

34 
ex
();

36 
	g$addRow
 = 
$dsql
->
GO
("Select * From `#@__addonspec` whereid='$aid'");

37 
	g$gs
 = 
GTags
(
$aid
);

38 
ude
 
DedeInude
("templets/spec_edit.htm");

44 if(
	g$do
=='save')

46 
que_
(
DEDEINC
.'/image.func.php');

47 
que_
(
DEDEINC
.'/oxwindow.class.php');

48 
	g$ag
 = 
ist
(
$ags
? 
jo
(',',$flags) : '';

49 
	g$npo
 = 
ist
(
$npo
) && $notpost == 1 ? 1: 0;

51 if(!
ist
(
$gs
)
	g$gs
 = '';

52 
	g$chlid
= -1;

55 if(!
ist
(
$autokey
)
	g$autokey
 = 0;

56 if(!
ist
(
$me
)
	g$me
 = 0;

57 if(!
ist
(
$dlk
)
	g$dlk
 = 0;

58 if(!
ist
(
$autޙpic
)
	g$autޙpic
 = 0;

61 
	g$pubde
 = 
GMkTime
(
$pubde
);

62 
	g$s܌k
 = 
AddDay
(
$pubde
,
$stup
);

63 if(
	g$ishtml
==0)

65 
$ismake
 = -1;

69 
	g$ismake
 = 0;

71 
	g$t
 = 
_subrR
(
$t
,
$cfg_t_maxn
);

72 
	g$sh܉
 = 
_subrR
(
$sh܉
,36);

73 
	g$c
 = 
_subrR
(
$c
,7);

74 
	g$wr
 = 
_subrR
(
$wr
,20);

75 
	g$sour
 = 
_subrR
(
$sour
,30);

76 
	g$desti
 = 
_subrR
(
$desti
,
$cfg_au_desti
);

77 
	g$keywds
 = 
im
(
_subrR
(
$keywds
,60));

78 
	g$fame
 = 
im
(
_subrR
(
$fame
,40));

79 if(!
TePurvw
('a_Check,a_AccCheck,a_MyCheck'))

81 
	g$k
 = -1;

83 
	g$admid
 = 
$curLog
->
gUrID
();

86 if(
emy
(
$ddieme
))

88 
	g$ddieme
 = 0;

90 
	g$lpic
 = 
GDDImage
('ne',
$piame
,
$ddieme
);

93 
	g$add_f
 = '';

94 
	g$add_v
 = '';

95 if(!
emy
(
$dede_addflds
))

97 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

98 
	g$add_f
 = '';

99 
	g$add_v
 = '';

100 if(
is_y
(
$addflds
))

102 
fܗch
(
$addflds
 
as
 
$v
)

104 if(
	g$v
=='')

108 
	g$vs
 = 
exode
(',',
$v
);

109 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

111 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

113 if(!
ist
(
$
{
$vs
[0]}))

115 
	g$
{
	g$vs
[0]} = '';

117 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$cID
);

119 
	g$add_f
 .",`{$vs[0]}` = '".
$
{
$vs
[0]}."'";

125 if(
	g$lpic
!='' && !
eg
('p',
$ag
))

127 
	g$ag
 = (
$ag
=='' ? 'p' : $flag.',p');

129 
	g$Quy
 = "update `#@__archives` set

130 
tyid
='$typeid',

131 
	gs܌k
='$sortrank',

132 
	gag
='$flag',

133 
	gismake
='$ismake',

134 
	gk
='$arcrank',

135 
	gick
='$click',

136 
	gt
='$title',

137 
	gc
='$color',

138 
	gwr
='$writer',

139 
	gsour
='$source',

140 
	glpic
='$litpic',

141 
	gpubde
='$pubdate',

142 
	gnpo
='$notpost',

143 
	gdesti
='$description',

144 
	gkeywds
='$keywords',

145 
	gsh܉
='$shorttitle',

146 
	gfame
='$filename'

147 
whe
 
id
='$id'; ";

148 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

150 
ShowMsg
("更新数据库archives表时出错，请检查！","-1");

151 
ex
();

155 
	g$cids
 = '';

156 
	g$nٖi
 = '';

157 
	g$i
=1;$i<=
$cfg_ee
;$i++)

159 if(!
emy
(
$
{'nْame'.
$i
}))

161 
	g$nْame
 = 
r_a
("'","",
im
(
$
{'nْame'.
$i
}));

162 
	g$cid
 = 
im
(
$
{'cid'.
$i
});

163 
	g$c
 = 
im
(
$
{'c'.
$i
});

164 
	g$imgwidth
 = 
im
(
$
{'imgwidth'.
$i
});

165 
	g$imgheight
 = 
im
(
$
{'imgheight'.
$i
});

166 
	g$tn
 = 
im
(
$
{'tn'.
$i
});

167 
	g$fޒ
 = 
im
(
$
{'fޒ'.
$i
});

168 
	g$litmp
 = 
im
(
$
{'litmp'.
$i
});

169 if(
ist
(
$
{'neid'.
$i
}))

171 
	g$neid
 = 
im
(
$
{'neid'.
$i
});

175 
	g$neid
 = 
$i
;

177 if(
ist
(
$
{'iuto'.
$i
}))

179 
	g$iuto
 = 
im
(
$
{'iuto'.
$i
});

183 
	g$iuto
 = 0;

185 if(
ist
(
$
{'keywds'.
$i
}))

187 
	g$keywds
 = 
r_a
("'","",
im
(
$
{'keywds'.
$i
}));

191 
	g$keywds
 = "";

193 if(!
emy
(
$
{'tyid'.
$i
}))

195 
	g$yid
 = 
im
(
$
{'tyid'.
$i
});

199 
	g$yid
 = 0;

201 if(!
emy
(
$
{'rownum'.
$i
}))

203 
	g$rownum
 = 
im
(
$
{'rownum'.
$i
});

207 
	g$rownum
 = 0;

209 
	g$cid
 = 
eg_a
("[^0-9,]","",
$cid
);

210 
	g$ids
 = 
exode
(",",
$cid
);

211 
	g$okids
 = "";

212 if(
is_y
(
$ids
))

214 
fܗch
(
$ids
 
as
 
$mid
)

216 
	g$mid
 = 
im
(
$mid
);

217 if(
	g$mid
=="")

221 if(!
ist
(
$cids
[
$mid
]))

223 if(
	g$okids
=="")

225 
$okids
 .
$mid
;

229 
	g$okids
 .",".
$mid
;

231 
	g$cids
[
$mid
] = 1;

235 
	g$nٖi
 .= "{dede:specnote imgheight=\\'$imgheight\\' imgwidth=\\'$imgwidth\\'

236 
fޒ
=\\'$fޒ\\' 
tn
=\\'$tn\\' 
c
=\\'$c\\' 
idli
=\\'$okids\\'

237 
me
=\\'$nْame\\' 
neid
=\\'$neid\\' 
iuto
=\'$iuto\'ownum=\\'
$rownum
\\'

238 
keywds
=\\'$keywds\\' 
tyid
=\\'$ttypeid\\'}

239 
	g$litmp


240 {/
	gdede
:
ee
}\
r
\
n
";

245 
$Quy
 = "update `#@__addonspec` setypeid ='$typeid',note='$notelist'{$inadd_f},templet='$templet' whereid='$id';";

246 if(!
	g$dsql
->
	$ExecuNeQuy
(
$Quy
))

248 
	`ShowMsg
("更新数据库附加表ddonspec 时出错，请检查原因！","-1");

249 
	`ex
();

250 
	}
}

253 
UpIndexKey
(
$id
,
$k
,
$tyid
,
$s܌k
,
$gs
);

254 
	g$tU
 = 
MakeA
(
$id
,
ue
,true);

255 if(
	g$tU
=='')

257 
$tU
 = 
$cfg_phpu
."/view.php?aid=$id";

259 
CˬMyAdd
(
$id
, 
$t
);

261 
	g$msg
 = "　　请选择你的后续操作：

262 <
a
 
hf
='ec_add.php?cid=$tyid'><
u
>发布新专题</u></a>

263 &
nb
;&
	gnb
;

264 <
a
 
	ghf
='chives_do.php?aid=".$id."&dodArchives'><
u
>查看更改</u></a>

265 &
nb
;&
	gnb
;

266 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看专题</u></a>

267 &
nb
;&
	gnb
;

268 <
a
 
	ghf
='cڋ_s_li.php'><
u
>已发布专题管理</u></a> ";

269 
$wt
 = "成功更改一个专题！";

270 
	g$wecome_fo
 = "专题管理::更改专题";

271 
	g$w
 = 
w
 
OxWdow
();

272 
	g$w
->
AddT
("成功更改专题！");

273 
	g$w
->
AddMsgIm
(
$msg
);

274 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

275 
	g$w
->
Diy
();

	@dede/stepselect_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('c_Stepselect');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
que_
(
DEDEINC
.'/enums.func.php');

10 
	g$ENV_GOBACK_URL
 = (
ist
(
$ENV_GOBACK_URL
) ? $ENV_GOBACK_URL : 'stepselect_main.php');

11 if(
	$emy
(
$ai
))

13 
	`tcook
("ENV_GOBACK_URL",
$dedeNowu
,
	`time
()+3600,"/");

14 if(!
	`ist
(
$egroup
)) $egroup = '';

15 if(!
	`ist
(
$tvue
)) $topvalue = 0;

16 
$ys
 = 
	`y
();

17 
$egroups
 = 
	`y
();

18 
$dsql
->
	`Execu
('me','Select * from `#@__stepselect` order by id desc');

19 
$r
 = 
$dsql
->
	`GAay
())

21 
$ys
[] = 
$r
;

22 
$egroups
[
$r
['egroup']] = $arr['itemname'];

25 if(
$egroup
!='')

27 
$dby
 = 'order by disordersc,valuesc';

28 if(!
	`emy
(
$tvue
))

30 
$egroupsql
 = " whegroulik'$egroup' Andvue>=$tvuAndvu< ".(
$tvue
 + 500);

34 
$egroupsql
 = " wheregroupike '$egroup' ";

36 
$sql
 = "Select * From `#@__sys_enum` $egroupsql $orderby";

40 
$egroupsql
 = '';

41 
$sql
 = "Select * from `#@__stepselect` order by id desc";

43 
$dli
 = 
w
 
	`DaLiCP
();

44 
$dli
->
	`SPam
('egroup',
$egroup
);

45 
$dli
->
	`SPam
('tvue',
$tvue
);

46 
$dli
->
	`STem
(
DEDEADMIN
."/templets/stepselect_main.htm");

47 
$dli
->
	`SSour
(
$sql
);

48 
$dli
->
	`diy
();

49 
	`ex
();

50 
	}
}

51 if(
	g$ai
=='ed' || 
$ai
=='addnew' || $action=='addenum' || $action=='view')

53 
AjaxHd
();

54 
ude
('./templets/stepselect_showajax.htm');

55 
ex
();

61 if(
	g$ai
=='del')

63 
$r
 = 
$dsql
->
GO
("Select * from `#@__stepselect` where id='$id' ");

64 if(!
is_y
(
$r
))

66 
ShowMsg
("无法获取分类信息，不允许后续操作！","_ma.php?".
ExecTime
());

67 
ex
();

69 if(
	g$r
['issystem']==1)

71 
ShowMsg
("系统内置的枚举分类不能删除！","_ma.php?".
ExecTime
());

72 
ex
();

74 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__stepselect` where id='$id'; ");

75 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__sys_enum` wheregroup='{$arr['egroup']}'; ");

76 
ShowMsg
("成功删除一个分类！","_ma.php?".
ExecTime
());

77 
ex
();

79 if(
	g$ai
=='delenumAllSel')

81 if(
ist
(
$ids
&& 
is_y
($ids))

83 
$id
 = 
jo
(',', 
$ids
);

85 
	g$groups
 = 
y
();

86 
	g$dsql
->
Execu
('me', "Selectgroup From `#@__sys_enum` where id in($id) group bygroup");

87 
	g$row
 = 
$dsql
->
GAay
('me'))

89 
$groups
[] = 
$row
['egroup'];

92 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__sys_enum` where id in($id); ");

95 
fܗch
(
$groups
 
as
 
$egru
) {

96 
WreEnumsCache
(
$egroup
);

99 
ShowMsg
("成功删除选中的枚举分类！",
$ENV_GOBACK_URL
);

103 
ShowMsg
("你没选择任何分类！", "-1");

105 
ex
();

107 if(
	g$ai
=='delenum')

109 
$row
 = 
$dsql
->
GO
("Selectgroup From `#@__sys_enum` where id = '$id' ");

110 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__sys_enum` where id='{$id}'; ");

111 
WreEnumsCache
(
$row
['egroup']);

112 
ShowMsg
("成功删除一个枚举！",
$ENV_GOBACK_URL
);

113 
ex
();

119 if(
	g$ai
=='edit_save')

121 if(
egi
("[^0-9a-z_-]",
$egroup
))

123 
ShowMsg
("组名称不能有全角字符或特殊符号！","-1");

124 
ex
();

126 
	g$dsql
->
ExecuNeQuy
("update `#@__stepselect` set `itemname`='$itemname',`egroup`='$egroup' where id='$id'; ");

127 
ShowMsg
("成功修改一个分类！","_ma.php?".
ExecTime
());

128 
ex
();

134 if(
	g$ai
=='addnew_save')

136 if(
egi
("[^0-9a-z_-]",
$egroup
))

138 
ShowMsg
("组名称不能有全角字符或特殊符号！","-1");

139 
ex
();

141 
	g$r
 = 
$dsql
->
GO
("Select * from `#@__stepselect` where itemnameike '$itemname' Orgroupike '$egroup' ");

142 if(
is_y
(
$r
))

144 
ShowMsg
("你指定的类别名称或组名称已经存在，不能使用！","stepselect_main.php");

145 
ex
();

147 
	g$dsql
->
ExecuNeQuy
("Insert into `#@__stepselect`(`itemname`,`egroup`,`issign`,`issystem`) values('$itemname','$egroup','0','0'); ");

148 
WreEnumsCache
(
$egroup
);

149 
ShowMsg
("成功添加一个分类！","stepselect_main.php?egroup=$egroup");

150 
ex
();

156 if(
	g$ai
=='exarea')

158 
$bigtys
 = 
y
();

159 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__sys_enum` wheregroup='nativeplace'; ");

160 
	g$quy
 = "SELECT * FROM `#@__area` WHEREeid =0 order by idsc";

161 
	g$dsql
->
Execu
('me', 
$quy
);

162 
	g$n
 = 1;

163 
	g$row
 = 
$dsql
->
GAay
())

165 
$bigtys
[
$row
['id']] = 
$evue
 = 
$disd
 = 
$n
 * 500;

166 
	g$dsql
->
ExecuNeQuy
("Insert into `#@__sys_enum`(`ename`,`evalue`,`egroup`,`disorder`,`issign`)

167 
vues
('{$row['
me
']}','$evalue','nativeplace','$disorder','0'); ");

168 
$n
++;

170 
$ys
 = 
y
();

171 
fܗch
(
$bigtys
 
as
 
$k
=>
$v
)

173 
$quy
 = "SELECT * FROM `#@__area` WHEREeid=$k order by idsc";

174 
$dsql
->
Execu
('me', 
$quy
);

175 
$n
 = 1;

176 
$row
 = 
$dsql
->
GAay
())

178 
$ys
[
$row
['id']] = 
$evue
 = 
$disd
 = 
$v
 + 
$n
;

179 
$dsql
->
ExecuNeQuy
("Insert into `#@__sys_enum`(`ename`,`evalue`,`egroup`,`disorder`,`issign`)

180 
vues
('{$row['
me
']}','$evalue','nativeplace','$disorder','0'); ");

181 
$n
++;

184 
WreEnumsCache
('nativeplace');

185 
ShowMsg
("成功导入所有旧的地区数据！", "stepselect_main.php?egroup=nativeplace");

186 
ex
();

195 if(
$ai
=='addenum_save')

197 if(
emy
(
$ame
||my(
$egroup
)) {

198 
Showmsg
("类别名称或组名称不能为空！","-1");

199 
ex
();

201 if(
$issign
==1 || 
$tvue
==0)

203 
$ames
 = 
exode
(',', 
$ame
);

204 
fܗch
(
$ames
 
as
 
$ame
)

206 
$r
 = 
$dsql
->
GO
("Select * From `#@__sys_enum` wheregroup='$egroup' And (evalue mod 500)=0 order byvalue desc ");

208 if(!
is_y
(
$r
)
$disd
 = 
$evue
 = (
$issign
==1 ? 1 : 500);

209 
$disd
 = 
$evue
 = 
$r
['disd'] + (
$issign
==1 ? 1 : 500);

211 
$dsql
->
ExecuNeQuy
("Insert into `#@__sys_enum`(`ename`,`evalue`,`egroup`,`disorder`,`issign`) 

212 
vues
('$ename','$evalue','$egroup','$disorder','$issign'); "); 

214 
WreEnumsCache
(
$egroup
);

215 
ShowMsg
("成功添加枚举分类！".
$dsql
->
GE
(), 
$ENV_GOBACK_URL
);

216 
ex
();

220 
$mid
 = 
$tvue
;

221 
$maxid
 = 
$tvue
 + 500;

222 
$ames
 = 
exode
(',', 
$ame
);

223 
fܗch
(
$ames
 
as
 
$ame
)

225 
$r
 = 
$dsql
->
GO
("Select * From `#@__sys_enum` wheregroup='$egroup' Andvalue>$minid Andvalue<$maxid order byvalue desc ");

226 if(!
is_y
(
$r
))

228 
$disd
 = 
$evue
 = 
$mid
+1;

232 
$disd
 = 
$r
['disorder']+1;

233 
$evue
 = 
$r
['evalue']+1;

235 
$dsql
->
ExecuNeQuy
("Insert into `#@__sys_enum`(`ename`,`evalue`,`egroup`,`disorder`,`issign`) 

236 
vues
('$ename','$evalue','$egroup','$disorder','$issign'); ");

238 
WreEnumsCache
(
$egroup
);

239 
ShowMsg
("成功添加枚举分类！", 
$ENV_GOBACK_URL
);

240 
ex
();

247 if(
$ai
=='upenum')

249 
$ame
 = 
im
(
r_a
(' └─','',$ename));

250 
$row
 = 
$dsql
->
GO
("Selectgroup From `#@__sys_enum` where id = '$id' ");

251 
WreEnumsCache
(
$row
['egroup']);

252 
$dsql
->
ExecuNeQuy
("Update `#@__sys_enum` set `ename`='$ename',`disorder`='$disorder' where id='$aid'; ");

253 
ShowMsg
("成功修改一个枚举！", 
$ENV_GOBACK_URL
);

254 
ex
();

260 if(
$ai
=='upallcache')

262 if(!
ist
(
$egroup
)) $egroup = '';

263 
WreEnumsCache
(
$egroup
);

264 
ShowMsg
("成更新枚举缓存！", 
$ENV_GOBACK_URL
);

265 
ex
();

	@dede/swfupload.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
que_
(
DEDEINC
.'/image.func.php');

8 if(
	$emy
(
$do
))

10 
	`i_t
('html_errors', '0');

11 i
	`emy
(
$Feda
|| !
	`is_uded_fe
($Filedata) )

13 
echo
 'ERROR: Upload Error! ';

14 
	`ex
(0);

18 
$tmpd
 = 
DEDEDATA
.'/uploadtmp';

19 if(!
	`is_d
(
$tmpd
))

21 
	`MkdA
(
$tmpd
, 
$cfg_d_purvw
);

22 
	`CloF
();

23 if(!
	`is_d
(
$tmpd
))

25 
echo
 "ERROR: Create {$tmpdir} dir Error! ";

26 
	`ex
(0);

30 
$FedaNew
 = 
	`r_a
("\\", '/', 
$Feda
);

31 
$FedaNew
 = 
$tmpd
.'/'.
	`eg_a
("/(.*)[\/]/isU", "", $FiledataNew);

32 
	`move_uded_fe
(
$Feda
, 
$FedaNew
);

34 
$fo
 = 
$y
 = 
$ame
 = '';

35 
$cInfo
 = 
	`GImageSize
(
$FedaNew
, 
$fo
);

37 i(!
	`is_y
(
$cInfo
))

39 @
	`uƚk
(
$Feda
);

40 
echo
 "ERROR: Image info Error! ";

41 
	`ex
(0);

45 
$cInfo
[2])

48 
$y
 = 'image/gif';

49 
$ame
 = '.gif';

52 
$y
 = 'image/jpeg';

53 
$ame
 = '.jpg';

56 
$y
 = 'image/png';

57 
$ame
 = '.png';

60 
$y
 = 'image/bmp';

61 
$ame
 = '.bmp';

65 if(
$y
=='')

67 @
	`uƚk
(
$Feda
);

68 
echo
 "ERROR: Imageype Error! ";

69 
	`ex
(0);

74 
$fed
 = 
$cfg_image_d
.'/'.
	`MyDe
(
$cfg_add_vy
, 
	`time
());

75 if(!
	`is_d
(
DEDEROOT
.
$fed
))

77 
	`MkdA
(
$cfg_bad
.
$fed
, 
$cfg_d_purvw
);

78 
	`CloF
();

80 
$fame
 = 
$curLog
->
	`gUrID
().'-'.
	`dd2ch
(
	`MyDe
('ymdHis', 
	`time
()));

81 if
	`fe_exis
(
$cfg_bad
.
$fed
.'/'.
$fame
.
$ame
) )

83 
$i
=50; $i <= 5000; $i++)

85 if!
	`fe_exis
(
$cfg_bad
.
$fed
.'/'.
$fame
.'-'.
$i
.
$ame
) )

87 
$fame
 = $fame.'-'.
$i
;

92 
$feu
 = 
$fed
.'/'.
$fame
.
$ame
;

93 
$rs
 = 
	`cy
(
$FedaNew
, 
$cfg_bad
.
$feu
);

94 
	`uƚk
(
$FedaNew
);

95 if(!
$rs
)

97 
echo
 "ERROR: Copy Uploadfile Error! ";

98 
	`ex
(0);

101 
$t
 = 
$fame
.
$ame
;

102 
$quy
 = "INSERT INTO `#@__uploads`(title,url,mediatype,width,height,playtime,filesize,uptime,mid)

103 
	`VALUES
 ('$title','$fileurl','$ftype','0','0','0','".filesize($cfg_basedir.$fileurl)."','".time()."','".$cuserLogin->getUserID()."'); ";

104 
$dsql
->
	`ExecuNeQuy
(
$quy
);

105 
$fid
 = 
$dsql
->
	`GLaID
();

106 
	`AddMyAdd
(
$fid
, 
$feu
);

110 
	`ob_t
();

111 
	`ImageResizeNew
(
$cfg_bad
.
$feu
, 
$cfg_ddimg_width
, 
$cfg_ddimg_height
, '', 
l
);

112 
$imagevb
 = 
	`ob_g_cڋs
();

113 
	`ob_d_n
();

117 i(!
	`ist
(
$_SESSION
['file_info']))

119 
$_SESSION
['fe_fo'] = 
	`y
();

122 i(!
	`ist
(
$_SESSION
['bigfile_info']))

124 
$_SESSION
['bigfe_fo'] = 
	`y
();

127 i(!
	`ist
(
$_SESSION
['fileid']))

129 
$_SESSION
['fileid'] = 1;

133 
$_SESSION
['fileid']++;

136 
$_SESSION
['bigfe_fo'][$_SESSION['feid']] = 
$feu
;

138 
$_SESSION
['fe_fo'][$_SESSION['feid']] = 
$imagevb
;

140 
echo
 "FILEID:".
$_SESSION
['fileid'];

142 
	`ex
(0);

143 
	}
}

148 if(
	g$do
=='thumbnail')

150 if
emy
(
$id
) )

152 
hd
('HTTP/1.1 500 Internal Server Error');

153 
	gecho
 'No ID';

154 
ex
(0);

156 i(!
is_y
(
$_SESSION
['fe_fo']|| !
ist
($_SESSION['fe_fo'][
$id
]))

158 
hd
('HTTP/1.1 404 Not found');

159 
ex
(0);

161 
hd
('Content-type: image/jpeg');

162 
hd
('Cڋ-Lgth: '.

(
$_SESSION
['fe_fo'][
$id
]));

163 
echo
 
	g$_SESSION
['fe_fo'][
$id
];

164 
ex
(0);

169 if(
	g$do
=='del')

171 if(!
ist
(
$_SESSION
['bigfe_fo'][
$id
]))

173 
echo
 '';

174 
ex
();

176 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__uploads` where urlike '{$_SESSION['bigfile_info'][$id]}'; ");

177 @
uƚk
(
$cfg_bad
.
$_SESSION
['bigfe_fo'][
$id
]);

178 
	g$_SESSION
['fe_fo'][
$id
] = '';

179 
	g$_SESSION
['bigfe_fo'][
$id
] = '';

180 
	gecho
 "<b>已删除！</b>";

181 
ex
();

187 if(
	g$do
=='ddimg')

190 
ob_t
();

191 
ImageResizeNew
(
$cfg_bad
.
$img
, 
$cfg_ddimg_width
, 
$cfg_ddimg_height
, '', 
l
);

192 
	g$imagevb
 = 
ob_g_cڋs
();

193 
ob_d_n
();

194 
hd
('Content-type: image/jpeg');

195 
hd
('Cڋ-Lgth: '.

(
$imagevb
));

196 
echo
 
	g$imagevb
;

197 
ex
();

202 if(
	g$do
=='delold')

204 
$imgfe
 = 
$cfg_bad
.
$picfe
;

205 if(!
fe_exis
(
$imgfe
&& !
is_d
($imgfe&& 
eg
("^".
$cfg_meds_d
, $imgfile))

207 @
uƚk
(
$imgfe
);

209 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__uploads` where urlike '{$picfile}'; ");

210 
	gecho
 "<b>已删除！</b>";

211 
ex
();

	@dede/sys_admin_user.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_User');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 if(
	$emy
(
$nk
))

8 
$nk
="";

9 
	}
}

12 
	g$nk
 = " where CONCAT(#@__admin.usertype)='$rank' ";

14 
	g$dsql
->
SQuy
("selectank,typename From `#@__admintype` ");

15 
	g$dsql
->
Execu
();

16 
	g$row
 = 
$dsql
->
	$GObje
())

18 
$admRks
[
$row
->
nk
] = $row->
tyme
;

19 
	}
}

20 
	g$quy
 = "Select #@__admin.*,#@__arctype.typename From #@__admineft join #@__arctype on #@__admin.typeid=#@__arctype.id $rank ";

21 
	g$dli
 = 
w
 
DaLiCP
();

22 
	g$dli
->
STem
(
DEDEADMIN
."/templets/sys_admin_user.htm");

23 
	g$dli
->
SSour
(
$quy
);

24 
	g$dli
->
Diy
();

26 
funi
 
	$GUrTy
(
$k
)

28 
glob
 
$admRks
;

29 if(
	`ist
(
$admRks
[
$k
]))

31  
$admRks
[
$k
];

37 
	}
}

39 
funi
 
	$GChl
(
$c
)

41 if(
$c
==""||$c==0)

47  
$c
;

49 
	}
}

	@dede/sys_admin_user_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_User');

4 
que_
(
DEDEINC
."/typelink.class.php");

5 if(
	$emy
(
$do
))

7 
$do
='';

8 
	}
}

9 if(
	g$do
=='add')

11 if(
eg
("[^0-9a-zA-Z_@!\.-]", 
$pwd
||g("[^0-9a-zA-Z_@!\.-]", 
$urid
))

13 
ShowMsg
('密码或或用户名不合法，<br />请使用[0-9a-zA-Z_@!.-]内的字符！', '-1', 0, 3000);

14 
ex
();

16 
	g$codeok
 = 
subr
(
md5
(
$cfg_cook_code
.
$ndcode
), 0, 24);

17 if(
	g$code
 !
$codeok
 )

19 
ShowMsg
('请填写安全验证串！','-1',0,3000);

20 
ex
();

22 
	g$row
 = 
$dsql
->
GO
("Select count(*)s dd from `#@__member` where useridike '$userid' ");

23 if(
	g$row
['dd']>0)

25 
ShowMsg
('用户名已存在！','-1');

26 
ex
();

28 
	g$mpwd
 = 
md5
(
$pwd
);

29 
	g$pwd
 = 
subr
(
md5
(
$pwd
), 5, 20);

31 
	g$tyid
 = 
jo
(',', 
$tyids
);

32 if(
	g$tyid
=='0'
$tyid
 = '';

35 
	g$admquy
 = "INSERT INTO `#@__member` (`mtype`,`userid`,`pwd`,`uname`,`sex`,`rank`,`money`,`email`,

36 `
sces
` ,`
	gmt
` ,`
	g
`,`
	gquei
`,`
	gsw
` ,`
	gjotime
` ,`
	gjo
` ,`
	glogtime
` ,`
	glog
` )

37 
VALUES
 ('个人','$userid','$mpwd','$uname','男','100','0','$email','1000','10','','0','','0','','0',''); ";

38 
	g$dsql
->
ExecuNeQuy
(
$admquy
);

40 
	g$mid
 = 
$dsql
->
GLaID
();

41 if(
	g$mid
 <= 0 )

43 
d
(
$dsql
->
GE
().' 数据库出错！');

47 
	g$quy
 = "Insert Into `#@__admin`(id,usertype,userid,pwd,uname,typeid,tname,email)

48 
vues
('$mid','$usertype','$userid','$pwd','$uname','$typeid','$tname','$email'); ";

49 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

51 
	g$admquy
 = "INSERT INTO `#@__member_person` (`mid`,`onlynet`,`sex`,`uname`,`qq`,`msn`,`tel`,`mobile`,`place`,`oldplace`,`birthday`,`star`,

52 `
come
` , `
	geduti
` , `
	gheight
` , `
	gbodyty
` , `
	gblood
` , `
	gvoti
` , `
	gsmoke
` , `
	gm
` , `
	ghou
` ,`
	gdrk
` , `
	gdgty
` , `
	gnguage
` , `
	gtu
` , `
	glovemsg
` , `
	gaddss
`,`
	guime
`)

53 
VALUES
 ('$mid', '1', '男', '{$userid}', '', '', '', '', '0', '0','1980-01-01', '1', '0', '0', '160', '0', '0', '0', '0', '0', '0','0', '0', '', '', '', '','0'); ";

54 
	g$dsql
->
ExecuNeQuy
(
$admquy
);

56 
	g$admquy
 = "INSERT INTO `#@__member_tj` (`mid`,`article`,`album`,`archives`,`homecount`,`pagecount`,`feedback`,`friend`,`stow`)

57 
VALUES
 ('$mid','0','0','0','0','0','0','0','0'); ";

58 
	g$dsql
->
ExecuNeQuy
(
$admquy
);

60 
	g$admquy
 = "Insert Into `#@__member_space`(`mid` ,`pagesize` ,`matt` ,`spacename` ,`spacelogo` ,`spacestyle`, `sign` ,`spacenews`)

61 
Vues
('$mid','10','0','{$uname}的空间','','person','',''); ";

62 
	g$dsql
->
ExecuNeQuy
(
$admquy
);

64 
ShowMsg
('成功增加一个用户！', 'sys_admin_user.php');

65 
ex
();

67 
	g$ndcode
 = 
mt_nd
(10000, 99999);

68 
	g$code
 = 
subr
(
md5
(
$cfg_cook_code
.
$ndcode
), 0, 24);

69 
	g$tyOis
 = '';

70 
	g$dsql
->
SQuy
(" Select id,typename From `#@__arctype` whereeid=0 And (ispart=0 Or ispart=1) ");

71 
	g$dsql
->
Execu
('op');

72 
	g$row
 = 
$dsql
->
GObje
('op'))

74 
$tc
 = 
$row
->
id
;

75 
	g$tyOis
 .= "<option value='{$row->id}' class='btype'>{$row->typename}</option>\r\n";

76 
	g$dsql
->
SQuy
(" Select id,typename From `#@__arctype` whereeid={$row->id} And (ispart=0 Or ispart=1) ");

77 
	g$dsql
->
Execu
('s');

78 
	g$row
 = 
$dsql
->
GObje
('s'))

80 
$tyOis
 .= "<option value='{$row->id}' class='stype'>—{$row->typename}</option>\r\n";

84 
ude
 
DedeInude
('templets/sys_admin_user_add.htm');

	@dede/sys_admin_user_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('sys_User');

4 
que_
(
DEDEINC
.'/typelink.class.php');

5 if(
emy
(
$do
)
	g$do
 = '';

6 
	g$id
 = 
eg_a
('[^0-9]','',
$id
);

8 if(
	g$do
=='saveedit')

10 
$pwd
 = 
im
($pwd);

11 if(
	g$pwd
!='' && 
eg
("[^0-9a-zA-Z_@!\.-]",
$pwd
))

13 
ShowMsg
('密码不合法，请使用[0-9a-zA-Z_@!.-]内的字符！','-1',0,3000);

14 
ex
();

16 
	g$codeok
 = 
subr
(
md5
(
$cfg_cook_code
.
$ndcode
),0,24);

17 if(
	g$codeok
!=
$code
)

19 
ShowMsg
("请填写正确的安全验证串！","sys_admin_user_edit.php?id={$id}&dopost=edit");

20 
ex
();

22 
	g$pwdm
 = '';

23 if(
	g$pwd
!='')

25 
$pwdm
 = ",pwd='".
md5
(
$pwd
)."'";

26 
	g$pwd
 = ",pwd='".
subr
(
md5
(
$pwd
),5,20)."'";

28 
	g$tyid
 = 
jo
(',', 
$tyids
);

29 if(
	g$tyid
=='0'
$tyid
 = '';

30 if(
	g$id
!=1)

32 
$quy
 = "Update `#@__admin` set uname='$uname',usertype='$usertype',tname='$tname',email='$email',typeid='$typeid' $pwd where id='$id'";

36 
	g$quy
 = "Update `#@__admin` set uname='$uname',tname='$tname',email='$email',typeid='$typeid' $pwd where id='$id'";

38 
	g$dsql
->
ExecuNeQuy
(
$quy
);

39 
	g$quy
 = "Update `#@__member` set uname='$uname',email='$email'$pwdm where mid='$id'";

40 
	g$dsql
->
ExecuNeQuy
(
$quy
);

41 
ShowMsg
("成功更改一个帐户！","sys_admin_user.php");

42 
ex
();

44 if(
	g$do
=='delete')

46 if(
emy
(
$urok
))

48 
$urok
="";

50 if(
	g$urok
!="yes")

52 
$ndcode
 = 
mt_nd
(10000,99999);

53 
	g$code
 = 
subr
(
md5
(
$cfg_cook_code
.
$ndcode
),0,24);

54 
que_
(
DEDEINC
."/oxwindow.class.php");

55 
	g$wt
 = "删除用户";

56 
	g$wecome_fo
 = "<a href='sys_admin_user.php'>系统帐号管理</a>::删除用户";

57 
	g$w
 = 
w
 
OxWdow
();

58 
	g$w
->
In
("sys_admin_user_edit.php","js/blank.js","POST");

59 
	g$w
->
AddHidd
("do",
$do
);

60 
	g$w
->
AddHidd
("userok","yes");

61 
	g$w
->
AddHidd
("ndcode",
$ndcode
);

62 
	g$w
->
AddHidd
("code",
$code
);

63 
	g$w
->
AddHidd
("id",
$id
);

64 
	g$w
->
AddT
("系统警告！");

65 
	g$w
->
AddMsgIm
("你确信要删除用户：$userid 吗？","50");

66 
	g$w
->
AddMsgIm
("安全验证串：<inputame='safecode'ype='text' id='safecode' size='16' style='width:200px' />&nbsp;(复制本代码： <font color='red'>$safecode</font> )","30");

67 
	g$wfm
 = 
$w
->
GWdow
("ok");

68 
	g$w
->
Diy
();

69 
ex
();

71 
	g$codeok
 = 
subr
(
md5
(
$cfg_cook_code
.
$ndcode
),0,24);

72 if(
	g$codeok
!=
$code
)

74 
ShowMsg
("请填写正确的安全验证串！","sys_admin_user.php");

75 
ex
();

79 
	g$rs
 = 
$dsql
->
ExecuNeQuy2
("DFrom `#@__adm` whid='$id' And id<>1 And id<>'".
$curLog
->
gUrID
()."' ");

80 if(
	g$rs
>0)

83 
	g$dsql
->
ExecuNeQuy
("Update `#@__member` set matt='0' where mid='$id'imit 1");

84 
ShowMsg
("成功删除一个帐户！","sys_admin_user.php");

88 
ShowMsg
("不能删除id为1的创建人帐号，不能删除自己！","sys_admin_user.php",0,3000);

90 
ex
();

94 
	g$ndcode
 = 
mt_nd
(10000,99999);

95 
	g$code
 = 
subr
(
md5
(
$cfg_cook_code
.
$ndcode
),0,24);

96 
	g$tyOis
 = '';

97 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__admin` where id='$id'");

98 
	g$tyids
 = 
exode
(',', 
$row
['typeid']);

99 
	g$dsql
->
SQuy
("Select id,typename From `#@__arctype` whereeid=0 And (ispart=0 Or ispart=1)");

100 
	g$dsql
->
Execu
('op');

101 
	g$ow
 = 
$dsql
->
GObje
('op'))

103 
$tyOis
 ."<ti vue='{$ow->id}' css='bty'".(
_y
(
$ow
->
id
, 
$tyids
) ? ' selected' : '').">{$nrow->typename}</option>\r\n";

104 
	g$dsql
->
SQuy
("Select id,typename From #@__arctype whereeid={$nrow->id} And (ispart=0 Or ispart=1)");

105 
	g$dsql
->
Execu
('s');

106 
	g$ow
 = 
$dsql
->
GObje
('s'))

108 
$tyOis
 ."<ti vue='{$ow->id}' css='y'".(
_y
(
$ow
->
id
, 
$tyids
) ? ' selected' : '').">—{$nrow->typename}</option>\r\n";

111 
ude
 
DedeInude
('templets/sys_admin_user_edit.htm');

	@dede/sys_admin_user_tj.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_User');

6 if(
ist
(
$do
&& 
	g$do
=='getone')

8 
$row
 = 
$dsql
->
GO
("Select userid From `#@__admin` where id='$uid'; ");

9 
	g$urid
 = 
$row
['userid'];

10 
	g$y
 = 
tv
(
MyDe
('Y', 
time
()));

11 
	g$m
 = 
tv
(
MyDe
('m', 
time
()));

12 
	g$d
 = 
tv
(
MyDe
('d', 
time
()));

14 
	g$row
 = 
$dsql
->
GO
("Select count(id)s dd,sum(click)s cc From `#@__archives` where mid='$uid'; ");

15 
	g$dd
 = 
$row
['dd'];

16 
	g$cc
 = 
$row
['cc'];

18 
	g$ime
 = 0;

19 if
eg
("[123]", 
$m
&& 
	g$m
 < 10
	g$ime
 = 
$y
."-01-01 00:00:00";

20 if
eg
("[456]", 
$m

	g$ime
 = 
$y
."-04-01 00:00:00";

21 if
eg
("[789]", 
$m

	g$ime
 = 
$y
."-07-01 00:00:00";

22 
	g$ime
 = 
$y
."-10-01 00:00:00";

23 
	g$iime
 = 
GMkTime
(
$ime
);

24 
	g$row
 = 
$dsql
->
GO
("Select count(id)s dd,sum(click)s cc From `#@__archives` where senddate>$istarttime And mid='$uid'; ");

25 
	g$dds
 = 
$row
['dd'];

26 
	g$ccs
 = 
$row
['cc'];

28 
	g$ime
 = 
$y
."-{$m}-01 00:00:00";

29 
	g$iime
 = 
GMkTime
(
$ime
);

30 
	g$row
 = 
$dsql
->
GO
("Select count(id)s dd,sum(click)s cc From `#@__archives` where senddate>$istarttime And mid='$uid'; ");

31 
	g$ddm
 = 
$row
['dd'];

32 
	g$ccm
 = 
$row
['cc'];

34 
	g$ime
 = 
$y
."-{$m}-{$d} 00:00:00";

35 
	g$iime
 = 
GMkTime
(
$ime
) - (7*24*3600);

36 
	g$row
 = 
$dsql
->
GO
("Select count(id)s dd,sum(click)s cc From `#@__archives` where senddate>$istarttime And mid='$uid'; ");

37 
	g$ddw
 = 
$row
['dd'];

38 
	g$ccw
 = 
$row
['cc'];

40 
	g$ime
 = 
$y
."-{$m}-{$d} 00:00:00";

41 
	g$iime
 = 
GMkTime
(
$ime
);

42 
	g$row
 = 
$dsql
->
GO
("Select count(id)s dd,sum(click)s cc From `#@__archives` where senddate>$istarttime And mid='$uid'; ");

43 
	g$ddd
 = 
$row
['dd'];

44 
	g$ccd
 = 
$row
['cc'];

46 
	g$msg
 = "<table width='96%' border='0'lign='center' cellpadding='3' cellspacing='1' bgcolor='#C4DB8C'>

47 <

 
ign
='' 
bgc
='#ECFCD1'>

48 <
td
 
width
='18%' 
height
='26'><
rg
>管理员↓|统计信息→</strong></td>

49 <
td
 
width
='18%'><
rg
>全部(文档|点击)</strong></td>

50 <
td
 
width
='16%'><
rg
>季度</strong></td>

51 <
td
 
width
='16%'><
rg
>当月</strong></td>

52 <
td
 
width
='16%'><
rg
>近七天</strong></td>

53 <
td
 
width
='16%'><
rg
>当天</strong></td>

54 </

>

55 <

 
ign
='' 
bgc
='#FFFFFF'>

56 <
td
 
height
='26'>{
$urid
}</td>

57 <
td
>{
$dd
} | {
$cc
}</td>

58 <
td
>{
$dds
} | {
$ccs
}</td>

59 <
td
>{
$ddm
} | {
$ccm
}</td>

60 <
td
>{
$ddw
} | {
$ccw
}</td>

61 <
td
>{
$ddd
} | {
$ccd
}</td>

62 </

>

63 </
b
><
br
 
y
='r:bh'/>\
r
\
n
";

64 
AjaxHd
();

65 
echo
 
	g$msg
;

66 
ex
();

70 
ude
 
DedeInude
('templets/sys_admin_user_tj.htm');

	@dede/sys_cache_up.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_ArcBatch');

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

8 if(
	$emy
(
$
))

10 
$
 = 1;

11 
	}
}

12 if(
	g$do
=="ok")

14 if(
emy
(
$urc
))

16 
$urc
 = 0;

18 if(
	g$
==-1)

20 if(
$urc
==0)

22 
p
(1);

24 
ShowMsg
("成功更新所有缓存！","javascript:;");

25 
ex
();

29 if(
	g$
==1)

31 
UpDeCCache
();

32 
ShowMsg
("成功更新栏目缓存，准备更新枚举缓存...","sys_cache_up.php?dopost=ok&step=2&uparc=$uparc");

33 
ex
();

37 if(
	g$
==2)

39 
ude_
(
DEDEINC
."/enums.func.php");

40 
WreEnumsCache
();

42 
ShowMsg
("成功更新枚举缓存，准备更新调用缓存...","sys_cache_up.php?dopost=ok&step=3&uparc=$uparc");

43 
ex
();

47 if(
	g$
==3)

49 
echo
 '<mhp-equiv="Cڋ-Ty" cڋ="xt/html; cht='.
$cfg_so_ng
.'">';

50 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arccache`");

51 
	gecho
 "\n成功更新arclist调用缓存，准备清理过期会员访问历史...<hr />";

52 
	g$dtime
 = 
time
() - (90 * 24 * 3600);

53 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_vhistory` where vtime<'$oldtime' ");

54 
	gecho
 "成功清理过期会员访问历史，准备清理过期短信...<hr />";

55 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_pms` where sendtime<'$oldtime' ");

56 
	gecho
 "成功清理过期短信，准备修正错误文档，这可能要占较长的时间...";

57 if(
	g$urc
==1)

59 
echo
 "<scriptanguage='javascript'>location='sys_cache_up.php?dopost=ok&step=9';</script>";

63 
	gecho
 "<scriptanguage='javascript'>location='sys_cache_up.php?dopost=ok&step=-1&uparc=$uparc';</script>";

65 
ex
();

68 if(
	g$
==9)

70 
ShowMsg
('修正错误文档操作已经取消，请在&lt;系统-&gt;系统错误修复[S]&gt;中操作...','sys_cache_up.php?dopost=ok&step=-1&uparc=1',0,5000);

71 
ex
();

74 
ude
 
DedeInude
('templets/sys_cache_up.htm');

	@dede/sys_data.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Data');

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

8 if(
	g$do
=="viewinfo")

10 
echo
 "[<a href='#' onclick='javascript:HideObj(\"_mydatainfo\")'><u>关闭</u></a>]\r\n<xmp>";

11 if(
emy
(
$bme
))

13 
	gecho
 "没有指定表名！";

17 
	g$dsql
->
SQuy
("SHOW CREATE TABLE ".
$dsql
->
dbName
.".".
$bme
);

18 
	g$dsql
->
Execu
('me');

19 
	g$row2
 = 
$dsql
->
GAay
('me',
MYSQL_BOTH
);

20 
	g$fo
 = 
$row2
[1];

21 
echo
 
im
(
$fo
);

23 
	gecho
 '</xmp>';

24 
ex
();

26 if(
	g$do
=="opimize")

28 
echo
 "[<a href='#' onclick='javascript:HideObj(\"_mydatainfo\")'><u>关闭</u></a>]\r\n<xmp>";

29 if(
emy
(
$bme
))

31 
	gecho
 "没有指定表名！";

35 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("OPTIMIZE TABLE `$tablename` ");

36 if(
	g$rs
)

38 
	gecho
 "执行优化表： $tablename OK！";

42 
	gecho
 "执行优化表： $bm 失败，原因是：".
	g$dsql
->
GE
();

45 
	gecho
 '</xmp>';

46 
ex
();

48 if(
	g$do
=="repair")

50 
echo
 "[<a href='#' onclick='javascript:HideObj(\"_mydatainfo\")'><u>关闭</u></a>]\r\n<xmp>";

51 if(
emy
(
$bme
))

53 
	gecho
 "没有指定表名！";

57 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("REPAIR TABLE `$tablename` ");

58 if(
	g$rs
)

60 
	gecho
 "修复表： $tablename OK！";

64 
	gecho
 "修复表： $bm 失败，原因是：".
	g$dsql
->
GE
();

67 
	gecho
 '</xmp>';

68 
ex
();

72 
	g$hTabs
 = 
Aay
();

73 
	g$dedeSysTabs
 = 
Aay
();

74 
	g$chlTabs
 = 
Aay
();

75 
	g$dsql
->
SQuy
("Selectddtable From `#@__channeltype` ");

76 
	g$dsql
->
Execu
();

77 
	g$row
 = 
$dsql
->
	$GObje
())

79 
$chlTabs
[] = 
$row
->
addb
;

80 
	}
}

81 
	g$dsql
->
SQuy
("Show Tables");

82 
	g$dsql
->
Execu
('t');

83 
	g$row
 = 
$dsql
->
GAay
('t',
MYSQL_BOTH
))

85 if(
eg
("^{$cfg_dbefix}",
$row
[0])||
_y
($row[0],
$chlTabs
))

87 
	g$dedeSysTabs
[] = 
$row
[0];

91 
	g$hTabs
[] = 
$row
[0];

94 
	g$mysql_vsi
 = 
$dsql
->
GVsi
();

95 
ude
 
DedeInude
('templets/sys_data.htm');

97 
funi
 
	$TjCou
(
$tbme
,&
$dsql
)

99 
$row
 = 
$dsql
->
	`GO
("Select count(*)s dd From $tbname");

100  
$row
['dd'];

101 
	}
}

	@dede/sys_data_done.php

1 <?
	gphp


2 @
ob_t
();

3 @
t_time_lim
(0);

4 
que_
(
dme
(
__FILE__
).'/config.php');

6 
CheckPurvw
('sys_Data');

8 if(
	$emy
(
$do
))

10 
$do
 = '';

11 
	}
}

13 
	g$bkd
 = 
DEDEDATA
.'/'.
$cfg_backup_d
;

16 
	g$gojs
 = "function GotoNextPage(){

17 
documt
.
gext
."."
subm
();

18 }"."\
	gr
\
	gnt
"."
Timeout
('GotoNextPage()',500);";

20 
	g$dojs
 = "<scriptanguage='javascript'>$gotojs</script>";

26 if(
	g$do
=='bak')

28 if(
emy
(
$bˬr
))

30 
ShowMsg
('你没选中任何表！','javascript:;');

31 
ex
();

33 if(!
is_d
(
$bkd
))

35 
MkdA
(
$bkd
,
$cfg_d_purvw
);

36 
CloF
();

40 
	g$bs
 = 
exode
(',',
$bˬr
);

41 if(!
ist
(
$isru
))

43 
	g$isru
 = 0;

45 if(!
ist
(
$os
))

47 
	g$os
 = 0;

49 if(!
ist
(
$isz
))

51 
	g$isz
 = 0;

53 if(
emy
(
$nowb
))

55 
	g$nowb
 = '';

57 if(
emy
(
$fsize
))

59 
	g$fsize
 = 2048;

61 
	g$fsizeb
 = 
$fsize
 * 1024;

64 if(
	g$nowb
=='')

66 
$tmsg
 = '';

67 
	g$dh
 = 
d
(
$bkd
);

68 
	g$fame
=
$dh
->
ad
())

70 if(!
eg
("txt$",
$fame
))

74 
	g$fame
 = 
$bkd
."/$filename";

75 if(!
is_d
(
$fame
))

77 
uƚk
(
$fame
);

80 
	g$dh
->
o
();

81 
	g$tmsg
 .= "清除备份目录旧数据完成...<br />";

83 if(
	g$isru
==1)

85 
$bkfe
 = 
$bkd
."/bs_ru_".
subr
(
md5
(
time
().
mt_nd
(1000,5000).
$cfg_cook_code
),0,16).".txt";

86 
	g$mysql_vsi
 = 
$dsql
->
GVsi
();

87 
	g$
 = 
fݒ
(
$bkfe
,"w");

88 
fܗch
(
$bs
 
as
 
$t
)

90 
fwre
(
$
,"DROP TABLE IF EXISTS `$t`;\r\n\r\n");

91 
	g$dsql
->
SQuy
("SHOW CREATE TABLE ".
$dsql
->
dbName
.".".
$t
);

92 
	g$dsql
->
Execu
('me');

93 
	g$row
 = 
$dsql
->
GAay
('me',
MYSQL_BOTH
);

96 
	g$row
[1] = 
egi_a
("AUTO_INCREMENT=([0-9]{1,})[ \r\n\t]{1,}","",
$row
[1]);

99 if(
	g$dy
==4.0 && 
$mysql_vsi
 > 4.0)

101 
$g1
 = "ENGINE=MyISAM[ \r\n\t]{1,}DEFAULT[ \r\n\t]{1,}CHARSET=".
$cfg_db_nguage
;

102 
	g$bSu
 = 
egi_a
(
$g1
,"TYPE=MyISAM",
$row
[1]);

106 if(
	g$dy
==4.1 && 
$mysql_vsi
 < 4.1)

108 
$g1
 = "ENGINE=MyISAM DEFAULT CHARSET={$cfg_db_language}";

109 
	g$bSu
 = 
egi_a
("TYPE=MyISAM",
$g1
,
$row
[1]);

115 
	g$bSu
 = 
$row
[1];

117 
fwre
(
$
,''.
$bSu
.";\r\n\r\n");

119 
fo
(
$
);

120 
	g$tmsg
 .= "备份数据表结构信息完成...<br />";

122 
	g$tmsg
 .= "<font color='red'>正在进行数据备份的初始化工作，请稍后...</font>";

123 
	g$deFm
 = "<formame='gonext' method='post'ction='sys_data_done.php'>

124 <
put
 
ty
='hidd' 
me
='isru' 
vue
='$isstruct' />

125 <
put
 
ty
='hidd' 
me
='do' 
vue
='bak' />

126 <
put
 
ty
='hidd' 
me
='fsize' 
vue
='$fsize' />

127 <
put
 
ty
='hidd' 
me
='bˬr' 
vue
='$tablearr' />

128 <
put
 
ty
='hidd' 
me
='nowb' 
vue
='{$tables[0]}' />

129 <
put
 
ty
='hidd' 
me
='os' 
vue
='0' />

130 <
put
 
ty
='hidd' 
me
='isz' 
vue
='$isz' />\
r
\
n
</
fm
>\r\n{
$dojs
}\r\n";

131 
PutInfo
(
$tmsg
,
$deFm
);

132 
ex
();

138 
	g$j
 = 0;

139 
	g$fs
 = 
$bakS
 = '';

142 
	g$dsql
->
GTabFlds
(
$nowb
);

143 
	g$b
 = "INSERT INTO `$nowtable` VALUES(";

144 
	g$r
 = 
$dsql
->
GFldObje
())

146 
$fs
[
$j
] = 
im
(
$r
->
me
);

147 
	g$j
++;

149 
	g$fsd
 = 
$j
-1;

152 
	g$dsql
->
SQuy
("Select * From `$nowtable` ");

153 
	g$dsql
->
Execu
();

154 
	g$m
 = 0;

155 
	g$bakfame
 = "$bkd/{$nowb}_{$os}_".
subr
(
md5
(
time
().
mt_nd
(1000,5000).
$cfg_cook_code
),0,16).".txt";

156 
	g$row2
 = 
$dsql
->
GAay
())

158 if(
$m
 < 
$os
)

160 
$m
++;

165 if(

(
$bakS
> 
	g$fsizeb
)

167 
	g$
 = 
fݒ
(
$bakfame
,"w");

168 
fwre
(
$
,
$bakS
);

169 
fo
(
$
);

170 
	g$tmsg
 = "<font color='red'>完成到{$m}条记录的备份，继续备份{$nowtable}...</font>";

171 
	g$deFm
 = "<formame='gonext' method='post'ction='sys_data_done.php'>

172 <
put
 
ty
='hidd' 
me
='isru' 
vue
='$isstruct' />

173 <
put
 
ty
='hidd' 
me
='do' 
vue
='bak' />

174 <
put
 
ty
='hidd' 
me
='fsize' 
vue
='$fsize' />

175 <
put
 
ty
='hidd' 
me
='bˬr' 
vue
='$tablearr' />

176 <
put
 
ty
='hidd' 
me
='nowb' 
vue
='$nowtable' />

177 <
put
 
ty
='hidd' 
me
='os' 
vue
='$m' />

178 <
put
 
ty
='hidd' 
me
='isz' 
vue
='$isz' />\
r
\
n
</
fm
>\r\n{
$dojs
}\r\n";

179 
PutInfo
(
$tmsg
,
$deFm
);

180 
ex
();

184 
	g$le
 = 
$b
;

185 
	g$j
=0;$j<=
$fsd
;$j++)

187 if(
	g$j
 < 
	g$fsd
)

189 
	g$le
 ."'".
RpLe
(
addashes
(
$row2
[
$fs
[
$j
]]))."',";

193 
	g$le
 ."'".
RpLe
(
addashes
(
$row2
[
$fs
[
$j
]]))."');\r\n";

196 
	g$m
++;

197 
	g$bakS
 .
$le
;

201 if(
	g$bakS
!='')

203 
$
 = 
fݒ
(
$bakfame
,"w");

204 
fwre
(
$
,
$bakS
);

205 
fo
(
$
);

207 
	g$i
=0;$i<
cou
(
$bs
);$i++)

209 if(
	g$bs
[
$i
]==
$nowb
)

211 if(
ist
(
$bs
[
$i
+1]))

213 
$nowb
 = 
$bs
[
$i
+1];

214 
	g$os
 = 0;

218 
PutInfo
("完成所有数据备份！","");

219 
ex
();

223 
	g$tmsg
 = "<font color='red'>完成到{$m}条记录的备份，继续备份{$nowtable}...</font>";

224 
	g$deFm
 = "<formame='gonext' method='post'ction='sys_data_done.php?dopost=bak'>

225 <
put
 
ty
='hidd' 
me
='isru' 
vue
='$isstruct' />

226 <
put
 
ty
='hidd' 
me
='fsize' 
vue
='$fsize' />

227 <
put
 
ty
='hidd' 
me
='bˬr' 
vue
='$tablearr' />

228 <
put
 
ty
='hidd' 
me
='nowb' 
vue
='$nowtable' />

229 <
put
 
ty
='hidd' 
me
='os' 
vue
='$os'>\
r
\
n
</
fm
>\r\n{
$dojs
}\r\n";

230 
PutInfo
(
$tmsg
,
$deFm
);

231 
ex
();

240 if(
	g$do
=='redat')

242 if(
$bakfes
=='')

244 
ShowMsg
('没指定任何要还原的文件!','javascript:;');

245 
ex
();

247 
	g$bakfesTmp
 = 
$bakfes
;

248 
	g$bakfes
 = 
exode
(',',
$bakfes
);

249 if(
emy
(
$rufe
))

251 
	g$rufe
 = "";

253 if(
emy
(
$dfe
))

255 
	g$dfe
 = 0;

257 if(
emy
(
$tgo
))

259 
	g$tgo
 = 0;

261 if(
	g$tgo
==0 && 
$rufe
!='')

263 
$tbda
 = '';

264 
	g$
 = 
fݒ
("$bkdir/$structfile",'r');

265 !
of
(
$
))

267 
	g$tbda
 .
fgs
(
$
,1024);

269 
fo
(
$
);

270 
	g$quys
 = 
exode
(';',
$tbda
);

272 
fܗch
(
$quys
 
as
 
$q
)

274 
	g$dsql
->
ExecuNeQuy
(
im
(
$q
).';');

276 if(
	g$dfe
==1)

278 @
uƚk
("$bkdir/$structfile");

280 
	g$tmsg
 = "<font color='red'>完成数据表信息还原，准备还原数据...</font>";

281 
	g$deFm
 = "<formame='gonext' method='post'ction='sys_data_done.php?dopost=redat'>

282 <
put
 
ty
='hidd' 
me
='tgo' 
vue
='1' />

283 <
put
 
ty
='hidd' 
me
='dfe' 
vue
='$delfile' />

284 <
put
 
ty
='hidd' 
me
='bakfes' 
vue
='$bakfilesTmp' />

285 </
fm
>\
r
\
n
{
$dojs
}\r\n";

286 
PutInfo
(
$tmsg
,
$deFm
);

287 
ex
();

291 
	g$nowfe
 = 
$bakfes
[0];

292 
	g$bakfesTmp
 = 
eg_a
(
$nowfe
."[,]{0,1}","",
$bakfesTmp
);

293 
	g$oknum
=0;

294 if
fesize
("$bkdir/$nowfile") > 0 )

296 
	g$
 = 
fݒ
("$bkdir/$nowfile",'r');

297 !
of
(
$
))

299 
	g$le
 = 
im
(
fgs
(
$
,512*1024));

300 if(
	g$le
=="")

304 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$le
);

305 if(
	g$rs
)

307 
	g$oknum
++;

310 
fo
(
$
);

312 if(
	g$dfe
==1)

314 @
uƚk
("$bkdir/$nowfile");

316 if(
	g$bakfesTmp
=="")

318 
ShowMsg
('成功还原所有的文件的数据!','javascript:;');

319 
ex
();

321 
	g$tmsg
 = "成功还原{$nowfile}的{$oknum}条记录<br/><br/>正在准备还原其它数据...";

322 
	g$deFm
 = "<formame='gonext' method='post'ction='sys_data_done.php?dopost=redat'>

323 <
put
 
ty
='hidd' 
me
='tgo' 
vue
='1' />

324 <
put
 
ty
='hidd' 
me
='dfe' 
vue
='$delfile' />

325 <
put
 
ty
='hidd' 
me
='bakfes' 
vue
='$bakfilesTmp' />

326 </
fm
>\
r
\
n
{
$dojs
}\r\n";

327 
PutInfo
(
$tmsg
,
$deFm
);

328 
ex
();

332 
funi
 
	$PutInfo
(
$msg1
,
$msg2
)

334 
glob
 
$cfg_d_purvw
;

335 
$msgfo
 = "<html>\n<head>

336 <
ma
 
hp
-
equiv
='Cڋ-Ty' 
cڋ
='text/html; charset=utf-8' />

337 <
t
>
DEDECMS
 提示信息</title>

338 <
ba
 
rg
='_lf'/>\
n
</
hd
>\n<
body
 
mg
='0' 
tmg
='0'>\n<

>

339 <
br
/>

340 <
div
 
y
='width:400px;ddg-t:4px;height:24;ft-size:10;bd-:1px sid #cccccc;bd-t:1px sid #cccccc;bd-right:1px sid #cccccc;background-c:#DBEEBD;'>
DEDECMS
 提示信息！</div>

341 <
div
 
y
='width:400px;height:100px;font-size:10pt;border:1px solid #cccccc;background-color:#F4FAEB'>

342 <

 
y
='le-height:160%'><
br
/>{
$msg1
}</span>

343 <
br
/><br/></
div
>\
r
\
n
{
$msg2
}";

344 
echo
 
$msgfo
."</center>\n</body>\n</html>";

345 
	}
}

347 
funi
 
	$RpLe
(
$r
)

349 
$r
 = 
	`r_a
("\r","\\r",$str);

350 
$r
 = 
	`r_a
("\n","\\n",$str);

351  
$r
;

352 
	}
}

	@dede/sys_data_replace.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('sys_Data');

4 if(
	$emy
(
$ai
))

6 
$ai
 = '';

7 
	}
}

8 if(
	$emy
(
$ai
))

10 
	`que_
(
DEDEADMIN
."/templets/sys_data_replace.htm");

11 
	`ex
();

12 
	}
}

18 if(
	g$ai
=='getfields')

20 
AjaxHd
();

21 
	g$dsql
->
GTabFlds
(
$exab
);

22 
	gecho
 "<div style='border:1px solid #ababab;background-color:#FEFFF0;margin-top:6px;padding:3px;line-height:160%'>";

23 
	gecho
 "表(".
	g$exab
.")含有的字段：<br>";

24 
	g$row
 = 
$dsql
->
GFldObje
())

26 
echo
 "<hf=\"javast:pf('{$row->me}')\"><u>".
$row
->
me
."</u></a>\r\n";

28 
	gecho
 "</div>";

29 
ex
();

36 if(
	g$ai
=='apply')

38 
$vide
 = 
emy
($vide? '' : 
ow
($validate);

39 
	g$svi
 = 
GCkVdVue
();

40 if(
	g$vide
=="" || 
$vide
!=
$svi
)

42 
ShowMsg
("安全确认码不正确!","javascript:;");

43 
ex
();

45 if(
	g$exab
==''||
$fld
=='')

47 
ShowMsg
("请指定数据表和字段！","javascript:;");

48 
ex
();

50 if(
	g$rg
=='')

52 
ShowMsg
("请指定被替换内容！","javascript:;");

53 
ex
();

55 if(
	g$ty
=='replace')

57 
$cdi
 = 
emy
($condition) ? '' : " where $condition ";

58 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("Update $exptable set $rpfield=Replace($rpfield,'$rpstring','$tostring') $condition ");

59 
	g$dsql
->
execunequy
("OPTIMIZE TABLE `$exptable`");

60 if(
	g$rs
)

62 
ShowMsg
("成功完成数据替换！","javascript:;");

63 
ex
();

67 
ShowMsg
("数据替换失败！","javascript:;");

68 
ex
();

73 
	g$cdi
 = 
emy
(
$cdi
) ? '' : " And $condition ";

74 
	g$rg
 = 
rashes
(
$rg
);

75 
	g$rg2
 = 
r_a
("\\","\\\\",
$rg
);

76 
	g$rg2
 = 
r_a
("'","\\'",
$rg2
);

77 
	g$dsql
->
SQuy
("Select $keyfield,$rpfield From $exptable where $rpfield REGEXP '$rpstring2' $condition ");

78 
	g$dsql
->
Execu
();

79 
	g$
 = 
$dsql
->
GTٮRow
();

80 if(
	g$
==0)

82 
ShowMsg
("根据你指定的正则，找不到任何东西！","javascript:;");

83 
ex
();

85 
	g$oo
 = 0;

86 
	g$row
 = 
$dsql
->
GAay
())

88 
$kid
 = 
$row
[
$keyfld
];

89 
	g$f
 = 
egi_a
(
$rg
,
$torg
,
$row
[
$fld
]);

90 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("Update $exptable set $rpfield='$rpf' where $keyfield='$kid' ");

91 if(
	g$rs
)

93 
	g$oo
++;

96 
	g$dsql
->
execunequy
("OPTIMIZE TABLE `$exptable`");

97 
ShowMsg
("共找到 $tt 条记录，成功替换了 $oo 条！","javascript:;");

98 
ex
();

	@dede/sys_data_revert.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Data');

4 
	g$bkd
 = 
DEDEDATA
."/".
$cfg_backup_d
;

5 
	g$fis
 = 
Aay
();

6 
	g$dh
 = 
d
(
$bkd
);

7 
	g$rufe
 = "没找到数据结构文件";

8 (
	g$fame
=
$dh
->
ad
()!=
l
)

10 if(!
eg
('txt$',
$fame
))

14 if(
eg
('bs_ru',
$fame
))

16 
	g$rufe
 = 
$fame
;

18 if
fesize
("$bkdir/$filename") >0 )

20 
	g$fis
[] = 
$fame
;

23 
	g$dh
->
o
();

24 
ude
 
DedeInude
('templets/sys_data_revert.htm');

	@dede/sys_group.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Group');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

8 
ude
 
DedeInude
('templets/sys_group.htm');

	@dede/sys_group_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Group');

4 if(!
	$emy
(
$do
))

6 
$row
 = 
$dsql
->
	`GO
("Se * From #@__admty whnk='".
$nkid
."'");

7 if(
	`is_y
(
$row
))

9 
	`ShowMsg
("你所创建的组别的级别值已存在，不允许重复!","-1");

10 
	`ex
();

12 if(
$nkid
 > 10)

14 
	`ShowMsg
('组级别值不能大于10， 否则一切权限设置均无效!', '-1');

15 
	`ex
();

17 
$APurvws
 = '';

18 if(
	`is_y
(
$purvws
))

20 
	`fܗch
(
$purvws
 
as
 
$pur
)

22 
$APurvws
 = 
$pur
.' ';

24 
$APurvws
 = 
	`im
($AllPurviews);

26 
$dsql
->
	`ExecuNeQuy
("INSERT INTO #@__admintype(rank,typename,system,purviews) VALUES ('$rankid','$groupname', 0, '$AllPurviews');");

27 
	`ShowMsg
("成功创建一个新的用户组!","sys_group.php");

28 
	`ex
();

29 
	}
}

30 
ude
 
DedeInude
('templets/sys_group_add.htm');

	@dede/sys_group_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Group');

4 if(
	$emy
(
$do
))

6 
$do
 = '';

7 
	}
}

8 if(
	g$do
=='save')

10 if(
$nk
==10)

12 
ShowMsg
("超级管理员的权限不允许更改!","sys_group.php");

13 
ex
();

15 
	g$purvw
 = "";

16 if(
is_y
(
$purvws
))

18 
fܗch
(
$purvws
 
as
 
$p
)

20 
	g$purvw
 .= "$p ";

22 
	g$purvw
 = 
im
(
$purvw
);

24 
	g$dsql
->
ExecuNeQuy
("Update #@__admintype setypename='$typename',purviews='$purview' where CONCAT(`rank`)='$rank'");

25 
ShowMsg
("成功更改用户组的权限!","sys_group.php");

26 
ex
();

28 if(
	g$do
=='del')

30 
$dsql
->
ExecuNeQuy
("Delete From #@__admintype where CONCAT(`rank`)='$rank' And system='0';");

31 
ShowMsg
("成功删除一个用户组!","sys_group.php");

32 
ex
();

34 
	g$groupRks
 = 
Aay
();

35 
	g$groupS
 = 
$dsql
->
GO
("Select * From `#@__admintype` where CONCAT(`rank`)='{$rank}' ");

36 
	g$groupRks
 = 
exode
(' ',
$groupS
['purviews']);

37 
ude
 
DedeInude
('templets/sys_group_edit.htm');

40 
funi
 
	$CRk
(
$n
)

42 
glob
 
$groupRks
;

43  
	`_y
(
$n
,
$groupRks
) ? ' checked' : '';

44 
	}
}

	@dede/sys_info.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Edit');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

8 
	g$cfigfe
 = 
DEDEDATA
.'/config.cache.inc.php';

11 
funi
 
	$ReWreCfig
()

13 
glob
 
$dsql
,
$cfigfe
;

14 if(!
	`is_wrb
(
$cfigfe
))

16 
echo
 "配置文件'{$configfile}'不支持写入，无法修改系统配置参数！";

17 
	`ex
();

19 
$
 = 
	`fݒ
(
$cfigfe
,'w');

20 
	`ock
(
$
,3);

21 
	`fwre
(
$
,"<"."?php\r\n");

22 
$dsql
->
	`SQuy
("Select `varname`,`type`,`value`,`groupid` From `#@__sysconfig` order byidsc ");

23 
$dsql
->
	`Execu
();

24 
$row
 = 
$dsql
->
	`GAay
())

26 if(
$row
['type']=='number')

28 if(
$row
['value']=='') $row['value'] = 0;

29 
	`fwre
(
$
,"\${$row['vme']} = ".
$row
['value'].";\r\n");

33 
	`fwre
(
$
,"\${$row['vme']} = '".
	`r_a
("'",'',
$row
['value'])."';\r\n");

36 
	`fwre
(
$
,"?".">");

37 
	`fo
(
$
);

38 
	}
}

41 if(
	g$do
=="save")

43 
fܗch
(
$_POST
 
as
 
$k
=>
$v
)

45 if(
eg
("^ed___",
$k
))

47 
$v
 = 
_subrR
(
$
{
$k
}, 1024);

53 
	g$k
 = 
eg_a
("^ed___","",
$k
);

54 
	g$dsql
->
ExecuNeQuy
("Update `#@__sysconfig` set `value`='$v' where varname='$k' ");

56 
ReWreCfig
();

57 
ShowMsg
("成功更改站点配置！","sys_info.php");

58 
ex
();

62 if(
	g$do
=='add')

64 if(
$vty
=='bo' && (
$nvvue
!='Y' && $nvarvalue!='N'))

66 
ShowMsg
("布尔变量值必须为'Y'或'N'!","-1");

67 
ex
();

69 if(
im
(
$nvme
)=='' || 
egi
('[^a-z_]', $nvarname) )

71 
ShowMsg
("变量名不能为空并且必须为[a-z_]组成!","-1");

72 
ex
();

74 
	g$row
 = 
$dsql
->
GO
("Select varname From `#@__sysconfig` where varnameike '$nvarname' ");

75 if(
is_y
(
$row
))

77 
ShowMsg
("该变量名称已经存在!","-1");

78 
ex
();

80 
	g$row
 = 
$dsql
->
GO
("Selectid From `#@__sysconfig` order byid desc ");

81 
	g$aid
 = 
$row
['aid']+1;

82 
	g$quy
 = "INSERT INTO `#@__sysconfig`(`aid`,`varname`,`info`,`value`,`type`,`groupid`)

83 
VALUES
 ('$aid','$nvarname','$varmsg','$nvarvalue','$vartype','$vargroup')";

84 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

85 if(!
	g$rs
)

87 
ShowMsg
("新增变量失败，可能有非法字符！","sys_info.php?gp=$vargroup");

88 
ex
();

90 if(!
is_wrb
(
$cfigfe
))

92 
ShowMsg
("成功保存变量，但由于 $configfile 无法写入，因此不能更新配置文件！","sys_info.php?gp=$vargroup");

93 
ex
();

96 
ReWreCfig
();

97 
ShowMsg
("成功保存变量并更新配置文件！","sys_info.php?gp=$vargroup");

98 
ex
();

101 
ude
 
DedeInude
('templets/sys_info.htm');

	@dede/sys_info_mark.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Edit');

4 
que_
(
DEDEINC
."/image.func.php");

5 if(
	g$cfg_pho_sut
=='')

7 
echo
 "你的系统没安装GD库，不允许使用本功能！";

8 
ex
();

10 
	g$ImageWCfigFe
 = 
DEDEDATA
."/mark/inc_photowatermark_config.php";

11 if(
	$emy
(
$ai
))

13 
$ai
 = "";

14 
	}
}

15 if(
	g$ai
=="save")

17 
$vs
 = 
y
('photo_markup','photo_markdown','photo_marktype','photo_wwidth','photo_wheight','photo_waterpos','photo_watertext','photo_fontsize','photo_fontcolor','photo_marktrans','photo_diaphaneity');

18 
	g$cfigr
 = 
$sh܊ame
 = "";

19 
fܗch
(
$vs
 
as
 
$v
)

21 
	g$
{
	g$v
} = 
r_a
("'", "", 
$
{'g_'.
$v
});

22 
	g$cfigr
 ."\${$v} = '".
$
{
$v
}."';\r\n";

24 if(
is_uded_fe
(
$wimg
))

26 
	g$imgfe_ty
 = 
ow
(
im
(
$wimg_ty
));

27 if(!
_y
(
$imgfe_ty
,
$cfg_pho_tymes
))

29 
ShowMsg
("上传的图片格式错误，请使用 {$cfg_photo_support}格式的其中一种！","-1");

30 
ex
();

32 if(
	g$imgfe_ty
=='image/xpng')

34 
$sh܊ame
 = ".png";

36 if(
	g$imgfe_ty
=='image/gif')

38 
$sh܊ame
 = ".gif";

42 
	g$sh܊ame
 = ".gif";

44 
	g$pho_mkimg
 = 'mk'.
$sh܊ame
;

45 @
move_uded_fe
(
$wimg
,
DEDEDATA
."/mk/".
$pho_mkimg
);

47 
	g$cfigr
 .= "\$photo_markimg = '{$photo_markimg}';\r\n";

48 
	g$cfigr
 = "<"."?php\r\n".
$cfigr
."?".">\r\n";

49 
	g$
 = 
fݒ
(
$ImageWCfigFe
,"w"

 
d
("写入文件 $ImageWaterConfigFile 失败，请检查权限！");

50 
fwre
(
$
,
$cfigr
);

51 
fo
(
$
);

52 
	gecho
 "<script>alert('修改配置成功！');</script>\r\n";

54 
que_
(
$ImageWCfigFe
);

55 
ude
 
DedeInude
('templets/sys_info_mark.htm');

	@dede/sys_info_pay.php

1 <?
php


3 
que_
(
dme
(
__FILE__
)."/config.php");

4 
CheckPurvw
('sys_Data');

5 
	g$cfig_fe
 = 
DEDEDATA
.'/sys_pay.cache.php';

6 
	g$mesge
 = '<font color="green">√</font>支付接口配置文件(/data/sys_pay.cache.php)可写.WINDOWS主机不能正常检测可写权限时,请设该文件可写权限!';

7 
	g$rg
 = '';

8 @
touch
(
$cfig_fe
);

9 if(!
is_wrab
(
$cfig_fe
|| !
	$fe_exis
(
$cfig_fe
))

11 
$mesge
 = '<font color="red">×</font>请检查目录/data/sys_pay.cache.php下文件是否有可写权限(0777)!';

12 
	}
}

14 
ude_
 
	gDEDEDATA
.'/sys_pay.cache.php';

16 if(
ist
(
$do
&& 
	g$do
 == 'save')

18 if(!
ist
(
$ymt_
|| 
emy
($payment_select)){

19 
ShowMsg
("选择错误的支付接口类型!","javascript:;");

20 
ex
();

23 if(!
ist
(
$ymt_urid
|| 
emy
($payment_userid)){

24 
ShowMsg
("请填写正确的商户号!","javascript:;");

25 
ex
();

28 
	g$ymt_
 = 
mch_y_rg
(
$_POST
['payment_select']);

30 
	g$ymt_urid
 = 
mch_y_rg
(
$_POST
['payment_userid']);

32 
	g$ymt_ema
 = 
mch_y_rg
(
$_POST
['payment_email']);

34 
	g$ymt_key
 = 
mch_y_rg
(
$_POST
['payment_key']);

36 
	g$ymt_exp
 = 
mch_y_rg
(
$_POST
['payment_exp']);

38 if
	g$cڋ
 = 
fe_g_cڋs
(
$cfig_fe
) ){

40 
$cڋ
 = 
_mch_cfig
($cڋ, '/\$ymt_ \y\(.*?\);/i', '$ymt_ =ay('.
$ymt_
.');');

42 
	g$cڋ
 = 
_mch_cfig
(
$cڋ
, '/\$ymt_urid \y\(.*?\);/i', '$ymt_urid =ay('.
$ymt_urid
.');');

44 
	g$cڋ
 = 
_mch_cfig
(
$cڋ
, '/\$ymt_key \y\(.*?\);/i', '$ymt_key =ay('.
$ymt_key
.');');

46 
	g$cڋ
 = 
_mch_cfig
(
$cڋ
, '/\$ymt_ex\y\(.*?\);/i', '$ymt_exy('.
$ymt_exp
.');');

48 
	g$cڋ
 = 
_mch_cfig
(
$cڋ
, '/\$ymt_ema \y\(.*?\);/i', '$ymt_ema =ay('.
$ymt_ema
.');');

50 
	g$
 = 
fݒ
(
$cfig_fe
,"w+");

51 
fwre
(
$
,
$cڋ
);

52 
fo
(
$
);

53 
ShowMsg
("成功更改支付接口设置!","javascript:;");

54 
ex
();

57 
ShowMsg
("读取配置文件失败!","javascript:;");

58 
ex
();

64 
funi
 
	$_mch_cfig
(
$s
, 
$fd
, 
$a
) {

65 if(
	`eg_mch
(
$fd
, 
$s
)) {

66 
$s
 = 
	`eg_a
(
$fd
, 
$a
, $s);

69 
$s
 ."\r\n".
$a
;

71  
$s
;

72 
	}
}

75 
funi
 
	$mch_y_rg
(
$r
){

76 if(
	`emy
(
$r
))  '';

77 
$rg
 = 
	`y
();

78 
	`fܗch
(
$r
 
as
 
$k
 => 
$v
){

79 
$k
 = (!
	`is_numic
($k)) ? "'$k'" : $k;

80 
$rg
[] = "$k => \"".
	`addashes
(
$v
)."\"";

82  
	`imode
(',',
$rg
);

83 
	}
}

85 
ude
 
DedeInude
('templets/sys_info_pay.htm');

	@dede/sys_passport.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(!
	$ist
(
$do
))

5 
$do
 = "";

6 
	}
}

7 if(
	g$do
=='save')

9 
$CfigFe
 = 
DEDEINC
."/config_passport.php";

10 
	g$vs
 = 
y
('cfg_pp_need','cfg_pp_encode','cfg_pp_login','cfg_pp_exit','cfg_pp_reg');

11 
	g$cfigr
 = "";

12 
fܗch
(
$vs
 
as
 
$v
)

14 
	g$
{
	g$v
} = 
r_a
("'","",
$
{
$v
});

15 
	g$cfigr
 ."\${$v} = '".
r_a
("'","",
rashes
(
$
{'ed___'.
$v
}))."';\r\n";

17 
	g$cfigr
 = '<'.'?'."\r\n".
$cfigr
.'?'.'>';

18 
	g$
 = 
fݒ
(
$CfigFe
,"w"

 
d
("写入文件 $ConfigFile 失败，请检查权限！");

19 
fwre
(
$
,
$cfigr
);

20 
fo
(
$
);

21 
	gecho
 "<st>t('修改通行证配置成功！');wdow.loti='sys_st.php?".
time
()."';</script>\r\n";

23 
ude
 
DedeInude
('templets/sys_passport.htm');

	@dede/sys_repair.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('sys_ArcBatch');

4 
que_
(
dme
(
__FILE__
).'/../include/oxwindow.class.php');

5 
ShowMsg
("目前暂不需要此工具，以后有需要系统会进行自动升级这个程序！<br /><a href='index_body.php'>&lt;&lt;点击此返回&gt;&gt;</a>", "javascript:;");

6 
ex
();

7 if(
	$emy
(
$do
))

9 
$w
 = 
w
 
	`OxWdow
();

10 
$w
->
	`In
("sys_repair.php","js/blank.js","POST'nctype='multipart/form-data' ");

11 
$w
->
maT
 = "系统修复工具";

12 
$wecome_fo
 = "<a href='index_body.php'>系统主页</a> &gt;&gt; 系统错误修复工具";

13 
$w
->
	`AddT
('本工具用于检测和修复你的系统可能存在的错误');

14 
$msg
 = "

15 <
b
 
width
='98%' 
bd
='0' 
Υacg
='0' 
ηddg
='0' 
ign
='center'>

16 <

>

17 <
td
 
height
='250' 
vign
='top'>

18 <
br
 />

19 由于手动升级时用户没运行指定的
SQL
语句，或自动升级的遗漏处理或处理出错，可能会导致一些错误，使用本工具会自动检测并处理。<
br
 /><br />

20 <
b
>本工具目前主要执行下面动作：</b><
br
 />

21 1、检测从
DedeCms
 
V5
.3发布以来的数据结构的完整性；<
br
 />

22 2、检测微表
dede_y
的健康性；<
br
 />

23 3、检测你的系统是否有因为非正常录入导致的文档
id
不正常问题。<
br
 />

24 <
br
 />

25 <
br
 />

26 <
a
 
hf
='sys_.php?do=1' 
y
='ft-size:14px;c:d'><
b
>点击此开始进行常规检测&
gt
;&gt;</b></a>

27 <
br
 /><br /><br />

28 </
td
>

29 </

>

30 </
b
>

32 
$w
->
	`AddMsgIm
("<div style='padding-left:20px;line-height:150%'>$msg</div>");

33 
$wfm
 = 
$w
->
	`GWdow
('hand','');

34 
$w
->
	`Diy
();

35 
	`ex
();

36 
	}
}

41 if(
	g$do
==1)

43 
$msg
 = '';

44 
	g$dsql
->
Execu
('n',"Show Create Table `#@__arctiny` ");

45 
	g$row
 = 
$dsql
->
GAay
('n', 
MYSQL_BOTH
);

46 if(!
egi
('tyid2', 
$row
[1]))

48 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(" ALTER TABLE `#@__arctiny` ADD `typeid2` SMALLINT( 5 ) UNSIGNED DEFAULT '0' NOT NULL AFTER `typeid` ; ");

49 if(
	g$rs

	g$msg
 .= "◎微表 #@__arctiny 没有副栏目字段typeid2，修复成功！<br />";

50 
	g$msg
 .= "<font color='red'>◎微表 #@__arctiny 没有副栏目字段typeid2，修复无效！</font><br />";

54 
	g$msg
 .= "◎表： #@__arctiny 结构完整，不需修复！<br />";

56 
	g$dsql
->
Execu
('n',"Show Create Table `#@__archives` ");

57 
	g$row
 = 
$dsql
->
GAay
('n', 
MYSQL_BOTH
);

58 if(!
egi
('tyid2', 
$row
[1]))

60 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(" ALTER TABLE `#@__archives` ADD `typeid2` SMALLINT( 5 ) UNSIGNED DEFAULT '0' NOT NULL AFTER `typeid` ; ");

61 if(
	g$rs

	g$msg
 .= "主表 #@__archives 没有副栏目字段typeid2，修复成功！<br />";

62 
	g$msg
 .= "<font color='red'>主表 #@__archives 没有副栏目字段typeid2，修复无效！</font><br />";

66 
	g$msg
 .= "◎表： #@__archives 结构完整，不需修复！<br />";

69 
	g$upsqls
[] = "ALTER TABLE `#@__tagindex` CHANGE `tag` `tag` VARCHAR( 20 ) NOT NULL default ''; ";

70 
	g$upsqls
[] = "ALTER TABLE `#@__taglist` CHANGE `tag` `tag` VARCHAR( 20 ) NOT NULL default ''; ";

71 
	g$upsqls
[] = "ALTER TABLE `#@__archives` CHANGE `litpic` `litpic` VARCHAR( 80 ) NOT NULL default ''; ";

72 
	g$upsqls
[] = "INSERT INTO `#@__sysconfig` (`aid` ,`varname` ,`info` ,`value` ,`type` ,`groupid`) VALUES (713, 'cfg_need_typeid2', '是否启用副栏目', 'N', 'bool', 6); ";

73 
	g$upsqls
[] = "INSERT INTO `#@__sysconfig` (`aid` ,`varname` ,`info` ,`value` ,`type` ,`groupid`) VALUES (715, 'cfg_mb_pwdtype', '前台密码验证类型：默认32 — 32位md5，可选：<br />l16 — 前16位，16 — 后16位， m16 — 中间16位', '32', 'string', 4); ";

74 
	g$upsqls
[] = "Update `#@__sysconfig` set `groupid` = '8' where `varname`ike 'cfg_group_%'; ";

75 
	g$upsqls
[] = "ALTER TABLE `#@__arccache` ADD `stylehash` CHAR(32) NOT NULL default '' AFTER `md5hash`; ";

77 
	g$msg
 .= "◎检测系统修改过的字段或增加的变量，这些SQL操作运行多次并不会影响系统正常运行...<br />";

78 
fܗch
(
$upsqls
 
as
 
$upsql
)

80 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$upsql
);

81 
	g$msg
 ."·执行 <fڈc='g'>".
$upsql
."</font> ok!<br />";

84 
	g$msg
 .= "◎检测 #@__advancedsearch 表是否存在...<br />";

86 
	g$Quy
 = "CREATE TABLE IF NOT EXISTS `#@__advancedsearch` (

87 `
mid
` (11
NOT
 
NULL
,

88 `
	gmab
` 
vch
(255
NOT
 
NULL
  '',

89 `
	gmaflds
` 
	gxt
,

90 `
	gaddڏb
` 
vch
(255)  '',

91 `
	gaddflds
` 
	gxt
,

92 `
	gfms
` 
	gxt
,

93 `
	gme
` 
vch
(255
NOT
 
NULL
  '',

94 
UNIQUE
 
	gKEY
 `
	gmid
` (`mid`)

95 
	gTYPE
=
MyISAM
; ";

96 
	g$dsql
->
ExecuNeQuy
(
$Quy
);

98 
	g$w
 = 
w
 
OxWdow
();

99 
	g$w
->
In
("sys_repair.php","js/blank.js","POST'nctype='multipart/form-data' ");

100 
	g$w
->
	gmaT
 = "系统修复工具";

101 
	g$wecome_fo
 = "<a href='sys_repair.php'>系统错误修复工具</a> &gt;&gt; 检测数据结构";

102 
	g$w
->
AddT
('本工具用于检测和修复你的系统可能存在的错误');

103 
	g$msg
 = "

104 <
b
 
width
='98%' 
bd
='0' 
Υacg
='0' 
ηddg
='0' 
ign
='center'>

105 <

>

106 <
td
 
height
='250' 
vign
='top'>

107 {
$msg
}

108 <
b
><
ft
 
c
='green'>已完成数据结构完整性检测！</font></b>

109 <
hr
 
size
='1'/>

110 <
br
 />

111 <
b
>如果你系统有下面几种问题之一，请检测微表正确性：</b><
br
 />

112 1、无法获得主键，因此无法进行后续操作<
br
 />

113 2、更新数据库
chives
表时出错<
br
 />

114 3、列表显示数据目与实际文档数不一致<
br
 />

115 <
br
 />

116 <
a
 
hf
='sys_.php?do=2' 
y
='ft-size:14px;'><
b
>点击此检测微表正确性&
gt
;&
	ggt
;</
	gb
></
	ga
>

117 <
	gbr
 /><br /><br />

118 </
	gtd
>

119 </
	g
>

120 </
	gb
>

122 
	g$w
->
AddMsgIm
("<div style='padding-left:20px;line-height:150%'>$msg</div>");

123 
	g$wfm
 = 
$w
->
GWdow
('hand','');

124 
	g$w
->
Diy
();

125 
ex
();

131 if(
	g$do
==2)

133 
$msg
 = '';

135 
	g$rum
 = 0;

136 
	g$row
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__archives` ");

137 
	g$rum
 = 
$um
 = 
$row
['dd'];

138 
	g$msg
 .= "·#@__archives 表总记录数： {$arcnum} <br />";

140 
	g$shbs
 = 
y
();

141 
	g$dsql
->
Execu
('me', " Selectddtable From `#@__channeltype` where id < -1 ");

142 
	g$row
 = 
$dsql
->
GAay
('me') )

144 
$addb
 = 
ow
(
im
(
r_a
('#@__', 
$cfg_dbefix
, 
$row
['addtable'])));

145 if(
emy
(
$addb
)) {

150 if!
ist
(
$shbs
[
$addb
]) )

152 
	g$shbs
[
$addb
] = 1;

153 
	g$row
 = 
$dsql
->
GO
("Select count(aid)s dd From `$addtable` ");

154 
	g$msg
 .= "·{$addtable} 表总记录数： {$row['dd']} <br />";

155 
	g$rum
 +
$row
['dd'];

159 
	g$msg
 .= "※总有效记录数： {$allarcnum} <br /> ";

160 
	g$
 = "<a href='index_body.php' style='font-size:14px;'><b>完成修正或无错误返回&gt;&gt;</b></a>";

161 
	g$row
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__arctiny` ");

162 
	g$msg
 .= "※微统计表记录数： {$row['dd']}<br />";

163 if(
	g$row
['dd']==
$rum
)

165 
$msg
 .= "<p style='color:green;font-size:16px'><b>两者记录一致，无需修正！</b></p><br />";

169 
	g$sql
 = " TRUNCATE TABLE `#@__arctiny`";

170 
	g$dsql
->
execunequy
(
$sql
);

171 
	g$msg
 .= "<font color='red'>两者记录不一致，尝试进行简单修正...</font><br />";

173 
	g$sql
 = "insert into `#@__arctiny`(id,ypeid,ypeid2,rcrank, channel, senddate, sortrank, mid) 

174 
Se
 
id
, 
	gtyid
, 
	gtyid2
, 
	gk
, 
	gchl
, 
	gndde
, 
	gs܌k
, 
mid
 
	gom
 `#@
	g__chives
` ";

175 
	g$dsql
->
execunequy
(
$sql
);

177 
fܗch
(
$shbs
 
as
 
$tb
=>
$v
)

179 
$sql
 = "insert into `#@__arctiny`(id,ypeid,ypeid2,rcrank, channel, senddate, sortrank, mid) 

180 
Se
 
aid
, 
	gtyid
, 0, 
	gk
, 
	gchl
, 
	gndde
, 0, 
mid
 
	gom
 `
	g$tb
` ";

181 
	g$rs
 = 
$dsql
->
execunequy
(
$sql
);

182 
	g$d߼ay
[
$tb
] = 1;

184 
	g$row
 = 
$dsql
->
GO
("Select count(*)s dd From `#@__arctiny` ");

185 if(
	g$row
['dd']==
$rum
)

187 
$msg
 .= "<p style='color:green;font-size:16px'><b>修正记录成功！</b></p><br />";

191 
	g$msg
 .= "<p style='color:red;font-size:16px'><b>修正记录失败，建议进行高级综合检测！</b></p><br />";

192 
	g$
 = " <a href='sys_repair.php?dopost=3' style='font-size:14px;'><b>进行高级结合性检测&gt;&gt;</b></a> ";

195 
UpDeCCache
();

196 
	g$w
 = 
w
 
OxWdow
();

197 
	g$w
->
In
("sys_repair.php","js/blank.js","POST'nctype='multipart/form-data' ");

198 
	g$w
->
	gmaT
 = "系统修复工具";

199 
	g$wecome_fo
 = "<a href='sys_repair.php'>系统错误修复工具</a> &gt;&gt; 检测微表正确性";

200 
	g$w
->
AddT
('本工具用于检测和修复你的系统可能存在的错误');

201 
	g$msg
 = "

202 <
b
 
width
='98%' 
bd
='0' 
Υacg
='0' 
ηddg
='0' 
ign
='center'>

203 <

>

204 <
td
 
height
='250' 
vign
='top'>

205 {
$msg
}

206 <
hr
 />

207 <
br
 />

208 {
$
}

209 </
td
>

210 </

>

211 </
b
>

213 
$w
->
AddMsgIm
("<div style='padding-left:20px;line-height:150%'>$msg</div>");

214 
	g$wfm
 = 
$w
->
GWdow
('hand','');

215 
	g$w
->
Diy
();

216 
ex
();

222 if(
	g$do
==3)

224 
$um
 = 0;

225 
	g$sql
 = " TRUNCATE TABLE `#@__arctiny`";

226 
	g$dsql
->
execunequy
(
$sql
);

228 
	g$sql
 = "Selectrc.id,rc.typeid,rc.typeid2,rc.arcrank,rc.channel,rc.senddate,rc.sortrank,

229 
c
.
mid
, 
	gch
.
addb
 
	gFROM
 `#@
	g__chives
`r

 
	gjo
 `#@
	g__chy
` 
ch
 

 ch.
	gid
rc.
chl
 ";

230 
$dsql
->
Execu
('me', 
$sql
);

231 
	g$row
 = 
$dsql
->
GAay
('me') )

233 
$sql
 = "Insert Into `#@__arctiny`(id,ypeid,ypeid2,rcrank, channel, senddate, sortrank, mid)

234 
Vues
('{$row['
id
']}','{$row['
tyid
']}','{$row['
tyid2
']}','{$row['
k
']}',

235 '{$row['
chl
']}','{$row['
ndde
']}','{$row['
s܌k
']}','{$row['
mid
']}'); ";

236 
	g$rs
 = 
$dsql
->
execunequy
(
$sql
);

237 if(!
	g$rs
)

239 
	g$addb
 = 
im
(
$addb
);

240 
	g$um
 ++;

241 
	g$dsql
->
execunequy
("Delete From `#@__archives` where id='{$row['id']}' ");

242 if(!
emy
(
$addb
)
	g$dsql
->
execunequy
("Delete From `$addtable` where id='{$row['id']}' ");

246 
	g$dsql
->
SQuy
("Select id,addtable From `#@__channeltype` where id < -1 ");

247 
	g$dsql
->
Execu
();

248 
	g$d߼ay
 = 
y
();

249 
	g$row
 = 
$dsql
->
GAay
())

251 
$tb
 = 
r_a
('#@__', 
$cfg_dbefix
, 
$row
['addtable']);

252 if(
emy
(
$tb
|| 
ist
(
$d߼ay
[$tb]) )

258 
	g$sql
 = "insert into `#@__arctiny`(id,ypeid,ypeid2,rcrank, channel, senddate, sortrank, mid) 

259 
Se
 
aid
, 
	gtyid
, 0, 
	gk
, 
	gchl
, 
	gndde
, 0, 
mid
 
	gom
 `
	g$tb
` ";

260 
	g$rs
 = 
$dsql
->
execunequy
(
$sql
);

261 
	g$d߼ay
[
$tb
] = 1;

264 
	g$w
 = 
w
 
OxWdow
();

265 
	g$w
->
In
("sys_repair.php","js/blank.js","POST'nctype='multipart/form-data' ");

266 
	g$w
->
	gmaT
 = "系统修复工具";

267 
	g$wecome_fo
 = "<a href='sys_repair.php'>系统错误修复工具</a> &gt;&gt; 高级综合检测修复";

268 
	g$w
->
AddT
('本工具用于检测和修复你的系统可能存在的错误');

269 
	g$msg
 = "

270 <
b
 
width
='98%' 
bd
='0' 
Υacg
='0' 
ηddg
='0' 
ign
='center'>

271 <

>

272 <
td
 
height
='250' 
vign
='top'>

273 完成所有修复操作，移除错误记录 {
$um
} 条！

274 <
hr
 />

275 <
br
 />

276 <
a
 
hf
='dex_body.php' 
y
='ft-size:14px;'><
b
>完成修正或无错误返回&
gt
;&
	ggt
;</
	gb
></
	ga
>

277 </
	gtd
>

278 </
	g
>

279 </
	gb
>

281 
	g$w
->
AddMsgIm
("<div style='padding-left:20px;line-height:150%'>$msg</div>");

282 
	g$wfm
 = 
$w
->
GWdow
('hand','');

283 
	g$w
->
Diy
();

284 
ex
();

	@dede/sys_safetest.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('sys_Edit');

4 if(
emy
(
$ai
)
	g$ai
 = '';

5 if(
emy
(
$mesge
)
	g$mesge
 = '尚未进行检测……';

7 
	g$fe
 = "data/common.inc.php

8 
dede
/
cfig
.
php


9 
dede
/
dex_body
.
php


10 
dede
/
memb_do
.
php


11 
dede
/
sys_fo_y
.
php


12 
group
/
pofm
.
php


13 
group
/
y
.
php


14 
ude
/
comm
.
c
.
php


15 
ude
/
ma
.
ass
.
php


16 
memb
/
y
/
ay
/
ay_nify
.
php


17 
memb
/
y
/
ay
/
nify_u
.
php


18 
memb
/
y
/
ay
/
tu_u
.
php


19 
memb
/
y
/
cbymt
/
auteive
.
php


20 
memb
/
y
/
s
/
y_back_s
.
php


21 
memb
/
y
/
ay
/
ay_gbk_ge
.
php


22 
memb
/
y
/
yy
/
yy_gbk
.
php


23 
us
/
y
/
ay
/
ay_nify
.
php


24 
us
/
y
/
ay
/
nify_u
.
php


25 
us
/
y
/
ay
/
tu_u
.
php


26 
us
/
y
/
cbymt
/
auteive
.
php


27 
us
/
y
/
cbymt
/
ive
.
php


28 
us
/
y
/
s
/
y_back_s
.
php


29 
us
/
y
/
yy
/
yy_gbk
.
php


30 
ude
/
dedeci
.
ass
.
php


31 
ude
/
dedag
.
ass
.
php


32 
ude
/
dlog
/
cfig
.
php


33 
ude
/
FCKed
/
fcked
.
php


34 
ude
/
sm
.
ass
.
php


35 
ude
/
z
.
ass
.
php


36 
l
/
comm
.
c
.
php


37 
l
/
dex
.
php
";

39 
$admD
 = 
eg_a
("(.*)[/\\]","",
dme
(
__FILE__
));

40 
	g$fe
 = 
im
(
r_a
('dede/',
$admD
.'/',
$fe
));

41 
	g$fes
 = 
l
("[\r\n]{1,}",
$fe
);

43 
funi
 
	$TeOFe
(
$f
)

45 
glob
 
$mesge
;

46 
$r
 = '';

49 if(
	`NCheckFe
(
$f
|| 
	`eg
('data/tplcache',$f))  -1;

51 
$
 = 
	`fݒ
(
$f
,'r');

52 !
	`of
(
$
){ 
$r
 .
	`fgs
($fp,1024); }

53 
	`fo
(
$
);

54 if(
	`egi
("v|cmd|_GET|_POST)[ \r\n\t]{0,}([\[\(])",
$r
))

56 
$fe
 = 
	`eg_a
('^'.
DEDEROOT
,'',
$f
);

57 
$mesge
 .= "<div style='clear:both;border-bottom:1px dotted #B8E6A2;line-height:24px'>

58 <
div
 
y
='width:350px;t:'>可疑文件：{
$fe
}</div>

59 <
div
 
y
='t:'>[<
a
 
hf
='fe_mage_vw.php?fmdo=d&fame=$fe&aivh=' 
rg
='_bnk'><
u
>删除</u></a>]

60 [<
a
 
hf
='fe_mage_vw.php?fmdod&fame=$fe&aivh=' 
rg
='_bnk'><
u
>查看源码</u></a>]

61 </
div
></div>\
r
\
n
";

65 
	}
}

67 
funi
 
	$NCheckFe
(
$f
)

69 
glob
 
$fes
, 
$fe
;

70 if(
$fe
 != '')

72 
	`fܗch
(
$fes
 
as
 
$v
)

75 if
	`egi
(
$v
,
$f
 
ue
;

78  
l
;

79 
	}
}

81 
funi
 
	$TeSa
(
$td
)

83 
$dh
 = 
	`d
(
$td
);

84 
$ame
=
$dh
->
	`ad
())

86 
$amef
 = 
$td
.'/'.
$ame
;

87 if(
	`is_d
(
$amef
&& 
$ame
 != '.' && $fname != '..')

89 
	`TeSa
(
$amef
);

91 if(
	`egi
("\.hp|c)",
$amef
))

93 
	`TeOFe
(
$amef
);

96 
	}
}

99 if(
	g$ai
=='test')

101 
$mesge
 = '';

102 
AjaxHd
();

103 
TeSa
(
DEDEROOT
);

104 if(
	g$mesge
==''
$mesge
 = "<font color='green' style='font-size:14px'>没发现可疑文件！</font>";

105 
echo
 
	g$mesge
;

106 
ex
();

109 if(
	g$ai
=='clear')

111 
glob
 
$cfg_lche_d
;

112 
	g$mesge
 = '';

113 
	g$d
 = 
DEDEROOT
.
$cfg_lche_d
;

114 
AjaxHd
();

115 
p
(1);

116 if(
eg
('da/',
$cfg_lche_d
&& 
fe_exis
(
$d
&& 
is_d
($d))

118 
	g$dh
 = 
d
(
$d
);

119 
	g$fame
 = 
$dh
->
ad
())

121 if(
$fame
=='.'||$filename=='..'||$filename=='index.html') ;

122 @
uƚk
(
$d
.'/'.
$fame
);

125 
	g$mesge
 = "<font color='green' style='font-size:14px'>成功清空模板缓存！</font>";

126 
echo
 
	g$mesge
;

127 
ex
();

130 
ude
(
dme
(
__FILE__
).'/templets/sys_safetest.htm');

	@dede/sys_sql_query.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Data');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

10 if(
	g$do
=="viewinfo")

12 if(
emy
(
$bme
))

14 
echo
 "没有指定表名！";

18 
	g$dsql
->
SQuy
("SHOW CREATE TABLE ".
$dsql
->
dbName
.".".
$bme
);

19 
	g$dsql
->
Execu
('me');

20 
	g$row2
 = 
$dsql
->
GAay
('me',
MYSQL_BOTH
);

21 
	g$fo
 = 
$row2
[1];

22 
	gecho
 "<xmp>".
im
(
$fo
)."</xmp>";

24 
ex
();

27 if(
	g$do
=="opimize")

29 if(
emy
(
$bme
))

31 
echo
 "没有指定表名！";

35 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("OPTIMIZE TABLE `$tablename` ");

36 if(
	g$rs

	gecho
 "执行优化表： $tablename OK！";

37 
	gecho
 "执行优化表： $bm 失败，原因是：".
	g$dsql
->
GE
();

39 
ex
();

42 if(
	g$do
=="opimizeAll")

44 
$dsql
->
SQuy
("Show Tables");

45 
	g$dsql
->
Execu
('t');

46 
	g$row
 = 
$dsql
->
GAay
('t',
MYSQL_BOTH
))

48 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("OPTIMIZE TABLE `{$row[0]}` ");

49 if(
	g$rs
) {

50 
	gecho
 "优化表: {$row[0]} ok!<br />\r\n";

53 
	gecho
 "优化表: {$row[0]} 失败! 原因是: ".
	g$dsql
->
GE
()."<br />\r\n";

56 
ex
();

59 if(
	g$do
=="repair")

61 if(
emy
(
$bme
))

63 
echo
 "没有指定表名！";

67 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("REPAIR TABLE `$tablename` ");

68 if(
	g$rs

	gecho
 "修复表： $tablename OK！";

69 
	gecho
 "修复表： $bm 失败，原因是：".
	g$dsql
->
GE
();

71 
ex
();

74 if(
	g$do
=="repairAll")

76 
$dsql
->
SQuy
("Show Tables");

77 
	g$dsql
->
Execu
('t');

78 
	g$row
 = 
$dsql
->
GAay
('t',
MYSQL_BOTH
))

80 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("REPAIR TABLE `{$row[0]}` ");

81 if(
	g$rs
) {

82 
	gecho
 "修复表: {$row[0]} ok!<br />\r\n";

85 
	gecho
 "修复表: {$row[0]} 失败! 原因是: ".
	g$dsql
->
GE
()."<br />\r\n";

88 
ex
();

91 if(
	g$do
=="query")

93 
$sqlquy
 = 
im
(
rashes
($sqlquery));

103 if(
egi
("^ ",
$sqlquy
))

105 
	g$dsql
->
SQuy
(
$sqlquy
);

106 
	g$dsql
->
Execu
();

107 if(
	g$dsql
->
GTٮRow
()<=0)

109 
echo
 "运行SQL：{$sqlquery}，无返回记录！";

113 
	gecho
 "运行SQL：{$sqlquy}，共有".
	g$dsql
->
GTٮRow
()."条记录，最大返回100条！";

115 
	g$j
 = 0;

116 
	g$row
 = 
$dsql
->
GAay
())

118 
$j
++;

119 if(
	g$j
>100)

123 
	gecho
 "<hr size=1 width='100%'/>";

124 
	gecho
 "记录：$j";

125 
	gecho
 "<hr size=1 width='100%'/>";

126 
fܗch
(
$row
 
as
 
$k
=>
$v
)

128 
echo
 "<font color='red'>{$k}：</font>{$v}<br/>\r\n";

131 
ex
();

133 if(
	g$quyty
==2)

136 
$sqlquy
 = 
r_a
("\r","",$sqlquery);

137 
	g$sqls
 = 
l
(";[ \t]{0,}\n",
$sqlquy
);

138 
	g$üCode
 = ""; 
	g$i
=0;

139 
fܗch
(
$sqls
 
as
 
$q
)

141 
	g$q
 = 
im
(
$q
);

142 if(
	g$q
=="")

146 
	g$dsql
->
ExecuNeQuy
(
$q
);

147 
	g$rCode
 = 
im
(
$dsql
->
GE
());

148 if(
	g$rCode
=="")

150 
$i
++;

154 
	g$üCode
 ."执行： <fڈc='blue'>$q</ft> 出错，错误提示：<fڈc='d'>".
$rCode
."</font><br>";

157 
	gecho
 "成功执行{$i}个SQL语句！<br><br>";

158 
echo
 
	g$üCode
;

162 
	g$dsql
->
ExecuNeQuy
(
$sqlquy
);

163 
	g$üCode
 = 
im
(
$dsql
->
GE
());

164 
	gecho
 "成功执行1个SQL语句！<br><br>";

165 
echo
 
	g$üCode
;

167 
ex
();

169 
ude
 
DedeInude
('templets/sys_sql_query.htm');

	@dede/sys_task.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Task');

4 if(
emy
(
$do
)
	g$do
 = '';

7 if(
	g$do
=='del')

9 
$dsql
->
ExecuNeQuy
("Delete From `#@__sys_task` where id='$id' ");

10 
ShowMsg
("成功删除一个任务！", "sys_task.php");

11 
ex
();

14 
ude
 
DedeInude
('templets/sys_task.htm');

	@dede/sys_task_add.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Task');

4 if(
emy
(
$do
)
	g$do
 = '';

6 if(
	g$do
=='save')

8 
$ime
 = 
emy
($ime? 0 : 
GMkTime
($starttime);

9 
	g$dtime
 = 
emy
(
$dtime
? 0 : 
GMkTime
($endtime);

10 
	g$ruime
 = 
$h
.':'.
$m
;

11 
	g$Quy
 = "Insert Into `#@__sys_task`(`taskname`,`dourl`,`islock`,`runtype`,`runtime`,`starttime`,`endtime`,`freq`,`lastrun`,`description`,`parameter`,`settime`)

12 
Vues
('$taskname', '$dourl', '$nislock', '$runtype', '$runtime', '$starttime', '$endtime','$freq', '0', '$description','$parameter', '".time()."'); ";

13 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$Quy
);

14 if(
	g$rs
)

16 
ShowMsg
('成功增加一个任务!', 'sys_task.php');

20 
ShowMsg
('增加任务失败!'.
$dsql
->
GE
(), 'javascript:;');

22 
ex
();

25 
ude
 
DedeInude
('templets/sys_task_add.htm');

	@dede/sys_task_edit.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Task');

4 if(
emy
(
$do
)
	g$do
 = '';

6 if(
	g$do
=='save')

8 
$ime
 = 
emy
($ime? 0 : 
GMkTime
($starttime);

9 
	g$dtime
 = 
emy
(
$dtime
? 0 : 
GMkTime
($endtime);

10 
	g$ruime
 = 
$h
.':'.
$m
;

11 
	g$quy
 = "Update `#@__sys_task`

12 
t
 `
skme
` = '$taskname',

13 `
	gdou
` = '$dourl',

14 `
	giock
` = '$nislock',

15 `
	gruy
` = '$runtype',

16 `
	gruime
` = '$runtime',

17 `
	gime
` = '$starttime',

18 `
	gdtime
` = '$endtime',

19 `
	geq
` = '$freq',

20 `
	gdesti
` = '$description',

21 `
	gm
` = '$parameter'

22 
whe
 
id
='$id' ";

23 
$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

24 if(
	g$rs
)

26 
ShowMsg
('成功修改一个任务!', 'sys_task.php');

30 
ShowMsg
('修改任务失败!'.
$dsql
->
GE
(), 'javascript:;');

32 
ex
();

35 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__sys_task` where id='$id' ");

36 
ude
 
DedeInude
('templets/sys_task_edit.htm');

	@dede/sys_verifies.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Edit');

4 @
t_time_lim
(0);

5 
que
(
DEDEINC
.'/dedehttpdown.class.php');

8 
	g$officlU
 = 'http://service.dedecms.com';

9 
	g$updeHo
 = 'http://updatenew.dedecms.com/base-v55/';

11 
	g$ai
 = 
ist
(
$ai
? 
	$im
(
$ai
) : '';

14 
$vLockFe
 = 
DEDEROOT
.'/data/admin/ver.txt';

16 
$vifsLockFe
 = 
DEDEROOT
.'/data/admin/verifies.txt';

18 
$
 = 
	`fݒ
(
$vLockFe
,'r');

19 
$upTime
 = 
	`im
(
	`d
(
$
,64));

20 
	`fo
(
$
);

22 
$updeTime
 = 
	`subr
(
$upTime
,0,4).'-'.substr($upTime,4,2).'-'.substr($upTime,6,2);

23 
$vifsTime
 = "未同步过指纹码";

24 if(
	$fe_exis
(
$vifsLockFe
))

26 
$
 = 
	`fݒ
(
$vifsLockFe
,'r');

27 
$upTime
 = 
	`im
(
	`d
(
$
,64));

28 
	`fo
(
$
);

29 
$vifsTime
 = 
	`subr
(
$upTime
,0,4).'-'.substr($upTime,4,2).'-'.substr($upTime,6,2);

30 
	}
}

32 
	g$tmpd
 = 
subr
(
md5
(
$cfg_cook_code
),0,16);

37 if(!
funi_exis
('file_get_contents'))

39 
funi
 
fe_g_cڋs
(
$ame
)

41 if(!
fe_exis
(
$ame
|| 
is_d
($fname))

47 
	g$
 = 
fݒ
(
$ame
, 'r');

48 
	g$
 = 
d
(
$
, 
fesize
(
$ame
));

49 
fo
(
$
);

50  
	g$
;

55 if(
	g$ai
 == '')

57 
ude
(
DEDEADMIN
.'/templets/sys_verifies.htm');

58 
ex
();

64 if(
	g$ai
 == 'verify')

66 
$dsql
->
SQuy
("Select * from `#@__verifies` ");

67 
	g$dsql
->
Execu
();

68 
	g$fi
 = 
y
();

69 
	g$row
 = 
$dsql
->
GAay
())

71 
$tufe
 = 
r_a
('../dede', '.', 
$row
['filename']);

73 if(!
fe_exis
(
$tufe
)) {

76 if
fesize
(
$tufe
)==0 ) {

79 
	g$
 = 
fe_g_cڋs
(
$tufe
);

80 
	g$
 = 
eg_a
("/\/\*\*[\r\n]{1,}(.*)[\r\n]{1,} \*\//sU", '', 
$
);

81 
	g$hash
 = 
md5
(
$
);

82 if(
	g$hash
 !
$row
['cthash']) {

83 
$row
['lolhash'] = 
$hash
;

84 
	g$row
['mtime'] = 
MyDe
('Y-m-d H:i:s', 
femtime
(
$tufe
));

85 
	g$row
['tufe'] = 
$tufe
;

86 
	g$fi
[] = 
$row
;

89 if(!
ist
(
$fi
[0]))

91 
ShowMsg
("所有文件都通过效验证，核心文件没有被改动过！","sys_verifies.php");

95 
ude
(
DEDEADMIN
.'/templets/sys_verifies_verify.htm');

97 
ex
();

103 i(
	g$ai
 == 'view')

105 
que_
(
DEDEINC
."/oxwindow.class.php");

107 
	g$fxt
 = '';

108 if!
egi
('da(.*)comm.c.php',
$fame
) )

110 
	g$
 = 
fݒ
(
$fame
,'r');

111 
	g$fxt
 = 
d
(
$
, 
fesize
(
$fame
));

112 
fo
(
$
);

115 
	g$fxt
 = 
r_a
('xa','!xa',
$fxt
);

117 
	g$wt
 = "文件效验::查看文件";

118 
	g$wecome_fo
 = "<a href='sys_verifies.php'><u>文件效验</u></a>::查看文件";

119 
	g$w
 = 
w
 
OxWdow
();

120 
	g$w
->
In
();

121 
	g$w
->
AddT
("以下为文件 $filename 的内容，请检查是否可疑：");

122 
	g$wfm
 = 
$w
->
GWdow
("hd","<xme='fxt' sty='width:100%;height:450px;wd-wp: bak-wd;wd-bak:bak-l;'>".
$fxt
."</textarea>");

123 
	g$w
->
Diy
();

124 
ex
();

130 i(
	g$ai
 == 'manage')

132 
$dsql
->
SQuy
("Select * from `#@__verifies` ");

133 
	g$dsql
->
Execu
();

134 
	g$fi
 = 
y
();

135 
	g$row
 = 
$dsql
->
GAay
())

137 
$fi
[] = 
$row
;

139 
ude
(
DEDEADMIN
.'/templets/sys_verifies_manage.htm');

140 
ex
();

146 i(
	g$ai
 == 'getfiles')

148 if(!
ist
(
$fes
))

150 
ShowMsg
("你没进行任何操作！","sys_verifies.php");

151 
ex
();

153 
	g$cheFes
 = 
DEDEROOT
.'/data/modifytmp.inc';

154 
	g$
 = 
fݒ
(
$cheFes
,'w');

155 
fwre
(
$
,'<'.'?php'."\r\n");

156 
fwre
(
$
,'$tmpd = "'.
$tmpd
.'";'."\r\n");

157 
	g$ds
 = 
y
();

158 
	g$i
 = -1;

159 
	g$admD
 = 
eg_a
("(.*)[/\\]","",
dme
(
__FILE__
));

160 
fܗch
(
$fes
 
as
 
$fame
)

162 
	g$fame
 = 
subr
(
$fame
,3,

($filename)-3);

163 if(
egi
("^dede/",
$fame
)) {

164 
	g$curd
 = 
GDName

egi_a
("^dede/",
$admD
.'/',
$fame
) );

167 
	g$curd
 = 
GDName
(
$fame
);

169 if!
ist
(
$ds
[
$curd
]) ) {

170 
	g$ds
[
$curd
] = 
TeIsFeD
($curdir);

172 
	g$i
++;

173 
fwre
(
$
,'$fes['.
$i
.'] = "'.
$fame
.'";'."\r\n");

175 
fwre
(
$
,'$feCu'.
$i
.';'."\r\n");

176 
fwre
(
$
,'?'.'>');

177 
fo
(
$
);

179 
	g$dfos
 = '';

180 if(
	g$i
 > -1)

182 
	g$dfos
 = '<tr bgcolor="#ffffff"><td colspan="2">';

183 
	g$dfos
 .= "本次升级需要在下面文件夹写入更新文件，请注意文件夹是否有写入权限：<br />\r\n";

184 
fܗch
(
$ds
 
as
 
$curd
)

186 
	g$dfos
 .
$curd
['name']." 状态：".($curdir['writeable'] ? "[√正常]" : "<font color='red'>[×不可写]</font>")."<br />\r\n";

188 
	g$dfos
 .= "</td></tr>\r\n";

191 
	g$deS
 = "<iframeame='stafrm' src='sys_verifies.php?action=down&curfile=0' frameborder='0' id='stafrm' width='100%' height='100%'></iframe>\r\n";

193 
ude
(
DEDEADMIN
.'/templets/sys_verifies_getfiles.htm');

195 
ex
();

201 if(
	g$ai
=='down')

203 
$cheFes
 = 
DEDEROOT
.'/data/modifytmp.inc';

204 
que_
(
$cheFes
);

206 if(
	g$feCut
==-1 || 
$curfe
 > 
$feCut
)

208 
ShowMsg
("已下载所有文件<br /><a href='sys_verifies.php?action=apply'>[直接替换文件]</a> &nbsp; <a href='#'>[我自己手动替换文件]</a>","javascript:;");

209 
ex
();

213 
MkTmpD
(
$tmpd
, 
$fes
[
$curfe
]);

215 
	g$downfe
 = 
$updeHo
.
$cfg_so_ng
.'/sour/'.
$fes
[
$curfe
];

217 
	g$dhd
 = 
w
 
DedeHpDown
();

218 
	g$dhd
->
OnU
(
$downfe
);

219 
	g$dhd
->
SaveToB
(
DEDEROOT
.'/da/'.
$tmpd
.'/'.
$fes
[
$curfe
]);

220 
	g$dhd
->
Clo
();

222 
ShowMsg
("成功下载文件：{$fes[$curfe]}； 继续下载下一个文件。","sys_vifs.php?ai=down&curfe=".(
$curfe
+1));

223 
ex
();

229 if(
	g$ai
=='modify')

231 if(!
ist
(
$modifys
))

233 
ShowMsg
("没选定要修改的文件！","-1");

234 
ex
();

238 
fܗch
(
$modifys
 
as
 
$ame
)

240 if(
	g$mhod
=='local')

242 
$tuFame
 = 
r_a
('../dede','./',
$ame
);

243 if(
fe_exis
(
$tuFame
))

245 
	g$
 = 
fݒ
(
$tuFame
,'r');

246 
	g$
 = 
d
(
$
,
fesize
(
$tuFame
));

247 
fo
(
$
);

248 
	g$hash
 = 
md5
(
$
);

249 
	g$dsql
->
ExecuNeQuy
("update `#@__verifies` set `method`='local',cthash='$cthash' where filename='$fname' ");

254 
	g$dsql
->
ExecuNeQuy
("update `#@__verifies` set `method`='offical' where filename='$fname' ");

258 if(
	g$mhod
=='local')

260 
ShowMsg
("成功修改指定文件的验证方式！","sys_verifies.php?action=manage");

264 
ShowMsg
("成功修改指定文件的验证方式！<br /> 由于你修改了文件为远程验证方式，因此需进行更新操作<br /> <a href='sys_verifies.php?action=update'>[更新]</a> &nbsp; <a href='sys_verifies.php?action=manage'>[返回]</a>","javascript:;");

266 
ex
();

272 i(
	g$ai
 == 'apply')

274 
$cheFes
 = 
DEDEROOT
.'/data/modifytmp.inc';

275 
que_
(
$cheFes
);

276 
	g$sD
 = 
DEDEROOT
."/data/$tmpdir";

277 
	g$tD
 = 
DEDEROOT
;

279 
	g$bad
 = 0;

280 
	g$admD
 = 
eg_a
("(.*)[/\\]","",
dme
(
__FILE__
));

282 if(
ist
(
$fes
&& 
is_y
($files))

284 
fܗch
(
$fes
 
as
 
$f
)

286 if(
eg
('^dede',
$f
)
	g$tf
 = 
eg_a
('^dede',
$admD
,$f);

287 
	g$tf
 = 
$f
;

289 if(
fe_exis
(
$sD
.'/'.
$f
))

292 
	g$
 = 
fe_g_cڋs
(
$sD
.'/'.
$f
);

293 
	g$
 = 
eg_a
("/\/\*\*[\r\n]{1,}(.*)[\r\n]{1,} \*\//sU", '', 
$
);

294 
	g$whash
 = 
md5
(
$
);

295 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__verifies` where filename='../{$f}' ");

296 if(
is_y
(
$row
&& 
	g$row
['hash'] !
$whash
)

298 
$bad
++;

302 
	g$rs
 = @
cy
(
$sD
.'/'.
$f
, 
$tD
.'/'.
$tf
);

303 if(
	g$rs

uƚk
(
$sD
.'/'.
$f
);

304 
	g$bad
++;

310 
	g$badmsg
 = '！';

311 if(
	g$bad
 > 0)

313 
	g$badmsg
 = "，其 {$badcp} 个文件效验码不正确或复制失败，<br />请从临时目录[../data/{$tmpdir}]中取出这几个文件手动还原。";

316 
ShowMsg
("成功完成还原指定文件{$badmsg}","javascript:;");

317 
ex
();

323 if(
	g$ai
 == 'update')

325 
$rmFe
 = 
$updeHo
.
$cfg_so_ng
.'/verifys.txt';

326 
	g$dhd
 = 
w
 
DedeHpDown
();

327 
	g$dhd
->
OnU
(
$rmFe
);

328 
	g$
 = 
$dhd
->
GHtml
();

329 
	g$dhd
->
Clo
();

330 
	g$s
 = 
l
("[\r\n]{1,}",
$
);

331 
fܗch
(
$s
 
as
 
$
)

333 
	g$
 = 
im
(
$
);

334 if(
emy
(
$
)) ;

335 
li
(
$meid
,
$hash
,
$ame

exode
("\t",
$
);

336 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__verifies` whereameid='$nameid' ");

337 if(!
is_y
(
$row
|| (
	g$row
['mhod']=='officl' && $row['hash']!=
$hash
 ))

339 
$dsql
->
ExecuNeQuy
("Replace Into `#@__verifies`(nameid,cthash,method,filename) values ('$nameid','$cthash','official','$fname'); ");

342 
	g$
 = 
fݒ
(
$vifsLockFe
,'w');

343 
fwre
(
$
, 
MyDe
('Ymd',
time
()));

344 
fo
(
$
);

345 
ShowMsg
("完成效验码更新，是否马上进行效验操作？<br /> <a href='sys_verifies.php?action=verify'>[开始效验]</a> &nbsp; <a href='sys_verifies.php?action=manage'>[管理]</a> &nbsp; <a href='sys_verifies.php'>[返回]</a>","javascript:;");

346 
ex
();

352 i(
	g$ai
 == 'make')

354 
$
 = 
fݒ
(
DEDEROOT
.'/../verifys.txt','w');

355 
fܗch
 (
eg_ls
 ('../', 
ue
, "/.*\.hp|htm|html|js)$/i", 'CVS,da,html,uds,ms,ecl'
as
 
$efe
)

357 
	g$meid
 = 
md5
(
$efe
);

358 
	g$body
 = 
fe_g_cڋs
(
DEDEADMIN
.'/'.
$efe
);

359 
	g$body
 = 
eg_a
("/\/\*\*[\r\n]{1,}(.*)[\r\n]{1,} \*\//sU", '', 
$body
);

360 
	g$hash
 = 
md5
(
$body
);

361 
fwre
(
$
,"{$nameid}\t{$cthash}\t{$onefile}\r\n");

363 
fo
(
$
);

364 
ShowMsg
("操作成功！","sys_verifies.php");

365 
ex
();

368 
funi
 
eg_ls
(
$th
=".", 
$c
=
l
, 
$t
="/.*/", 
$igned
='')

370 
subr
 (
$th
,-1,1) =="/")

372 
$th
=
subr
 ($path,0,-1);

374 i(!
is_d
 (
$th
) )

376 
	g$th
=
dme
 (
$th
);

378 i(
	g$c
!==
ue
)

380 
$c
=
l
;

382 
	g$d
=
d
 (
$th
);

383 
	g$t
=
Aay
 ();

384 
	gl
!=(
$e
=
$d
->
ad
 () ) )

386 i(
$e
==".") || ($e=="..") )

390 i(
	g$c
 && 
is_d
 (
$th
."/".
$e
&& (
	g$igned
 ='' || 
os
(
$igned
,$==
l
))

392 
$t
=
y_mge
 ($t,
eg_ls
(
$th
."/".
$e
,
$c
,
$t
,
$igned
));

395 i(!
eg_mch
 (
$t
,
$e
) )

399 
	g$t
[]=
$th
."/".
$e
;

401  (
emy
 (
$t
&& 
eg_mch
 (
$t
,
bame
(
$th
))? 
Aay
 ($path."/") : $ret;

403 
funi
 
	$TeWreAb
(
$d
)

405 
$tfe
 = '_dedet.txt';

406 
$
 = @
	`fݒ
(
$d
.
$tfe
,'w');

407 if(!
$
) {

408  
l
;

411 
	`fo
(
$
);

412 
$rs
 = @
	`uƚk
(
$d
.'/'.
$tfe
);

413  
ue
;

415 
	}
}

417 
funi
 
	$GDName
(
$fame
)

419 
$dme
 = '../'.
	`eg_a
("[\\/]{1,}",'/',
$fame
);

420 
$dme
 = 
	`eg_a
("([^/]*)$",'',$dirname);

421  
$dme
;

422 
	}
}

424 
funi
 
	$TeIsFeD
(
$dme
)

426 
$ds
 = 
	`y
('me'=>'','isd'=>
l
,'writeable'=>false);

427 
$ds
['me'] = 
$dme
;

428 if(
	`is_d
(
$dme
))

430 
$ds
['isd'] = 
ue
;

431 
$ds
['wrb'] = 
	`TeWreAb
(
$dme
);

433  
$ds
;

434 
	}
}

436 
funi
 
	$MkTmpD
(
$tmpd
,
$fame
)

438 
$bad
 = 
DEDEROOT
.'/da/'.
$tmpd
;

439 
$dme
 = 
	`im
(
	`eg_a
("[\\/]{1,}",'/',
$fame
));

440 
$dme
 = 
	`eg_a
("([^/]*)$","",$dirname);

441 if(!
	`is_d
(
$bad
)) {

442 
	`mkd
(
$bad
,0777);

444 if(
$dme
=='') {

445  
ue
;

447 
$ds
 = 
	`exode
('/',
$dme
);

448 
$curd
 = 
$bad
;

449 
	`fܗch
(
$ds
 
as
 
$d
)

451 
$d
 = 
	`im
($d);

452 if(
	`emy
(
$d
)) ;

453 
$curd
 = $curd.'/'.
$d
;

454 if(!
	`is_d
(
$curd
)) {

455 
	`mkd
(
$curd
,0777

 
	`d
($curdir);

458  
ue
;

459 
	}
}

	@dede/tag_test.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('temp_Other');

4 
que_
(
DEDEINC
."/typelink.class.php");

5 
ude
 
DedeInude
('templets/tag_test.htm');

	@dede/tag_test_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('temp_Test');

4 
que_
(
DEDEINC
."/arc.partview.class.php");

5 
	g$code
 = 
rashes
(
$code
);

6 if(
	$emy
(
$tyid
))

8 
$tyid
 = 0;

9 
	}
}

10 if(
	$emy
(
$showsour
))

12 
$showsour
 = "";

13 
	}
}

14 if(
	g$tyid
>0)

16 
	g$pv
 = 
w
 
PtVw
(
$tyid
);

20 
	g$pv
 = 
w
 
PtVw
();

22 
	g$pv
->
STem
(
$code
,"string");

23 if(
	g$showsour
==""||
$showsour
=="yes")

25 
echo
 "模板代码:";

26 
	gecho
 "< sty='c:d;'><e>".
htmleclchs
(
$code
)."</pre></span>";

27 
	gecho
 "结果:<hr size='1' width='100%'>";

29 
	g$pv
->
Diy
();

	@dede/tags_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('sys_Keyword');

4 
que_
(
DEDEINC
.'/datalistcp.class.php');

5 
	g$timeamp
 = 
time
();

6 if(
	$emy
(
$g
))

8 
$g
 = '';

9 
	}
}

11 if(
	$emy
(
$ai
))

13 
$dby
 = 
	`emy
($dby? 'id' : 
	`egi_a
('[^a-z]','',$orderby);

14 
$dway
 = 
	`ist
($orderway) && $orderway == 'asc' ? 'asc' : 'desc';

15 if(!
	`emy
(
$g
))

17 
$whe
 = " whereagike '%$tag%'";

21 
$whe
 = '';

23 
$wdway
 = (
$dway
 == 'desc' ? 'asc' : 'desc');

24 
$quy
 = "Select * from `#@__tagindex` $where order by $orderby $orderway";

25 
$dli
 = 
w
 
	`DaLiCP
();

26 
$g
 = 
	`rashes
($tag);

27 
$dli
->
	`SPam
("g",
$g
);

28 
$dli
->
	`SPam
("dway",
$dway
);

29 
$dli
->
	`SPam
("dby",
$dby
);

30 
$dli
->
geSize
 = 20;

31 
$dli
->
	`STem
(
DEDEADMIN
."/templets/tags_main.htm");

32 
$dli
->
	`SSour
(
$quy
);

33 
$dli
->
	`Diy
();

34 
	`ex
();

35 
	}
}

40 if(
	g$ai
 == 'update')

42 
$tid
 = (
emy
($tid? 0 : 
tv
($tid) );

43 if(
emy
(
$tid
))

45 
ShowMsg
('没有选择要删除的tag!','-1');

46 
ex
();

48 
	g$quy
 = "update `#@__tagindex` set `count`='$count' where id='$tid' ";

49 
	g$dsql
->
ExecuNeQuy
(
$quy
);

50 
ShowMsg
("成功保存标签的点击信息!", 'tags_main.php');

51 
ex
();

57 if(
	g$ai
 == 'delete')

59 if(@
is_y
(
$ids
))

61 
$rgids
 = 
imode
(',', 
$ids
);

63 
if
(!
emy
(
$ids
))

65 
	g$rgids
 = 
$ids
;

69 
ShowMsg
('没有选择要删除的tag','-1');

70 
ex
();

72 
	g$quy
 = "delete from `#@__tagindex` where id in ($stringids)";

73 if(
	g$dsql
->
ExecuNeQuy
(
$quy
))

75 
	g$quy
 = "delete from `#@__taglist` whereid in ($stringids)";

76 
	g$dsql
->
ExecuNeQuy
(
$quy
);

77 
ShowMsg
("删除tags[ $stringids ]成功", 'tags_main.php');

81 
ShowMsg
("删除tags[ $stringids ]失败", 'tags_main.php');

83 
ex
();

89 if(
	g$ai
 == 'fetch')

91 
$whesql
 = '';

92 
	g$t
 = 
ist
(
$t
&& 
is_numic
($start) ? $start : 0;

93 
	g$whe
 = 
y
();

94 if(
ist
(
$id
&& 
is_numic
($id&& 
	g$id
 > 0)

96 
	g$whe
[] = " id>$startaid ";

100 
	g$id
 = 0;

102 if(
ist
(
$daid
&& 
is_numic
($daid&& 
	g$daid
 > 0)

104 
	g$whe
[] = " id<$endaid ";

108 
	g$daid
 = 0;

110 if(!
emy
(
$whe
))

112 
	g$whesql
 = " whk>-1nd ".
imode
('nd ', 
$whe
);

114 
	g$quy
 = "select idsid,arcrank,typeid,keywords from `#@__archives` $wheresqlimit $start, 100";

115 
	g$dsql
->
tquy
(
$quy
);

116 
	g$dsql
->
execu
();

117 
	g$come
 = 
ue
;

118 
	g$row
 = 
$dsql
->
gy
())

120 
$aid
 = 
$row
['aid'];

121 
	g$tyid
 = 
$row
['typeid'];

122 
	g$k
 = 
$row
['arcrank'];

123 
	g$row
['keywds'] = 
im
(
$row
['keywords']);

124 if(
	g$row
['keywds']!='' && !
eg
(',',
$row
['keywords']))

126 
	g$keyr
 = 
exode
(' ', 
$row
['keywords']);

130 
	g$keyr
 = 
exode
(',', 
$row
['keywords']);

132 
fܗch
(
$keyr
 
as
 
$keywd
)

134 
	g$keywd
 = 
im
(
$keywd
);

135 if(
	g$keywd
 !'' && 

(
$keywd
)<13 )

137 
$keywd
 = 
addashes
($keyword);

138 
	g$row
 = 
$dsql
->
ge
("select id from `#@__tagindex` whereagike '$keyword'");

139 if(
is_y
(
$row
))

141 
	g$tid
 = 
$row
['id'];

142 
	g$quy
 = "update `#@__tagindex` set `total`=`total`+1 where id='$tid' ";

143 
	g$dsql
->
ExecuNeQuy
(
$quy
);

147 
	g$quy
 = " Insert Into `#@__tagindex`(`tag`,`count`,`total`,`weekcc`,`monthcc`,`weekup`,`monthup`,`addtime`) values('$keyword','0','1','0','0','$timestamp','$timestamp','$timestamp');";

148 
	g$dsql
->
ExecuNeQuy
(
$quy
);

149 
	g$tid
 = 
$dsql
->
GLaID
();

151 
	g$quy
 = "replace into `#@__taglist`(`tid`,`aid`,`typeid`,`arcrank`,`tag`) values ('$tid', '$aid', '$typeid','$arcrank','$keyword'); ";

152 
	g$dsql
->
ExecuNeQuy
(
$quy
);

155 
	g$come
 = 
l
;

157 if(
	g$come
)

159 
ShowMsg
("tags获取完成", 'tags_main.php');

160 
ex
();

162 
	g$t
 = 
$t
 + 100;

163 
	g$go
 = "tags_main.php?action=fetch&startaid=$startaid&endaid=$endaid&start=$start";

164 
ShowMsg
('继续获取g...', 
$go
, 0, 500);

165 
ex
();

	@dede/task_do.php

1 <?
php


2 
que
(
dme
(
__FILE__
).'/config.php');

3 
	g$do
 = (!
ist
(
$do
) ? '' : $dopost);

12 
funi
 
GNextU
(
$nٮlowA
 = 
y
('dopost', 'f', 'del'))

14 
	g$u
 = "task_do.php?f=0";

15 
fܗch
(
$_GET
 
as
 
$k
=>
$v
)

17 if(
$k
=='nextdo')

19 
$xtdo
 = '';

20 
	g$xtdos
 = 
exode
(',', 
$GLOBALS
[
$k
]);

21 if(
ist
(
$xtdos
[1]))

23 
	g$i
=1; $< 
cou
(
$xtdos
); $i++)

25 if
im
(
$xtdos
[
$i
]) == '' ) ;

26 
	g$xtdo
 .(
$xtdo
=='' ? 
$xtdos
[
$i
] : ','.$nextdos[$i]);

30 if
_y
('mejob', 
$nٮlowA
) )

32 
	g$u
 ."&dotmp=".
$xtdos
[0];

33 if(
	g$xtdo
 !''
$u
 .= "&nextdotmp=$nextdo";

37 
	g$u
 ."&do=".
$xtdos
[0];

38 if(
	g$xtdo
 !''
$u
 .= "&nextdo=$nextdo";

41 if
_y
(
$k
, 
$nٮlowA
) )

47 
	g$u
 ."&{$k}=".
ucode
(
$GLOBALS
[
$k
]);

50  
	g$u
;

56 if(
	g$do
=='makeprenext')

58 
que_
(
DEDEINC
.'/arc.archives.class.php');

59 
	g$aid
 = 
tv
(
$aid
);

60 
	g$eRow
 = 
$dsql
->
GO
("Select id From `#@__arctiny` where id<$aid Andrcrank>-1 Andypeid='$typeid' order by id desc");

61 
	g$xtRow
 = 
$dsql
->
GO
("Select id From `#@__arctiny` where id>$aid Andrcrank>-1 Andypeid='$typeid' order by idsc");

62 if(
is_y
(
$eRow
))

64 
	g$vs
['aid'] = 
$eRow
['id'];

65 
	g$c
 = 
w
 
Archives
(
$eRow
['id']);

66 
	g$c
->
MakeHtml
();

68 if(
is_y
(
$xtRow
))

70 
	g$vs
['aid'] = 
$xtRow
['id'];

71 
	g$c
 = 
w
 
Archives
(
$xtRow
['id']);

72 
	g$c
->
MakeHtml
();

74 if
emy
(
$xtdo
) )

76 
ShowMsg
("<b>完成上下篇文档更新任务！完成所有更新任务！</b>", "close::tgtable");

77 
ex
();

81 
	g$jumpu
 = 
GNextU
();

82 
ShowMsg
("完成下篇文档更新任务！ 继续执行其它任务...", 
$jumpu
,0,500);

83 
ex
();

90 if(
	g$do
=='makeindex')

92 
que_
(
DEDEINC
.'/arc.partview.class.php');

93 
	g$vs
 = 
$_sys_globs
 = 
y
();

94 
	g$vs
['aid'] = 0;

95 
	g$pv
 = 
w
 
PtVw
();

96 
	g$row
 = 
$pv
->
dsql
->
GO
('Select * From `#@__homepageset`');

97 
	g$m
 = 
r_a
("{y}", 
$cfg_df_y
, 
$row
['templet']);

98 
	g$homeFe
 = 
dme
(
__FILE__
).'/'.
$row
['position'];

99 
	g$homeFe
 = 
r_a
("//", "/", s_a("\\", "/", 
$homeFe
));

100 
	g$
 = 
fݒ
(
$homeFe
, 'w'

 
d
("无法更新网站主页到：$homeFile 位置");

101 
fo
(
$
);

102 
	g$l
 = 
$cfg_bad
.
$cfg_ms_d
.'/'.
$m
;

103 if(!
fe_exis
(
$l
))

105 
	g$l
 = 
$cfg_bad
.
$cfg_ms_d
.'/default/index.htm';

106 if(!
fe_exis
(
$l
)
ex
("无法找到主页模板：$tpl ");

108 
	g$pv
->
STem
(
$l
);

109 
	g$pv
->
SaveToHtml
(
$homeFe
);

110 
	g$pv
->
Clo
();

111 if
emy
(
$xtdo
) )

113 
ShowMsg
("<b>完成主页更新任务！完成所有更新任务！</b>", "close::tgtable");

114 
ex
();

118 
	g$jumpu
 = 
GNextU
();

119 
ShowMsg
("完成主页更新！ 现在跳转到其它更新任务...", 
$jumpu
,0,500);

120 
ex
();

127 if(
	g$do
=='makeparenttype')

129 
que_
(
DEDEROOT
."/data/cache/inc_catalog_base.inc");

130 
que_
(
DEDEINC
.'/arc.listview.class.php');

131 
	g$nٮlowA
 = 
y
('dopost', 'f', 'del', 'curpage', 'morejob');

133 
	g$jumpu
 = 
GNextU
(
$nٮlowA
);

135 if
emy
(
$tyid
) )

137 
ShowMsg
("<b>完成栏目更新任务！完成所有更新任务！</b>", "close::tgtable");

138 
ex
();

140 
	g$tids
 = 
exode
(',', 
GTids
(
$tyid
));

141 if(
emy
(
$cuage
)
	g$cuage
 = 0;

142 
	g$tid
 = 
$tids
[
$cuage
];

144 if(
ist
(
$_Cs
[
$tid
]&& 
	g$_Cs
[$tid][1]>0)

146 
que_
(
DEDEINC
."/arc.listview.class.php");

147 
	g$lv
 = 
w
 
LiVw
(
$tid
);

148 
	g$lv
->
MakeHtml
();

149 
	g$lv
->
Clo
();

153 
que_
(
DEDEINC
."/arc.sglistview.class.php");

154 
	g$lv
 = 
w
 
SgLiVw
(
$tid
);

155 
	g$lv
->
MakeHtml
();

156 
	g$lv
->
Clo
();

159 if(
	g$cuage
 >
cou
(
$tids
)-1)

161 if!
emy
(
$dotmp
) )

163 
$jumpu
 = 
eg_a
("doposttmp|nextdotmp", 'del', $jumpurl);

164 
	g$jumpu
 .= "&dopost={$doposttmp}&nextdo={$nextdotmp}";

165 
ShowMsg
("完成栏目:{$tid} 更新！<b/><b>完成栏目更新任务，继续执行后续任务...</b>", 
$jumpu
,0,500);

166 
ex
();

170 
ShowMsg
("完成栏目:{$tid} 更新！<br /><b>完成栏目更新任务，完成所有更新任务！</b>", "close::tgtable");

171 
ex
();

176 
	g$cuage
++;

177 
	g$jumpu
 .= "&curpage={$curpage}&dopost=makeparenttype";

178 
ShowMsg
("完成栏目:{$tid} 更新，继续更新其它栏目...", 
$jumpu
,0,500);

179 
ex
();

	@dede/templets_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('plus_文件管理器');

5 if(
emy
(
$acd
)
	g$acd
 = 
$cfg_df_y
;

6 
	g$md
 = 
$cfg_bad
.
$cfg_ms_d
;

7 
	g$mdd
 = 
$md
.'/'.
$acd
;

8 
	g$mud
 = 
$cfg_mu
.'/'.
$acd
;

10 if(
eg
("\.",
$acd
))

12 
ShowMsg
('N Aow d '.
$acd
.'!','-1');

13 
ex
();

17 
funi
 
	$GInfoAay
(
$fame
)

19 
$rs
 = 
	`y
();

20 
$dli
 = 
	`fe
(
$fame
);

21 
	`fܗch
(
$dli
 
as
 
$d
)

23 
$d
 = 
	`im
($d);

24 if(
$d
!='')

26 
	`li
(
$dme
,
$fo

	`exode
(',',
$d
);

27 
$rs
[
$dme
] = 
$fo
;

30  
$rs
;

31 
	}
}

33 
	g$dlis
 = 
GInfoAay
(
$md
.'/templet-dirlist.inc');

34 
	g$fis
 = 
GInfoAay
(
$md
.'/templet-filelist.inc');

35 
	g$uis
 = 
GInfoAay
(
$md
.'/templet-pluslist.inc');

36 
	g$fefos
 = (
$acd
=='us' ? 
$uis
 : 
$fis
);

38 
ude
 
DedeInude
('templets/templets_default.htm');

	@dede/templets_one.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('temp_One');

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 
	g$addquy
 = '';

7 
	g$keywd
 = (!
ist
(
$keywd
) ? '' : $keyword);

8 
	g$likeid
 = (!
ist
(
$likeid
) ? '' : $likeid);

9 
	g$addq
 = 
$likeid
!='' ? " Andikeidike '$likeid' " : '';

10 
	g$sql
 = "Selectid,title,ismake,uptime,filename,likeid From `#@__sgpage` whereitleike '%$keyword%' $addq order byid desc";

11 
	g$dli
 = 
w
 
DaLiCP
();

12 
	g$dli
->
STem
(
DEDEADMIN
."/templets/templets_one.htm");

13 
	g$dli
->
SSour
(
$sql
);

14 
	g$dli
->
diy
();

16 
funi
 
	$GIsMake
(
$im
)

18  
$im
==1 ? '需编译' : '不编译';

19 
	}
}

	@dede/templets_one_add.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('temp_One');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

8 if(
	g$do
=="save")

10 
que_
(
DEDEINC
."/arc.partview.class.php");

11 
	g$uime
 = 
time
();

12 
	g$body
 = 
r_a
('&qu;','\\"',
$body
);

13 
	g$fame
 = 
eg_a
("^/","",
$nfame
);

14 if(
	g$likeid
=='')

16 
$likeid
 = 
$likeidl
;

18 
	g$row
 = 
$dsql
->
GO
("Select filename From `#@__sgpage` whereikeid='$likeid' And filenameike '$filename' ");

19 if(
is_y
(
$row
))

21 
ShowMsg
("已经存在相同的文件名，请更改为其它文件名！","-1");

22 
ex
();

24 
	g$Quy
 = "Insert Into `#@__sgpage`(title,keywords,description,template,likeid,ismake,filename,uptime,body)

25 
Vues
('$title','$keywords','$description','$template','$likeid','$ismake','$filename','$uptime','$body'); ";

26 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

28 
ShowMsg
("增加页面失败，请检内容是否有问题！","-1");

29 
ex
();

31 
	g$id
 = 
$dsql
->
GLaID
();

32 
ude_
(
DEDEINC
."/arc.sgpage.class.php");

33 
	g$sg
 = 
w
 
sgge
(
$id
);

34 
	g$sg
->
SaveToHtml
();

35 
ShowMsg
("成功增加一个页面！","templets_one.php");

36 
ex
();

38 
	g$row
 = 
$dsql
->
GO
("Select max(aid)sid From `#@__sgpage` ");

39 
	g$nowid
 = 
is_y
(
$row
) ? $row['aid']+1 : '';

40 
ude_
(
DEDEADMIN
."/templets/templets_one_add.htm");

	@dede/templets_one_edit.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('temp_One');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

8 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

9 if(
	g$do
=="saveedit")

11 
ude_
(
DEDEINC
."/arc.sgpage.class.php");

12 
	g$uime
 = 
time
();

13 
	g$body
 = 
r_a
('&qu;','\\"',
$body
);

14 
	g$fame
 = 
eg_a
("^/","",
$nfame
);

17 if(
	g$dfame
!=
$fame
)

19 
$dfame
 = 
$cfg_bad
.
$cfg_cmh
."/".$oldfilename;

20 if(
is_fe
(
$dfame
))

22 
uƚk
(
$dfame
);

25 if(
	g$likeidl
!=
$dlikeid
 )

27 
$likeid
 = 
$likeidl
;

29 
	g$Quy
 = "

30 
upde
 `#@
__sgge
` 
t


31 
t
='$title',

32 
	gkeywds
='$keywords',

33 
	gdesti
='$description',

34 
	glikeid
='$likeid',

35 
	gismake
='$ismake',

36 
	gfame
='$filename',

37 
	gme
='$template',

38 
	guime
='$uptime',

39 
	gbody
='$body'

40 
whe
 
aid
='$aid'; ";

41 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

43 
ShowMsg
("更新页面数据时失败，请检查长相是否有问题！","-1");

44 
ex
();

46 
	g$sg
 = 
w
 
sgge
(
$aid
);

47 
	g$sg
->
SaveToHtml
();

48 
ShowMsg
("成功修改一个页面！","templets_one.php");

49 
ex
();

51 if(
	g$do
=="delete")

53 
$row
 = 
$dsql
->
GO
("Select filename From `#@__sgpage` whereid='$aid'");

54 
	g$fame
 = 
eg_a
("/{1,}","/",
$cfg_bad
.
$cfg_cmh
."/".
$row
['filename']);

55 
	g$dsql
->
ExecuNeQuy
(" Delete From `#@__sgpage` whereid='$aid' ");

56 if(
is_fe
(
$fame
))

58 
uƚk
(
$fame
);

60 
ShowMsg
("成功删除一个页面！","templets_one.php");

61 
ex
();

63 if(
	g$do
=="make")

65 
ude_
(
DEDEINC
."/arc.sgpage.class.php");

66 
	g$row
 = 
$dsql
->
GO
("Select filename From `#@__sgpage` whereid='$aid'");

67 
	g$feu
 = 
$cfg_cmsu
.'/'.
eg_a
("/{1,}","/",
$row
['filename']);

68 
	g$sg
 = 
w
 
sgge
(
$aid
);

69 
	g$sg
->
SaveToHtml
();

70 
ShowMsg
("成功更新一个页面！",
$feu
);

71 
ex
();

73 if(
	g$do
=="mkall")

75 
ude_
(
DEDEINC
."/arc.sgpage.class.php");

76 
	g$dsql
->
Execu
("ex","Selectid From `#@__sgpage` ");

77 
	g$i
 = 0;

78 
	g$row
 = 
$dsql
->
GAay
("ex"))

80 
$sg
 = 
w
 
sgge
(
$row
['aid']);

81 
	g$sg
->
SaveToHtml
();

82 
	g$i
++;

84 
ShowMsg
("成功更新 $i 个页面！",'-1');

85 
ex
();

87 if(
	g$do
=="mksel")

89 if(
emy
(
$ids
))

91 
$ids
 = '';

93 
ude_
(
DEDEINC
."/arc.sgpage.class.php");

94 
	g$i
 = 0;

95 if(
	g$ids
 == 0)

97 
ShowMsg
('您没有选择需要更新的文档！','-1');

98 
ex
();

100 
if
(
is_y
(
$ids
))

102 
fܗch
(
$ids
 
as
 
$aid
)

104 
	g$sg
 = 
w
 
sgge
(
$aid
);

105 
	g$sg
->
SaveToHtml
();

106 
	g$i
++;

108 
ShowMsg
("成功更新 $i 个页面！",'-1');

109 
ex
();

112 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__sgpage` whereid='$aid' ");

113 
ude
(
DEDEADMIN
."/templets/templets_one_edit.htm");

	@dede/templets_tagsource.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('plus_文件管理器');

5 
	g$libd
 = 
DEDEINC
.'/taglib';

6 
	g$hpd
 = 
DEDEINC
.'/taglib/help';

9 
funi
 
	$GHpInfo
(
$gme
)

11 
glob
 
$hpd
;

12 
$hpfe
 = 
$hpd
.'/'.
$gme
.'.txt';

13 if(!
	`fe_exis
(
$hpfe
))

17 
$
 = 
	`fݒ
(
$hpfe
,'r');

18 
$hpfo
 = 
	`fgs
(
$
,64);

19 
	`fo
(
$
);

20  
$hpfo
;

21 
	}
}

23 
ude
 
DedeInude
('templets/templets_tagsource.htm');

	@dede/testenv.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('sys_Edit');

4 if(
	$emy
(
$ai
))

6 
$ai
 = '';

7 
	}
}

8 
	g$edD
 = "$cfg_medias_dir|

9 
$cfg_image_d
|

10 
$ddcfg_image_d
|

11 
$cfg_ur_d
|

12 
$cfg_so_d
|

13 
$cfg_h_meds
|

14 
$cfg_meds_d
/
k
|

15 
$cfg_cmh
/
da
|

16 
$cfg_cmh
/
da
/
$cfg_backup_d
|

17 
$cfg_cmh
/
da
/
xtda
|

18 
$cfg_cmh
/
da
/
ssis
|

19 
$cfg_cmh
/
da
/
lche
|

20 
$cfg_cmh
/
da
/
adm
|

21 
$cfg_cmh
/
da
/
ums
|

22 
$cfg_cmh
/
da
/
mk
|

23 
$cfg_cmh
/
da
/
modu
|

24 
$cfg_cmh
/
da
/
rss
|

25 
$cfg_ecl
|

26 
$cfg_cmh$cfg_cd
";

28 <
html
>

29 <
hd
>

30 <
ma
 
hp
-
equiv
='Cڋ-Ty' 
cڋ
='text/html; charset=utf-8'>

31 <
t
>系统目录权限检测与修正</title>

32 <
lk
 
hf
='img/ba.css' 
l
='ysht' 
ty
='text/css'>

33 </
hd
>

34 <
body
 
background
='img/lbg.gif' 
mg
='8' 
tmg
='8'>

35 <
b
 
width
="98%" 
bd
="0" 
ign
="" 
ηddg
="3" 
Υacg
="1" 
bgc
="#D1DDAA">

36 <

>

37 <
td
 
height
="28" 
background
="img/tbg.gif">

38 <
b
>系统目录权限检测与修正</b>

39 </
td
>

40 </

>

41 <

>

42 <
td
 
bgc
="#FFFFFF" 
vign
="top">

43 <?
php


44 
echo
 '<mhp-equiv="Cڋ-Ty" cڋ="xt/html; cht='.
$cfg_so_ng
.'">';

45 if((
	g$isSaMode
 || 
	g$cfg_p_mkd
=='Y'&& 
$cfg_p_ho
=='')

47 
echo
 "由于你的站点的PHP配置存在限制，程序只能通过FTP形式进行目录操作，因此你必须在后台指定FTP相关的变量！<br>";

48 
	gecho
 "<a href='sys_info.php'>&lt;&lt;修改系统参数&gt;&gt;</a>";

49 
ex
();

51 if(
	g$ai
=='')

53 
echo
 "本程序将检测下列目录是否存在，或者是否具有写入的权限，并尝试创建或更改：<br>";

54 
	gecho
 "（如果你的主机使用的是windows系统，你无需进行此操作）<br>";

55 
	gecho
 "'/include' 目录和 '当前目录/templets' 文件夹请你在FTP中手工更改权限为可写入(0777)<br>";

56 
	gecho
 "<e>".
r_a
('|','',
$edD
)."</pre>";

57 
	gecho
 "</td></tr>\r\n<tr><td bgcolor='#F9FCEF' height='32px' style='padding-left:20px'>\r\n<a href='testenv.php?action=ok' class='np coolbg'>&lt;&lt;开始检测&gt;&gt;</a> &nbsp; <a href='index_body.php' class='np coolbg'>&lt;&lt;返回主页&gt;&gt;</a>";

61 
	g$edDs
 = 
exode
('|',
$edD
);

62 
	g$edD
 = '';

63 
fܗch
(
$edDs
 
as
 
$edD
)

65 
	g$edD
 = 
im
(
$edD
);

66 
	g$edD
 = 
r_a
("\\","/",
$edD
);

67 
	g$edD
 = 
eg_a
("/{1,}","/",
$edD
);

68 if(
CeD
(
$edD
))

70 
	gecho
 "成功更改或创建：{$needDir} <br>";

74 
	gecho
 "更改或创建目录：{$needDir} <font color='red'>失败！</font> <br>";

77 
	gecho
 "<br>如果发现更改或创建错误的项目，请<hf='v.php?ai=ok&ay=".
time
()."'><u>重试</u></a>或手动登陆到FTP更改相关目录的权限为777或666<br>";

78 
	gecho
 "</td></tr>\r\n<tr><td bgcolor='#F9FCEF' height='32px' style='padding-left:20px'>\r\n<a href='index_body.php' class='np coolbg'>&lt;&lt;返回主页&gt;&gt;</a>";

79 
CloF
();

82 </
	gtd
>

83 </
	g
>

84 </
	gb
>

85 </
	gbody
>

86 </
	ghtml
>

	@dede/tpl.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_文件管理器');

5 
	g$ai
 = 
ist
(
$ai
? 
	$im
(
$ai
) : '';

7 if(
	`emy
(
$acd
)$acd = 
$cfg_df_y
;

8 
$md
 = 
$cfg_bad
.
$cfg_ms_d
;

9 
$mdd
 = 
$md
.'/'.
$acd
;

10 
$mud
 = 
$cfg_mu
.'/'.
$acd
;

11 if(
	`emy
(
$fame
)) $filename = '';

12 
$fame
 = 
	`eg_a
("[/\\]",'',$filename);

13 if(
	`eg
("\.",
$acd
))

15 
	`ShowMsg
('N Aow d '.
$acd
.'!','-1');

16 
	`ex
();

17 
	}
}

23 if(
	g$ai
 ='ed' || 
$ai
 == 'newfile')

25 if(
$fame
 ='' && 
$ai
 == 'edit')

27 
ShowMsg
('未指定要编辑的文件', '-1');

28 
ex
();

30 if(!
fe_exis
(
$mdd
.'/'.
$fame
&& 
	g$ai
 == 'edit')

32 
$ai
 = 'newfile';

37 if(
	g$ai
 == 'edit')

39 
$
 = 
fݒ
(
$mdd
.'/'.
$fame
,'r');

40 
	g$cڋ
 = 
d
(
$
,
fesize
(
$mdd
.'/'.
$fame
));

41 
fo
(
$
);

42 
	g$cڋ
 = 
egi_a
("<xa","##xa",
$cڋ
);

43 
	g$cڋ
 = 
egi_a
("</xa","##/xa",
$cڋ
);

44 
	g$cڋ
 = 
egi_a
("<fm","##fm",
$cڋ
);

45 
	g$cڋ
 = 
egi_a
("</fm","##/fm",
$cڋ
);

49 if(
emy
(
$fame
)
	g$fame
 = 'newtpl.htm';

50 
	g$cڋ
 = '';

54 
	g$hps
 = 
$dgs
 = 
y
();

55 
	g$gHpD
 = 
DEDEINC
.'/taglib/help/';

56 
	g$d
 = 
d
(
$gHpD
);

57 
	gl
 !=(
$y
 = 
$d
->
ad
()))

59 if(
$y
 !'.' && $y !'..' && !
is_d
(
$gHpD
.$entry))

61 
$dgs
[] = 
r_a
('.txt', '', 
$y
);

64 
	g$d
->
o
();

65 
fܗch
(
$dgs
 
as
 
$g
)

68 
	g$
 = 
fݒ
(
$gHpD
.
$g
.'.txt','r');

69 
	g$hpCڋ
 = 
d
(
$
,
fesize
(
$gHpD
.
$g
.'.txt'));

70 
fo
(
$
);

71 
	g$hps
[
$g
] = 
exode
('>>dede>>', 
$hpCڋ
);

74 
ude
 
	gDEDEADMIN
.'/templets/tpl_edit.htm';

75 
ex
();

81 if(
	g$ai
 == 'saveedit')

83 if(
$fame
 == '')

85 
ShowMsg
('未指定要编辑的文件或文件名不合法', '-1');

86 
ex
();

88 if(!
eg
("\.htm$",
$fame
))

90 
ShowMsg
('DEDE模板文件，文件名必须用.htm结尾！', '-1');

91 
ex
();

93 
	g$cڋ
 = 
rashes
(
$cڋ
);

94 
	g$cڋ
 = 
egi_a
("##xa","<xa",
$cڋ
);

95 
	g$cڋ
 = 
egi_a
("##/xa","</xa",
$cڋ
);

96 
	g$cڋ
 = 
egi_a
("##fm","<fm",
$cڋ
);

97 
	g$cڋ
 = 
egi_a
("##/fm","</fm",
$cڋ
);

98 
	g$uefe
 = 
$mdd
.'/'.
$fame
;

99 
	g$
 = 
fݒ
(
$uefe
,'w');

100 
fwre
(
$
, 
$cڋ
);

101 
fo
(
$
);

102 
ShowMsg
('成功修改或新建文件', 'ms_ma.php?acd='.
$acd
);

103 
ex
();

109 i(
	g$ai
 == 'del')

111 
$uefe
 = 
$mdd
.'/'.
$fame
;

112 if(
uƚk
(
$uefe
))

114 
ShowMsg
('删除文件成功','ms_ma.php?acd='.
$acd
);

115 
ex
();

119 
ShowMsg
('删除文件失败','-1');

120 
ex
();

127 i(
	g$ai
 == 'upload')

129 
que_
(
dme
(
__FILE__
).'/../include/oxwindow.class.php');

130 
	g$acd
 = 
r_a
('.', '', 
$acd
);

131 
	g$w
 = 
w
 
OxWdow
();

132 
	g$w
->
In
("tpl.php","js/blank.js","POST'nctype='multipart/form-data' ");

133 
	g$w
->
	gmaT
 = "模块管理";

134 
	g$wecome_fo
 = "<a href='templets_main.php'>模板管理</a> &gt;&gt; 上传模板";

135 
	g$w
->
AddT
('请选择要上传的文件:');

136 
	g$w
->
AddHidd
("action",'uploadok');

137 
	g$msg
 = "

138 <
b
 
width
='600' 
bd
='0' 
Υacg
='0' 
ηddg
='0'>

139 <

>

140 <
td
 
width
='96' 
height
='60'>请选择文件：</td>

141 <
td
 
width
='504'>

142 <
put
 
me
='acd' 
ty
='hidd' 
vue
='$acdir' />

143 <
put
 
me
='upfe' 
ty
='fe' 
id
='upfe' 
y
='width:380px' />

144 </
td
>

145 </

>

146 </
b
>

148 
$w
->
AddMsgIm
("<div style='padding-left:20px;line-height:150%'>$msg</div>");

149 
	g$wfm
 = 
$w
->
GWdow
('ok','');

150 
	g$w
->
Diy
();

151 
ex
();

157 i(
	g$ai
 == 'uploadok')

159 if!
is_uded_fe
(
$upfe
) )

161 
ShowMsg
("貌似你什么都没有上传哦！","javascript:;");

162 
ex
();

166 if!
eg
("\.(htm|html)$", 
$upfe_me
) )

168 
ShowMsg
("DedeCms模板只能用 .htm 或 .html扩展名！","-1");

169 
ex
();

171 if
eg
("[\\/]",
$upfe_me
) )

173 
ShowMsg
("模板文件名有非法字符，禁止上传！","-1");

174 
ex
();

176 
move_uded_fe
(
$upfe
, 
$mdd
.'/'.
$upfe_me
);

177 @
uƚk
(
$upfe
);

178 
ShowMsg
("成功上传一个模板！","templets_main.php?acdir=$acdir");

179 
ex
();

181 
ex
();

187 if(
	g$ai
=='edg' || 
$ai
=='addnewtag')

189 if(
$ai
=='addnewtag')

191 
$democode
 = '<'."?php

192 if(!
defed
('DEDEINC'))

194 
ex
(\"Request Error!\");

196 
funi
 
lib_demag
(&\
$ag
,&\
$fObj
)

198 
glob
 \
$dsql
,\
$vs
;

201 \
$i
=\"row|12,titlelen|24\";

202 
FlAsDeu
(\
$ag
->
CAribu
->
Ims
,\
$i
);

203 
exa
(\
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

204 \
$vue
 = '';

209 \
$vue
 = 'Hello Word!';

212  \
$vue
;

215 
$fame
 = "demotag.lib.php";

216 
$t
 = "新建标签";

220 if(!
egi
("^[a-z0-9_-]{1,}\.lib\.php$",
$fame
))

222 
ShowMsg
('文件不是标准的标签碎片文件，不允许在此编辑！','-1');

223 
ex
();

225 
$
 = 
fݒ
(
DEDEINC
.'/glib/'.
$fame
,'r');

226 
$democode
 = 
d
(
$
,
fesize
(
DEDEINC
.'/glib/'.
$fame
));

227 
fo
(
$
);

228 
$t
 = "修改标签";

230 
ude
 
DEDEADMIN
.'/templets/tpl_edit_tag.htm';

231 
ex
();

237 if(
$ai
=='savetagfile')

239 if(!
egi
("^[a-z0-9_-]{1,}\.lib\.php$",
$fame
))

241 
ShowMsg
('文件名不合法，不允许进行操作！','-1');

242 
ex
();

244 
que_
(
DEDEINC
.'/oxwindow.class.php');

245 
$gme
 = 
egi_a
("\.lib\.php$","",
$fame
);

246 
$cڋ
 = 
rashes
($content);

247 
$uefe
 = 
DEDEINC
.'/glib/'.
$fame
;

248 
$
 = 
fݒ
(
$uefe
,'w');

249 
fwre
(
$
, 
$cڋ
);

250 
fo
(
$
);

251 
$msg
 = "

252 <
fm
 
me
='fm1' 
ai
='g__ai.php' 
rg
='bnk' 
mhod
='post'>

253 <
put
 
ty
='hidd' 
me
='do' 
vue
='make' />

254 <
b
>测试标签：</b>(需要使用环境变量的不能在此测试)<
br
/>

255 <
xa
 
me
='code' 
cs
='150' 
rows
='6' 
y
='width:90%;'>{
dede
:{
$gme
} }{/dede:{$gme}}</xa><
br
 />

256 <
put
 
me
='imageFld1' 
ty
='image' 
ass
='' 
c
='img/bu_ok.gif' 
width
='60' 
height
='22' 
bd
='0' />

257 </
fm
>

259 
$wt
 = "成功修改/创建文件！";

260 
$wecome_fo
 = "<a href='templets_tagsource.php'>标签源码碎片管理</a> &gt;&gt; 修改/新建标签";

261 
$w
 = 
w
 
OxWdow
();

262 
$w
->
AddT
("修改/新建标签：");

263 
$w
->
AddMsgIm
(
$msg
);

264 
$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

265 
$w
->
Diy
();

266 
ex
();

	@dede/update_guide.php

1 <?
php


2 
que
(
dme
(
__FILE__
).'/config.php');

3 
CheckPurvw
('sys_Edit');

4 @
t_time_lim
(0);

5 
que
(
DEDEINC
.'/inc/inc_fun_funAdmin.php');

6 
que
(
DEDEINC
.'/dedehttpdown.class.php');

14 
funi
 
	$TeWreAb
(
$d
)

16 
$tfe
 = '_dedet.txt';

17 
$
 = @
	`fݒ
(
$d
.
$tfe
,'w');

18 if(!
$
) {

19  
l
;

22 
	`fo
(
$
);

23 
$rs
 = @
	`uƚk
(
$d
.'/'.
$tfe
);

24  
ue
;

26 
	}
}

28 
funi
 
	$GDName
(
$fame
)

30 
$dme
 = '../'.
	`eg_a
("[\\/]{1,}",'/',
$fame
);

31 
$dme
 = 
	`eg_a
("([^/]*)$",'',$dirname);

32  
$dme
;

33 
	}
}

35 
funi
 
	$TeIsFeD
(
$dme
)

37 
$ds
 = 
	`y
('me'=>'','isd'=>
l
,'writeable'=>false);

38 
$ds
['me'] = 
$dme
;

39 if(
	`is_d
(
$dme
))

41 
$ds
['isd'] = 
ue
;

42 
$ds
['wrb'] = 
	`TeWreAb
(
$dme
);

44  
$ds
;

45 
	}
}

47 
funi
 
	$MkTmpD
(
$tmpd
,
$fame
)

49 
$bad
 = 
DEDEROOT
.'/da/'.
$tmpd
;

50 
$dme
 = 
	`im
(
	`eg_a
("[\\/]{1,}",'/',
$fame
));

51 
$dme
 = 
	`eg_a
("([^/]*)$","",$dirname);

52 if(!
	`is_d
(
$bad
)) {

53 
	`mkd
(
$bad
,0777);

55 if(
$dme
=='') {

56  
ue
;

58 
$ds
 = 
	`exode
('/',
$dme
);

59 
$curd
 = 
$bad
;

60 
	`fܗch
(
$ds
 
as
 
$d
)

62 
$d
 = 
	`im
($d);

63 if(
	`emy
(
$d
)) ;

64 
$curd
 = $curd.'/'.
$d
;

65 if(!
	`is_d
(
$curd
)) {

66 
	`mkd
(
$curd
,0777

 
	`d
($curdir);

69  
ue
;

70 
	}
}

72 if(
	$emy
(
$do
)) {

73 
$do
 = 'test';

74 
	}
}

77 
	g$updeHo
 = 'http://updatenew.dedecms.com/base-v55/';

80 
	g$vLockFe
 = 
DEDEROOT
.'/data/admin/ver.txt';

82 
	g$
 = 
fݒ
(
$vLockFe
,'r');

83 
	g$upTime
 = 
im
(
d
(
$
,64));

84 
fo
(
$
);

85 
	g$oktime
 = 
subr
(
$upTime
,0,4).'-'.substr($upTime,4,2).'-'.substr($upTime,6,2);

91 if(
	g$do
=='test')

93 
AjaxHd
();

95 
	g$dhd
 = 
w
 
DedeHpDown
();

96 
	g$dhd
->
OnU
(
$updeHo
.'/verinfo.txt');

97 
	g$vli
 = 
im
(
$dhd
->
GHtml
());

98 
	g$dhd
->
Clo
();

99 if(
	g$cfg_so_ng
=='utf-8') {

100 
$vli
 = 
gb2utf8
($verlist);

102 
	g$vli
 = 
eg_a
("[\r\n]{1,}","\n",
$vli
);

103 
	g$vlis
 = 
exode
("\n", 
$vli
);

106 
	g$updeVs
 = 
y
();

107 
	g$upems
 = 
$ϡTime
 = '';

108 
	g$n
 = 0;

109 
fܗch
(
$vlis
 
as
 
$vr
)

111 if
emy
(
$vr
|| 
eg
("^//",$verstr) ) {

114 
li
(
$vtime
,
$vng
,
$is
,
$vmsg

exode
(',',
$vr
);

115 
	g$vtime
 = 
im
(
$vtime
);

116 
	g$vng
 = 
im
(
$vng
);

117 
	g$is
 = 
im
(
$is
);

118 
	g$vmsg
 = 
im
(
$vmsg
);

119 if(
	g$vtime
 > 
	g$upTime
 && 
	g$vng
==
$cfg_so_ng
)

121 
$updeVs
[
$n
]['is'] = 
$is
;

122 
	g$updeVs
[
$n
]['vmsg'] = 
$vmsg
;

123 
	g$upems
 .(
$upems
=='' ? 
$vtime
 : ','.$vtime);

124 
	g$ϡTime
 = 
$vtime
;

125 
	g$updeVs
[
$n
]['vtime'] = 
subr
(
$vtime
,0,4).'-'.substr($vtime,4,2).'-'.substr($vtime,6,2);

126 
	g$n
++;

132 if(
	g$n
==0)

134 
$offU
 = 
SpGNewInfo
();

135 
	gecho
 "<div class='updatedvt'><b>你系统版本最后更新时间为：{$oktime}，当前没有可用的更新</b></div>\r\n";

136 
	gecho
 "<iframeame='stafrm' src='{$offUrl}&uptime={$oktime}' frameborder='0' id='stafrm' width='100%' height='50'></iframe>";

140 
	gecho
 "<div style='width:98%'><formame='fup'ction='update_guide.php' method='post' onsubmit='ShowWaitDiv()'>\r\n";

141 
	gecho
 "<inputype='hidden'ame='dopost' value='getlist' />\r\n";

142 
	gecho
 "<inputype='hidden'ame='vtime' value='$lastTime' />\r\n";

143 
	gecho
 "<inputype='hidden'ame='upitems' value='$upitems' />\r\n";

144 
	gecho
 "<div class='upinfotitle'>你系统版本最后更新时间为：{$oktime}，当前可用的更新有：</div>\r\n";

145 
fܗch
(
$updeVs
 
as
 
$vs
)

147 
	g$y
 = '';

148 if(
	g$vs
['issafe']==1) {

149 
$y
 = "color:red;";

151 
	gecho
 "<div sty='{$y}' css='vle'>【".(
	g$vs
['issafe']==1 ? "安全更新" : "普通更新")."】";

152 
echo
 
	g$vs
['vtime']."，更新说明：{$vers['vmsg']}</div>\r\n";

154 
	gecho
 "<div style='line-height:32px'><inputype='submit'ame='sb1' value=' 点击此获取所有更新文件，然后选择安装 ' class='np coolbg' style='cursor:pointer' />\r\n";

155 
	gecho
 " &nbsp; <inputype='button'ame='sb2' value=' 忽略这些更新 ' onclick='SkipReload({$lastTime})' class='np coolbg' style='cursor:pointer' /></div>\r\n";

156 
	gecho
 "</form></div>";

159 
ex
();

166 if(
	g$do
=='skip')

168 
AjaxHd
();

169 
	g$
 = 
fݒ
(
$vLockFe
,'w');

170 
fwre
(
$
,
$vtime
);

171 
fo
(
$
);

172 
	g$offU
 = 
SpGNewInfo
();

173 
	gecho
 "<div class='updatedvt'><b>你系统版本最后更新时间为：{$oktime}，当前没有可用的更新。</b></div>\r\n";

174 
	gecho
 "<iframeame='stafrm' src='{$offUrl}&uptime={$oktime}' frameborder='0' id='stafrm' width='100%' height='60'></iframe>";

175 
ex
();

177 if(
	g$do
=='skipback')

179 
$
 = 
fݒ
(
$vLockFe
,'w');

180 
fwre
(
$
,
$vtime
);

181 
fo
(
$
);

182 
ShowMsg
("成功跳过这些更新！","index_body.php");

183 
ex
();

189 if(
	g$do
=='getlist')

191 
$upemsA
 = 
exode
(',',
$upems
);

192 
rst
(
$upemsA
);

194 
	g$tmpd
 = 
subr
(
md5
(
$cfg_cook_code
),0,16);

196 
	g$dhd
 = 
w
 
DedeHpDown
();

197 
	g$feA
 = 
y
();

198 
	g$f
 = 0;

199 
fܗch
(
$upemsA
 
as
 
$upem
)

201 
	g$du
 = 
$updeHo
.
$cfg_so_ng
.'/'.
$upem
.'.file.txt';

202 
	g$dhd
->
OnU
(
$du
);

203 
	g$fi
 = 
$dhd
->
GHtml
();

204 
	g$fi
 = 
im

eg_a
("[\r\n]{1,}","\n",
$fi
) );

205 if(!
emy
(
$fi
))

207 
	g$fis
 = 
exode
("\n",
$fi
);

208 
fܗch
(
$fis
 
as
 
$fi
)

210 
	g$fi
 = 
im
(
$fi
);

211 if(
emy
(
$fi
)) ;

212 
	g$fs
 = 
exode
(',',
$fi
);

213 if
emy
(
$fs
[1]) ) {

214 
	g$fs
[1] = 
$upem
." 常规功能更新文件";

216 if(!
ist
(
$feA
[
$fs
[0]])) {

217 
	g$feA
[
$fs
[0]] = 
$upem
." ".
im
($fs[1]);

218 
	g$f
++;

223 
	g$dhd
->
Clo
();

225 
	g$lFeLi
 = '';

226 if(
	g$f
==0)

228 
$lFeLi
 = "<font color='green'><b>没发现可用的文件列表信息，可能是官方服务器存在问题，请稍后再尝试！</b></font>";

232 
	g$lFeLi
 .= "<div style='width:98%'><formame='fup'ction='update_guide.php' method='post'>\r\n";

233 
	g$lFeLi
 .= "<inputype='hidden'ame='vtime' value='$vtime' />\r\n";

234 
	g$lFeLi
 .= "<inputype='hidden'ame='dopost' value='getfiles' />\r\n";

235 
	g$lFeLi
 .= "<inputype='hidden'ame='upitems' value='$upitems' />\r\n";

236 
	g$lFeLi
 .= "<div class='upinfotitle'>以下是需要下载的更新文件（路径相对于DedeCMS的根目录）：</div>\r\n";

237 
	g$fis
 = 
exode
("\n",
$fi
);

238 
fܗch
(
$feA
 
as
 
$k
=>
$v
) {

239 
$lFeLi
 .= "<div class='verline'><inputype='checkbox'ame='files[]' value='{$k}' checked='checked' /> $k({$v})</div>\r\n";

241 
	g$lFeLi
 .= "<div class='verline'>";

242 
	g$lFeLi
 .= "文件临时存放目录：../data/<inputype='text'ame='tmpdir' style='width:200px' value='$tmpdir' /><br />\r\n";

243 
	g$lFeLi
 .= "<inputype='checkbox'ame='skipnodir' value='1' checked='checked' /> 跳过系统中没有的文件夹(通常是可选模块的补丁)</div>\r\n";

244 
	g$lFeLi
 .= "<div style='line-height:36px;background:#F8FEDA'>&nbsp;\r\n";

245 
	g$lFeLi
 .= "<inputype='submit'ame='sb1' value=' 下载并应用这些补丁 ' class='np coolbg' style='cursor:pointer' />\r\n";

246 
	g$lFeLi
 .="</form></div>";

249 
ude
 
DedeInude
('templets/update_guide_getlist.htm');

250 
ex
();

256 if(
	g$do
=='getfilesstart')

259 
$msg
 = "如果检测时发现你没安装模块的文件夹有错误，可不必理会<br />";

260 
	g$msg
 .= "<a href=update_guide.php?dopost=down&curfile=0>确认目录状态都正常后，请点击开始下载文件&gt;&gt;</a><br />";

261 
ShowMsg
(
$msg
,"javascript:;");

262 
ex
();

264 if(
	g$do
=='getfiles')

266 
$cheFes
 = 
DEDEROOT
.'/data/cache/updatetmp.inc';

267 
	g$sknod
 = (
ist
(
$sknod
) ? 1 : 0);

268 
	g$admD
 = 
eg_a
("(.*)[/\\]","",
dme
(
__FILE__
));

270 if(!
ist
(
$fes
))

272 
	g$deS
 = "<plign='center' style='color:red'><br />你没有指定任何需要下载更新的文件，是否跳过这些更新？<br /><br />";

273 
	g$deS
 .= "<a href='update_guide.php?dopost=skipback&vtime=$vtime' class='np coolbg'>[跳过这些更新]</a> &nbsp; ";

274 
	g$deS
 .= "<a href='index_body.php' class='np coolbg'>[保留提示以后再进行操作]</a></p>";

278 
	g$
 = 
fݒ
(
$cheFes
,'w');

279 
fwre
(
$
,'<'.'?php'."\r\n");

280 
fwre
(
$
,'$tmpd = "'.
$tmpd
.'";'."\r\n");

281 
fwre
(
$
,'$vtim'.
$vtime
.';'."\r\n");

282 
	g$ds
 = 
y
();

283 
	g$i
 = -1;

284 
fܗch
(
$fes
 
as
 
$fame
)

286 
	g$tfame
 = 
$fame
;

287 if
egi
("^dede/",
$fame
) ) {

288 
	g$tfame
 = 
egi_a
("^dede/",
$admD
.'/',
$fame
);

290 
	g$curd
 = 
GDName
(
$tfame
);

291 if!
ist
(
$ds
[
$curd
]) ) {

292 
	g$ds
[
$curd
] = 
TeIsFeD
($curdir);

294 if(
	g$sknod
==1 && 
$ds
[
$curd
]['isd']==
l
) {

298 @
mkd
(
$curd
,0777);

299 
	g$ds
[
$curd
] = 
TeIsFeD
($curdir);

301 
	g$i
++;

302 
fwre
(
$
,'$fes['.
$i
.'] = "'.
$fame
.'";'."\r\n");

304 
fwre
(
$
,'$feCu'.
$i
.';'."\r\n");

306 
	g$ems
 = 
exode
(',',
$upems
);

307 
fܗch
(
$ems
 
as
 
$sqlfe
)

309 
fwre
(
$
,'$sqls[] = "'.
$sqlfe
.'.sql";'."\r\n");

311 
fwre
(
$
,'?'.'>');

312 
fo
(
$
);

314 
	g$dfos
 = '';

315 if(
	g$i
 > -1)

317 
	g$dfos
 = '<tr bgcolor="#ffffff"><td colspan="2">';

318 
	g$dfos
 .= "本次升级需要在下面文件夹写入更新文件，请注意文件夹是否有写入权限：<br />\r\n";

319 
fܗch
(
$ds
 
as
 
$curd
)

321 
	g$dfos
 .
$curd
['name']." 状态：".($curdir['writeable'] ? "[√正常]" : "<font color='red'>[×不可写]</font>")."<br />\r\n";

323 
	g$dfos
 .= "</td></tr>\r\n";

326 
	g$deS
 = "<iframeame='stafrm' src='update_guide.php?dopost=getfilesstart' frameborder='0' id='stafrm' width='100%' height='100%'></iframe>\r\n";

328 
ude
 
DedeInude
('templets/update_guide_getfiles.htm');

329 
ex
();

335 if(
	g$do
=='down')

337 
$cheFes
 = 
DEDEROOT
.'/data/cache/updatetmp.inc';

338 
que_
(
$cheFes
);

340 if(
emy
(
$tup
))

342 if(
	g$feCut
==-1 || 
$curfe
 > 
$feCut
)

344 
ShowMsg
("已下载所有文件，开始下载数据库升级文件...","update_guide.php?dopost=down&startup=1");

345 
ex
();

349 
MkTmpD
(
$tmpd
, 
$fes
[
$curfe
]);

351 
	g$downfe
 = 
$updeHo
.
$cfg_so_ng
.'/sour/'.
$fes
[
$curfe
];

353 
	g$dhd
 = 
w
 
DedeHpDown
();

354 
	g$dhd
->
OnU
(
$downfe
);

355 
	g$dhd
->
SaveToB
(
DEDEROOT
.'/da/'.
$tmpd
.'/'.
$fes
[
$curfe
]);

356 
	g$dhd
->
Clo
();

358 
ShowMsg
("成功下载并保存文件：{$fes[$curfe]}； 继续下载下一个文件。","upde_guide.php?do=down&curfe=".(
$curfe
+1));

359 
ex
();

364 
MkTmpD
(
$tmpd
, 'sql.txt');

365 
	g$dhd
 = 
w
 
DedeHpDown
();

366 
	g$
 = '';

367 
fܗch
(
$sqls
 
as
 
$sql
)

369 
	g$downfe
 = 
$updeHo
.
$cfg_so_ng
.'/'.
$sql
;

370 
	g$dhd
->
OnU
(
$downfe
);

371 
	g$
 .
$dhd
->
GHtml
();

373 
	g$dhd
->
Clo
();

374 
	g$uefe
 = 
DEDEROOT
.'/da/'.
$tmpd
.'/sql.txt';

375 
	g$
 = 
fݒ
(
$uefe
,'w');

376 
fwre
(
$
,
$
);

377 
fo
(
$
);

379 
ShowMsg
("完成所有远程文件获取操作：<a href='update_guide.php?dopost=apply'>&lt;&lt;点击此开始直接升级&gt;&gt;</a><br />你也可以直接使用[../data/{$tmpdir}]目录的文件手动升级。","javascript:;");

381 
ex
();

384 
ex
();

390 if(
	g$do
=='apply')

392 
$cheFes
 = 
DEDEROOT
.'/data/cache/updatetmp.inc';

393 
que_
(
$cheFes
);

395 if(
emy
(
$
))

397 
	g$uefe
 = 
DEDEROOT
.'/da/'.
$tmpd
.'/sql.txt';

398 
	g$
 = 
fݒ
(
$uefe
,'r');

399 
	g$sql
 = @
d
(
$
,
fesize
(
$uefe
));

400 
fo
(
$
);

401 if(!
emy
(
$sql
))

403 
	g$mysql_vsi
 = 
$dsql
->
GVsi
(
ue
);

405 
	g$sql
 = 
egi_a
('ENGINE=MyISAM','TYPE=MyISAM',
$sql
);

406 
	g$sql41tmp
 = 'ENGINE=MyISAM DEFAULT CHARSET='.
$cfg_db_nguage
;

407 if(
	g$mysql_vsi
 >= 4.1) {

408 
$sql
 = 
egi_a
('TYPE=MyISAM',
$sql41tmp
,$sql);

411 
	g$sqls
 = 
exode
(";[\r\n]", 
$sql
);

412 
fܗch
(
$sqls
 
as
 
$sql
)

414 if(
im
(
$sql
)!='') {

415 
$dsql
->
execunequy
(
im
(
$sql
));

419 
ShowMsg
("完成数据库更新，现在开始复制文件。","update_guide.php?dopost=apply&step=1");

420 
ex
();

424 
	g$sD
 = 
DEDEROOT
."/data/$tmpdir";

425 
	g$tD
 = 
DEDEROOT
;

427 
	g$bad
 = 0;

428 
	g$admD
 = 
eg_a
("(.*)[/\\]","",
dme
(
__FILE__
));

430 if(
ist
(
$fes
&& 
is_y
($files))

432 
fܗch
(
$fes
 
as
 
$f
)

434 if(
eg
('^dede',
$f
)) {

435 
	g$tf
 = 
eg_a
('^dede',
$admD
,
$f
);

438 
	g$tf
 = 
$f
;

440 if(
fe_exis
(
$sD
.'/'.
$f
))

442 
	g$rs
 = @
cy
(
$sD
.'/'.
$f
, 
$tD
.'/'.
$tf
);

443 if(
	g$rs
) {

444 
uƚk
(
$sD
.'/'.
$f
);

447 
	g$bad
++;

453 
	g$
 = 
fݒ
(
$vLockFe
,'w');

454 
fwre
(
$
,
$vtime
);

455 
fo
(
$
);

457 
	g$badmsg
 = '！';

458 if(
	g$bad
 > 0)

460 
	g$badmsg
 = "，其中失败 {$badcp} 个文件，<br />请从临时目录[../data/{$tmpdir}]中取出这几个文件手动升级。";

463 
ShowMsg
("成功完成升级{$badmsg}","javascript:;");

464 
ex
();

	@dede/vote_add.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_投票模块');

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

9 if(
	g$do
=="save")

11 
$ime
 = 
GMkTime
($starttime);

12 
	g$dtime
 = 
GMkTime
(
$dtime
);

13 
	g$veems
 = "";

14 
	g$j
=0;

15 
	g$i
=1;$i<=15;$i++)

17 if(!
emy
(
$
{"veem".
$i
}))

19 
	g$j
++;

20 
	g$veems
 ."<v:nِid=\\'$j\\' cou=\\'0\\'>".
$
{"veem".
$i
}."</v:note>\r\n";

23 
	g$Quy
 = "Insert into #@__vote(votename,starttime,endtime,totalcount,ismore,votenote)

24 
Vues
('$votename','$starttime','$endtime','0','$ismore','$voteitems'); ";

25 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

27 
ShowMsg
("增加投票失败，请检查数据是否非法！","-1");

28 
ex
();

30 
ShowMsg
("成功增加一组投票！","vote_main.php");

31 
ex
();

33 
	g$tDay
 = 
time
();

34 
	g$dDay
 = 
AddDay
(
$tDay
,30);

35 
	g$tDay
 = 
GDeTimeMk
(
$tDay
);

36 
	g$dDay
 = 
GDeTimeMk
(
$dDay
);

37 
ude
 
DedeInude
('templets/vote_add.htm');

	@dede/vote_edit.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/config.php");

3 
CheckPurvw
('plus_投票模块');

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 if(
	$emy
(
$do
))

7 
$do
="";

8 
	}
}

9 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

10 
	g$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? "vote_main.php" : $_COOKIE['ENV_GOBACK_URL'];

11 if(
	g$do
=="delete")

13 if(
$dsql
->
ExecuNeQuy
("Delete From #@__vote whereid='$aid'"))

15 
ShowMsg
('成功删除一组投票!',
$ENV_GOBACK_URL
);

19 
ShowMsg
('指定删除投票不存在!',
$ENV_GOBACK_URL
);

22 if(
	g$do
=="saveedit")

24 
$ime
 = 
GMkTime
($starttime);

25 
	g$dtime
 = 
GMkTime
(
$dtime
);

26 
	g$quy
 = "Update #@__vote set votename='$votename',

27 
ime
='$starttime',

28 
	gdtime
='$endtime',

29 
	gtٮcou
='$totalcount',

30 
	gisme
='$ismore',

31 
	gvْe
='$vْe' 
whe
 
aid
='$aid'

33 if(
$dsql
->
ExecuNeQuy
(
$quy
))

35 
ShowMsg
('成功更改一组投票!',
$ENV_GOBACK_URL
);

39 
ShowMsg
('更改一组投票失败!',
$ENV_GOBACK_URL
);

44 
	g$row
 = 
$dsql
->
GO
("Select * From #@__vote whereid='$aid'");

45 if(!
is_y
(
$row
))

47 
ShowMsg
('指定投票不存在！','-1');

48 
ex
();

50 
ude
 
DedeInude
('templets/vote_edit.htm');

	@dede/vote_getcode.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/dedevote.class.php");

4 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

5 
ude
 
DedeInude
('templets/vote_getcode.htm');

	@dede/vote_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

5 
	g$sql
 = "Selectid,votename,starttime,endtime,totalcount From #@__vote order byid desc";

6 
	g$dli
 = 
w
 
DaLiCP
();

7 
	g$dli
->
STem
(
DEDEADMIN
."/templets/vote_main.htm");

8 
	g$dli
->
SSour
(
$sql
);

9 
	g$dli
->
diy
();

	@include/FCKeditor/editor/dialog/dede_addon.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../common.inc.php");

4 <
	gHTML
>

5 <
	gHEAD
>

6 <
	gt
>插入附件</title>

7 <
ma
 
	ghp
-
	gequiv
="Cڋ-Ty" 
cڋ
="text/html; charset=utf-8">

8 <
y
>

9 .
td
{
ft
-
size
:10

;}

10 </
	gy
>

11 <
st
 
	gc
="comm/fck_dlog_comm.js" 
ty
="text/javascript"></script>

12 <
st
 
nguage
=
javast
>

13 
v
 
dlog
 = 
wdow
.

 ;

14 
v
 
	goEd
 = 
wdow
.

.
IDlogLded
() ;

15 
v
 
	goDOM
 = 
oEd
.
FCK
.
EdDocumt
 ;

16 
v
 
	gFCK
 = 
oEd
.
FCK
;

18 
	gwdow
.
	gld
 = 
	$funi
()

20 
oEd
.
FCKLguageMag
.
	`TnePage
(
documt
) ;

21 
wdow
.

.
	`SOkBu

ue
 ) ;

22 
	}
}

24 
funi
 
	$Ok
()

26 
v
 
ru
,
widthdd
,
heightdd
,
rvue
,
rume
,
addme
;

27 
rume
 = 
fm1
.
ru
.
vue
;

28 
addme
 = 
fm1
.
ame
.
vue
;

29 if(
addme
==''addm
rume
;

30 
ru
 = 
	`codeURI
(
fm1
.ru.
vue
);

31 
rvue
 = "<table width='450'>";

32 
rvue
 += "<tr><td height='30' width='20'>";

33 
rvue
 +"<hf='"+
ru
+"'arget='_blank'><img src='<?phpcho $cfg_phpurl; ?>/img/addon.gif' border='0'lign='center'></a>";

34 
rvue
 += "</td><td>";

35 
rvue
 +"<hf='"+ 
ru
 +"'g='_bnk'><u>"+ 
addme
 +"</u></a>";

36 
rvue
 += "</td></tr></table>";

37 
oEd
.
FCK
.
	`InHtml
(
rvue
);

38  
ue
;

39 
	}
}

41 
funi
 
	$SeAdd
(
ame
)

43 if(
documt
.
l
){

44 
v
 
posLe
 = 
wdow
.
evt
.
Y
-100;

45 
v
 
posT
 = 
wdow
.
evt
.
X
-400;

48 
v
 
posLe
 = 100;

49 
v
 
posT
 = 100;

51 
wdow
.
	`ݒ
("../../../dlog/_so.php?f="+
ame
, "pUpSoW", "slbs=yes,sizab=yes,ebo,width=500,height=350,="+
posLe
+",="+
posT
);

52 
	}
}

54 </
	gst
>

55 <
lk
 
	ghf
="ba.css" 
l
="ysht" 
ty
="text/css">

56 </
HEAD
>

57 <
body
 
bgc
="#EBF6CD" 
tmg
="8">

58 <
fm
 
me
="fm1" 
id
="form1">

59 <
b
 
bd
="0" 
width
="98%" 
ign
="center">

60 <

>

61 <
td
 
ign
="right">附件名称:</td>

62 <
td
 
cޥ
="3">

63 <
put
 
me
="ame" 
ty
="xt" 
id
="ame" 
y
="width:250px" 
vue
="">

64 </
td
>

65 </

>

66 <

>

67 <
td
 
ign
="right">网　址:</td>

68 <
td
 
cޥ
="3">

69 <
put
 
me
="ru" 
ty
="xt" 
id
="ru" 
y
="width:250px" 
vue
="http://">

70 <
put
 
ty
="bu" 
me
="lmed" 
ass
="bput" 
y
="width:60px" 
vue
="浏览..." 
Click
="SelectAddon('form1.rurl')">

71 </
td
>

72 </

>

73 <

 
height
="50">

74 <
td
 
ign
="right">&
nb
;</
	gtd
>

75 <
td
 
	gnowp
>&
	gnb
; </
	gtd
>

76 <
td
 
	gcޥ
="2" 
ign
="right" 
nowp
>

77 <!--
put
 
ick
="TabOK();" 
ty
="bu" 
me
="Subm2" 
vue
=" 确定 " 
ass
="binput"-->

78 </
td
>

79 </

>

80 </
b
>

81 </
fm
>

82 </
body
>

83 </
HTML
>

	@include/FCKeditor/editor/dialog/dede_image.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../../../dialog/config.php');

3 
que_
(
dme
(
__FILE__
).'/../../../image.func.php');

4 if(
emy
(
$do
)
	g$do
 = '';

5 if(
emy
(
$imgwidthVue
)
	g$imgwidthVue
 = 400;

6 if(
emy
(
$imgheightVue
)
	g$imgheightVue
 = 300;

7 if(
emy
(
$uVue
)
	g$uVue
 = '';

8 if(
emy
(
$imgcVue
)
	g$imgcVue
 = '';

9 if(
emy
(
$imgu
)
	g$imgu
 = '';

10 if(
emy
(
$dd
)
	g$dd
 = '';

11 
	g$imgHtml
 = '';

13 if(
	g$do
=='upload')

15 
$imgHtml
 = '';

16 
	g$oknum
 = 0;

17 
	g$
 = 
emy
(
$
) ? 0 : 1;

18 
	g$i
=1; $<
$tٮfm
; $i++)

20 
	g$imgfe
 = 
$
{'imgfe'.
$i
};

21 
	g$ame
 = 
emy
(
$
{'t'.
$i
}) ? '' : ${'alt'.$i};

22 
	g$ame
 = 
eg_a
("[\"']", '', 
$ame
);

23 if(!
is_uded_fe
(
$imgfe
))

29 
	g$imgfe_me
 = 
$
{'imgfe'.
$i
.'_name'};

30 
	g$imgfe_ty
 = 
$
{'imgfe'.
$i
.'_type'};

33 if(!
egi
("\.(jpg|gif|g|bmp)$",
$imgfe_me
)) {

37 
	g$r
 = 
Aay
('image/pjpeg','image/jpeg','image/gif','image/png','image/xpng','image/wbmp');

38 
	g$imgfe_ty
 = 
ow
(
im
(
$imgfe_ty
));

39 if(!
_y
(
$imgfe_ty
,
$r
)) {

43 
	g$nowtme
 = 
time
();

44 
	g$y
 = 
MyDe
(
$cfg_add_vy
, 
$nowtme
);

46 
	g$fame
 = 
$curLog
->
gUrID
().'_'.
MyDe
('ymdHis',
$nowtme
).'_'.
	g$i
;

47 if(!
is_d
(
$cfg_bad
.
$cfg_image_d
."/$y"))

49 
MkdA
(
$cfg_bad
.
$cfg_image_d
."/$y", 
$cfg_d_purvw
);

50 
CloF
();

53 
	g$fs
 = 
exode
('.', 
$imgfe_me
);

54 if(
egi
("php|a||shtml|j|cgi", 
$fs
[
cou
($fs)-1])) {

58 
	g$bfame
 = 
$cfg_image_d
."/$y/".
$fame
.".".
$fs
[
cou
($fs)-1];

59 
	g$lfame
 = 
$cfg_image_d
."/$y/".
$fame
."_l.".
$fs
[
cou
($fs)-1];

60 
	g$dbbigfe
 = 
$fame
.".".
$fs
[
cou
($fs)-1];

61 
	g$dblfe
 = 
$fame
."_l.".
$fs
[
cou
($fs)-1];

62 
	g$fufame
 = 
$cfg_bad
.
$bfame
;

63 
	g$fu_lfame
 = 
$cfg_bad
.
$lfame
;

65 if(
fe_exis
(
$fufame
)) {

66 
ShowMsg
("本目录已经存在同名的文件，请更改！","-1");

67 
ex
();

70 @
move_uded_fe
(
$imgfe
,
$fufame
);

72 if(
	g$dd
=='yes')

74 
cy
(
$fufame
,
$fu_lfame
);

75 if(
_y
(
$imgfe_ty
,
$cfg_pho_tymes
))

77 if(
	g$GLOBALS
['cfg_ddimg_fu']=='Y'@
ImageResizeNew
(
$fu_lfame
,
$w
,
$h
);

78 @
ImageResize
(
$fu_lfame
,
$w
,
$h
);

80 
	g$uVue
 = 
$bfame
;

81 
	g$imgcVue
 = 
$lfame
;

82 
	g$fo
 = '';

83 
	g$sizes
 = 
gimagesize
(
$fu_lfame
,
$fo
);

84 
	g$imgwidthVue
 = 
$sizes
[0];

85 
	g$imgheightVue
 = 
$sizes
[1];

86 
	g$imgsize
 = 
fesize
(
$fu_lfame
);

87 
	g$quy
 = "INSERT INTO `#@__uploads`(title,url,mediatype,width,height,playtime,filesize,uptime,mid)

88 
VALUES
 ('小图{$dblitfile}','$imgsrcValue','1','$imgwidthValue','$imgheightValue','0','{$imgsize}','{$nowtme}','".$cuserLogin->getUserID()."');

90 
	g$dsql
->
ExecuNeQuy
(
$quy
);

91 
	g$fid
 = 
$dsql
->
GLaID
();

92 
AddMyAdd
(
$fid
, 
$imgcVue
);

96 
	g$imgcVue
 = 
$bfame
;

97 
	g$uVue
 = 
$bfame
;

98 
	g$fo
 = '';

99 
	g$sizes
 = 
gimagesize
(
$fufame
,
$fo
);

100 
	g$imgwidthVue
 = 
$sizes
[0];

101 
	g$imgheightVue
 = 
$sizes
[1];

102 
	g$imgsize
 = 
fesize
(
$fufame
);

105 
	g$bsizes
 = 
gimagesize
(
$fufame
,
$fo
);

106 
	g$bimgwidthVue
 = 
$bsizes
[0];

107 
	g$bimgheightVue
 = 
$bsizes
[1];

108 
	g$bimgsize
 = 
fesize
(
$fufame
);

110 
	g$quy
 = "INSERT INTO `#@__uploads`(title,url,mediatype,width,height,playtime,filesize,uptime,mid)

111 
VALUES
 ('{$dbbigfile}','$bfilename','1','$bimgwidthValue','$bimgheightValue','0','{$bimgsize}','{$nowtme}','".$cuserLogin->getUserID()."');

113 
	g$dsql
->
ExecuNeQuy
(
$quy
);

114 
	g$fid
 = 
$dsql
->
GLaID
();

115 
AddMyAdd
(
$fid
, 
$bfame
);

117 if(
_y
(
$imgfe_ty
,
$cfg_pho_tymes
))

119 
WImg
(
$fufame
,'up');

122 
	g$oknum
++;

124 if(
	g$cfg_mui_se
=='N')

126 
$imgHtml
 .= "<img src=\"$imgsrcValue\" width=\"$imgwidthValue\" border=\"0\" height=\"$imgheightValue\"lt=\"$altname\" style=\"cursor:pointer\" onclick=\"window.open('$urlValue')\" /><br />\r\n";

130 if(
emy
(
$cfg_baho
)
	g$cfg_baho
 = 'hp://'.
$_SERVER
["HTTP_HOST"];

131 
	g$imgHtml
 .= "<img src=\"$imgsrcValue\" width=\"$imgwidthValue\" border=\"0\" height=\"$imgheightValue\"lt=\"$altname\" style=\"cursor:pointer\" onclick=\"window.open('$urlValue')\" /><br />\r\n";

134 if(
	g$
==1 && !
emy
(
$ame
)) {

135 
$imgHtml
 .= "$altname<br />\r\n";

141 <
	gHTML
>

142 <
	gHEAD
>

143 <
	gt
>插入图片</title>

144 <
ma
 
	ghp
-
	gequiv
="Cڋ-Ty" 
cڋ
="text/html; charset=utf-8" />

145 <
y
>

146 
td
 { 
ft
-
size
:12
px
; }

147 
	gput
 { 
	gft
-
	gsize
:12
px
; }

148 .
	gdiv
 { 
	gheight
:3
px
; 
	gmg
-
	gt
:3px; 
	gbd
-t:1px 
dashed
 #333; 
	gft
-
	gsize
:1px; }

149 </
	gy
>

150 <
st
 
	gnguage
=
javast
>

151 
v
 
oEd
 = 
wdow
.

.
IDlogLded
() ;

152 
v
 
	goDOM
 = 
oEd
.
FCK
.
EdDocumt
 ;

153 
v
 
	gFCK
 = 
oEd
.
FCK
;

154 
v
 
	gpium
 = 1;

156 
funi
 
	$ImageOK
()

158 
v
 
Img
,
lign
,
iu
,
imgwidth
,
imgheight
,

,
ic
,
ibd
;

159 
lign
 = 
documt
.
fm1
.lign.
vue
;

160 
ibd
 = 
documt
.
fm1
.
bd
.
vue
;

161 
imgwidth
 = 
documt
.
fm1
.imgwidth.
vue
;

162 
imgheight
 = 
documt
.
fm1
.imgheight.
vue
;

163 

 = 
documt
.
fm1
.
t
.
vue
;

165 <?
php


166 if(
$cfg_mui_se
=='N')

169 
ic
 = 
documt
.
fm1
.
imgc
.
vue
;

170 
iu
 = 
documt
.
fm1
.
u
.
vue
;

171 <?
php


175 
echo
 "var basehost = '$cfg_basehost';\r\n";

177 if(
documt
.
fm1
.
imgc
.
vue
.
	`dexOf
('ttp:') <= 0)

179 
ic
 = 
baho
 + 
documt
.
fm1
.
imgc
.
vue
;

183 
ic
 = 
documt
.
fm1
.
imgc
.
vue
;

185 if(
documt
.
fm1
.
imgc
.
vue
.
	`dexOf
('ttp:') <= 0 && document.form1.imgsrc.value != '') {

186 
iu
 = 
baho
 + 
documt
.
fm1
.
u
.
vue
;

190 
iu
 = 
documt
.
fm1
.
u
.
vue
;

192 <?
php


196 if(
lign
!=0) ialign = "lign=\""+ialign+"\"";

197 
Img
 = "<img src=\""+ 
ic
 +"\" width=\""+ 
imgwidth
;

198 
Img
 +"\" height=\""+ 
imgheight
 +"\" bd=\""+ 
ibd
 +"\"=\""+ 

 +"\""+
lign
+" />";

199 if(
iu
!=""
Img
 = "<a href=\""+ iurl +"\"arget=\"_blank\">"+ inImg +"</a>\r\n";

201 
v
 
wCode
 = 
FCK
.
	`CeEmt
('DIV');

202 
wCode
.
rHTML
 = 
Img
;

203 
wdow
.

.
	`Cl
();

204 
	}
}

206 
funi
 
	$ImageOK2
()

208 
v
 
iimghtml
 = 
documt
.
fm1
.
imghtml
.
vue
;

210 
v
 
wCode
 = 
FCK
.
	`CeEmt
('DIV');

211 
wCode
.
rHTML
 = 
iimghtml
;

212 
wdow
.

.
	`Cl
();

213 
	}
}

215 
funi
 
	$SeMed
(
ame
)

217 if(
documt
.
l
){

218 
v
 
posLe
 = 
wdow
.
evt
.
Y
-100;

219 
v
 
posT
 = 
wdow
.
evt
.
X
-400;

222 
v
 
posLe
 = 100;

223 
v
 
posT
 = 100;

225 
wdow
.
	`ݒ
("../../../dlog/_images.php?f="+
ame
+"&imgick=big", "pUpImgW", "slbs=yes,sizab=yes,ebo,width=600,height=400,="+
posLe
+",="+
posT
);

226 
	}
}

227 
funi
 
	$SPic
(
imgid
,
fobj
)

229 if(!
fobj
) ;

230 if(
fobj
.
vue
 !"" && fobj.vu!
nu
)

232 
v
 
cimg
 = 
documt
.
	`gEmtById
(
imgid
);

233 if(
cimg
cimg.
c
 = 
fobj
.
vue
;

235 
	}
}

236 
funi
 
	$UpdeImageInfo
()

238 
v
 
imgc
 = 
documt
.
fm1
.imgc.
vue
;

239 if(
imgc
!="")

241 
v
 
imgObj
 = 
w
 
	`Image
();

242 
imgObj
.
c
 = 
imgc
;

243 
documt
.
fm1
.
himgheight
.
vue
 = 
imgObj
.
height
;

244 
documt
.
fm1
.
himgwidth
.
vue
 = 
imgObj
.
width
;

245 
documt
.
fm1
.
imgheight
.
vue
 = 
imgObj
.
height
;

246 
documt
.
fm1
.
imgwidth
.
vue
 = 
imgObj
.
width
;

248 
	}
}

249 
funi
 
	$UpImgSizeH
()

251 
v
 
ih
 = 
documt
.
fm1
.
himgheight
.
vue
;

252 
v
 
iw
 = 
documt
.
fm1
.
himgwidth
.
vue
;

253 
v
 
iih
 = 
documt
.
fm1
.
imgheight
.
vue
;

254 
v
 
iiw
 = 
documt
.
fm1
.
imgwidth
.
vue
;

255 if(
ih
!=
iih
 && iih>0 && ih>0 && 
documt
.
fm1
.
autesize
.
checked
)

257 
documt
.
fm1
.
imgwidth
.
vue
 = 
Mh
.
	`
(
iiw
 * (
iih
/
ih
));

259 
	}
}

260 
funi
 
	$UpImgSizeW
()

262 
v
 
ih
 = 
documt
.
fm1
.
himgheight
.
vue
;

263 
v
 
iw
 = 
documt
.
fm1
.
himgwidth
.
vue
;

264 
v
 
iih
 = 
documt
.
fm1
.
imgheight
.
vue
;

265 
v
 
iiw
 = 
documt
.
fm1
.
imgwidth
.
vue
;

266 if(
iw
!=
iiw
 && iiw>0 && iw>0 && 
documt
.
fm1
.
autesize
.
checked
)

268 
documt
.
fm1
.
imgheight
.
vue
 = 
Mh
.
	`
(
iih
 * (
iiw
/
iw
));

270 
	}
}

272 
funi
 
	$AddFm
()

274 
pium
++;

275 
documt
.
	`gEmtById
('meud').
rHTML
 +"<div css='div'>&nb;</div>图片"+
pium
+"：<inputame='imgfile"+picnum+"'ype='file' id='imgfile"+picnum+"' class='binput' />\r\n";

276 
documt
.
	`gEmtById
('meud').
rHTML
 +"<b/>ALT信息：<puty='xt'ame='t"+
pium
+"' value='' style='width:60%' /><br />\r\n";

277 
documt
.
fm1
.
tٮfm
.
vue
 = 
pium
;

278 
	}
}

280 </
	gst
>

281 <
lk
 
	ghf
="ba.css" 
l
="ysht" 
ty
="text/css" />

282 <
ba
 
rg
="_self" />

283 </
HEAD
>

284 <
body
 
bgc
="#EBF6CD" 
mg
="4" 
tmg
="2">

285 <
fm
 
y
="muɝt/fm-da" 
me
="fm1" 
id
="fm1" 
mhod
="post">

286 <?
php


288 if(
$imgHtml
 != '')

291 <
b
 
width
="100%" 
bd
="0">

292 <

>

293 <
td
 
nowp
='1'>

294 <
fldt
>

295 <
gd
>上传后得到的图片
HTML
信息</legend>

296 <
b
 
width
="100%" 
bd
="0" 
Υacg
="0" 
ηddg
="0">

297 <

>

298 <
td
 
nowp
='1'>

299 <
xa
 
me
='imghtml' 
y
='width:100%;height:250px;'><?
php
 
echo
 
$imgHtml
; ?></
	gxa
>

300 </
	gtd
>

301 </
	g
>

302 <

 
	gheight
="28">

303 <
td
 
ign
='center'>

304 <
put
 
ty
="bu" 
me
="imgok" 
id
="imgok" 
ick
='ImageOK2()' 
vue
=" 插入到编辑器 " 
y
="height:24px" 
ass
="binput" />

305 </
td
>

306 </

>

307 </
b
>

308 </
fldt
>

309 </
td
>

310 </

>

311 </
b
>

312 <?
php


316 <
put
 
	gty
="hidd" 
me
="do" 
vue
="upload" />

317 <
put
 
ty
="hidd" 
me
="himgheight" 
vue
="<?phpcho $imgheightValue?>" />

318 <
put
 
ty
="hidd" 
me
="himgwidth" 
vue
="<?phpcho $imgwidthValue?>" />

319 <
put
 
ty
="hidd" 
me
="" 
id
="" 
vue
="" />

320 <
put
 
ty
="hidd" 
me
="tٮfm" 
vue
="1" />

321 <
b
 
width
="100%" 
bd
="0">

322 <

>

323 <
td
 
nowp
='1'>

324 <
fldt
>

325 <
gd
>上传新图片</legend>

326 <
b
 
width
="100%" 
bd
="0" 
Υacg
="0" 
ηddg
="0">

327 <

 
height
="30">

328 <
td
 
ign
="right" 
vign
='t' 
nowp
='1'>图 片：</td>

329 <
td
 
nowp
='1'>

330 图片1：<
put
 
me
="imgfe1" 
ty
="fe" 
id
="imgfe1" 
ass
="binput" />

331 <
br
 />

332 
ALT
信息：<
put
 
ty
='xt' 
me
='t1' 
vue
='' 
y
='width:60%' />

333 <
div
 
id
='moreupload'></div>

334 <
div
 
y
='height:3px;mg-t:3px;ft-size:1px'>&
nb
;</
	gdiv
>

335 </
	gtd
>

336 </
	g
>

337 <

 
	gheight
="30">

338 <
td
 
ign
="right" 
nowp
='1' 
y
='border-top:1px dashed #333;padding-top:3px'>选 项：</td>

339 <
td
 
nowp
='1' 
y
='border-top:1px dashed #333;padding-top:3px'>

340 <
put
 
ty
="checkbox" 
me
="dd" 
vue
="yes" />生成缩略图 &
nb
;

342 <
put
 
	gme
="w" 
ty
="xt" 
vue
="<?phech$cfg_ddimg_width?>" 
size
="3" />

344 <
put
 
me
="h" 
ty
="xt" 
vue
="<?phech$cfg_ddimg_height?>" 
size
="3" />

345 <
br
 />

346 <
put
 
ty
='checkbox' 
me
='' 
vue
='1' />在图片下一行加上
ALT
描述作为说明文字

347 </
td
>

348 </

>

349 <

 
height
="36">

350 <
td
 
cޥ
="2">

351 &
nb
;

352 <
put
 
	gty
="bu" 
me
="addud" 
id
="addud" 
ick
='AddFm()' 
vue
=" 增加上传框 " 
y
="height:24px" 
ass
="binput" />

353 &
nb
;

354 <
put
 
	gty
="subm" 
me
="picSubm" 
id
="picSubm" 
vue
=" 上 传 " 
y
="height:24px" 
ass
="binput" />

355 &
nb
;

356 <
put
 
	gty
='checkbox' 
me
='edwmk' 
vue
='1' 
ass
='' <?
php
 if(
$pho_mkup
=='1'
echo
 "checked"; ?> />

358 </
	gtd
>

359 </
	g
>

360 </
	gb
>

361 </
	gfldt
>

362 </
	gtd
>

363 </
	g
>

364 <
	g
>

365 <
	gtd
>

366 <
	gfldt
>

367 <
	ggd
>已有图片</legend>

368 <
b
 
	gwidth
="100%" 
bd
="0" 
Υacg
="0" 
ηddg
="0">

369 <

>

370 <
td
 
width
="65" 
height
="25" 
ign
="right">网址：</td>

371 <
td
 
cޥ
="2">

372 <
put
 
me
="imgc" 
ty
="xt" 
id
="imgc" 
size
="30" 
Chge
="SPic('picvw',this);" 
vue
="<?phpcho $imgsrcValue?>" />

373 <
put
 
Click
="SeMed('fm1.imgc');" 
ty
="bu" 
me
="limg" 
vue
=" 浏览服务器... " 
ass
="bput" 
y
="width:100px" />

374 </
td
>

375 </

>

376 <

>

377 <
td
 
height
="25" 
ign
="right">宽度：</td>

378 <
td
 
cޥ
="2" 
nowp
>

379 <
put
 
ty
="xt" 
id
="imgwidth" 
me
="imgwidth" 
size
="8" 
vue
="<?phech$imgwidthVue?>" 
Chge
="UpImgSizeW()" />

380 &
nb
;&
	gnb
;

381 高度: <
put
 
me
="imgheight" 
ty
="xt" 
id
="imgheight" 
size
="8" 
vue
="<?phech$imgheightVue?>" 
Chge
="UpImgSizeH()" />

382 <
put
 
ty
="bu" 
me
="Subm" 
vue
="原始" 
ass
="bput" 
y
="width:40" 
Click
="UpdateImageInfo()" />

383 <
put
 
me
="autesize" 
ty
="checkbox" 
id
="autesize" 
vue
="1" 
checked
='1' />

385 </
td
>

386 </

>

387 <

>

388 <
td
 
height
="25" 
ign
="right">边框：</td>

389 <
td
 
cޥ
="2" 
nowp
>

390 <
put
 
me
="bd" 
ty
="xt" 
id
="bd" 
size
="4" 
vue
="0" />

391 &
nb
;替代文字:

392 <
put
 
me
="t" 
ty
="xt" 
id
="t" 
size
="10" />

393 </
td
>

394 </

>

395 <

>

396 <
td
 
height
="25" 
ign
="right">链接：</td>

397 <
td
 
width
="166" 
nowp
><
put
 
me
="u" 
ty
="xt" 
id
="u" 
size
="30" 
vue
="<?phpcho $urlValue?>" /></td>

398 <
td
 
width
="155" 
ign
="" 
nowp
='1'>&
nb
;</
	gtd
>

399 </
	g
>

400 <
	g
>

401 <
td
 
	gheight
="25" 
ign
="right">

403 </
td
>

404 <
td
 
nowp
='1'>

405 <

 
me
="lign" 
id
="ialign">

406 <
ti
 
vue
="0" 
ed
>默认</option>

407 <
ti
 
vue
="right">右对齐</option>

408 <
ti
 
vue
="center">中间</option>

409 <
ti
 
vue
="left">左对齐</option>

410 <
ti
 
vue
="top">顶端</option>

411 <
ti
 
vue
="bottom">底部</option>

412 </

>

413 </
td
>

414 <
td
 
ign
="right" 
nowp
='1'>

415 <
put
 
Click
="ImageOK();" 
ty
="bu" 
me
="Subm2" 
vue
=" 确定 " 
ass
="binput" />

416 </
td
>

417 </

>

418 </
b
>

419 </
fldt
>

420 </
td
>

421 </

>

422 </
b
>

423 <?
php


426 </
	gfm
>

427 </
	gbody
>

428 </
	gHTML
>

	@include/FCKeditor/editor/dialog/dede_imageuser.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../../member/config.php");

3 
CheckRk
(0,0);

4 
que_
(
dme
(
__FILE__
)."/../../../image.func.php");

5 
que_
(
dme
(
__FILE__
)."/../../../../member/inc/inc_archives_functions.php");

6 if(
emy
(
$do
)
	g$do
='';

7 if(
emy
(
$imgwidthVue
)
	g$imgwidthVue
=400;

8 if(
emy
(
$imgheightVue
)
	g$imgheightVue
=300;

9 if(
emy
(
$uVue
)
	g$uVue
='';

10 if(
emy
(
$imgcVue
)
	g$imgcVue
='';

11 if(
emy
(
$imgu
)
	g$imgu
='';

12 if(
emy
(
$dd
)
	g$dd
='';

13 if(
	g$do
=='upload')

15 
$ime
 = 
time
();

16 
	g$cfg_ml
->
CheckUrS
();

17 
	g$fame
 = 
MembUds
('imgfe','',
$cfg_ml
->
M_ID
,'image','',-1,-1,
ue
);

18 
	g$dfame
 = 
eg_a
("(.*)/","",
$fame
);

19 
SaveUdInfo
("对话框上传 {$dfame} ",
$fame
,1);

20 if(
	g$dd
=="yes")

22 
$lfame
 = 
r_a
(".","-l.",
$fame
);

23 
cy
(
$cfg_bad
.'/'.
$fame
,$cfg_bad.'/'.
$lfame
);

24 
SaveUdInfo
("对话框上传 {$dfame} 的小图",
$lfame
,1);

25 
ImageResize
(
$cfg_bad
.'/'.
$lfame
,
$w
,
$h
);

26 
	g$uVue
 = 
$fame
;

27 
	g$imgcVue
 = 
$lfame
;

28 
	g$fo
 = '';

29 
	g$sizes
 = 
gimagesize
(
$cfg_bad
.'/'.
$lfame
,
$fo
);

30 
	g$imgwidthVue
 = 
$sizes
[0];

31 
	g$imgheightVue
 = 
$sizes
[1];

32 
	g$imgsize
 = 
fesize
(
$cfg_bad
.'/'.
$lfame
);

34 
	g$imgcVue
 = 
$fame
;

35 
	g$uVue
 = 
$fame
;

36 
	g$fo
 = '';

37 
	g$sizes
 = 
gimagesize
(
$cfg_bad
.'/'.
$fame
,
$fo
);

38 
	g$imgwidthVue
 = 
$sizes
[0];

39 
	g$imgheightVue
 = 
$sizes
[1];

40 
	g$imgsize
 = 
fesize
(
$cfg_bad
.'/'.
$fame
);

42 
	g$kkkimg
 = 
$uVue
;

44 if(
emy
(
$kkkimg
)
	g$kkkimg
='picview.gif';

46 <
	gHTML
>

47 <
	gHEAD
>

48 <
	gt
>插入图片</title>

49 <
ma
 
	ghp
-
	gequiv
="Cڋ-Ty" 
cڋ
="text/html; charset=utf-8">

50 <
y
>

51 
td
{
ft
-
size
:10

;}

52 </
	gy
>

53 <
st
 
	gnguage
=
javast
>

54 
v
 
oEd
 = 
wdow
.

.
IDlogLded
() ;

55 
v
 
	goDOM
 = 
oEd
.
FCK
.
EdDocumt
 ;

56 
v
 
	gFCK
 = 
oEd
.
FCK
;

57 
funi
 
	$ImageOK
()

59 
v
 
Img
,
lign
,
iu
,
imgwidth
,
imgheight
,

,
ic
,
ibd
;

60 
lign
 = 
documt
.
fm1
.lign.
vue
;

61 
ibd
 = 
documt
.
fm1
.
bd
.
vue
;

62 
imgwidth
 = 
documt
.
fm1
.imgwidth.
vue
;

63 
imgheight
 = 
documt
.
fm1
.imgheight.
vue
;

64 

 = 
documt
.
fm1
.
t
.
vue
;

65 <?
php


66 if(
$cfg_mui_se
=='N')

69 
ic
 = 
documt
.
fm1
.
imgc
.
vue
;

70 
iu
 = 
documt
.
fm1
.
u
.
vue
;

71 <?
php


75 
echo
 "var basehost = '$cfg_basehost';\r\n";

77 if(
documt
.
fm1
.
imgc
.
vue
.
	`dexOf
('ttp:') <= 0)

79 
ic
 = 
baho
 + 
documt
.
fm1
.
imgc
.
vue
;

83 
ic
 = 
documt
.
fm1
.
imgc
.
vue
;

85 if(
documt
.
fm1
.
imgc
.
vue
.
	`dexOf
('ttp:') <= 0 && document.form1.imgsrc.value != '') {

86 
iu
 = 
baho
 + 
documt
.
fm1
.
u
.
vue
;

90 
iu
 = 
documt
.
fm1
.
u
.
vue
;

92 <?
php


95 if(
lign
!=0) ialign = "lign='"+ialign+"'";

96 
Img
 = "<img src='"+ 
ic
 +"' width='"+ 
imgwidth
;

97 
Img
 +"' height='"+ 
imgheight
 +"' bd='"+ 
ibd
 +"'='"+ 

 +"'"+
lign
+"/>";

98 if(
iu
!=""
Img
 = "<a href='"+ iurl +"'arget='_blank'>"+ inImg +"</a>\r\n";

100 
v
 
wCode
 = 
FCK
.
	`CeEmt
('DIV');

101 
wCode
.
rHTML
 = 
Img
;

102 
wdow
.

.
	`Cl
();

103 
	}
}

104 
funi
 
	$SeMed
(
ame
)

106 if(
documt
.
l
){

107 
v
 
posLe
 = 
wdow
.
evt
.
Y
-100;

108 
v
 
posT
 = 
wdow
.
evt
.
X
-400;

111 
v
 
posLe
 = 100;

112 
v
 
posT
 = 100;

114 
wdow
.
	`ݒ
("../../../../memb/uds_.php?medty=1&f="+
ame
+"&imgick=big", "pUpImgW", "slbs=yes,sizab=yes,ebo,width=600,height=400,="+
posLe
+",="+
posT
);

115 
	}
}

116 
funi
 
	$SPic
(
imgid
,
fobj
)

118 if(!
fobj
) ;

119 if(
fobj
.
vue
 !"" && fobj.vu!
nu
)

121 
v
 
cimg
 = 
documt
.
	`gEmtById
(
imgid
);

122 if(
cimg
cimg.
c
 = 
fobj
.
vue
;

124 
	}
}

125 
funi
 
	$UpdeImageInfo
()

127 
v
 
imgc
 = 
documt
.
fm1
.imgc.
vue
;

128 if(
imgc
!="")

130 
v
 
imgObj
 = 
w
 
	`Image
();

131 
imgObj
.
c
 = 
imgc
;

132 
documt
.
fm1
.
himgheight
.
vue
 = 
imgObj
.
height
;

133 
documt
.
fm1
.
himgwidth
.
vue
 = 
imgObj
.
width
;

134 
documt
.
fm1
.
imgheight
.
vue
 = 
imgObj
.
height
;

135 
documt
.
fm1
.
imgwidth
.
vue
 = 
imgObj
.
width
;

137 
	}
}

138 
funi
 
	$UpImgSizeH
()

140 
v
 
ih
 = 
documt
.
fm1
.
himgheight
.
vue
;

141 
v
 
iw
 = 
documt
.
fm1
.
himgwidth
.
vue
;

142 
v
 
iih
 = 
documt
.
fm1
.
imgheight
.
vue
;

143 
v
 
iiw
 = 
documt
.
fm1
.
imgwidth
.
vue
;

144 if(
ih
!=
iih
 && iih>0 && ih>0 && 
documt
.
fm1
.
autesize
.
checked
)

146 
documt
.
fm1
.
imgwidth
.
vue
 = 
Mh
.
	`
(
iiw
 * (
iih
/
ih
));

148 
	}
}

149 
funi
 
	$UpImgSizeW
()

151 
v
 
ih
 = 
documt
.
fm1
.
himgheight
.
vue
;

152 
v
 
iw
 = 
documt
.
fm1
.
himgwidth
.
vue
;

153 
v
 
iih
 = 
documt
.
fm1
.
imgheight
.
vue
;

154 
v
 
iiw
 = 
documt
.
fm1
.
imgwidth
.
vue
;

155 if(
iw
!=
iiw
 && iiw>0 && iw>0 && 
documt
.
fm1
.
autesize
.
checked
)

157 
documt
.
fm1
.
imgheight
.
vue
 = 
Mh
.
	`
(
iih
 * (
iiw
/
iw
));

159 
	}
}

160 </
	gst
>

161 <
lk
 
	ghf
="ba.css" 
l
="ysht" 
ty
="text/css">

162 <
ba
 
rg
="_self">

163 </
HEAD
>

164 <
body
 
bgc
="#EBF6CD" 
mg
="4" 
tmg
="2">

165 <
fm
 
y
="muɝt/fm-da" 
me
="fm1" 
id
="fm1" 
mhod
="post" />

166 <
put
 
ty
="hidd" 
me
="do" 
vue
="upload" />

167 <
put
 
ty
="hidd" 
me
="himgheight" 
vue
="<?phpcho $imgheightValue?>" />

168 <
put
 
ty
="hidd" 
me
="himgwidth" 
vue
="<?phpcho $imgwidthValue?>" />

169 <
b
 
width
="100%" 
bd
="0">

170 <

 
height
="20">

171 <
td
 
cޥ
="3">

172 <
fldt
>

173 <
gd
>图片属性</legend>

174 <
b
 
width
="100%" 
bd
="0" 
Υacg
="0" 
ηddg
="0">

175 <

>

176 <
td
 
width
="65" 
height
="25" 
ign
="right">网址：</td>

177 <
td
 
cޥ
="2">

178 <
put
 
me
="imgc" 
ty
="xt" 
id
="imgc" 
size
="30" 
Chge
="SPic('picvw',this);" 
vue
="<?phpcho $imgsrcValue?>" />

179 <
put
 
Click
="SeMed('fm1.imgc');" 
ty
="bu" 
me
="limg" 
vue
=" 浏览... " 
ass
="bput" 
y
="width:80px" />

180 </
td
>

181 </

>

182 <

>

183 <
td
 
height
="25" 
ign
="right">宽度：</td>

184 <
td
 
cޥ
="2" 
nowp
>

185 <
put
 
ty
="xt" 
id
="imgwidth" 
me
="imgwidth" 
size
="8" 
vue
="<?phech$imgwidthVue?>" 
Chge
="UpImgSizeW()" />

186 &
nb
;&
	gnb
; 高度:

187 <
put
 
me
="imgheight" 
ty
="xt" 
id
="imgheight" 
size
="8" 
vue
="<?phech$imgheightVue?>" 
Chge
="UpImgSizeH()" />

188 <
put
 
ty
="bu" 
me
="Subm" 
vue
="原始" 
ass
="bput" 
y
="width:40px" 
ick
="UpdateImageInfo()" />

189 <
put
 
me
="autesize" 
ty
="checkbox" 
id
="autesize" 
vue
="1" 
checked
='1' />

191 </
td
>

192 </

>

193 <

>

194 <
td
 
height
="25" 
ign
="right">边框：</td>

195 <
td
 
cޥ
="2" 
nowp
>

196 <
put
 
me
="bd" 
ty
="xt" 
id
="bd" 
size
="4" 
vue
="0" />

197 &
nb
;替代文字:

198 <
put
 
me
="t" 
ty
="xt" 
id
="t" 
size
="10" />

199 </
td
>

200 </

>

201 <

>

202 <
td
 
height
="25" 
ign
="right">链接：</td>

203 <
td
 
width
="166" 
nowp
>

204 <
put
 
me
="u" 
ty
="xt" 
id
="u" 
size
="30" 
vue
="<?phpcho $urlValue?>" />

205 </
td
>

206 <
td
 
width
="155" 
ign
="" 
nowp
>&
nb
;</
	gtd
>

207 </
	g
>

208 <
	g
>

209 <
td
 
	gheight
="25" 
ign
="right">对齐：</td>

210 <
td
 
nowp
>

211 <

 
me
="lign" 
id
="ialign">

212 <
ti
 
vue
="0" 
ed
='1'>默认</option>

213 <
ti
 
vue
="right">右对齐</option>

214 <
ti
 
vue
="center">中间</option>

215 <
ti
 
vue
="left">左对齐</option>

216 <
ti
 
vue
="top">顶端</option>

217 <
ti
 
vue
="bottom">底部</option>

218 </

>

219 </
td
>

220 <
td
 
ign
="right" 
nowp
>

221 <
put
 
Click
="ImageOK();" 
ty
="bu" 
me
="Subm2" 
vue
=" 确定 " 
ass
="bput" />&
nb
;

222 </
	gtd
>

223 </
	g
>

224 </
	gb
>

225 </
	gfldt
>

226 </
	gtd
>

227 </
	g
>

228 <

 
	gheight
="25">

229 <
td
 
cޥ
="3" 
nowp
='1'>

230 <
fldt
>

231 <
gd
>上传新图片</legend>

232 <
b
 
width
="100%" 
bd
="0" 
Υacg
="0" 
ηddg
="0">

233 <

 
height
="30">

234 <
td
 
ign
="right" 
nowp
>　新图片：</td>

235 <
td
 
cޥ
="2" 
nowp
>

236 <
put
 
me
="imgfe" 
ty
="fe" 
id
="imgfe" 
Chge
="SPic('picvw',this);" 
y
="height:22px" 
ass
="binput" />

237 &
nb
; <
put
 
	gty
="subm" 
me
="picSubm" 
id
="picSubm" 
vue
=" 上 传 " 
y
="height:22px" 
ass
="binput" />

238 </
td
>

239 </

>

240 <

 
height
="30">

241 <
td
 
ign
="right" 
nowp
>　选　项：</td>

242 <
td
 
cޥ
="2" 
nowp
>

243 <
put
 
ty
="checkbox" 
me
="dd" 
vue
="yes" />生成缩略图

244 &
nb
;

246 <
put
 
	gme
="w" 
ty
="xt" 
vue
="<?phech$cfg_ddimg_width?>" 
size
="3" />

248 <
put
 
me
="h" 
ty
="xt" 
vue
="<?phech$cfg_ddimg_height?>" 
size
="3" />

249 </
td
>

250 </

>

251 </
b
>

252 </
fldt
>

253 </
td
>

254 </

>

255 <

 
height
="50">

256 <
td
 
height
="140" 
ign
="right" 
nowp
>预览区:</td>

257 <
td
 
height
="140" 
cޥ
="2" 
nowp
>

258 <
b
 
width
="150" 
height
="120" 
bd
="0" 
ηddg
="1" 
Υacg
="1">

259 <

>

260 <
td
 
ign
="center">

261 <
img
 
me
="picvw" 
id
="picvw" 
c
="<?phech$kkkimg?>" 
width
="160" 
height
="120" 
t
="预览图片" />

262 </
td
>

263 </

>

264 </
b
>

265 </
td
>

266 </

>

267 </
b
>

268 </
fm
>

269 </
body
>

270 </
HTML
>

	@include/FCKeditor/editor/dialog/dede_mycode.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../common.inc.php");

4 <
	gHTML
>

5 <
	gHEAD
>

6 <
	gt
>插入自定义内容</title>

7 <
ma
 
	ghp
-
	gequiv
="Cڋ-Ty" 
cڋ
="text/html; charset=utf-8">

8 <
y
>

9 .
td
{
ft
-
size
:10

;}

10 
	gli
,
	gdd
 {

11 
	gli
-
	gy
-
	gty
:
ne
; 
	gmg
:0
px
; 
	gddg
:0px;

13 
	gul
,
	gdl
,
	g
,
	gfm
,
	gdiv
 {

14 
	gmg
:0
px
; 
	gddg
:0px;

16 </
	gy
>

17 <
st
 
	gc
="comm/fck_dlog_comm.js" 
ty
="text/javascript"></script>

18 <
st
 
nguage
=
javast
>

19 
v
 
dlog
 = 
wdow
.

 ;

20 
v
 
	goEd
 = 
wdow
.

.
IDlogLded
() ;

21 
v
 
	goDOM
 = 
oEd
.
FCK
.
EdDocumt
 ;

22 
v
 
	gFCK
 = 
oEd
.
FCK
;

23 
	gwdow
.
	gld
 = 
	$funi
()

25 
oEd
.
FCKLguageMag
.
	`TnePage
(
documt
) ;

26 
wdow
.

.
	`SOkBu

ue
 ) ;

27 
	}
}

28 
funi
 
	$Ok
()

30 
v
 
svue
 = 0;

31 if(!
documt
.
fm1
.
lems
) {

32  
ue
;

34 if(
documt
.
fm1
.
lems
.
vue

svue
 = document.form1.selitems.value;

37 
v
 
i
=0; i<
documt
.
fm1
.
lems
.
ngth
; i++)

39 if(
documt
.
fm1
.
lems
[
i
].
checked

svue
 = documt.fm1.lems[i].
vue
;

42 if(
svue
 > 0
oEd
.
FCK
.
	`InHtml

documt
.
	`gEmtById
('b'+svue).
rHTML
 );

43  
ue
;

44 
	}
}

46 </
	gst
>

47 <
lk
 
	ghf
="ba.css" 
l
="ysht" 
ty
="text/css">

48 </
HEAD
>

49 <
body
 
bgc
="#EBF6CD" 
tmg
="8">

50 <
fm
 
me
="fm1" 
id
="form1">

51 <
b
 
bd
="0" 
width
="98%" 
ign
="center">

52 <

>

53 <
td
>

55 <
br
>

56 <
ft
 
c
='#999999'>修改文件
da
/
adm
/
mycode
.
php
更改这些文字</font>

57 </
td
>

58 </

>

59 <

 
height
="50">

60 <
td
 
y
='le-height:160%' 
nowp
>

61 <
ul
>

62 <?
php


63 
$codefe
 = 
DEDEROOT
."/data/admin/mycode.txt";

64 if(!
	$fe_exis
(
$codefe
))

66 
$S
 = "<"."?php

67 ##测试
HTML
内容一

69 ##测试
HTML
内容二

71 
$
 = 
	`fݒ
(
$codefe
, 'w');

72 
	`fwre
(
$
, 
$S
);

73 
	`fo
(
$
);

74 
	}
}

75 
	g$
 = 
fݒ
(
$codefe
, 'r');

76 
	g$r
 = '';

77  !
	$of
(
$
) )

79 
$r
 .
	`im
(
	`fgs
(
$
, 1024));

80 
	}
}

81 
fo
(
$
);

82 
	g$rs
 = 
exode
("##", 
$r
);

83 
	g$i
 = 0;

84 
	$fܗch
(
$rs
 
as
 
$r
)

86 if(!
	`eg
('//#',
$r
)) ;

87 
$i
++;

88 
$tmds
 = 
	`exode
("//#", 
$r
);

89 
echo
 "<li><inputype='radio'ame='selitems' value='$i'><b>{$tmds[0]}</b>\r\n";

90 
echo
 "<br /><label id='lab{$i}'>{$tmds[1]}</label>";

91 
echo
 "</li>\r\n";

92 
	}
}

94 </
	gul
>

95 </
	gtd
>

96 </
	g
>

97 </
	gb
>

98 </
	gfm
>

99 </
	gbody
>

100 </
	gHTML
>

	@include/FCKeditor/fckeditor.php

1 <?
php


3 
funi
 
	$FCKed_IsComtibBrowr
()

5 i
	`ist

$_SERVER
 ) ) {

6 
$sAgt
 = 
$_SERVER
['HTTP_USER_AGENT'] ;

9 
glob
 
$HTTP_SERVER_VARS
 ;

10 i
	`ist

$HTTP_SERVER_VARS
 ) ) {

11 
$sAgt
 = 
$HTTP_SERVER_VARS
['HTTP_USER_AGENT'] ;

14 
glob
 
$HTTP_USER_AGENT
 ;

15 
$sAgt
 = 
$HTTP_USER_AGENT
 ;

19 i
	`os
(
$sAgt
, 'MSIE'!=
l
 && strpos($sAgent, 'mac') === false && strpos($sAgent, 'Opera') === false )

21 
$iVsi
 = ()
	`subr
(
$sAgt
, 
	`os
($sAgent, 'MSIE') + 5, 3) ;

22  (
$iVsi
 >= 5.5) ;

24 i
	`os
(
$sAgt
, 'Gecko/'!=
l
 )

26 
$iVsi
 = ()
	`subr
(
$sAgt
, 
	`os
($sAgent, 'Gecko/') + 6, 8) ;

27  (
$iVsi
 >= 20030210) ;

29 i
	`os
(
$sAgt
, 'O/'!=
l
 )

31 
$fVsi
 = ()
	`subr
(
$sAgt
, 
	`os
($sAgent, 'Opera/') + 6, 4) ;

32  (
$fVsi
 >= 9.5) ;

34 i
	`eg_mch
"|AWebK/(\d+)|i", 
$sAgt
, 
$mches
 ) )

36 
$iVsi
 = 
$mches
[1] ;

37  ( 
$mches
[1] >= 522 ) ;

40  
l
 ;

41 
	}
}

43 as
	cFCKed


45 
v
 
	m$InName
 ;

46 
v
 
	m$BaPh
 ;

47 
v
 
	m$Width
 ;

48 
v
 
	m$Height
 ;

49 
v
 
	m$TobS
 ;

50 
v
 
	m$Vue
 ;

51 
v
 
	m$Cfig
 ;

53 
funi
 
	$__cڡru

$Name
 )

55 
$this
->
InName
 = 
$Name
 ;

56 
$this
->
BaPh
 = '/editor/' ;

57 
$this
->
Width
 = '100%' ;

58 
$this
->
Height
 = '350' ;

59 
$this
->
TobS
 = 'Default' ;

60 
$this
->
Vue
 = '' ;

61 
$this
->
Cfig
 = 
	`y
() ;

64 
funi
 
	$FCKed

$Name
 )

66 
$this
->
	`__cڡru

$Name
 );

67 
	}
}

69 
funi
 
	$Ce
()

71 
echo
 
$this
->
	`CeHtml
() ;

72 
	}
}

74 
funi
 
	$CeHtml
()

76 
$HtmlVue
 = 
	`htmleclchs

$this
->
Vue
 ) ;

78 
$Html
 = '' ;

80 i!
	`ist

$_GET
 ) ) {

81 
glob
 
$HTTP_GET_VARS
 ;

82 
$_GET
 = 
$HTTP_GET_VARS
 ;

85 i
$this
->
	`IsComtib
() )

87 
$Fe
 = 'fckeditor.html' ;

89 
$Lk
 = "{$this->BasePath}editor/{$File}?InstanceName={$this->InstanceName}" ;

91 i
$this
->
TobS
 != '' )

92 
$Lk
 .= "&amp;Toolbar={$this->ToolbarSet}" ;

95 
$Html
 .= "<inputype=\"hidden\" id=\"{$this->InstanceName}\"ame=\"{$this->InstanceName}\" value=\"{$HtmlValue}\" style=\"display:none\" />" ;

98 
$Html
 ."<puty=\"hidd\" id=\"{$this->InName}___Cfig\" vue=\"" . 
$this
->
	`GCfigFldSg
() . "\" style=\"display:none\" />" ;

101 
$Html
 .= "<iframe id=\"{$this->InstanceName}___Frame\" src=\"{$Link}\" width=\"{$this->Width}\" height=\"{$this->Height}\" frameborder=\"0\" scrolling=\"no\"></iframe>" ;

105 i
	`os

$this
->
Width
, '%' ) ==
l
 )

106 
$WidthCSS
 = 
$this
->
Width
 . 'px' ;

108 
$WidthCSS
 = 
$this
->
Width
 ;

110 i
	`os

$this
->
Height
, '%' ) ==
l
 )

111 
$HeightCSS
 = 
$this
->
Height
 . 'px' ;

113 
$HeightCSS
 = 
$this
->
Height
 ;

115 
$Html
 .= "<textareaame=\"{$this->InstanceName}\"ows=\"4\" cols=\"40\" style=\"width: {$WidthCSS}; height: {$HeightCSS}\">{$HtmlValue}</textarea>" ;

118  
$Html
 ;

119 
	}
}

121 
funi
 
	$IsComtib
()

123  
	`FCKed_IsComtibBrowr
() ;

124 
	}
}

126 
funi
 
	$GCfigFldSg
()

128 
$sPams
 = '' ;

129 
$bF
 = 
ue
 ;

131 
	`fܗch
 ( 
$this
->
Cfig
 
as
 
$sKey
 => 
$sVue
 )

133 i
$bF
 =
l
 )

134 
$sPams
 .= '&amp;' ;

136 
$bF
 = 
l
 ;

138 i
$sVue
 ==
ue
 )

139 
$sPams
 .
$this
->
	`EncodeCfig

$sKey
 ) . '=true' ;

140 i
$sVue
 ==
l
 )

141 
$sPams
 .
$this
->
	`EncodeCfig

$sKey
 ) . '=false' ;

143 
$sPams
 .
$this
->
	`EncodeCfig

$sKey
 ) . '=' . $this->EncodeCfig
$sVue
 ) ;

146  
$sPams
 ;

147 
	}
}

149 
funi
 
	$EncodeCfig

$vueToEncode
 )

151 
$chs
 = 
	`y
(

156  
	`r

$vueToEncode
, 
$chs
 ) ;

157 
	}
}

	@include/FCKeditor/index.php

1 <?
php


2 
r_ptg
(
E_ALL
);

3 
ude
('fckeditor.php') ;

4 
	g$sBaPh
 = 
$_SERVER
['PHP_SELF'] ;

5 
	g$fck
 = 
w
 
FCKed
('FCKeditor1') ;

6 
	g$fck
->
	gBaPh
 = '' ;

7 
	g$fck
->
	gWidth
 = '100%' ;

8 
	g$fck
->
	gHeight
 = "500" ;

9 
	g$fck
->
	gTobS
 = "Default" ;

10 
	g$fck
->
Ce
() ;

	@include/arc.archives.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/typelink.class.php");

7 
que_
(
DEDEINC
."/channelunit.class.php");

8 
que_
(
DEDEINC
."/downmix.inc.php");

10 @
t_time_lim
(0);

11 as
	cArchives


13 
v
 
	m$TyLk
;

14 
v
 
	m$ChlUn
;

15 
v
 
	m$dsql
;

16 
v
 
	m$Flds
;

17 
v
 
	m$d
;

18 
v
 
	m$ArcID
;

19 
v
 
	m$SPageFld
;

20 
v
 
	m$SFlds
;

21 
v
 
	m$NowPage
;

22 
v
 
	m$TٮPage
;

23 
v
 
	m$NameF
;

24 
v
 
	m$ShtName
;

25 
v
 
	m$FixedVues
;

26 
v
 
	m$TempSour
;

27 
v
 
	m$IsE
;

28 
v
 
	m$STs
;

29 
v
 
	m$PNext
;

30 
v
 
	m$addTabRow
;

33 
funi
 
	$__cڡru
(
$aid
)

35 
glob
 
$dsql
;

36 
$this
->
IsE
 = 
l
;

37 
$this
->
ArcID
 = 
$aid
;

38 
$this
->
PNext
 = 
	`y
();

40 
$this
->
dsql
 = 
$dsql
;

41 
$quy
 = "Select channel,typeid from `#@__arctiny` where id='$aid' ";

42 
$r
 = 
$this
->
dsql
->
	`GO
(
$quy
);

43 if(!
	`is_y
(
$r
))

45 
$this
->
IsE
 = 
ue
;

49 if(
$r
['channel']==0) { $arr['channel']=1; }

50 
$this
->
ChlUn
 = 
w
 
	`ChlUn
(
$r
['chl'],
$aid
);

51 
$this
->
TyLk
 = 
w
 
	`TyLk
(
$r
['typeid']);

52 if(
$this
->
ChlUn
->
ChlInfos
['issystem']!=-1)

54 
$quy
 = "Selectrc.*,tp.reid,tp.typedir,ch.addtable

55 
om
 `#@
__chives
` 
c


56 

 
jo
 #@
__y
 

 

p.
id
=
c
.
tyid


57 

 
jo
 #@
__chy
 
as
 
ch
 

 
c
.
chl
 = ch.
id


58 
whe
 
c
.
id
='$aid' ";

59 
$this
->
Flds
 = $this->
dsql
->
	`GO
(
$quy
);

63 
$this
->
Flds
['title'] = '';

64 
$this
->
Flds
['money'] = $this->Fields['arcrank'] = 0;

65 
$this
->
Flds
['senddate'] = $this->Fields['pubdate'] = $this->Fields['mid'] = $this->Fields['adminid'] = 0;

66 
$this
->
Flds
['ismake'] = 1;

67 
$this
->
Flds
['filename'] = '';

70 if(
$this
->
TyLk
->
TyInfos
['cܪk'] > 0 && $this->
Flds
['arcrank']==0)

72 
$this
->
Flds
['k'] = $this->
TyLk
->
TyInfos
['corank'];

75 
$this
->
Flds
['gs'] = 
	`GTags
(
$aid
);

76 
$this
->
d
 = 
w
 
	`DedeTagP
();

77 
$this
->
d
->
	`SRefObj
($this);

78 
$this
->
SPageFld
 = $this->
ChlUn
->SplitPageField;

79 
$this
->
SFlds
 = '';

80 
$this
->
TٮPage
 = 1;

81 
$this
->
NameF
 = '';

82 
$this
->
ShtName
 = 'html';

83 
$this
->
FixedVues
 = '';

84 
$this
->
TempSour
 = '';

85 if(
	`emy
(
$GLOBALS
['pageno']))

87 
$this
->
NowPage
 = 1;

91 
$this
->
NowPage
 = 
$GLOBALS
['pageno'];

95 
$this
->
Flds
['aid'] = 
$aid
;

96 
$this
->
Flds
['id'] = 
$aid
;

97 
$this
->
Flds
['posi'] = $this->
TyLk
->
	`GPosiLk
(
ue
);

98 
$this
->
Flds
['tyid'] = 
$r
['typeid'];

101 
	`fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v
)

103 
$this
->
Flds
[
$k
] = 
$v
;

107 if(
$this
->
ChlUn
->
ChlInfos
['addtable']!='')

109 
$quy
 = "SELECT * FROM `{$this->ChannelUnit->ChannelInfos['addtable']}` WHERE `aid` = '$aid'";

110 
$this
->
addTabRow
 = $this->
dsql
->
	`GO
(
$quy
);

114 if(
$this
->
ChlUn
->
ChlInfos
['addtable']!='' && $this->ChannelUnit->ChannelInfos['issystem']!=-1)

116 if(
	`is_y
(
$this
->
addTabRow
))

118 
$this
->
Flds
['deu'] = $this->
addTabRow
['redirecturl'];

119 
$this
->
Flds
['m'] = $this->
addTabRow
['templet'];

120 
$this
->
Flds
['ur'] = $this->
addTabRow
['userip'];

122 
$this
->
Flds
['m'] = (
	`emy
($this->Flds['m']? '' : 
	`im
($this->Fields['templet']));

123 
$this
->
Flds
['deu'] = (
	`emy
($this->Flds['deu']? '' : 
	`im
($this->Fields['redirecturl']));

124 
$this
->
Flds
['ur'] = (
	`emy
($this->Flds['ur']? '' : 
	`im
($this->Fields['userip']));

128 
$this
->
Flds
['templet'] = $this->Fields['redirecturl'] = '';

134 
funi
 
	$Archives
(
$aid
)

136 
$this
->
	`__cڡru
(
$aid
);

137 
	}
}

140 
funi
 
	$PAddTab
()

143 if(
$this
->
ChlUn
->
ChlInfos
['addtable']!='')

145 
$row
 = 
$this
->
addTabRow
;

146 if(
$this
->
ChlUn
->
ChlInfos
['issystem']==-1)

148 
$this
->
Flds
['t'] = 
$row
['title'];

149 
$this
->
Flds
['ndde'] = $this->Flds['pubde'] = 
$row
['senddate'];

150 
$this
->
Flds
['mid'] = $this->Flds['admid'] = 
$row
['mid'];

151 
$this
->
Flds
['ismake'] = 1;

152 
$this
->
Flds
['arcrank'] = 0;

153 
$this
->
Flds
['money']=0;

154 
$this
->
Flds
['filename'] = '';

157 if(
	`is_y
(
$row
))

159 
	`fܗch
(
$row
 
as
 
$k
=>
$v
$row[
	`ow
($k)] = $v;

161 if(
	`is_y
(
$this
->
ChlUn
->
ChlFlds
&& !
	`emy
($this->ChannelUnit->ChannelFields))

163 
	`fܗch
(
$this
->
ChlUn
->
ChlFlds
 
as
 
$k
=>
$r
)

165 if(
	`ist
(
$row
[
$k
]))

167 if(!
	`emy
(
$r
['rename']))

169 
$nk
 = 
$r
['rename'];

173 
$nk
 = 
$k
;

175 
$cobj
 = 
$this
->
	`GCurTag
(
$k
);

176 if(
	`is_obje
(
$cobj
))

178 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$ag
)

180 if(
$ag
->
	`GTagName
()=='fld' && $ag->
	`GA
('me')==
$k
)

183 if(
$ag
->
	`GA
('noteid') != '') {

184 
$this
->
Flds
[
$k
.'_'.
$ag
->
	`GA
('neid')] = $this->
ChlUn
->
	`MakeFld
($k, 
$row
[$k], $ctag);

188 
$this
->
Flds
[
$nk
] = $this->
ChlUn
->
	`MakeFld
(
$k
, 
$row
[$k], 
$ag
);

195 
$this
->
Flds
[
$nk
] = 
$row
[
$k
];

197 if(
$r
['ty']=='htmext' && 
$GLOBALS
['cfg_keywd_a']=='Y' && !
	`emy
(
$this
->
Flds
['keywords']))

199 
$this
->
Flds
[
$nk
] = $this->
	`RKeywd
($this->Fields['keywords'],$this->Fields[$nk]);

205 
$this
->
Flds
['tyme'] = $this->
TyLk
->
TyInfos
['typename'];

206 @
	`SSysEnv
(
$this
->
Flds
['typeid'],$this->Fields['typename'],$this->Fields['id'],$this->Fields['title'],'archives');

209 
	`unt
(
$row
);

212 
$this
->
STs
 = 
	`Aay
();

213 if(
$this
->
SPageFld
!='' && 
$GLOBALS
['cfg_arcsptitle']='Y'

214 && 
	`ist
(
$this
->
Flds
[$this->
SPageFld
]))

216 
$this
->
SFlds
 = 
	`exode
("#p#",$this->
Flds
[$this->
SPageFld
]);

217 
$i
 = 1;

218 
	`fܗch
(
$this
->
SFlds
 
as
 
$k
=>
$v
)

220 
$tmpv
 = 
	`_subr
(
$v
,50);

221 
$pos
 = 
	`os
(
$tmpv
,'#e#');

222 if(
$pos
>0)

224 
$
 = 
	`im
(
	`_subr
(
$tmpv
,
$pos
));

225 if(
$
==""||$st=="副标题"||$st=="分页标题")

227 
$this
->
SFlds
[
$k
] = 
	`eg_a
("/^(.*)#e#/is","",
$v
);

232 
$this
->
SFlds
[
$k
] = 
	`eg_a
("/^(.*)#e#/is","",
$v
);

233 
$this
->
STs
[
$k
] = 
$
;

240 
$i
++;

242 
$this
->
TٮPage
 = 
	`cou
($this->
SFlds
);

243 
$this
->
Flds
['tٮge'] = $this->
TٮPage
;

247 if(
$this
->
Flds
['litpic'] == '-' || $this->Fields['litpic'] == '')

249 
$this
->
Flds
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

251 if(!
	`egi
("^hp://",
$this
->
Flds
['lpic']&& 
$GLOBALS
['cfg_multi_site'] == 'Y')

253 
$this
->
Flds
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$this->Fields['litpic'];

255 
$this
->
Flds
['picname'] = $this->Fields['litpic'];

258 
$this
->
Flds
['image'] = (!
	`egi
('jpg|gif|png', $this->Fields['picname']) ? '' : "<img src='{$this->Fields['picname']}' />");

261 if(
$this
->
Flds
['goodpost'] + $this->Fields['badpost'] == 0)

263 
$this
->
Flds
['goodper'] = $this->Fields['badper'] = 0;

267 
$this
->
Flds
['goodr'] = 
	`numb_fm
($this->Fields['goodpost']/($this->Fields['goodpost']+$this->Fields['badpost']), 3)*100;

268 
$this
->
Flds
['badper'] = 100 - $this->Fields['goodper'];

271 
	}
}

274 
funi
 
	$GCurTag
(
$fldme
)

276 if(!
	`ist
(
$this
->
d
->
CTags
))

280 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$ag
)

282 if(
$ag
->
	`GTagName
()=='fld' && $ag->
	`GA
('me')==
$fldme
)

284  
$ag
;

292 
	}
}

295 
funi
 
	$MakeHtml
()

297 if(
$this
->
IsE
)

301 
$this
->
Flds
["displaytype"] = "st";

303 
$this
->
	`LdTem
();

304 
$this
->
	`PAddTab
();

305 
$this
->
	`PTemsF
();

308 
$fame
 = 
	`GFeNewName
(

309 
$this
->
ArcID
,$this->
Flds
['typeid'],$this->Fields['senddate'],

310 
$this
->
Flds
['title'],$this->Fields['ismake'],$this->Fields['arcrank'],

311 
$this
->
TyLk
->
TyInfos
['mu'],$this->TyLk->TyInfos['tyd'],$this->
Flds
['money'],$this->Fields['filename']

314 
$fames
 = 
	`exode
(".", 
$fame
);

315 
$this
->
ShtName
 = 
$fames
[
	`cou
($filenames)-1];

316 if(
$this
->
ShtName
=='') $this->ShortName = 'html';

317 
$feF
 = 
	`egi_a
("\.".
$this
->
ShtName
."$", "", 
$fame
);

318 
$this
->
Flds
['mehd'] = 
	`bame
(
$feF
);

319 
$fames
 = 
	`exode
("/",
$fame
);

320 
$this
->
NameF
 = 
	`egi_a
("\.".$this->
ShtName
."$","",
$fames
[
	`cou
($filenames)-1]);

321 if(
$this
->
NameF
=='')

323 
$this
->
NameF
 = $this->
cID
;

327 
$fameFu
 = 
	`GFeU
(

328 
$this
->
ArcID
,$this->
Flds
['typeid'],$this->Fields["senddate"],

329 
$this
->
Flds
["title"],$this->Fields["ismake"],

330 
$this
->
Flds
["k"],$this->
TyLk
->
TyInfos
['namerule'],$this->TypeLink->TypeInfos['typedir'],$this->Fields["money"],$this->Fields['filename'],

331 
$this
->
TyLk
->
TyInfos
['moresite'],$this->TypeLink->TypeInfos['siteurl'],$this->TypeLink->TypeInfos['sitepath']

333 
$this
->
Flds
['cu'] = $this->Flds['fume'] = 
$fameFu
;

336 if(
$this
->
Flds
['ismake']==-1 || $this->Fields['arcrank']!=0 || $this->Fields['money']>0

337 || (
$this
->
Flds
['typeid']==0 && $this->Fields['channel'] != -1) )

339  
$this
->
	`GTrueU
(
$fame
);

344 
$i
=1;$i<=
$this
->
TٮPage
;$i++)

346 if(
$this
->
TٮPage
 > 1) {

347 
$this
->
Flds
['tm'] = (
	`emy
($this->Fields['tmptitle']) ? $this->Fields['title'] : $this->Fields['tmptitle']);

348 if(
$i
>1
$this
->
Flds
['title'] = $this->Fields['tmptitle']."($i)";

350 if(
$i
>1)

352 
$uefame
 = 
$this
->
	`GTruePh
().
$feF
."_".
$i
.".".$this->
ShtName
;

356 
$uefame
 = 
$this
->
	`GTruePh
().
$fame
;

358 
$this
->
	`PDMFlds
(
$i
,1);

359 
$this
->
d
->
	`SaveTo
(
$uefame
);

362 
$this
->
dsql
->
	`ExecuNeQuy
("Upd`#@__chives` s ismake=1 whid='".$this->
ArcID
."'");

363  
$this
->
	`GTrueU
(
$fame
);

364 
	}
}

367 
funi
 
	$GTrueU
(
$nu
)

369  
GFeU


371 
$this
->
Flds
['id'],

372 
$this
->
Flds
['typeid'],

373 
$this
->
Flds
['senddate'],

374 
$this
->
Flds
['title'],

375 
$this
->
Flds
['ismake'],

376 
$this
->
Flds
['arcrank'],

377 
$this
->
TyLk
->
TyInfos
['namerule'],

378 
$this
->
TyLk
->
TyInfos
['typedir'],

379 
$this
->
Flds
['money'],

380 
$this
->
Flds
['filename'],

381 
$this
->
TyLk
->
TyInfos
['moresite'],

382 
$this
->
TyLk
->
TyInfos
['siteurl'],

383 
$this
->
TyLk
->
TyInfos
['sitepath']

385 
	}
}

388 
funi
 
	$GTruePh
()

390 
$uh
 = 
$GLOBALS
["cfg_basedir"];

391  
$uh
;

392 
	}
}

395 
funi
 
	$GFld
(
$ame
, 
$ag
)

398 if(
$ame
=='array')

400  
$this
->
Flds
;

403 if(
$ag
->
	`GA
('noteid') != '')

405 if
	`ist
(
$this
->
Flds
[
$ame
.'_'.
$ag
->
	`GA
('noteid')]) )

407  
$this
->
Flds
[
$ame
.'_'.
$ag
->
	`GA
('noteid')];

410 if
	`ist
(
$this
->
Flds
[
$ame
]) )

412  
$this
->
Flds
[
$ame
];

415 
	}
}

418 
funi
 
	$GTemFe
()

420 
glob
 
$cfg_bad
,
$cfg_ms_d
,
$cfg_df_y
;

421 
$cid
 = 
$this
->
ChlUn
->
ChlInfos
['nid'];

422 if(!
	`emy
(
$this
->
Flds
['templet']))

424 
$fag
 = 
	`MfTem
(
$this
->
Flds
['templet']);

425 if!
	`eg
('/', 
$fag
$fag = 
$GLOBALS
['cfg_df_style'].'/'.$filetag;

429 
$fag
 = 
	`MfTem
(
$this
->
TyLk
->
TyInfos
["temparticle"]);

431 
$tid
 = 
$this
->
Flds
['typeid'];

432 
$fag
 = 
	`r_a
('{cid}', 
$cid
,$filetag);

433 
$fag
 = 
	`r_a
('{tid}', 
$tid
,$filetag);

434 
$tmpfe
 = 
$cfg_bad
.
$cfg_ms_d
.'/'.
$fag
;

435 if(
$cid
=='spec')

437 if!
	`emy
(
$this
->
Flds
['templet']) )

439 
$tmpfe
 = 
$cfg_bad
.
$cfg_ms_d
.'/'.
$fag
;

443 
$tmpfe
 = 
$cfg_bad
.
$cfg_ms_d
."/{$cfg_df_style}/article_spec.htm";

446 if(!
	`fe_exis
(
$tmpfe
))

448 
$tmpfe
 = 
$cfg_bad
.
$cfg_ms_d
."/{$cfg_df_y}/".(
$cid
=='spec' ? 'article_spec.htm' : 'article_default.htm');

450  
$tmpfe
;

451 
	}
}

454 
funi
 
	$diy
()

456 if(
$this
->
IsE
)

460 
$this
->
Flds
["displaytype"] = "dm";

461 if(
$this
->
NowPage
 > 1$this->
Flds
["title"] = $this->Fields["title"]."({$this->NowPage})";

463 
$this
->
	`LdTem
();

464 
$this
->
	`PAddTab
();

466 
$this
->
	`PTemsF
();

469 if(
	`eg
('j', 
$this
->
Flds
['flag']) && $this->Fields['redirecturl'] != '')

471 if(
$GLOBALS
['cfg_jump_once']=='N')

473 
$geHtml
 = "<html>\r\n<hd>\r\n<mhp-equiv=\"Cڋ-Ty\" cڋ=\"xt/html; cht=".
$GLOBALS
['cfg_so_ng']."\">\r\n<t>".
$this
->
Flds
['title']."</title>\r\n";

474 
$geHtml
 ."<mhp-equiv=\"esh\" cڋ=\"3;URL=".
$this
->
Flds
['redirecturl']."\">\r\n</head>\r\n<body>\r\n";

475 
$geHtml
 ."现在正在转向：".
$this
->
Flds
['title']."，请稍候...<br/><br/>\r\n转向内容简介:".$this->Fields['description']."\r\n</body>\r\n</html>\r\n";

476 
echo
 
$geHtml
;

480 
	`hd
("location:{$this->Fields['redirecturl']}");

482 
	`ex
();

484 
$geCou
 = 
$this
->
NowPage
;

485 
$this
->
	`PDMFlds
(
$geCou
,0);

486 
$this
->
d
->
	`diy
();

487 
	}
}

490 
funi
 
	$LdTem
()

492 if(
$this
->
TempSour
=='')

494 
$mpfe
 = 
$this
->
	`GTemFe
();

495 if(!
	`fe_exis
(
$mpfe
|| !
	`is_fe
($tempfile))

497 
echo
 "文档ID：{$this->Fields['id']} - {$this->TypeLink->TypeInfos['typename']} - {$this->Fields['title']}<br />";

498 
echo
 "模板文件不存在，无法解析文档！";

499 
	`ex
();

501 
$this
->
d
->
	`LdTeme
(
$mpfe
);

502 
$this
->
TempSour
 = $this->
d
->
SourSg
;

506 
$this
->
d
->
	`LdSour
($this->
TempSour
);

508 
	}
}

511 
funi
 
	$PTemsF
()

513 if(
	`emy
(
$this
->
Flds
['keywords']))

515 
$this
->
Flds
['keywords'] = '';

518 if(
	`emy
(
$this
->
Flds
['reid']))

520 
$this
->
Flds
['reid'] = 0;

523 
$GLOBALS
['vs']['gs'] = 
$this
->
Flds
['tags'];

525 if(
	`ist
(
$this
->
TyLk
->
TyInfos
['reid']))

527 
$GLOBALS
['vs']['id'] = 
$this
->
TyLk
->
TyInfos
['reid'];

530 
$GLOBALS
['vs']['keywd'] = 
$this
->
Flds
['keywords'];

532 
$GLOBALS
['vs']['tyid'] = 
$this
->
Flds
['typeid'];

534 
$GLOBALS
['vs']['tid'] = 
	`GTid
(
$this
->
Flds
['typeid']);

536 
$GLOBALS
['vs']['aid'] = $GLOBALS['vs']['id'] = 
$this
->
Flds
['id'];

538 
$GLOBALS
['vs']['admid'] = $GLOBALS['vs']['mid'] = 
$this
->
Flds
['mid'];

540 
$GLOBALS
['vs']['chlid'] = 
$this
->
TyLk
->
TyInfos
['channeltype'];

542 if(
$this
->
Flds
['reid']>0)

544 
$GLOBALS
['vs']['tyid'] = 
$this
->
Flds
['reid'];

547 
	`MakeOTag
(
$this
->
d
, $this, 'N');

548 
	}
}

551 
funi
 
	$PDMFlds
(
$geNo
,
$ismake
=1)

553 
$this
->
NowPage
 = 
$geNo
;

554 
$this
->
Flds
['nowge'] = $this->
NowPage
;

555 if(
$this
->
SPageFld
!='' && 
	`ist
($this->
Flds
[$this->SplitPageField]))

557 
$this
->
Flds
[$this->
SPageFld
] = $this->
SFlds
[
$geNo
 - 1];

558 if(
$geNo
>1
$this
->
Flds
['desti'] = 
	`im
(
	`eg_a
("[\r\n\t]", ' ', 
	`_subr
(
	`html2xt
($this->Flds[$this->
SPageFld
]), 200)));

562 if(
	`is_y
(
$this
->
d
->
CTags
))

564 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$i
=>
$ag
)

566 if(
$ag
->
	`GName
()=='field')

568 
$this
->
d
->
	`Assign
(
$i
, $this->
	`GFld
(
$ag
->
	`GA
('name'), $ctag) );

570 if(
$ag
->
	`GName
()=='pagebreak')

572 if(
$ismake
==0)

574 
$this
->
d
->
	`Assign
(
$i
,$this->
	`GPagebakDM
($this->
TٮPage
,$this->
NowPage
,$this->
ArcID
));

578 
$this
->
d
->
	`Assign
(
$i
,$this->
	`GPagebak
($this->
TٮPage
,$this->
NowPage
,$this->
ArcID
));

581 if(
$ag
->
	`GName
()=='pagetitle')

583 if(
$ismake
==0)

585 
$this
->
d
->
	`Assign
(
$i
,$this->
	`GPageTsDM
(
$ag
->
	`GA
("y"),
$geNo
));

589 
$this
->
d
->
	`Assign
(
$i
,$this->
	`GPageTsST
(
$ag
->
	`GA
("y"),
$geNo
));

592 if(
$ag
->
	`GName
()=='prenext')

594 
$this
->
d
->
	`Assign
(
$i
,$this->
	`GPNext
(
$ag
->
	`GA
('get')));

596 if(
$ag
->
	`GName
()=='fieldlist')

598 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

599 if(
$ùext
==''$ùex
	`GSysTems
('tag_fieldlist.htm');

600 
$d2
 = 
w
 
	`DedeTagP
();

601 
$d2
->
	`SNameS
('field','[',']');

602 
$d2
->
	`LdSour
(
$ùext
);

603 
$dSour
 = 
$d2
->
SourSg
;

604 
$dCgs
 = 
$d2
->
CTags
;

605 
$s
 = '';

606 if(
	`is_y
(
$this
->
ChlUn
->
ChlFlds
&& is_y(
$d2
->
CTags
))

608 
	`fܗch
(
$this
->
ChlUn
->
ChlFlds
 
as
 
$k
=>
$v
)

610 if(
	`ist
(
$v
['autofld']&& 
	`emy
($v['autofield'])) {

613 
$d2
->
SourSg
 = 
$dSour
;

614 
$d2
->
CTags
 = 
$dCgs
;

615 
$ame
 = 
$v
['itemname'];

616 
	`fܗch
(
$d2
->
CTags
 
as
 
$tid
=>
$ag2
)

618 if(
$ag2
->
	`GName
()=='name')

620 
$d2
->
	`Assign
(
$tid
,
$ame
);

622 if(
$ag2
->
	`GName
()=='tagname')

624 
$d2
->
	`Assign
(
$tid
,
$k
);

626 if(
$ag2
->
	`GName
()=='value')

628 
$this
->
Flds
[
$k
] = $this->
ChlUn
->
	`MakeFld
($k,$this->Flds[$k],
$ag2
);

629 @
$d2
->
	`Assign
(
$tid
,
$this
->
Flds
[
$k
]);

632 
$s
 .
$d2
->
	`GResu
();

635 
$this
->
d
->
	`Assign
(
$i
,
$s
);

641 
	}
}

644 
funi
 
	$Clo
()

646 
$this
->
FixedVues
 = '';

647 
$this
->
Flds
 = '';

648 
	}
}

651 
funi
 
GPNext
(
$gty
='')

653 
$rs
 = '';

654 if(
cou
(
$this
->
PNext
)<2)

656 
	g$aid
 = 
$this
->
ArcID
;

657 
	g$eR
 = 
$this
->
dsql
->
GO
("Select id From `#@__arctiny` where id<$aid Andrcrank>-1 Andypeid='{$this->Fields['typeid']}' order by id desc");

658 
	g$xtR
 = 
$this
->
dsql
->
GO
("Select id From `#@__arctiny` where id>$aid Andrcrank>-1 Andypeid='{$this->Fields['typeid']}' order by idsc");

659 
	g$xt
 = (
is_y
(
$xtR
) ? " whererc.id={$nextR['id']} " : ' where 1>2 ');

660 
	g$e
 = (
is_y
(
$eR
) ? " whererc.id={$preR['id']} " : ' where 1>2 ');

661 
	g$quy
 = "Selectrc.id,arc.title,arc.shorttitle,arc.typeid,arc.ismake,arc.senddate,arc.arcrank,arc.money,arc.filename,

662 
t
.
tyd
,
	gt
.
	gtyme
,t.
	gmu
,t.
	gmu2
,t.
	git
,t.
	gmese
,t.
	gseu
,t.
sh


663 
	gom
 `#@
	g__chives
` 
c
 

 
	gjo
 #@
__y
 
t
 

 
	gc
.
	gtyid
.
id
 ";

664 
$xtRow
 = 
$this
->
dsql
->
GO
(
$quy
.
$xt
);

665 
	g$eRow
 = 
$this
->
dsql
->
GO
(
$quy
.
$e
);

666 if(
is_y
(
$eRow
))

668 
	g$mlk
 = 
GFeU
(
$eRow
['id'],$preRow['typeid'],$preRow['senddate'],$preRow['title'],$preRow['ismake'],$preRow['arcrank'],

669 
$eRow
['namerule'],$preRow['typedir'],$preRow['money'],$preRow['filename'],$preRow['moresite'],$preRow['siteurl'],$preRow['sitepath']);

670 
	g$this
->
	gPNext
['pre'] = "上一篇：<a href='$mlink'>{$preRow['title']}</a> ";

674 
	g$this
->
	gPNext
['pre'] = "上一篇：没有了 ";

676 if(
is_y
(
$xtRow
))

678 
	g$mlk
 = 
GFeU
(
$xtRow
['id'],$nextRow['typeid'],$nextRow['senddate'],$nextRow['title'],$nextRow['ismake'],$nextRow['arcrank'],

679 
$xtRow
['namerule'],$nextRow['typedir'],$nextRow['money'],$nextRow['filename'],$nextRow['moresite'],$nextRow['siteurl'],$nextRow['sitepath']);

680 
	g$this
->
	gPNext
['next'] = "下一篇：<a href='$mlink'>{$nextRow['title']}</a> ";

684 
	g$this
->
	gPNext
['next'] = "下一篇：没有了 ";

687 if(
	g$gty
=='pre')

689 
$rs
 = 
$this
->
PNext
['pre'];

691 if(
	g$gty
=='next')

693 
$rs
 = 
$this
->
PNext
['next'];

697 
	g$rs
 = 
$this
->
PNext
['pre']." &nbsp; ".$this->PreNext['next'];

699  
	g$rs
;

703 
funi
 
	$GPagebakDM
(
$tٮPage
,
$nowPage
,
$aid
)

705 
glob
 
$cfg_wre
;

706 if(
$tٮPage
==1)

710 
$PageLi
 = "<li><a>共".
$tٮPage
."页: </a></li>";

711 
$nPage
 = 
$nowPage
-1;

712 
$lPage
 = 
$nowPage
+1;

713 if(
$nowPage
==1)

715 
$PageLi
.="<li><a href='#'>上一页</a></li>";

719 if(
$nPage
==1)

721 
$PageLi
.="<li><a href='view.php?aid=$aid'>上一页</a></li>";

722 if(
$cfg_wre
 == 'Y')

724 
$PageLi
 = 
	`eg_a
("/.php\?aid=(\d+)/i",'-\\1-1.html',$PageList);

729 
$PageLi
.="<li><a href='view.php?aid=$aid&pageno=$nPage'>上一页</a></li>";

730 if(
$cfg_wre
 == 'Y')

732 
$PageLi
 = 
	`r_a
(".php?aid=","-",$PageList);

733 
$PageLi
 = 
	`eg_a
("/&pageno=(\d+)/i",'-\\1.html',$PageList);

737 
$i
=1;$i<=
$tٮPage
;$i++)

739 if(
$i
==1)

741 if(
$nowPage
!=1)

743 
$PageLi
.="<li><a href='view.php?aid=$aid'>1</a></li>";

744 if(
$cfg_wre
 == 'Y')

746 
$PageLi
 = 
	`eg_a
("/.php\?aid=(\d+)/i",'-\\1-1.html',$PageList);

751 
$PageLi
.="<li class=\"thisclass\"><a>1</a></li>";

756 
$n
 = 
$i
;

757 if(
$nowPage
!=
$i
)

759 
$PageLi
.="<li><hf='vw.php?aid=$aid&go=$i'>".
$n
."</a></li>";

760 if(
$cfg_wre
 == 'Y')

762 
$PageLi
 = 
	`r_a
(".php?aid=","-",$PageList);

763 
$PageLi
 = 
	`eg_a
("/&pageno=(\d+)/i",'-\\1.html',$PageList);

768 
$PageLi
.="<li class=\"thisclass\"><a href='#'>{$n}</a></li>";

772 if(
$lPage
 <
$tٮPage
)

774 
$PageLi
.="<li><a href='view.php?aid=$aid&pageno=$lPage'>下一页</a></li>";

775 if(
$cfg_wre
 == 'Y')

777 
$PageLi
 = 
	`r_a
(".php?aid=","-",$PageList);

778 
$PageLi
 = 
	`eg_a
("/&pageno=(\d+)/i",'-\\1.html',$PageList);

783 
$PageLi
.= "<li><a href='#'>下一页</a></li>";

785  
$PageLi
;

786 
	}
}

789 
funi
 
	$GPagebak
(
$tٮPage
,
$nowPage
,
$aid
)

791 if(
$tٮPage
==1)

795 
$PageLi
 = "<li><a>共".
$tٮPage
."页: </a></li>";

796 
$nPage
 = 
$nowPage
-1;

797 
$lPage
 = 
$nowPage
+1;

798 if(
$nowPage
==1)

800 
$PageLi
.="<li><a href='#'>上一页</a></li>";

804 if(
$nPage
==1)

806 
$PageLi
.="<li><hf='".
$this
->
NameF
.".".$this->
ShtName
."'>上一页</a></li>";

810 
$PageLi
.="<li><hf='".
$this
->
NameF
."_".
$nPage
.".".$this->
ShtName
."'>上一页</a></li>";

813 
$i
=1;$i<=
$tٮPage
;$i++)

815 if(
$i
==1)

817 if(
$nowPage
!=1)

819 
$PageLi
.="<li><hf='".
$this
->
NameF
.".".$this->
ShtName
."'>1</a></li>";

823 
$PageLi
.="<li class=\"thisclass\"><a href='#'>1</a></li>";

828 
$n
 = 
$i
;

829 if(
$nowPage
!=
$i
)

831 
$PageLi
.="<li><hf='".
$this
->
NameF
."_".
$i
.".".$this->
ShtName
."'>".
$n
."</a></li>";

835 
$PageLi
.="<li class=\"thisclass\"><a href='#'>{$n}</a></li>";

839 if(
$lPage
 <
$tٮPage
)

841 
$PageLi
.="<li><hf='".
$this
->
NameF
."_".
$lPage
.".".$this->
ShtName
."'>下一页</a></li>";

845 
$PageLi
.= "<li><a href='#'>下一页</a></li>";

847  
$PageLi
;

848 
	}
}

851 
funi
 
	$GPageTsDM
(
$yName
,
$geNo
)

853 if(
$this
->
TٮPage
==1)

857 if(
	`cou
(
$this
->
STs
)==0)

861 
$i
=1;

862 
$aid
 = 
$this
->
ArcID
;

863 if(
$yName
=='link')

865 
$vue
 = "";

866 
	`fܗch
(
$this
->
STs
 
as
 
$k
=>
$v
)

868 if(
$i
==1)

870 
$vue
 .= "<a href='view.php?aid=$aid&pageno=$i'>$v</a> \r\n";

874 if(
$geNo
==
$i
)

876 
$vue
 .= " $v \r\n";

880 
$vue
 .= "<a href='view.php?aid=$aid&pageno=$i'>$v</a> \r\n";

883 
$i
++;

888 
$vue
 = "<select id='dedepagetitles' onchange='location.href=this.options[this.selectedIndex].value;'>\r\n";

889 
	`fܗch
(
$this
->
STs
 
as
 
$k
=>
$v
)

891 if(
$i
==1)

893 
$vue
 ."<ti vue='".
$this
->
Flds
['phpurl']."/view.php?aid=$aid&pageno=$i'>{$i}、{$v}</option>\r\n";

897 if(
$geNo
==
$i
)

899 
$vue
 ."<ti vue='".
$this
->
Flds
['phpurl']."/view.php?aid=$aid&pageno=$i' selected>{$i}、{$v}</option>\r\n";

903 
$vue
 ."<ti vue='".
$this
->
Flds
['phpurl']."/view.php?aid=$aid&pageno=$i'>{$i}、{$v}</option>\r\n";

906 
$i
++;

908 
$vue
 .= "</select>\r\n";

910  
$vue
;

911 
	}
}

914 
funi
 
	$GPageTsST
(
$yName
,
$geNo
)

916 if(
$this
->
TٮPage
==1)

920 if(
	`cou
(
$this
->
STs
)==0)

924 
$i
=1;

925 if(
$yName
=='link')

927 
$vue
 = "";

928 
	`fܗch
(
$this
->
STs
 
as
 
$k
=>
$v
)

930 if(
$i
==1)

932 
$vue
 ."<hf='".
$this
->
NameF
.".".$this->
ShtName
."'>$v</a> \r\n";

936 if(
$geNo
==
$i
)

938 
$vue
 .= " $v \r\n";

942 
$vue
 ."<hf='".
$this
->
NameF
."_".
$i
.".".$this->
ShtName
."'>$v</a> \r\n";

945 
$i
++;

950 
$vue
 = "<select id='dedepagetitles' onchange='location.href=this.options[this.selectedIndex].value;'>\r\n";

951 
	`fܗch
(
$this
->
STs
 
as
 
$k
=>
$v
)

953 if(
$i
==1)

955 
$vue
 ."<ti vue='".
$this
->
NameF
.".".$this->
ShtName
."'>{$i}、{$v}</option>\r\n";

959 if(
$geNo
==
$i
)

961 
$vue
 ."<ti vue='".
$this
->
NameF
."_".
$i
.".".$this->
ShtName
."' selected>{$i}、{$v}</option>\r\n";

965 
$vue
 ."<ti vue='".
$this
->
NameF
."_".
$i
.".".$this->
ShtName
."'>{$i}、{$v}</option>\r\n";

968 
$i
++;

970 
$vue
 .= "</select>\r\n";

972  
$vue
;

973 
	}
}

982 
funi
 
	$RKeywd
(
$kw
,&
$body
)

984 
glob
 
$cfg_cmh
;

985 
$maxkey
 = 5;

986 
$kws
 = 
	`exode
(",",
	`im
(
$kw
));

987 
$i
=0;

988 
$kr
 = 
$k
 = 
$GLOBALS
['ad'] = 
	`y
();

991 
$body
 = 
	`eg_a
("/(<a(.*))(>)(.*)(<)(\/a>)/isU", '\\1-]-\\4-[-\\6', $body);

993 
	`fܗch
(
$kws
 
as
 
$k
)

995 
$k
 = 
	`im
($k);

996 if(
$k
!="")

998 if(
$i
 > 
$maxkey
)

1002 
$myrow
 = 
$this
->
dsql
->
	`GO
("select * from #@__keywords where keyword='$k' Andpurl<>'' ");

1003 if(
	`is_y
(
$myrow
))

1005 
$kr
[] = 
$k
;

1006 
$GLOBALS
['ad'][
$k
] = 0;

1007 
$k
[] = "<a href='{$myrow['rpurl']}'><u>$k</u></a>";

1009 
$i
++;

1012 
$body
 = 
	`eg_a
("/(^|>)([^<]+)(?=<|$)/sUe", "_highlight('\\2', \$karr, \$kaarr, '\\1')", $body);

1015 
$body
 = 
	`eg_a
("/(<a(.*))-\]-(.*)-\[-(\/a>)/isU", '\\1>\\3<\\4', $body);

1016  
$body
;

1017 
	}
}

1023 
funi
 
	$_highlight
(
$rg
, 
$wds
, 
$su
, 
$e
)

1025 
glob
 
$cfg_a_num
;

1026 
$rg
 = 
	`r_a
('\"', '"', $string);

1027 if(
$cfg_a_num
 > 0)

1029 
	`fܗch
 (
$wds
 
as
 
$key
 => 
$wd
)

1031 if(
$GLOBALS
['ad'][
$wd
] == 1)

1035 
$rg
 = 
	`eg_a
("/".
	`eg_que
(
$wd
)."/", 
$su
[
$key
], $rg, 
$cfg_a_num
);

1036 if(
	`os
(
$rg
, 
$wd
!=
l
)

1038 
$GLOBALS
['ad'][
$wd
] = 1;

1044 
$rg
 = 
	`r_a
(
$wds
, 
$su
, $string);

1046  
$e
.
$rg
;

1047 
	}
}

	@include/arc.caicai.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/datalistcp.class.php");

7 
que_
(
DEDEINC
."/channelunit.func.php");

9 as
	cCaii
 
exnds
 
	mDaLiCP


11 
v
 
	m$maxPageSize
 = 100;

12 
v
 
	m$cCacheTime
 = 3600;

18 
funi
 
	$PLd
()

20 
glob
 
$tٮsu
,
$go
;

21 if(
	`emy
(
$go
|| 
	`eg
("[^0-9]",$pageno))

23 
$go
 = 1;

25 if(
	`emy
(
$tٮsu
|| 
	`eg
("[^0-9]",$totalresult))

27 
$tٮsu
 = 0;

29 
$this
->
geNO
 = 
$go
;

30 
$this
->
tٮResu
 = 
$tٮsu
;

32 if(
	`ist
(
$this
->
l
->
Cfgs
['pagesize'])){

33 
$this
->
geSize
 = $this->
l
->
Cfgs
['pagesize'];

35 
$this
->
tٮPage
 = 
	`
($this->
tٮResu
/$this->
geSize
);

36 if(
$this
->
tٮPage
 > $this->
maxPageSize
)

38 
$this
->
tٮPage
 = $this->
maxPageSize
;

41 if(
$this
->
geNO
 > $this->
tٮPage
)

43 
$this
->
geNO
 = $this->
tٮPage
;

44 
$this
->
tٮResu
 = $this->
tٮPage
 * $this->
geSize
;

46 
$this
->
sourSql
 = 
	`eg_a
("limit [0-9,]{1,}",'',$this->sourceSql);

47 if(
$this
->
tٮResu
==0)

52 
$couQuy
 = 
	`egi_a
("[ \r\n\t](.*)[ \r\n\t]om","Se cou(*add From",
$this
->
sourSql
);

53 
$row
 = 
$this
->
dsql
->
	`GO
(
$couQuy
);

54 
$this
->
tٮResu
 = 
$row
['dd'];

55 
$this
->
sourSql
 ."im 0,".$this->
geSize
;

59 
$this
->
sourSql
 ."im ".(($this->
geNO
-1* $this->
geSize
).",".$this->pageSize;

71 
funi
 
	`GArcLi
(
$ts
,
$fObj
='',
$flds
=
	$y
())

73 
$rsAay
 = 
	`y
();

74 
$t1
 = 
	`Exeime
();

75 if(!
$this
->
isQuy
)

77 
$this
->
dsql
->
	`Execu
('dli',$this->
sourSql
);

79 
$i
 = 0;

80 
$r
=
$this
->
dsql
->
	`GAay
('dlist'))

82 
$i
++;

83 
$r
['fame'] = $r['cu'] = 
	`GFeU
($arr['id'],$arr['typeid'],$arr['senddate'],$arr['title'],$arr['ismake'],

84 
$r
['arcrank'],$arr['namerule'],$arr['typedir'],$arr['money'],$arr['filename'],$arr['moresite'],$arr['siteurl'],$arr['sitepath']);

85 
$r
['tyu'] = 
	`GTyU
($r['tyid'],
	`MfTyd
($arr['typedir']),$arr['isdefault'],$arr['defaultname'],

86 
$r
['ispart'],$arr['namerule2'],$arr['moresite'],$arr['siteurl'],$arr['sitepath']);

87 if(
$r
['litpic'] == '-' || $arr['litpic'] == '')

89 
$r
['litpic'] = 'images/dfpic.gif';

91 if(!
	`egi
("^hp://",
$r
['lpic']&& 
$GLOBALS
['cfg_multi_site'] == 'Y')

93 
$r
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$arr['litpic'];

95 
$r
['picname'] = $arr['litpic'];

96 
$r
['alttitle'] = $arr['userid']." 的空间";

97 
$r
['face'] = ($arr['face']!='' ? $arr['face'] : 'images/nopic.gif');

98 if(
$r
['userid']!='')

100 
$r
['au'] = 
$GLOBALS
['cfg_basehost'].'/member/index.php?uid='.$arr['userid'];

104 
$r
['alttitle'] = $arr['title'];

105 
$r
['spaceurl'] = $arr['arcurl'];

106 
$r
['face'] = $arr['litpic'];

107 
$r
[''] = 
	`r_a
('defaultpic','dfcaicai',$arr['face']);

109 if(!
	`emy
(
$r
['lastpost']))

111 
$r
['ϡpo'] = 
	`MyDe
('m-d h:i',$arr['lastpost']);

115 
$r
['lastpost'] = "<a href='../plus/feedback.php?aid={$arr['id']}'>说几句&gt;&gt;</a>";

117 
$rsAay
[
$i
] = 
$r
;

118 if(
$i
 >
$this
->
geSize
)

123 
$this
->
dsql
->
	`FeResu
('dlist');

124 
$this
->
quyTime
 = (
	`Exeime
(- 
$t1
);

125  
$rsAay
;

126 
	}
}

136 
funi
 
GStArc
(
$ts
,
$fObj
='',
$flds
=
	$y
())

138 
$ow
 = (
	`emy
(
$ts
['row']) ? 12 : $atts['row']);

139 
$d
 = (
	`emy
(
$ts
['order']) ? 'scores' : $atts['order'] );

140 
$dway
 = (
	`emy
(
$ts
['orderway']) ? 'desc' : $atts['orderway'] );

141 if(
	`emy
(
$ow
))

143 
$ow
 = 12;

146 
$quy
 = "Selectrc.*,tp.typedir,tp.typename,

147 

.
isdeu
,.
deume
,.
mu
,.
mu2
,.
it
,.
mese
,.
seu
,.
sh


148 
From
 `#@
__chives
` 
c
 

 
jo
 `#@
__y
` 

 

p.
id
rc.
tyid


149 
whe
 
c
.
k
>-1 
d
 
by
rc.{
$d
} 
$dway
 
lim
 0,
$ow
 ";

151 
$rsAay
 = 
	`y
();

153 
$cheFe
 = 
DEDEDATA
.'/che/ii_'.
	`md5
(
$quy
).'.inc';

154 
$edCache
 = 
l
;

155 if(
	`fe_exis
(
$cheFe
&& 
	`femtime
($cheFe)-
	`time
(< 
$this
->
cCacheTime
)

157 
$
 = 
	`fݒ
(
$cheFe
, 'r');

158 
$ids
 = 
	`d
(
$
, 
	`fesize
(
$cheFe
));

159 
	`fo
(
$
);

160 
$ids
 = 
	`im
($ids);

161 if!
	`emy
(
$ids
) )

163 
$quy
 = "Selectrc.*,tp.typedir,tp.typename,

164 

.
isdeu
,.
deume
,.
mu
,.
mu2
,.
it
,.
mese
,.
seu
,.
sh


165 
From
 `#@
__chives
` 
c
 

 
jo
 `#@
__y
` 

 

p.
id
rc.
tyid


166 
whe
 
c
.
id
 
	`
(
$ids

d
 
by
rc.{
$d
} 
$dway
 ";

171 
$edCache
 = 
ue
;

173 
$ids
 = 
	`y
();

174 
$i
 = 0;

175 
$this
->
dsql
->
	`Execu
('i',
$quy
);

176 
$r
=
$this
->
dsql
->
	`GAay
('cai'))

178 
$i
++;

179 
$ids
[] = 
$r
['id'];

180 
$r
['fame'] = $r['cu'] = 
	`GFeU
($arr['id'],$arr['typeid'],$arr['senddate'],$arr['title'],$arr['ismake'],

181 
$r
['arcrank'],$arr['namerule'],$arr['typedir'],$arr['money'],$arr['filename'],$arr['moresite'],$arr['siteurl'],$arr['sitepath']);

183 
$r
['tyu'] = 
	`GTyU
($r['tyid'],
	`MfTyd
($arr['typedir']),$arr['isdefault'],$arr['defaultname'],

184 
$r
['ispart'],$arr['namerule2'],$arr['moresite'],$arr['siteurl'],$arr['sitepath']);

186 if(
$r
['litpic']=='')

188 
$r
['litpic'] = '/images/defaultpic.gif';

191 if(!
	`egi
("^hp://",
$r
['litpic']))

193 
$r
['piame'] = $r['lpic'] = 
$GLOBALS
['cfg_cmsurl'].$arr['litpic'];

197 
$r
['picname'] = $arr['litpic'] = $arr['litpic'];

200 
$rsAay
[
$i
] = 
$r
;

202 
$this
->
dsql
->
	`FeResu
('cai');

205 if(
$edCache
 && 
	`cou
(
$ids
) > 0)

207 
$idsr
 = 
	`jo
(',', 
$ids
);

208 
$
 = 
	`fݒ
(
$cheFe
, 'w');

209 
	`fwre
(
$
, 
$idsr
);

210 
	`fo
(
$
);

213  
$rsAay
;

215 
	}
}

225 
funi
 
GCog
(
$ts
,
$fObj
='',
$flds
=
	$y
())

227 
$maxrow
 = (
	`emy
(
$ts
['row']) ? 12 : $atts['row']);

228 
$quy
 = "Select id,typename From `#@__arctype` whereeid=0nd ispart<2 And channeltype>0 order by sortrankscimit 0,$maxrow ";

229 
$rsAay
 = 
	`y
();

230 
$this
->
dsql
->
	`Execu
('co',
$quy
);

231 
$i
 = 0;

232 
$r
=
$this
->
dsql
->
	`GAay
('co'))

234 
$i
++;

235 
$rsAay
[
$i
] = 
$r
;

237 
$this
->
dsql
->
	`FeResu
('co');

238  
$rsAay
;

239 
	}
}

	@include/arc.datalist.class.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

3 @
t_time_lim
(0);

4 
que_
(
DEDEINC
.'/channelunit.class.php');

5 
que_
(
DEDEINC
.'/typelink.class.php');

7 
	g$codefe
 = (
ist
(
$edCode
? $edCod: 
$cfg_so_ng
);

8 if(
fe_exis
(
DEDEINC
.'/code/di.'.
$codefe
.'.inc'))

10 
que_
(
DEDEINC
.'/code/di.'.
$codefe
.'.inc');

14 
	g$ng_e_ge
 = '上页';

15 
	g$ng_xt_ge
 = '下页';

16 
	g$ng_dex_ge
 = '首页';

17 
	g$ng_d_ge
 = '末页';

18 
	g$ng_cd_numb
 = '条记录';

19 
	g$ng_ge
 = '页';

20 
	g$ng_tٮ
 = '共';

23 as
	cDaLi


25 
v
 
	m$dsql
;

26 
v
 
	m$d
;

27 
v
 
	m$d2
;

28 
v
 
	m$TyID
;

29 
v
 
	m$TyLk
;

30 
v
 
	m$PageNo
;

31 
v
 
	m$TٮPage
;

32 
v
 
	m$TٮResu
;

33 
v
 
	m$PageSize
;

34 
v
 
	m$ChlUn
;

35 
v
 
	m$LiTy
;

36 
v
 
	m$Flds
;

37 
v
 
	m$SourSql
;

38 
v
 
	m$Teme
;

39 
v
 
	m$TemeSg
;

40 
v
 
	m$QuyTime
;

41 
v
 
	m$GVues
;

43 
funi
 
__cڡru
(
$tyid
=0, 
$sql
='', 
$me
='')

45 
$this
->
TyID
 = 
$tyid
;

46 
	m$this
->
	mdsql
 = 
$GLOBALS
['dsql'];

47 
	m$this
->
	mTeme
 = 
$me
;

48 
	m$this
->
	mSourSql
 = 
$sql
;

49 
	m$this
->
	mGVues
 = 
y
();

50 
	m$this
->
	md
 = 
w
 
DedeTagP
();

51 
	m$this
->
	md
->
	mfObj
 = 
$this
;

52 
	m$this
->
	md
->
SNameS
('dede', '{', '}');

53 
	m$this
->
	md2
 = 
w
 
DedeTagP
();

54 
	m$this
->
	md2
->
SNameS
('field', '[', ']');

57 if!
emy
(
$tyid
) )

59 
	m$this
->
	mTyLk
 = 
w
 
TyLk
(
$tyid
);

60 
	m$this
->
	mFlds
 = 
$this
->
TyLk
->
TyInfos
;

61 
	m$this
->
	mFlds
['id'] = 
$tyid
;

62 
	m$this
->
	mFlds
['posi'] = 
$this
->
TyLk
->
GPosiLk
(
ue
);

63 
	m$this
->
	mFlds
['t'] = 
eg_a
("[<>]"," / ",
$this
->
TyLk
->
GPosiLk
(
l
));

64 
	m$this
->
	mFlds
['rsk'] = 
$GLOBALS
['cfg_cmsu']."/da/rss/".
$this
->
TyID
.".xml";

66 
SSysEnv
(
$this
->
TyID
, $this->
Flds
['typename'], 0, '', 'datalist');

67 
	m$this
->
	mFlds
['tyid'] = 
$this
->
TyID
;

70 
fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v
)

72 
$this
->
Flds
[
$k
] = 
$v
;

77 
funi
 
DaLi
(
$tyid
=0, 
$sql
='', 
$me
='')

79 
$this
->
__cڡru
(
$tyid
, 
$sql
, 
$me
);

83 
funi
 
	$SQuy
(
$sql
)

85 
$this
->
SourSql
 = 
$sql
;

86 
	}
}

89 
funi
 
	$STeme
(
$fame
)

91 
$this
->
Teme
 = 
$fame
;

92 
	}
}

95 
funi
 
	$STemeSg
(
$r
)

97 
$this
->
TemeSg
 = 
$r
;

98 
	}
}

101 
funi
 
	$Clo
()

104 
	}
}

107 
funi
 
	$CouRecd
()

110 
$this
->
TٮResu
 = -1;

111 if(
	`ist
(
$GLOBALS
['TٮResu'])
$this
->
TٮResu
 = $GLOBALS['TotalResult'];

112 if(
	`ist
(
$GLOBALS
['PageNo'])
$this
->
PageNo
 = $GLOBALS['PageNo'];

113 
$this
->
PageNo
 = 1;

115 if(
$this
->
TٮResu
==-1)

117 
$couQuy
 = 
	`egi_a
("[ \r\n\t](.*)[ \r\n\t]om","Se cou(*add From", 
$this
->
SourSql
);

118 
$couQuy
 = 
	`egi_a
('order[ \r\n\t]{1,}by(.*)', '', $countQuery);

119 
$row
 = 
$this
->
dsql
->
	`GO
(
$couQuy
);

120 if(
	`is_y
(
$row
)) {

121 
$this
->
TٮResu
 = 
$row
['dd'];

124 
$this
->
TٮResu
 = 0;

129 if(
$this
->
Teme
 != '')

131 
$mpfe
 = 
$this
->
Teme
;

132 if(!
	`fe_exis
(
$mpfe
|| !
	`is_fe
($tempfile))

134 
$mpfe
 = 
	`eg_a
("^[^/\\]*/", "/", $tempfile);

135 
echo
 "模板文件 {$tempfile} 不存在，无法解析文档！";

136 
	`ex
();

138 
$this
->
d
->
	`LdTeme
(
$mpfe
);

140 if(
$this
->
TemeSg
 != '')

142 
$this
->
d
->
	`LdSg
($this->
TemeSg
);

146 
echo
 "没指定模板文件或字符串，不能运行类！";

147 
	`ex
();

150 
$ag
 = 
$this
->
d
->
	`GTag
('page');

151 if(!
	`is_obje
(
$ag
))

153 
$ag
 = 
$this
->
d
->
	`GTag
('list');

155 if(!
	`is_obje
(
$ag
))

157 
$this
->
PageSize
 = 20;

161 if(
$ag
->
	`GA
('gesize')!=''
$this
->
PageSize
 = $ctag->GetAtt('pagesize');

162 
$this
->
PageSize
 = 20;

164 
$this
->
TٮPage
 = 
	`
($this->
TٮResu
/$this->
PageSize
);

165 
	}
}

168 
funi
 
	$Diy
()

170 
$this
->
	`CouRecd
();

171 
$this
->
	`PTemsF
();

172 
$this
->
	`PDMFlds
($this->
PageNo
, 0);

173 
$this
->
d
->
	`Diy
();

174 
	}
}

177 
funi
 
	$PTemsF
()

179 if
	`ist
(
$this
->
TyLk
->
TyInfos
) )

181 
$GLOBALS
['vs']['id'] = 
$this
->
TyLk
->
TyInfos
['reid'];

182 
$GLOBALS
['vs']['tyid'] = 
$this
->
TyID
;

183 
$GLOBALS
['vs']['tid'] = 
	`GTid
(
$this
->
TyID
);

184 
$GLOBALS
['envs']['cross'] = 1;

186 
	`MakeOTag
(
$this
->
d
, $this);

187 
	}
}

190 
funi
 
	$PDMFlds
(
$PageNo
, 
$ismake
=0)

192 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$gid
=>
$ag
)

194 if(
$ag
->
	`GName
() == 'list')

196 
$this
->
d
->
	`Assign
(
$gid
, $this->
	`GLi
(
$ag
->
CAribu
->
Ims
, $ag->
	`GIText
()));

198 if(
$ag
->
	`GName
() == 'pagelist')

200 
$li_n
 = (
	`im
(
$ag
->
	`GA
('listsize'))=='' ? 3 :rim($ctag->GetAtt('listsize')));

201 
$liem
 = (
$ag
->
	`GA
('listitem')=='' ? 'index,pre,pageno,next,end,option' : $ctag->GetAtt('listitem'));

202 if(
$ismake
==0)

204 
$this
->
d
->
	`Assign
(
$gid
, $this->
	`GPageLiDM
(
$li_n
, 
$liem
));

208 
$this
->
d
->
	`Assign
(
$gid
, $this->
	`GPageLiST
(
$li_n
, 
$liem
));

212 if(
$PageNo
!=1 && 
$ag
->
	`GName
()=='fld' && $ag->
	`GA
('display')=='first')

214 
$this
->
d
->
	`Assign
(
$gid
,'');

217 
	}
}

220 
funi
 
	$GLi
(
$s
, 
$ùext
)

222 
$rsvue
 = '';

223 
$t1
 = 
	`Exeime
();

224 
$limt
 = (
$this
->
PageNo
-1* $this->
PageSize
;

225 
$oksql
 = 
$this
->
SourSql
."im $limt, ".$this->
PageSize
;

226 
$this
->
dsql
->
	`Execu
('dli', 
$oksql
);

227 
$this
->
d2
->
	`LdSour
(
$ùext
);

228 
$GLOBALS
['autoindex'] = 0;

229 
$r
=
$this
->
dsql
->
	`GAay
('dlist'))

231 if(
	`is_y
(
$this
->
d2
->
CTags
))

233 
	`fܗch
(
$this
->
d2
->
CTags
 
as
 
$k
=>
$ag
)

235 if(
$ag
->
	`GName
()=='array')

237 
$this
->
d2
->
	`Assign
(
$k
,
$r
);

241 if(
	`ist
(
$r
[
$ag
->
	`GName
()])
$this
->
d2
->
	`Assign
(
$k
, $arr[$ctag->GetName()]);

242 
$this
->
d2
->
	`Assign
(
$k
, 
$ag
->
	`GName
().' Not Exists');

246 
$GLOBALS
['autoindex']++;

247 
$rsvue
 .
$this
->
d2
->
	`GResu
();

249 
$this
->
dsql
->
	`FeResu
('dlist');

250 
$this
->
QuyTime
 = (
	`Exeime
(- 
$t1
);

251  
$rsvue
;

252 
	}
}

255 
funi
 
	$SPam
(
$key
, 
$vue
)

257 
$this
->
GVues
[
$key
] = 
$vue
;

258 
	}
}

264 
funi
 
GPageLiDM
(
$li_n
, 
$liem
='index,end,pre,next,pageno')

266 
glob
 
$ng_e_ge
,
$ng_xt_ge
,
$ng_dex_ge
,
$ng_d_ge
,
$ng_cd_numb
,
$ng_ge
,
$ng_tٮ
;

267 
	g$age
 = 
$xage
 = 
$gu

$hidfm
 = '';

268 
	g$agum
 = 
$this
->
PageNo
-1;

269 
	g$xagum
 = 
$this
->
PageNo
+1;

271 
	g$vue
 = "<tablelign='center' class='pagelist'>\r\n<tr>\r\n";

272 
	g$dvue
 = "</tr>\r\n</table>\r\n";

273 if(
	g$li_n
=='' || 
eg
("[^0-9]",
$li_n
))

275 
	g$li_n
 = 3;

277 
	g$tٮge
 = 

(
$this
->
TٮResu
/$this->
PageSize
);

278 if(
	g$tٮge
<=1 && 
$this
->
TٮResu
>0)

280  
$vue
." <td css='gefo'>".
$ng_tٮ
.' 1 '.
$ng_ge
.'/'.
$this
->
TٮResu
.' '.
$ng_cd_numb
."</td>\r\n".
$dvue
;

282 if(
	g$this
->
	gTٮResu
 == 0)

284  
$vue
." <td css='gefo'>".
$ng_tٮ
.' 0 '.
$ng_ge
.'/'.
$this
->
TٮResu
.' '.
$ng_cd_numb
."</td>\r\n".
$dvue
;

287 
	g$gefo
 = "<td class='pageinfo'>{$lang_total} {$totalpage} {$lang_page}/{$this->TotalResult} {$lang_record_number}</td>\r\n";

289 
	g$pu
 = 
$this
->
GCurU
();

292 
	g$gu
 = "TotalResult={$this->TotalResult}&";

293 
	g$hidfm
 = "<td><formction='$purl'ame='dlistPage' class='dlistPage' style='padding:0px;margin:0px'>\r\n";

294 
	g$hidfm
 ."<puty='hidd'ame='TٮResu' vue='".
$this
->
TٮResu
."'>\r\n";

295 if(
cou
(
$this
->
GVues
)>0)

297 
fܗch
(
$this
->
GVues
 
as
 
$key
=>
$vue
)

299 
$vue
 = 
ucode
($value);

300 
	g$gu
 .= "{$key}={$value}&";

301 
	g$hidfm
 .= "<inputype='hidden'ame='$key' value='$value' />\n";

304 
	g$hidfm
 ."<puty='xt'ame='PageNO' vue='".
$this
->
TٮResu
."' style='width:30px;height:22px' class='dlistPageno' />\r\n";

305 
	g$hidfm
 .= "<inputype='submit'ame='sbgo' value='GO' style='width:30px;height:22px' class='dlistSubmit' />\r\n";

306 
	g$hidfm
 .= "</form></td>\r\n";

307 
	g$pu
 .'?'.
$gu
;

310 if(
	g$this
->
	gPageNo
 != 1)

312 
$age
 .= "<td class='dlistLink'><a href='{$purl}PageNo=$prepagenum'>{$lang_pre_page}</a></td>\r\n";

313 
	g$dexge
 = "<td class='dlistLink'><a href='{$purl}PageNo=1'>{$lang_index_page}</a></td>\r\n";

317 
	g$dexge
 = "<td class='dlistEmpty'>{$lang_index_page}</td>\r\n";

319 if(
	g$this
->
	gPageNo
 !
$tٮge
 && $totalpage>1)

321 
$xage
 .= "<td class='dlistLink'><a href='{$purl}PageNo=$nextpagenum'>{$lang_next_page}</a></td>\r\n";

322 
	g$dge
 = "<td class='dlistLink'><a href='{$purl}PageNo=$totalpage'>{$lang_end_page}</a></td>\r\n";

326 
	g$dge
 = "<td class='dlistEmpty'>{$lang_end_page}</td>\r\n";

330 
	g$lidd
 = '';

331 
	g$tٮ_li
 = 
$li_n
 * 2 + 1;

332 if(
	g$this
->
	gPageNo
 >
$tٮ_li
)

334 
$j
 = 
$this
->
PageNo
-
$li_n
;

335 
	g$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

336 
	g$tٮ_li
 = (
$tٮ_li
>
$tٮge
 ? $totalpage : $total_list);

340 
	g$j
=1;

341 
	g$tٮ_li
 = (
$tٮ_li
>
$tٮge
 ? $totalpage : $total_list);

343 
	g$j
;$j<=
$tٮ_li
;$j++)

345 
	g$lidd
.(
$j
==
$this
->
PageNo
 ? "<td class='dlistEmpty'>$j</td>\r\n" : "<td class='dlistLink'><a href='{$purl}PageNo=$j'>[{$j}]</a></td>\r\n");

349 
	g$i
 = 
$vue
;

350 if
egi
('dex', 
$liem

	g$i
 .
$dexge
;

351 if
egi
('e', 
$liem

	g$i
 .
$age
;

352 if
egi
('go', 
$liem

	g$i
 .
$lidd
;

353 if
egi
('xt', 
$liem

	g$i
 .
$xage
;

354 if
egi
('d', 
$liem

	g$i
 .
$dge
;

355 if
egi
('fm', 
$liem

	g$i
 .
$hidfm
;

356 
	g$i
 .
$dge
;

358  
	g$i
;

362 
funi
 
	$GCurU
()

364 if(!
	`emy
(
$_SERVER
['REQUEST_URI']))

366 
$nowu
 = 
$_SERVER
['REQUEST_URI'];

367 
$nowus
 = 
	`exode
('?', 
$nowu
);

368 
$nowu
 = 
$nowus
[0];

372 
$nowu
 = 
$_SERVER
['PHP_SELF'];

374  
$nowu
;

375 
	}
}

	@include/arc.freelist.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
 
	gDEDEINC
.'/arc.partview.class.php';

8 @
t_time_lim
(0);

9 as
	cFeLi


11 
v
 
	m$dsql
;

12 
v
 
	m$d
;

13 
v
 
	m$TyID
;

14 
v
 
	m$TyLk
;

15 
v
 
	m$PageNo
;

16 
v
 
	m$TٮPage
;

17 
v
 
	m$TٮResu
;

18 
v
 
	m$PageSize
;

19 
v
 
	m$ChlUn
;

20 
v
 
	m$Flds
;

21 
v
 
	m$PtVw
;

22 
v
 
	m$FLInfos
;

23 
v
 
	m$LiObj
;

24 
v
 
	m$TemsFe
;

25 
v
 
	m$mab
;

28 
funi
 
	$__cڡru
(
$fid
)

30 
glob
 
$dsql
;

31 
$this
->
FeID
 = 
$fid
;

32 
$this
->
TyLk
 = 
w
 
	`TyLk
(0);

33 
$this
->
dsql
 = 
$dsql
;

34 
$this
->
mab
 = '#@__archives';

35 
$this
->
TemsFe
 = '';

36 
$this
->
FLInfos
 = $this->
dsql
->
	`GO
("Select * From `#@__freelist` whereid='$fid' ");

37 
$lir
 = 
$this
->
FLInfos
['listtag'];

38 
$this
->
FLInfos
['maxge'] = (
	`emy
($this->FLInfos['maxpage']) ? 100 : $this->FLInfos['maxpage']);

41 
$nd
 = 
w
 
	`DedeTagP
();

42 
$nd
->
	`SNameS
("dede","{","}");

43 
$nd
->
	`LdSg
(
$lir
);

44 
$this
->
LiObj
 = 
$nd
->
	`GTag
('list');

45 
$this
->
PageSize
 = $this->
LiObj
->
	`GA
('pagesize');

46 if(
	`emy
(
$this
->
PageSize
))

48 
$this
->
PageSize
 = 30;

50 
$chlid
 = 
$this
->
LiObj
->
	`GA
('channel');

64 
$chlid
 = 
	`tv
($channelid);

65 
$this
->
mab
 = '#@__archives';

68 
$this
->
d
 = 
w
 
	`DedeTagP
();

69 
$this
->
d
->
	`SNameS
("dede","{","}");

70 
$this
->
d
->
	`SRefObj
($this);

73 
$this
->
Flds
['aid'] = $this->
FLInfos
['aid'];

74 
$this
->
Flds
['t'] = $this->
FLInfos
['title'];

75 
$this
->
Flds
['posi'] = $this->
FLInfos
['title'];

76 
$this
->
Flds
['keywds'] = $this->
FLInfos
['keywords'];

77 
$this
->
Flds
['desti'] = $this->
FLInfos
['description'];

78 
$chlid
 = 
$this
->
LiObj
->
	`GA
('channel');

79 if(!
	`emy
(
$chlid
))

81 
$this
->
Flds
['chy'] = 
$chlid
;

82 
$this
->
ChlUn
 = 
w
 
	`ChlUn
(
$chlid
);

86 
$this
->
Flds
['channeltype'] = 0;

88 
	`fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v
)

90 
$this
->
Flds
[
$k
] = 
$v
;

92 
$this
->
PtVw
 = 
w
 
	`PtVw
();

93 
$this
->
	`CouRecd
();

97 
funi
 
	$FeLi
(
$fid
)

99 
$this
->
	`__cڡru
(
$fid
);

100 
	}
}

103 
funi
 
	$Clo
()

105 
	}
}

108 
funi
 
	$CouRecd
()

110 
glob
 
$cfg_li_s
,
$cfg_edsty
;

113 
$this
->
TٮResu
 = -1;

114 if(
	`ist
(
$GLOBALS
['TotalResult']))

116 
$this
->
TٮResu
 = 
$GLOBALS
['TotalResult'];

118 if(
	`ist
(
$GLOBALS
['PageNo']))

120 
$this
->
PageNo
 = 
$GLOBALS
['PageNo'];

124 
$this
->
PageNo
 = 1;

128 if(
$this
->
TٮResu
==-1)

130 
$addSql
 = "rcrank > -1 And channel>-1 ";

131 
$tyid
 = 
$this
->
LiObj
->
	`GA
('typeid');

132 
$subday
 = 
$this
->
LiObj
->
	`GA
('subday');

133 
$lity
 = 
$this
->
LiObj
->
	`GA
('type');

134 
$t
 = 
$this
->
LiObj
->
	`GA
('att');

135 
$chlid
 = 
$this
->
LiObj
->
	`GA
('channel');

136 if(
	`emy
(
$chlid
))

138 
$chlid
 = 0;

142 if(!
	`emy
(
$tyid
))

144 if(
$cfg_li_s
=='N')

146 
$addSql
 .= " And (typeid='$typeid') ";

150 
$addSql
 ." Andyid i(".
	`GSIds
(
$tyid
,0,
ue
).") ";

155 if(
$t
!='') {

156 
$ags
 = 
	`exode
(',',
$t
);

157 
$i
=0;
	`ist
(
$ags
[$i]);$i++
$addSql
 .= " AND FIND_IN_SET('{$flags[$i]}',flag)>0 ";

161 if(
$chlid
>0 && !
	`egi
("ec",
$lity
))

163 
$addSql
 .= " And channel = '$channelid' ";

167 if(
	`egi
("commd",
$lity
))

169 
$addSql
 .= " And FIND_IN_SET('c',flag) > 0 ";

171 if(
	`egi
("image",
$lity
))

173 
$addSql
 .= " Anditpic <> '' ";

175 if(
	`egi
("ec",
$lity
|| 
$chlid
==-1)

177 
$addSql
 .= " And channel = -1 ";

179 if(!
	`emy
(
$subday
))

181 
$ime
 = 
	`time
(- 
$subday
 * 86400;

182 
$addSql
 .= " And senddate > $starttime ";

184 
$keywd
 = 
$this
->
LiObj
->
	`GA
('keyword');

185 if(!
	`emy
(
$keywd
))

187 
$addSql
 .= " And CONCAT(title,keywords) REGEXP '$keyword' ";

189 
$cquy
 = "Select count(*)s dd From `{$this->maintable}` where $addSql";

190 
$row
 = 
$this
->
dsql
->
	`GO
(
$cquy
);

191 if(
	`is_y
(
$row
))

193 
$this
->
TٮResu
 = 
$row
['dd'];

197 
$this
->
TٮResu
 = 0;

200 
$this
->
TٮPage
 = 
	`
($this->
TٮResu
/$this->
PageSize
);

201 if(
$this
->
TٮPage
 > $this->
FLInfos
['maxpage'])

203 
$this
->
TٮPage
 = $this->
FLInfos
['maxpage'];

204 
$this
->
TٮResu
 = $this->
TٮPage
 * $this->
PageSize
;

206 
	}
}

209 
funi
 
	$LdTem
()

211 
$tmpd
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir'];

212 
$mpfe
 = 
	`r_a
("{y}",
$GLOBALS
['cfg_df_y'],
$this
->
FLInfos
['templet']);

213 
$mpfe
 = 
$tmpd
."/".$tempfile;

214 if(!
	`fe_exis
(
$mpfe
))

216 
$mpfe
 = 
$tmpd
."/".
$GLOBALS
['cfg_df_style']."/list_free.htm";

218 
$this
->
d
->
	`LdTeme
(
$mpfe
);

219 
$this
->
TemsFe
 = 
	`eg_a
("^".
$GLOBALS
['cfg_bad'],'',
$mpfe
);

220 
	}
}

223 
funi
 
	$MakeHtml
(
$age
=1,
$makagesize
=0)

225 
$this
->
	`LdTem
();

226 
$mu
 = "";

227 if(
	`emy
(
$age
))

229 
$age
 = 1;

231 
$this
->
	`PTemsF
();

232 
$tٮge
 = 
	`
(
$this
->
TٮResu
/$this->
PageSize
);

233 if(
$tٮge
==0)

235 
$tٮge
 = 1;

237 if(
$makagesize
>0)

239 
$dge
 = 
$age
+
$makagesize
;

243 
$dge
 = (
$tٮge
+1);

245 if(
$dge
>(
$tٮge
+1))

247 
$dge
 = 
$tٮge
;

249 
$fFe
 = '';

250 
$this
->
PageNo
=
$age
;$this->PageNo<
$dge
;$this->PageNo++)

252 
$this
->
	`PDMFlds
($this->
PageNo
,1);

255 
$makeFe
 = 
$this
->
	`GMakeFeRu
();

256 if(!
	`eg
("^/",
$makeFe
))

258 
$makeFe
 = "/".$makeFile;

260 
$makeFe
 = 
	`r_a
('{ge}',
$this
->
PageNo
,$makeFile);

261 
$mu
 = 
$makeFe
;

262 
$makeFe
 = 
$GLOBALS
['cfg_basedir'].$makeFile;

263 
$makeFe
 = 
	`eg_a
("/{1,}","/",$makeFile);

264 if(
$this
->
PageNo
==1)

266 
$fFe
 = 
$makeFe
;

270 
$this
->
d
->
	`SaveTo
(
$makeFe
);

271 
echo
 "成功创建：<hf='$mu'g='_bnk'>".
	`eg_a
("/{1,}","/",
$mu
)."</a><br/>";

273 if(
$this
->
FLInfos
['nodefault']==0)

275 
$mu
 = '/'.
	`r_a
('{cmh}',
$GLOBALS
['cfg_cmh'],
$this
->
FLInfos
['listdir']);

276 
$mu
 .'/'.
$this
->
FLInfos
['defaultpage'];

277 
$dexfe
 = 
$GLOBALS
['cfg_bad'].
$mu
;

278 
$mu
 = 
	`eg_a
("/{1,}","/",$murl);

279 
echo
 "复制：$fF为 ".
$this
->
FLInfos
['defaultpage']." <br/>";

280 
	`cy
(
$fFe
,
$dexfe
);

282 
$this
->
	`Clo
();

283  
$mu
;

284 
	}
}

287 
funi
 
	$Diy
()

289 
$this
->
	`LdTem
();

290 
$this
->
	`PTemsF
();

291 
$this
->
	`PDMFlds
($this->
PageNo
,0);

292 
$this
->
d
->
	`Diy
();

293 
	}
}

296 
funi
 
	$DiyPtTems
()

298 
$nm
 = 0;

299 
$tmpd
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir'];

300 if(
$this
->
Flds
['ispart']==1)

302 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
FeID
,$this->
Flds
['tempindex']);

303 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

304 
$mpfe
 = 
$tmpd
."/".$tempfile;

305 if(!
	`fe_exis
(
$mpfe
))

307 
$mpfe
 = 
$tmpd
."/".
$GLOBALS
['cfg_df_style']."/index_default.htm";

309 
$this
->
PtVw
->
	`STem
(
$mpfe
);

311 if(
$this
->
Flds
['ispart']==2)

313 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
FeID
,$this->
Flds
['tempone']);

314 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

315 if(
	`is_fe
(
$tmpd
."/".
$mpfe
))

317 
$this
->
PtVw
->
	`STem
(
$tmpd
."/".
$mpfe
);

321 
$this
->
PtVw
->
	`STem
("这是没有使用模板的单独页！","rg"); 
$nm
 = 1;

324 
	`CeD
(
$this
->
Flds
['typedir']);

325 
$makeU
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],"index",$this->Fields['typedir'],$this->Fields['defaultname'],$this->Fields['namerule2']);

326 
$makeFe
 = 
$this
->
	`GTruePh
().
$makeU
;

327 if(
$nm
==0)

329 
$this
->
PtVw
->
	`Diy
();

332 if(!
	`fe_exis
(
$makeFe
))

334 
$this
->
PtVw
->
	`Diy
();

338 
	`ude
(
$makeFe
);

341 
	}
}

344 
funi
 
	$PTemsF
()

346 
	`MakeOTag
(
$this
->
d
,$this);

347 
	}
}

350 
funi
 
	$PDMFlds
(
$PageNo
,
$ismake
=1)

352 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$gid
=>
$ag
)

354 if(
$ag
->
	`GName
()=="freelist")

356 
$limt
 = (
$this
->
PageNo
-1* $this->
PageSize
;

357 if(
$this
->
PageNo
 > $this->
FLInfos
['maxge']$this->
d
->
	`Assign
(
$gid
, '已经超过了最大允许列出的页面！');

358 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GLi
(
$limt
,
$ismake
));

360 if(
$ag
->
	`GName
()=="pagelist")

362 
$li_n
 = 
	`im
(
$ag
->
	`GA
("listsize"));

363 
$ag
->
	`GA
("liem")=="" ? 
$liem
="info,index,pre,pageno,next,end,option" : $listitem=$ctag->GetAtt("listitem");

364 if(
$li_n
=="")

366 
$li_n
 = 3;

368 if(
$ismake
==0)

370 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiDM
(
$li_n
,
$liem
));

374 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiST
(
$li_n
,
$liem
));

377 if(
$ag
->
	`GName
()=="pageno")

379 
$this
->
d
->
	`Assign
(
$gid
,
$PageNo
);

382 
	}
}

385 
funi
 
	$GMakeFeRu
()

387 
$okfe
 = '';

388 
$mu
 = 
$this
->
FLInfos
['namerule'];

389 
$lid
 = 
$this
->
FLInfos
['listdir'];

390 
$lid
 = 
	`r_a
('{cmh}',
$GLOBALS
['cfg_cmspath'],$listdir);

391 
$okfe
 = 
	`r_a
('{liid}',
$this
->
FLInfos
['aid'],
$mu
);

392 
$okfe
 = 
	`r_a
('{lid}',
$lid
,$okfile);

393 
$okfe
 = 
	`r_a
("\\","/",$okfile);

394 
$md
 = 
	`eg_a
("/([^/]*)$","",
$okfe
);

395 if(!
	`eg
("/",
$md
) &&reg("\.",$mdir))

397  
$okfe
;

401 
	`CeD
(
$md
,'','');

402  
$okfe
;

404 
	}
}

407 
funi
 
	$GLi
(
$limt
,
$ismake
=1)

409 
glob
 
$cfg_li_s
,
$cfg_edsty
;

410 
$c
 = 
$this
->
LiObj
->
	`GA
('col');

411 if(
	`emy
(
$c
))

413 
$c
 = 1;

415 
$tn
 = 
$this
->
LiObj
->
	`GA
('titlelen');

416 
$fޒ
 = 
$this
->
LiObj
->
	`GA
('infolen');

417 
$imgwidth
 = 
$this
->
LiObj
->
	`GA
('imgwidth');

418 
$imgheight
 = 
$this
->
LiObj
->
	`GA
('imgheight');

419 
$tn
 = 
	`ADef
($titlelen,60);

420 
$fޒ
 = 
	`ADef
($infolen,250);

421 
$imgwidth
 = 
	`ADef
($imgwidth,80);

422 
$imgheight
 = 
	`ADef
($imgheight,80);

423 
$ùext
 = 
	`im
(
$this
->
LiObj
->
	`GIText
());

424 if(
	`emy
(
$ùext
))

426 
$ùext
 = 
	`GSysTems
("list_fulllist.htm");

428 
$bwidth
=100;

429 if(
$c
=="")

431 
$c
=1;

433 
$cWidth
 = 
	`
(100/
$c
);

434 
$bwidth
 = $tablewidth."%";

435 
$cWidth
 = $colWidth."%";

438 
$whe
 = "rc.arcrank > -1 And channel>-1 ";

439 
$tyid
 = 
$this
->
LiObj
->
	`GA
('typeid');

440 
$subday
 = 
$this
->
LiObj
->
	`GA
('subday');

441 
$lity
 = 
$this
->
LiObj
->
	`GA
('type');

442 
$t
 = 
$this
->
LiObj
->
	`GA
('att');

443 
$chlid
 = 
$this
->
LiObj
->
	`GA
('channel');

444 if(
	`emy
(
$chlid
))

446 
$chlid
 = 0;

450 if(!
	`emy
(
$tyid
))

452 if(
$cfg_li_s
=='N')

454 
$whe
 .= " And (arc.typeid='$typeid') ";

458 
$whe
 ." Andrc.tyid i(".
	`GSIds
(
$tyid
,0,
ue
).") ";

463 if(
$t
!='') {

464 
$ags
 = 
	`exode
(',',
$t
);

465 
$i
=0;
	`ist
(
$ags
[$i]);$i++
$whe
 .= " AND FIND_IN_SET('{$flags[$i]}',flag)>0 ";

468 if(
$chlid
>0 && !
	`egi
("ec",
$lity
))

470 
$whe
 .= " Andrc.channel = '$channelid' ";

474 if(
	`egi
("commd",
$lity
))

476 
$whe
 .= " And FIND_IN_SET('c',flag) > 0 ";

478 if(
	`egi
("image",
$lity
))

480 
$whe
 .= " Andrc.litpic <> '' ";

482 if(
	`egi
("ec",
$lity
|| 
$chlid
==-1)

484 
$whe
 .= " Andrc.channel = -1 ";

486 if(!
	`emy
(
$subday
))

488 
$ime
 = 
	`time
(- 
$subday
*86400;

489 
$whe
 .= " Andrc.senddate > $starttime ";

491 
$keywd
 = 
$this
->
LiObj
->
	`GA
('keyword');

492 if(!
	`emy
(
$keywd
))

494 
$whe
 .= " And CONCAT(arc.title,arc.keywords) REGEXP '$keyword' ";

496 
$dby
 = 
$this
->
LiObj
->
	`GA
('orderby');

497 
$dWay
 = 
$this
->
LiObj
->
	`GA
('orderway');

500 
$dsql
 = "";

501 if(
$dby
=="senddate")

503 
$dsql
=" order byrc.senddate $orderWay";

505 if(
$dby
=="pubdate")

507 
$dsql
=" order byrc.pubdate $orderWay";

509 if(
$dby
=="id")

511 
$dsql
=" order byrc.id $orderWay";

513 if(
$dby
=="hot"||$orderby=="click")

515 
$dsql
 = " order byrc.click $orderWay";

517 if(
$dby
=="lastpost")

519 
$dsql
 = " order byrc.lastpost $orderWay";

521 if(
$dby
=="scores")

523 
$dsql
 = " order byrc.scores $orderWay";

525 if(
$dby
=="rand")

527 
$dsql
 = " order byand()";

531 
$dsql
=" order byrc.sortrank $orderWay";

535 
$addFld
 = "";

536 
$addJo
 = "";

537 if(
	`is_obje
(
$this
->
ChlUn
))

539 
$addb
 = 
$this
->
ChlUn
->
ChlInfos
['addtable'];

540 if(
$addb
!="")

542 
$addJo
 = "e jo $addb oc.id = ".
$addb
.".aid ";

543 
$addFld
 = "";

544 
$flds
 = 
	`exode
(",",
$this
->
ChlUn
->
ChlInfos
['listfields']);

545 
	`fܗch
(
$flds
 
as
 
$k
=>
$v
)

547 
$nflds
[
$v
] = 
$k
;

549 
	`fܗch
(
$this
->
ChlUn
->
ChlFlds
 
as
 
$k
=>
$r
)

551 if(
	`ist
(
$nflds
[
$k
]))

553 if(!
	`emy
(
$r
['rename']))

555 
$addFld
 .",".
$addb
.".".
$k
."".
$r
['rename'];

559 
$addFld
 .",".
$addb
.".".
$k
;

566 
$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,

567 

.
mu
,.
mu2
,.
it
,.
mese
,.
seu
,.
sh


568 
$addFld


569 
om
 {
$this
->
mab
} 
c


570 

 
jo
 #@
__y
 

 

 
c
.
tyid
p.
id


571 
$addJo


572 
whe
 
$whe
 
$dsql
 
lim
 
$limt
,".$this->PageSize;

573 
$this
->
dsql
->
	`SQuy
(
$quy
);

574 
$this
->
dsql
->
	`Execu
("al");

575 
$i
 = "";

576 if(
$c
>1)

578 
$i
 = "<table width='$tablewidth' border='0' cellspacing='0' cellpadding='0'>\r\n";

580 
$d
 = 
w
 
	`DedeTagP
();

581 
$d
->
	`SNameS
("field","[","]");

582 
$d
->
	`LdSour
(
$ùext
);

583 
$GLOBALS
['autoindex'] = 0;

584 
$i
=0;$i<
$this
->
PageSize
;$i++)

586 if(
$c
>1)

588 
$i
 .= "<tr>\r\n";

590 
$j
=0;$j<
$c
;$j++)

592 if(
$c
>1)

594 
$i
 .= "<td width='$colWidth'>\r\n";

596 if(
$row
 = 
$this
->
dsql
->
	`GAay
("al"))

598 
$GLOBALS
['autoindex']++;

601 
$row
['id'] = $row['id'];

602 
$row
['cu'] = 
$this
->
	`GArcU
($row['id'],$row['typeid'],$row['senddate'],

603 
$row
['title'],$row['ismake'],$row['arcrank'],$row['namerule'],$row['typedir'],$row['money'],

604 
$row
['filename'],$row['moresite'],$row['siteurl'],$row['sitepath']);

605 
$row
['tyu'] = 
	`GTyU
($row['typeid'],$row['typedir'],$row['isdefault'],$row['defaultname'],

606 
$row
['ispart'],$row['namerule2'],$row['siteurl'],$row['sitepath']);

607 if(
$ismake
==0 && 
$GLOBALS
['cfg_multi_site']=='Y')

609 if(
$row
["siteurl"]=="")

611 
$row
["seu"] = 
$GLOBALS
['cfg_mainsite'];

615 
$row
['desti'] = 
	`_subr
($row['desti'],
$fޒ
);

617 if(
$row
['litpic'] == '-' || $row['litpic'] == '')

619 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

621 if(!
	`egi
("^hp://",
$row
['lpic']&& 
$GLOBALS
['cfg_multi_site'] == 'Y')

623 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

625 
$row
['picname'] = $row['litpic'];

626 
$row
['info'] = $row['description'];

627 
$row
['filename'] = $row['arcurl'];

628 
$row
['ime'] = 
	`GDeMK
($row['pubdate']);

629 
$row
['xk'] = "<hf='".$row['fame']."'='".
	`r_a
("'","",$row['title'])."'>".$row['title']."</a>";

630 
$row
['typelink'] = "<a href='".$row['typeurl']."'>[".$row['typename']."]</a>";

631 
$row
['imglk'] = "<hf='".$row['fame']."'><img src='".$row['piame']."' bd='0' width='$imgwidth' height='$imgheight'='".
	`r_a
("'","",$row['title'])."'></a>";

632 
$row
['image'] = "<img src='".$row['piame']."' bd='0' width='$imgwidth' height='$imgheight'='".
	`r_a
("'","",$row['title'])."'>";

633 
$row
['usu'] = $row['phpu'] = 
$GLOBALS
['cfg_phpurl'];

634 
$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

635 
$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

636 
$row
['t'] = 
	`_subr
($row['t'],
$tn
);

637 if(
$row
['color']!="")

639 
$row
['title'] = "<font color='".$row['color']."'>".$row['title']."</font>";

641 if(
	`eg
('c',
$row
['flag']))

643 
$row
['title'] = "<b>".$row['title']."</b>";

647 if(
	`is_obje
(
$this
->
ChlUn
))

649 
	`fܗch
(
$row
 
as
 
$k
=>
$v
)

651 if(
	`eg
("[A-Z]",
$k
))

653 
$row
[
	`ow
(
$k
)] = 
$v
;

656 
	`fܗch
(
$this
->
ChlUn
->
ChlFlds
 
as
 
$k
=>
$r
)

658 if(
	`ist
(
$row
[
$k
]))

660 
$row
[
$k
] = 
$this
->
ChlUn
->
	`MakeFld
($k,$row[$k]);

666 if(
	`is_y
(
$d
->
CTags
))

668 
	`fܗch
(
$d
->
CTags
 
as
 
$k
=>
$ag
)

670 
$_f
 = 
$ag
->
	`GName
();

671 if(
$_f
=='array')

674 
$d
->
	`Assign
(
$k
,
$row
);

678 if(
	`ist
(
$row
[
$_f
]))

680 
$d
->
	`Assign
(
$k
,
$row
[
$_f
]);

684 
$d
->
	`Assign
(
$k
,"");

689 
$i
 .
$d
->
	`GResu
();

694 
$i
 .= "";

696 if(
$c
>1)

698 
$i
 .= " </td>\r\n";

702 if(
$c
>1){

703 
$i
 +
$c
 - 1;

705 if(
$c
>1)

707 
$i
 .= " </tr>\r\n";

711 if(
$c
>1)

713 
$i
 .= "</table>\r\n";

715 
$this
->
dsql
->
	`FeResu
("al");

716  
$i
;

717 
	}
}

720 
funi
 
GPageLiST
(
$li_n
,
$liem
="info,index,end,pre,next,pageno")

722 
$age
="";

723 
	g$xage
="";

724 
	g$agum
 = 
$this
->
PageNo
-1;

725 
	g$xagum
 = 
$this
->
PageNo
+1;

726 if(
	g$li_n
==""||
eg
("[^0-9]",
$li_n
))

728 
	g$li_n
=3;

730 
	g$tٮge
 = 

(
$this
->
TٮResu
/$this->
PageSize
);

731 if(
	g$tٮge
<=1 && 
$this
->
TٮResu
>0)

733  "共1页/".
$this
->
TٮResu
."条记录";

735 if(
	g$this
->
	gTٮResu
 == 0)

737  "共0页/".
$this
->
TٮResu
."条记录";

739 
	g$mafo
 = " 共{$tٮge}页/".
$this
->
TٮResu
."条记录 ";

740 
	g$pu
 = 
$this
->
GCurU
();

741 
	g$amu
 = 
$this
->
GMakeFeRu
();

742 
	g$amu
 = 
eg_a
('^(.*)/','',
$amu
);

745 if(
	g$this
->
	gPageNo
 != 1)

747 
$age
.="<hf='".
r_a
("{ge}",
$agum
,
$amu
)."'>上一页</a>\r\n";

748 
	g$dexge
="<hf='".
r_a
("{ge}",1,
$amu
)."'>首页</a>\r\n";

752 
	g$dexge
="<a href='#'>首页</a>\r\n";

756 if(
	g$this
->
	gPageNo
!=
$tٮge
 && $totalpage>1)

758 
$xage
.="<hf='".
r_a
("{ge}",
$xagum
,
$amu
)."'>下一页</a>\r\n";

759 
	g$dge
="<hf='".
r_a
("{ge}",
$tٮge
,
$amu
)."'>末页</a>\r\n";

763 
	g$dge
="<a href='#'>末页</a>\r\n";

767 
	g$tin
 = 

(
$tٮge
);

768 
	g$tin
 = 
$tin
*12 + 18;

769 if(
	g$tin
 < 36) $optionlen = 36;

770 if(
	g$tin
 > 100) $optionlen = 100;

771 
	g$tili
 = "<selectame='sldd' style='width:$optionlen' onchange='location.href=this.options[this.selectedIndex].value;'>\r\n";

772 
	g$mjj
=1;$mjj<=
$tٮge
;$mjj++)

774 if(
	g$mjj
==
$this
->
PageNo
)

776 
$tili
 ."<ti vue='".
r_a
("{ge}",
$mjj
,
$amu
)."' selected>$mjj</option>\r\n";

780 
	g$tili
 ."<ti vue='".
r_a
("{ge}",
$mjj
,
$amu
)."'>$mjj</option>\r\n";

783 
	g$tili
 .= "</select>";

786 
	g$lidd
="";

787 
	g$tٮ_li
 = 
$li_n
 * 2 + 1;

788 if(
	g$this
->
	gPageNo
 >
$tٮ_li
)

790 
$j
 = 
$this
->
PageNo
-
$li_n
;

791 
	g$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

792 if(
	g$tٮ_li
>
	g$tٮge
)

794 
	g$tٮ_li
=
$tٮge
;

799 
	g$j
=1;

800 if(
	g$tٮ_li
>
	g$tٮge
)

802 
	g$tٮ_li
=
$tٮge
;

805 
	g$j
;$j<=
$tٮ_li
;$j++)

807 if(
	g$j
==
$this
->
PageNo
)

809 
$lidd
.= "<strong>{$j}</strong>\r\n";

813 
	g$lidd
.="<hf='".
r_a
("{ge}",
$j
,
$amu
)."'>".
	g$j
."</a>\r\n";

816 
	g$i
 = "";

817 if(
egi
('fo',
$liem
))

819 
	g$i
 .
$mafo
.' ';

821 if(
egi
('dex',
$liem
))

823 
	g$i
 .
$dexge
.' ';

825 if(
egi
('e',
$liem
))

827 
	g$i
 .
$age
.' ';

829 if(
egi
('go',
$liem
))

831 
	g$i
 .
$lidd
.' ';

833 if(
egi
('xt',
$liem
))

835 
	g$i
 .
$xage
.' ';

837 if(
egi
('d',
$liem
))

839 
	g$i
 .
$dge
.' ';

841 if(
egi
('ti',
$liem
))

843 
	g$i
 .
$tili
;

845  
	g$i
;

849 
funi
 
GPageLiDM
(
$li_n
,
$liem
="index,end,pre,next,pageno")

851 
$age
="";

852 
	g$xage
="";

853 
	g$agum
 = 
$this
->
PageNo
-1;

854 
	g$xagum
 = 
$this
->
PageNo
+1;

855 if(
	g$li_n
==""||
eg
("[^0-9]",
$li_n
))

857 
	g$li_n
=3;

859 
	g$tٮge
 = 

(
$this
->
TٮResu
/$this->
PageSize
);

860 if(
	g$tٮge
<=1 && 
$this
->
TٮResu
>0)

862  "共1页/".
$this
->
TٮResu
."条记录";

864 if(
	g$this
->
	gTٮResu
 == 0)

866  "共0页/".
$this
->
TٮResu
."条记录";

868 
	g$mafo
 = "共{$tٮge}页/".
$this
->
TٮResu
."条记录";

869 
	g$pu
 = 
$this
->
GCurU
();

870 
	g$gu
 = "lid=".
$this
->
FeID
."&TٮResu=".$this->
TٮResu
."&";

871 
	g$hidfm
 = "<puty='hidd'ame='lid' vue='".
$this
->
FeID
."' />\r\n";

872 
	g$hidfm
 ."<puty='hidd'ame='TٮResu' vue='".
$this
->
TٮResu
."' />\r\n";

873 
	g$pu
 ."?".
$gu
;

876 if(
	g$this
->
	gPageNo
 != 1)

878 
$age
.="<hf='".
$pu
."PageNo=$prepagenum'>上一页</a>\r\n";

879 
	g$dexge
="<hf='".
$pu
."PageNo=1'>首页</a>\r\n";

883 
	g$dexge
="<a href='#'>首页</a>\r\n";

885 if(
	g$this
->
	gPageNo
!=
$tٮge
 && $totalpage>1)

887 
$xage
.="<hf='".
$pu
."PageNo=$nextpagenum'>下一页</a>\r\n";

888 
	g$dge
="<hf='".
$pu
."PageNo=$totalpage'>末页</a>\r\n";

892 
	g$dge
="<a href='#'>末页</a>\r\n";

896 
	g$lidd
="";

897 
	g$tٮ_li
 = 
$li_n
 * 2 + 1;

898 if(
	g$this
->
	gPageNo
 >
$tٮ_li
)

900 
$j
 = 
$this
->
PageNo
-
$li_n
;

901 
	g$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

902 if(
	g$tٮ_li
>
	g$tٮge
$tٮ_li=
$tٮge
;

906 
	g$j
=1;

907 if(
	g$tٮ_li
>
	g$tٮge
$tٮ_li=
$tٮge
;

909 
	g$j
;$j<=
$tٮ_li
;$j++)

911 if(
	g$j
==
$this
->
PageNo
)

913 
$lidd
.= "<a href='#'>.$j.</a>\r\n";

917 
	g$lidd
.="<hf='".
$pu
."PageNo=$j'>".
$j
."</a>\r\n";

920 
	g$i
 = "<fmame='gi'i='".
$this
->
GCurU
()."'>$hidenform";

921 
	g$i
 .
$mafo
.
$dexge
.
$age
.
$lidd
.
$xage
.
$dge
;

922 if(
	g$tٮge
>
	g$tٮ_li
)

924 
	g$i
.="<puty='xt'ame='PageNo' vue='".
$this
->
PageNo
."' style='width:30px' />\r\n";

925 
	g$i
.="<inputype='submit'ame='plistgo' value='GO' />\r\n";

927 
	g$i
 .= "</form>\r\n";

928  
	g$i
;

932 
funi
 
GArcU
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
=0,
$nk
=0,
$mu
='',
$td
='',

933 
$mey
=0,
$fame
='',
$mese
='',
$seu
='',
$sh
='')

935  
GFeU
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
,
$nk
,
$mu
,
$td
,

936 
$mey
,
$fame
,
$mese
,
$seu
,
$sh
);

940 
funi
 
	$GCurU
()

942 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

944 
$nowu
 = 
$_SERVER
["REQUEST_URI"];

945 
$nowus
 = 
	`exode
("?",
$nowu
);

946 
$nowu
 = 
$nowus
[0];

950 
$nowu
 = 
$_SERVER
["PHP_SELF"];

952  
$nowu
;

953 
	}
}

	@include/arc.listview.class.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
que_
(
DEDEINC
.'/arc.partview.class.php');

6 @
t_time_lim
(0);

7 as
	cLiVw


9 
v
 
	m$dsql
;

10 
v
 
	m$d
;

11 
v
 
	m$d2
;

12 
v
 
	m$TyID
;

13 
v
 
	m$TyLk
;

14 
v
 
	m$PageNo
;

15 
v
 
	m$TٮPage
;

16 
v
 
	m$TٮResu
;

17 
v
 
	m$PageSize
;

18 
v
 
	m$ChlUn
;

19 
v
 
	m$LiTy
;

20 
v
 
	m$Flds
;

21 
v
 
	m$PtVw
;

22 
v
 
	m$upPageTy
;

23 
v
 
	m$addSql
;

24 
v
 
	m$IsE
;

25 
v
 
	m$CrossID
;

26 
v
 
	m$IsR
;

28 
funi
 
	$__cڡru
(
$tyid
,
$uage
=1)

30 
glob
 
$dsql
;

31 
$this
->
TyID
 = 
$tyid
;

32 
$this
->
dsql
 = &
$dsql
;

33 
$this
->
CrossID
 = '';

34 
$this
->
IsR
 = 
l
;

35 
$this
->
IsE
 = 
l
;

36 
$this
->
d
 = 
w
 
	`DedeTagP
();

37 
$this
->
d
->
	`SRefObj
($this);

38 
$this
->
d
->
	`SNameS
("dede", "{", "}");

39 
$this
->
d2
 = 
w
 
	`DedeTagP
();

40 
$this
->
d2
->
	`SNameS
("field","[","]");

41 
$this
->
TyLk
 = 
w
 
	`TyLk
(
$tyid
);

42 
$this
->
upPageTy
 = 
$uage
;

43 if(!
	`is_y
(
$this
->
TyLk
->
TyInfos
))

45 
$this
->
IsE
 = 
ue
;

47 if(!
$this
->
IsE
)

49 
$this
->
ChlUn
 = 
w
 
	`ChlUn
($this->
TyLk
->
TyInfos
['channeltype']);

50 
$this
->
Flds
 = $this->
TyLk
->
TyInfos
;

51 
$this
->
Flds
['id'] = 
$tyid
;

52 
$this
->
Flds
['posi'] = $this->
TyLk
->
	`GPosiLk
(
ue
);

53 
$this
->
Flds
['t'] = 
	`eg_a
("[<>]"," / ",$this->
TyLk
->
	`GPosiLk
(
l
));

56 
	`fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v

$this
->
Flds
[$k] = $v;

57 
$this
->
Flds
['rsk'] = 
$GLOBALS
['cfg_cmsu']."/da/rss/".$this->
TyID
.".xml";

60 
	`SSysEnv
(
$this
->
TyID
,$this->
Flds
['typename'],0,'','list');

61 
$this
->
Flds
['tyid'] = $this->
TyID
;

64 if(
$this
->
TyLk
->
TyInfos
['cross']>0 && $this->TypeLink->TypeInfos['ispart']==0)

66 
$lquy
 = '';

67 if(
$this
->
TyLk
->
TyInfos
['cross']==1)

69 
$lquy
 = "Select id,topid From `#@__arctype` whereypenameike '{$this->Fields['typename']}' And id<>'{$this->TypeID}' Andopid<>'{$this->TypeID}' ";

73 
$this
->
Flds
['ossid'] = 
	`eg_a
('[^0-9,]','',
	`im
($this->Fields['crossid']));

74 if(
$this
->
Flds
['crossid']!='')

76 
$lquy
 = "Select id,topid From `#@__arctype` where id in({$this->Fields['crossid']}) And id<>{$this->TypeID} Andopid<>{$this->TypeID} ";

79 if(
$lquy
!='')

81 
$this
->
dsql
->
	`SQuy
(
$lquy
);

82 
$this
->
dsql
->
	`Execu
();

83 
$r
 = 
$this
->
dsql
->
	`GAay
())

85 
$this
->
CrossID
 .($this->CrossID=='' ? 
$r
['id'] : ','.$arr['id']);

95 
funi
 
	$LiVw
(
$tyid
,
$uage
=0){

96 
$this
->
	`__cڡru
(
$tyid
,
$uage
);

97 
	}
}

99 
funi
 
	$Clo
()

102 
	}
}

105 
funi
 
	$CouRecd
()

107 
glob
 
$cfg_li_s
,
$cfg_ed_tyid2
;

108 if(
	`emy
(
$cfg_ed_tyid2
)) $cfg_need_typeid2 = 'N';

111 
$this
->
TٮResu
 = -1;

112 if(
	`ist
(
$GLOBALS
['TٮResu'])
$this
->
TٮResu
 = $GLOBALS['TotalResult'];

113 if(
	`ist
(
$GLOBALS
['PageNo'])
$this
->
PageNo
 = $GLOBALS['PageNo'];

114 
$this
->
PageNo
 = 1;

115 
$this
->
addSql
 = "rc.arcrank > -1 ";

117 
$tyid2like
 = " '%,{$this->TypeID},%' ";

118 if(
$cfg_li_s
=='N')

121 if(
$cfg_ed_tyid2
=='N')

123 if(
$this
->
CrossID
==''$this->
addSql
 ." And (c.tyid='".$this->
TyID
."') ";

124 
$this
->
addSql
 .= " And (arc.typeid in({$this->CrossID},{$this->TypeID})) ";

128 if(
$this
->
CrossID
==''$this->
addSql
 ." And ( (c.tyid='".$this->
TyID
."') OR CONCAT(',',rc.typeid2, ',')ike $typeid2like) ";

129 
$this
->
addSql
 .= " And (rc.typeid in({$this->CrossID},{$this->TypeID}) OR CONCAT(',',rc.typeid2, ',')ike $typeid2like) ";

134 
$sids
 = 
	`GSIds
(
$this
->
TyID
,$this->
Flds
['channeltype']);

135 if(!
	`eg_mch
("/,/", 
$sids
)) {

136 
$sidsC
 = "rc.typeid = '$sonids' ";

139 
$sidsC
 = "rc.typeid in($sonids) ";

141 if(
$cfg_ed_tyid2
=='N')

143 if(
$this
->
CrossID
==''$this->
addSql
 .= " And ( $sonidsCon ) ";

144 
$this
->
addSql
 .= " And (rc.typeid in ({$sonids},{$this->CrossID}) ) ";

148 if(
$this
->
CrossID
==''$this->
addSql
 .= " And ( $sonidsCon OR CONCAT(',',rc.typeid2, ',')ike $typeid2like ) ";

149 
$this
->
addSql
 .= " And (rc.typeid in ({$sonids},{$this->CrossID}) OR CONCAT(',',rc.typeid2, ',')ike $typeid2like ) ";

152 if(
$this
->
TٮResu
==-1)

154 
$cquy
 = "Se cou(*add From `#@__y`rwh".
$this
->
addSql
;

155 
$row
 = 
$this
->
dsql
->
	`GO
(
$cquy
);

156 if(
	`is_y
(
$row
))

158 
$this
->
TٮResu
 = 
$row
['dd'];

162 
$this
->
TٮResu
 = 0;

167 
$mpfe
 = 
$GLOBALS
['cfg_bad'].$GLOBALS['cfg_ms_d']."/".
$this
->
TyLk
->
TyInfos
['templist'];

168 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
TyID
,$tempfile);

169 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

170 if(!
	`fe_exis
(
$mpfe
))

172 
$mpfe
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir']."/".$GLOBALS['cfg_df_style']."/list_default.htm";

174 if(!
	`fe_exis
(
$mpfe
)||!
	`is_fe
($tempfile))

176 
echo
 "模板文件不存在，无法解析文档！";

177 
	`ex
();

179 
$this
->
d
->
	`LdTeme
(
$mpfe
);

180 
$ag
 = 
$this
->
d
->
	`GTag
("page");

181 if(!
	`is_obje
(
$ag
))

183 
$ag
 = 
$this
->
d
->
	`GTag
("list");

185 if(!
	`is_obje
(
$ag
))

187 
$this
->
PageSize
 = 20;

191 if(
$ag
->
	`GA
("pagesize")!="")

193 
$this
->
PageSize
 = 
$ag
->
	`GA
("pagesize");

197 
$this
->
PageSize
 = 20;

200 
$this
->
TٮPage
 = 
	`
($this->
TٮResu
/$this->
PageSize
);

201 
	}
}

204 
funi
 
	$MakeHtml
(
$age
=1,
$makagesize
=0)

206 if(
	`emy
(
$age
))

208 
$age
 = 1;

212 if(
$this
->
TyLk
->
TyInfos
['isdefault']==-1)

214 
echo
 '这个类目是动态类目！';

215  '../us/li.php?tid='.
$this
->
TyLk
->
TyInfos
['id'];

219 if(
$this
->
TyLk
->
TyInfos
['ispart']>0)

221 
$u
 = 
$this
->
	`MakePtTems
();

222  
$u
;

225 
$this
->
	`CouRecd
();

227 
$this
->
	`PTemsF
();

228 
$tٮge
 = 
	`
(
$this
->
TٮResu
/$this->
PageSize
);

229 if(
$tٮge
==0)

231 
$tٮge
 = 1;

233 
	`CeD
(
	`MfTyd
(
$this
->
Flds
['typedir']));

234 
$mu
 = '';

235 if(
$makagesize
 > 0)

237 
$dge
 = 
$age
+
$makagesize
;

241 
$dge
 = (
$tٮge
+1);

243 if
$dge
 >
$tٮge
+1 )

245 
$dge
 = 
$tٮge
+1;

247 if(
$dge
==1)

249 
$dge
 = 2;

251 
$this
->
PageNo
=
$age
; $this->PageN< 
$dge
; $this->PageNo++)

253 
$this
->
	`PDMFlds
($this->
PageNo
,1);

254 
$makeFe
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],'list',$this->Fields['typedir'],'',$this->Fields['namerule2']);

255 
$makeFe
 = 
	`r_a
("{ge}",
$this
->
PageNo
,$makeFile);

256 
$mu
 = 
$makeFe
;

257 if(!
	`eg
("^/",
$makeFe
))

259 
$makeFe
 = "/".$makeFile;

261 
$makeFe
 = 
$this
->
	`GTruePh
().$makeFile;

262 
$makeFe
 = 
	`eg_a
("/{1,}","/",$makeFile);

263 
$mu
 = 
$this
->
	`GTrueU
($murl);

264 
$this
->
d
->
	`SaveTo
(
$makeFe
);

266 if(
$age
==1)

269 if(
$this
->
TyLk
->
TyInfos
['isdefault']==1

270 && 
$this
->
TyLk
->
TyInfos
['ispart']==0)

272 
$lyru
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],"list",$this->Fields['typedir'],'',$this->Fields['namerule2']);

273 
$lyru
 = 
	`r_a
("{page}","1",$onlyrule);

274 
$li_1
 = 
$this
->
	`GTruePh
().
$lyru
;

275 
$mu
 = 
	`MfTyd
(
$this
->
Flds
['typedir']).'/'.$this->Fields['defaultname'];

276 
$dexme
 = 
$this
->
	`GTruePh
().
$mu
;

277 
	`cy
(
$li_1
,
$dexme
);

280  
$mu
;

281 
	}
}

284 
funi
 
	$Diy
()

286 if(
$this
->
TyLk
->
TyInfos
['ispart']>0)

288 
$this
->
	`DiyPtTems
();

291 
$this
->
	`CouRecd
();

292 if((
	`emy
(
$this
->
PageNo
) || $this->PageNo==1)

293 && 
$this
->
TyLk
->
TyInfos
['ispart']==1)

295 
$tmpd
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir'];

296 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
TyID
,$this->
Flds
['tempindex']);

297 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

298 
$mpfe
 = 
$tmpd
."/".$tempfile;

299 if(!
	`fe_exis
(
$mpfe
))

301 
$mpfe
 = 
$tmpd
."/".
$GLOBALS
['cfg_df_style']."/index_default.htm";

303 
$this
->
d
->
	`LdTeme
(
$mpfe
);

305 
$this
->
	`PTemsF
();

306 
$this
->
	`PDMFlds
($this->
PageNo
,0);

307 
$this
->
d
->
	`Diy
();

308 
	}
}

311 
funi
 
	$MakePtTems
()

313 
$this
->
PtVw
 = 
w
 
	`PtVw
($this->
TyID
,
l
);

314 
$this
->
PtVw
->
	`STyLk
($this->
TyLk
);

315 
$nm
 = 0;

316 
$tmpd
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir'];

317 if(
$this
->
Flds
['ispart']==1)

319 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
TyID
,$this->
Flds
['tempindex']);

320 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

321 
$mpfe
 = 
$tmpd
."/".$tempfile;

322 if(!
	`fe_exis
(
$mpfe
))

324 
$mpfe
 = 
$tmpd
."/".
$GLOBALS
['cfg_df_style']."/index_default.htm";

326 
$this
->
PtVw
->
	`STem
(
$mpfe
);

328 if(
$this
->
Flds
['ispart']==2)

331  
$this
->
Flds
['typedir'];

333 
	`CeD
(
	`MfTyd
(
$this
->
Flds
['typedir']));

334 
$makeU
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],"dex",
	`MfTyd
($this->Fields['typedir']),$this->Fields['defaultname'],$this->Fields['namerule2']);

335 
$makeU
 = 
	`eg_a
("/{1,}","/",$makeUrl);

336 
$makeFe
 = 
$this
->
	`GTruePh
().
$makeU
;

337 if(
$nm
==0)

339 
$this
->
PtVw
->
	`SaveToHtml
(
$makeFe
);

343 if(!
	`fe_exis
(
$makeFe
))

345 
$this
->
PtVw
->
	`SaveToHtml
(
$makeFe
);

348  
$this
->
	`GTrueU
(
$makeU
);

349 
	}
}

352 
funi
 
	$DiyPtTems
()

354 
$this
->
PtVw
 = 
w
 
	`PtVw
($this->
TyID
,
l
);

355 
$this
->
PtVw
->
	`STyLk
($this->
TyLk
);

356 
$nm
 = 0;

357 
$tmpd
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir'];

358 if(
$this
->
Flds
['ispart']==1)

361 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
TyID
,$this->
Flds
['tempindex']);

362 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

363 
$mpfe
 = 
$tmpd
."/".$tempfile;

364 if(!
	`fe_exis
(
$mpfe
))

366 
$mpfe
 = 
$tmpd
."/".
$GLOBALS
['cfg_df_style']."/index_default.htm";

368 
$this
->
PtVw
->
	`STem
(
$mpfe
);

370 if(
$this
->
Flds
['ispart']==2)

373 
$gou
 = 
$this
->
Flds
['typedir'];

374 
	`hd
("Location:$gotourl");

375 
	`ex
();

377 
	`CeD
(
	`MfTyd
(
$this
->
Flds
['typedir']));

378 
$makeU
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],"dex",
	`MfTyd
($this->Fields['typedir']),$this->Fields['defaultname'],$this->Fields['namerule2']);

379 
$makeFe
 = 
$this
->
	`GTruePh
().
$makeU
;

380 if(
$nm
==0)

382 
$this
->
PtVw
->
	`Diy
();

386 if(!
	`fe_exis
(
$makeFe
))

388 
$this
->
PtVw
->
	`Diy
();

392 
	`ude
(
$makeFe
);

395 
	}
}

398 
funi
 
	$GTruePh
()

400 
$uh
 = 
$GLOBALS
["cfg_basedir"];

401  
$uh
;

402 
	}
}

405 
funi
 
	$GTrueU
(
$nu
)

407 if(
$this
->
Flds
['moresite']==1)

409 if(
$this
->
Flds
['sitepath']!='')

411 
$nu
 = 
	`eg_a
("^".
$this
->
Flds
['sitepath'],'',$nurl);

413 
$nu
 = 
$this
->
Flds
['siteurl'].$nurl;

415  
$nu
;

416 
	}
}

419 
funi
 
	$PTemsF
()

421 if(
	`ist
(
$this
->
TyLk
->
TyInfos
['reid']))

423 
$GLOBALS
['vs']['id'] = 
$this
->
TyLk
->
TyInfos
['reid'];

425 
$GLOBALS
['vs']['tyid'] = 
$this
->
TyID
;

426 
$GLOBALS
['vs']['tid'] = 
	`GTid
(
$this
->
Flds
['typeid']);

427 
$GLOBALS
['envs']['cross'] = 1;

428 
	`MakeOTag
(
$this
->
d
,$this);

429 
	}
}

432 
funi
 
	$PDMFlds
(
$PageNo
,
$ismake
=1)

435 if((
$PageNo
>1 || 
	`
(
$this
->
Flds
['cڋ'])<10 ) && !$this->
IsR
)

437 
$this
->
d
->
SourSg
 = 
	`r_a
('[cmsreplace]','display:none',$this->dtp->SourceString);

438 
$this
->
IsR
 = 
ue
;

440 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$gid
=>
$ag
)

442 if(
$ag
->
	`GName
()=="list")

444 
$limt
 = (
$this
->
PageNo
-1* $this->
PageSize
;

445 
$row
 = 
$this
->
PageSize
;

446 if(
	`im
(
$ag
->
	`GIText
())=="")

448 
$IText
 = 
	`GSysTems
("list_fulllist.htm");

452 
$IText
 = 
	`im
(
$ag
->
	`GIText
());

454 
$this
->
d
->
	`Assign
(
$gid
,

455 
$this
->
	`GArcLi
(

456 
$limt
,

457 
$row
,

458 
$ag
->
	`GA
("col"),

459 
$ag
->
	`GA
("titlelen"),

460 
$ag
->
	`GA
("infolen"),

461 
$ag
->
	`GA
("imgwidth"),

462 
$ag
->
	`GA
("imgheight"),

463 
$ag
->
	`GA
("listtype"),

464 
$ag
->
	`GA
("orderby"),

465 
$IText
,

466 
$ag
->
	`GA
("tablewidth"),

467 
$ismake
,

468 
$ag
->
	`GA
("orderway")

472 if(
$ag
->
	`GName
()=="pagelist")

474 
$li_n
 = 
	`im
(
$ag
->
	`GA
("listsize"));

475 
$ag
->
	`GA
("liem")=="" ? 
$liem
="index,pre,pageno,next,end,option" : $listitem=$ctag->GetAtt("listitem");

476 if(
$li_n
=="")

478 
$li_n
 = 3;

480 if(
$ismake
==0)

482 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiDM
(
$li_n
,
$liem
));

486 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiST
(
$li_n
,
$liem
));

489 if(
$PageNo
!=1 && 
$ag
->
	`GName
()=='fld' && $ag->
	`GA
('display')!='')

491 
$this
->
d
->
	`Assign
(
$gid
,'');

494 
	}
}

497 
funi
 
	$GMakeFeRu
(
$tyid
,
$wme
,
$tyd
,
$deume
,
$mu2
)

499 
$tyd
 = 
	`MfTyd
($typedir);

500 if(
$wme
=='index')

502  
$tyd
.'/'.
$deume
;

506 
$mu2
 = 
	`r_a
('{tid}',
$tyid
,$namerule2);

507 
$mu2
 = 
	`r_a
('{tyd}',
$tyd
,$namerule2);

508  
$mu2
;

510 
	}
}

513 
funi
 
GArcLi
(
$limt
=0,
$row
=10,
$c
=1,
$tn
=30,
$fޒ
=250,

514 
$imgwidth
=120,
$imgheight
=90,
$lity
="l",
$dby
="deu",
$ùext
="",
$bwidth
="100",
$ismake
=1,
$dWay
='desc')

516 
glob
 
$cfg_li_s
;

518 
	g$tyid
=
$this
->
TyID
;

520 if(
	g$row
==''
$row
 = 10;

521 if(
	g$limt
==''
$limt
 = 0;

522 if(
	g$tn
==''
$tn
 = 100;

523 if(
	g$fޒ
==''
$fޒ
 = 250;

524 if(
	g$imgwidth
==''
$imgwidth
 = 120;

525 if(
	g$imgheight
==''
$imgheight
 = 120;

526 if(
	g$lity
==''
$lity
 = 'all';

527 if(
	g$dWay
==''
$dWay
 = 'desc';

529 if(
	g$dby
=='') {

530 
$dby
='default';

533 
	g$dby
=
ow
(
$dby
);

536 
	g$bwidth
 = 
r_a
('%','',
$bwidth
);

537 if(
	g$bwidth
==''
$bwidth
=100;

538 if(
	g$c
==''
$c
=1;

539 
	g$cWidth
 = 

(100/
$c
);

540 
	g$bwidth
 = 
$bwidth
.'%';

541 
	g$cWidth
 = 
$cWidth
.'%';

543 
	g$ùext
 = 
im
(
$ùext
);

544 if(
	g$ùext
=='') {

545 
$ùext
 = 
GSysTems
('list_fulllist.htm');

549 
	g$dsql
 = '';

550 if(
	g$dby
=="ndde" || 
$dby
=="id") {

551 
$dsql
=" order byrc.id $orderWay";

553 if(
	g$dby
=="h" || 
$dby
=="click") {

554 
$dsql
 = " order byrc.click $orderWay";

556 if(
	g$dby
=="lastpost") {

557 
$dsql
 = " order byrc.lastpost $orderWay";

560 
	g$dsql
=" order byrc.sortrank $orderWay";

564 
	g$addb
 = 
$this
->
ChlUn
->
ChlInfos
['addtable'];

565 if(
	g$addb
!="")

567 
$addJo
 = "e jo `$addb` oc.id = ".
$addb
.'.aid ';

568 
	g$addFld
 = '';

569 
	g$flds
 = 
exode
(',',
$this
->
ChlUn
->
ChlInfos
['listfields']);

570 
fܗch
(
$flds
 
as
 
$k
=>
$v
)

572 
$nflds
[
$v
] = 
$k
;

574 if(
is_y
(
$this
->
ChlUn
->
ChlFlds
&& !
emy
($this->ChannelUnit->ChannelFields))

576 
fܗch
(
$this
->
ChlUn
->
ChlFlds
 
as
 
$k
=>
$r
)

578 if(
ist
(
$nflds
[
$k
]))

580 if(!
emy
(
$r
['rename'])) {

581 
$addFld
 .','.
$addb
.'.'.
$k
.''.
$r
['rename'];

584 
	g$addFld
 .','.
$addb
.'.'.
$k
;

592 
	g$addFld
 = '';

593 
	g$addJo
 = '';

597 if(
eg
('h|ick|ϡpo',
$dby
))

599 
	g$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,

600 

.
mu
,
	g
.
	gmu2
,.
	git
,.
	gmese
,.
	gseu
,.
sh


601 
$addFld


602 
	gom
 `#@
	g__chives
` 
c


603 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


604 
$addJo


605 
whe
 {
$this
->
addSql
} 
$dsql
 
lim
 
$limt
,
	g$row
";

610 
	g$t1
 = 
ExecTime
();

611 
	g$ids
 = 
y
();

612 
	g$quy
 = "Select id From `#@__arctiny`rc where {$this->addSql} $ordersqlimit $limitstart,$row ";

613 
	g$this
->
	gdsql
->
SQuy
(
$quy
);

614 
	g$this
->
	gdsql
->
Execu
();

615 
	g$r
=
$this
->
dsql
->
GAay
())

617 
$ids
[] = 
$r
['id'];

619 
	g$idr
 = 
jo
(',',
$ids
);

620 if(
	g$idr
=='')

626 
	g$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.corank,tp.isdefault,tp.defaultname,

627 

.
mu
,
	g
.
	gmu2
,.
	git
,.
	gmese
,.
	gseu
,.
sh


628 
$addFld


629 
	gom
 `#@
	g__chives
` 
c
 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


630 
$addJo


631 
whe
 
c
.
id
 

(
$idr

$dsql
 ";

633 
	g$t2
 = 
ExecTime
();

637 
	g$this
->
	gdsql
->
SQuy
(
$quy
);

638 
	g$this
->
	gdsql
->
Execu
('al');

639 
	g$t2
 = 
ExecTime
();

642 
	g$i
 = '';

643 
	g$this
->
	gd2
->
LdSour
(
$ùext
);

644 
	g$GLOBALS
['autoindex'] = 0;

645 
	g$i
=0;$i<
	g$row
;$i++)

647 if(
	g$c
>1)

649 
	g$i
 .= "<div>\r\n";

651 
	g$j
=0;$j<
	g$c
;$j++)

653 if(
	g$row
 = 
$this
->
dsql
->
GAay
("al"))

655 
$GLOBALS
['autoindex']++;

656 
	g$ids
[
$row
['id']] = $row['id'];

659 
	g$row
['fos'] = 
_subr
(
$row
['desti'],
$fޒ
);

660 
	g$row
['id'] = 
$row
['id'];

662 if(
	g$row
['corank'] > 0 && $row['arcrank']==0)

664 
$row
['arcrank'] = $row['corank'];

667 
	g$row
['fame'] = 
$row
['cu'] = 
GFeU
($row['id'],$row['typeid'],$row['senddate'],$row['title'],$row['ismake'],

668 
$row
['arcrank'],$row['namerule'],$row['typedir'],$row['money'],$row['filename'],$row['moresite'],$row['siteurl'],$row['sitepath']);

669 
	g$row
['tyu'] = 
GTyU
(
$row
['tyid'],
MfTyd
($row['typedir']),$row['isdefault'],$row['defaultname'],

670 
$row
['ispart'],$row['namerule2'],$row['moresite'],$row['siteurl'],$row['sitepath']);

671 if(
	g$row
['lpic'] ='-' || 
$row
['litpic'] == '')

673 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

675 if(!
egi
("^hp://",
$row
['lpic']&& 
	g$GLOBALS
['cfg_multi_site'] == 'Y')

677 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

679 
	g$row
['piame'] = 
$row
['litpic'];

680 
	g$row
['ime'] = 
GDeMK
(
$row
['pubdate']);

681 
	g$row
['tylk'] = "<hf='".
$row
['typeurl']."'>".$row['typename']."</a>";

682 
	g$row
['image'] = "<img src='".
$row
['piame']."' bd='0' width='$imgwidth' height='$imgheight'='".
eg_a
("['><]","",$row['title'])."'>";

683 
	g$row
['imglk'] = "<hf='".
$row
['filename']."'>".$row['image']."</a>";

684 
	g$row
['fut'] = 
$row
['title'];

685 
	g$row
['t'] = 
_subr
(
$row
['t'],
$tn
);

686 if(
	g$row
['color']!='')

688 
$row
['title'] = "<font color='".$row['color']."'>".$row['title']."</font>";

690 if(
eg
('c',
$row
['flag']))

692 
	g$row
['t'] = "<b>".
$row
['title']."</b>";

694 
	g$row
['xk'] = "<hf='".
$row
['filename']."'>".$row['title']."</a>";

695 
	g$row
['usu'] = 
$row
['phpu'] = 
$GLOBALS
['cfg_phpurl'];

696 
	g$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

697 
	g$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

700 
fܗch
(
$row
 
as
 
$k
=>
$v
)

702 
$row
[
ow
(
$k
)] = 
$v
;

704 
fܗch
(
$this
->
ChlUn
->
ChlFlds
 
as
 
$k
=>
$r
)

706 if(
ist
(
$row
[
$k
]))

708 
$row
[
$k
] = 
$this
->
ChlUn
->
MakeFld
($k,$row[$k]);

711 if(
is_y
(
$this
->
d2
->
CTags
))

713 
fܗch
(
$this
->
d2
->
CTags
 
as
 
$k
=>
$ag
)

715 if(
$ag
->
GName
()=='array')

718 
$this
->
d2
->
Assign
(
$k
,
$row
);

722 if(
ist
(
$row
[
$ag
->
GName
()]))

724 
	g$this
->
	gd2
->
Assign
(
$k
,
$row
[
$ag
->
GName
()]);

728 
	g$this
->
	gd2
->
Assign
(
$k
,'');

733 
	g$i
 .
$this
->
d2
->
GResu
();

738 if(
	g$c
>1)

740 
	g$i
 +
$c
 - 1;

741 
	g$i
 .= " </div>\r\n";

745 
	g$t3
 = 
ExecTime
();

748 
	g$this
->
	gdsql
->
FeResu
('al');

749  
	g$i
;

753 
funi
 
GPageLiST
(
$li_n
,
$liem
="index,end,pre,next,pageno")

755 
$age
 = 
$xage
 = '';

756 
	g$agum
 = 
$this
->
PageNo
-1;

757 
	g$xagum
 = 
$this
->
PageNo
+1;

758 if(
	g$li_n
=='' || 
eg
("[^0-9]",
$li_n
))

760 
	g$li_n
=3;

762 
	g$tٮge
 = 

(
$this
->
TٮResu
/$this->
PageSize
);

763 if(
	g$tٮge
<=1 && 
$this
->
TٮResu
>0)

766  "<li>< css=\"gefo\">共 <rg>1</rg>页<rg>".
$this
->
TٮResu
."</strong>条记录</span></li>\r\n";

768 if(
	g$this
->
	gTٮResu
 == 0)

770  "<li>< css=\"gefo\">共 <rg>0</rg>页<rg>".
$this
->
TٮResu
."</strong>条记录</span></li>\r\n";

772 
	g$pu
 = 
$this
->
GCurU
();

773 
	g$mafo
 = "<li>< css=\"gefo\">共 <rg>{$tٮge}</rg>页<rg>".
$this
->
TٮResu
."</strong>条</span></li>\r\n";

774 
	g$amu
 = 
$this
->
GMakeFeRu
($this->
Flds
['id'],"list",$this->Fields['typedir'],$this->Fields['defaultname'],$this->Fields['namerule2']);

775 
	g$amu
 = 
eg_a
('^(.*)/','',
$amu
);

778 if(
	g$this
->
	gPageNo
 != 1)

780 
$age
.="<li><hf='".
r_a
("{ge}",
$agum
,
$amu
)."'>上一页</a></li>\r\n";

781 
	g$dexge
="<li><hf='".
r_a
("{ge}",1,
$amu
)."'>首页</a></li>\r\n";

785 
	g$dexge
="<li>首页</li>\r\n";

789 if(
	g$this
->
	gPageNo
!=
$tٮge
 && $totalpage>1)

791 
$xage
.="<li><hf='".
r_a
("{ge}",
$xagum
,
$amu
)."'>下一页</a></li>\r\n";

792 
	g$dge
="<li><hf='".
r_a
("{ge}",
$tٮge
,
$amu
)."'>末页</a></li>\r\n";

796 
	g$dge
="<li>末页</li>\r\n";

800 
	g$tili
 = '';

802 
	g$tin
 = 

(
$tٮge
);

803 
	g$tin
 = 
$tin
*12 + 18;

804 if(
	g$tin
 < 36) $optionlen = 36;

805 if(
	g$tin
 > 100) $optionlen = 100;

806 
	g$tili
 = "<li><selectame='sldd' style='width:{$optionlen}px' onchange='location.href=this.options[this.selectedIndex].value;'>\r\n";

807 
	g$mjj
=1;$mjj<=
$tٮge
;$mjj++)

809 if(
	g$mjj
==
$this
->
PageNo
)

811 
$tili
 ."<ti vue='".
r_a
("{ge}",
$mjj
,
$amu
)."' selected>$mjj</option>\r\n";

815 
	g$tili
 ."<ti vue='".
r_a
("{ge}",
$mjj
,
$amu
)."'>$mjj</option>\r\n";

818 
	g$tili
 .= "</select></li>\r\n";

821 
	g$lidd
="";

822 
	g$tٮ_li
 = 
$li_n
 * 2 + 1;

823 if(
	g$this
->
	gPageNo
 >
$tٮ_li
)

825 
$j
 = 
$this
->
PageNo
-
$li_n
;

826 
	g$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

827 if(
	g$tٮ_li
>
	g$tٮge
)

829 
	g$tٮ_li
=
$tٮge
;

834 
	g$j
=1;

835 if(
	g$tٮ_li
>
	g$tٮge
)

837 
	g$tٮ_li
=
$tٮge
;

840 
	g$j
;$j<=
$tٮ_li
;$j++)

842 if(
	g$j
==
$this
->
PageNo
)

844 
$lidd
.= "<li class=\"thisclass\">$j</li>\r\n";

848 
	g$lidd
.="<li><hf='".
r_a
("{ge}",
$j
,
$amu
)."'>".
	g$j
."</a></li>\r\n";

851 
	g$i
 = '';

852 if(
egi
('dex',
$liem
)
	g$i
 .
$dexge
;

853 if(
egi
('e',
$liem
)
	g$i
 .
$age
;

854 if(
egi
('go',
$liem
)
	g$i
 .
$lidd
;

855 if(
egi
('xt',
$liem
)
	g$i
 .
$xage
;

856 if(
egi
('d',
$liem
)
	g$i
 .
$dge
;

857 if(
egi
('ti',
$liem
)
	g$i
 .
$tili
;

858 if(
egi
('fo',
$liem
)
	g$i
 .
$mafo
;

860  
	g$i
;

864 
funi
 
GPageLiDM
(
$li_n
,
$liem
="index,end,pre,next,pageno")

866 
glob
 
$cfg_wre
;

867 
	g$age
 = 
$xage
 = '';

868 
	g$agum
 = 
$this
->
PageNo
-1;

869 
	g$xagum
 = 
$this
->
PageNo
+1;

870 if(
	g$li_n
=='' || 
eg
("[^0-9]",
$li_n
))

872 
	g$li_n
=3;

874 
	g$tٮge
 = 

(
$this
->
TٮResu
/$this->
PageSize
);

875 if(
	g$tٮge
<=1 && 
$this
->
TٮResu
>0)

877  "<li>< css=\"gefo\">共 1 页/".
$this
->
TٮResu
." 条记录</span></li>\r\n";

879 if(
	g$this
->
	gTٮResu
 == 0)

881  "<li>< css=\"gefo\">共 0 页/".
$this
->
TٮResu
." 条记录</span></li>\r\n";

883 
	g$mafo
 = "<li>< css=\"gefo\">共 <rg>{$tٮge}</rg>页<rg>".
$this
->
TٮResu
."</strong>条</span></li>\r\n";

885 
	g$pu
 = 
$this
->
GCurU
();

886 if(
	g$cfg_wre
 == 'Y')

888 
$nowus
 = 
eg_a
("\-", ".php?", 
$pu
);

889 
	g$nowus
 = 
exode
("?", 
$nowus
);

890 
	g$pu
 = 
$nowus
[0];

893 
	g$gu
 = "tid=".
$this
->
TyID
."&TٮResu=".$this->
TٮResu
."&";

894 
	g$pu
 .'?'.
$gu
;

896 
	g$tili
 = '';

901 if(
	g$this
->
	gPageNo
 != 1)

903 
$age
.="<li><hf='".
$pu
."PageNo=$prepagenum'>上一页</a></li>\r\n";

904 
	g$dexge
="<li><hf='".
$pu
."PageNo=1'>首页</a></li>\r\n";

908 
	g$dexge
="<li><a>首页</a></li>\r\n";

910 if(
	g$this
->
	gPageNo
!=
$tٮge
 && $totalpage>1)

912 
$xage
.="<li><hf='".
$pu
."PageNo=$nextpagenum'>下一页</a></li>\r\n";

913 
	g$dge
="<li><hf='".
$pu
."PageNo=$totalpage'>末页</a></li>\r\n";

917 
	g$dge
="<li><a>末页</a></li>\r\n";

922 
	g$lidd
="";

923 
	g$tٮ_li
 = 
$li_n
 * 2 + 1;

924 if(
	g$this
->
	gPageNo
 >
$tٮ_li
)

926 
$j
 = 
$this
->
PageNo
-
$li_n
;

927 
	g$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

928 if(
	g$tٮ_li
>
	g$tٮge
)

930 
	g$tٮ_li
=
$tٮge
;

935 
	g$j
=1;

936 if(
	g$tٮ_li
>
	g$tٮge
)

938 
	g$tٮ_li
=
$tٮge
;

941 
	g$j
;$j<=
$tٮ_li
;$j++)

943 if(
	g$j
==
$this
->
PageNo
)

945 
$lidd
.= "<li class=\"thisclass\"><a>$j</a></li>\r\n";

949 
	g$lidd
.="<li><hf='".
$pu
."PageNo=$j'>".
$j
."</a></li>\r\n";

953 
	g$i
 = '';

954 if(
egi
('dex',
$liem
)
	g$i
 .
$dexge
;

955 if(
egi
('e',
$liem
)
	g$i
 .
$age
;

956 if(
egi
('go',
$liem
)
	g$i
 .
$lidd
;

957 if(
egi
('xt',
$liem
)
	g$i
 .
$xage
;

958 if(
egi
('d',
$liem
)
	g$i
 .
$dge
;

959 if(
egi
('ti',
$liem
)
	g$i
 .
$tili
;

960 if(
egi
('fo',
$liem
)
	g$i
 .
$mafo
;

962 if(
	g$cfg_wre
 == 'Y')

964 
$i
 = 
r_a
('.php?tid=', '-', $plist);

965 
	g$i
 = 
r_a
('&TٮResu=', '-', 
$i
);

966 
	g$i
 = 
eg_a
("/&PageNo=(\d+)/i",'-\\1.html',
$i
);

968  
	g$i
;

972 
funi
 
	$GCurU
()

974 if(!
	`emy
(
$_SERVER
['REQUEST_URI']))

976 
$nowu
 = 
$_SERVER
['REQUEST_URI'];

977 
$nowus
 = 
	`exode
('?', 
$nowu
);

978 
$nowu
 = 
$nowus
[0];

982 
$nowu
 = 
$_SERVER
['PHP_SELF'];

984  
$nowu
;

985 
	}
}

	@include/arc.memberlistview.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/dedetemplate.class.php");

7 
	g$ng_e_ge
 = '上页';

8 
	g$ng_xt_ge
 = '下页';

9 
	g$ng_dex_ge
 = '首页';

10 
	g$ng_d_ge
 = '末页';

11 
	g$ng_cd_numb
 = '条记录';

12 
	g$ng_ge
 = '页';

13 
	g$ng_tٮ
 = '共';

16 as
	cMembLivw


18 
v
 
	m$dsql
 = '';

19 
v
 
	m$l
 = '';

20 
v
 
	m$geNO
 = 1;

21 
v
 
	m$tٮPage
 = 0;

22 
v
 
	m$tٮResu
 = 0;

23 
v
 
	m$geSize
 = 25;

24 
v
 
	m$gVues
 = 
y
();

25 
v
 
	m$sourSql
 = '';

26 
v
 
	m$isQuy
 = 
l
;

27 
v
 
	m$ndts
 = 0;

30 
funi
 
__cڡru
(
$lfe
='')

32 
$this
->
sourSql
 = '';

33 
	m$this
->
	mgeSize
 = 25;

34 
	m$this
->
	mquyTime
 = 0;

35 
	m$this
->
	mgVues
 = 
Aay
();

36 
	m$this
->
	mndts
 = 
time
();

37 
	m$this
->
	mdsql
 = 
$GLOBALS
['dsql'];

38 
	m$this
->
SV
('ParseEnv','datalist');

39 
	m$this
->
	ml
 = 
w
 
DedeTeme
();

40 if(
	m$GLOBALS
['cfg_tplcache']=='N')

42 
$this
->
l
->
isCache
 = 
l
;

44 if(
	m$lfe
!='')

46 
$this
->
l
->
LdTeme
(
$lfe
);

50 
funi
 
MembLivw
(
$lfe
='')

52 
$this
->
__cڡru
(
$lfe
);

56 
funi
 
	$SSour
(
$sql
)

58 
$this
->
sourSql
 = 
$sql
;

59 
	}
}

63 
funi
 
	$STeme
(
$lfe
)

65 
$this
->
l
->
	`LdTeme
(
$lfe
);

66 
	}
}

68 
funi
 
	$STem
(
$lfe
)

70 
$this
->
l
->
	`LdTeme
(
$lfe
);

71 
	}
}

74 
funi
 
	$PLd
()

76 
glob
 
$tٮsu
,
$go
;

77 if(
	`emy
(
$go
|| 
	`eg
("[^0-9]",$pageno))

79 
$go
 = 1;

81 if(
	`emy
(
$tٮsu
|| 
	`eg
("[^0-9]",$totalresult))

83 
$tٮsu
 = 0;

85 
$this
->
geNO
 = 
$go
;

86 
$this
->
tٮResu
 = 
$tٮsu
;

88 if(
	`ist
(
$this
->
l
->
Cfgs
['pagesize']))

90 
$this
->
geSize
 = $this->
l
->
Cfgs
['pagesize'];

92 
$this
->
tٮPage
 = 
	`
($this->
tٮResu
/$this->
geSize
);

93 if(
$this
->
tٮResu
==0)

98 
$couQuy
 = 
	`egi_a
("[ \r\n\t](.*)[ \r\n\t]om","Se cou(*add From",
$this
->
sourSql
);

99 
$row
 = 
$this
->
dsql
->
	`GO
(
$couQuy
);

100 
$this
->
tٮResu
 = 
$row
['dd'];

101 
$this
->
sourSql
 ."im 0,".$this->
geSize
;

105 
$this
->
sourSql
 ."im ".(($this->
geNO
-1* $this->
geSize
).",".$this->pageSize;

107 
	}
}

110 
funi
 
	$SPam
(
$key
,
$vue
)

112 
$this
->
gVues
[
$key
] = 
$vue
;

113 
	}
}

116 
funi
 
	$SV
(
$k
,
$v
)

118 
glob
 
$_vs
;

119 if(!
	`ist
(
$_vs
[
$k
])$_vs[$k] = 
$v
;

120 
	}
}

122 
funi
 
	$GV
(
$k
)

124 
glob
 
$_vs
;

125 if(
	`ist
(
$_vs
[
$k
]))  $_vars[$k];

127 
	}
}

130 
funi
 
GArcLi
(
$ts
,
$fObj
='',
$flds
=
	$y
())

132 
$i
 = "titlelen=30,infolen=200,imgwidth=120,imgheight=90";

133 
	`FlAs
(
$ts
,
$i
);

134 
	`FlFlds
(
$ts
,
$flds
,
$fObj
);

135 
	`exa
(
$ts
, 
EXTR_OVERWRITE
);

136 
$rsAay
 = 
	`y
();

140 if(!
$this
->
isQuy
)

142 
$this
->
dsql
->
	`Execu
('mbdl',$this->
sourSql
);

144 
$i
 = 0;

145 
$row
 = 
$this
->
dsql
->
	`GAay
('mbdl'))

147 
$i
++;

149 if(!
	`ist
(
$row
['description'])) $row['description'] = '';

150 if(!
	`ist
(
$row
['color'])) $row['color'] = '';

151 if(!
	`ist
(
$row
['pubdate'])) $row['pubdate'] = $row['senddate'];

153 
$row
['fos'] = 
	`_subr
($row['desti'],
$fޒ
);

154 
$row
['id'] = $row['id'];

155 
$row
['fame'] = $row['cu'] = 
	`GFeU
($row['id'],$row['typeid'],$row['senddate'],$row['title'],$row['ismake'],

156 
$row
['arcrank'],$row['namerule'],$row['typedir'],$row['money'],$row['filename'],$row['moresite'],$row['siteurl'],$row['sitepath']);

157 
$row
['tyu'] = 
	`GTyU
($row['typeid'],$row['typedir'],$row['isdefault'],$row['defaultname'],$row['ispart'],

158 
$row
['namerule2'],$row['moresite'],$row['siteurl'],$row['sitepath']);

159 if(
$row
['litpic'] == '-' || $row['litpic'] == '')

161 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

163 if(!
	`egi
("^hp://",
$row
['lpic']&& 
$GLOBALS
['cfg_multi_site'] == 'Y')

165 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

167 
$row
['picname'] = $row['litpic'];

168 
$row
['ime'] = 
	`GDeMK
($row['pubdate']);

169 
$row
['typelink'] = "<a href='".$row['typeurl']."'>".$row['typename']."</a>";

170 
$row
['image'] = "<img src='".$row['piame']."' bd='0' width='$imgwidth' height='$imgheight'='".
	`eg_a
("['><]","",$row['title'])."'>";

171 
$row
['imglink'] = "<a href='".$row['filename']."'>".$row['image']."</a>";

172 
$row
['fulltitle'] = $row['title'];

173 
$row
['t'] = 
	`_subr
($row['t'],
$tn
);

174 if(
$row
['color']!='')

176 
$row
['title'] = "<font color='".$row['color']."'>".$row['title']."</font>";

178 if(
	`eg
('b',
$row
['flag']))

180 
$row
['title'] = "<strong>".$row['title']."</strong>";

184 
$row
['textlink'] = "<a href='".$row['filename']."'>".$row['title']."</a>";

185 
$row
['usu'] = $row['phpu'] = 
$GLOBALS
['cfg_phpurl'];

186 
$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

187 
$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

188 
$rsAay
[
$i
] = 
$row
;

189 if(
$i
 >
$this
->
geSize
)

194 
$this
->
dsql
->
	`FeResu
();

197  
$rsAay
;

198 
	}
}

201 
funi
 
GPageLi
(
$ts
,
$fObj
='',
$flds
=
	$y
())

203 
glob
 
$ng_e_ge
,
$ng_xt_ge
,
$ng_dex_ge
,
$ng_d_ge
,
$ng_cd_numb
,
$ng_ge
,
$ng_tٮ
;

204 
$age
 = 
$xage
 = 
$gu

$hidfm
 = '';

205 
$pu
 = 
$this
->
	`GCurU
();

206 
$agum
 = 
$this
->
geNO
-1;

207 
$xagum
 = 
$this
->
geNO
+1;

208 if(!
	`ist
(
$ts
['lisize']|| 
	`eg
("[^0-9]",$atts['listsize']))

210 
$ts
['listsize'] = 5;

212 if(!
	`ist
(
$ts
['listitem']))

214 
$ts
['listitem'] = "info,index,end,pre,next,pageno";

216 
$tٮge
 = 
	`
(
$this
->
tٮResu
/$this->
geSize
);

221 if(
$tٮge
<=1 && 
$this
->
tٮResu
 > 0)

223  "{$ng_tٮ} 1 {$ng_ge}/".
$this
->
tٮResu
.
$ng_cd_numb
;

225 if(
$this
->
tٮResu
 == 0)

227  "{$ng_tٮ} 0 {$ng_ge}/".
$this
->
tٮResu
.
$ng_cd_numb
;

229 
$fos
 = "<span>{$lang_total} {$totalpage} {$lang_page}/{$this->totalResult}{$lang_record_number}</span> ";

230 if(
$this
->
tٮResu
!=0)

232 
$this
->
gVues
['tٮsu'] = $this->
tٮResu
;

234 if(
	`cou
(
$this
->
gVues
)>0)

236 
	`fܗch
(
$this
->
gVues
 
as
 
$key
=>
$vue
)

238 
$vue
 = 
	`ucode
($value);

239 
$gu
.="$key=$value"."&";

240 
$hidfm
.="<inputype='hidden'ame='$key' value='$value'>\r\n";

243 
$pu
 ."?".
$gu
;

246 if(
$this
->
geNO
!=1)

248 
$age
.="<hf='".
$pu
."pageno=$prepagenum'>$lang_pre_page</a> \r\n";

249 
$dexge
="<hf='".
$pu
."pageno=1'>$lang_index_page</a> \r\n";

253 
$dexge
="$lang_index_page \r\n";

255 if(
$this
->
geNO
!=
$tٮge
&&$totalpage>1)

257 
$xage
.="<hf='".
$pu
."pageno=$nextpagenum'>$lang_next_page</a> \r\n";

258 
$dge
="<hf='".
$pu
."pageno=$totalpage'>$lang_end_page</a> \r\n";

262 
$dge
=" $lang_end_page \r\n";

266 
$lidd
="";

267 
$tٮ_li
 = 
$ts
['listsize'] * 2 + 1;

268 if(
$this
->
geNO
>=
$tٮ_li
)

270 
$j
=
$this
->
geNO
-
$ts
['listsize'];

271 
$tٮ_li
=
$this
->
geNO
+
$ts
['listsize'];

272 if(
$tٮ_li
>
$tٮge
)

274 
$tٮ_li
=
$tٮge
;

279 
$j
=1;

280 if(
$tٮ_li
>
$tٮge
) $total_list=$totalpage;

282 
$j
;$j<=
$tٮ_li
;$j++)

284 if(
$j
==
$this
->
geNO
)

286 
$lidd
.= "<strong>$j</strong> \r\n";

290 
$lidd
.="<hf='".
$pu
."go=$j'>".
$j
."</a> \r\n";

293 
$i
 = "<div class=\"pagelistbox\">\r\n";

296 if(
	`egi
("fo",
$ts
['listitem']))

298 
$i
 .
$fos
;

300 if(
	`egi
("dex",
$ts
['listitem']))

302 
$i
 .
$dexge
;

304 if(
	`egi
("e",
$ts
['listitem']))

306 
$i
 .
$age
;

308 if(
	`egi
("go",
$ts
['listitem']))

310 
$i
 .
$lidd
;

312 if(
	`egi
("xt",
$ts
['listitem']))

314 
$i
 .
$xage
;

316 if(
	`egi
("d",
$ts
['listitem']))

318 
$i
 .
$dge
;

320 if(
	`egi
("fm",
$ts
['listitem']))

322 
$i
 .=" <fmame='gi'i='".
$this
->
	`GCurU
()."'>$hidenform";

323 if(
$tٮge
>
$tٮ_li
)

325 
$i
.="<inputype='text'ame='pageno' style='padding:0px;width:30px;height:18px'>\r\n";

326 
$i
.="<inputype='submit'ame='plistgo' value='GO' style='padding:0px;width:30px;height:18px;font-size:11px'>\r\n";

328 
$i
 .= "</form>\r\n";

330 
$i
 .= "</div>\r\n";

331  
$i
;

332 
	}
}

335 
funi
 
	$GCurU
()

337 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

339 
$nowu
 = 
$_SERVER
["REQUEST_URI"];

340 
$nowus
 = 
	`exode
("?",
$nowu
);

341 
$nowu
 = 
$nowus
[0];

345 
$nowu
 = 
$_SERVER
["PHP_SELF"];

347  
$nowu
;

348 
	}
}

351 
funi
 
	$Clo
()

353 
	}
}

356 
funi
 
	$Diy
()

359 if(
$this
->
sourSql
 !''$this->
	`PLd
();

362 
$this
->
l
->
	`SObje
($this);

363 
$this
->
l
->
	`Diy
();

364 
	}
}

367 
funi
 
	$SaveTo
(
$fame
)

369 
$this
->
l
->
	`SaveTo
(
$fame
);

370 
	}
}

	@include/arc.partview.class.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

3 
que_
(
DEDEINC
.'/channelunit.class.php');

4 
que_
(
DEDEINC
.'/typelink.class.php');

6 as
	cPtVw


8 
v
 
	m$dsql
;

9 
v
 
	m$d
;

10 
v
 
	m$TyID
;

11 
v
 
	m$Flds
;

12 
v
 
	m$TyLk
;

13 
v
 
	m$pvCy
;

14 
v
 
	m$fObj
;

17 
funi
 
	$__cڡru
(
$tyid
=0,
$edtylk
=
ue
)

19 
glob
 
$_sys_globs
;

20 
$this
->
TyID
 = 
$tyid
;

21 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

22 
$this
->
d
 = 
w
 
	`DedeTagP
();

23 
$this
->
d
->
	`SNameS
("dede","{","}");

24 
$this
->
d
->
	`SRefObj
($this);

26 if(
$edtylk
)

28 
$this
->
TyLk
 = 
w
 
	`TyLk
(
$tyid
);

29 if(
	`is_y
(
$this
->
TyLk
->
TyInfos
))

31 
	`fܗch
(
$this
->
TyLk
->
TyInfos
 
as
 
$k
=>
$v
)

33 if(
	`eg
("[^0-9]",
$k
))

35 
$this
->
Flds
[
$k
] = 
$v
;

39 
$_sys_globs
['curfile'] = 'partview';

40 
$_sys_globs
['tyme'] = 
$this
->
Flds
['typename'];

43 
	`SSysEnv
(
$this
->
TyID
,$this->
Flds
['typename'],0,'','partview');

45 
	`SSysEnv
(
$this
->
TyID
,'',0,'','partview');

46 
$this
->
Flds
['tyid'] = $this->
TyID
;

49 
	`fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v
)

51 
$this
->
Flds
[
$k
] = 
$v
;

56 
funi
 
	$SRefObj
(&
$fObj
)

58 
$this
->
d
->
	`SRefObj
(
$fObj
);

59 if(
	`ist
(
$fObj
->
TyID
))

61 
$this
->
	`__cڡru
(
$fObj
->
TyID
);

63 
	}
}

66 
funi
 
	$STyLk
(&
$tylk
)

68 
$this
->
TyLk
 = 
$tylk
;

69 if(
	`is_y
(
$this
->
TyLk
->
TyInfos
))

71 
	`fܗch
(
$this
->
TyLk
->
TyInfos
 
as
 
$k
=>
$v
)

73 if(
	`eg
("[^0-9]",
$k
))

75 
$this
->
Flds
[
$k
] = 
$v
;

79 
	}
}

82 
funi
 
	$PtVw
(
$tyid
=0,
$edtylk
=
ue
)

84 
$this
->
	`__cڡru
(
$tyid
,
$edtylk
);

85 
	}
}

88 
funi
 
STem
(
$mp
,
$y
="file")

90 if(
$y
=="string")

92 
$this
->
d
->
LdSour
(
$mp
);

96 
	g$this
->
	gd
->
LdTem
(
$mp
);

98 if(
	g$this
->
	gTyID
 > 0)

100 
	g$this
->
	gFlds
['posi'] = 
$this
->
TyLk
->
GPosiLk
(
ue
);

101 
	g$this
->
	gFlds
['t'] = 
$this
->
TyLk
->
GPosiLk
(
l
);

103 
	g$this
->
PTem
();

107 
funi
 
	$Diy
()

109 
$this
->
d
->
	`Diy
();

110 
	}
}

113 
funi
 
	$GResu
()

115  
$this
->
d
->
	`GResu
();

116 
	}
}

122 
funi
 
	$SaveToHtml
(
$fame
)

124 
$this
->
d
->
	`SaveTo
(
$fame
);

125 
	}
}

130 
funi
 
	$PTem
()

132 
$GLOBALS
['vs']['tyid'] = 
$this
->
TyID
;

133 if(
$this
->
TyID
>0)

135 
$GLOBALS
['vs']['tid'] = 
	`GTid
(
$this
->
TyID
);

139 
$GLOBALS
['envs']['topid'] = 0;

141 if(
	`ist
(
$this
->
TyLk
->
TyInfos
['reid']))

143 
$GLOBALS
['vs']['id'] = 
$this
->
TyLk
->
TyInfos
['reid'];

145 if(
	`ist
(
$this
->
TyLk
->
TyInfos
['channeltype']))

147 
$GLOBALS
['vs']['chlid'] = 
$this
->
TyLk
->
TyInfos
['channeltype'];

149 
	`MakeOTag
(
$this
->
d
,$this);

150 
	}
}

181 
funi
 
GArcLi
(
$ms
='',
$tyid
=0,
$row
=10,
$c
=1,
$tn
=30,
$fޒ
=160,

182 
$imgwidth
=120,
$imgheight
=90,
$lity
="l",
$dby
="deu",
$keywd
="",
$ùext
="",

183 
$bwidth
="100",
$cid
=0,
$idli
="",
$chlid
=0,
$lim
="",
$t
=0,
$d
='desc',
$subday
=0,

184 
$autݬtid
=-1,
$ismemb
=0,
$mab
='',
$ag
='')

186 if(
emy
(
$autݬtid
))

188 
$autݬtid
 = -1;

190 if(
emy
(
$tyid
))

192 
	g$tyid
=
$this
->
TyID
;

194 if(
	g$autݬtid
!=-1)

196 
$tyid
 = 
$this
->
GAutoChlID
(
$autݬtid
,$typeid);

197 if(
	g$tyid
==0)

203 if(!
ist
(
$GLOBALS
['__SpGetArcList']))

205 
que_
(
dme
(
__FILE__
)."/inc/inc_fun_SpGetArcList.php");

207  
SpGArcLi
(
$this
->
dsql
,
$ms
,
$tyid
,
$row
,
$c
,
$tn
,
$fޒ
,
$imgwidth
,
$imgheight
,

208 
$lity
,
$dby
,
$keywd
,
$ùext
,
$bwidth
,
$cid
,
$idli
,
$chlid
,
$lim
,
$t
,

209 
$d
,
$subday
,
$ismemb
,
$mab
,
$ag
);

213 
funi
 
	$Clo
()

215 
	}
}

	@include/arc.rssview.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/dedetag.class.php");

7 
que_
(
DEDEINC
."/typelink.class.php");

8 
que_
(
DEDEINC
."/channelunit.func.php");

10 @
t_time_lim
(0);

11 as
	cRssVw


13 
v
 
	m$dsql
;

14 
v
 
	m$TyID
;

15 
v
 
	m$TyLk
;

16 
v
 
	m$TyFlds
;

17 
v
 
	m$MaxRow
;

18 
v
 
	m$d
;

20 
funi
 
	$__cڡru
(
$tyid
,
$max_row
=50)

22 
$this
->
TyID
 = 
$tyid
;

23 
$this
->
d
 = 
w
 
	`DedeTagP
();

24 
$this
->
d
->
fObj
 = $this;

25 
$mfes
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir']."/plus/rss.htm";

26 
$this
->
d
->
	`LdTeme
(
$mfes
);

27 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

28 
$this
->
TyLk
 = 
w
 
	`TyLk
(
$tyid
);

29 
$this
->
TyFlds
 = $this->
TyLk
->
TyInfos
;

30 
$this
->
MaxRow
 = 
$max_row
;

31 
$this
->
TyFlds
['t'] = $this->
TyLk
->
	`GPosiLk
(
l
);

32 
$this
->
TyFlds
['t'] = 
	`eg_a
("[<>]"," / ",$this->TypeFields['title']);

33 
$this
->
TyFlds
['tylk'] = 
$GLOBALS
['cfg_baho'].$this->
TyLk
->
	`GOTyU
($this->TypeFields);

34 
$this
->
TyFlds
['powby'] = 
$GLOBALS
['cfg_powerby'];

35 
$this
->
TyFlds
['admema'] = 
$GLOBALS
['cfg_adminemail'];

36 
	`fܗch
(
$this
->
TyFlds
 
as
 
$k
=>
$v
)

38 
$this
->
TyFlds
[
$k
] = 
	`htmleclchs
(
$v
);

40 
$this
->
	`PTem
();

44 
funi
 
	$RssVw
(
$tyid
,
$max_row
=50)

46 
$this
->
	`__cڡru
(
$tyid
,
$max_row
);

47 
	}
}

50 
funi
 
	$Clo
()

52 
	}
}

55 
funi
 
	$Diy
()

57 
$this
->
d
->
	`Diy
();

58 
	}
}

61 
funi
 
	$MakeRss
()

63 
$mu
 = 
$GLOBALS
['cfg_cmh']."/da/rss/".
$this
->
TyID
.".xml";

64 
$mfe
 = 
$GLOBALS
['cfg_bad'].
$mu
;

65 
$this
->
d
->
	`SaveTo
(
$mfe
);

66  
$mu
;

67 
	}
}

70 
funi
 
	$PTem
()

72 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$tid
 => 
$ag
)

74 if(
$ag
->
	`GName
()=="field")

76 
$this
->
d
->
	`Assign
(
$tid
,$this->
TyFlds
[
$ag
->
	`GA
('name')]);

78 if(
$ag
->
	`GName
()=="rssitem")

80 
$this
->
d
->
	`Assign
(
$tid
,

81 
$this
->
	`GArcLi
(
$ag
->
	`GIText
())

85 
	}
}

88 
funi
 
GArcLi
(
$ùext
="")

90 
$tyid
=
$this
->
TyID
;

91 
	g$ùext
 = 
im
(
$ùext
);

92 if(
	g$ùext
=="")

94 
$ùext
 = 
GSysTems
("rss.htm");

96 
	g$whe
 = "rc.arcrank > -1 ";

97 
	g$whe
 ." And (c.tyid i(".
GSIds
(
$this
->
TyID
,$this->
TyFlds
['channeltype']).") ) ";

98 
	g$dsql
=" order byrc.id desc";

99 
	g$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.isdefault,

100 

.
deume
,
	g
.
	gmu
,.
	gmu2
,.
	git
,.
	gmese
,.
	gseu
,.
sh


101 
	gom
 `#@
	g__chives
` 
c
 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


102 
whe
 
$whe
 
$dsql
 
lim
 0,".$this->MaxRow;

103 
	g$this
->
	gdsql
->
SQuy
(
$quy
);

104 
	g$this
->
	gdsql
->
Execu
('al');

105 
	g$i
 = '';

106 
	g$d2
 = 
w
 
DedeTagP
();

107 
	g$d2
->
SNameS
('field','[',']');

108 
	g$d2
->
LdSour
(
$ùext
);

109 
	g$row
 = 
$this
->
dsql
->
GAay
('al'))

112 if(
$row
['litpic'] == '-' || $row['litpic'] == '')

114 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

116 if(!
egi
("^hp://",
$row
['lpic']&& 
	g$GLOBALS
['cfg_multi_site'] == 'Y')

118 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

120 
	g$row
['piame'] = 
$row
['litpic'];

121 
	g$row
["cu"] = 
GFeU
(
$row
["id"],$row["typeid"],$row["senddate"],$row["title"],

122 
$row
["ismake"],$row["arcrank"],$row["namerule"],$row["typedir"],$row["money"],$row['filename'],$row["moresite"],$row["siteurl"],$row["sitepath"]);

123 
	g$row
["tyu"] = 
GTyU
(
$row
["typeid"],$row["typedir"],$row["isdefault"],$row["defaultname"],$row["ispart"],

124 
$row
["namerule2"],$row["moresite"],$row["siteurl"],$row["sitepath"]);

125 
	g$row
["fo"] = 
$row
["description"];

126 
	g$row
["fame"] = 
$row
["arcurl"];

127 
	g$row
["ime"] = 
GDeMK
(
$row
["pubdate"]);

128 
	g$row
["image"] = "<img src='".
$row
["picname"]."' border='0'>";

129 
	g$row
["fuu"] = 
$GLOBALS
["cfg_baho"].
$row
["arcurl"];

130 
	g$row
["phpu"] = 
$GLOBALS
["cfg_plus_dir"];

131 
	g$row
["mu"] = 
$GLOBALS
["cfg_templets_dir"];

132 if(
	g$row
["source"]=='')

134 
$row
["sour"] = 
$GLOBALS
['cfg_webname'];

136 if(
	g$row
["writer"]=='')

138 
$row
["writer"] = "秩名";

140 
fܗch
(
$row
 
as
 
$k
=>
$v
)

142 
$row
[
$k
] = 
htmleclchs
(
$v
);

144 if(
is_y
(
$d2
->
CTags
))

146 
fܗch
(
$d2
->
CTags
 
as
 
$k
=>
$ag
)

148 if(
$ag
->
GName
()=='array')

152 
$d2
->
Assign
(
$k
,
$row
);

156 if(
ist
(
$row
[
$ag
->
GName
()]))

158 
	g$d2
->
Assign
(
$k
,
$row
[
$ag
->
GName
()]);

162 
	g$d2
->
Assign
(
$k
,'');

167 
	g$i
 .
$d2
->
GResu
()."\r\n";

169 
	g$this
->
	gdsql
->
FeResu
('al');

170  
	g$i
;

	@include/arc.searchview.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/typelink.class.php");

7 
que_
(
DEDEINC
."/dedetag.class.php");

8 
que_
(
DEDEINC
."/splitword.class.php");

9 
que_
(
DEDEINC
."/taglib/hotwords.lib.php");

10 
que_
(
DEDEINC
."/taglib/channel.lib.php");

14 @
t_time_lim
(0);

17 as
	cSrchVw


19 
v
 
	m$dsql
;

20 
v
 
	m$d
;

21 
v
 
	m$d2
;

22 
v
 
	m$TyID
;

23 
v
 
	m$TyLk
;

24 
v
 
	m$PageNo
;

25 
v
 
	m$TٮPage
;

26 
v
 
	m$TٮResu
;

27 
v
 
	m$PageSize
;

28 
v
 
	m$ChlTy
;

29 
v
 
	m$TempInfos
;

30 
v
 
	m$Flds
;

31 
v
 
	m$PtVw
;

32 
v
 
	m$STime
;

33 
v
 
	m$Keywds
;

34 
v
 
	m$OrdBy
;

35 
v
 
	m$SrchTy
;

36 
v
 
	m$mid
;

37 
v
 
	m$KTy
;

38 
v
 
	m$Keywd
;

39 
v
 
	m$SrchMax
;

40 
v
 
	m$SrchMaxRc
;

41 
v
 
	m$SrchTime
;

42 
v
 
	m$AddSql
;

43 
v
 
	m$RsFlds
;

46 
funi
 
__cڡru
(
$tyid
,
$keywd
,
$dby
,
$achy
="all",

47 
$chty
='',
$ime
=0,
$ugesize
=20,
$kwty
=1,
$mid
=0)

49 
glob
 
$cfg_ch_max
,
$cfg_ch_maxrc
,
$cfg_ch_time
;

50 if(
emy
(
$ugesize
))

52 
	m$ugesize
 = 10;

54 
	m$this
->
	mTyID
 = 
$tyid
;

55 
	m$this
->
	mKeywd
 = 
$keywd
;

56 
	m$this
->
	mOrdBy
 = 
$dby
;

57 
	m$this
->
	mKTy
 = 
$kwty
;

58 
	m$this
->
	mPageSize
 = 
$ugesize
;

59 
	m$this
->
	mSTime
 = 
$ime
;

60 
	m$this
->
	mChlTy
 = 
$achy
;

61 
	m$this
->
	mSrchMax
 = 
$cfg_ch_max
;

62 
	m$this
->
	mSrchMaxRc
 = 
$cfg_ch_maxrc
;

63 
	m$this
->
	mSrchTime
 = 
$cfg_ch_time
;

64 
	m$this
->
	mmid
 = 
$mid
;

65 
	m$this
->
	mRsFlds
 = '';

66 
	m$this
->
	mSrchTy
 = 
$chty
=='' ? 'titlekeyword' : $searchtype;

67 
	m$this
->
	mdsql
 = 
$GLOBALS
['dsql'];

68 
	m$this
->
	md
 = 
w
 
DedeTagP
();

69 
	m$this
->
	md
->
SRefObj
(
$this
);

70 
	m$this
->
	md
->
SNameS
("dede","{","}");

71 
	m$this
->
	md2
 = 
w
 
DedeTagP
();

72 
	m$this
->
	md2
->
SNameS
("field","[","]");

73 
	m$this
->
	mTyLk
 = 
w
 
TyLk
(
$tyid
);

74 
	m$this
->
	mKeywds
 = 
$this
->
GKeywds
(
$keywd
);

77 
fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v
)

79 
$this
->
Flds
[
$k
] = 
$v
;

81 
	m$this
->
CouRecd
();

82 
	m$mpfe
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir']."/".$GLOBALS['cfg_df_style']."/search.htm";

83 if(!
fe_exis
(
$mpfe
)||!
is_fe
($tempfile))

85 
	mecho
 "模板文件不存在，无法解析！";

86 
ex
();

88 
	m$this
->
	md
->
LdTeme
(
$mpfe
);

89 
	m$this
->
	mTempInfos
['gs'] = 
$this
->
d
->
CTags
;

90 
	m$this
->
	mTempInfos
['sour'] = 
$this
->
d
->
SourSg
;

91 if(
	m$this
->
	mPageSize
=="")

93 
$this
->
PageSize
 = 20;

95 
	m$this
->
	mTٮPage
 = 

(
$this
->
TٮResu
/$this->
PageSize
);

96 if(
	m$this
->
	mPageNo
==1)

98 
$this
->
dsql
->
ExecuNeQuy
("Upd`#@__ch_keywds` sesu='".$this->
TٮResu
."' whkeywd='".
addashes
(
$keywd
)."'; ");

104 
funi
 
SrchVw
(
$tyid
,
$keywd
,
$dby
,
$achy
="all",

105 
$chty
="",
$ime
=0,
$ugesize
=20,
$kwty
=1,
$mid
=0)

107 
$this
->
__cڡru
(
$tyid
,
$keywd
,
$dby
,
$achy
,
$chty
,
$ime
,
$ugesize
,
$kwty
,
$mid
);

111 
funi
 
	$Clo
()

113 
	}
}

116 
funi
 
	$GKeywds
(
$keywd
)

118 
$keywd
 = 
	`_subr
($keyword,50);

119 
$row
 = 
$this
->
dsql
->
	`GO
("Se spwdFrom `#@__ch_keywds` whkeywd='".
	`addashes
(
$keywd
)."'; ");

120 if(!
	`is_y
(
$row
))

122 if(
	`
(
$keywd
)>7)

124 
$
 = 
w
 
	`SWd
();

125 
$keywds
 = 
$
->
	`GSRMM
(
$keywd
);

126 
$
->
	`Cˬ
();

127 
$keywds
 = 
	`eg_a
("[ ]{1,}"," ",
	`im
($keywords));

131 
$keywds
 = 
$keywd
;

133 
$quy
 = "INSERT INTO `#@__search_keywords`(`keyword`,`spwords`,`count`,`result`,`lasttime`)

134 
	`VALUES
 ('".addslashes($keyword)."', '".addslashes($keywords)."', '1', '0', '".time()."'); ";

135 
$this
->
dsql
->
	`ExecuNeQuy
(
$quy
);

139 
$this
->
dsql
->
	`ExecuNeQuy
("Upd`#@__ch_keywds` s cou=cou+1,ϡtime='".
	`time
()."' whkeywd='".
	`addashes
(
$keywd
)."'; ");

140 
$keywds
 = 
$row
['spwords'];

142  
$keywds
;

143 
	}
}

146 
funi
 
	$GKeywdSql
()

148 
$ks
 = 
	`exode
(' ',
$this
->
Keywds
);

149 
$kwsql
 = '';

150 
$kwsqls
 = 
	`y
();

151 
	`fܗch
(
$ks
 
as
 
$k
)

153 
$k
 = 
	`im
($k);

154 if(
	`
(
$k
)<1)

158 if(
	`d
(
$k
[0])>0x80 && 
	`
($k)<2)

162 
$k
 = 
	`addashes
($k);

163 if(
$this
->
SrchTy
=="title")

165 
$kwsqls
[] = "rc.titleike '%$k%' ";

169 
$kwsqls
[] = " CONCAT(arc.title,' ',arc.writer,' ',arc.keywords)ike '%$k%' ";

172 if(!
	`ist
(
$kwsqls
[0]))

178 if(
$this
->
KTy
==1)

180 
$kwsql
 = 
	`jo
(' OR ',
$kwsqls
);

184 
$kwsql
 = 
	`jo
(' And ',
$kwsqls
);

186  
$kwsql
;

188 
	}
}

191 
funi
 
	$GLikeWds
(
$num
=8)

193 
$ks
 = 
	`exode
(' ',
$this
->
Keywds
);

194 
$lsql
 = '';

195 
	`fܗch
(
$ks
 
as
 
$k
)

197 
$k
 = 
	`im
($k);

198 if(
	`
(
$k
)<2)

202 if(
	`d
(
$k
[0])>0x80 && 
	`
($k)<3)

206 
$k
 = 
	`addashes
($k);

207 if(
$lsql
=='')

209 
$lsql
 = $lsql." CONCAT(spwords,' ')ike '%$k %' ";

213 
$lsql
 = $lsql." Or CONCAT(spwords,' ')ike '%$k %' ";

216 if(
$lsql
=='')

222 
$likewd
 = '';

223 
$lsql
 = "(".$lsql."And N(keywdik'".
	`addashes
(
$this
->
Keywd
)."') ";

224 
$this
->
dsql
->
	`SQuy
("Select keyword,count From `#@__search_keywords` where $lsql order byasttime descimit 0,$num; ");

225 
$this
->
dsql
->
	`Execu
('l');

226 
$row
=
$this
->
dsql
->
	`GAay
('l'))

228 if(
$row
['count']>1000)

230 
$fy
=" style='font-size:11pt;color:red'";

232 if(
$row
['count']>300)

234 
$fy
=" style='font-size:10pt;color:green'";

238 
$y
 = "";

240 
$likewd
 ."　<hf='ch.php?keywd=".
	`ucode
(
$row
['keywd'])."&chtykeywd'".
$y
."><u>".$row['keyword']."</u></a> ";

242  
$likewd
;

244 
	}
}

247 
funi
 
	$GRedKeyWd
(
$fr
)

249 
$ks
 = 
	`exode
(' ',
$this
->
Keywds
);

250 
$kwsql
 = '';

251 
	`fܗch
(
$ks
 
as
 
$k
)

253 
$k
 = 
	`im
($k);

254 if(
$k
=='')

258 if(
	`d
(
$k
[0])>0x80 && 
	`
($k)<3)

262 
$fr
 = 
	`r_a
(
$k
,"<font color='red'>$k</font>",$fstr);

264  
$fr
;

265 
	}
}

268 
funi
 
	$CouRecd
()

270 
$this
->
TٮResu
 = -1;

271 if(
	`ist
(
$GLOBALS
['TotalResult']))

273 
$this
->
TٮResu
 = 
$GLOBALS
['TotalResult'];

275 if(
	`ist
(
$GLOBALS
['PageNo']))

277 
$this
->
PageNo
 = 
$GLOBALS
['PageNo'];

281 
$this
->
PageNo
 = 1;

283 
$ksql
 = 
$this
->
	`GKeywdSql
();

284 
$ksqls
 = 
	`y
();

285 if(
$this
->
STime
 > 0)

287 
$ksqls
[] = "rc.ndde>'".
$this
->
STime
."' ";

289 if(
$this
->
TyID
 > 0)

291 
$ksqls
[] = "yid i(".
	`GSIds
(
$this
->
TyID
).") ";

293 if(
$this
->
ChlTy
 > 0)

295 
$ksqls
[] = "rc.chl='".
$this
->
ChlTy
."'";

297 if(
$this
->
mid
 > 0)

299 
$ksqls
[] = "rc.mid = '".
$this
->
mid
."'";

301 
$ksqls
[] = "rc.arcrank > -1 ";

302 
$this
->
AddSql
 = (
$ksql
=='' ? 
	`jo
(' And ',
$ksqls
) : join(' And ',$ksqls)." And ($ksql)" );

303 
$cquy
 = "Se * From `#@__chives`rwh".
$this
->
AddSql
;

304 
$hascode
 = 
	`md5
(
$cquy
);

305 
$row
 = 
$this
->
dsql
->
	`GO
("Se * From `#@__cche` wh`md5hash`='".
$hascode
."' ");

306 
$uime
 = 
	`time
();

307 if(
	`is_y
(
$row
&& 
	`time
()-$row['uptime'] < 3600 * 24)

309 
$aids
 = 
	`exode
(',', 
$row
['cachedata']);

310 
$this
->
TٮResu
 = 
	`cou
(
$aids
)-1;

311 
$this
->
RsFlds
 = 
$row
['cachedata'];

315 if(
$this
->
TٮResu
==-1)

317 
$this
->
dsql
->
	`SQuy
(
$cquy
);

318 
$this
->
dsql
->
	`execu
();

319 
$aidr
 = 
	`y
();

320 
$aidr
[] = 0;

321 
$row
 = 
$this
->
dsql
->
	`gy
())

323 
$aidr
[] = 
$row
['id'];

325 
$nums
 = 
	`cou
(
$aidr
)-1;

326 
$aids
 = 
	`imode
(',', 
$aidr
);

327 
$de
 = "DFrom `#@__cche` whuime<".(
	`time
() - 3600 * 24);

328 
$this
->
dsql
->
	`SQuy
(
$de
);

329 
$this
->
dsql
->
	`execunequy
();

330 
$
 = "insert into `#@__arccache` (`md5hash`, `uptime`, `cachedata`)

331 
	`vues
('$hascode', '$uptime', '$aids')";

332 
$this
->
dsql
->
	`SQuy
(
$
);

333 
$this
->
dsql
->
	`execunequy
();

334 
$this
->
TٮResu
 = 
$nums
;

337 
	}
}

340 
funi
 
	$Diy
()

342 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$gid
=>
$ag
)

344 
$gme
 = 
$ag
->
	`GName
();

345 if(
$gme
=="list")

347 
$limt
 = (
$this
->
PageNo
-1* $this->
PageSize
;

348 
$row
 = 
$this
->
PageSize
;

349 if(
	`im
(
$ag
->
	`GIText
())=="")

351 
$IText
 = 
	`GSysTems
("list_fulllist.htm");

355 
$IText
 = 
	`im
(
$ag
->
	`GIText
());

357 
$this
->
d
->
	`Assign
(
$gid
,

358 
$this
->
	`GArcLi
(
$limt
,

359 
$row
,

360 
$ag
->
	`GA
("col"),

361 
$ag
->
	`GA
("titlelen"),

362 
$ag
->
	`GA
("infolen"),

363 
$ag
->
	`GA
("imgwidth"),

364 
$ag
->
	`GA
("imgheight"),

365 
$this
->
ChlTy
,

366 
$this
->
OrdBy
,

367 
$IText
,

368 
$ag
->
	`GA
("tablewidth"))

371 if(
$gme
=="pagelist")

373 
$li_n
 = 
	`im
(
$ag
->
	`GA
("listsize"));

374 if(
$li_n
=="")

376 
$li_n
 = 3;

378 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiDM
(
$li_n
));

380 if(
$gme
=="likewords")

382 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GLikeWds
(
$ag
->
	`GA
('num')));

384 if(
$gme
=="hotwords")

386 
$this
->
d
->
	`Assign
(
$gid
,
	`lib_hwds
(
$ag
,$this));

388 if(
$gme
=="field")

391 if(
	`ist
(
$this
->
Flds
[
$ag
->
	`GA
('name')]))

393 
$this
->
d
->
	`Assign
(
$gid
,$this->
Flds
[
$ag
->
	`GA
('name')]);

397 
$this
->
d
->
	`Assign
(
$gid
,"");

400 if(
$gme
=="channel")

403 if(
$this
->
TyID
>0)

405 
$tyid
 = 
$this
->
TyID
; 
$id
 = $this->
TyLk
->
TyInfos
['reid'];

409 
$tyid
 = 0; 
$id
=0;

411 
$GLOBALS
['vs']['tyid'] = 
$tyid
;

412 
$GLOBALS
['vs']['id'] = 
$tyid
;

413 
$this
->
d
->
	`Assign
(
$gid
,
	`lib_chl
(
$ag
,$this));

417 
glob
 
$keywd
, 
$dkeywd
;

418 if(!
	`emy
(
$dkeywd
)
$keywd
 = $oldkeyword;

419 
$this
->
d
->
	`Diy
();

420 
	}
}

423 
funi
 
GArcLi
(
$limt
=0,
$row
=10,
$c
=1,
$tn
=30,
$fޒ
=250,

424 
$imgwidth
=120,
$imgheight
=90,
$achy
="l",
$dby
="deu",
$ùext
="",
$bwidth
="100")

426 
$tyid
=
$this
->
TyID
;

427 if(
	g$row
==''
$row
 = 10;

428 if(
	g$limt
==''
$limt
 = 0;

429 if(
	g$tn
==''
$tn
 = 30;

430 if(
	g$fޒ
==''
$fޒ
 = 250;

431 if(
	g$imgwidth
==''
$imgwidth
 = 120;

432 if(
	g$imgheight
=''
$imgheight
 = 120;

433 if(
	g$achy
==''
$achy
 = '0';

434 
	g$dby
 = 
$dby
=='' ? 'deu' : 
ow
($orderby);

435 
	g$bwidth
 = 
r_a
("%","",
$bwidth
);

436 if(
	g$bwidth
==''
$bwidth
=100;

437 if(
	g$c
==''
$c
=1;

438 
	g$cWidth
 = 

(100/
$c
);

439 
	g$bwidth
 = 
$bwidth
."%";

440 
	g$cWidth
 = 
$cWidth
."%";

441 
	g$ùext
 = 
im
(
$ùext
);

442 if(
	g$ùext
=='')

444 
$ùext
 = 
GSysTems
("search_list.htm");

448 
	g$dsql
 = '';

449 if(
	g$dby
=="senddate")

451 
$dsql
=" order byrc.senddate desc";

453 if(
	g$dby
=="pubdate")

455 
$dsql
=" order byrc.pubdate desc";

457 if(
	g$dby
=="id")

459 
$dsql
=" order byrc.id desc";

463 
	g$dsql
=" order byrc.sortrank desc";

467 
	g$quy
 = "Selectrc.*,act.typedir,act.typename,act.isdefault,act.defaultname,act.namerule,

468 
a
.
mu2
,
	ga
.
	git
,a.
	gmese
,a.
	gseu
,a.
sh


469 
	gom
 `#@
	g__chives
` 
c
 

 
	gjo
 `#@
	g__y
` 
a
 

 
	gc
.
	gtyid
.
id


470 
whe
 {
$this
->
AddSql
} 
$dsql
 
lim
 
$limt
,
	g$row
";

471 
	g$this
->
	gdsql
->
SQuy
(
$quy
);

472 
	g$this
->
	gdsql
->
Execu
("al");

473 
	g$i
 = "";

474 if(
	g$c
>1)

476 
	g$i
 = "<table width='$tablewidth' border='0' cellspacing='0' cellpadding='0'>\r\n";

478 
	g$this
->
	gd2
->
LdSour
(
$ùext
);

479 
	g$i
=0;$i<
	g$row
;$i++)

481 if(
	g$c
>1)

483 
	g$i
 .= "<tr>\r\n";

485 
	g$j
=0;$j<
	g$c
;$j++)

487 if(
	g$c
>1)

489 
	g$i
 .= "<td width='$colWidth'>\r\n";

491 if(
	g$row
 = 
$this
->
dsql
->
GAay
("al"))

494 
$row
["cu"] = 
GFeU
($row["id"],$row["typeid"],$row["senddate"],$row["title"],

495 
$row
["ismake"],$row["arcrank"],$row["namerule"],$row["typedir"],$row["money"],$row['filename'],$row["moresite"],$row["siteurl"],$row["sitepath"]);

496 
	g$row
["desti"] = 
$this
->
GRedKeyWd
(
_subr
(
$row
["desti"],
$fޒ
));

497 
	g$row
["t"] = 
$this
->
GRedKeyWd
(
_subr
(
$row
["t"],
$tn
));

498 
	g$row
["id"] = 
$row
["id"];

499 if(
	g$row
['lpic'] ='-' || 
$row
['litpic'] == '')

501 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

503 if(!
egi
("^hp://",
$row
['lpic']&& 
	g$GLOBALS
['cfg_multi_site'] == 'Y')

505 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

507 
	g$row
['piame'] = 
$row
['litpic'];

508 
	g$row
["tyu"] = 
GTyU
(
$row
["typeid"],$row["typedir"],$row["isdefault"],$row["defaultname"],$row["ispart"],$row["namerule2"],$row["moresite"],$row["siteurl"],$row["sitepath"]);

509 
	g$row
["fo"] = 
$row
["description"];

510 
	g$row
["fame"] = 
$row
["arcurl"];

511 
	g$row
["ime"] = 
GDeMK
(
$row
["pubdate"]);

512 
	g$row
["xk"] = "<hf='".
$row
["filename"]."'>".$row["title"]."</a>";

513 
	g$row
["tylk"] = "[<hf='".
$row
["typeurl"]."'>".$row["typename"]."</a>]";

514 
	g$row
["imglk"] = "<hf='".
$row
["filename"]."'><img src='".$row["picname"]."' border='0' width='$imgwidth' height='$imgheight'></a>";

515 
	g$row
["image"] = "<img src='".
$row
["picname"]."' border='0' width='$imgwidth' height='$imgheight'>";

516 
	g$row
['usu'] = 
$row
['phpu'] = 
$GLOBALS
['cfg_phpurl'];

517 
	g$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

518 
	g$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

519 if(
is_y
(
$this
->
d2
->
CTags
))

521 
fܗch
(
$this
->
d2
->
CTags
 
as
 
$k
=>
$ag
)

523 if(
$ag
->
GName
()=='array')

526 
$this
->
d2
->
Assign
(
$k
,
$row
);

530 if(
ist
(
$row
[
$ag
->
GName
()]))

532 
	g$this
->
	gd2
->
Assign
(
$k
,
$row
[
$ag
->
GName
()]);

536 
	g$this
->
	gd2
->
Assign
(
$k
,'');

541 
	g$i
 .
$this
->
d2
->
GResu
();

546 
	g$i
 .= "";

548 if(
	g$c
>1
	g$i
 .= "</td>\r\n";

551 if(
	g$c
>1)

553 
	g$i
 .= "</tr>\r\n";

557 if(
	g$c
>1)

559 
	g$i
 .= "</table>\r\n";

561 
	g$this
->
	gdsql
->
FeResu
("al");

562  
	g$i
;

566 
funi
 
	$GPageLiDM
(
$li_n
)

568 
glob
 
$dkeywd
;

569 
$age
="";

570 
$xage
="";

571 
$agum
 = 
$this
->
PageNo
-1;

572 
$xagum
 = 
$this
->
PageNo
+1;

573 if(
$li_n
==""||
	`eg
("[^0-9]",$list_len))

575 
$li_n
=3;

577 
$tٮge
 = 
	`
(
$this
->
TٮResu
/$this->
PageSize
);

578 if(
$tٮge
<=1 && 
$this
->
TٮResu
>0)

580  "共1页/".
$this
->
TٮResu
."条记录";

582 if(
$this
->
TٮResu
 == 0)

584  "共0页/".
$this
->
TٮResu
."条记录";

586 
$pu
 = 
$this
->
	`GCurU
();

588 
$dkeywd
 = (
	`emy
($dkeywd? 
$this
->
Keywd
 : $oldkeyword);

591 if(
$this
->
TٮResu
 > $this->
SrchMaxRc
)

593 
$tٮge
 = 
	`
(
$this
->
SrchMaxRc
/$this->
PageSize
);

595 
$fos
 = "<td>共找到<b>".
$this
->
TٮResu
."</b>条记录/最大显示<b>{$totalpage}</b>页 </td>\r\n";

596 
$gu
 = "keywd=".
	`ucode
(
$dkeywd
)."&chty=".
$this
->
SrchTy
;

597 
$hidfm
 = "<puty='hidd'ame='keywd' vue='".
	`ucode
(
$dkeywd
)."'>\r\n";

598 
$gu
 ."&chy=".
$this
->
ChlTy
."&dby=".$this->
OrdBy
;

599 
$hidfm
 ."<puty='hidd'ame='chy' vue='".
$this
->
ChlTy
."'>\r\n";

600 
$hidfm
 ."<puty='hidd'ame='dby' vue='".
$this
->
OrdBy
."'>\r\n";

601 
$gu
 ."&kwty=".
$this
->
KTy
."&gesize=".$this->
PageSize
;

602 
$hidfm
 ."<puty='hidd'ame='kwty' vue='".
$this
->
KTy
."'>\r\n";

603 
$hidfm
 ."<puty='hidd'ame='gesize' vue='".
$this
->
PageSize
."'>\r\n";

604 
$gu
 ."&tyid=".
$this
->
TyID
."&TٮResu=".$this->
TٮResu
."&";

605 
$hidfm
 ."<puty='hidd'ame='tyid' vue='".
$this
->
TyID
."'>\r\n";

606 
$hidfm
 ."<puty='hidd'ame='TٮResu' vue='".
$this
->
TٮResu
."'>\r\n";

607 
$pu
 ."?".
$gu
;

610 if(
$this
->
PageNo
 != 1)

612 
$age
.="<td width='50'><hf='".
$pu
."PageNo=$prepagenum'>上一页</a></td>\r\n";

613 
$dexge
="<td width='30'><hf='".
$pu
."PageNo=1'>首页</a></td>\r\n";

617 
$dexge
="<td width='30'>首页</td>\r\n";

619 if(
$this
->
PageNo
!=
$tٮge
 && $totalpage>1)

621 
$xage
.="<td width='50'><hf='".
$pu
."PageNo=$nextpagenum'>下一页</a></td>\r\n";

622 
$dge
="<td width='30'><hf='".
$pu
."PageNo=$totalpage'>末页</a></td>\r\n";

626 
$dge
="<td width='30'>末页</td>\r\n";

630 
$lidd
="";

631 
$tٮ_li
 = 
$li_n
 * 2 + 1;

632 if(
$this
->
PageNo
 >
$tٮ_li
)

634 
$j
 = 
$this
->
PageNo
-
$li_n
;

635 
$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

636 if(
$tٮ_li
>
$tٮge
)

638 
$tٮ_li
=
$tٮge
;

643 
$j
=1;

644 if(
$tٮ_li
>
$tٮge
)

646 
$tٮ_li
=
$tٮge
;

649 
$j
;$j<=
$tٮ_li
;$j++)

651 if(
$j
==
$this
->
PageNo
)

653 
$lidd
.= "<td>$j&nbsp;</td>\r\n";

657 
$lidd
.="<td><hf='".
$pu
."PageNo=$j'>[".
$j
."]</a>&nbsp;</td>\r\n";

660 
$i
 = "<table border='0' cellpadding='0' cellspacing='0'>\r\n";

661 
$i
 .= "<trlign='center' style='font-size:10pt'>\r\n";

662 
$i
 ."<fmame='gi'i='".
$this
->
	`GCurU
()."'>$hidenform";

663 
$i
 .
$fos
;

664 
$i
 .
$dexge
;

665 
$i
 .
$age
;

666 
$i
 .
$lidd
;

667 
$i
 .
$xage
;

668 
$i
 .
$dge
;

669 if(
$tٮge
>
$tٮ_li
)

671 
$i
.="<td width='38'><puty='xt'ame='PageNo' sty='width:28px;height:14px' vue='".
$this
->
PageNo
."' /></td>\r\n";

672 
$i
.="<td width='30'><inputype='submit'ame='plistgo' value='GO' style='width:24px;height:22px;font-size:9pt' /></td>\r\n";

674 
$i
 .= "</form>\r\n</tr>\r\n</table>\r\n";

675  
$i
;

676 
	}
}

681 
funi
 
	$GCurU
()

683 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

685 
$nowu
 = 
$_SERVER
["REQUEST_URI"];

686 
$nowus
 = 
	`exode
("?",
$nowu
);

687 
$nowu
 = 
$nowus
[0];

691 
$nowu
 = 
$_SERVER
["PHP_SELF"];

693  
$nowu
;

694 
	}
}

	@include/arc.sglistview.class.php

1 <?
php


3 if(!
defed
('DEDEINC'))
ex
('Request Error!');

4 @
t_time_lim
(0);

5 
que_
(
DEDEINC
."/arc.partview.class.php");

7 as
	cSgLiVw


9 
v
 
	m$dsql
;

10 
v
 
	m$d
;

11 
v
 
	m$d2
;

12 
v
 
	m$TyID
;

13 
v
 
	m$TyLk
;

14 
v
 
	m$PageNo
;

15 
v
 
	m$TٮPage
;

16 
v
 
	m$TٮResu
;

17 
v
 
	m$PageSize
;

18 
v
 
	m$ChlUn
;

19 
v
 
	m$LiTy
;

20 
v
 
	m$Flds
;

21 
v
 
	m$PtVw
;

22 
v
 
	m$addSql
;

23 
v
 
	m$IsE
;

24 
v
 
	m$CrossID
;

25 
v
 
	m$IsR
;

26 
v
 
	m$AddTab
;

27 
v
 
	m$LiFlds
;

28 
v
 
	m$chA
;

29 
v
 
	m$sAddTab
;

31 
funi
 
__cڡru
(
$tyid
,
$chA
=
	$y
())

33 
glob
 
$dsql
;

34 
$this
->
TyID
 = 
$tyid
;

35 
$this
->
dsql
 = 
$dsql
;

36 
$this
->
CrossID
 = '';

37 
$this
->
IsR
 = 
l
;

38 
$this
->
IsE
 = 
l
;

39 
$this
->
d
 = 
w
 
	`DedeTagP
();

40 
$this
->
d
->
	`SRefObj
($this);

41 
$this
->
sAddTab
 = 
l
;

42 
$this
->
d
->
	`SNameS
("dede","{","}");

43 
$this
->
d2
 = 
w
 
	`DedeTagP
();

44 
$this
->
d2
->
	`SNameS
("field","[","]");

45 
$this
->
TyLk
 = 
w
 
	`TyLk
(
$tyid
);

46 
$this
->
chA
 = 
$chA
;

47 if(!
	`is_y
(
$this
->
TyLk
->
TyInfos
))

49 
$this
->
IsE
 = 
ue
;

51 if(!
$this
->
IsE
)

53 
$this
->
ChlUn
 = 
w
 
	`ChlUn
($this->
TyLk
->
TyInfos
['channeltype']);

54 
$this
->
Flds
 = $this->
TyLk
->
TyInfos
;

55 
$this
->
Flds
['id'] = 
$tyid
;

56 
$this
->
Flds
['posi'] = $this->
TyLk
->
	`GPosiLk
(
ue
);

57 
$this
->
Flds
['t'] = 
	`eg_a
("[<>]"," / ",$this->
TyLk
->
	`GPosiLk
(
l
));

60 
$this
->
AddTab
 = $this->
ChlUn
->
ChlInfos
['addtable'];

61 
$lifld
 = 
	`im
(
$this
->
ChlUn
->
ChlInfos
['listfields']);

63 
$this
->
LiFlds
 = 
	`exode
(',',
$lifld
);

66 
	`fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v

$this
->
Flds
[$k] = $v;

67 
$this
->
Flds
['rsk'] = 
$GLOBALS
['cfg_cmsu']."/da/rss/".$this->
TyID
.".xml";

70 
	`SSysEnv
(
$this
->
TyID
,$this->
Flds
['typename'],0,'','list');

71 
$this
->
Flds
['tyid'] = $this->
TyID
;

74 if(
$this
->
TyLk
->
TyInfos
['cross']>0 && $this->TypeLink->TypeInfos['ispart']==0)

76 
$lquy
 = '';

77 if(
$this
->
TyLk
->
TyInfos
['cross']==1)

79 
$lquy
 = "Select id,topid From `#@__arctype` whereypenameike '{$this->Fields['typename']}' And id<>'{$this->TypeID}' Andopid<>'{$this->TypeID}' ";

83 
$this
->
Flds
['ossid'] = 
	`eg_a
('[^0-9,]','',
	`im
($this->Fields['crossid']));

84 if(
$this
->
Flds
['crossid']!='')

86 
$lquy
 = "Select id,topid From `#@__arctype` where id in({$this->Fields['crossid']}) And id<>{$this->TypeID} Andopid<>{$this->TypeID} ";

89 if(
$lquy
!='')

91 
$this
->
dsql
->
	`SQuy
(
$lquy
);

92 
$this
->
dsql
->
	`Execu
();

93 
$r
 = 
$this
->
dsql
->
	`GAay
())

95 
$this
->
CrossID
 .($this->CrossID=='' ? 
$r
['id'] : ','.$arr['id']);

105 
funi
 
	`SgLiVw
(
$tyid
,
$chA
=
	$y
()){

106 
$this
->
	`__cڡru
(
$tyid
,
$chA
);

107 
	}
}

109 
funi
 
	$Clo
()

112 
	}
}

115 
funi
 
	$CouRecd
()

117 
glob
 
$cfg_li_s
;

120 
$this
->
TٮResu
 = -1;

121 if(
	`ist
(
$GLOBALS
['TٮResu'])
$this
->
TٮResu
 = $GLOBALS['TotalResult'];

122 if(
	`ist
(
$GLOBALS
['PageNo'])
$this
->
PageNo
 = $GLOBALS['PageNo'];

123 
$this
->
PageNo
 = 1;

124 
$this
->
addSql
 = "rc.arcrank > -1 ";

127 if(!
	`emy
(
$this
->
TyID
))

129 if(
$cfg_li_s
=='N')

131 if(
$this
->
CrossID
==''$this->
addSql
 ." And (c.tyid='".$this->
TyID
."') ";

132 
$this
->
addSql
 .= " And (arc.typeid in({$this->CrossID},{$this->TypeID})) ";

136 if(
$this
->
CrossID
==''$this->
addSql
 ." And (c.tyid i(".
	`GSIds
($this->
TyID
,$this->
Flds
['channeltype']).") ) ";

137 
$this
->
addSql
 ." And (c.tyid i(".
	`GSIds
($this->
TyID
,$this->
Flds
['channeltype']).",{$this->CrossID}) ) ";

141 
$ddQuy
 = '';

143 if(
	`cou
(
$this
->
chA
) > 0)

145 if(!
	`emy
(
$this
->
chA
['nativeplace']))

147 if(
$this
->
chA
['nativeplace'] % 500 ==0 )

149 
$ddQuy
 ." Andrc.tiv >'{$this->chA['tiv']}' Andrc.tiv < '".(
$this
->
chA
['nativeplace']+500)."'";

153 
$ddQuy
 .= "Andrc.nativeplace = '{$this->searchArr['nativeplace']}'";

156 if(!
	`emy
(
$this
->
chA
['infotype']))

158 if(
$this
->
chA
['infotype'] % 500 ==0 )

160 
$ddQuy
 ." Andrc.fy >'{$this->chA['fy']}' Andrc.fy < '".(
$this
->
chA
['infotype']+500)."'";

164 
$ddQuy
 .= "Andrc.infotype = '{$this->searchArr['infotype']}'";

167 if(!
	`emy
(
$this
->
chA
['keyword']))

169 
$ddQuy
 .= "Andrc.titleike '%{$this->searchArr['keyword']}%' ";

173 if(
$ddQuy
!='')

175 
$this
->
sAddTab
 = 
ue
;

176 
$this
->
addSql
 .
$ddQuy
;

179 if(
$this
->
TٮResu
==-1)

181 if(
$this
->
sAddTab
)

183 
$cquy
 = "Se cou(*add From `{$this->AddTab}`rwh".
$this
->
addSql
;

187 
$cquy
 = "Se cou(*add From `#@__y`rwh".
$this
->
addSql
;

189 
$row
 = 
$this
->
dsql
->
	`GO
(
$cquy
);

190 if(
	`is_y
(
$row
))

192 
$this
->
TٮResu
 = 
$row
['dd'];

196 
$this
->
TٮResu
 = 0;

200 
$mpfe
 = 
$GLOBALS
['cfg_bad'].$GLOBALS['cfg_ms_d']."/".
$this
->
TyLk
->
TyInfos
['templist'];

201 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
TyID
,$tempfile);

202 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

203 if(!
	`fe_exis
(
$mpfe
))

205 
$mpfe
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir']."/".$GLOBALS['cfg_df_style']."/list_default_sg.htm";

207 if(!
	`fe_exis
(
$mpfe
)||!
	`is_fe
($tempfile))

209 
echo
 "模板文件不存在，无法解析文档！";

210 
	`ex
();

212 
$this
->
d
->
	`LdTeme
(
$mpfe
);

213 
$ag
 = 
$this
->
d
->
	`GTag
("page");

214 if(!
	`is_obje
(
$ag
))

216 
$ag
 = 
$this
->
d
->
	`GTag
("list");

218 if(!
	`is_obje
(
$ag
))

220 
$this
->
PageSize
 = 20;

224 if(
$ag
->
	`GA
('pagesize')!='')

226 
$this
->
PageSize
 = 
$ag
->
	`GA
('pagesize');

230 
$this
->
PageSize
 = 20;

233 
$this
->
TٮPage
 = 
	`
($this->
TٮResu
/$this->
PageSize
);

234 
	}
}

237 
funi
 
	$MakeHtml
(
$age
=1,
$makagesize
=0)

239 if(
	`emy
(
$age
))

241 
$age
 = 1;

245 if(
$this
->
TyLk
->
TyInfos
['isdefault']==-1)

247 
echo
 '这个类目是动态类目！';

252 if(
$this
->
TyLk
->
TyInfos
['ispart']>0)

254 
$u
 = 
$this
->
	`MakePtTems
();

255  
$u
;

258 
$this
->
	`CouRecd
();

260 
$this
->
	`PTemsF
();

261 
$tٮge
 = 
	`
(
$this
->
TٮResu
/$this->
PageSize
);

262 if(
$tٮge
==0)

264 
$tٮge
 = 1;

266 
	`CeD
(
	`MfTyd
(
$this
->
Flds
['typedir']));

267 
$mu
 = '';

268 if(
$makagesize
 > 0)

270 
$dge
 = 
$age
+
$makagesize
;

274 
$dge
 = (
$tٮge
+1);

276 if
$dge
 >
$tٮge
+1 )

278 
$dge
 = 
$tٮge
+1;

280 if(
$dge
==1)

282 
$dge
 = 2;

284 
$this
->
PageNo
=
$age
; $this->PageN< 
$dge
; $this->PageNo++)

286 
$this
->
	`PDMFlds
($this->
PageNo
,1);

287 
$makeFe
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],'list',$this->Fields['typedir'],'',$this->Fields['namerule2']);

288 
$makeFe
 = 
	`r_a
("{ge}",
$this
->
PageNo
,$makeFile);

289 
$mu
 = 
$makeFe
;

290 if(!
	`eg
("^/",
$makeFe
))

292 
$makeFe
 = "/".$makeFile;

294 
$makeFe
 = 
$this
->
	`GTruePh
().$makeFile;

295 
$makeFe
 = 
	`eg_a
("/{1,}","/",$makeFile);

296 
$mu
 = 
$this
->
	`GTrueU
($murl);

297 
$this
->
d
->
	`SaveTo
(
$makeFe
);

299 if(
$age
==1)

302 if(
$this
->
TyLk
->
TyInfos
['isdefault']==1

303 && 
$this
->
TyLk
->
TyInfos
['ispart']==0)

305 
$lyru
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],"list",$this->Fields['typedir'],'',$this->Fields['namerule2']);

306 
$lyru
 = 
	`r_a
("{page}","1",$onlyrule);

307 
$li_1
 = 
$this
->
	`GTruePh
().
$lyru
;

308 
$mu
 = 
	`MfTyd
(
$this
->
Flds
['typedir']).'/'.$this->Fields['defaultname'];

309 
$dexme
 = 
$this
->
	`GTruePh
().
$mu
;

310 
	`cy
(
$li_1
,
$dexme
);

313  
$mu
;

314 
	}
}

317 
funi
 
	$Diy
()

319 if(
$this
->
TyLk
->
TyInfos
['it']>0 && 
	`cou
($this->
chA
)==0 )

321 
$this
->
	`DiyPtTems
();

324 
$this
->
	`CouRecd
();

339 
$this
->
	`PTemsF
();

340 
$this
->
	`PDMFlds
($this->
PageNo
,0);

341 
$this
->
d
->
	`Diy
();

342 
	}
}

345 
funi
 
	$MakePtTems
()

347 
$this
->
PtVw
 = 
w
 
	`PtVw
($this->
TyID
,
l
);

348 
$this
->
PtVw
->
	`STyLk
($this->
TyLk
);

349 
$nm
 = 0;

350 
$tmpd
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir'];

351 if(
$this
->
Flds
['ispart']==1)

353 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
TyID
,$this->
Flds
['tempindex']);

354 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

355 
$mpfe
 = 
$tmpd
."/".$tempfile;

356 if(!
	`fe_exis
(
$mpfe
))

358 
$mpfe
 = 
$tmpd
."/".
$GLOBALS
['cfg_df_style']."/index_default_sg.htm";

360 
$this
->
PtVw
->
	`STem
(
$mpfe
);

362 if(
$this
->
Flds
['ispart']==2)

365  
$this
->
Flds
['typedir'];

367 
	`CeD
(
	`MfTyd
(
$this
->
Flds
['typedir']));

368 
$makeU
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],"dex",
	`MfTyd
($this->Fields['typedir']),$this->Fields['defaultname'],$this->Fields['namerule2']);

369 
$makeU
 = 
	`eg_a
("/{1,}","/",$makeUrl);

370 
$makeFe
 = 
$this
->
	`GTruePh
().
$makeU
;

371 if(
$nm
==0)

373 
$this
->
PtVw
->
	`SaveToHtml
(
$makeFe
);

377 if(!
	`fe_exis
(
$makeFe
))

379 
$this
->
PtVw
->
	`SaveToHtml
(
$makeFe
);

382  
$this
->
	`GTrueU
(
$makeU
);

383 
	}
}

386 
funi
 
	$DiyPtTems
()

388 
$this
->
PtVw
 = 
w
 
	`PtVw
($this->
TyID
,
l
);

389 
$this
->
PtVw
->
	`STyLk
($this->
TyLk
);

390 
$nm
 = 0;

391 
$tmpd
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir'];

392 if(
$this
->
Flds
['ispart']==1)

395 
$mpfe
 = 
	`r_a
("{tid}",
$this
->
TyID
,$this->
Flds
['tempindex']);

396 
$mpfe
 = 
	`r_a
("{cid}",
$this
->
ChlUn
->
ChlInfos
['nid'],$tempfile);

397 
$mpfe
 = 
$tmpd
."/".$tempfile;

398 if(!
	`fe_exis
(
$mpfe
))

400 
$mpfe
 = 
$tmpd
."/".
$GLOBALS
['cfg_df_style']."/index_default_sg.htm";

402 
$this
->
PtVw
->
	`STem
(
$mpfe
);

404 if(
$this
->
Flds
['ispart']==2)

407 
$gou
 = 
$this
->
Flds
['typedir'];

408 
	`hd
("Location:$gotourl");

409 
	`ex
();

411 
	`CeD
(
	`MfTyd
(
$this
->
Flds
['typedir']));

412 
$makeU
 = 
$this
->
	`GMakeFeRu
($this->
Flds
['id'],"dex",
	`MfTyd
($this->Fields['typedir']),$this->Fields['defaultname'],$this->Fields['namerule2']);

413 
$makeFe
 = 
$this
->
	`GTruePh
().
$makeU
;

414 if(
$nm
==0)

416 
$this
->
PtVw
->
	`Diy
();

420 if(!
	`fe_exis
(
$makeFe
))

422 
$this
->
PtVw
->
	`Diy
();

426 
	`ude
(
$makeFe
);

429 
	}
}

432 
funi
 
	$GTruePh
()

434 
$uh
 = 
$GLOBALS
["cfg_basedir"];

435  
$uh
;

436 
	}
}

439 
funi
 
	$GTrueU
(
$nu
)

441 if(
	`egi
('^hp://',
$nu
))  $nurl;

442 if(
$this
->
Flds
['moresite']==1)

444 if(
$this
->
Flds
['sitepath']!='')

446 
$nu
 = 
	`eg_a
("^".
$this
->
Flds
['sitepath'],'',$nurl);

448 
$nu
 = 
$this
->
Flds
['siteurl'].$nurl;

450  
$nu
;

451 
	}
}

454 
funi
 
	$PTemsF
()

456 if(
	`ist
(
$this
->
TyLk
->
TyInfos
['reid']))

458 
$GLOBALS
['vs']['id'] = 
$this
->
TyLk
->
TyInfos
['reid'];

460 
$GLOBALS
['vs']['chlid'] = 
$this
->
TyLk
->
TyInfos
['channeltype'];

461 
$GLOBALS
['vs']['tyid'] = 
$this
->
TyID
;

462 
$GLOBALS
['envs']['cross'] = 1;

463 
	`MakeOTag
(
$this
->
d
,$this);

464 
	}
}

467 
funi
 
	$PDMFlds
(
$PageNo
,
$ismake
=1)

470 if((
$PageNo
>1 || 
	`
(
$this
->
Flds
['cڋ'])<10 ) && !$this->
IsR
)

472 
$this
->
d
->
SourSg
 = 
	`r_a
('[cmsreplace]','display:none',$this->dtp->SourceString);

473 
$this
->
IsR
 = 
ue
;

475 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$gid
=>
$ag
)

477 if(
$ag
->
	`GName
()=="list")

479 
$limt
 = (
$this
->
PageNo
-1* $this->
PageSize
;

480 
$row
 = 
$this
->
PageSize
;

481 if(
	`im
(
$ag
->
	`GIText
())=="")

483 
$IText
 = 
	`GSysTems
("list_fulllist.htm");

487 
$IText
 = 
	`im
(
$ag
->
	`GIText
());

489 
$this
->
d
->
	`Assign
(
$gid
,

490 
$this
->
	`GArcLi
(

491 
$limt
,

492 
$row
,

493 
$ag
->
	`GA
("col"),

494 
$ag
->
	`GA
("titlelen"),

495 
$ag
->
	`GA
("listtype"),

496 
$ag
->
	`GA
("orderby"),

497 
$IText
,

498 
$ag
->
	`GA
("tablewidth"),

499 
$ismake
,

500 
$ag
->
	`GA
("orderway")

504 if(
$ag
->
	`GName
()=="pagelist")

506 
$li_n
 = 
	`im
(
$ag
->
	`GA
("listsize"));

507 
$ag
->
	`GA
("liem")=="" ? 
$liem
="index,pre,pageno,next,end,option" : $listitem=$ctag->GetAtt("listitem");

508 if(
$li_n
=="")

510 
$li_n
 = 3;

512 if(
$ismake
==0)

514 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiDM
(
$li_n
,
$liem
));

518 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiST
(
$li_n
,
$liem
));

521 if(
$PageNo
!=1 && 
$ag
->
	`GName
()=='fld' && $ag->
	`GA
('display')!='')

523 
$this
->
d
->
	`Assign
(
$gid
,'');

526 
	}
}

529 
funi
 
	$GMakeFeRu
(
$tyid
,
$wme
,
$tyd
,
$deume
,
$mu2
)

531 
$tyd
 = 
	`MfTyd
($typedir);

532 if(
$wme
=='index')

534  
$tyd
.'/'.
$deume
;

538 
$mu2
 = 
	`r_a
('{tid}',
$tyid
,$namerule2);

539 
$mu2
 = 
	`r_a
('{tyd}',
$tyd
,$namerule2);

540  
$mu2
;

542 
	}
}

545 
funi
 
GArcLi
(
$limt
=0,
$row
=10,
$c
=1,
$tn
=30,
$lity
="l",
$dby
="deu",
$ùext
="",
$bwidth
="100",
$ismake
=1,
$dWay
='desc')

547 
glob
 
$cfg_li_s
;

548 
	g$tyid
=
$this
->
TyID
;

550 if(
	g$row
==''
$row
 = 10;

552 if(
	g$limt
==''
$limt
 = 0;

554 if(
	g$tn
==''
$tn
 = 100;

556 if(
	g$lity
==''
$lity
 = "all";

558 if(
	g$dby
==''
$dby
='id';

559 
	g$dby
=
ow
(
$dby
);

561 if(
	g$dWay
==''
$dWay
 = 'desc';

563 
	g$bwidth
 = 
r_a
("%","",
$bwidth
);

564 if(
	g$bwidth
==''
$bwidth
=100;

565 if(
	g$c
==''
$c
=1;

566 
	g$cWidth
 = 

(100/
$c
);

567 
	g$bwidth
 = 
$bwidth
."%";

568 
	g$cWidth
 = 
$cWidth
."%";

570 
	g$ùext
 = 
im
(
$ùext
);

571 if(
	g$ùext
==''
$ùext
 = 
GSysTems
('list_sglist.htm');

574 
	g$dsql
 = '';

575 if(
	g$dby
=='ndde'||
$dby
=='id')

577 
$dsql
=" order byrc.aid $orderWay";

579 if(
	g$dby
=='h'||
$dby
=='click')

581 
$dsql
 = " order byrc.click $orderWay";

585 
	g$dsql
=" order byrc.aid $orderWay";

588 
	g$addFld
 = 'c.'.
jo
(',c.',
$this
->
LiFlds
);

591 if(
eg
('h|ick',
$dby
|| 
	g$this
->
	gsAddTab
)

593 
	g$quy
 = "Selectp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,

594 

.
it
,
	g
.
	gmese
,.
	gseu
,.
	gsh
,
	gc
.
	gaid
,c.
aid
 
as
 
	gid
,c.
	gtyid
,

595 
$addFld


596 
	gom
 `{
	g$this
->
	gAddTab
}` 
c


597 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


598 
whe
 {
$this
->
addSql
} 
$dsql
 
lim
 
$limt
,
	g$row
";

603 
	g$t1
 = 
ExecTime
();

604 
	g$ids
 = 
y
();

605 
	g$ndsql
 = 
r_a
('.aid','.id',
$dsql
);

606 
	g$quy
 = "Select id From `#@__arctiny`rc where {$this->addSql} $nordersqlimit $limitstart,$row ";

608 
	g$this
->
	gdsql
->
SQuy
(
$quy
);

609 
	g$this
->
	gdsql
->
Execu
();

610 
	g$r
=
$this
->
dsql
->
GAay
())

612 
$ids
[] = 
$r
['id'];

614 
	g$idr
 = 
jo
(',',
$ids
);

615 if(
	g$idr
=='')

621 
	g$quy
 = "Selectp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,

622 

.
it
,
	g
.
	gmese
,.
	gseu
,.
	gsh
,
	gc
.
	gaid
,c.
aid
 
as
 
	gid
,c.
	gtyid
,

623 
$addFld


624 
	gom
 `{
	g$this
->
	gAddTab
}` 
c
 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


625 
whe
 
c
.
aid
 

(
$idr

d
rc.
k
 >-1 
$dsql
 ";

627 
	g$t2
 = 
ExecTime
();

631 
	g$this
->
	gdsql
->
SQuy
(
$quy
);

632 
	g$this
->
	gdsql
->
Execu
('al');

633 
	g$t2
 = 
ExecTime
();

636 
	g$i
 = '';

637 
	g$this
->
	gd2
->
LdSour
(
$ùext
);

638 
	g$GLOBALS
['autoindex'] = 0;

639 
	g$i
=0;$i<
	g$row
;$i++)

641 if(
	g$c
>1)

643 
	g$i
 .= "<div>\r\n";

645 
	g$j
=0;$j<
	g$c
;$j++)

647 if(
	g$row
 = 
$this
->
dsql
->
GAay
("al"))

649 
$GLOBALS
['autoindex']++;

650 
	g$ids
[
$row
['aid']] = $row['id']= $row['aid'];

653 
	g$row
['ismake'] = 1;

654 
	g$row
['money'] = 0;

655 
	g$row
['arcrank'] = 0;

656 
	g$row
['filename'] = '';

657 
	g$row
['fame'] = 
$row
['cu'] = 
GFeU
($row['id'],$row['typeid'],$row['senddate'],$row['title'],$row['ismake'],

658 
$row
['arcrank'],$row['namerule'],$row['typedir'],$row['money'],$row['filename'],$row['moresite'],$row['siteurl'],$row['sitepath']);

660 
	g$row
['tyu'] = 
GTyU
(
$row
['tyid'],
MfTyd
($row['typedir']),$row['isdefault'],$row['defaultname'],

661 
$row
['ispart'],$row['namerule2'],$row['moresite'],$row['siteurl'],$row['sitepath']);

662 if(
	g$row
['lpic'] ='-' || 
$row
['litpic'] == '')

664 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

666 if(!
egi
("^hp://",
$row
['lpic']&& 
	g$GLOBALS
['cfg_multi_site'] == 'Y')

668 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

670 
	g$row
['piame'] = 
$row
['litpic'];

672 
	g$row
['pubde'] = 
$row
['senddate'];

674 
	g$row
['ime'] = 
GDeMK
(
$row
['pubdate']);

676 
	g$row
['tylk'] = "<hf='".
$row
['typeurl']."'>".$row['typename']."</a>";

678 
	g$row
['fut'] = 
$row
['title'];

680 
	g$row
['t'] = 
_subr
(
$row
['t'],
$tn
);

682 if(
eg
('b',
$row
['flag']))

684 
	g$row
['t'] = "<b>".
$row
['title']."</b>";

687 
	g$row
['xk'] = "<hf='".
$row
['filename']."'>".$row['title']."</a>";

689 
	g$row
['usu'] = 
$row
['phpu'] = 
$GLOBALS
['cfg_phpurl'];

691 
	g$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

693 
	g$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

696 
fܗch
(
$row
 
as
 
$k
=>
$v
$row[
ow
($k)] = $v;

698 
fܗch
(
$this
->
ChlUn
->
ChlFlds
 
as
 
$k
=>
$r
)

700 if(
ist
(
$row
[
$k
]))

702 
$row
[
$k
] = 
$this
->
ChlUn
->
MakeFld
($k,$row[$k]);

706 if(
is_y
(
$this
->
d2
->
CTags
))

708 
fܗch
(
$this
->
d2
->
CTags
 
as
 
$k
=>
$ag
)

710 if(
$ag
->
GName
()=='array')

713 
$this
->
d2
->
Assign
(
$k
,
$row
);

717 if(
ist
(
$row
[
$ag
->
GName
()]))

719 
	g$this
->
	gd2
->
Assign
(
$k
,
$row
[
$ag
->
GName
()]);

723 
	g$this
->
	gd2
->
Assign
(
$k
,'');

728 
	g$i
 .
$this
->
d2
->
GResu
();

733 if(
	g$c
>1)

735 
	g$i
 +
$c
 - 1;

736 
	g$i
 .= " </div>\r\n";

740 
	g$t3
 = 
ExecTime
();

743 
	g$this
->
	gdsql
->
FeResu
('al');

744  
	g$i
;

748 
funi
 
GPageLiST
(
$li_n
,
$liem
="index,end,pre,next,pageno")

750 
$age
="";

751 
	g$xage
="";

752 
	g$agum
 = 
$this
->
PageNo
-1;

753 
	g$xagum
 = 
$this
->
PageNo
+1;

754 if(
	g$li_n
==""||
eg
("[^0-9]",
$li_n
))

756 
	g$li_n
=3;

758 
	g$tٮge
 = 

(
$this
->
TٮResu
/$this->
PageSize
);

759 if(
	g$tٮge
<=1 && 
$this
->
TٮResu
>0)

761  "< css=\"gefo\">共 <rg>1</rg>页<rg>".
$this
->
TٮResu
."</strong>条记录</span>";

763 if(
	g$this
->
	gTٮResu
 == 0)

765  "< css=\"gefo\">共 <rg>0</rg>页<rg>".
$this
->
TٮResu
."</strong>条记录</span>";

767 
	g$pu
 = 
$this
->
GCurU
();

768 
	g$mafo
 = "< css=\"gefo\">共 <rg>{$tٮge}</rg>页<rg>".
$this
->
TٮResu
."</strong>条</span>";

769 
	g$amu
 = 
$this
->
GMakeFeRu
($this->
Flds
['id'],"list",$this->Fields['typedir'],$this->Fields['defaultname'],$this->Fields['namerule2']);

770 
	g$amu
 = 
eg_a
('^(.*)/','',
$amu
);

773 if(
	g$this
->
	gPageNo
 != 1)

775 
$age
.="<li><hf='".
r_a
("{ge}",
$agum
,
$amu
)."'>上一页</a></li>\r\n";

776 
	g$dexge
="<li><hf='".
r_a
("{ge}",1,
$amu
)."'>首页</a></li>\r\n";

780 
	g$dexge
="<li>首页</li>\r\n";

784 if(
	g$this
->
	gPageNo
!=
$tٮge
 && $totalpage>1)

786 
$xage
.="<li><hf='".
r_a
("{ge}",
$xagum
,
$amu
)."'>下一页</a></li>\r\n";

787 
	g$dge
="<li><hf='".
r_a
("{ge}",
$tٮge
,
$amu
)."'>末页</a></li>\r\n";

791 
	g$dge
="<li>末页</li>";

795 
	g$tili
 = "";

815 
	g$lidd
="";

816 
	g$tٮ_li
 = 
$li_n
 * 2 + 1;

817 if(
	g$this
->
	gPageNo
 >
$tٮ_li
)

819 
$j
 = 
$this
->
PageNo
-
$li_n
;

820 
	g$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

821 if(
	g$tٮ_li
>
	g$tٮge
)

823 
	g$tٮ_li
=
$tٮge
;

828 
	g$j
=1;

829 if(
	g$tٮ_li
>
	g$tٮge
)

831 
	g$tٮ_li
=
$tٮge
;

834 
	g$j
;$j<=
$tٮ_li
;$j++)

836 if(
	g$j
==
$this
->
PageNo
)

838 
$lidd
.= "<li class=\"thisclass\">$j</li>\r\n";

842 
	g$lidd
.="<li><hf='".
r_a
("{ge}",
$j
,
$amu
)."'>".
	g$j
."</a></li>\r\n";

845 
	g$i
 = "";

846 if(
egi
('fo',
$liem
))

848 
	g$i
 .
$mafo
.' ';

850 if(
egi
('dex',
$liem
))

852 
	g$i
 .
$dexge
.' ';

854 if(
egi
('e',
$liem
))

856 
	g$i
 .
$age
.' ';

858 if(
egi
('go',
$liem
))

860 
	g$i
 .
$lidd
.' ';

862 if(
egi
('xt',
$liem
))

864 
	g$i
 .
$xage
.' ';

866 if(
egi
('d',
$liem
))

868 
	g$i
 .
$dge
.' ';

870 if(
egi
('ti',
$liem
))

872 
	g$i
 .
$tili
;

874  
	g$i
;

878 
funi
 
GPageLiDM
(
$li_n
,
$liem
="index,end,pre,next,pageno")

880 
glob
 
$tiv
,
$fy
,
$keywd
;

881 if(
emy
(
$tiv
)
	g$tiv
 = 0;

882 if(
emy
(
$fy
)
	g$fy
 = 0;

883 if(
emy
(
$keywd
)
	g$keywd
 = '';

884 
	g$age
 = 
$xage
 = '';

885 
	g$agum
 = 
$this
->
PageNo
-1;

886 
	g$xagum
 = 
$this
->
PageNo
+1;

887 if(
	g$li_n
==""||
eg
("[^0-9]",
$li_n
))

889 
	g$li_n
=3;

891 
	g$tٮge
 = 

(
$this
->
TٮResu
/$this->
PageSize
);

892 if(
	g$tٮge
<=1 && 
$this
->
TٮResu
>0)

894  "< css=\"gefo\">共1页/".
$this
->
TٮResu
."条记录</span>";

896 if(
	g$this
->
	gTٮResu
 == 0)

898  "< css=\"gefo\">共0页/".
$this
->
TٮResu
."条记录</span>";

900 
	g$pu
 = 
$this
->
GCurU
();

901 
	g$gu
 = "tid=".
$this
->
TyID
."&TٮResu=".$this->
TٮResu
."&tiv=$tiv&fy=$fy&keywd=".
ucode
(
$keywd
)."&";

902 
	g$hidfm
 = "<puty='hidd'ame='tid' vue='".
$this
->
TyID
."' />\r\n";

903 
	g$hidfm
 = "<inputype='hidden'ame='nativeplace' value='$nativeplace' />\r\n";

904 
	g$hidfm
 = "<inputype='hidden'ame='infotype' value='$infotype' />\r\n";

905 
	g$hidfm
 = "<inputype='hidden'ame='keyword' value='$keyword' />\r\n";

906 
	g$hidfm
 ."<puty='hidd'ame='TٮResu' vue='".
$this
->
TٮResu
."' />\r\n";

907 
	g$pu
 ."?".
$gu
;

910 if(
	g$this
->
	gPageNo
 != 1)

912 
$age
.="<li><hf='".
$pu
."PageNo=$prepagenum'>上一页</a></li>\r\n";

913 
	g$dexge
="<li><hf='".
$pu
."PageNo=1'>首页</a></li>\r\n";

917 
	g$dexge
="<li><a>首页</a></li>\r\n";

919 if(
	g$this
->
	gPageNo
!=
$tٮge
 && $totalpage>1)

921 
$xage
.="<li><hf='".
$pu
."PageNo=$nextpagenum'>下一页</a></li>\r\n";

922 
	g$dge
="<li><hf='".
$pu
."PageNo=$totalpage'>末页</a></li>\r\n";

926 
	g$dge
="<li><a>末页</a></li>";

930 
	g$lidd
="";

931 
	g$tٮ_li
 = 
$li_n
 * 2 + 1;

932 if(
	g$this
->
	gPageNo
 >
$tٮ_li
)

934 
$j
 = 
$this
->
PageNo
-
$li_n
;

935 
	g$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

936 if(
	g$tٮ_li
>
	g$tٮge
)

938 
	g$tٮ_li
=
$tٮge
;

943 
	g$j
=1;

944 if(
	g$tٮ_li
>
	g$tٮge
)

946 
	g$tٮ_li
=
$tٮge
;

949 
	g$j
;$j<=
$tٮ_li
;$j++)

951 if(
	g$j
==
$this
->
PageNo
)

953 
$lidd
.= "<li class=\"thisclass\"><a>$j</a></li>\r\n";

957 
	g$lidd
.="<li><hf='".
$pu
."PageNo=$j'>".
$j
."</a></li>\r\n";

962 
	g$i
 = 
$dexge
.
$age
.
$lidd
.
$xage
.
$dge
;

964  
	g$i
;

968 
funi
 
	$GCurU
()

970 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

972 
$nowu
 = 
$_SERVER
["REQUEST_URI"];

973 
$nowus
 = 
	`exode
("?",
$nowu
);

974 
$nowu
 = 
$nowus
[0];

978 
$nowu
 = 
$_SERVER
["PHP_SELF"];

980  
$nowu
;

981 
	}
}

	@include/arc.sgpage.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/arc.partview.class.php");

8 as
	csgge


10 
v
 
	m$dsql
;

11 
v
 
	m$d
;

12 
v
 
	m$TyID
;

13 
v
 
	m$Flds
;

14 
v
 
	m$TyLk
;

15 
v
 
	m$Vw
;

18 
funi
 
	$__cڡru
(
$aid
)

20 
glob
 
$cfg_bad
,
$cfg_ms_d
,
$cfg_df_y
,
$vs
;

22 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

23 
$this
->
d
 = 
w
 
	`DedeTagP
();

24 
$this
->
d
->
fObj
 = $this;

25 
$this
->
d
->
	`SNameS
("dede","{","}");

26 
$this
->
Flds
 = $this->
dsql
->
	`GO
("Select * From `#@__sgpage` whereid='$aid' ");

27 
$vs
['aid'] = 
$this
->
Flds
['aid'];

30 
	`fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v
)

32 
$this
->
Flds
[
$k
] = 
$v
;

34 if(
$this
->
Flds
['ismake']==1)

36 
$pv
 = 
w
 
	`PtVw
();

37 
$pv
->
	`STem
(
$this
->
Flds
['body'],'string');

38 
$this
->
Flds
['body'] = 
$pv
->
	`GResu
();

40 
$lfe
 = 
$cfg_bad
.
	`r_a
('{y}',
$cfg_ms_d
.'/'.
$cfg_df_y
,
$this
->
Flds
['template']);

41 
$this
->
d
->
	`LdTeme
(
$lfe
);

42 
$this
->
	`PTem
();

46 
funi
 
	$sgge
(
$aid
)

48 
$this
->
	`__cڡru
(
$aid
);

49 
	}
}

52 
funi
 
	$Diy
()

54 
$this
->
d
->
	`Diy
();

55 
	}
}

58 
funi
 
	$GResu
()

60  
$this
->
d
->
	`GResu
();

61 
	}
}

64 
funi
 
	$SaveToHtml
()

66 
$fame
 = 
$GLOBALS
['cfg_bad'].$GLOBALS['cfg_cmh'].'/'.
$this
->
Flds
['filename'];

67 
$fame
 = 
	`eg_a
('/{1,}','/',$filename);

68 
$this
->
d
->
	`SaveTo
(
$fame
);

69 
	}
}

72 
funi
 
	$PTem
()

74 
$GLOBALS
['vs']['likeid'] = 
$this
->
Flds
['likeid'];

75 
	`MakeOTag
(
$this
->
d
,$this);

76 
	}
}

79 
funi
 
	$Clo
()

81 
	}
}

	@include/arc.specview.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/typelink.class.php");

7 
que_
(
DEDEINC
."/channelunit.class.php");

9 @
t_time_lim
(0);

10 as
	cScVw


12 
v
 
	m$dsql
;

13 
v
 
	m$d
;

14 
v
 
	m$d2
;

15 
v
 
	m$TyID
;

16 
v
 
	m$TyLk
;

17 
v
 
	m$PageNo
;

18 
v
 
	m$TٮPage
;

19 
v
 
	m$TٮResu
;

20 
v
 
	m$PageSize
;

21 
v
 
	m$ChlUn
;

22 
v
 
	m$LiTy
;

23 
v
 
	m$TempInfos
;

24 
v
 
	m$Flds
;

25 
v
 
	m$STime
;

28 
funi
 
	$__cڡru
(
$ime
=0)

30 
$this
->
TyID
 = 0;

31 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

32 
$this
->
d
 = 
w
 
	`DedeTagP
();

33 
$this
->
d
->
	`SRefObj
($this);

34 
$this
->
d
->
	`SNameS
("dede","{","}");

35 
$this
->
d2
 = 
w
 
	`DedeTagP
();

36 
$this
->
d2
->
	`SNameS
("field","[","]");

37 
$this
->
TyLk
 = 
w
 
	`TyLk
(0);

38 
$this
->
ChlUn
 = 
w
 
	`ChlUn
(-1);

41 
	`fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v
)

43 
$this
->
Flds
[
$k
] = 
$v
;

45 if(
$ime
==0)

47 
$this
->
STime
 = 0;

51 
$this
->
STime
 = 
	`GMkTime
(
$ime
);

53 
$this
->
	`CouRecd
();

54 
$mpfe
 = 
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_templets_dir']."/".$GLOBALS['cfg_df_style']."/list_spec.htm";

55 if(!
	`fe_exis
(
$mpfe
)||!
	`is_fe
($tempfile))

57 
echo
 "模板文件不存在，无法解析文档！";

58 
	`ex
();

60 
$this
->
d
->
	`LdTeme
(
$mpfe
);

61 
$this
->
TempInfos
['gs'] = $this->
d
->
CTags
;

62 
$this
->
TempInfos
['sour'] = $this->
d
->
SourSg
;

63 
$ag
 = 
$this
->
d
->
	`GTag
("page");

64 if(!
	`is_obje
(
$ag
))

66 
$this
->
PageSize
 = 20;

70 if(
$ag
->
	`GA
("pagesize")!="")

72 
$this
->
PageSize
 = 
$ag
->
	`GA
("pagesize");

76 
$this
->
PageSize
 = 20;

79 
$this
->
TٮPage
 = 
	`
($this->
TٮResu
/$this->
PageSize
);

83 
funi
 
	$ScVw
(
$ime
=0)

85 
$this
->
	`__cڡru
(
$ime
);

86 
	}
}

89 
funi
 
	$Clo
()

91 
	}
}

94 
funi
 
	$CouRecd
()

96 
$this
->
TٮResu
 = -1;

97 if(
	`ist
(
$GLOBALS
['TotalResult']))

99 
$this
->
TٮResu
 = 
$GLOBALS
['TotalResult'];

101 if(
	`ist
(
$GLOBALS
['PageNo']))

103 
$this
->
PageNo
 = 
$GLOBALS
['PageNo'];

107 
$this
->
PageNo
 = 1;

109 if(
$this
->
TٮResu
==-1)

111 if(
$this
->
STime
>0)

113 
$timesql
 = " And #@__chives.ndde>'".
$this
->
STime
."'";

117 
$timesql
 = "";

119 
$row
 = 
$this
->
dsql
->
	`GO
("Select count(*)s dd From #@__archives where #@__archives.arcrank > -1 And channel=-1 $timesql");

120 if(
	`is_y
(
$row
))

122 
$this
->
TٮResu
 = 
$row
['dd'];

126 
$this
->
TٮResu
 = 0;

129 
	}
}

132 
funi
 
	$Diy
()

134 if(
$this
->
TyLk
->
TyInfos
['ispart']==1

135 ||
$this
->
TyLk
->
TyInfos
['ispart']==2)

137 
$this
->
	`DiyPtTems
();

139 
$this
->
	`PTemsF
();

140 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$gid
=>
$ag
)

142 if(
$ag
->
	`GName
()=="list")

144 
$limt
 = (
$this
->
PageNo
-1* $this->
PageSize
;

145 
$row
 = 
$this
->
PageSize
;

146 if(
	`im
(
$ag
->
	`GIText
())=="")

148 
$IText
 = 
	`GSysTems
("list_fulllist.htm");

152 
$IText
 = 
	`im
(
$ag
->
	`GIText
());

154 
$this
->
d
->
	`Assign
(
$gid
,

155 
$this
->
	`GArcLi
(
$limt
,
$row
,

156 
$ag
->
	`GA
("col"),

157 
$ag
->
	`GA
("titlelen"),

158 
$ag
->
	`GA
("infolen"),

159 
$ag
->
	`GA
("imgwidth"),

160 
$ag
->
	`GA
("imgheight"),

161 
$ag
->
	`GA
("listtype"),

162 
$ag
->
	`GA
("orderby"),

163 
$IText
,

164 
$ag
->
	`GA
("tablewidth"))

167 if(
$ag
->
	`GName
()=="pagelist")

169 
$li_n
 = 
	`im
(
$ag
->
	`GA
("listsize"));

170 if(
$li_n
=="")

172 
$li_n
 = 3;

174 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiDM
(
$li_n
));

177 
$this
->
d
->
	`Diy
();

178 
	}
}

181 
funi
 
	$MakeHtml
()

184 
$this
->
	`PTemsF
();

185 
$tٮge
 = 
	`
(
$this
->
TٮResu
/$this->
PageSize
);

186 if(
$tٮge
==0)

188 
$tٮge
 = 1;

190 
	`CeD
(
$GLOBALS
['cfg_special']);

191 
$mu
 = "";

192 
$this
->
PageNo
=1;$this->PageNo<=
$tٮge
;$this->PageNo++)

194 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$gid
=>
$ag
)

196 if(
$ag
->
	`GName
()=="list")

198 
$limt
 = (
$this
->
PageNo
-1* $this->
PageSize
;

199 
$row
 = 
$this
->
PageSize
;

200 if(
	`im
(
$ag
->
	`GIText
())=="")

202 
$IText
 = 
	`GSysTems
("spec_list.htm");

206 
$IText
 = 
	`im
(
$ag
->
	`GIText
());

208 
$this
->
d
->
	`Assign
(
$gid
,

209 
$this
->
	`GArcLi
(
$limt
,
$row
,

210 
$ag
->
	`GA
("col"),

211 
$ag
->
	`GA
("titlelen"),

212 
$ag
->
	`GA
("infolen"),

213 
$ag
->
	`GA
("imgwidth"),

214 
$ag
->
	`GA
("imgheight"),

216 
$ag
->
	`GA
("orderby"),

217 
$IText
,

218 
$ag
->
	`GA
("tablewidth"))

221 if(
$ag
->
	`GName
()=="pagelist")

223 
$li_n
 = 
	`im
(
$ag
->
	`GA
("listsize"));

224 if(
$li_n
=="")

226 
$li_n
 = 3;

228 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiST
(
$li_n
));

232 
$makeFe
 = 
$GLOBALS
['cfg_ecl']."/ec_".
$this
->
PageNo
.$GLOBALS['art_shortname'];

233 
$mu
 = 
$makeFe
;

234 
$makeFe
 = 
$GLOBALS
['cfg_basedir'].$makeFile;

235 
$this
->
d
->
	`SaveTo
(
$makeFe
);

236 
echo
 "成功创建：$murl<br/>";

238 
	`cy
(
$GLOBALS
['cfg_basedir'].$GLOBALS['cfg_special']."/spec_1".$GLOBALS['art_shortname'],$GLOBALS['cfg_basedir'].$GLOBALS['cfg_special']."/index.html");

239 
$mu
 = 
$GLOBALS
['cfg_special']."/index.html";

240  
$mu
;

241 
	}
}

244 
funi
 
	$PTemsF
()

246 
	`MakeOTag
(
$this
->
d
,$this);

247 
	}
}

250 
funi
 
GArcLi
(
$limt
=0,
$row
=10,
$c
=1,
$tn
=30,
$fޒ
=250,

251 
$imgwidth
=120,
$imgheight
=90,
$lity
="l",
$dby
="deu",
$ùext
="",
$bwidth
="100")

253 
$tyid
=
$this
->
TyID
;

254 if(
	g$row
=="")

256 
$row
 = 10;

258 if(
	g$limt
=="")

260 
$limt
 = 0;

262 if(
	g$tn
=="")

264 
$tn
 = 30;

266 if(
	g$fޒ
=="")

268 
$fޒ
 = 250;

270 if(
	g$imgwidth
=="")

272 
$imgwidth
 = 120;

274 if(
	g$imgheight
=="")

276 
$imgheight
 = 120;

278 if(
	g$lity
=="")

280 
$lity
 = "all";

282 if(
	g$dby
=="")

284 
$dby
="default";

288 
	g$dby
=
ow
(
$dby
);

290 
	g$bwidth
 = 
r_a
("%","",
$bwidth
);

291 if(
	g$bwidth
=="")

293 
$bwidth
=100;

295 if(
	g$c
=="")

297 
$c
=1;

299 
	g$cWidth
 = 

(100/
$c
);

300 
	g$bwidth
 = 
$bwidth
."%";

301 
	g$cWidth
 = 
$cWidth
."%";

302 
	g$ùext
 = 
im
(
$ùext
);

303 if(
	g$ùext
=="")

305 
$ùext
 = 
GSysTems
("spec_list.htm");

309 
	g$whe
 = "rc.arcrank > -1 Andrc.channel = -1 ";

310 if(
	g$this
->
	gSTime
>0)

312 
	g$whe
 ." Andrc.ndde>'".
$this
->
STime
."'";

316 
	g$dsql
 = '';

317 if(
	g$dby
=='senddate')

319 
$dsql
=" order byrc.senddate desc";

321 if(
	g$dby
=='pubdate')

323 
$dsql
=" order byrc.pubdate desc";

325 if(
	g$dby
=='id')

327 
$dsql
=" order byrc.id desc";

331 
	g$dsql
=" order byrc.sortrank desc";

333 
	g$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.isdefault,arc.money,

334 

.
deume
,
	g
.
	gmu
,.
	gmu2
,.
	git
,.
	gmese
,.
	gseu
,.
sh


335 
	gom
 `#@
	g__chives
` 
c
 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


336 
whe
 
$whe
 
$dsql
 
lim
 
$limt
,
	g$row
 ";

337 
	g$this
->
	gdsql
->
SQuy
(
$quy
);

338 
	g$this
->
	gdsql
->
Execu
('al');

339 
	g$i
 = '';

340 if(
	g$c
>1)

342 
	g$i
 = "<table width='$tablewidth' border='0' cellspacing='0' cellpadding='0'>\r\n";

344 
	g$this
->
	gd2
->
LdSour
(
$ùext
);

345 
	g$i
=0;$i<
	g$row
;$i++)

347 if(
	g$c
>1)

349 
	g$i
 .= "<tr>\r\n";

351 
	g$j
=0;$j<
	g$c
;$j++)

353 if(
	g$c
>1)

355 
	g$i
 .= "<td width='$colWidth'>\r\n";

357 if(
	g$row
 = 
$this
->
dsql
->
GAay
("al"))

360 
$row
["desti"] = 
_subr
($row["desti"],
$fޒ
);

361 
	g$row
["t"] = 
_subr
(
$row
["t"],
$tn
);

362 
	g$row
["id"] = 
$row
["id"];

363 if(
	g$row
['lpic'] ='-' || 
$row
['litpic'] == '')

365 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

367 if(!
egi
("^hp://",
$row
['lpic']&& 
	g$GLOBALS
['cfg_multi_site'] == 'Y')

369 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

371 
	g$row
['piame'] = 
$row
['litpic'];

372 
	g$row
["cu"] = 
GFeU
(
$row
["id"],$row["typeid"],$row["senddate"],$row["title"],

373 
$row
["ismake"],$row["arcrank"],$row["namerule"],$row["typedir"],$row["money"],$row['filename'],$row["moresite"],$row["siteurl"],$row["sitepath"]);

374 
	g$row
["tyu"] = 
GTyU
(
$row
["typeid"],$row["typedir"],$row["isdefault"],$row["defaultname"],$row["ispart"],$row["namerule2"],$row["moresite"],$row["siteurl"],$row["sitepath"]);

375 
	g$row
["fo"] = 
$row
["description"];

376 
	g$row
["fame"] = 
$row
["arcurl"];

377 
	g$row
["ime"] = 
GDeMK
(
$row
["pubdate"]);

378 
	g$row
["xk"] = "<hf='".
$row
["filename"]."'>".$row["title"]."</a>";

379 
	g$row
["tylk"] = "[<hf='".
$row
["typeurl"]."'>".$row["typename"]."</a>]";

380 
	g$row
["imglk"] = "<hf='".
$row
["filename"]."'><img src='".$row["picname"]."' border='0' width='$imgwidth' height='$imgheight'></a>";

381 
	g$row
["image"] = "<img src='".
$row
["picname"]."' border='0' width='$imgwidth' height='$imgheight'>";

382 
	g$row
['usu'] = 
$row
['phpu'] = 
$GLOBALS
['cfg_phpurl'];

383 
	g$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

384 
	g$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

387 
fܗch
(
$this
->
ChlUn
->
ChlFlds
 
as
 
$k
=>
$r
)

389 if(
ist
(
$row
[
$k
]))

391 
$row
[
$k
] = 
$this
->
ChlUn
->
MakeFld
($k,$row[$k]);

394 if(
is_y
(
$this
->
d2
->
CTags
))

396 
fܗch
(
$this
->
d2
->
CTags
 
as
 
$k
=>
$ag
)

398 if(
$ag
->
GName
()=='array')

401 
$this
->
d2
->
Assign
(
$k
,
$row
);

405 if(
ist
(
$row
[
$ag
->
GName
()]))

407 
	g$this
->
	gd2
->
Assign
(
$k
,
$row
[
$ag
->
GName
()]);

411 
	g$this
->
	gd2
->
Assign
(
$k
,'');

416 
	g$i
 .
$this
->
d2
->
GResu
();

421 
	g$i
 .= "";

423 if(
	g$c
>1)

425 
	g$i
 .= "</td>\r\n";

429 if(
	g$c
>1)

431 
	g$i
 .= "</tr>\r\n";

435 if(
	g$c
>1)

437 
	g$i
 .= "</table>\r\n";

439 
	g$this
->
	gdsql
->
FeResu
("al");

440  
	g$i
;

444 
funi
 
	$GPageLiST
(
$li_n
)

446 
$age
="";

447 
$xage
="";

448 
$agum
 = 
$this
->
PageNo
-1;

449 
$xagum
 = 
$this
->
PageNo
+1;

450 if(
$li_n
==""||
	`eg
("[^0-9]",$list_len))

452 
$li_n
=3;

454 
$tٮge
 = 
	`
(
$this
->
TٮResu
/$this->
PageSize
);

455 if(
$tٮge
<=1 && 
$this
->
TٮResu
>0)

458  "< css=\"gefo\">共 <rg>1</rg>页<rg>".
$this
->
TٮResu
."</strong>条记录</span>";

460 if(
$this
->
TٮResu
 == 0)

462  "< css=\"gefo\">共 <rg>0</rg>页<rg>".
$this
->
TٮResu
."</strong>条记录</span>";

464 
$pu
 = 
$this
->
	`GCurU
();

465 
$amu
 = "spec_";

468 if(
$this
->
PageNo
 != 1)

470 
$age
.="<li><hf='".
$amu
."$agum".
$GLOBALS
['art_shortname']."'>上一页</a></li>\r\n";

471 
$dexge
="<li><hf='".
$amu
."1".
$GLOBALS
['art_shortname']."'>首页</a></li>\r\n";

475 
$dexge
="<li><a>首页</a></li>\r\n";

477 if(
$this
->
PageNo
!=
$tٮge
 && $totalpage>1)

479 
$xage
.="<li><hf='".
$amu
."$xagum".
$GLOBALS
['art_shortname']."'>下一页</a></li>\r\n";

480 
$dge
="<li><hf='".
$amu
."$tٮge".
$GLOBALS
['art_shortname']."'>末页</a></li>\r\n";

484 
$dge
="<li><a>末页</a></li>\r\n";

488 
$lidd
="";

489 
$tٮ_li
 = 
$li_n
 * 2 + 1;

490 if(
$this
->
PageNo
 >
$tٮ_li
)

492 
$j
 = 
$this
->
PageNo
-
$li_n
;

493 
$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

494 if(
$tٮ_li
>
$tٮge
)

496 
$tٮ_li
=
$tٮge
;

501 
$j
=1;

502 if(
$tٮ_li
>
$tٮge
)

504 
$tٮ_li
=
$tٮge
;

507 
$j
;$j<=
$tٮ_li
;$j++)

509 if(
$j
==
$this
->
PageNo
)

511 
$lidd
.= "<li class=\"thisclass\"><a>$j</a></li>\r\n";

515 
$lidd
.="<li><hf='".
$amu
."$j".
$GLOBALS
['t_sh܊ame']."'>".
$j
."</a></li>\r\n";

518 
$i
 = 
$dexge
.
$age
.
$lidd
.
$xage
.
$dge
;

519  
$i
;

520 
	}
}

523 
funi
 
	$GPageLiDM
(
$li_n
)

525 
$age
="";

526 
$xage
="";

527 
$agum
 = 
$this
->
PageNo
-1;

528 
$xagum
 = 
$this
->
PageNo
+1;

529 if(
$li_n
==""||
	`eg
("[^0-9]",$list_len))

531 
$li_n
=3;

533 
$tٮge
 = 
	`
(
$this
->
TٮResu
/$this->
PageSize
);

534 if(
$tٮge
<=1 && 
$this
->
TٮResu
>0)

536  "< css=\"gefo\">共1页/".
$this
->
TٮResu
."条记录</span>";

538 if(
$this
->
TٮResu
 == 0)

540  "< css=\"gefo\">共0页/".
$this
->
TٮResu
."条记录</span>";

543 
$pu
 = 
$this
->
	`GCurU
();

544 
$gu
 = "tyid=".
$this
->
TyID
."&TٮResu=".$this->
TٮResu
."&";

545 
$hidfm
 = "<puty='hidd'ame='tyid' vue='".
$this
->
TyID
."'>\r\n";

546 
$hidfm
 ."<puty='hidd'ame='TٮResu' vue='".
$this
->
TٮResu
."'>\r\n";

547 
$pu
 ."?".
$gu
;

550 if(
$this
->
PageNo
 != 1)

552 
$age
.="<li><hf='".
$pu
."PageNo=$prepagenum'>上一页</a></li>\r\n";

553 
$dexge
="<li><hf='".
$pu
."PageNo=1'>首页</a></li>\r\n";

557 
$dexge
="<li><a>首页</a></li>\r\n";

559 if(
$this
->
PageNo
!=
$tٮge
 && $totalpage>1)

561 
$xage
.="<li><hf='".
$pu
."PageNo=$nextpagenum'>下一页</a></li>\r\n";

562 
$dge
="<li><hf='".
$pu
."PageNo=$totalpage'>末页</a></li>\r\n";

566 
$dge
="<li><a>末页</a></li>";

570 
$lidd
="";

571 
$tٮ_li
 = 
$li_n
 * 2 + 1;

572 if(
$this
->
PageNo
 >
$tٮ_li
)

574 
$j
 = 
$this
->
PageNo
-
$li_n
;

575 
$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

576 if(
$tٮ_li
>
$tٮge
)

578 
$tٮ_li
=
$tٮge
;

583 
$j
=1;

584 if(
$tٮ_li
>
$tٮge
)

586 
$tٮ_li
=
$tٮge
;

589 
$j
;$j<=
$tٮ_li
;$j++)

591 if(
$j
==
$this
->
PageNo
)

593 
$lidd
.= "<li class=\"thisclass\"><a>$j</a></li>\r\n";

597 
$lidd
.="<li><hf='".
$pu
."PageNo=$j'>".
$j
."</a></li>\r\n";

601 
$i
 = 
$dexge
.
$age
.
$lidd
.
$xage
.
$dge
;

602  
$i
;

603 
	}
}

606 
funi
 
	$GCurU
()

608 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

610 
$nowu
 = 
$_SERVER
["REQUEST_URI"];

611 
$nowus
 = 
	`exode
("?",
$nowu
);

612 
$nowu
 = 
$nowus
[0];

616 
$nowu
 = 
$_SERVER
["PHP_SELF"];

618  
$nowu
;

619 
	}
}

	@include/arc.taglist.class.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
que_
(
DEDEINC
.'/channelunit.class.php');

5 
que_
(
DEDEINC
.'/typelink.class.php');

7 @
t_time_lim
(0);

8 as
	cTagLi


10 
v
 
	m$dsql
;

11 
v
 
	m$d
;

12 
v
 
	m$d2
;

13 
v
 
	m$TyLk
;

14 
v
 
	m$PageNo
;

15 
v
 
	m$TٮPage
;

16 
v
 
	m$TٮResu
;

17 
v
 
	m$PageSize
;

18 
v
 
	m$LiTy
;

19 
v
 
	m$Flds
;

20 
v
 
	m$Tag
;

21 
v
 
	m$Tem
;

22 
v
 
	m$TagInfos
;

23 
v
 
	m$TemsFe
;

26 
funi
 
	$__cڡru
(
$keywd
,
$m
)

28 
$this
->
Tem
 = 
$m
;

29 
$this
->
Tag
 = 
$keywd
;

30 
$this
->
dsql
 = 
w
 
	`DedeSql
(
l
);

31 
$this
->
d
 = 
w
 
	`DedeTagP
();

32 
$this
->
d
->
	`SRefObj
($this);

33 
$this
->
d
->
	`SNameS
("dede","{","}");

34 
$this
->
d2
 = 
w
 
	`DedeTagP
();

35 
$this
->
d2
->
	`SNameS
("field","[","]");

36 
$this
->
TyLk
 = 
w
 
	`TyLk
(0);

37 
$this
->
Flds
['g'] = 
$keywd
;

38 
$this
->
Flds
['t'] = 
$keywd
;

39 
$this
->
TemsFe
 = '';

42 
	`fܗch
(
$GLOBALS
['PubFlds'] 
as
 
$k
=>
$v

$this
->
Flds
[$k] = $v;

45 if(
$this
->
Tag
!='')

47 
$this
->
TagInfos
 = $this->
dsql
->
	`GO
("Select * From `#@__tagindex` whereagike '{$this->Tag}' ");

48 if(!
	`is_y
(
$this
->
TagInfos
))

50 
$fuΣch
 = 
$GLOBALS
['cfg_phpu']."/ch.php?keywd=".
$this
->
Tag
."&searchtype=titlekeyword";

51 
$msg
 = "系统无此标签，可能已经移除！<br /><br />你还可以尝试通过搜索程序去搜索这个关键字：<a href='$fullsearch'>前往搜索&gt;&gt;</a>";

52 
	`ShowMsg
(
$msg
,"-1");

53 
	`ex
();

58 
$mpfe
 = 
$GLOBALS
['cfg_bad'].$GLOBALS['cfg_ms_d']."/".$GLOBALS['cfg_df_y'].'/'.
$this
->
Tem
;

59 if(!
	`fe_exis
(
$mpfe
)||!
	`is_fe
($tempfile))

61 
echo
 "模板文件不存在，无法解析文档！";

62 
	`ex
();

64 
$this
->
d
->
	`LdTeme
(
$mpfe
);

65 
$this
->
TemsFe
 = 
	`eg_a
("^".
$GLOBALS
['cfg_bad'],'',
$mpfe
);

70 
funi
 
	$TagLi
(
$keywd
,
$m
)

72 
$this
->
	`__cڡru
(
$keywd
,
$m
);

73 
	}
}

76 
funi
 
	$Clo
()

78 @
$this
->
dsql
->
	`Clo
();

79 @
$this
->
TyLk
->
	`Clo
();

80 
	}
}

83 
funi
 
	$CouRecd
()

86 
$this
->
TٮResu
 = -1;

87 if(
	`ist
(
$GLOBALS
['TotalResult']))

89 
$this
->
TٮResu
 = 
$GLOBALS
['TotalResult'];

91 if(
	`ist
(
$GLOBALS
['PageNo']))

93 
$this
->
PageNo
 = 
$GLOBALS
['PageNo'];

97 
$this
->
PageNo
 = 1;

99 if(
$this
->
TٮResu
==-1)

101 
$cquy
 = "Select count(*)s dd From `#@__taglist` whereid = '{$this->TagInfos['id']}' Andrcrank>-1 ";

102 
$row
 = 
$this
->
dsql
->
	`GO
(
$cquy
);

103 
$this
->
TٮResu
 = 
$row
['dd'];

106 
$ime
 = 
	`time
();

109 
$upquy
 = "Update `#@__tagindex` setesult='{$row['dd']}',count=count+1,weekcc=weekcc+1,monthcc=monthcc+1 whereagike '{$this->Tag}' ";

110 
$this
->
dsql
->
	`ExecuNeQuy
(
$upquy
);

111 
$eday
 = 24 * 3600;

114 if(
	`
(
$ime
 - 
$this
->
TagInfos
['wkup'])/
$eday
 ) > 7)

116 
$this
->
dsql
->
	`ExecuNeQuy
("Update `#@__tagindex` set weekcc=0,weekup='{$ntime}' whereagike '{$this->Tag}' ");

120 if(
	`
(
$ime
 - 
$this
->
TagInfos
['mthup'])/
$eday
 ) > 30)

122 
$this
->
dsql
->
	`ExecuNeQuy
("Update `#@__tagindex` set monthcc=0,monthup='{$ntime}' whereagike '{$this->Tag}' ");

125 
$ag
 = 
$this
->
d
->
	`GTag
("page");

126 if(!
	`is_obje
(
$ag
))

128 
$ag
 = 
$this
->
d
->
	`GTag
("list");

130 if(!
	`is_obje
(
$ag
))

132 
$this
->
PageSize
 = 25;

136 if(
$ag
->
	`GA
("pagesize")!='')

138 
$this
->
PageSize
 = 
$ag
->
	`GA
("pagesize");

142 
$this
->
PageSize
 = 25;

145 
$this
->
TٮPage
 = 
	`
($this->
TٮResu
/$this->
PageSize
);

146 
	}
}

149 
funi
 
	$Diy
()

151 if(
$this
->
Tag
!='')

153 
$this
->
	`CouRecd
();

155 
$this
->
	`PTemsF
();

156 if(
$this
->
Tag
!='')

158 
$this
->
	`PDMFlds
($this->
PageNo
,0);

160 
$this
->
	`Clo
();

161 
$this
->
d
->
	`Diy
();

162 
	}
}

165 
funi
 
	$PTemsF
()

167 
	`MakeOTag
(
$this
->
d
,$this);

168 
	}
}

171 
funi
 
	$PDMFlds
(
$PageNo
,
$ismake
=1)

173 
	`fܗch
(
$this
->
d
->
CTags
 
as
 
$gid
=>
$ag
){

174 if(
$ag
->
	`GName
()=="list")

176 
$limt
 = (
$this
->
PageNo
-1* $this->
PageSize
;

177 if(
$limt
<0)

179 
$limt
 = 0;

181 
$row
 = 
$this
->
PageSize
;

182 if(
	`im
(
$ag
->
	`GIText
())=="")

184 
$IText
 = 
	`GSysTems
("list_fulllist.htm");

188 
$IText
 = 
	`im
(
$ag
->
	`GIText
());

190 
$this
->
d
->
	`Assign
(
$gid
,

191 
$this
->
	`GArcLi
(

192 
$limt
,

193 
$row
,

194 
$ag
->
	`GA
("col"),

195 
$ag
->
	`GA
("titlelen"),

196 
$ag
->
	`GA
("infolen"),

197 
$ag
->
	`GA
("imgwidth"),

198 
$ag
->
	`GA
("imgheight"),

199 
$ag
->
	`GA
("listtype"),

200 
$ag
->
	`GA
("orderby"),

201 
$IText
,

202 
$ag
->
	`GA
("tablewidth"),

203 
$ismake
,

204 
$ag
->
	`GA
("orderway")

208 if(
$ag
->
	`GName
()=="pagelist")

210 
$li_n
 = 
	`im
(
$ag
->
	`GA
("listsize"));

211 
$ag
->
	`GA
("liem")=="" ? 
$liem
="info,index,pre,pageno,next,end,option" : $listitem=$ctag->GetAtt("listitem");

212 if(
$li_n
=="")

214 
$li_n
 = 3;

216 if(
$ismake
==0)

218 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiDM
(
$li_n
,
$liem
));

222 
$this
->
d
->
	`Assign
(
$gid
,$this->
	`GPageLiST
(
$li_n
,
$liem
));

226 
	}
}

229 
funi
 
GArcLi
(
$limt
=0,
$row
=10,
$c
=1,
$tn
=30,
$fޒ
=250,

230 
$imgwidth
=120,
$imgheight
=90,
$lity
="l",
$dby
="deu",
$ùext
="",
$bwidth
="100",
$ismake
=1,
$dWay
='desc')

232 
$grow
 = (
$row
=='' ? 10 : $row);

233 if(
	g$limt
==''
$limt
 = 0;

234 if(
	g$tn
==''
$tn
 = 100;

235 if(
	g$fޒ
==''
$fޒ
 = 250;

236 if(
	g$imgwidth
==''
$imgwidth
 = 120;

237 if(
	g$imgheight
==''
$imgheight
 = 120;

238 if(
	g$lity
==''
$lity
 = 'all';

239 
	g$dby
 = (
$dby
=='' ? 'deu' : 
ow
($orderby) );

240 if(
	g$dWay
==''
$dWay
 = 'desc';

241 
	g$bwidth
 = 
r_a
("%", "", 
$bwidth
);

242 if(
	g$bwidth
==''
$bwidth
=100;

243 if(
	g$c
==''
$c
=1;

244 
	g$cWidth
 = 

(100/
$c
);

245 
	g$bwidth
 = 
$bwidth
."%";

246 
	g$cWidth
 = 
$cWidth
."%";

247 
	g$ùext
 = 
im
(
$ùext
);

248 if(
	g$ùext
==''
$ùext
 = 
GSysTems
("list_fulllist.htm");

249 
	g$idlis
 = 
$dsql
 = '';

250 
	g$this
->
	gdsql
->
SQuy
("Selectid From `#@__taglist` whereid = '{$this->TagInfos['id']}' Andrcrank>-1imit $limitstart,$getrow");

251 
	g$this
->
	gdsql
->
Execu
();

252 
	g$row
=
$this
->
dsql
->
GAay
())

254 
$idlis
 .($idlis=='' ? 
$row
['aid'] : ','.$row['aid']);

256 if(
	g$idlis
=='')  '';

259 
	g$whe
 = " se.id in($idlists) ";

262 if(
	g$dby
=="sortrank")

264 
$dsql
 = " order by se.sortrank $orderWay";

268 
	g$dsql
=" order by se.id $orderWay";

270 
	g$quy
 = "Select se.*,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,tp.ispart,tp.moresite,tp.siteurl,tp.sitepath

271 
om
 `#@
__chives
` 

 

 
jo
 `#@
__y
` 

 

 se.
tyid
p.
id
 
whe
 
$whe
 
$dsql
 ";

273 
$this
->
dsql
->
SQuy
(
$quy
);

274 
	g$this
->
	gdsql
->
Execu
('al');

275 
	g$row
 = 
$this
->
PageSize
 / 
$c
;

276 
	g$i
 = '';

277 
	g$this
->
	gd2
->
LdSour
(
$ùext
);

278 
	g$GLOBALS
['autoindex'] = 0;

279 
	g$i
=0;$i<
	g$row
;$i++)

281 if(
	g$c
>1)

283 
	g$i
 .= "<div>\r\n";

285 
	g$j
=0;$j<
	g$c
;$j++)

287 if(
	g$row
 = 
$this
->
dsql
->
GAay
("al"))

289 
$GLOBALS
['autoindex']++;

290 
	g$ids
[
$row
['id']] = $row['id'];

293 
	g$row
['fos'] = 
_subr
(
$row
['desti'],
$fޒ
);

294 
	g$row
['id'] = 
$row
['id'];

295 
	g$row
['cu'] = 
GFeU
(
$row
['id'],$row['typeid'],$row['senddate'],$row['title'],

296 
$row
['ismake'],

297 
$row
['arcrank'],$row['namerule'],$row['typedir'],$row['money'],

298 
$row
['filename'],$row['moresite'],$row['siteurl'],$row['sitepath']);

299 
	g$row
['tyu'] = 
GTyU
(
$row
['tyid'],
MfTyd
($row['typedir']),$row['isdefault'],$row['defaultname'],

300 
$row
['ispart'],$row['namerule2'],$row['moresite'],$row['siteurl'],$row['sitepath']);

301 if(
	g$row
['lpic'] ='-' || 
$row
['litpic'] == '')

303 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

305 if(!
egi
("^hp://",
$row
['lpic']&& 
	g$GLOBALS
['cfg_multi_site'] == 'Y')

307 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

309 
	g$row
['piame'] = 
$row
['litpic'];

310 
	g$row
['ime'] = 
GDeMK
(
$row
['pubdate']);

311 
	g$row
['tylk'] = "<hf='".
$row
['typeurl']."'>".$row['typename']."</a>";

312 
	g$row
['image'] = "<img src='".
$row
['piame']."' bd='0' width='$imgwidth' height='$imgheight'='".
eg_a
("['><]","",$row['title'])."'>";

313 
	g$row
['imglk'] = "<hf='".
$row
['filename']."'>".$row['image']."</a>";

314 
	g$row
['fut'] = 
$row
['title'];

315 
	g$row
['t'] = 
_subr
(
$row
['t'],
$tn
);

316 if(
	g$row
['color']!='')

318 
$row
['title'] = "<font color='".$row['color']."'>".$row['title']."</font>";

320 if(
eg
('c',
$row
['flag']))

322 
	g$row
['t'] = "<b>".
$row
['title']."</b>";

324 
	g$row
['xk'] = "<hf='".
$row
['filename']."'>".$row['title']."</a>";

325 
	g$row
['usu'] = 
$row
['phpu'] = 
$GLOBALS
['cfg_phpurl'];

326 
	g$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

327 
	g$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

328 if(
is_y
(
$this
->
d2
->
CTags
))

330 
fܗch
(
$this
->
d2
->
CTags
 
as
 
$k
=>
$ag
)

332 if(
$ag
->
GName
()=='array')

335 
$this
->
d2
->
Assign
(
$k
,
$row
);

339 if(
ist
(
$row
[
$ag
->
GName
()]))

341 
	g$this
->
	gd2
->
Assign
(
$k
,
$row
[
$ag
->
GName
()]);

345 
	g$this
->
	gd2
->
Assign
(
$k
,'');

350 
	g$i
 .
$this
->
d2
->
GResu
();

355 if(
	g$c
>1)

357 
	g$i
 +
$c
 - 1;

358 
	g$i
 .= " </div>\r\n";

362 
	g$this
->
	gdsql
->
FeResu
('al');

363  
	g$i
;

367 
funi
 
GPageLiDM
(
$li_n
,
$liem
="info,index,end,pre,next,pageno")

369 
$age
="";

370 
	g$xage
="";

371 
	g$agum
 = 
$this
->
PageNo
-1;

372 
	g$xagum
 = 
$this
->
PageNo
+1;

373 if(
	g$li_n
==""||
eg
("[^0-9]",
$li_n
))

375 
	g$li_n
=3;

377 
	g$tٮge
 = 
$this
->
TٮPage
;

378 if(
	g$tٮge
<=1 && 
$this
->
TٮResu
>0)

380  "< css=\"gefo\">共1页/".
$this
->
TٮResu
."条</span>";

382 if(
	g$this
->
	gTٮResu
 == 0)

384  "< css=\"gefo\">共0页/".
$this
->
TٮResu
."条</span>";

386 
	g$mafo
 = "< css=\"gefo\">共{$tٮge}页/".
$this
->
TٮResu
."条</span>\r\n";

387 
	g$pu
 = 
$this
->
GCurU
();

388 
	g$pu
 ."?/".
ucode
(
$this
->
Tag
);

391 if(
	g$this
->
	gPageNo
 != 1)

393 
$age
.="<li><hf='".
$pu
."/$prepagenum/'>上一页</a></li>\r\n";

394 
	g$dexge
="<li><hf='".
$pu
."/1/'>首页</a></li>\r\n";

398 
	g$dexge
="<li><a>首页</a></li>\r\n";

400 if(
	g$this
->
	gPageNo
!=
$tٮge
 && $totalpage>1)

402 
$xage
.="<li><hf='".
$pu
."/$nextpagenum/'>下一页</a></li>\r\n";

403 
	g$dge
="<li><hf='".
$pu
."/$totalpage/'>末页</a></li>\r\n";

407 
	g$dge
="<li><a>末页</a></li>\r\n";

411 
	g$lidd
="";

412 
	g$tٮ_li
 = 
$li_n
 * 2 + 1;

413 if(
	g$this
->
	gPageNo
 >
$tٮ_li
)

415 
$j
 = 
$this
->
PageNo
-
$li_n
;

416 
	g$tٮ_li
 = 
$this
->
PageNo
+
$li_n
;

417 if(
	g$tٮ_li
>
	g$tٮge
)

419 
	g$tٮ_li
=
$tٮge
;

424 
	g$j
=1;

425 if(
	g$tٮ_li
>
	g$tٮge
)

427 
	g$tٮ_li
=
$tٮge
;

430 
	g$j
;$j<=
$tٮ_li
;$j++)

432 if(
	g$j
==
$this
->
PageNo
)

434 
$lidd
.= "<li class=\"thisclass\"><a>$j</a></li>\r\n";

438 
	g$lidd
.="<li><hf='".
$pu
."/$j/'>".
$j
."</a></li>\r\n";

441 
	g$i
 = '';

442 if(
egi
('fo',
$liem
))

444 
	g$i
 .
$mafo
.' ';

446 if(
egi
('dex',
$liem
))

448 
	g$i
 .
$dexge
.' ';

450 if(
egi
('e',
$liem
))

452 
	g$i
 .
$age
.' ';

454 if(
egi
('go',
$liem
))

456 
	g$i
 .
$lidd
.' ';

458 if(
egi
('xt',
$liem
))

460 
	g$i
 .
$xage
.' ';

462 if(
egi
('d',
$liem
))

464 
	g$i
 .
$dge
.' ';

466  
	g$i
;

470 
funi
 
GLiU
(
$tyid
,
$tyd
,
$isdeu
,
$deume
,
$it
,
$mu2
,
$seu
="")

472  
GTyU
(
$tyid
,
MfTyd
(
$tyd
),
$isdeu
,
$deume
,
$it
,
$mu2
,
$seu
);

476 
funi
 
GArcU
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
=0,
$nk
=0,
$mu
="",
$td
="",
$mey
=0,
$fame
='')

478  
GFeU
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
,
$nk
,
$mu
,
$td
,
$mey
,
$fame
);

482 
funi
 
	$GCurU
()

484 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

486 
$nowu
 = 
$_SERVER
["REQUEST_URI"];

487 
$nowus
 = 
	`exode
("?",
$nowu
);

488 
$nowu
 = 
$nowus
[0];

492 
$nowu
 = 
$_SERVER
["PHP_SELF"];

494  
$nowu
;

495 
	}
}

	@include/archives.func.php

1 <?
php


3 if(!
defed
('DEDEINC'))

5 
ex
("Request Error!");

9 
funi
 
	$GIndexKey
(
$k
,
$tyid
,
$s܌k
=0,
$chlid
=1,
$ndde
=0,
$mid
=1)

11 
glob
 
$dsql
,
$ndde
,
$tyid2
;

12 if(
	`emy
(
$tyid2
)) $typeid2 = 0;

13 if(
	`emy
(
$ndde
)$ndd
	`time
();

14 if(
	`emy
(
$s܌k
)$s܌k = 
$ndde
;

15 
$iquy
 = "

16 
INSERT
 
INTO
 `#@
__y
` (`
k
`,`
tyid
`,`
chl
`,`
ndde
`, `
s܌k
`, `
mid
`)

17 
	`VALUES
 ('$arcrank','$typeid', '$channelid','$senddate', '$sortrank', '$mid') ";

18 
$dsql
->
	`ExecuNeQuy
(
$iquy
);

19 
$aid
 = 
$dsql
->
	`GLaID
();

20 
$dsql
->
	`ExecuNeQuy
(" Update `#@__arctiny` set `typeid2`='$typeid2' where id = '$aid' ");

21  
$aid
;

22 
	}
}

25 
funi
 
UpIndexKey
(
$id
,
$k
,
$tyid
,
$s܌k
=0,
$gs
='')

27 
glob
 
$dsql
,
$tyid2
;

28 if(
emy
(
$tyid2
)
	g$tyid2
 = 0;

29 
	g$addtime
 = 
time
();

30 
	g$quy
 = " Update `#@__arctiny` set `arcrank`='$arcrank', `typeid`='$typeid',`sortrank`='$sortrank' where id = '$id' ";

31 
	g$dsql
->
ExecuNeQuy
(
$quy
);

32 
	g$quy
 = " Update `#@__arctiny` set `typeid2`='$typeid2' where id = '$id' ";

33 
	g$dsql
->
ExecuNeQuy
(
$quy
);

38 if(
	g$gs
!='')

40 
$dg
 = 
GTags
(
$id
);

41 
	g$dgs
 = 
exode
(',',
$dg
);

42 
	g$gss
 = 
exode
(',',
$gs
);

43 
fܗch
(
$gss
 
as
 
$g
)

45 
	g$g
 = 
im
(
$g
);

46 if(
ist
(
$g
[12]|| 
	g$g
!=
rashes
($tag))

50 if(!
_y
(
$g
,
$dgs
))

52 
InOTag
(
$g
,
$id
);

55 
fܗch
(
$dgs
 
as
 
$g
)

57 if(!
_y
(
$g
,
$gss
))

59 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__taglist` whereid='$id' Andagike '$tag' ");

60 
	g$dsql
->
ExecuNeQuy
("Update `#@__tagindex` setotal=total-1 whereagike '$tag' ");

64 
	g$dsql
->
ExecuNeQuy
("Update `#@__taglist` set `arcrank` = '$arcrank', `typeid` = '$typeid' whereagike '$tag' ");

73 
funi
 
	$InTags
(
$g
,
$aid
)

75 
$gs
 = 
	`exode
(',',
$g
);

76 
	`fܗch
(
$gs
 
as
 
$g
)

78 
$g
 = 
	`im
($tag);

79 if(
	`ist
(
$g
[20]|| $g!=
	`rashes
($tag))

83 
	`InOTag
(
$g
,
$aid
);

85 
	}
}

90 
funi
 
	$InOTag
(
$g
,
$aid
)

92 
glob
 
$tyid
,
$k
,
$dsql
;

93 
$g
 = 
	`im
($tag);

94 if(
$g
 == '')

98 if(
	`emy
(
$tyid
))

100 
$tyid
 = 0;

102 if(
	`emy
(
$k
))

104 
$k
 = 0;

106 
$rs
 = 
l
;

107 
$addtime
 = 
	`time
();

108 
$row
 = 
$dsql
->
	`GO
("Select * From `#@__tagindex` whereagike '$tag' ");

109 if(!
	`is_y
(
$row
))

111 
$rs
 = 
$dsql
->
	`ExecuNeQuy
(" Insert Into `#@__tagindex`(`tag`,`typeid`,`count`,`total`,`weekcc`,`monthcc`,`weekup`,`monthup`,`addtime`) values('$tag','$typeid','0','1','0','0','$addtime','$addtime','$addtime'); ");

112 
$tid
 = 
$dsql
->
	`GLaID
();

116 
$rs
 = 
$dsql
->
	`ExecuNeQuy
(" Update `#@__tagindex` setotal=total+1,addtime=$addtime whereagike '$tag' ");

117 
$tid
 = 
$row
['id'];

119 if(
$rs
)

121 
$dsql
->
	`ExecuNeQuy
("Insert Into `#@__taglist`(`tid`,`aid`,`arcrank`,`typeid` , `tag`) values('$tid','$aid','$arcrank','$typeid' , '$tag'); ");

123 
	}
}

	@include/channelunit.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/dedetag.class.php");

7 
que_
(
DEDEINC
."/channelunit.func.php");

12 as
	cChlUn


14 
v
 
	m$ChlInfos
;

15 
v
 
	m$ChlFlds
;

16 
v
 
	m$AFldNames
;

17 
v
 
	m$ChlID
;

18 
v
 
	m$ArcID
;

19 
v
 
	m$dsql
;

20 
v
 
	m$SPageFld
;

23 
funi
 
	$__cڡru
(
$cid
,
$aid
=0)

25 
$this
->
ChlInfos
 = '';

26 
$this
->
ChlFlds
 = '';

27 
$this
->
AFldNames
 = '';

28 
$this
->
SPageFld
 = '';

29 
$this
->
ChlID
 = 
$cid
;

30 
$this
->
ArcID
 = 
$aid
;

31 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

32 
$sql
 = " Select * from `#@__channeltype` where id='$cid' ";

33 
$this
->
ChlInfos
 = $this->
dsql
->
	`GO
(
$sql
);

34 if(!
	`is_y
(
$this
->
ChlInfos
))

36 
echo
 '读取频道信息失败，无法进行后续操作！';

37 
	`ex
();

39 
$d
 = 
w
 
	`DedeTagP
();

40 
$d
->
	`SNameS
('field','<','>');

41 
$d
->
	`LdSour
(
$this
->
ChlInfos
['fieldset']);

42 if(
	`is_y
(
$d
->
CTags
))

44 
$ames
 = 
	`Aay
();

45 
	`fܗch
(
$d
->
CTags
 
as
 
$ag
)

47 
$ame
 = 
$ag
->
	`GName
();

48 if(
	`ist
(
$ames
[
$ame
]))

52 
$ames
[
$ame
] = 1;

53 if(
$this
->
AFldNames
!='')

55 
$this
->
AFldNames
 .','.
$ame
;

59 
$this
->
AFldNames
 .
$ame
;

61 if(
	`is_y
(
$ag
->
CAribu
->
Ims
))

63 
$this
->
ChlFlds
[
$ame
] = 
$ag
->
CAribu
->
Ims
;

65 
$this
->
ChlFlds
[
$ame
]['value'] = '';

66 
$this
->
ChlFlds
[
$ame
]['ùext'] = 
$ag
->
	`GIText
();

67 if(
	`emy
(
$this
->
ChlFlds
[
$ame
]['itemname']))

69 
$this
->
ChlFlds
[
$ame
]['itemname'] = $tname;

71 if(
$ag
->
	`GA
('page')=='split')

73 
$this
->
SPageFld
 = 
$ame
;

77 
$d
->
	`Cˬ
();

80 
funi
 
	$ChlUn
(
$cid
,
$aid
=0)

82 
$this
->
	`__cڡru
(
$cid
,
$aid
);

83 
	}
}

86 
funi
 
	$SArcID
(
$aid
)

88 
$this
->
ArcID
 = 
$aid
;

89 
	}
}

92 
funi
 
MakeFld
(
$ame
, 
$fvue
, 
$addvue
='')

94 if(
$fvue
=='')

96 
$fvue
 = 
$this
->
ChlFlds
[
$ame
]['default'];

100 
	g$y
 = 
$this
->
ChlFlds
[
$ame
]['type'];

101 if(
	g$y
=='text')

103 
$fvue
 = 
HtmlR
($fvalue);

105 if(
	g$y
=='textdata')

107 if(!
is_fe
(
$GLOBALS
['cfg_bad'].
$fvue
))

111 
	g$
 = 
fݒ
(
$GLOBALS
['cfg_bad'].
$fvue
,'r');

112 
	g$fvue
 = '';

113 !
of
(
$
))

115 
	g$fvue
 .
fgs
(
$
,1024);

117 
fo
(
$
);

119 if(
	g$y
=='addon')

121 
$fdvue
 = 
$fvue
;

122 
	g$tmext
 = 
GSysTems
("channel_addon.htm");

123 
	g$fvue
 = 
r_a
('~lk~',
$fdvue
,
$tmext
);

124 
	g$fvue
 = 
r_a
('~phpu~',
$GLOBALS
['cfg_phpu'],
$fvue
);

126 if(
fe_exis
(
DEDEINC
.'/glib/chl/'.
$y
.'.lib.php'))

128 
ude_
(
DEDEINC
.'/glib/chl/'.
$y
.'.lib.php');

129 
	g$func
 = 'ch_'.
$y
;

130 
	g$fvue
 = 
$func
(
$fvue
,
$addvue
,
$this
,
$ame
);

132  
	g$fvue
;

136 
funi
 
	$Clo
()

138 
	}
}

	@include/channelunit.func.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 if(!
	$ist
(
$cfg_mase
)
	`exa
(
$GLOBALS
, 
EXTR_SKIP
);

5 
glob
 
$PubFlds
,
$pTyAays
,
$idAy
,
$vs
,
$v1
,
$v2
;

7 
$pTyAays
 = 
$idAy
 = 
$PubFlds
 = 
$vs
 = 
	`y
();

8 
$PubFlds
['phpu'] = 
$cfg_phpu
;

9 
$PubFlds
['dexu'] = 
$cfg_mase
.
$cfg_dexu
;

10 
$PubFlds
['mu'] = 
$cfg_mu
;

11 
$PubFlds
['membu'] = 
$cfg_membu
;

12 
$PubFlds
['ecu'] = 
$cfg_eclu
;

13 
$PubFlds
['dexme'] = 
$cfg_dexme
;

14 
$PubFlds
['mdef'] = 
$cfg_ms_d
.'/'.
$cfg_df_y
;

15 
$vs
['typeid'] = 0;

16 
$vs
['reid'] = 0;

17 
$vs
['aid'] = 0;

18 
$vs
['keyword'] = '';

19 
$vs
['idlist'] = '';

23 
funi
 
	$GRkSr
(
$nk
)

25 
$n
 = "";

26 
$i
=1;$i<=
$nk
;$i++)

28 
$n
 .= "★";

30 
$i
;$i<=5;$i++)

32 
$n
 .= "☆";

34  
$n
;

35 
	}
}

43 
funi
 
GFeU
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
=0,
$nk
=0,
$mu
='',
$tyd
='',

44 
$mey
=0, 
$fame
='',
$mese
=0,
$seu
='',
$sh
='')

46 
$tieU
 = 
GFeName
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
,
$nk
,
$mu
,
$tyd
,
$mey
,
$fame
);

47 
	g$sh
 = 
MfTyd
(
$sh
);

50 if(
	g$GLOBALS
['cfg_multi_site']=='Y')

52 if(
$seu
=='')

54 
$seu
 = 
$GLOBALS
['cfg_basehost'];

56 if(
	g$mese
==1)

58 
$tieU
 = 
eg_a
("^".
$sh
,'',$articleUrl);

60 if(!
eg
('hp:',
$tieU
))

62 
	g$tieU
 = 
$seu
.
$tieU
;

66  
	g$tieU
;

70 
funi
 
GFeNewName
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
=0,
$nk
=0,
$mu
='',
$tyd
='',
$mey
=0,
$fame
='')

72 
glob
 
$cfg_c_dme
;

73 
	g$tiame
 = 
GFeName
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
,
$nk
,
$mu
,
$tyd
,
$mey
,
$fame
);

75 if(
eg
("\?",
$tiame
))

77  
	g$tiame
;

80 if(
	g$cfg_c_dme
=='Y' && 
eg
("/$", 
$tiame
))

82 
	g$tiame
 = 
$tiame
."index.html";

85 
	g$
 = 

(
$tiame
)-1;

86 
	g$i
=
$
;$i>=0;$i--)

88 if(
	g$tiame
[
$i
]=='/')

90 
$subpos
 = 
$i
;

94 
	g$okd
 = 
subr
(
$tiame
,0,
$subpos
);

95 
CeD
(
$okd
);

96  
	g$tiame
;

100 
funi
 
GFeName
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
=0,
$nk
=0,
$mu
='',
$tyd
='',
$mey
=0,
$fame
='')

102 
glob
 
$cfg_wre
, 
$cfg_cmh
, 
$cfg_cd
, 
$cfg_ecl
, 
$cfg_c_dme
;

104 if(
emy
(
$mu
)) {

105 
	g$mu
 = 
$cfg_ecl
.'/arc-{aid}.html';

106 
	g$tyid
 = -1;

108 if(
	g$nk
!=0 || 
$ismake
==-1 || 
$tyid
==0 || 
$mey
>0)

111 if(
$cfg_wre
 == 'Y')

113  
$GLOBALS
["cfg_us_d"]."/vw-".
$aid
.'-1.html';

117  
	g$GLOBALS
['cfg_phpurl']."/view.php?aid=$aid";

122 
	g$tieD
 = 
MfTyd
(
$tyd
);

123 
	g$tieRu
 = 
ow
(
$mu
);

124 if(
	g$tieRu
=='')

126 
$tieRu
 = 
ow
(
$GLOBALS
['cfg_df_namerule']);

128 if(
	g$tyd
=='')

130 
$tieD
 = 
$GLOBALS
['cfg_cmspath'].$GLOBALS['cfg_arcdir'];

132 
	g$dtime
 = 
GDeMk
(
$timag
);

133 
li
(
$y
,
$m
,
$d

exode
('-',
$dtime
);

134 
	g$r_sour
 = 
y
('{typedir}','{y}','{m}','{d}','{timestamp}','{aid}','{cc}');

135 
	g$r_vues
 = 
y
(
$tieD
,
$y
, 
$m
, 
$d
, 
$timag
, 
$aid
, 
dd2ch
($m.$d.$aid.$y));

136 if(
	g$fame
 != '')

138 
$tieRu
 = 
dme
($tieRu).'/'.
$fame
.
$GLOBALS
['cfg_df_ext'];

140 
	g$tieRu
 = 
r_a
(
$r_sour
,
$r_vues
,
$tieRu
);

141 if(
eg
('\{p',
$tieRu
))

143 
	g$tieRu
 = 
r_a
('{py}',
GPy
(
$t
).'_'.
$aid
,
$tieRu
);

144 
	g$tieRu
 = 
r_a
('{py}',
GPy
(
$t
,1).'_'.
$aid
,
$tieRu
);

146 
	g$tieU
 = '/'.
eg_a
('^/','',
$tieRu
);

147 if(
eg
("dex\.html", 
$tieU
&& 
	g$cfg_c_dme
=='Y')

149 
$tieU
 = 
r_a
('index.html', '', $articleUrl);

151  
	g$tieU
;

157 
funi
 
GTyU
(
$tyid
,
$tyd
,
$isdeu
,
$deume
,
$it
,
$mu2
,
$mese
=0,
$seu
='',
$sh
='')

159 
glob
 
$cfg_tyd_df
;

160 
	g$tyd
 = 
MfTyd
(
$tyd
);

161 
	g$sh
 = 
MfTyd
(
$sh
);

162 if(
	g$isdeu
==-1)

165 
$u
 = 
$GLOBALS
['cfg_phpu']."/li.php?tid=".
$tyid
;

167 if(
	g$it
==2)

170 
$u
 = 
$tyd
;

171  
	g$u
;

175 if(
	g$isdeu
==0 && 
$it
==0)

177 
$u
 = 
r_a
("{ge}","1",
$mu2
);

178 
	g$u
 = 
r_a
("{tid}",
$tyid
,
$u
);

179 
	g$u
 = 
r_a
("{tyd}",
$tyd
,
$u
);

183 if(
	g$cfg_tyd_df
=='N' || 
$isdeu
==0
$u
 = 
$tyd
.'/'.
$deume
;

184 
	g$u
 = 
$tyd
.'/';

188 if!
egi
("^hp://",
$u
) ) {

189 
	g$u
 = 
eg_a
("/{1,}",'/',
$u
);

192 if(
	g$GLOBALS
['cfg_multi_site']=='Y')

194 if(
$seu
=='') {

195 
$seu
 = 
$GLOBALS
['cfg_basehost'];

197 if(
	g$mese
==1 ) {

198 
$u
 = 
eg_a
("^".
$sh
,'',$reurl);

200 if!
egi
('^hp://', 
$u
) ) {

201 
	g$u
 = 
$seu
.
$u
;

204  
	g$u
;

208 
funi
 
	$MagicV
(
$v1
,
$v2
)

210  
$GLOBALS
['autodex']%2==0 ? 
$v1
 : 
$v2
;

211 
	}
}

214 
funi
 
	$GTids
(
$tid
)

216 
$r
 = 
	`GPtIds
(
$tid
);

217  
	`jo
(',',
$r
);

218 
	}
}

221 
funi
 
	$GPtIds
(
$tid
)

223 
glob
 
$_Cs
;

224 
$GLOBALS
['pTyAays'][] = 
$tid
;

225 if(!
	`is_y
(
$_Cs
))

227 
	`que_
(
DEDEROOT
."/data/cache/inc_catalog_base.inc");

229 if(!
	`ist
(
$_Cs
[
$tid
]) || $_Cs[$tid][0]==0)

231  
$GLOBALS
['pTypeArrays'];

235  
	`GPtIds
(
$_Cs
[
$tid
][0]);

237 
	}
}

240 
funi
 
	$IsPt
(
$sid
, 
$pid
)

242 
$pTyAays
 = 
	`GPtIds
(
$sid
);

243  
	`_y
(
$pid
, 
$pTyAays
);

244 
	}
}

247 
funi
 
	$GTid
(
$tid
)

249 
glob
 
$_Cs
;

250 if(!
	`is_y
(
$_Cs
))

252 
	`que_
(
DEDEROOT
."/data/cache/inc_catalog_base.inc");

254 if(!
	`ist
(
$_Cs
[
$tid
][0]) || $_Cs[$tid][0]==0)

256  
$tid
;

260  
	`GTid
(
$_Cs
[
$tid
][0]);

262 
	}
}

265 
funi
 
	$GSIds
(
$id
,
$chl
=0,
$addthis
=
ue
)

267 
glob
 
$_Cs
;

268 
$GLOBALS
['idAay'] = 
	`y
();

269 if!
	`is_y
(
$_Cs
) )

271 
	`que_
(
DEDEROOT
."/data/cache/inc_catalog_base.inc");

273 
	`GSIdsLogic
(
$id
,
$_Cs
,
$chl
,
$addthis
);

274 
$rquy
 = 
	`jo
(',',
$GLOBALS
['idArray']);

275  
$rquy
;

276 
	}
}

279 
funi
 
	$GSIdsLogic
(
$id
,
$sA
,
$chl
=0,
$addthis
=
l
)

281 if(
$id
!=0 && 
$addthis
)

283 
$GLOBALS
['idAay'][
$id
] = $id;

285 
	`fܗch
(
$sA
 
as
 
$k
=>
$v
)

287 if
$v
[0]==
$id
 && (
$chl
==0 || $v[1]==$channel ))

289 
	`GSIdsLogic
(
$k
,
$sA
,
$chl
,
ue
);

292 
	}
}

295 
funi
 
	$MfTyd
(
$tyd
)

297 if(
	`egi
("^hp:",
$tyd
))  $typedir;

298 
$tyd
 = 
	`r_a
("{cmh}",
$GLOBALS
['cfg_cmspath'],$typedir);

299 
$tyd
 = 
	`eg_a
("/{1,}","/",$typedir);

300  
$tyd
;

301 
	}
}

304 
funi
 
	$MfTem
(
$tmpd
)

306 
$tmpd
 = 
	`r_a
("{y}",
$GLOBALS
['cfg_df_style'],$tmpdir);

307 
$tmpd
 = 
	`eg_a
("/{1,}","/",$tmpdir);

308  
$tmpd
;

309 
	}
}

312 
funi
 
	$FmSt
(
$me
)

314  
$me
=='&nbsp;' ? '' : $atme;

315 
	}
}

318 
funi
 
	$FlAsDeu
(&
$ts
,
$i
)

320 
$is
 = 
	`exode
(',',
$i
);

321 
$i
=0;
	`ist
(
$is
[$i]);$i++)

323 
	`li
(
$k
,
$v

	`exode
('|',
$is
[
$i
]);

324 if(!
	`ist
(
$ts
[
$k
]))

326 
$ts
[
$k
] = 
$v
;

329 
	}
}

332 
funi
 
MakeOTag
(&
$d
, &
$fObj
, 
$rfld
='Y')

334 
$ags
 = 
y
();

335 
	g$d
->
tRefObj
(
$fObj
);

337 
	g$dh
 = 
d
(
DEDEINC
.'/taglib');

338 
	g$fame
 = 
$dh
->
ad
())

340 if(
eg
("\.lib\.",
$fame
))

342 
$ags
[] = 
r_a
('.lib.php','',
$fame
);

345 
	g$dh
->
Clo
();

348 if(!
is_y
(
$d
->
CTags
))

352 
fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

354 
$gme
 = 
$ag
->
GName
();

355 if(
	g$gme
=='fld' && 
$rfld
=='Y')

357 
$vme
 = 
$ag
->
GA
('name');

358 if
	g$vme
=='y' && 
ist
(
$fObj
->
Flds
) )

360 
$d
->
Assign
(
$gid
,
$fObj
->
Flds
);

362 if(
ist
(
$fObj
->
Flds
[
$vme
]))

364 
	g$d
->
Assign
(
$gid
,
$fObj
->
Flds
[
$vme
]);

366 if(
	g$ag
->
GA
('noteid') != '')

368 if
ist
(
$fObj
->
Flds
[
$vme
.'_'.
$ag
->
GA
('noteid')]) )

370 
$d
->
Assign
(
$gid
, 
$fObj
->
Flds
[
$vme
.'_'.
$ag
->
GA
('noteid')]);

377 if(
eg
("^׹li|lik|h٬t|imgli|imgfi|coެt|e|auti)$",
$gme
))

379 
	g$gme
='arclist';

381 if(
	g$gme
=='friendlink')

383 
$gme
='flink';

385 if(
_y
(
$gme
,
$ags
))

387 
	g$fame
 = 
DEDEINC
.'/glib/'.
$gme
.'.lib.php';

388 
ude_
(
$fame
);

389 
	g$funame
 = 'lib_'.
$gme
;

390 
	g$d
->
Assign
(
$gid
,
$funame
(
$ag
,
$fObj
));

396 
funi
 
	$GOTyUA
(
$tyfos
)

398  
	`GTyU
(
$tyfos
['id'],
	`MfTyd
($typeinfos['typedir']),$typeinfos['isdefault'],$typeinfos['defaultname'],

399 
$tyfos
['ispart'],$typeinfos['namerule2'],$typeinfos['moresite'],$typeinfos['siteurl'],$typeinfos['sitepath']);

400 
	}
}

403 
funi
 
SSysEnv
(
$tyid
=0,
$tyme
='',
$aid
=0,
$t
='',
$curfe
='')

405 
glob
 
$_sys_globs
;

406 if(
emy
(
$_sys_globs
['curfile']))

408 
	g$_sys_globs
['curfe'] = 
$curfe
;

410 if(
emy
(
$_sys_globs
['typeid']))

412 
	g$_sys_globs
['tyid'] = 
$tyid
;

414 if(
emy
(
$_sys_globs
['typename']))

416 
	g$_sys_globs
['tyme'] = 
$tyme
;

418 if(
emy
(
$_sys_globs
['aid']))

420 
	g$_sys_globs
['aid'] = 
$aid
;

425 
funi
 
	$GBookU
(
$bid
,
$t
,
$gd
=0)

427 
glob
 
$cfg_cmh
;

428 
$booku
 = 
$gd
==1 ?

429 "{$cfg_cmh}/book/".
	`DedeID2D
(
$bid
: "{$cfg_cmh}/book/".DedeID2D($bid).'/'.
	`GPy
(
$t
).'-'.$bid.'.html';

430  
$booku
;

431 
	}
}

434 
funi
 
	$DedeID2D
(
$aid
)

436 
$n
 = 
	`
(
$aid
 / 1000);

437  
$n
;

438 
	}
}

441 
funi
 
	$GFeLiU
(
$lid
,
$mu
,
$lid
,
$deuɷge
,
$nodeu
){

442 
$lid
 = 
	`r_a
('{cmh}',
$GLOBALS
['cfg_cmspath'],$listdir);

443 if(
$nodeu
==1)

445 
$okfe
 = 
	`r_a
('{ge}','1',
$mu
);

446 
$okfe
 = 
	`r_a
('{liid}',
$lid
,$okfile);

447 
$okfe
 = 
	`r_a
('{lid}',
$lid
,$okfile);

451 
$okfe
 = 
$GLOBALS
['cfg_phpurl']."/freelist.php?lid=$lid";

452  
$okfe
;

454 
$okfe
 = 
	`r_a
("\\","/",$okfile);

455 
$okfe
 = 
	`r_a
("//","/",$okfile);

456 
$ueFe
 = 
$GLOBALS
['cfg_bad'].
$okfe
;

457 if(!@
	`fe_exis
(
$ueFe
))

459 
$okfe
 = 
$GLOBALS
['cfg_phpurl']."/freelist.php?lid=$lid";

461  
$okfe
;

462 
	}
}

465 
funi
 
GHKeywds
(&
$dsql
,
$num
=8,
$nday
=365,
$kn
=16,
$dby
='count')

467 
glob
 
$cfg_phpu
,
$cfg_cmh
;

468 
	g$nowtime
 = 
time
();

469 
	g$num
 = @
tv
(
$num
);

470 
	g$nday
 = @
tv
(
$nday
);

471 
	g$kn
 = @
tv
(
$kn
);

472 if(
emy
(
$nday
))

474 
	g$nday
 = 365;

476 if(
emy
(
$num
))

478 
	g$num
 = 6;

480 if(
emy
(
$kn
))

482 
	g$kn
 = 16;

484 
	g$kn
 = 
$kn
+1;

485 
	g$mtime
 = 
$nowtime
 - (
$nday
 * 24 * 3600);

486 if(
emy
(
$dby
))

488 
	g$dby
 = 'count';

490 
	g$dsql
->
SQuy
("Select keyword From #@__search_keywords whereasttime>$mintime Andength(keyword)<$klen order by $orderby descimit 0,$num");

491 
	g$dsql
->
Execu
('hw');

492 
	g$hwd
 = "";

493 
	g$row
=
$dsql
->
GAay
('hw'))

495 
$hwd
 ."　<hf='".
$cfg_phpu
."/ch.php?keywd=".
ucode
(
$row
['keyword'])."&searchtype=titlekeyword'>".$row['keyword']."</a> ";

497  
	g$hwd
;

501 
funi
 
	$Gmu
(
$gu
)

503  
	`egi
("hp://",
$gu
? $gu : 
$GLOBALS
['cfg_basehost'].$gurl;

504 
	}
}

507 
funi
 
	$Que_a
(
$que
)

509 
$que
 = 
	`r_a
('{quote}','<div class="decmt-box">',$quote);

510 
$que
 = 
	`r_a
('{title}','<div class="decmt-title"><span class="username">',$quote);

511 
$que
 = 
	`r_a
('{/title}','</span></div>',$quote);

512 
$que
 = 
	`r_a
('&lt;br/&gt;','<br>',$quote);

513 
$que
 = 
	`r_a
('{content}','<div class="decmt-content">',$quote);

514 
$que
 = 
	`r_a
('{/content}','</div>',$quote);

515 
$que
 = 
	`r_a
('{/quote}','</div>',$quote);

516  
$que
;

517 
	}
}

520 
funi
 
	$GCacheBlock
(
$cheid
)

522 
glob
 
$cfg_pucche_time
;

523 
$chefe
 = 
DEDEDATA
.'/che/'.
$cheid
.'.inc';

524 if(!
	`fe_exis
(
$chefe
|| 
	`fesize
($cachefile)==0 ||

525 
$cfg_pucche_time
==0 || 
	`time
(- 
	`femtime
(
$chefe
) > $cfg_puccache_time)

529 
$
 = 
	`fݒ
(
$chefe
, 'r');

530 
$r
 = @
	`d
(
$
, 
	`fesize
(
$chefe
));

531 
	`fo
(
$
);

532  
$r
;

533 
	}
}

535 
funi
 
	$WreCacheBlock
(
$cheid
, 
$r
)

537 
$chefe
 = 
DEDEDATA
.'/che/'.
$cheid
.'.inc';

538 
$
 = 
	`fݒ
(
$chefe
, 'w');

539 
$r
 = 
	`fwre
(
$
, $str);

540 
	`fo
(
$
);

541 
	}
}

	@include/charset.func.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('dedecms');

7 
	g$UC2GBTABLE
 = 
$CODETABLE
 = 
$BIG5_DATA
 = 
$GB_DATA
 = '';

8 
	g$GbkUniDic
 = 
nu
;

11 
funi
 
	$utf82gb
(
$utfr
)

13 if(
	`funi_exis
('iconv'))

15  
	`icv
('utf-8','gbk//igne',
$utfr
);

17 
glob
 
$UC2GBTABLE
;

18 
$okr
 = "";

19 if(
	`im
(
$utfr
)=="")

21  
$utfr
;

23 if(
	`emy
(
$UC2GBTABLE
))

25 
$fame
 = 
DEDEINC
."/data/gb2312-utf8.dat";

26 
$
 = 
	`fݒ
(
$fame
,"r");

27 
$l
 = 
	`fgs
(
$
,15))

29 
$UC2GBTABLE
[
	`hexdec
(
	`subr
(
$l
, 7, 6))] = hexdec(substr($l, 0, 6));

31 
	`fo
(
$
);

33 
$okr
 = "";

34 
$un
 = 
	`
(
$utfr
);

35 
$i
=0;$i<
$un
;$i++)

37 
$c
 = 
$utfr
[
$i
];

38 
$cb
 = 
	`decb
(
	`d
(
$utfr
[
$i
]));

39 if(
	`
(
$cb
)==8)

41 
$csize
 = 
	`os
(
	`decb
(
	`d
(
$cb
)),"0");

42 
$j
=0;$j < 
$csize
;$j++)

44 
$i
++; 
$c
 .
$utfr
[$i];

46 
$c
 = 
	`utf82u
($c);

47 if(
	`ist
(
$UC2GBTABLE
[
$c
]))

49 
$c
 = 
	`dechex
(
$UC2GBTABLE
[$c]+0x8080);

50 
$okr
 .
	`chr
(
	`hexdec
(
$c
[0].$c[1])).chr(hexdec($c[2].$c[3]));

54 
$okr
 ."&#".
$c
.";";

59 
$okr
 .
$c
;

62 
$okr
 = 
	`im
($okstr);

63  
$okr
;

64 
	}
}

67 
funi
 
	$gb2utf8
(
$gbr
)

69 if(
	`funi_exis
('iconv'))

71  
	`icv
('gbk','utf-8//igne',
$gbr
);

73 
glob
 
$CODETABLE
;

74 if(
	`im
(
$gbr
)=="")

76  
$gbr
;

78 if(
	`emy
(
$CODETABLE
))

80 
$fame
 = 
DEDEINC
."/data/gb2312-utf8.dat";

81 
$
 = 
	`fݒ
(
$fame
,"r");

82 
$l
 = 
	`fgs
(
$
,15))

84 
$CODETABLE
[
	`hexdec
(
	`subr
(
$l
, 0, 6))] = substr($l, 7, 6);

86 
	`fo
(
$
);

88 
$t
 = "";

89 
$utf8
 = "";

90 
$gbr
 != '')

92 i(
	`d
(
	`subr
(
$gbr
, 0, 1)) > 0x80)

94 
$thisW
 = 
	`subr
(
$gbr
, 0, 2);

95 
$gbr
 = 
	`subr
($gbr, 2, 
	`
($gbstr));

96 
$utf8
 = "";

97 @
$utf8
 = 
	`u2utf8
(
	`hexdec
(
$CODETABLE
[hexdec(
	`b2hex
(
$thisW
)) - 0x8080]));

98 if(
$utf8
!="")

100 
$i
 = 0;$< 
	`
(
$utf8
);$i += 3)

101 
$t
 .
	`chr
(
	`subr
(
$utf8
, 
$i
, 3));

106 
$t
 .
	`subr
(
$gbr
, 0, 1);

107 
$gbr
 = 
	`subr
($gbr, 1, 
	`
($gbstr));

110  
$t
;

111 
	}
}

114 
funi
 
	$u2utf8
(
$c
)

116 
$i
 = 0;$< 
	`cou
(
$c
);$i++)

118 
$r
 = "";

120 i(
$c
 < 0x80)

122 
$r
 .
$c
;

124 i(
$c
 < 0x800)

126 
$r
 .(0xC0 | 
$c
 >> 6);

127 
$r
 .(0x80 | 
$c
 & 0x3F);

129 i(
$c
 < 0x10000)

131 
$r
 .(0xE0 | 
$c
 >> 12);

132 
$r
 .(0x80 | 
$c
 >> 6 & 0x3F);

133 
$r
 .(0x80 | 
$c
 & 0x3F);

135 i(
$c
 < 0x200000)

137 
$r
 .(0xF0 | 
$c
 >> 18);

138 
$r
 .(0x80 | 
$c
 >> 12 & 0x3F);

139 
$r
 .(0x80 | 
$c
 >> 6 & 0x3F);

140 
$r
 .(0x80 | 
$c
 & 0x3F);

142  
$r
;

143 
	}
}

146 
funi
 
	$utf82u
(
$c
)

148 
	`
(
$c
))

151  
	`d
(
$c
);

153 
$n
 = (
	`d
(
$c
[0]) & 0x3f) << 6;

154 
$n
 +
	`d
(
$c
[1]) & 0x3f;

155  
$n
;

157 
$n
 = (
	`d
(
$c
[0]) & 0x1f) << 12;

158 
$n
 +(
	`d
(
$c
[1]) & 0x3f) << 6;

159 
$n
 +
	`d
(
$c
[2]) & 0x3f;

160  
$n
;

162 
$n
 = (
	`d
(
$c
[0]) & 0x0f) << 18;

163 
$n
 +(
	`d
(
$c
[1]) & 0x3f) << 12;

164 
$n
 +(
	`d
(
$c
[2]) & 0x3f) << 6;

165 
$n
 +
	`d
(
$c
[3]) & 0x3f;

166  
$n
;

168 
	}
}

171 
funi
 
	$big52gb
(
$Text
)

173 if(
	`funi_exis
('iconv'))

175  
	`icv
('big5','gbk//igne',
$Text
);

177 
glob
 
$BIG5_DATA
;

178 if(
	`emy
(
$BIG5_DATA
))

180 
$fame
 = 
DEDEINC
."/data/big5-gb.dat";

181 
$
 = 
	`fݒ
(
$fame
, "rb");

182 
$BIG5_DATA
 = 
	`d
(
$
,
	`fesize
(
$fame
));

183 
	`fo
(
$
);

185 
$max
 = 
	`
(
$Text
)-1;

186 
$i
=0;$i<
$max
;$i++)

188 
$h
 = 
	`d
(
$Text
[
$i
]);

189 if(
$h
>=0x80)

191 
$l
 = 
	`d
(
$Text
[
$i
+1]);

192 if(
$h
==161 && 
$l
==64)

194 
$gbr
 = "　";

198 
$p
 = (
$h
-160)*510+(
$l
-1)*2;

199 
$gbr
 = 
$BIG5_DATA
[
$p
].$BIG5_DATA[$p+1];

201 
$Text
[
$i
] = 
$gbr
[0];

202 
$Text
[
$i
+1] = 
$gbr
[1];

203 
$i
++;

206  
$Text
;

207 
	}
}

210 
funi
 
	$gb2big5
(
$Text
)

212 if(
	`funi_exis
('iconv'))

214  
	`icv
('gbk','big5//igne',
$Text
);

216 
glob
 
$GB_DATA
;

217 if(
	`emy
(
$GB_DATA
))

219 
$fame
 = 
DEDEINC
."/data/gb-big5.dat";

220 
$
 = 
	`fݒ
(
$fame
, "rb");

221 
$gb
 = 
	`d
(
$
,
	`fesize
(
$fame
));

222 
	`fo
(
$
);

224 
$max
 = 
	`
(
$Text
)-1;

225 
$i
=0;$i<
$max
;$i++)

227 
$h
 = 
	`d
(
$Text
[
$i
]);

228 if(
$h
>=0x80)

230 
$l
 = 
	`d
(
$Text
[
$i
+1]);

231 if(
$h
==161 && 
$l
==64)

233 
$big
 = "　";

237 
$p
 = (
$h
-160)*510+(
$l
-1)*2;

238 
$big
 = 
$GB_DATA
[
$p
].$GB_DATA[$p+1];

240 
$Text
[
$i
] = 
$big
[0];

241 
$Text
[
$i
+1] = 
$big
[1];

242 
$i
++;

245  
$Text
;

246 
	}
}

249 
funi
 
	$UnicodeU2Gbk
(
$r
)

252 if(!
	`ist
(
$GLOBALS
['GbkUniDic']))

254 
$
 = 
	`fݒ
(
DEDEINC
.'/data/gbk-unicode.dat','rb');

255 !
	`of
(
$
))

257 
$GLOBALS
['GbkUniDic'][
	`b2hex
(
	`d
(
$
,2))] = fread($fp,2);

259 
	`fo
(
$
);

263 
$r
 = 
	`r_a
('$#$','+',$str);

264 
$gn
 = 
	`
(
$r
);

265 
$okr
 = "";

266 
$i
=0; $< 
$gn
; $i++)

268 if(
$gn
-
$i
 > 4)

270 if(
$r
[
$i
]=='%' && $str[$i+1]=='u')

272 
$uni
 = 
	`ow
(
	`subr
(
$r
,
$i
+2,4));

273 
$i
 = $i+5;

274 if(
	`ist
(
$GLOBALS
['GbkUniDic'][
$uni
]))

276 
$okr
 .
$GLOBALS
['GbkUniDic'][
$uni
];

280 
$okr
 ."&#".
	`hexdec
('0x'.
$uni
).";";

285 
$okr
 .
$r
[
$i
];

290 
$okr
 .
$r
[
$i
];

293  
$okr
;

294 
	}
}

	@include/common.func.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('dedecms');

4 
que_
(
DEDEINC
.'/charset.func.php');

7 
	g$pys
 = 
Aay
();

8 
	g$g_pLk
 = 
l
;

11 
funi
 
	$GCurU
()

13 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

15 
$stName
 = 
$_SERVER
["REQUEST_URI"];

16 
$nowu
 = 
$stName
;

20 
$stName
 = 
$_SERVER
["PHP_SELF"];

21 if(
	`emy
(
$_SERVER
["QUERY_STRING"]))

23 
$nowu
 = 
$stName
;

27 
$nowu
 = 
$stName
."?".
$_SERVER
["QUERY_STRING"];

30  
$nowu
;

31 
	}
}

34 if(!
funi_exis
('file_put_contents'))

36 
funi
 
fe_put_cڋs
(
$n
,
$d
)

38 
	g$f
=@
fݒ
(
$n
,"w");

39 i(!
	g$f
)

41  
	gl
;

45 
fwre
(
$f
,
$d
);

46 
fo
(
$f
);

47  
	gue
;

53 
funi
 
MyDe
(
$fm
='Y-m-d H:i:s',
$time
=0)

55 
glob
 
$cfg_i_time
;

56 
	g$addtime
 = 
$cfg_i_time
 * 3600;

57 if(
emy
(
$fm
))

59 
	g$fm
 = 'Y-m-d H:i:s';

61  
gmde
 (
$fm
,
$time
+
$addtime
);

64 
funi
 
	$GAbNum
(
$um
)

66 
$nums
 = 
	`y
("０","１","２","３","４","５","６","７","８","９");

68 
$ums
 = 
	`y
("0","1","2","3","4","5","6","7","8","9");

69 
$um
 = 
	`r_a
(
$nums
,
$ums
,$fnum);

70 
$um
 = 
	`eg_a
("[^0-9\.-]",'',$fnum);

71 if(
$um
=='')

73 
$um
=0;

75  
$um
;

76 
	}
}

78 
funi
 
	$Html2Text
(
$r
,
$r
=0)

80 if(!
	`funi_exis
('SpHtml2Text'))

82 
	`que_
(
DEDEINC
."/inc/inc_fun_funString.php");

84 if(
$r
==0)

86  
	`SpHtml2Text
(
$r
);

90 
$r
 = 
	`SpHtml2Text
(
	`rashes
($str));

91  
	`addashes
(
$r
);

93 
	}
}

96 
funi
 
	$Text2Html
(
$txt
)

98 
$txt
 = 
	`r_a
(" ","　",$txt);

99 
$txt
 = 
	`r_a
("<","&lt;",$txt);

100 
$txt
 = 
	`r_a
(">","&gt;",$txt);

101 
$txt
 = 
	`eg_a
("/[\r\n]{1,}/isU","<br/>\r\n",$txt);

102  
$txt
;

103 
	}
}

105 
funi
 
	$AjaxHd
()

107 @
	`hd
("Pragma:no-cache\r\n");

108 @
	`hd
("Cache-Control:no-cache\r\n");

109 @
	`hd
("Expires:0\r\n");

110 
	}
}

114 
funi
 
	$_subrR
(
$r
,
$
,
$tdd
=0)

116 
$r
 = 
	`_subr
(
	`rashes
($r),
$
,
$tdd
);

117  
	`addashes
(
$r
);

118 
	}
}

121 
funi
 
	$_subr
(
$r
,
$
,
$tdd
=0)

123 
glob
 
$cfg_so_ng
;

124 if(
$cfg_so_ng
=='utf-8')

126  
	`_subr_utf8
(
$r
,
$
,
$tdd
);

128 
$r
 = '';

129 
$c
 = '';

130 
$r_n
 = 
	`
(
$r
);

131 if(
$r_n
 < 
$tdd
+1)

135 if(
$r_n
 < 
$tdd
 + 
$
 || $slen==0)

137 
$
 = 
$r_n
 - 
$tdd
;

139 
$ddd
 = 
$tdd
 + 
$
 - 1;

140 
$i
=0;$i<
$r_n
;$i++)

142 if(
$tdd
==0)

144 
$r
 .
$c
;

146 if(
$i
 > 
$tdd
)

148 
$r
 .
$c
;

151 if(
	`d
(
$r
[
$i
])>0x80)

153 if(
$r_n
>
$i
+1)

155 
$c
 = 
$r
[
$i
].$str[$i+1];

157 
$i
++;

161 
$c
 = 
$r
[
$i
];

164 if(
$i
 >
$ddd
)

166 if(
	`
(
$r
)+(
$c
)>
$
)

172 
$r
 .
$c
;

177  
$r
;

178 
	}
}

181 
funi
 
	$_subr_utf8
(
$r
, 
$ngth
, 
$t
=0)

183 if(
	`
(
$r
< 
$t
+1)

187 
	`eg_mch_l
("/./su", 
$r
, 
$
);

188 
$r
 = '';

189 
$tr
 = '';

192 
$i
=0; 
	`ist
(
$
[0][$i]); $i++)

194 if(
	`
(
$tr
< 
$t
)

196 
$tr
 .
$
[0][
$i
];

200 if(
	`
(
$r
< 
$ngth
 + sn(
$
[0][
$i
]) )

202 
$r
 .
$
[0][
$i
];

210  
$r
;

211 
	}
}

213 
funi
 
	$GMkTime
(
$dtime
)

215 
glob
 
$cfg_i_time
;

216 if(!
	`eg
("[^0-9]",
$dtime
))

218  
$dtime
;

220 
$dtime
 = 
	`im
($dtime);

221 
$dt
 = 
	`Aay
(1970,1,1,0,0,0);

222 
$dtime
 = 
	`eg_a
("[\r\n\t]|日|秒"," ",$dtime);

223 
$dtime
 = 
	`r_a
("年","-",$dtime);

224 
$dtime
 = 
	`r_a
("月","-",$dtime);

225 
$dtime
 = 
	`r_a
("时",":",$dtime);

226 
$dtime
 = 
	`r_a
("分",":",$dtime);

227 
$dtime
 = 
	`im
(
	`eg_a
("[ ]{1,}"," ",$dtime));

228 
$ds
 = 
	`exode
(" ",
$dtime
);

229 
$ymd
 = 
	`exode
("-",
$ds
[0]);

230 if(!
	`ist
(
$ymd
[1]))

232 
$ymd
 = 
	`exode
(".",
$ds
[0]);

234 if(
	`ist
(
$ymd
[0]))

236 
$dt
[0] = 
$ymd
[0];

238 if(
	`ist
(
$ymd
[1]))

240 
$dt
[1] = 
$ymd
[1];

242 if(
	`ist
(
$ymd
[2]))

244 
$dt
[2] = 
$ymd
[2];

246 if(
	`
(
$dt
[0])==2)

248 
$dt
[0] = '20'.$dt[0];

250 if(
	`ist
(
$ds
[1]))

252 
$hms
 = 
	`exode
(":",
$ds
[1]);

253 if(
	`ist
(
$hms
[0]))

255 
$dt
[3] = 
$hms
[0];

257 if(
	`ist
(
$hms
[1]))

259 
$dt
[4] = 
$hms
[1];

261 if(
	`ist
(
$hms
[2]))

263 
$dt
[5] = 
$hms
[2];

266 
	`fܗch
(
$dt
 
as
 
$k
=>
$v
)

268 
$v
 = 
	`eg_a
("^0{1,}",'',
	`im
($v));

269 if(
$v
=='')

271 
$dt
[
$k
] = 0;

274 
$mt
 = @
	`gmmktime
(
$dt
[3],$dt[4],$dt[5],$dt[1],$dt[2],$dt[0]- 3600 * 
$cfg_i_time
;

275 if(!
	`emy
(
$mt
))

277  
$mt
;

281  
	`time
();

283 
	}
}

285 
funi
 
	$SubDay
(
$ime
,
$ime
)

287 
$day
 = 3600 * 24;

288 
$cday
 = 
	`
((
$ime
-
$ime
)/
$day
);

289  
$cday
;

290 
	}
}

292 
funi
 
	$AddDay
(
$ime
,
$aday
)

294 
$day
 = 3600 * 24;

295 
$oktime
 = 
$ime
 + (
$aday
 * 
$day
);

296  
$oktime
;

297 
	}
}

299 
funi
 
	$GDeTimeMk
(
$mktime
)

301  
	`MyDe
('Y-m-d H:i:s',
$mktime
);

302 
	}
}

304 
funi
 
	$GDeMk
(
$mktime
)

306  
	`MyDe
("Y-m-d",
$mktime
);

307 
	}
}

309 
funi
 
	$GIP
()

311 if(!
	`emy
(
$_SERVER
["HTTP_CLIENT_IP"]))

313 
$c
 = 
$_SERVER
["HTTP_CLIENT_IP"];

315 if(!
	`emy
(
$_SERVER
["HTTP_X_FORWARDED_FOR"]))

317 
$c
 = 
$_SERVER
["HTTP_X_FORWARDED_FOR"];

319 if(!
	`emy
(
$_SERVER
["REMOTE_ADDR"]))

321 
$c
 = 
$_SERVER
["REMOTE_ADDR"];

325 
$c
 = '';

327 
	`eg_mch
("/[\d\.]{7,15}/", 
$c
, 
$cs
);

328 
$c
 = 
	`ist
(
$cs
[0]) ? $cips[0] : 'unknown';

329 
	`unt
(
$cs
);

330  
$c
;

331 
	}
}

334 
funi
 
	$GPy
(
$r
,
$ishd
=0,
$iso
=1)

336 
glob
 
$cfg_so_ng
;

337 if(!
	`funi_exis
('SpGetPinyin'))

339 
	`que_
(
DEDEINC
."/inc/inc_fun_funAdmin.php");

341 if(
$cfg_so_ng
=='utf-8')

343  
	`SpGPy
(
	`utf82gb
(
$r
),
$ishd
,
$iso
);

347  
	`SpGPy
(
$r
,
$ishd
,
$iso
);

349 
	}
}

351 
funi
 
	$GNewInfo
()

353 if(!
	`funi_exis
('SpGetNewInfo'))

355 
	`que_
(
DEDEINC
."/inc/inc_fun_funAdmin.php");

357  
	`SpGNewInfo
();

358 
	}
}

360 
funi
 
	$UpdeSt
()

362 
	`ude_
(
DEDEINC
."/inc/inc_stat.php");

363  
	`SpUpdeSt
();

364 
	}
}

366 
	g$rs1
 = 
y
(0x63,0x66,0x67,0x5f,0x70,0x6f,0x77,0x65,0x72,0x62,0x79);

367 
	g$rs2
 = 
y
(0x20,0x3c,0x61,0x20,0x68,0x72,0x65,0x66,0x3d,0x68,0x74,0x74,0x70,0x3a,0x2f,0x2f,

372 
funi
 
	$ShowMsg
(
$msg
,
$gou
,
$lymsg
=0,
$limtime
=0)

374 if(
	`emy
(
$GLOBALS
['cfg_phpurl'])) $GLOBALS['cfg_phpurl'] = '..';

376 
$htmlhd
 = "<html>\r\n<head>\r\n<title>DEDECMS提示信息</title>\r\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=gb2312\" />\r\n";

377 
$htmlhd
 ."<bag='_lf'/>\r\n<y>div{le-height:160%;}</y></hd>\r\n<bodyemg='0'mg='0'>".(
	`ist
(
$GLOBALS
['ucsynlogin']) ? $GLOBALS['ucsynlogin'] : '')."\r\n<center>\r\n<script>\r\n";

378 
$htmlfo
 = "</script>\r\n</center>\r\n</body>\r\n</html>\r\n";

380 
$lime
 = (
$limtime
==0 ? 1000 : $limittime);

381 
$func
 = '';

383 if(
$gou
=='-1')

385 if(
$limtime
==0
$lime
 = 5000;

386 
$gou
 = "javascript:history.go(-1);";

389 if(
$gou
=='' || 
$lymsg
==1)

391 
$msg
 = "<st>t(\"".
	`r_a
("\"","“",$msg)."\");</script>";

396 if(
	`egi
('o::',
$gou
))

398 
$tgobj
 = 
	`im
(
	`egi_a
('o::', '', 
$gou
));

399 
$gou
 = 'javascript:;';

400 
$func
 .= "window.parent.document.getElementById('{$tgobj}').style.display='none';\r\n";

403 
$func
 .= " vargo=0;

404 
funi
 
	`JumpU
(){

405 if(
pgo
==0){ 
loti
='$gourl';go=1; }

406 }\
r
\
n
";

407 
$rmsg
 = 
$func
;

408 
$rmsg
 .= "document.write(\"<br /><div style='width:450px;padding:0px;border:1px solid #D1DDAA;'>";

409 
$rmsg
 .= "<div style='padding:6px;font-size:12px;border-bottom:1px solid #D1DDAA;background:#DBEEBD url({$GLOBALS['cfg_phpurl']}/img/wbg.gif)';'><b>DEDECMS 提示信息！</b></div>\");\r\n";

410 
$rmsg
 .= "document.write(\"<div style='height:130px;font-size:10pt;background:#ffffff'><br />\");\r\n";

411 
$rmsg
 ."documt.wre(\"".
	`r_a
("\"","“",
$msg
)."\");\r\n";

412 
$rmsg
 .= "document.write(\"";

414 if(
$lymsg
==0)

416 if
$gou
 != 'javascript:;' && $gourl != '')

418 
$rmsg
 .= "<br /><a href='{$gourl}'>如果你的浏览器没反应，请点击这里...</a>";

419 
$rmsg
 .= "<br/></div>\");\r\n";

420 
$rmsg
 .= "setTimeout('JumpUrl()',$litime);";

424 
$rmsg
 .= "<br/></div>\");\r\n";

429 
$rmsg
 .= "<br/><br/></div>\");\r\n";

431 
$msg
 = 
$htmlhd
.
$rmsg
.
$htmlfo
;

433 
echo
 
$msg
;

434 
	}
}

436 
funi
 
	$ExecTime
()

438 
$time
 = 
	`exode
(" ", 
	`miime
());

439 
$uc
 = ()
$time
[0];

440 
$c
 = ()
$time
[1];

441  
$c
 + 
$uc
;

442 
	}
}

444 
funi
 
GEd
(
$ame
,
$fvue
,
$nheight
="350",
$y
="Basic",
$gty
="t",
$isfuηge
="false")

446 if(!
funi_exis
('SpGetEditor'))

448 
que_
(
DEDEINC
."/inc/inc_fun_funAdmin.php");

450  
SpGEd
(
$ame
,
$fvue
,
$nheight
,
$y
,
$gty
,
$isfuηge
);

453 
funi
 
	$GTems
(
$fame
)

455 if(
	`fe_exis
(
$fame
))

457 
$
 = 
	`fݒ
(
$fame
,"r");

458 
$rr
 = 
	`d
(
$
,
	`fesize
(
$fame
));

459 
	`fo
(
$
);

460  
$rr
;

466 
	}
}

468 
funi
 
	$GSysTems
(
$fame
)

470  
	`GTems
(
$GLOBALS
['cfg_bad'].$GLOBALS['cfg_ms_d'].'/syem/'.
$fame
);

471 
	}
}

473 
funi
 
	$ADef
(
$dv
,
$nv
)

475  
	`emy
(
$dv
? 
$nv
 : $oldvar;

476 
	}
}

478 
funi
 
	$dd2ch
(
$ddnum
)

480 
$ddnum
 = 
	`rv
($ddnum);

481 
$
 = 
	`
(
$ddnum
);

482 
$okdd
 = '';

483 
$
 = '';

484 
$i
=0;$i<
$
;$i++)

486 if(
	`ist
(
$ddnum
[
$i
+1]))

488 
$n
 = 
$ddnum
[
$i
].$ddnum[$i+1];

489 if(
$n
>96 && $n<123) || ($n>64 && $n<91) )

491 
$okdd
 .
	`chr
(
$n
);

492 
$i
++;

496 
$okdd
 .
$ddnum
[
$i
];

501 
$okdd
 .
$ddnum
[
$i
];

504  
$okdd
;

505 
	}
}

507 
funi
 
PutCook
(
$key
,
$vue
,
$kime
=0,
$
="/")

509 
glob
 
$cfg_cook_code
;

510 
tcook
(
$key
,
$vue
,
time
()+
$kime
,
$
);

511 
tcook
(
$key
.'__ckMd5',
subr
(
md5
(
$cfg_cook_code
.
$vue
),0,16),
time
()+
$kime
,
$
);

514 
funi
 
	$DrCook
(
$key
)

516 
	`tcook
(
$key
,'',
	`time
()-360000,"/");

517 
	`tcook
(
$key
.'__ckMd5','',
	`time
()-360000,"/");

518 
	}
}

520 
funi
 
	$GCook
(
$key
)

522 
glob
 
$cfg_cook_code
;

523 if!
	`ist
(
$_COOKIE
[
$key
]) || !isset($_COOKIE[$key.'__ckMd5']) )

529 if(
$_COOKIE
[
$key
.'__ckMd5']!=
	`subr
(
	`md5
(
$cfg_cook_code
.$_COOKIE[$key]),0,16))

535  
$_COOKIE
[
$key
];

538 
	}
}

540 
funi
 
	$GCkVdVue
()

542 @
	`ssi_t
();

543  
	`ist
(
$_SESSION
['dd_ckstr']) ? $_SESSION['dd_ckstr'] : '';

544 
	}
}

547 
funi
 
	$RetVdVue
()

549 @
	`ssi_t
();

550 
$_SESSION
['dd_ckstr'] = '';

551 
$_SESSION
['dd_ckstr_last'] = '';

552 
	}
}

554 
funi
 
	$FMkd
(
$uh
,
$mmode
,
$isMkd
=
ue
)

556 
glob
 
$cfg_bad
,
$cfg_p_ro
,
$g_pLk
;

557 
	`OnF
();

558 
$o
 = 
	`eg_a
(
$cfg_p_ro
.'$','',
$cfg_bad
);

559 
$md
 = 
	`eg_a
('^'.
$o
,'',
$uh
);

560 if(
$isMkd
)

562 
	`p_mkd
(
$g_pLk
,
$md
);

564  
	`p_se
(
$g_pLk
,"chmod $mmode $mdir");

565 
	}
}

567 
funi
 
	$FChmod
(
$uh
,
$mmode
)

569  
	`FMkd
(
$uh
,
$mmode
,
l
);

570 
	}
}

572 
funi
 
	$OnF
()

574 
glob
 
$cfg_bad
,
$cfg_p_ho
,
$cfg_p_pt
, 
$cfg_p_ur
,
$cfg_p_pwd
,
$cfg_p_ro
,
$g_pLk
;

575 if(!
$g_pLk
)

577 if(
$cfg_p_ho
=='')

579 
echo
 "由于你的站点的PHP配置存在限制，程序尝试用FTP进行目录操作，你必须在后台指定FTP相关的变量！";

580 
	`ex
();

582 
$g_pLk
 = 
	`p_c
(
$cfg_p_ho
,
$cfg_p_pt
);

583 if(!
$g_pLk
)

585 
echo
 "连接FTP失败！";

586 
	`ex
();

588 if(!
	`p_log
(
$g_pLk
,
$cfg_p_ur
,
$cfg_p_pwd
))

590 
echo
 "登陆FTP失败！";

591 
	`ex
();

594 
	}
}

596 
funi
 
	$CloF
()

598 
glob
 
$g_pLk
;

599 if(
$g_pLk
)

601 @
	`p_qu
(
$g_pLk
);

603 
	}
}

605 
funi
 
	$MkdA
(
$uh
,
$mmode
)

607 
glob
 
$cfg_p_mkd
,
$isSaMode
,
$cfg_d_purvw
;

608 if(
$isSaMode
||
$cfg_p_mkd
=='Y')

610  
	`FMkd
(
$uh
,
$mmode
);

614 if(!
	`fe_exis
(
$uh
))

616 
	`mkd
(
$uh
,
$cfg_d_purvw
);

617 
	`chmod
(
$uh
,
$cfg_d_purvw
);

618  
ue
;

622  
ue
;

625 
	}
}

627 
funi
 
	$PCv
(
$n
)

629  
	`chr
(
$n
);

630 
	}
}

632 
funi
 
	$ChmodA
(
$uh
,
$mmode
)

634 
glob
 
$cfg_p_mkd
,
$isSaMode
;

635 if(
$isSaMode
||
$cfg_p_mkd
=='Y')

637  
	`FChmod
(
$uh
,
$mmode
);

641  
	`chmod
(
$uh
,'0'.
$mmode
);

643 
	}
}

645 
funi
 
	$CeD
(
$h
)

647 if(!
	`funi_exis
('SpCreateDir'))

649 
	`que_
(
DEDEINC
.'/inc/inc_fun_funAdmin.php');

651  
	`SpCeD
(
$h
);

652 
	}
}

658 
funi
 
	$HtmlR
(
$r
,
$ty
=0)

660 
$r
 = 
	`rashes
($str);

661 if(
$ty
==0)

663 
$r
 = 
	`htmleclchs
($str);

665 if(
$ty
==1)

667 
$r
 = 
	`htmleclchs
($str);

668 
$r
 = 
	`r_a
("　",' ',$str);

669 
$r
 = 
	`eg_a
("[\r\n\t ]{1,}",' ',$str);

671 if(
$ty
==2)

673 
$r
 = 
	`htmleclchs
($str);

674 
$r
 = 
	`r_a
("　",'',$str);

675 
$r
 = 
	`eg_a
("[\r\n\t ]",'',$str);

679 
$r
 = 
	`eg_a
("[\r\n\t ]{1,}",' ',$str);

680 
$r
 = 
	`egi_a
('script','ｓｃｒｉｐｔ',$str);

681 
$r
 = 
	`egi_a
("<[/]{0,1}(link|meta|ifr|fra)[^>]*>",'',$str);

683  
	`addashes
(
$r
);

684 
	}
}

687 
funi
 
	$GTags
(
$aid
)

689 
glob
 
$dsql
;

690 
$gs
 = '';

691 
$quy
 = "Selectag From `#@__taglist` whereid='$aid' ";

692 
$dsql
->
	`Execu
('g',
$quy
);

693 
$row
 = 
$dsql
->
	`GAay
('tag'))

695 
$gs
 .($gs=='' ? 
$row
['tag'] : ','.$row['tag']);

697  
$gs
;

698 
	}
}

700 
funi
 
	$PamE
()

702 
	`ShowMsg
('对不起，你输入的参数有误！','javascript:;');

703 
	`ex
();

704 
	}
}

707 
funi
 
	$FrSrch
(
$keywd
)

709 
glob
 
$cfg_so_ng
;

710 if(
$cfg_so_ng
=='utf-8')

712 
$keywd
 = 
	`eg_a
("[\"\r\n\t\$\\><']",'',$keyword);

713 if(
$keywd
 !
	`rashes
($keyword))

719  
$keywd
;

724 
$r
 = '';

725 
$i
=0;
	`ist
(
$keywd
[$i]);$i++)

727 if(
	`d
(
$keywd
[
$i
]) > 0x80)

729 if(
	`ist
(
$keywd
[
$i
+1]&& 
	`d
($keyword[$i+1]) > 0x40)

731 
$r
 .
$keywd
[
$i
].$keyword[$i+1];

732 
$i
++;

736 
$r
 .= ' ';

741 if(
	`egi
("[^0-9a-z@#\.]",
$keywd
[
$i
]))

743 
$r
 .= ' ';

747 
$r
 .
$keywd
[
$i
];

752  
$r
;

753 
	}
}

756 
funi
 
	$TrimMsg
(
$msg
)

758 
$msg
 = 
	`im
(
	`rashes
($msg));

759 
$msg
 = 
	`2br
(
	`htmleclchs
($msg));

760 
$msg
 = 
	`r_a
(" ","&nbsp;&nbsp;",$msg);

761  
	`addashes
(
$msg
);

762 
	}
}

765 
funi
 
	$GOArchive
(
$aid
)

767 
glob
 
$dsql
;

768 
	`ude_
(
DEDEINC
."/channelunit.func.php");

769 
$aid
 = 
	`im
(
	`eg_a
('[^0-9]','',$aid));

770 
$A
 = 
	`y
();

772 
$chRow
 = 
$dsql
->
	`GO
("Selectrc.*,ch.maintable,ch.addtable,ch.issystem From `#@__arctiny`rceft join `#@__channeltype` ch on ch.id=arc.channel whererc.id='$aid' ");

774 if(!
	`is_y
(
$chRow
)) {

775  
$A
;

778 if(
	`emy
(
$chRow
['maintable'])) $chRow['maintable'] = '#@__archives';

781 if(
$chRow
['issystem']!=-1)

783 
$nquy
 = " Selectrc.*,tp.typedir,tp.topid,tp.namerule,tp.moresite,tp.siteurl,tp.sitepath

784 
From
 `{
$chRow
['mab']}` 
c
 

 
jo
 `#@
__y
` 

 

p.
id
rc.
tyid


785 
whe
 
c
.
id
='$aid' ";

789 
$nquy
 = " Selectrc.*,1s ismake,0s money,''s filename,tp.typedir,tp.topid,tp.namerule,tp.moresite,tp.siteurl,tp.sitepath

790 
From
 `{
$chRow
['addb']}` 
c
 

 
jo
 `#@
__y
` 

 

p.
id
rc.
tyid


791 
whe
 
c
.
aid
='$aid' ";

794 
$cRow
 = 
$dsql
->
	`GO
(
$nquy
);

796 if(!
	`is_y
(
$cRow
)) {

797  
$A
;

800 if(!
	`ist
(
$cRow
['description'])) {

801 
$cRow
['description'] = '';

804 if(
	`emy
(
$cRow
['desti']&& 
	`ist
($arcRow['body'])) {

805 
$cRow
['desti'] = 
	`_subr
(
	`html2xt
($arcRow['body']),250);

808 if(!
	`ist
(
$cRow
['pubdate'])) {

809 
$cRow
['pubdate'] = $arcRow['senddate'];

812 if(!
	`ist
(
$cRow
['notpost'])) {

813 
$cRow
['notpost'] = 0;

816 
$A
 = 
$cRow
;

817 
$A
['aid'] = 
$aid
;

818 
$A
['tid'] = 
$cRow
['topid'];

819 
$A
[''] = 
$cRow
['title'];

820 
$A
['cu'] = 
	`GFeU
(
$aid
,
$cRow
['typeid'],$arcRow['senddate'],$reArr['title'],$arcRow['ismake'],$arcRow['arcrank'],$arcRow['namerule'],

821 
$cRow
['typedir'],$arcRow['money'],$arcRow['filename'],$arcRow['moresite'],$arcRow['siteurl'],$arcRow['sitepath']);

822  
$A
;

824 
	}
}

827 
funi
 
GChlTab
(
$id
,
$fmty
='channel')

829 
glob
 
$dsql
;

830 if(
	g$fmty
 == 'archive')

832 
$quy
 = "select ch.maintable, ch.addtable from #@__arctinyineft join #@__channeltype ch on ch.id=tin.channel wherein.id='$id'";

834 
if
(
$fmty
 == 'typeid')

836 
$quy
 = "select ch.maintable, ch.addtable from #@__arctypecteft join #@__channeltype ch on ch.id=act.channeltype wherect.id='$id'";

840 
	g$quy
 = "select maintable,ddtable from #@__channeltype where id='$id'";

842 
	g$row
 = 
$dsql
->
ge
(
$quy
);

843  
	g$row
;

846 
funi
 
	$jrim
(
$r
,
$n
)

848 
$r
 = 
	`eg_a
("/{quote}(.*){\/quote}/is",'',$str);

849 
$r
 = 
	`r_a
('&lt;br/&gt;',' ',$str);

850 
$r
 = 
	`_subr
($r,
$n
);

851 
$r
 = 
	`eg_a
("['\"\r\n]","",$str);

852  
$r
;

853 
	}
}

861 
funi
 
AdmUd
(
$udme
, 
$y
='image', 
$ddd
=0, 
$wmk
=
ue
, 
$fy
='' )

863 
glob
 
$dsql
, 
$curLog
, 
$cfg_add_vy
, 
$cfg_d_purvw
;

864 
glob
 
	g$cfg_bad
, 
	g$cfg_image_d
, 
	g$cfg_so_d
, 
	g$cfg_h_meds
;

865 
glob
 
	g$cfg_imgty
, 
	g$cfg_soty
, 
	g$cfg_medty
;

866 if(
	g$wmk

ude_
(
DEDEINC
.'/image.func.php');

868 
	g$fe_tmp
 = 
ist
(
$GLOBALS
[
$udme
]) ? $GLOBALS[$uploadname] : '';

869 if(
	g$fe_tmp
=='' || !
is_uded_fe
(
$fe_tmp
) )

874 
	g$fe_tmp
 = 
$GLOBALS
[
$udme
];

875 
	g$fe_size
 = 
fesize
(
$fe_tmp
);

876 
	g$fe_ty
 = 
$fy
=='' ? 
ow
(
im
(
$GLOBALS
[
$udme
.'_type'])) : $filetype;

878 
	g$fe_me
 = 
ist
(
$GLOBALS
[
$udme
.'_name']) ? $GLOBALS[$uploadname.'_name'] : '';

879 
	g$fe_ames
 = 
exode
('.', 
$fe_me
);

880 
	g$fe_ame
 = 
ow
(
im
(
$fe_ames
[
cou
($file_snames)-1]));

882 if(
	g$y
=='image' || 
$y
=='imagelit')

884 
$fy
 = '1';

885 
	g$r
 = 
Aay
('image/pjpeg', 'image/jpeg', 'image/gif', 'image/png', 'image/xpng', 'image/wbmp');

886 if(!
_y
(
$fe_ty
, 
$r
))  0;

887 if(
	g$fe_ame
=='')

889 if(
$fe_ty
=='image/gif'
$fe_ame
 = 'jpg';

890 if(
	g$fe_ty
=='image/g' || 
$fe_ty
=='image/xg'
$fe_ame
 = 'png';

891 if(
	g$fe_ty
=='image/wbmp'
$fe_ame
 = 'bmp';

892 
	g$fe_ame
 = 'jpg';

894 
	g$fed
 = 
$cfg_image_d
.'/'.
MyDe
(
$cfg_add_vy
, 
time
());

896 if(
	g$y
=='media')

898 
$fy
 = '3';

899 if!
egi
(
$cfg_medty
, 
$fe_ame
) )  0;

900 
	g$fed
 = 
$cfg_h_meds
.'/'.
MyDe
(
$cfg_add_vy
, 
time
());

904 
	g$fy
 = '4';

905 
	g$cfg_soty
 .'|'.
$cfg_medty
.'|'.
$cfg_imgty
;

906 
	g$cfg_soty
 = 
eg_a
('||', '|', 
$cfg_soty
);

907 if!
egi
(
$cfg_soty
, 
$fe_ame
) )  0;

908 
	g$fed
 = 
$cfg_so_d
.'/'.
MyDe
(
$cfg_add_vy
, 
time
());

910 if(!
is_d
(
DEDEROOT
.
$fed
))

912 
MkdA
(
$cfg_bad
.
$fed
, 
$cfg_d_purvw
);

913 
CloF
();

915 
	g$fame
 = 
$curLog
->
gUrID
().'-'.
dd2ch
(
MyDe
('ymdHis', 
time
())).
	g$ddd
;

916 if(
	g$y
=='imag'
$fame
 .= '-L';

917 if
fe_exis
(
$cfg_bad
.
$fed
.'/'.
$fame
.'.'.
$fe_ame
) )

919 
	g$i
=50; $i <= 5000; $i++)

921 if!
fe_exis
(
$cfg_bad
.
$fed
.'/'.
$fame
.'-'.
$i
.'.'.
$fe_ame
) )

923 
	g$fame
 = 
$fame
.'-'.
$i
;

928 
	g$feu
 = 
$fed
.'/'.
$fame
.'.'.
$fe_ame
;

929 
	g$rs
 = 
move_uded_fe
(
$fe_tmp
, 
$cfg_bad
.
$feu
);

930 if(!
	g$rs
)  -2;

931 if(
	g$y
=='image' && 
$wmk
)

933 
WImg
(
$cfg_bad
.
$feu
, 'up');

937 
	g$t
 = 
$fame
.'.'.
$fe_ame
;

938 
	g$quy
 = "INSERT INTO `#@__uploads`(title,url,mediatype,width,height,playtime,filesize,uptime,mid)

939 
VALUES
 ('$title','$fileurl','$filetype','0','0','0','".filesize($cfg_basedir.$fileurl)."','".time()."','".$cuserLogin->getUserID()."'); ";

940 
	g$dsql
->
ExecuNeQuy
(
$quy
);

941 
	g$fid
 = 
$dsql
->
GLaID
();

942 
AddMyAdd
(
$fid
, 
$feu
);

943  
	g$feu
;

947 
funi
 
	$CheckEma
(
$ema
)

949  
	`egi
("^[0-9a-z][a-z0-9\._-]{1,}@[a-z0-9-]{1,}[a-z0-9]\.[a-z\.]{1,}[a-z]$", 
$ema
);

950 
	}
}

955 
funi
 
MembUds
(
$uame
,
$hdme
,
$urid
=0,
$uty
='image',
$exme
='',
$maxwidth
=0,
$maxheight
=0,
$w
=
l
,
$idm
=false)

957 
glob
 
$cfg_imgty
,
$cfg_mb_addty
,
$cfg_medty
,
$cfg_ur_d
,
$cfg_bad
,
$cfg_d_purvw
;

960 if
emy
(
$urid

	g$urid
 = 0;

961 if(!
is_d
(
$cfg_bad
.
$cfg_ur_d
."/$userid"))

963 
MkdA
(
$cfg_bad
.
$cfg_ur_d
."/$urid", 
$cfg_d_purvw
);

964 
CloF
();

967 
	g$lAowTy
 = 
r_a
('||', '|', 
$cfg_imgty
.'|'.
$cfg_medty
.'|'.
$cfg_mb_addty
);

968 if(!
emy
(
$GLOBALS
[
$uame
]&& 
is_uded_fe
($GLOBALS[$upname]))

970 
	g$nowtme
 = 
time
();

971 
	g$GLOBALS
[
$uame
.'_me'] = 
im
(
eg_a
("[ \r\n\t\*\%\\/\?><\|\":]{1,}",'',
$GLOBALS
[$upname.'_name']));

973 if(
	g$uty
=='image')

975 if(!
egi
("\.(".
$cfg_imgty
.")$", 
$GLOBALS
[
$uame
.'_name']))

977 
ShowMsg
("你所上传的图片类型不在许可列表，请上传{$cfg_imgtype}类型！",'-1');

978 
ex
();

980 
	g$r
 = 
Aay
("image/pjpeg","image/jpeg","image/gif","image/png","image/xpng","image/wbmp");

981 
	g$imgfe_ty
 = 
ow
(
im
(
$GLOBALS
[
$uame
.'_type']));

982 if(!
_y
(
$imgfe_ty
,
$r
))

984 
ShowMsg
('上传的图片格式错误，请使用JPEG、GIF、PNG、WBMP格式的其中一种！', '-1');

985 
ex
();

988 if(
	g$uty
=='ash' && !
egi
("\.swf$", 
$GLOBALS
[
$uame
.'_name']))

990 
ShowMsg
('上传的文件必须为flash文件！', '-1');

991 
ex
();

993 if(
	g$uty
=='med' && !
egi
("\.(".
$cfg_medty
.")$",
$GLOBALS
[
$uame
.'_name']))

995 
ShowMsg
('你所上传的文件类型必须为：'.
$cfg_medty
, '-1');

996 
ex
();

998 if(!
egi
("\.(".
$lAowTy
.")$", 
$GLOBALS
[
$uame
.'_name']))

1000 
ShowMsg
("你所上传的文件类型不被允许！",'-1');

1001 
ex
();

1004 
	g$fs
 = 
exode
('.', 
$GLOBALS
[
$uame
.'_name']);

1005 
	g$ame
 = 
$fs
[
cou
($fs)-1];

1006 
	g$ys
 = 
exode
('|', 
$lAowTy
);

1007 if(!
_y
(
ow
(
$ame
), 
$ys
))

1009 
ShowMsg
('你所上传的文件类型不被允许！', '-1');

1010 
ex
();

1013 if(
egi
("\.ץ|php||cgi|shtm|js)", 
$ame
))

1015 
ShowMsg
('你上传的文件为系统禁止的类型！', '-1');

1016 
ex
();

1018 if(
	g$exme
=='')

1020 
$fame
 = 
$cfg_ur_d
."/$urid/".
dd2ch
(
$nowtme
.'-'.
mt_nd
(1000,9999)).'.'.
	g$ame
;

1024 
	g$fame
 = 
$cfg_ur_d
."/{$urid}/{$exme}.".
$ame
;

1026 
move_uded_fe
(
$GLOBALS
[
$uame
],
$cfg_bad
.
$fame


 
d
("上传文件到 {$filename} 失败！");

1027 @
uƚk
(
$GLOBALS
[
$uame
]);

1029 if(@
fesize
(
$cfg_bad
.
$fame
> 
	g$GLOBALS
['cfg_mb_upload_size'] * 1024)

1031 @
uƚk
(
$cfg_bad
.
$fame
);

1032 
ShowMsg
('你上传的文件超出系统大小限制！', '-1');

1033 
ex
();

1037 if(
	g$uty
=='image')

1039 
ude_
(
DEDEINC
.'/image.func.php');

1040 if(
	g$maxwidth
>0 || 
	g$maxheight
>0)

1042 
ImageResize
(
$cfg_bad
.
$fame
, 
$maxwidth
, 
$maxheight
);

1044 if(
	g$w
)

1046 
WImg
(
$cfg_bad
.
$fame
);

1049  
	g$fame
;

1055 if(
	g$hdme
=='')

1057  
$hdme
;

1059 if(
egi
("\.ץ|php||cgi|shtm|js)", 
$hdme
))

1061 
ex
('Notllow filename forot safe!');

1063 if!
egi
("\.(".
$lAowTy
.")$", 
$hdme
) )

1065 
ex
('Notllow filename for filetype!');

1067 if!
egi
('^hp:', 
$hdme
&& !egi('^'.
$cfg_ur_d
.'/'.
$urid
, $hdme&& !
	g$idm
 )

1069 
ex
('Notllow filename forot userdir!');

1071  
	g$hdme
;

1077 if
fe_exis
(
DEDEINC
.'/extend.func.php') )

1079 
que_
(
DEDEINC
.'/extend.func.php');

	@include/common.inc.php

1 <?
php


3 
r_ptg
(
E_ALL
 || ~
E_NOTICE
);

4 
defe
('DEDEINC', 
eg_a
("[/\\]{1,}", '/', 
dme
(
__FILE__
) ) );

5 
defe
('DEDEROOT', 
eg_a
("[/\\]{1,}", '/', 
subr
(
DEDEINC
,0,-8) ) );

6 
defe
('DEDEDATA', 
DEDEROOT
.'/data');

7 
defe
('DEDEMEMBER', 
DEDEROOT
.'/member');

8 
defe
('DEDETEMPLATE', 
DEDEROOT
.'/templets');

11 
fܗch
(
$_REQUEST
 
as
 
$_k
=>
$_v
)

13 if

(
$_k
)>0 && 
egi
('^(cfg_|GLOBALS)',$_k) )

15 
ex
('Request varotllow!');

19 
funi
 
	$_RunMagicQues
(&
$sv
)

21 if(!
	`g_magic_ques_gpc
())

23 if
	`is_y
(
$sv
) )

25 
	`fܗch
(
$sv
 
as
 
$_k
 => 
$_v
$sv[$_k] = 
	`_RunMagicQues
($_v);

29 
$sv
 = 
	`addashes
($svar);

32  
$sv
;

33 
	}
}

35 
fܗch
(
Aay
('_GET','_POST','_COOKIE'
as
 
$_que
)

37 
fܗch
(
$$_que
 
as
 
$_k
 => 
$_v

$
{$_k} = 
_RunMagicQues
($_v);

41 if(!
	$ist
(
$edFr
))

43 
$edFr
 = 
l
;

44 
	}
}

45 
	g$giGlobs
 = @
i_g
("register_globals");

46 
	g$isUOn
 = @
i_g
("allow_url_fopen");

47 
	g$isSaMode
 = @
i_g
("safe_mode");

48 if
egi
('wdows', @
gv
('OS')) )

50 
	g$isSaMode
 = 
l
;

54 
	g$ssSavePh
 = 
DEDEDATA
."/sessions/";

55 if(
is_wrb
(
$ssSavePh
&& 
	$is_adab
(
$ssSavePh
))

57 
	`ssi_ve_th
(
$ssSavePh
);

58 
	}
}

61 
que_
(
DEDEDATA
."/config.cache.inc.php");

64 if(
	g$_FILES
)

66 
que_
(
DEDEINC
.'/uploadsafe.inc.php');

70 
que_
(
DEDEDATA
.'/common.inc.php');

74 if(
	gPHP_VERSION
 > '5.1')

76 
	g$time51
 = 
$cfg_i_time
 * -1;

77 @
de_deu_timeze_t
('Etc/GMT'.
$time51
);

79 
	g$cfg_isUOn
 = @
i_g
("allow_url_fopen");

82 
	g$cfg_iho
 = 'hp://'.
$_SERVER
['HTTP_HOST'];

85 
	g$cfg_bad
 = 
egi_a
(
$cfg_cmh
.'/ude$','',
DEDEINC
);

86 if(
	g$cfg_mui_se
 == 'Y')

88 
$cfg_mase
 = 
$cfg_baho
;

92 
	g$cfg_mase
 = '';

96 
	g$cfg_ms_d
 = 
$cfg_cmh
.'/templets';

97 
	g$cfg_mu
 = 
$cfg_mase
.
$cfg_ms_d
;

100 
	g$cfg_cmsu
 = 
$cfg_mase
.
$cfg_cmh
;

103 
	g$cfg_us_d
 = 
$cfg_cmh
.'/plus';

104 
	g$cfg_phpu
 = 
$cfg_mase
.
$cfg_us_d
;

106 
	g$cfg_da_d
 = 
$cfg_cmh
.'/data';

107 
	g$cfg_dau
 = 
$cfg_mase
.
$cfg_da_d
;

110 
	g$cfg_memb_d
 = 
$cfg_cmh
.'/member';

111 
	g$cfg_membu
 = 
$cfg_mase
.
$cfg_memb_d
;

114 
	g$cfg_ecl
 = 
$cfg_cmh
.'/special';

115 
	g$cfg_eclu
 = 
$cfg_mase
.
$cfg_ecl
;

118 
	g$cfg_meds_d
 = 
$cfg_cmh
.
$cfg_meds_d
;

119 
	g$cfg_medsu
 = 
$cfg_mase
.
$cfg_meds_d
;

122 
	g$cfg_image_d
 = 
$cfg_meds_d
.'/allimg';

125 
	g$ddcfg_image_d
 = 
$cfg_meds_d
.'/litimg';

128 
	g$cfg_ur_d
 = 
$cfg_meds_d
.'/userup';

131 
	g$cfg_so_d
 = 
$cfg_meds_d
.'/soft';

134 
	g$cfg_h_meds
 = 
$cfg_meds_d
.'/media';

137 
	g$cfg_vsi
 = 'V55_UTF8';

138 
	g$cfg_so_ng
 = 'utf-8';

139 
	g$cfg_so_public
 = 'base';

141 
	g$cfg_some
 = '织梦内容管理系统';

142 
	g$cfg_so_me
 = 'DedeCms';

143 
	g$cfg_so_devam
 = 'Dedecms官方团队';

146 
	g$t_sh܊ame
 = 
$cfg_df_ext
 = '.html';

147 
	g$cfg_df_mu
 = '{tyd}/{Y}/{M}{D}/{aid}'.
$cfg_df_ext
;

150 if(
ist
(
$cfg_p_mkd
&& 
	g$cfg_p_mkd
=='Y')

152 
$cfg_d_purvw
 = '0755';

156 
	g$cfg_d_purvw
 = 0755;

160 
	g$cfg_mb_l
 = 'N';

163 
	g$_sys_globs
['curfile'] = '';

164 
	g$_sys_globs
['typeid'] = 0;

165 
	g$_sys_globs
['typename'] = '';

166 
	g$_sys_globs
['aid'] = 0;

168 if(
	$emy
(
$cfg_add_vy
))

170 
$cfg_add_vy
 = 'Ymd';

171 
	}
}

172 if(
	g$cfg_ndma_bysm
=='Y' && !
	$emy
(
$cfg_sm_urma
))

174 
$cfg_admema
 = 
$cfg_sm_urma
;

175 
	}
}

177 if(!
	$ist
(
$cfg_NPrtHd
)) {

178 
	`hd
("Content-Type:ext/html; charset={$cfg_soft_lang}");

179 
	}
}

183 
que_
(
DEDEINC
.'/dedesql.class.php');

186 
que_
(
DEDEINC
.'/common.func.php');

	@include/customfields.func.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('dedecms');

8 
funi
 
GFmIm
(
$ag
,
$admty
='admin')

10 
glob
 
$dsql
;

11 
	g$fldme
 = 
$ag
->
GName
();

12 
	g$fldTy
 = 
$ag
->
GA
('type');

13 
	g$fmem
 = 
$fmem
 = 
GSysTems
("custom_fields_{$admintype}.htm");

14 
	g$ùext
 = 
im
(
$ag
->
GIText
());

15 if(
	g$ùext
!='')

17 
$fmem
 = 
$ùext
;

20 if(
	g$fldTy
=='select')

22 
$myfmIm
 = '';

23 
	g$ems
 = 
exode
(',',
$ag
->
GA
("default"));

24 
	g$myfmIm
 = "<selectame='$fieldname' style='width:150px'>";

25 
fܗch
(
$ems
 
as
 
$v
)

27 
	g$v
 = 
im
(
$v
);

28 if(
	g$v
!='') {

29 
$myfmIm
.= "<option value='$v'>$v</option>\r\n";

32 
	g$myfmIm
 .= "</select>\r\n";

33 
	g$ùext
 = 
$myfmIm
;

35 if(
	g$fldTy
=='stepselect')

37 
glob
 
$hasSEnumJs
,
$cfg_cmh
;

38 
	g$cmh
 = ( (
emy
(
$cfg_cmh
|| 
eg
('[/$]', $cfg_cmh)? 
	g$cfg_cmh
.'/' : $cfg_cmspath );

39 
	g$myfmIm
 = '';

40 
	g$myfmIm
 .= "<inputype='hidden' id='hidden_{$fieldname}'ame='{$fieldname}' value='0' />\r\n";

41 
	g$myfmIm
 .= "<span id='span_{$fieldname}'></span>\r\n";

42 
	g$myfmIm
 .= "<span id='span_{$fieldname}_son'></span>\r\n";

43 if(
	g$hasSEnumJs
 != 'hasset')

45 
$myfmIm
 .'<snguage="javast"y="xt/javast" src="'.
$cmh
.'images/enums.js"></script>'."\r\n";

46 
	g$GLOBALS
['hasSetEnumJs'] = 'hasset';

48 
	g$myfmIm
 .= "<scriptanguage='javascript'ype='text/javascript' src='{$cmspath}data/enums/{$fieldname}.js'></script>\r\n";

49 
	g$myfmIm
 .'<snguage="javast"y="xt/javast">MakeTSe("'.
$fldme
.'", 0);</script>'."\r\n";

50 
	g$fmem
 = 
r_a
('~me~', 
$ag
->
GA
('emme'), 
$fmem
);

51 
	g$fmem
 = 
r_a
('~fm~', 
$myfmIm
, 
$fmem
);

52  
	g$fmem
;

54 if(
	g$fldTy
=='radio')

56 
$myfmIm
 = '';

57 
	g$ems
 = 
exode
(',',
$ag
->
GA
("default"));

58 
	g$i
 = 0;

59 
fܗch
(
$ems
 
as
 
$v
)

61 
	g$v
 = 
im
(
$v
);

62 if(
	g$v
!='')

64 
$myfmIm
 .(
$i
==0 ? "<inputype='radio'ame='$fieldname' class='np' value='$v' checked>$v\r\n" : "<inputype='radio'ame='$fieldname' class='np' value='$v'>$v\r\n");

65 
	g$i
++;

68 
	g$ùext
 = 
$myfmIm
;

70 if(
	g$fldTy
=='checkbox')

72 
$myfmIm
 = '';

73 
	g$ems
 = 
exode
(',',
$ag
->
GA
("default"));

74 
fܗch
(
$ems
 
as
 
$v
)

76 
	g$v
 = 
im
(
$v
);

77 if(
	g$v
!='')

79 
$myfmIm
 .= "<inputype='checkbox'ame='{$fieldname}[]' class='np' value='$v'>$v\r\n";

82 
	g$ùext
 = 
$myfmIm
;

84 if(
	g$fldTy
=='htmext'||
$fldTy
=='textdata')

86 
$dfvue
 = (
$ag
->
GA
('default')!='' ? $ctag->GetAtt('default') : '');

87 
	g$dfvue
 = 
r_a
('{{', '<', 
$dfvue
);

88 
	g$dfvue
 = 
r_a
('}}', '>', 
$dfvue
);

89 if(
	g$admty
=='admin')

91 
$ùext
 = 
GEd
(
$fldme
, 
$dfvue
, 350, 'Basic', 'string');

93 if(
	g$admty
=='diy')

95 
$ùext
 = 
GEd
(
$fldme
, 
$dfvue
, 350, 'Diy', 'string');

99 
	g$ùext
 = 
GEd
(
$fldme
, 
$dfvue
, 350, 'Member', 'string');

102 if(
	g$fldTy
=="multitext")

104 
$ùext
 = "<textareaame='$fieldname' id='$fieldname' style='width:100%;height:80'></textarea>\r\n";

106 if(
	g$fldTy
=="datetime")

108 
$nowtime
 = 
GDeTimeMk
(
time
());

109 
	g$ùext
 = "<inputame=\"$fieldname\" value=\"$nowtime\"ype=\"text\" id=\"$fieldname\" style=\"width:250px\" />";

111 if(
	g$fldTy
=='img'||
$fldTy
=='imgfile')

113 if(
$admty
=='diy') {

114 
$ùext
 = "<inputype='file'ame='$fieldname' id='$fieldname' style='width:300px;height:22px;line-height:22px' />\r\n";

117 
	g$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' sty='width:300px' css='xt' /> <pume='".
$fldme
."_bt'ype='button' class='inputbut' value='浏览...' onClick=\"SelectImage('form1.$fieldname','big')\" />\r\n";

120 if(
	g$fldTy
=='media')

122 if(
$admty
=='diy')

124 
$ùext
 = "<inputype='hidden'ame='$fieldname' id='$fieldname' value='' />不支持的类型\r\n";

128 
	g$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' sty='width:300px' css='xt' /> <pume='".
$fldme
."_bt'ype='button' class='inputbut' value='浏览...' onClick=\"SelectMedia('form1.$fieldname')\" />\r\n";

131 if(
	g$fldTy
=='addon')

133 if(
$admty
=='diy')

135 
$ùext
 = "<inputype='file'ame='$fieldname' id='$fieldname' style='width:300px;height:22px;line-height:22px' />\r\n";

139 
	g$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' sty='width:300px' css='xt' /> <pume='".
$fldme
."_bt'ype='button' class='inputbut' value='浏览...' onClick=\"SelectSoft('form1.$fieldname')\" />\r\n";

142 if(
	g$fldTy
=='t'||
$fldTy
=='float')

144 
$dfvue
 = (
$ag
->
GA
('default')!='' ? $ctag->GetAtt('default') : '0');

145 
	g$ùext
 = "<inputype='text'ame='$fieldname' id='$fieldname' style='width:100px' class='text' value='$dfvalue' /> (填写数值)\r\n";

149 
	g$dfvue
 = (
$ag
->
GA
('default')!='' ? $ctag->GetAtt('default') : '');

150 
	g$ùext
 = "<inputype='text'ame='$fieldname' id='$fieldname' style='width:250px' class='text' value='$dfvalue' />\r\n";

152 
	g$fmem
 = 
r_a
("~me~",
$ag
->
GA
('emme'),
$fmem
);

153 
	g$fmem
 = 
r_a
("~fm~",
$ùext
,
$fmem
);

154  
	g$fmem
;

158 
funi
 
GFldVue
(
$dvue
, 
$dty
, 
$aid
=0, 
$job
='add', 
$addv
='', 
$admty
='adm', 
$fldme
='')

160 
glob
 
$cfg_bad
, 
$cfg_cmh
, 
$admid
, 
$cfg_ml
, 
$cfg_cook_code
;

161 if(!
emy
(
$admid
))

163 
	g$admid
 = 
$admid
;

167 
	g$admid
 = 
ist
(
$cfg_ml
? $cfg_ml->
M_ID
 : 1;

169 if(
	g$dty
=='int')

171 if(
$dvue
=='')

175  
GAbNum
(
$dvue
);

177 if(
	g$dty
=='stepselect')

179  
tv
(
$dvue
);

181 if(
	g$dty
=='float')

183 if(
$dvue
=='')

187  
GAbNum
(
$dvue
);

189 if(
	g$dty
=='datetime')

191 if(
$dvue
=='')

195  
GMkTime
(
$dvue
);

197 if(
	g$dty
=='checkbox')

199 
$okvue
 = '';

200 if(
is_y
(
$dvue
))

202 
	g$okvue
 = 
jo
(',',
$dvue
);

204  
	g$okvue
;

206 if(
	g$dty
=="htmltext")

208 if(
$admty
=='member' || $admintype=='diy')

210 
$dvue
 = 
HtmlR
($dvalue,-1);

212  
	g$dvue
;

214 if(
	g$dty
=="multitext")

216 if(
$admty
=='member' || $admintype=='diy')

218 
$dvue
 = 
HtmlR
($dvalue,0);

220  
	g$dvue
;

222 if(
	g$dty
=="textdata")

224 
$h
 = 
$cfg_cmh
."/data/textdata";

225 
	g$h
 = 

(
$aid
/5000);

226 if(!
is_d
(
$cfg_bad
.
$h
))

228 
MkdA
(
$cfg_bad
.
$h
,
$GLOBALS
['cfg_dir_purview']);

230 if(!
is_d
(
$cfg_bad
.
$h
.'/'.
$h
))

232 
MkdA
(
$cfg_bad
.
$h
.'/'.
$h
,
$GLOBALS
['cfg_dir_purview']);

234 
	g$h
 = 
$h
.'/'.
$h
;

235 
	g$fame
 = "{$h}/{$aid}-".
_subr
(
md5
(
$cfg_cook_code
),0,16).".txt";

238 if(
	g$admty
=='memb' || 
$admty
=='diy')

240 
$dvue
 = 
HtmlR
($dvalue,-1);

242 
	g$
 = 
fݒ
(
$cfg_bad
.
$fame
,"w");

243 
fwre
(
$
,
rashes
(
$dvue
));

244 
fo
(
$
);

245 
CloF
();

246  
	g$fame
;

248 if(
	g$dty
=='img' || 
$dty
=='imgfile')

250 if(
$admty
=='diy')

252 
$iu
 = 
MembUds
(
$fldme
,'', 0, 'image', '', -1, -1, 
l
);

253  
	g$iu
;

255 
	g$iu
 = 
rashes
(
$dvue
);

256 if(
im
(
$iu
)=='')

260 
	g$iu
 = 
im
(
r_a
(
$GLOBALS
['cfg_baho'],"",
$iu
));

261 
	g$imgu
 = "{dede:imgext='' width='' height=''} ".
$iu
." {/dede:img}";

262 if(
egi
("^hp://",
$iu
&& 
	g$GLOBALS
['cfg_isUrlOpen'])

265 
	g$imgs
 = '';

266 if(
	g$GLOBALS
['cfg_isUrlOpen'])

268 
	g$imgs
 = 
GRemeImage
(
$iu
,
$admid
);

269 if(
is_y
(
$imgs
))

271 if(
	g$dty
=='imgfile')

273 
$imgu
 = 
$imgs
[1];

277 
	g$imgu
 = "{dede:imgext='' width='".
$imgs
[1]."' height='".$reimgs[2]."'} ".$reimgs[0]." {/dede:img}";

283 if(
	g$dty
=='imgfile')

285 
$imgu
 = 
$iu
;

289 
	g$imgu
 = "{dede:imgext='' width='' height=''} ".
$iu
." {/dede:img}";

293 if(
	g$iu
 != '')

296 
$imgfe
 = 
$cfg_bad
.
$iu
;

297 if(
is_fe
(
$imgfe
))

299 
	g$fo
 = '';

300 
	g$imgfos
 = 
GImageSize
(
$imgfe
,
$fo
);

301 if(
	g$dty
=="imgfile")

303 
$imgu
 = 
$iu
;

307 
	g$imgu
 = "{dede:imgext='' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}";

311  
addashes
(
$imgu
);

313 if(
	g$dty
=='add' && 
$admty
=='diy')

315 
$dvue
 = 
MembUds
(
$fldme
,'', 0, 'add', '', -1, -1, 
l
);

316  
	g$dvue
;

320 if(
	g$admty
=='memb' || 
$admty
=='diy')

322 
$dvue
 = 
HtmlR
($dvalue,1);

324  
	g$dvue
;

329 
funi
 
GFmImVue
(
$ag
, 
$fvue
, 
$admty
='adm', 
$fldme
='')

331 
glob
 
$cfg_bad
,
$dsql
;

332 
	g$fldme
 = 
$ag
->
GName
();

333 
	g$fmem
 = 
$fmem
 = 
GSysTems
("custom_fields_{$admintype}.htm");

334 
	g$ùext
 = 
im
(
$ag
->
GIText
());

335 if(
	g$ùext
!='')

337 
$fmem
 = 
$ùext
;

339 
	g$y
 = 
$ag
->
GA
('type');

340 
	g$myfmIm
 = '';

341 if(
egi
('|dio|checkbox',
$y
))

343 
	g$ems
 = 
exode
(',',
$ag
->
GA
('default'));

345 if(
	g$y
=='select')

347 
$myfmIm
 = "<selectame='$fieldname' style='width:150px'>";

348 if(
is_y
(
$ems
))

350 
fܗch
(
$ems
 
as
 
$v
)

352 
	g$v
 = 
im
(
$v
);

353 if(
	g$v
=='')

357 
	g$myfmIm
.(
$fvue
==
$v
 ? "<option value='$v' selected>$v</option>\r\n" : "<option value='$v'>$v</option>\r\n");

360 
	g$myfmIm
 .= "</select>\r\n";

361 
	g$ùext
 = 
$myfmIm
;

363 if(
	g$ag
->
GA
("type")=='stepselect')

365 
glob
 
$hasSEnumJs
,
$cfg_cmh
;

366 
	g$cmh
 = ( (
emy
(
$cfg_cmh
|| 
eg
('[/$]', $cfg_cmh)? 
	g$cfg_cmh
.'/' : $cfg_cmspath );

367 
	g$myfmIm
 = '';

368 
	g$myfmIm
 .= "<inputype='hidden' id='hidden_{$fieldname}'ame='{$fieldname}' value='{$fvalue}' />\r\n";

369 
	g$myfmIm
 .= "<span id='span_{$fieldname}'></span>\r\n";

370 
	g$myfmIm
 .= "<span id='span_{$fieldname}_son'></span>\r\n";

371 if(
	g$hasSEnumJs
 != 'hasset')

373 
$myfmIm
 .'<snguage="javast"y="xt/javast" src="'.
$cmh
.'images/enums.js"></script>'."\r\n";

374 
	g$GLOBALS
['hasSetEnumJs'] = 'hasset';

376 
	g$myfmIm
 .= "<scriptanguage='javascript'ype='text/javascript' src='{$cmspath}data/enums/{$fieldname}.js'></script>\r\n";

377 
	g$myfmIm
 .= "<scriptanguage='javascript'ype='text/javascript'>MakeTopSelect('$fieldname', $fvalue);</script>\r\n";

378 
	g$fmem
 = 
r_a
('~me~', 
$ag
->
GA
('emme'), 
$fmem
);

379 
	g$fmem
 = 
r_a
('~fm~', 
$myfmIm
, 
$fmem
);

380  
	g$fmem
;

382 if(
	g$y
=='radio')

384 if(
is_y
(
$ems
))

386 
fܗch
(
$ems
 
as
 
$v
)

388 
$v
 = 
im
($v);

389 if(
	g$v
=='') ;

390 
	g$myfmIm
.(
$fvue
==
$v
 ? "<inputype='radio'ame='$fieldname' class='np' value='$v' checked='checked' />$v\r\n" : "<inputype='radio'ame='$fieldname' class='np' value='$v' />$v\r\n");

393 
	g$ùext
 = 
$myfmIm
;

397 if(
	g$y
=='checkbox')

399 
$myfmIm
 = '';

400 
	g$fvues
 = 
exode
(',',
$fvue
);

401 if(
is_y
(
$ems
))

403 
fܗch
(
$ems
 
as
 
$v
)

405 
	g$v
 = 
im
(
$v
);

406 if(
	g$v
=='')

410 if(
_y
(
$v
,
$fvues
))

412 
	g$myfmIm
 .= "<inputype='checkbox'ame='{$fieldname}[]' class='np' value='$v' checked='checked' />$v\r\n";

416 
	g$myfmIm
 .= "<inputype='checkbox'ame='{$fieldname}[]' class='np' value='$v' />$v\r\n";

420 
	g$ùext
 = 
$myfmIm
;

424 if(
	g$y
=="textdata")

426 if(
is_fe
(
$cfg_bad
.
$fvue
))

428 
$
 = 
fݒ
(
$cfg_bad
.
$fvue
,'r');

429 
	g$okfvue
 = '';

430 !
of
(
$
)){ 
	g$okfvue
 .
fgs
($fp,1024); }

431 
fo
(
$
);

435 
	g$okfvue
 = '';

437 if(
	g$admty
=='admin')

439 
$myfmIm
 = 
GEd
(
$fldme
,
$okfvue
,350,'Basic','string')."\r\n <inputype='hidden'ame='{$fieldname}_file' value='{$fvalue}' />\r\n ";

443 
	g$myfmIm
 = 
GEd
(
$fldme
,
$okfvue
,350,'Member','string')."\r\n <inputype='hidden'ame='{$fieldname}_file' value='{$fvalue}' />\r\n ";

445 
	g$ùext
 = 
$myfmIm
;

447 if(
	g$y
=="htmltext")

449 if(
$admty
=='admin')

451 
$myfmIm
 = 
GEd
(
$fldme
,
$fvue
,350,'Basic','string')."\r\n ";

455 
	g$myfmIm
 = 
GEd
(
$fldme
,
$fvue
,350,'Member','string')."\r\n ";

457 
	g$ùext
 = 
$myfmIm
;

459 if(
	g$y
=="multitext")

461 
$ùext
 = "<textareaame='$fieldname' id='$fieldname' style='width:100%;height:80px'>$fvalue</textarea>\r\n";

463 if(
	g$y
=="datetime")

465 
$nowtime
 = 
GDeTimeMk
(
$fvue
);

466 
	g$ùext
 = "<inputame=\"$fieldname\" value=\"$nowtime\"ype=\"text\" id=\"$fieldname\" style=\"width:250px\" />";

468 if(
	g$y
=="img")

470 
$nd
 = 
w
 
DedeTagP
();

471 
	g$nd
->
LdSour
(
$fvue
);

472 if(!
is_y
(
$nd
->
CTags
))

474 
	g$nd
->
Cˬ
();

475 
	g$fvue
 = "";

479 
	g$ag
 = 
$nd
->
GTag
("img");

480 
	g$fvue
 = 
im
(
$ag
->
GIText
());

482 
	g$ùext
 = "<puty='xt'ame='$fldme' vue='$fvue' id='$fldme' sty='width:300px' css='xt' /> <pume='".
$fldme
."_bt' class='inputbut'ype='button' value='浏览...' onClick=\"SelectImage('form1.$fieldname','big')\" />\r\n";

484 if(
	g$y
=="imgfile")

486 
$ùext
 = "<puty='xt'ame='$fldme' vue='$fvue' id='$fldme' sty='width:300px' css='xt' /> <pume='".
$fldme
."_bt' class='inputbut'ype='button' value='浏览...' onClick=\"SelectImage('form1.$fieldname','big')\" />\r\n";

488 if(
	g$y
=="media")

490 
$ùext
 = "<puty='xt'ame='$fldme' vue='$fvue' id='$fldme' sty='width:300px' css='xt' /> <pume='".
$fldme
."_bt' class='inputbut'ype='button' value='浏览...' onClick=\"SelectMedia('form1.$fieldname')\" />\r\n";

492 if(
	g$y
=="addon")

494 
$ùext
 = "<puty='xt'ame='$fldme' id='$fldme' vue='$fvue' sty='width:300px' css='xt' /> <pume='".
$fldme
."_bt' class='inputbut'ype='button' value='浏览...' onClick=\"SelectSoft('form1.$fieldname')\" />\r\n";

496 if(
	g$y
=="t"||
$y
=="float")

498 
$ùext
 = "<inputype='text'ame='$fieldname' id='$fieldname' style='width:100px' class='text' value='$fvalue' /> (填写数值)\r\n";

502 
	g$ùext
 = "<inputype='text'ame='$fieldname' id='$fieldname' style='width:250px' class='text' value='$fvalue' />\r\n";

504 
	g$fmem
 = 
r_a
('~me~',
$ag
->
GA
('emme'),
$fmem
);

505 
	g$fmem
 = 
r_a
('~fm~',
$ùext
,
$fmem
);

506  
	g$fmem
;

	@include/datalistcp.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('Request Error!');

6 
que_
(
DEDEINC
.'/dedetemplate.class.php');

7 
	g$codefe
 = (
ist
(
$edCode
? $edCod: 
$cfg_so_ng
);

8 if(
fe_exis
(
DEDEINC
.'/code/di.'.
$codefe
.'.inc'))

10 
que_
(
DEDEINC
.'/code/di.'.
$codefe
.'.inc');

14 
	g$ng_e_ge
 = '上页';

15 
	g$ng_xt_ge
 = '下页';

16 
	g$ng_dex_ge
 = '首页';

17 
	g$ng_d_ge
 = '末页';

18 
	g$ng_cd_numb
 = '条记录';

19 
	g$ng_ge
 = '页';

20 
	g$ng_tٮ
 = '共';

24 as
	cDaLiCP


26 
v
 
	m$dsql
;

27 
v
 
	m$l
;

28 
v
 
	m$geNO
;

29 
v
 
	m$tٮPage
;

30 
v
 
	m$tٮResu
;

31 
v
 
	m$geSize
;

32 
v
 
	m$gVues
;

33 
v
 
	m$sourSql
;

34 
v
 
	m$isQuy
;

35 
v
 
	m$quyTime
;

38 
funi
 
__cڡru
(
$lfe
='')

40 
$this
->
sourSql
='';

41 
	m$this
->
	mgeSize
=25;

42 
	m$this
->
	mquyTime
=0;

43 
	m$this
->
	mgVues
=
Aay
();

44 
	m$this
->
	misQuy
 = 
l
;

45 
	m$this
->
	mtٮResu
 = 0;

46 
	m$this
->
	mtٮPage
 = 0;

47 
	m$this
->
	mgeNO
 = 0;

48 
	m$this
->
	mdsql
 = 
$GLOBALS
['dsql'];

49 
	m$this
->
SV
('ParseEnv','datalist');

50 
	m$this
->
	ml
 = 
w
 
DedeTeme
();

51 if(
	m$GLOBALS
['cfg_tplcache']=='N')

53 
$this
->
l
->
isCache
 = 
l
;

55 if(
	m$lfe
!='')

57 
$this
->
l
->
LdTeme
(
$lfe
);

61 
funi
 
DaLiCP
(
$lfe
='')

63 
$this
->
__cڡru
(
$lfe
);

67 
funi
 
	$SSour
(
$sql
)

69 
$this
->
sourSql
 = 
$sql
;

70 
	}
}

74 
funi
 
	$STeme
(
$lfe
)

76 
$this
->
l
->
	`LdTeme
(
$lfe
);

77 
	}
}

78 
funi
 
	$STem
(
$lfe
)

80 
$this
->
l
->
	`LdTeme
(
$lfe
);

81 
	}
}

84 
funi
 
	$PLd
()

86 
glob
 
$tٮsu
,
$go
;

87 if(
	`emy
(
$go
|| 
	`eg
("[^0-9]",$pageno))

89 
$go
 = 1;

91 if(
	`emy
(
$tٮsu
|| 
	`eg
("[^0-9]",$totalresult))

93 
$tٮsu
 = 0;

95 
$this
->
geNO
 = 
$go
;

96 
$this
->
tٮResu
 = 
$tٮsu
;

98 if(
	`ist
(
$this
->
l
->
Cfgs
['pagesize']))

100 
$this
->
geSize
 = $this->
l
->
Cfgs
['pagesize'];

102 
$this
->
tٮPage
 = 
	`
($this->
tٮResu
/$this->
geSize
);

103 if(
$this
->
tٮResu
==0)

105 
$couQuy
 = 
	`egi_a
("[ \r\n\t](.*)[ \r\n\t]om","Se cou(*add From",
$this
->
sourSql
);

106 
$couQuy
 = 
	`egi_a
('order[ \r\n\t]{1,}by(.*)', '', $countQuery);

107 
$row
 = 
$this
->
dsql
->
	`GO
(
$couQuy
);

108 if(!
	`is_y
(
$row
)) $row['dd'] = 0;

109 
$this
->
tٮResu
 = 
$row
['dd'];

110 
$this
->
sourSql
 ."im 0,".$this->
geSize
;

114 
$this
->
sourSql
 ."im ".(($this->
geNO
-1* $this->
geSize
).",".$this->pageSize;

116 
	}
}

119 
funi
 
	$SPam
(
$key
,
$vue
)

121 
$this
->
gVues
[
$key
] = 
$vue
;

122 
	}
}

125 
funi
 
	$SV
(
$k
,
$v
)

127 
glob
 
$_vs
;

128 if(!
	`ist
(
$_vs
[
$k
]))

130 
$_vs
[
$k
] = 
$v
;

132 
	}
}

134 
funi
 
	$GV
(
$k
)

136 
glob
 
$_vs
;

137  
	`ist
(
$_vs
[
$k
]) ? $_vars[$k] : '';

138 
	}
}

141 
funi
 
GArcLi
(
$ts
,
$fObj
='',
$flds
=
	$y
())

143 
$rsAay
 = 
	`y
();

144 
$t1
 = 
	`Exeime
();

145 if(!
$this
->
isQuy
)

147 
$this
->
dsql
->
	`Execu
('dli',$this->
sourSql
);

149 
$i
 = 0;

150 
$r
=
$this
->
dsql
->
	`GAay
('dlist'))

152 
$i
++;

153 
$rsAay
[
$i
] = 
$r
;

154 if(
$i
 >
$this
->
geSize
)

159 
$this
->
dsql
->
	`FeResu
('dlist');

160 
$this
->
quyTime
 = (
	`Exeime
(- 
$t1
);

161  
$rsAay
;

162 
	}
}

165 
funi
 
GPageLi
(
$ts
,
$fObj
='',
$flds
=
	$y
())

167 
glob
 
$ng_e_ge
,
$ng_xt_ge
,
$ng_dex_ge
,
$ng_d_ge
,
$ng_cd_numb
,
$ng_ge
,
$ng_tٮ
;

168 
$age
 = 
$xage
 = 
$gu

$hidfm
 = '';

169 
$pu
 = 
$this
->
	`GCurU
();

170 
$agum
 = 
$this
->
geNO
-1;

171 
$xagum
 = 
$this
->
geNO
+1;

172 if(!
	`ist
(
$ts
['lisize']|| 
	`eg
("[^0-9]",$atts['listsize']))

174 
$ts
['listsize'] = 5;

176 if(!
	`ist
(
$ts
['listitem']))

178 
$ts
['listitem'] = "info,index,end,pre,next,pageno";

180 
$tٮge
 = 
	`
(
$this
->
tٮResu
/$this->
geSize
);

184 if(
$tٮge
<=1 && 
$this
->
tٮResu
 > 0)

186  "<>{$ng_tٮ} 1 {$ng_ge}/".
$this
->
tٮResu
.
$ng_cd_numb
."</span>";

188 if(
$this
->
tٮResu
 == 0)

190  "<>{$ng_tٮ} 0 {$ng_ge}/".
$this
->
tٮResu
.
$ng_cd_numb
."</span>";

192 
$fos
 = "<span>{$lang_total} {$totalpage} {$lang_page}/{$this->totalResult}{$lang_record_number} </span>";

193 if(
$this
->
tٮResu
!=0)

195 
$this
->
gVues
['tٮsu'] = $this->
tٮResu
;

197 if(
	`cou
(
$this
->
gVues
)>0)

199 
	`fܗch
(
$this
->
gVues
 
as
 
$key
=>
$vue
)

201 
$vue
 = 
	`ucode
($value);

202 
$gu
.="$key=$value"."&";

203 
$hidfm
.="<inputype='hidden'ame='$key' value='$value' />\n";

206 
$pu
 ."?".
$gu
;

209 if(
$this
->
geNO
!=1)

211 
$age
.="<ass='ePage' hf='".
$pu
."pageno=$prepagenum'>$lang_pre_page</a> \n";

212 
$dexge
="<ass='dexPage' hf='".
$pu
."pageno=1'>$lang_index_page</a> \n";

216 
$dexge
="<span class='indexPage'>"."$lang_index_page \n"."</span>";

218 if(
$this
->
geNO
!=
$tٮge
&&$totalpage>1)

220 
$xage
.="<ass='xtPage' hf='".
$pu
."pageno=$nextpagenum'>$lang_next_page</a> \n";

221 
$dge
="<ass='dPage' hf='".
$pu
."pageno=$totalpage'>$lang_end_page</a> \n";

225 
$dge
=" <strong>$lang_end_page</strong> \n";

229 
$lidd
="";

230 
$tٮ_li
 = 
$ts
['listsize'] * 2 + 1;

231 if(
$this
->
geNO
>=
$tٮ_li
)

233 
$j
=
$this
->
geNO
-
$ts
['listsize'];

234 
$tٮ_li
=
$this
->
geNO
+
$ts
['listsize'];

235 if(
$tٮ_li
>
$tٮge
)

237 
$tٮ_li
=
$tٮge
;

242 
$j
=1;

243 if(
$tٮ_li
>
$tٮge
)

245 
$tٮ_li
=
$tٮge
;

248 
$j
;$j<=
$tٮ_li
;$j++)

250 
$lidd
 .
$j
==
$this
->
geNO
 ? "<rg>$j</rg>\n" : "<hf='".
$pu
."pageno=$j'>".$j."</a>\n";

253 
$i
 = "<div class=\"pagelistbox\">\n";

256 if(
	`egi
("fo",
$ts
['listitem']))

258 
$i
 .
$fos
;

260 if(
	`egi
("dex",
$ts
['listitem']))

262 
$i
 .
$dexge
;

264 if(
	`egi
("e",
$ts
['listitem']))

266 
$i
 .
$age
;

268 if(
	`egi
("go",
$ts
['listitem']))

270 
$i
 .
$lidd
;

272 if(
	`egi
("xt",
$ts
['listitem']))

274 
$i
 .
$xage
;

276 if(
	`egi
("d",
$ts
['listitem']))

278 
$i
 .
$dge
;

280 if(
	`egi
("fm",
$ts
['listitem']))

282 
$i
 .=" <fmame='gi'i='".
$this
->
	`GCurU
()."' style='float:left;' class='pagelistform'>$hidenform";

283 if(
$tٮge
>
$tٮ_li
)

285 
$i
.="<inputype='text'ame='pageno' style='padding:0px;width:30px;height:18px;font-size:11px' />\r\n";

286 
$i
.="<inputype='submit'ame='plistgo' value='GO' style='padding:0px;width:30px;height:22px;font-size:11px' />\r\n";

288 
$i
 .= "</form>\n";

290 
$i
 .= "</div>\n";

291  
$i
;

292 
	}
}

295 
funi
 
	$GCurU
()

297 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

299 
$nowu
 = 
$_SERVER
["REQUEST_URI"];

300 
$nowus
 = 
	`exode
("?",
$nowu
);

301 
$nowu
 = 
$nowus
[0];

305 
$nowu
 = 
$_SERVER
["PHP_SELF"];

307  
$nowu
;

308 
	}
}

311 
funi
 
	$Clo
()

314 
	}
}

317 
funi
 
	$Diy
()

319 
$this
->
	`PLd
();

322 
$this
->
l
->
	`SObje
($this);

323 
$this
->
l
->
	`Diy
();

324 
	}
}

327 
funi
 
	$SaveTo
(
$fame
)

329 
$this
->
l
->
	`SaveTo
(
$fame
);

330 
	}
}

	@include/dedeatt.class.php

1 <?
php


6 as
	cDedeA


8 
v
 
	m$Cou
 = -1;

9 
v
 
	m$Ims
 = "";

12 
funi
 
	$GA
(
$r
)

14 if(
$r
=="")

18 if(
	`ist
(
$this
->
Ims
[
$r
]))

20  
$this
->
Ims
[
$r
];

29 
funi
 
	$GAribu
(
$r
)

31  
$this
->
	`GA
(
$r
);

32 
	}
}

35 
funi
 
	$IsAribu
(
$r
)

37  
	`ist
(
$this
->
Ims
[
$r
]? 
ue
 : 
l
;

38 
	}
}

41 
funi
 
	$GTagName
()

43  
$this
->
	`GA
("tagname");

44 
	}
}

47 
funi
 
	$GCou
()

49  
$this
->
Cou
+1;

50 
	}
}

57 as
	cDedeAP


59 
v
 
	m$SourSg
 = "";

60 
v
 
	m$SourMaxSize
 = 1024;

61 
v
 
	m$CA
 = "";

62 
v
 
	m$ChToLow
 = 
TRUE
;

65 
funi
 
SSour
(
$r
="")

67 
$this
->
CA
 = 
w
 
DedeA
();

68 
	m$rL
 = 0;

69 
	m$this
->
	mSourSg
 = 
im
(
eg_a
("/[ \t\r\n]{1,}/"," ",
$r
));

70 
	m$rL
 = 

(
$this
->
SourSg
);

71 if(
	m$rL
>0&&$rL<=
$this
->
SourMaxSize
)

73 
$this
->
PA
();

78 
funi
 
	$PA
()

80 
$d
 = "";

81 
$tm
="";

82 
$tmpvue
="";

83 
$tdd
=-1;

84 
$ddg
="";

85 
$nAribu
=
ue
;

86 
$rL
 = 
	`
(
$this
->
SourSg
);

91 
$i
=0;$i<
$rL
;$i++)

93 
$d
 = 
	`subr
(
$this
->
SourSg
,
$i
,1);

94 if(
$d
==' ')

96 
$this
->
CA
->
Cou
++;

97 if(
$this
->
ChToLow
)

99 
$this
->
CA
->
Ims
["gme"]=
	`ow
(
	`im
(
$tmpvue
));

103 
$this
->
CA
->
Ims
["gme"]=
	`im
(
$tmpvue
);

105 
$tmpvue
 = "";

106 
$nAribu
 = 
l
;

111 
$tmpvue
 .
$d
;

116 if(
$nAribu
)

118 
$this
->
CA
->
Cou
++;

119 
$this
->
CA
->
Ims
["gme"]($this->
ChToLow
 ? 
	`ow
(
	`im
(
$tmpvue
)) :rim($tmpvalue));

123 if(!
$nAribu
)

125 
$i
;$i<
$rL
;$i++)

127 
$d
 = 
	`subr
(
$this
->
SourSg
,
$i
,1);

128 if(
$tdd
==-1)

130 if(
$d
!="=")

132 
$tm
 .
$d
;

136 if(
$this
->
ChToLow
)

138 
$tm
 = 
	`ow
(
	`im
($tmpatt));

142 
$tm
 = 
	`im
($tmpatt);

144 
$tdd
=0;

147 if(
$tdd
==0)

149 
$d
)

155 
$ddg
='\'';

156 
$tdd
=1;

159 
$ddg
='"';

160 
$tdd
=1;

163 
$tmpvue
.=
$d
;

164 
$ddg
=' ';

165 
$tdd
=1;

169 if(
$tdd
==1)

171 if(
$d
==
$ddg
)

173 
$this
->
CA
->
Cou
++;

174 
$this
->
CA
->
Ims
[
$tm
] = 
	`im
(
$tmpvue
);

175 
$tm
 = "";

176 
$tmpvue
 = "";

177 
$tdd
=-1;

181 
$tmpvue
.=
$d
;

185 if(
$tm
!="")

187 
$this
->
CA
->
Cou
++;

188 
$this
->
CA
->
Ims
[
$tm
]=
	`im
(
$tmpvue
);

193 
	}
}

	@include/dedecollection.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('dedecms');

7 
que_
(
DEDEINC
."/dedecollection.func.php");

8 
que_
(
DEDEINC
."/image.func.php");

9 
que_
(
DEDEINC
."/dedehtml2.class.php");

10 @
t_time_lim
(0);

11 as
	cDedeCi


13 
v
 
	m$tNes
 = 
y
();

14 
v
 
	m$lis
 = 
y
();

15 
v
 
	m$neInfos
 = 
y
();

16 
v
 
	m$dsql
 = '';

17 
v
 
	m$neId
 = '';

18 
v
 
	m$cDedeHtml
 = '';

19 
v
 
	m$cHpDown
 = '';

20 
v
 
	m$medCou
 = 0;

21 
v
 
	m$tmpUnVue
 = '';

22 
v
 
	m$tmpLks
 = 
y
();

23 
v
 
	m$tmpHtml
 = '';

24 
v
 
	m$bImage
 = '';

25 
v
 
	m$rSg
 = '';

28 
funi
 
	$__cڡru
()

30 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

31 
$this
->
cHpDown
 = 
w
 
	`DedeHpDown
();

32 
$this
->
cDedeHtml
 = 
w
 
	`DedeHtml2
();

35 
funi
 
	$DedeCi
()

37 
$this
->
	`__cڡru
();

38 
	}
}

41 
funi
 
	$Clo
()

43 
	}
}

46 
funi
 
	$LdNe
(
$nid
)

48 
$this
->
neId
 = 
$nid
;

49 
$row
 = 
$this
->
dsql
->
	`GO
("Select * from `#@__co_note` whereid='$nid'");

50 
$this
->
	`LdLiCfig
(
$row
['listconfig']);

51 
$this
->
	`LdImCfig
(
$row
['itemconfig']);

52 
	}
}

55 
funi
 
	$LdLiCfig
(
$cfigSg
)

57 
$d
 = 
w
 
	`DedeTagP
();

58 
$d2
 = 
w
 
	`DedeTagP
();

59 
$d
->
	`LdSg
(
$cfigSg
);

60 
$i
=0;$i<=
$d
->
Cou
;$i++)

62 
$ag
 = 
$d
->
CTags
[
$i
];

66 if(
$ag
->
	`GName
()=="noteinfo")

68 
$this
->
neInfos
['nْame'] = 
$ag
->
	`GA
('notename');

69 
$this
->
neInfos
['mchty'] = 
$ag
->
	`GA
('matchtype');

70 
$this
->
neInfos
['chlid'] = 
$ag
->
	`GA
('channelid');

71 
$this
->
neInfos
['fu'] = 
$ag
->
	`GA
('refurl');

72 
$this
->
neInfos
['sourng'] = 
$ag
->
	`GA
('sourcelang');

73 
$this
->
neInfos
['cost'] = 
$ag
->
	`GA
('cosort');

74 
$this
->
neInfos
['ief'] = 
$ag
->
	`GA
('isref');

75 
$this
->
neInfos
['exime'] = 
$ag
->
	`GA
('exptime');

80 if(
$ag
->
	`GName
()=="listrule")

82 
$this
->
lis
['sourty'] = 
$ag
->
	`GA
('sourcetype');

83 
$this
->
lis
['rssu'] = 
$ag
->
	`GA
('rssurl');

84 
$this
->
lis
['gxu'] = 
$ag
->
	`GA
('regxurl');

85 
$this
->
lis
['tid'] = 
$ag
->
	`GA
('startid');

86 
$this
->
lis
['did'] = 
$ag
->
	`GA
('endid');

87 
$this
->
lis
['addv'] = 
$ag
->
	`GA
('addv');

88 
$this
->
lis
['uru'] = 
$ag
->
	`GA
('urlrule');

89 
$this
->
lis
['muhas'] = 
$ag
->
	`GA
('musthas');

90 
$this
->
lis
['nhas'] = 
$ag
->
	`GA
('nothas');

91 
$this
->
lis
['lipic'] = 
$ag
->
	`GA
('listpic');

92 
$this
->
lis
['ume'] = 
$ag
->
	`GA
('usemore');

93 
$d2
->
	`LdSg
(
$ag
->
	`GIText
());

94 
$j
=0;$j<=
$d2
->
Cou
;$j++)

96 
$ag2
 = 
$d2
->
CTags
[
$j
];

97 
$ame
 = 
$ag2
->
	`GName
();

98 if(
$ame
=='addurls')

100 
$this
->
lis
['addus'] = 
	`im
(
$ag2
->
	`GIText
());

102 if(
$ame
=='regxrule')

104 
$this
->
lis
['gxru'] = 
	`im
(
$ag2
->
	`GIText
());

106 if(
$ame
=='areastart')

108 
$this
->
lis
['t'] = 
	`im
(
$ag2
->
	`GIText
());

110 if(
$ame
=='areaend')

112 
$this
->
lis
['d'] = 
	`im
(
$ag2
->
	`GIText
());

114 if(
$ame
=='batchrule')

116 
$this
->
lis
['bchru'] = 
	`im
(
$ag2
->
	`GIText
());

121 if(
$this
->
lis
['sourcetype'] != 'rss')

123 
$this
->
lis
['u'] = 
	`GUFromLiRu
($this->lists['regxurl'],$this->lists['addurls'],

124 
$this
->
lis
['startid'],$this->lists['endid'],$this->lists['addv'],$this->lists['usemore'],$this->lists['batchrule']);

128 
$this
->
lis
['url'] = $this->lists['rssurl'];

133 
$d
->
	`Cˬ
();

134 
$d2
->
	`Cˬ
();

135 
	}
}

138 
funi
 
	$LdImCfig
(
$cfigSg
)

140 
$d
 = 
w
 
	`DedeTagP
();

141 
$d2
 = 
w
 
	`DedeTagP
();

142 
$d
->
	`LdSg
(
$cfigSg
);

143 
$i
=0;$i<=
$d
->
Cou
;$i++)

145 
$ag
 = 
$d
->
CTags
[
$i
];

146 if(
$ag
->
	`GName
()=='sppage')

148 
$this
->
tNes
['ge'] = 
$ag
->
	`GIText
();

149 
$this
->
tNes
['ty'] = 
$ag
->
	`GA
('sptype');

151 if(
$ag
->
	`GName
()=='previewurl')

153 
$this
->
tNes
['evwu'] = 
$ag
->
	`GIText
();

155 if(
$ag
->
	`GName
()=='keywordtrim')

157 
$this
->
tNes
['keywdim'] = 
$ag
->
	`GIText
();

159 if(
$ag
->
	`GName
()=='descriptiontrim')

161 
$this
->
tNes
['destiڌim'] = 
$ag
->
	`GIText
();

163 if(
$ag
->
	`GName
()=='item')

165 
$fld
 = 
$ag
->
	`GA
('field');

166 if(
$fld
 == '')

170 
$this
->
tNes
[
$fld
]['vue'] = 
$ag
->
	`GA
('value');

171 
$this
->
tNes
[
$fld
]['isun'] = 
$ag
->
	`GA
('isunit');

172 
$this
->
tNes
[
$fld
]['isdown'] = 
$ag
->
	`GA
('isdown');

173 
$this
->
tNes
[
$fld
]['im'] = 
	`y
();

174 
$this
->
tNes
[
$fld
]['match'] = '';

175 
$this
->
tNes
[
$fld
]['function'] = '';

176 
$t
 = 0;

177 
$d2
->
	`LdSg
(
$ag
->
	`GIText
());

178 
$k
=0;$k<=
$d2
->
Cou
;$k++)

180 
$ag2
 = 
$d2
->
CTags
[
$k
];

181 if(
$ag2
->
	`GName
()=='trim')

183 
$this
->
tNes
[
$fld
]['im'][
$t
][0] = 
	`r_a
('#n#','&nb;',
$ag2
->
	`GIText
());

184 
$this
->
tNes
[
$fld
]['im'][
$t
][1] = 
$ag2
->
	`GA
('replace');

185 
$t
++;

187 if(
$ag2
->
	`GName
()=='match')

189 
$this
->
tNes
[
$fld
]['mch'] = 
	`r_a
('#n#','&nb;',
$ag2
->
	`GIText
());

191 if(
$ag2
->
	`GName
()=='function')

193 
$this
->
tNes
[
$fld
]['funi'] = 
$ag2
->
	`GIText
();

199 
$d
->
	`Cˬ
();

200 
$d2
->
	`Cˬ
();

201 
	}
}

204 
funi
 
DownU
(
$aid
,
$dou
,
$lpic
='',
$isve
=
ue
)

206 
$this
->
tmpLks
 = 
y
();

207 
	g$this
->
	gtmpUnVue
 = '';

208 
	g$this
->
	gbImage
 = '';

209 
	g$this
->
	gtmpHtml
 = 
$this
->
DownOPage
(
$dou
);

212 if(!
emy
(
$this
->
tNes
['sppage']))

214 
	g$neid
 = '';

215 
fܗch
(
$this
->
tNes
 
as
 
$k
=>
$
)

217 if(
ist
(
$
['isunit']) && $sarr['isunit']==1)

219 
$neid
 = 
$k
;

223 
	g$this
->
GSpPage
(
$dou
,
$neid
,
$this
->
tmpHtml
);

225 if(
egi
('#p#',
$this
->
tmpUnVue
))

227 
	g$this
->
	gtmpUnVue
 = '副标题#e#'.
$this
->
tmpUnVue
;

233 
	g$body
 = 
$this
->
GPageFlds
(
$dou
,
$isve
,
$lpic
);

236 if(
	g$isve
)

238 
	g$quy
 = " Upd`#@__co_htmls` s dtime='".
time
()."',su='".
addashes
(
$body
)."',isdown='1' whereid='$aid' ";

239 if(!
	g$this
->
	gdsql
->
ExecuNeQuy
(
$quy
))

241 
echo
 
	g$this
->
	gdsql
->
GE
();

243  
	g$body
;

245  
	g$body
;

249 
funi
 
	$GSpPage
(
$dou
,
$neid
,
$html
,
$
=0)

251 
$
 = 
$this
->
tNes
[
$neid
];

252 
$lkHtml
 = 
$this
->
	`GHtmlAa
('[内容]',$this->
tNes
['ge'],
$html
);

253 if(
$lkHtml
=='')

255 if(
$this
->
tmpUnVue
=='')

257 
$this
->
tmpUnVue
 .$this->
	`GHtmlAa
('[内容]',
$
['mch'],
$html
);

261 
$this
->
tmpUnVue
 ."#p#副标题#e#".$this->
	`GHtmlAa
('[内容]',
$
['mch'],
$html
);

267 if(
$this
->
tNes
["sptype"]=='full' || $this->artNotes["sptype"]=='')

269 
$this
->
tmpUnVue
 .$this->
	`GHtmlAa
('[内容]',
$
['mch'],
$html
);

270 
$this
->
cDedeHtml
->
GLkTy
 = "link";

271 
$this
->
cDedeHtml
->
	`SSour
(
$lkHtml
,
$dou
,'link');

272 
	`fܗch
(
$this
->
cDedeHtml
->
Lks
 
as
 
$k
=>
$t
)

274 
$k
 = 
$this
->
cDedeHtml
->
	`FlU
($k);

275 if(
$k
==
$dou
)

279 
$nhtml
 = 
$this
->
	`DownOPage
(
$k
);

280 if(
$nhtml
!='')

282 
$
 = 
	`im
(
$this
->
	`GHtmlAa
('[内容]',
$
['mch'],
$nhtml
));

283 if(
$
!='')

285 
$this
->
tmpUnVue
 ."#p#副标题#e#".
$
;

294 if(
$
>50)

298 if(
$
==0)

300 
$this
->
tmpUnVue
 .$this->
	`GHtmlAa
('[内容]',
$
['mch'],
$html
);

302 
$this
->
cDedeHtml
->
GLkTy
 = "link";

303 
$this
->
cDedeHtml
->
	`SSour
(
$lkHtml
,
$dou
,'link');

304 
$hasLk
 = 
l
;

305 
	`fܗch
(
$this
->
cDedeHtml
->
Lks
 
as
 
$k
=>
$t
)

307 
$k
 = 
$this
->
cDedeHtml
->
	`FlU
($k);

308 if(
	`_y
(
$k
,
$this
->
tmpLks
))

313 
$nhtml
 = 
$this
->
	`DownOPage
(
$k
);

314 if(
$nhtml
!='')

316 
$
 = 
	`im
(
$this
->
	`GHtmlAa
('[内容]',
$
['mch'],
$nhtml
));

317 if(
$
!='')

319 
$this
->
tmpUnVue
 ."#p#副标题#e#".
$
;

322 
$hasLk
 = 
ue
;

323 
$this
->
tmpLks
[] = 
$k
;

324 
$dou
 = 
$k
;

325 
$
++;

328 if(
$hasLk
)

330 
$this
->
	`GSpPage
(
$dou
,
$neid
,
$nhtml
,
$
);

333 
	}
}

336 
funi
 
	$GHtmlAa
(
$g
,&
$Ru
,&
$html
)

339 if(
$this
->
neInfos
['matchtype']=='regex')

341 
$Ru
 = 
	`r_a
("/","\\/",$areaRule);

342 
$Rus
 = 
	`exode
(
$g
,
$Ru
);

343 
$r
 = 
	`y
();

344 if(
$html
==''||
$Rus
[0]=='')

348 
	`eg_mch
('/'.
$Rus
[0]."(.*)".$Rus[1]."/isU",
$html
,
$r
);

349  
	`emy
(
$r
[1]? '' : 
	`im
($arr[1]);

355 
$Rus
 = 
	`exode
(
$g
,
$Ru
);

356 if(
$html
=='' || 
$Rus
[0]=='')

360 
$post
 = @
	`os
(
$html
,
$Rus
[0]);

361 if(
$post
===
l
)

365 
$pond
 = @
	`os
(
$html
,
$Rus
[1],
$post
);

366 if(
$pond
 > 
$post
 && $pond!==
l
)

368  
	`subr
(
$html
,
$post
+
	`
(
$Rus
[0]),
$pond
-$posstart-strlen($areaRules[0]));

375 
	}
}

378 
funi
 
	$DownOPage
(
$dou
)

380 
$this
->
cHpDown
->
	`OnU
(
$dou
);

381 
$html
 = 
$this
->
cHpDown
->
	`GHtml
();

382 
$this
->
cHpDown
->
	`Clo
();

383 
$this
->
	`ChgeCode
(
$html
);

384  
$html
;

385 
	}
}

388 
funi
 
DownMed
(
$dou
,
$mty
='img',
$ipic
=
l
)

390 
glob
 
$nckpic
;

391 if(
emy
(
$nckpic
))

393 
	g$nckpic
 = 0;

397 
	g$wi
 = 
l
;

398 
	g$tofe
 = 
$fame
 = '';

399 if(
	g$nckpic
==0)

401 
$row
 = 
$this
->
dsql
->
GO
("Se hash,tofom `#@__co_medus` whnid='{$this->neId}' And hash='".
md5
(
$dou
)."' ");

402 if(
ist
(
$row
['tofile']))

404 
	g$tofe
 = 
$fame
 = 
$row
['tofile'];

409 if(
	g$tofe
=='' || !
fe_exis
(
$GLOBALS
['cfg_bad'].
$fame
))

411 
$fame
 = 
$this
->
GRndName
(
$dou
,
$mty
);

412 if(!
eg
("^/",
$fame
))

414 
	g$fame
 = "/".
$fame
;

418 if(
	g$this
->
	gneInfos
['ief']=='yes' && 
$this
->
neInfos
['refurl']!='')

420 if(
$this
->
neInfos
['exptime']=='')

422 
$this
->
neInfos
['exptime'] = 10;

424 
DownImageKp
(
$dou
,
$this
->
neInfos
['fu'],
$GLOBALS
['cfg_bad'].
$fame
,'',0,$this->
Im
['exptime']);

430 
	g$this
->
	gcHpDown
->
OnU
(
$dou
);

431 
	g$this
->
	gcHpDown
->
SaveToB
(
$GLOBALS
['cfg_bad'].
$fame
);

432 
	g$this
->
	gcHpDown
->
Clo
();

436 if(
fe_exis
(
$GLOBALS
['cfg_bad'].
$fame
))

438 if(
	g$tofe
=='')

440 
$quy
 = "INSERT INTO `#@__co_medus`id,hash,tofeVALUES ('".
$this
->
neId
."', '".
md5
(
$dou
)."', '".
addashes
(
$fame
)."');";

444 
	g$quy
 = "Upd`#@__co_medus` sofe='".
addashes
(
$fame
)."' whhash='".
md5
(
$dou
)."' ";

446 
	g$this
->
	gdsql
->
ExecuNeQuy
(
$quy
);

451 if(!
fe_exis
(
$GLOBALS
['cfg_bad'].
$fame
))

453  
	g$dou
;

457 if(
	g$mty
=='img' && !
$ipic
 && 
$this
->
bImage
=='')

459 
$this
->
bImage
 = 
$fame
;

460 if(!
egi
("^hp://",
$this
->
bImage
&& 
fe_exis
(
$GLOBALS
['cfg_bad'].
$fame
))

462 
	g$fames
 = 
exode
('/',
$fame
);

463 
	g$famed
 = 
$fames
[
cou
($filenames)-1];

464 
	g$nfame
 = 
r_a
('.','_l.',
$famed
);

465 
	g$nfame
 = 
r_a
(
$famed
,
$nfame
,
$fame
);

466 if(@
cy
(
$GLOBALS
['cfg_bad'].
$fame
,$GLOBALS['cfg_bad'].
$nfame
))

468 
ImageResize
(
$GLOBALS
['cfg_bad'].
$nfame
,$GLOBALS['cfg_ddimg_width'],$GLOBALS['cfg_ddimg_height']);

469 
	g$this
->
	gbImage
 = 
$nfame
;

473 if(
	g$mty
=='img' && !
$ipic
)

475 @
WImg
(
$GLOBALS
['cfg_bad'].
$fame
,'collect');

477  
	g$fame
;

481 
funi
 
	$GRndName
(
$u
,
$v
)

483 
glob
 
$cfg_image_d
,
$cfg_d_purvw
;

484 
$this
->
medCou
++;

485 
$mnum
 = 
$this
->
medCou
;

486 
$timed
 = "c".
	`MyDe
("ymd",
	`time
());

488 
$fuu
 = 
	`eg_a
("/\/{1,}/","/",
$cfg_image_d
."/");

489 if(!
	`is_d
(
$GLOBALS
['cfg_basedir']."/$fullurl"))

491 
	`MkdA
(
$GLOBALS
['cfg_bad']."/$fuu",
$cfg_d_purvw
);

494 
$fuu
 = $fuu.
$timed
."/";

495 if(!
	`is_d
(
$GLOBALS
['cfg_basedir']."/$fullurl"))

497 
	`MkdA
(
$GLOBALS
['cfg_bad']."/$fuu",
$cfg_d_purvw
);

501 
$timame
 = 
	`r_a
('.','',
	`ExecTime
());

502 
$thadnum
 = 0;

503 if(
	`ist
(
$_GET
['threadnum']))

505 
$thadnum
 = 
	`tv
(
$_GET
['threadnum']);

507 
$fame
 = 
	`dd2ch
(
$timame
.
$thadnum
.'-'.
$mnum
.
	`mt_nd
(1000,9999));

510 
$us
 = 
	`exode
('.',
$u
);

511 if(
$v
=='img')

513 
$sh܊ame
 = '.jpg';

514 if(
	`egi
("\.gif",
$v
))

516 
$sh܊ame
 = '.gif';

518 if(
	`egi
("\.g",
$v
))

520 
$sh܊ame
 = '.png';

523 if(
$v
=='embed')

525 
$sh܊ame
 = '.swf';

529 
$sh܊ame
 = '';

531 
$fume
 = 
$fuu
.
$fame
.
$sh܊ame
;

532  
	`eg_a
("/\/{1,}/","/",
$fume
);

533 
	}
}

536 
funi
 
GPageFlds
(
$dou
,
$edDown
,
$lpic
='')

538 
glob
 
$cfg_au_desti
;

539 if(
	g$this
->
	gtmpHtml
 == '')

543 
	g$tem
 = '';

544 
	g$isPutUn
 = 
l
;

545 
	g$tmpLtKeys
 = 
y
();

546 
	g$r
 = 
y
();

549 
eg_mch
("/<ma[\s]+me=['\"]keywds['\"] cڋ=['\"](.*)['\"]/isU",
$this
->
tmpHtml
,
$r
);

550 
eg_mch
("/<ma[\s]+cڋ=['\"](.*)['\"]ame=['\"]keywds['\"]/isU",
$this
->
tmpHtml
,
$r2
);

551 if(!
ist
(
$r
[1]&& ist(
$r2
[1]))

553 
	g$r
[1] = 
$r2
[1];

555 if(
ist
(
$r
[1]))

557 
	g$keywds
 = 
im
(
_subr
(
html2xt
(
$r
[1]),30));

558 
	g$keywds
 = 
eg_a
("/".
$this
->
tNes
['keywdim']."/isU",'',
$keywds
);

559 if(!
eg
(',',
$keywds
))

561 
	g$keywds
 = 
r_a
(' ',',',
$keywds
);

563 
	g$tem
 ."{dede:fldame='keywds'}".
$keywds
."{/dede:field}\r\n";

567 
	g$tem
 .= "{dede:fieldame='keywords'}{/dede:field}\r\n";

569 
eg_mch
("/<ma[\s]+me=['\"]desti['\"] cڋ=['\"](.*)['\"]/isU",
$this
->
tmpHtml
,
$r
);

570 
eg_mch
("/<ma[\s]+cڋ=['\"](.*)['\"]ame=['\"]desti['\"]/isU",
$this
->
tmpHtml
,
$r2
);

571 if(!
ist
(
$r
[1]&& ist(
$r2
[1]))

573 
	g$r
[1] = 
$r2
[1];

575 if(
ist
(
$r
[1]))

577 
	g$desti
 = 
im
(
_subr
(
html2xt
(
$r
[1]),
$cfg_au_desti
));

578 
	g$desti
 = 
eg_a
("/".
$this
->
tNes
['destiڌim']."/isU",'',
$desti
);

579 
	g$tem
 ."{dede:fldame='desti'}".
$desti
."{/dede:field}\r\n";

583 
	g$tem
 .= "{dede:fieldame='description'}{/dede:field}\r\n";

586 
fܗch
(
$this
->
tNes
 
as
 
$k
=>
$
)

589 if(
$k
=='sppage' || $k=='sptype')

593 if(!
is_y
(
$
))

599 if(
	g$
['mch']=='' || 
im
(
$
['match'])=='[内容]')

601 if(
$
['value']!='[内容]')

603 
$v
 = 
im
(
$
['value']);

607 
	g$v
 = '';

613 if(
	g$this
->
	gtmpUnVue
!='' && !
$isPutUn
 && 
$
['isunit']==1)

615 
$v
 = 
$this
->
tmpUnVue
;

616 
	g$isPutUn
 = 
ue
;

620 
	g$v
 = 
$this
->
GHtmlAa
('[内容]',
$
['mch'],$this->
tmpHtml
);

624 if(
ist
(
$
['im']&& 
	g$v
!='')

626 
fܗch
(
$
['im'] 
as
 
$nv
)

628 if(
$nv
[0]=='')

632 
	g$nvs
 = 
r_a
("/","\\/",
$nv
[0]);

633 
	g$v
 = 
eg_a
("/".
$nvs
."/isU",
$nv
[1],
$v
);

638 if(
	g$edDown
)

640 if(
	g$
['isdown'] == '1')

642 
$v
 = 
$this
->
DownMeds
($v,
$dou
);

647 if(
	g$
['isdown'] == '1')

649 
$v
 = 
$this
->
MedsR
($v,
$dou
);

653 
	g$v
 = 
im
(
$v
);

656 if(
	g$
['function'] != '')

658 
$tmpLtKeys
[
$k
]['v'] = 
$v
;

659 
	g$tmpLtKeys
[
$k
]['f'] = 
$
['function'];

663 
	g$v
 = 
eg_a
("(　)$",'',
$v
);

664 
	g$v
 = 
eg_a
("[\r\n\]{1,}$",'',
$v
);

665 
	g$tem
 .= "{dede:fieldame='$k'}$v{/dede:field}\r\n";

670 
fܗch
(
$tmpLtKeys
 
as
 
$k
=>
$
)

672 
$v
 = 
$this
->
RunPHP
(
$
['v'],$sarr['f']);

673 
	g$v
 = 
eg_a
("(　)$",'',
$v
);

674 
	g$v
 = 
eg_a
("[\r\n\]{1,}$",'',
$v
);

675 
	g$tem
 .= "{dede:fieldame='$k'}$v{/dede:field}\r\n";

677 if(
	g$lpic
!='' && 
$this
->
lis
['listpic']==1)

679 
$tem
 ."{dede:fldame='lpic'}".
$this
->
DownMed
(
$lpic
,'img',
ue
)."{/dede:field}\r\n";

683 
	g$tem
 ."{dede:fldame='lpic'}".
$this
->
bImage
."{/dede:field}\r\n";

685  
	g$tem
;

689 
funi
 
	$DownMeds
(&
$html
,
$u
)

691 
$this
->
cDedeHtml
->
	`SSour
(
$html
,
$u
,'media');

694 
	`fܗch
(
$this
->
cDedeHtml
->
Meds
 
as
 
$k
=>
$v
)

696 
$fu
 = 
$this
->
cDedeHtml
->
	`FlU
(
$k
);

697 if(
$v
=='embed' && !
	`egi
("\.(swf)\?(.*)$",
$k
)&& !eregi("\.(swf)$",$k))

701 
$oku
 = 
$this
->
	`DownMed
(
$fu
,
$v
);

702 
$html
 = 
	`r_a
(
$k
,
$oku
,$html);

706 
	`fܗch
(
$this
->
cDedeHtml
->
Lks
 
as
 
$v
=>
$k
)

708 if(
	`egi
("\.(jpg|gif|g)\?(.*)$",
$v
) ||regi("\.(jpg|gif|png)$",$v))

710 
$m
 = "img";

712 if(
	`egi
("\.(swf)\?(.*)$",
$v
) ||regi("\.(swf)$",$v))

714 
$m
 = "embed";

720 
$fu
 = 
$this
->
cDedeHtml
->
	`FlU
(
$v
);

721 
$oku
 = 
$this
->
	`DownMed
(
$fu
,
$m
);

722 
$html
 = 
	`r_a
(
$v
,
$oku
,$html);

724  
$html
;

725 
	}
}

728 
funi
 
	$MedsR
(&
$html
,
$dou
)

730 
$this
->
cDedeHtml
->
	`SSour
(
$html
,
$dou
,'media');

731 
	`fܗch
(
$this
->
cDedeHtml
->
Meds
 
as
 
$k
=>
$v
)

733 
$k
 = 
	`im
($k);

734 
$oku
 = 
$this
->
cDedeHtml
->
	`FlU
(
$k
);

735 
$html
 = 
	`r_a
(
$k
,
$oku
,$html);

737  
$html
;

738 
	}
}

741 
funi
 
	$Telis
(&
$dou
)

743 
$lks
 = 
	`y
();

746 if(
$this
->
lis
['sourcetype']=='rss')

748 
$dou
 = 
$this
->
lis
['rssurl'];

749 
$lks
 = 
	`GRssLks
(
$dou
);

750  
$lks
;

754 if(
	`ist
(
$this
->
lis
['url'][0][0]))

756 
$dou
 = 
$this
->
lis
['url'][0][0];

760 
$dou
 = '';

761 
$this
->
rSg
 = "配置中指定列表的网址错误!\r\n";

762  
$lks
;

764 
$dhtml
 = 
w
 
	`DedeHtml2
();

765 
$html
 = 
$this
->
	`DownOPage
(
$dou
);

766 if(
$html
=='')

768 
$this
->
rSg
 = "读取网址： $dourl 时失败！\r\n";

769  
$lks
;

771 if
	`im
(
$this
->
lis
['areastart']) !='' &&rim($this->lists['areaend']) != '' )

773 
$body
 = 
$this
->
lis
['areastart'].'[var:区域]'.$this->lists['areaend'];

774 
$html
 = 
$this
->
	`GHtmlAa
('[v:区域]',
$body
,$html);

776 
$t1
 = 
	`ExecTime
();

777 
$dhtml
->
	`SSour
(
$html
,
$dou
,'link');

778 
	`fܗch
(
$dhtml
->
Lks
 
as
 
$s
)

780 if(
$this
->
lis
['nothas']!='')

782 if
	`egi
(
$this
->
lis
['nhas'],
$s
['link']) )

787 if(
$this
->
lis
['musthas']!='')

789 if!
	`egi
(
$this
->
lis
['muhas'],
$s
['link']) )

794 
$lks
[] = 
$s
;

796  
$lks
;

797 
	}
}

800 
funi
 
	$TeA
(
$dou
)

802  
$this
->
	`DownU
(0,
$dou
,'',
l
);

803 
	}
}

806 
funi
 
	$GSourU
(
$ii
=0,
$glt
=0,
$gesize
=10)

810 if(
$glt
==0)

813 if(
$ii
 == -1)

815 
$this
->
dsql
->
	`ExecuNeQuy
("DFrom `#@__co_us` whnid='".$this->
neId
."'");

816 
$this
->
dsql
->
	`ExecuNeQuy
("DFrom `#@__co_htmls` whnid='".$this->
neId
."' ");

821 
$this
->
dsql
->
	`ExecuNeQuy
("DFrom `#@__co_htmls` whnid='".$this->
neId
."' And isexport=1 ");

826 if(
$this
->
lis
['sourcetype']=='rss')

828 
$lks
 = 
	`GRssLks
(
$this
->
lis
['rssurl']);

830 
$tmk
 = 
	`krst
(
$lks
);

831 
	`fܗch
(
$lks
 
as
 
$v
)

833 if(
$ii
==1)

835 
$ow
 = 
$this
->
dsql
->
	`GO
("Se * From `#@__co_us` whnid='{$this->neId}' And hash='".
	`md5
(
$v
['link'])."' ");

836 if(
	`is_y
(
$ow
))

842 
$quy
 = "INSERT INTO `#@__co_htmls` (`nid` ,`typeid`, `title` , `litpic` , `url` , `dtime` , `isdown` , `isexport` , `result`)

843 
	`VALUES
 ('{$this->neId}' , '0', '".addashes($v['
t
'])."' , '".addashes($v['
image
'])."' , '".addashes($v['
lk
'])."' , 'dtime' , '0' , '0' , ''); ";

844 
$this
->
dsql
->
	`ExecuNeQuy
(
$quy
);

846 
$quy
 = "INSERT INTO `#@__co_us`(hash,nidVALUES ('".
	`md5
(
$v
['link'])."','{$this->noteId}');";

847 
$this
->
dsql
->
	`ExecuNeQuy
(
$quy
);

853 
$tmk
 = 
	`y
();

854 
$rS
 = 0;

855 
$movPoi
 = 0;

856 
$dpos
 = 
$glt
 + 
$gesize
;

857 
$tٮn
 = 
	`cou
(
$this
->
lis
['url']);

858 
	`fܗch
(
$this
->
lis
['u'] 
as
 
$k
=>
$curus
)

860 
$curu
 = 
$curus
[0];

861 
$tyid
 = (
	`emy
(
$curus
[1]) ? 0 : $cururls[1]);

862 
$movPoi
++;

863 if(
$movPoi
 > 
$dpos
)

867 if(
$movPoi
 > 
$glt
)

869 
$html
 = 
$this
->
	`DownOPage
(
$curu
);

870 if
	`im
(
$this
->
lis
['areastart']) !='' &&rim($this->lists['areaend']) != '' )

872 
$body
 = 
$this
->
lis
['areastart'].'[var:区域]'.$this->lists['areaend'];

873 
$html
 = 
$this
->
	`GHtmlAa
('[v:区域]',
$body
,$html);

875 
$this
->
cDedeHtml
->
	`SSour
(
$html
,
$curu
,'link');

876 
$lk
 = 0;

877 
	`fܗch
(
$this
->
cDedeHtml
->
Lks
 
as
 
$k
=>
$v
)

879 if(
$this
->
lis
['nothas']!='')

881 if
	`egi
(
$this
->
lis
['nhas'],
$v
['link']) )

886 if(
$this
->
lis
['musthas']!='')

888 if!
	`egi
(
$this
->
lis
['muhas'],
$v
['link']) )

893 
$tmk
[
$rS
][0] = 
$v
;

894 
$tmk
[
$rS
][1] = 
$tyid
;

895 
$rS
++;

896 
$lk
++;

898 
$this
->
cDedeHtml
->
	`Cˬ
();

903 
	`krst
(
$tmk
);

904 
$unum
 = 
	`cou
(
$tmk
);

905 if(
$unum
>0)

908 
	`fܗch
(
$tmk
 
as
 
$vs
)

910 
$v
 = 
$vs
[0];

911 
$tyid
 = 
$vs
[1];

912 if(
$ii
==1)

914 
$ow
 = 
$this
->
dsql
->
	`GO
("Se * From `#@__co_us` whnid='{$this->neId}' And hash='".
	`md5
(
$v
['link'])."' ");

915 if(
	`is_y
(
$ow
))

920 
$quy
 = "INSERT INTO `#@__co_htmls` (`nid` ,`typeid`, `title` , `litpic` , `url` , `dtime` , `isdown` , `isexport` , `result`)

921 
	`VALUES
 ('{$this->neId}' ,'$tyid', '".addashes($v['
t
'])."' , '".addashes($v['
image
'])."' , '".addashes($v['
lk
'])."' , '".time()."' , '0' , '0' , ''); ";

922 
$this
->
dsql
->
	`ExecuNeQuy
(
$quy
);

924 
$quy
 = "INSERT INTO `#@__co_us`(hash,nidVALUES ('".
	`md5
(
$v
['link'])."','{$this->noteId}');";

925 
$this
->
dsql
->
	`ExecuNeQuy
(
$quy
);

927 if(
$dpos
 >
$tٮn
)

933  (
$tٮn
-
$dpos
);

939 if(
$glt
==0)

945 if(
$dpos
 >
$tٮn
)

951  (
$tٮn
-
$dpos
);

955 
	}
}

958 
funi
 
	$RunPHP
(
$fvue
,
$phpcode
)

960 
$DedeMeVue
 = 
$fvue
;

961 
$phpcode
 = 
	`eg_a
("/'@me'|\"@me\"|@me/isU",'$DedeMeValue',$phpcode);

962 if(
	`egi
('@body',
$phpcode
))

964 
$DedeBodyVue
 = 
$this
->
tmpHtml
;

965 
$phpcode
 = 
	`eg_a
("/'@body'|\"@body\"|@body/isU",'$DedeBodyValue',$phpcode);

967 if(
	`egi
('@lpic',
$phpcode
))

969 
$DedeLPicVue
 = 
$this
->
bImage
;

970 
$phpcode
 = 
	`eg_a
("/'@litpic'|\"@litpic\"|@litpic/isU",'$DedeLitPicValue',$phpcode);

972 
	`ev
(
$phpcode
.";");

973  
$DedeMeVue
;

974 
	}
}

977 
funi
 
	$ChgeCode
(&
$r
)

979 
glob
 
$cfg_so_ng
;

980 if(
$cfg_so_ng
=='utf-8')

982 if(
$this
->
neInfos
["sourcelang"]=="gb2312")

984 
$r
 = 
	`gb2utf8
($str);

986 if(
$this
->
neInfos
["sourcelang"]=="big5")

988 
$r
 = 
	`gb2utf8
(
	`big52gb
($str));

993 if(
$this
->
neInfos
["sourcelang"]=="utf-8")

995 
$r
 = 
	`utf82gb
($str);

997 if(
$this
->
neInfos
["sourcelang"]=="big5")

999 
$r
 = 
	`big52gb
($str);

1002 
	}
}

	@include/dedecollection.func.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('dedecms');

6 
que_
(
DEDEINC
."/dedehttpdown.class.php");

7 
que_
(
DEDEINC
."/dedetag.class.php");

8 
que_
(
DEDEINC
."/charset.func.php");

10 
funi
 
DownImageKp
(
$gu
,
$rfu
,
$fame
,
$gcook
="",
$JumpCou
=0,
$maxtime
=30)

12 
$ufos
 = 
GHoInfo
(
$gu
);

13 
	g$gho
 = 
im
(
$ufos
['host']);

14 if(
	g$gho
=='')

16  
l
;

18 
	g$gquy
 = 
$ufos
['query'];

19 if(
	g$gcook
=="" && !
emy
(
$rfu
))

21 
$gcook
 = 
RefuCook
(
$rfu
);

23 
	g$ssiQuy
 = "GET $gquery HTTP/1.1\r\n";

24 
	g$ssiQuy
 .= "Host: $ghost\r\n";

25 
	g$ssiQuy
 .= "Referer: $rfurl\r\n";

26 
	g$ssiQuy
 .= "Accept: */*\r\n";

27 
	g$ssiQuy
 .= "User-Agent: Mozilla/4.0 (compatible; MSIE 5.00; Windows 98)\r\n";

28 if(
	g$gcook
!=""&&!
eg
("[\r\n]",
$gcook
))

30 
	g$ssiQuy
 .
$gcook
."\r\n";

32 
	g$ssiQuy
 .= "Connection: Keep-Alive\r\n\r\n";

33 
	g$o
 = "";

34 
	g$rr
 = "";

35 
	g$m_
 = 
fsockݒ
(
$gho
, 80, 
$o
, 
$rr
,10);

36 
fwre
(
$m_
,
$ssiQuy
);

37 
	g$um
 = 0;

40 
	g$m_hphd
 = 
Aay
();

41 
	g$hpas
 = 
exode
(" ",
fgs
(
$m_
,256));

42 
	g$m_hphd
["hp-edi"] = 
im
(
$hpas
[0]);

43 
	g$m_hphd
["hp-e"] = 
im
(
$hpas
[1]);

44 !
of
(
$m_
))

46 
	g$le
 = 
im
(
fgs
(
$m_
,256));

47 if(
	g$le
 ="" || 
$um
>100)

51 
	g$hkey
 = "";

52 
	g$hvue
 = "";

53 
	g$v
 = 0;

54 
	g$i
=0;$i<

(
$le
);$i++)

56 if(
	g$v
==1)

58 
$hvue
 .
$le
[
$i
];

60 if(
	g$le
[
$i
]==":")

62 
$v
 = 1;

64 if(
	g$v
==0)

66 
$hkey
 .
$le
[
$i
];

69 
	g$hkey
 = 
im
(
$hkey
);

70 if(
	g$hkey
!="")

72 
$m_hphd
[
ow
(
$hkey
)] = 
im
(
$hvue
);

77 if(
eg
("^3",
$m_hphd
["http-state"]))

79 if(
ist
(
$m_hphd
["loti"]&& 
	g$JumpCou
<3)

81 
	g$JumpCou
++;

82 
DownImageKp
(
$gu
,
$rfu
,
$fame
,
$gcook
,
$JumpCou
);

86  
	gl
;

89 if(!
eg
("^2",
$m_hphd
["http-state"]))

91  
	gl
;

93 if(!
ist
(
$m_hphd
))

95  
	gl
;

97 
	g$cڋLgth
 = 
$m_hphd
['content-length'];

100 
	g$
 = 
fݒ
(
$fame
,"w"

 
d
("写入文件：{$filename} 失败！");

101 
	g$i
=0;

102 
	g$okda
 = "";

103 
	g$ime
 = 
time
();

104 !
of
(
$m_
))

106 
	g$okda
 .
fgc
(
$m_
);

107 
	g$i
++;

110 if(
time
()-
	g$ime
>
	g$maxtime
)

116 if(
	g$i
 >
$cڋLgth
)

121 if(
	g$okda
!="")

123 
fwre
(
$
,
$okda
);

125 
fo
(
$
);

126 if(
	g$okda
=="")

128 @
uƚk
(
$fame
);

129 
fo
(
$m_
);

130  
	gl
;

132 
fo
(
$m_
);

133  
	gue
;

137 
funi
 
	$RefuCook
(
$gu
)

139 
glob
 
$gcook
,
$ϡRfu
;

140 
$gu
 = 
	`im
($gurl);

141 if(!
	`emy
(
$gcook
&& 
$ϡRfu
==
$gu
)

143  
$gcook
;

147 
$ϡRfu
=
$gu
;

149 if(
	`im
(
$gu
)=='')

153 
$ufos
 = 
	`GHoInfo
(
$gu
);

154 
$gho
 = 
$ufos
['host'];

155 
$gquy
 = 
$ufos
['query'];

156 
$ssiQuy
 = "GET $gquery HTTP/1.1\r\n";

157 
$ssiQuy
 .= "Host: $ghost\r\n";

158 
$ssiQuy
 .= "Accept: */*\r\n";

159 
$ssiQuy
 .= "User-Agent: Mozilla/4.0 (compatible; MSIE 5.00; Windows 98)\r\n";

160 
$ssiQuy
 .= "Connection: Close\r\n\r\n";

161 
$o
 = "";

162 
$rr
 = "";

163 
$m_
 = 
	`fsockݒ
(
$gho
, 80, 
$o
, 
$rr
,10

 
	`d
($ghost.'<br />');

164 
	`fwre
(
$m_
,
$ssiQuy
);

165 
$um
 = 0;

168 
$gcook
 = "";

169 !
	`of
(
$m_
))

171 
$le
 = 
	`im
(
	`fgs
(
$m_
,256));

172 if(
$le
 ="" || 
$um
>100)

178 if(
	`egi
("^cook",
$le
))

180 
$gcook
 = 
$le
;

185 
	`fo
(
$m_
);

186  
$gcook
;

187 
	}
}

190 
funi
 
	$GHoInfo
(
$gu
)

192 
$gu
 = 
	`egi_a
("^hp://","",
	`im
($gurl));

193 
$gr
['ho'] = 
	`egi_a
("/(.*)$","",
$gu
);

194 
$gr
['quy'] = "/".
	`egi_a
("^([^/]*)/","",
$gu
);

195  
$gr
;

196 
	}
}

199 
funi
 
	$TuImageTag
(&
$body
)

201 
glob
 
$cfg_bum_width
,
$cfg_ddimg_width
;

202 if(
	`emy
(
$cfg_bum_width
))

204 
$cfg_bum_width
 = 800;

206 if(
	`emy
(
$cfg_ddimg_width
))

208 
$cfg_ddimg_width
 = 150;

210 
	`eg_mch_l
('/c=[\'"](.+?)[\'"]/is',
$body
,
$mch
);

211 
$x
 = '';

212 if(
	`is_y
(
$mch
[1]&& 
	`cou
($match[1])>0)

214 
$i
=0;
	`ist
(
$mch
[1][$i]);$i++)

216 
$x
 ."{dede:imgext='' }".
$mch
[1][
$i
]." {/dede:img}"."\r\n";

219 
$x
 = "\r\n{dede:pagestyle maxwidth='{$cfg_album_width}' ddmaxwidth='{$cfg_ddimg_width}'ow='3' col='3' value='2'/}\r\n{dede:comments}图集类型会采集时生成此配置是正常的，不过如果后面没有跟着img标记则表示规则无效{/dede:comments}\r\n".$ttx;

220  
$x
;

221 
	}
}

224 
funi
 
	$TuLkTag
(&
$body
)

226 
$x
 = '';

227 
$hdid
 = '服务器';

228 
	`eg_mch_l
("/<hf=['\"](.+?)['\"]([^>]+?)>(.+?)<\/a>/is",
$body
,
$mch
);

229 if(
	`is_y
(
$mch
[1]&& 
	`cou
($match[1])>0)

231 
$i
=0;
	`ist
(
$mch
[1][$i]);$i++)

233 
$rvme
 = (
	`ist
(
$mch
[3][
$i
]? 
	`r_a
("'","`",$mch[3][$i]: 
$hdid
.($i+1));

234 if(
	`eg
("[<>]",
$rvme
|| 
	`
($servername)>40)

236 
$rvme
 = 
$hdid
.(
$i
+1);

238 
$x
 .= "{dede:linkext='$servername'} {$match[1][$i]} {/dede:link}\r\n";

241  
$x
;

242 
	}
}

245 
funi
 
	$RpCda
(
$r
)

247 
$r
 = 
	`r_a
('<![CDATA[','',$str);

248 
$r
 = 
	`r_a
(']]>','',$str);

249  
$r
;

250 
	}
}

253 
funi
 
	$GRssLks
(
$rssu
)

255 
glob
 
$cfg_so_ng
;

256 
$dhd
 = 
w
 
	`DedeHpDown
();

257 
$dhd
->
	`OnU
(
$rssu
);

258 
$rsshtml
 = 
$dhd
->
	`GHtml
();

261 
	`eg_mch
("/codg=[\"']([^\"']*)[\"']/is",
$rsshtml
,
$fos
);

262 if(
	`ist
(
$fos
[1]))

264 
$pcode
 = 
	`ow
(
	`im
(
$fos
[1]));

268 
$pcode
 = 
	`ow
(
$cfg_so_ng
);

270 if(
$cfg_so_ng
=='gb2312')

272 if(
$pcode
=='utf-8')

274 
$rsshtml
 = 
	`utf82gb
($rsshtml);

276 if(
$pcode
=='big5')

278 
$rsshtml
 = 
	`big52gb
($rsshtml);

281 if(
$cfg_so_ng
=='utf-8')

283 if(
$pcode
=='gbk'||$pcode=='gb2312')

285 
$rsshtml
 = 
	`gb2utf8
($rsshtml);

287 if(
$pcode
=='big5')

289 
$rsshtml
 = 
	`gb2utf8
(
	`big52gb
($rsshtml));

292 
$r
 = 
	`y
();

293 
	`eg_mch_l
("/<em(.*)<t>(.*)<\/t>/isU",
$rsshtml
,
$ts
);

294 
	`eg_mch_l
("/<em(.*)<lk>(.*)<\/lk>/isU",
$rsshtml
,
$lks
);

295 
	`eg_mch_l
("/<em(.*)<desti>(.*)<\/desti>/isU",
$rsshtml
,
$destis
);

296 if(!
	`ist
(
$lks
[2]))

300 
	`fܗch
(
$lks
[2] 
as
 
$k
=>
$v
)

302 
$r
[
$k
]['lk'] = 
	`RpCda
(
$v
);

304 if(
	`ist
(
$ts
[2][
$k
]))

306 
$r
[
$k
]['t'] = 
	`RpCda
(
$ts
[2][$k]);

310 
$r
[
$k
]['t'] = 
	`eg_a
("^(.*)/","",
	`RpCda
(
$ts
[2][$k]));

312 if(
	`ist
(
$destis
[2][
$k
]))

314 
$r
[
$k
]['image'] = 
	`GddImgFromRss
(
$destis
[2][$k],
$rssu
);

318 
$r
[
$k
]['image'] = '';

321  
$r
;

322 
	}
}

325 
funi
 
	$GddImgFromRss
(
$destis
,
$fu
)

327 if(
$destis
=='')

331 
	`eg_mch_l
("/<img(.*)c=[\"']{0,1}(.*)[\"']{0,1}[> \r\n\t]{1,}/isU",
$destis
,
$imgs
);

332 if(
	`ist
(
$imgs
[2][0]))

334 
$imgs
[2][0] = 
	`eg_a
("[\"']",'',$imgs[2][0]);

335 
$imgs
[2][0] = 
	`eg_a
("/{1,}",'/',$imgs[2][0]);

336  
	`FlU
(
$fu
,
$imgs
[2][0]);

342 
	}
}

345 
funi
 
	$FlU
(
$fu
,
$su
)

347 
$i
 = 
$thSp
 = 0;

348 
$dr
 = 
$pr
 = 
$oku
 = '';

349 
$fu
 = 
	`im
($refurl);

350 
$su
 = 
	`im
($surl);

351 
$us
 = @
	`r_u
(
$fu
);

352 
$baho
 = ( (!
	`ist
(
$us
['port']) || $urls['port']=='80') ? $urls['host'] : $urls['host'].':'.$urls['port']);

356 
$bath
 = 
$baho
;

357 
$ths
 = 
	`exode
('/',
	`egi_a
("^hp://","",
$fu
));

358 
$n
 = 
	`cou
(
$ths
);

359 
$i
=1;$< (
$n
-1);$i++)

361 if(!
	`eg
("[\?]",
$ths
[
$i
])
$bath
 .= '/'.$paths[$i];

363 if(!
	`eg
("[\?\.]",
$ths
[
$n
-1]))

365 
$bath
 .'/'.
$ths
[
$n
-1];

367 if(
$su
=='')

369  
$bath
;

371 
$pos
 = 
	`os
(
$su
,"#");

372 if(
$pos
>0)

374 
$su
 = 
	`subr
($su,0,
$pos
);

378 if(
$su
[0]=='/')

380 
$oku
 = 
$baho
.
$su
;

382 if(
$su
[0]=='.')

384 if(
	`
(
$su
)<=2)

388 if(
$su
[1]=='/')

390 
$oku
 = 
$bath
.
	`eg_a
('^.','',
$su
);

394 
$oku
 = 
$bath
.'/'.
$su
;

399 if
	`
(
$su
) < 7 )

401 
$oku
 = 
$bath
.'/'.
$su
;

403 if
	`egi
('^hp://',
$su
) )

405 
$oku
 = 
$su
;

409 
$oku
 = 
$bath
.'/'.
$su
;

412 
$oku
 = 
	`egi_a
('^http://','',$okurl);

413 
$oku
 = 'hp://'.
	`egi_a
('/{1,}','/',$okurl);

414  
$oku
;

415 
	}
}

418 
funi
 
GUFromLiRu
(
$gxu
='',
$hdu
='',
$tid
=0,
$did
=0,
$addv
=1,
$ume
=0,
$bchru
='')

420 
glob
 
$dsql
,
$ii
;

422 
	g$lis
 = 
y
();

423 
	g$n
 = 0;

424 
	g$ii
 = (
emy
(
$ii
) ? 0 : $islisten);

425 if(
	g$hdu
!='')

427 
$hdus
 = 
exode
("\n",
$hdu
);

428 
fܗch
(
$hdus
 
as
 
$hdu
)

430 
	g$hdu
 = 
im
(
$hdu
);

431 if(
egi
("^hp://",
$hdu
))

433 
	g$lis
[
$n
][0] = 
$hdu
;

434 
	g$lis
[
$n
][1] = 0;

435 
	g$n
++;

436 if(
	g$ii
==1)

443 if(
	g$gxu
!='')

446 if(!
eg
("\(\*\)",
$gxu
) && !ereg("\(#\)",$regxurl))

448 
$lis
[
$n
][0] = 
$gxu
;

449 
	g$lis
[
$n
][1] = 0;

450 
	g$n
++;

454 if(
	g$addv
 <= 0)

456 
$addv
 = 1;

460 if(
	g$ume
==0)

462 
$tid
 <
$did
)

464 
$lis
[
$n
][0] = 
r_a
("(*)",
rtf
('%0'.

(
$tid
).'d',$tid),
$gxu
);

465 
	g$lis
[
$n
][1] = 0;

466 
	g$tid
 = 
rtf
('%0'.

(
$tid
).'d',$tid + 
$addv
);

467 
	g$n
++;

468 if(
	g$n
>2000 || 
	g$ii
==1)

479 
	g$us
 = 
exode
(']',
im
(
$bchru
));

480 
fܗch
(
$us
 
as
 
$u
)

482 
	g$u
 = 
im
(
$u
);

483 
	g$u
 = 
eg_a
("^\[|\]$",'',
$u
);

484 
	g$us
 = 
exode
(';',
$u
);

485 if(
cou
(
$us
)<3)

489 
	g$bag
 = '';

490 
	g$tid
 = 0;

491 
	g$did
 = 0;

492 
	g$tyid
 = 0;

493 
	g$addus
 = 
y
();

494 
fܗch
(
$us
 
as
 
$u
)

496 
	g$u
 = 
im
(
$u
);

497 
li
(
$k
,
$v

exode
('=>',
$u
);

498 if(
im
(
$k
)=='(#)')

500 
$bag
 = 
im
(
$v
);

502 if(
im
(
$k
)=='typeid')

504 
$tyid
 = 
im
(
$v
);

506 if(
im
(
$k
)=='addurl')

508 
$addu
 = 
im
(
$v
);

509 
	g$addus
 = 
exode
('|',
$addu
);

511 if(
im
(
$k
)=='(*)')

513 
$v
 = 
eg_a
("[ \r\n\t]",'',
im
($v));

514 
li
(
$tid
,
$did

exode
('-',
$v
);

519 if(
eg
('[^0-9]',
$tyid
))

521 
	g$r
 = 
$dsql
->
GO
("Select id From `#@__arctype` whereypenameike '$typeid' ");

522 if(
is_y
(
$r
))

524 
	g$tyid
 = 
$r
['id'];

528 
	g$tyid
 = 0;

533 
	g$mjj
 = 0;

534 if(
ist
(
$addus
[0]))

536 
fܗch
(
$addus
 
as
 
$addu
)

538 
	g$addu
 = 
im
(
$addu
);

539 if(
	g$addu
=='')

543 
	g$lis
[
$n
][0] = 
$addu
;

544 
	g$lis
[
$n
][1] = 
$tyid
;

545 
	g$n
++;

546 
	g$mjj
++;

547 if(
	g$ii
==1)

555 if(
	g$ii
!=1 || 
$mjj
==0 )

558 
$tid
 <
$did
)

560 
$lis
[
$n
][0] = 
r_a
("(#)",
$bag
,
$gxu
);

561 
	g$lis
[
$n
][0] = 
r_a
("(*)",
rtf
('%0'.

(
$tid
).'d',$tid),
$lis
[$n][0]);

562 
	g$lis
[
$n
][1] = 
$tyid
;

563 
	g$tid
 = 
rtf
('%0'.

(
$tid
).'d',$tid + 
$addv
);

564 
	g$n
++;

565 if(
	g$ii
==1)

569 if(
	g$n
>20000)

582  
	g$lis
;

	@include/dedehtml2.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('dedecms');

12 as
	cDedeHtml2


14 
v
 
	m$CA
;

15 
v
 
	m$SourHtml
;

16 
v
 
	m$T
;

17 
v
 
	m$Meds
;

18 
v
 
	m$MedInfos
;

19 
v
 
	m$Lks
;

20 
v
 
	m$ChS
;

21 
v
 
	m$BaU
;

22 
v
 
	m$BaUPh
;

23 
v
 
	m$HomeU
;

24 
v
 
	m$IsHd
;

25 
v
 
	m$ImgHeight
;

26 
v
 
	m$ImgWidth
;

27 
v
 
	m$GLkTy
;

30 
funi
 
	$__cڡru
()

32 
$this
->
CA
 = '';

33 
$this
->
SourHtml
 = '';

34 
$this
->
T
 = '';

35 
$this
->
Meds
 = 
	`Aay
();

36 
$this
->
MedInfos
 = 
	`Aay
();

37 
$this
->
Lks
 = 
	`Aay
();

38 
$this
->
BaU
 = '';

39 
$this
->
BaUPh
 = '';

40 
$this
->
HomeU
 = '';

41 
$this
->
IsHd
 = 
l
;

42 
$this
->
ImgHeight
 = 30;

43 
$this
->
ImgWidth
 = 50;

44 
$this
->
GLkTy
 = 'link';

47 
funi
 
	$DedeHtml2
()

49 
$this
->
	`__cڡru
();

50 
	}
}

53 
funi
 
SSour
(&
$html
,
$u
 = '',
$lkty
='')

55 
$this
->
__cڡru
();

56 
	g$this
->
	gCA
 = 
w
 
DedeAribu2
();

57 
	g$u
 = 
im
(
$u
);

58 
	g$this
->
	gSourHtml
 = 
$html
;

59 
	g$this
->
	gBaU
 = 
$u
;

61 
	g$us
 = @
r_u
(
$u
);

62 
	g$this
->
	gHomeU
 = 
$us
['host'];

63 
	g$this
->
	gBaUPh
 = 
$this
->
HomeU
.
$us
['path'];

64 
	g$this
->
	gBaUPh
 = 
eg_a
("/\/([^\/]*)\.(.*)$/","/",
$this
->
BaUPh
);

65 
	g$this
->
	gBaUPh
 = 
eg_a
("/\/$/",'',
$this
->
BaUPh
);

66 if(
	g$lkty
!='')

68 
$this
->
GLkTy
 = 
$lkty
;

70 if(
	g$html
 != '')

72 
$this
->
Alyr
();

77 
funi
 
	$Alyr
()

79 
$cA
 = 
w
 
	`DedeAribu2
();

80 
$cA
->
IsTagName
 = 
l
;

81 
$c
 = '';

82 
$i
 = 0;

83 
$tPos
 = 0;

84 
$dPos
 = 0;

85 
$wt
 = 0;

86 
$ht
 = 0;

87 
$stdd
 = 0;

88 
$tS
 = '';

89 
$tmpVue
 = '';

90 
$tmpVue2
 = '';

91 
$gName
 = '';

92 
$hashd
 = 0;

93 
$
 = 
	`
(
$this
->
SourHtml
);

94 if(
$this
->
GLkTy
=='link' || $this->GetLinkType=='')

96 
$edTags
 = 
	`y
('a');

98 if(
$this
->
GLkTy
=='media')

100 
$edTags
 = 
	`y
('img','embed','a');

101 
$this
->
IsHd
 = 
ue
;

103 
$gbaks
 = 
	`y
(' ','<','>',"\r","\n","\t");

104 ;
	`ist
(
$this
->
SourHtml
[
$i
]);$i++)

106 if(
$this
->
SourHtml
[
$i
]=='<')

108 
$gName
 = '';

109 
$j
 = 0;

110 
$i
=$i+1; 
	`ist
(
$this
->
SourHtml
[$i]); $i++)

112 if(
$j
>10)

116 
$j
++;

117 if
	`_y
(
$this
->
SourHtml
[
$i
],
$gbaks
) )

123 
$gName
 .
$this
->
SourHtml
[
$i
];

126 
$gName
 = 
	`ow
($tagName);

129 if(
$gName
=='!--')

131 
$dPos
 = 
	`os
(
$this
->
SourHtml
,'-->',
$i
);

132 if(
$dPos
 !=
l
)

134 
$i
=
$dPos
+3;

140 if
	`_y
(
$gName
,
$edTags
) )

142 
$tPos
 = 
$i
;

143 
$dPos
 = 
	`os
(
$this
->
SourHtml
,'>',
$i
+1);

144 if(
$dPos
===
l
)

148 
$tS
 = 
	`subr
(
$this
->
SourHtml
,
$i
+1,
$dPos
-
$tPos
-1);

149 
$cA
->
	`SSour
(
$tS
);

150 if(
$gName
=='img')

152 
$this
->
	`InMed
(
$cA
->
	`GA
('src'),'img');

154 if(
$gName
=='embed')

156 
$ru
 = 
$this
->
	`InMed
(
$cA
->
	`GA
('src'),'embed');

157 if(
$ru
 != '')

159 
$this
->
MedInfos
[
$ru
][0] = 
$cA
->
	`GA
('width');

160 
$this
->
MedInfos
[
$ru
][1] = 
$cA
->
	`GA
('height');

163 if(
$gName
=='a')

165 
$this
->
	`InLk
($this->
	`FlU
(
$cA
->
	`GA
('hf')),$this->
	`GIText
(
$i
,'a'));

176 if(
$this
->
T
 == '')

178 
$this
->
T
 = $this->
BaU
;

180 
	}
}

183 
funi
 
	$Cˬ
()

185 
$this
->
CA
 = '';

186 
$this
->
SourHtml
 = '';

187 
$this
->
T
 = '';

188 
$this
->
Lks
 = '';

189 
$this
->
Meds
 = '';

190 
$this
->
BaU
 = '';

191 
$this
->
BaUPh
 = '';

192 
	}
}

195 
funi
 
	$InMed
(
$u
,
$mty
)

197 if
	`eg
("^(javast:|#|'|\")",
$u
) )

201 if(
$u
 == '')

205 
$this
->
Meds
[
$u
]=
$mty
;

206  
$u
;

207 
	}
}

209 
funi
 
	$InLk
(
$u
,
$
)

211 if
	`eg
("^(javast:|#|'|\")",
$u
) )

215 if(
$u
 == '')

219 if(
	`eg
('^img:',
$
))

221 
	`li
(
$aimg
,
$

	`exode
(':txt:',$atitle);

222 if(!
	`ist
(
$this
->
Lks
[
$u
]))

224 if(
$
 != '')

226 
$this
->
Lks
[
$u
]['t'] = 
	`_subr
(
$
,50);

230 
$this
->
Lks
[
$u
]['t'] = 
	`eg_a
('img:','',
$aimg
);

232 
$this
->
Lks
[
$u
]['link'] = $url;

234 
$this
->
Lks
[
$u
]['image'] = 
	`eg_a
('img:','',
$aimg
);

235 
$this
->
	`InMed
($this->
Lks
[
$u
]['image'],'img');

239 if(!
	`ist
(
$this
->
Lks
[
$u
]))

241 
$this
->
Lks
[
$u
]['image'] = '';

242 
$this
->
Lks
[
$u
]['t'] = 
$
;

243 
$this
->
Lks
[
$u
]['link'] = $url;

247 if(
	`
(
$this
->
Lks
[
$u
]['t']< sn(
$
)) $this->Links[$url]['title'] = $atitle;

250  
$u
;

251 
	}
}

254 
funi
 
	$PChS
(
$t
)

256 
$tdd
=0;

257 
$gn
=0;

258 
$tdd
 = 
	`os
(
$t
,'=');

259 if(
$tdd
===
l
)

265 
$gn
 = 
	`
(
$t
)-
$tdd
-1;

266 if(
$gn
<=0)

270  
	`im
(
	`subr
(
$t
,
$tdd
+1,
$gn
));

272 
	}
}

275 
funi
 
	$FlU
(
$su
)

277 
$i
 = 
$thSp
 = 0;

278 
$dr
 = 
$pr
 = 
$oku
 = '';

280 
$su
 = 
	`im
($surl);

281 if(
$su
 == '')

285 
$pos
 = 
	`os
(
$su
,'#');

286 if(
$pos
>0)

288 
$su
 = 
	`subr
($su,0,
$pos
);

290 if(
$su
[0]=='/')

292 
$oku
 = 
$this
->
HomeU
.'/'.
$su
;

294 if(
$su
[0]=='.')

296 if(!
	`ist
(
$su
[2]))

300 if(
$su
[0]=='/')

302 
$oku
 = 
$this
->
BaUPh
."/".
	`subr
(
$su
,2,
	`
($surl)-2);

306 
$us
 = 
	`exode
('/',
$su
);

307 
	`fܗch
(
$us
 
as
 
$u
)

309 if(
$u
=='..')

311 
$thSp
++;

313 if(
$i
<
	`cou
(
$us
)-1)

315 
$dr
 .
$us
[
$i
].'/';

319 
$dr
 .
$us
[
$i
];

321 
$i
++;

323 
$us
 = 
	`exode
('/',
$this
->
BaUPh
);

324 if(
	`cou
(
$us
<
$thSp
)

330 
$pr
 = '';

331 
$i
=0;$i<
	`cou
(
$us
)-
$thSp
;$i++){ 
$pr
 .= $urls[$i].'/'; }

332 
$oku
 = 
$pr
.
$dr
;

338 if
	`
(
$su
) < 7 )

340 
$oku
 = 
$this
->
BaUPh
.'/'.
$su
;

342 if
	`ow
(
	`subr
(
$su
,0,7))=='http://' )

344 
$oku
 = 
	`egi_a
('^hp://','',
$su
);

348 
$oku
 = 
$this
->
BaUPh
.'/'.
$su
;

351 
$oku
 = 
	`egi_a
('/{1,}','/',$okurl);

352  'hp://'.
$oku
;

353 
	}
}

356 
funi
 
	$GIText
(&
$pos
,
$gme
)

358 
$tPos
=0;

359 
$dPos
=0;

360 
$xtL
=0;

361 
$r
 = '';

362 
$tPos
 = 
	`os
(
$this
->
SourHtml
,'>',
$pos
);

364 if(
$gme
=='title')

366 
$dPos
 = 
	`os
(
$this
->
SourHtml
,'<',
$tPos
);

370 
$dPos1
 = 
	`os
(
$this
->
SourHtml
,'</a',
$tPos
);

371 
$dPos2
 = 
	`os
(
$this
->
SourHtml
,'</A',
$tPos
);

372 if(
$dPos1
===
l
)

374 
$dPos
 = 
$dPos2
;

376 if(
$dPos2
===
l
)

378 
$dPos
 = 
$dPos1
;

382 
$dPos
 = (
$dPos1
 < 
$dPos2
 ? $endPos1 : $endPos2 );

385 if(
$dPos
 > 
$tPos
)

387 
$xtL
 = 
$dPos
-
$tPos
;

388 
$r
 = 
	`subr
(
$this
->
SourHtml
,
$tPos
+1,
$xtL
-1);

390 
$pos
 = 
$tPos
 + 
$xtL
 + 
	`
("</".
$gme
) + 1;

391 if(
$gme
=='title')

393  
	`im
(
$r
);

397 
	`eg_mch_l
("/<img(.*)c=[\"']{0,1}(.*)[\"']{0,1}[> \r\n\t]{1,}/isU",
$r
,
$imgs
);

398 if(
	`ist
(
$imgs
[2][0]))

400 
$txt
 = 
	`im
(
	`Html2Text
(
$r
));

401 
$imgs
[2][0] = 
	`eg_a
("[\"']",'',$imgs[2][0]);

402  "img:".
$this
->
	`FlU
(
$imgs
[2][0]).':txt:'.
$txt
;

406 
$r
 = 
	`egi_a
('</(.*)$','',$str);

407 
$r
 = 
	`im
(
	`egi_a
('^(.*)>','',$str));

408  
$r
;

411 
	}
}

418 as
	cDedeAribu2


420 
v
 
	m$SourSg
 = '';

421 
v
 
	m$SourMaxSize
 = 1024;

422 
v
 
	m$ChToLow
 = 
FALSE
;

423 
v
 
	m$IsTagName
 = 
TRUE
;

424 
v
 
	m$Cou
 = -1;

425 
v
 
	m$Ims
 = '';

428 
funi
 
SSour
(
$r
 = '')

430 
$this
->
Cou
 = -1;

431 
	m$this
->
	mIms
 = '';

432 
	m$rL
 = 0;

433 
	m$this
->
	mSourSg
 = 
im
(
eg_a
("/[ \t\r\n]{1,}/"," ",
$r
));

434 
	m$rL
 = 

(
$this
->
SourSg
);

435 
	m$this
->
	mSourSg
 .= " ";

436 if(
	m$rL
>0&&$rL<=
$this
->
SourMaxSize
)

438 
$this
->
PriveAP
();

443 
funi
 
	$GA
(
$r
)

445 if(
$r
 == '')

449 
$r
 = 
	`ow
($str);

450 if(
	`ist
(
$this
->
Ims
[
$r
]))

452  
$this
->
Ims
[
$r
];

458 
	}
}

461 
funi
 
	$IsA
(
$r
)

463 if(
$r
 == '')

465  
l
;

467 
$r
 = 
	`ow
($str);

468 if(
	`ist
(
$this
->
Ims
[
$r
]))

470  
ue
;

474  
l
;

476 
	}
}

479 
funi
 
	$GTagName
()

481  
$this
->
	`GA
("tagname");

482 
	}
}

485 
funi
 
	$GCou
()

487  
$this
->
Cou
+1;

488 
	}
}

491 
funi
 
	$PriveAP
()

493 
$d
 = '';

494 
$tm
 = '';

495 
$tmpvue
 = '';

496 
$tdd
 = -1;

497 
$ddg
 = '';

498 
$rL
 = 
	`
(
$this
->
SourSg
);

499 
$j
 = 0;

502 if(
$this
->
IsTagName
)

505 if(
	`ist
(
$this
->
SourSg
[2]))

507 if(
$this
->
SourSg
[0].$this->SourceString[1].$this->SourceString[2]=='!--')

509 
$this
->
Ims
['tagname'] = '!--';

513 
$i
=0;$i<
$rL
;$i++)

515 
$d
 = 
$this
->
SourSg
[
$i
];

516 
$j
++;

517 if(
	`eg
("[ '\"\r\n\t]",
$d
))

519 
$this
->
Cou
++;

520 
$this
->
Ims
["gme"]=
	`ow
(
	`im
(
$tmpvue
));

521 
$tmpvue
 = ''; ;

525 
$tmpvue
 .
$d
;

528 if(
$j
>0)

530 
$j
 = $j-1;

535 
$i
=
$j
;$i<
$rL
;$i++)

537 
$d
 = 
$this
->
SourSg
[
$i
];

539 if(
$tdd
==-1)

541 if(
$d
!='=')

543 
$tm
 .
$d
;

547 
$tm
 = 
	`ow
(
	`im
($tmpatt));

548 
$tdd
=0;

553 if(
$tdd
==0)

555 
$d
)

561 
$ddg
='\'';

562 
$tdd
=1;

565 
$ddg
='"';

566 
$tdd
=1;

569 
$tmpvue
.=
$d
;

570 
$ddg
=' ';

571 
$tdd
=1;

577 if(
$tdd
==1)

579 if(
$d
==
$ddg
)

581 
$this
->
Cou
++;

582 if(
$this
->
ChToLow
)

584 
$this
->
Ims
[
$tm
] = 
	`ow
(
	`im
(
$tmpvue
));

588 
$this
->
Ims
[
$tm
] = 
	`im
(
$tmpvue
);

590 
$tm
 = '';

591 
$tmpvue
 = '';

592 
$tdd
=-1;

596 
$tmpvue
.=
$d
;

602 if(
$tm
 != '')

604 
$this
->
Ims
[
$tm
] = '';

606 
	}
}

	@include/dedehttpdown.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('dedecms');

7 @
t_time_lim
(0);

9 as
	cDedeHpDown


11 
v
 
	m$m_u
 = '';

12 
v
 
	m$m_uth
 = '';

13 
v
 
	m$m_scheme
 = 'http';

14 
v
 
	m$m_ho
 = '';

15 
v
 
	m$m_pt
 = '80';

16 
v
 
	m$m_ur
 = '';

17 
v
 
	m$m_ss
 = '';

18 
v
 
	m$m_th
 = '/';

19 
v
 
	m$m_quy
 = '';

20 
v
 
	m$m_
 = '';

21 
v
 
	m$m_r
 = '';

22 
v
 
	m$m_hphd
 = '';

23 
v
 
	m$m_html
 = '';

24 
v
 
	m$m_puthd
 = '';

25 
v
 
	m$BaUPh
 = '';

26 
v
 
	m$HomeU
 = '';

27 
v
 
	m$Try
 = 0;

28 
v
 
	m$JumpCou
 = 0;

31 
funi
 
	$PriveIn
(
$u
)

33 if(
$u
=='') {

36 
$us
 = '';

37 
$us
 = @
	`r_u
(
$u
);

38 
$this
->
m_u
 = 
$u
;

39 if(
	`is_y
(
$us
))

41 
$this
->
m_ho
 = 
$us
["host"];

42 if(!
	`emy
(
$us
["scheme"]))

44 
$this
->
m_scheme
 = 
$us
["scheme"];

46 if(!
	`emy
(
$us
["user"]))

48 
$this
->
m_ur
 = 
$us
["user"];

50 if(!
	`emy
(
$us
["pass"]))

52 
$this
->
m_ss
 = 
$us
["pass"];

54 if(!
	`emy
(
$us
["port"]))

56 
$this
->
m_pt
 = 
$us
["port"];

58 if(!
	`emy
(
$us
["path"]))

60 
$this
->
m_th
 = 
$us
["path"];

62 
$this
->
m_uth
 = $this->
m_th
;

63 if(!
	`emy
(
$us
["query"]))

65 
$this
->
m_quy
 = 
$us
["query"];

66 
$this
->
m_uth
 ."?".$this->
m_quy
;

68 
$this
->
HomeU
 = 
$us
["host"];

69 
$this
->
BaUPh
 = $this->
HomeU
.
$us
["path"];

70 
$this
->
BaUPh
 = 
	`eg_a
("/\/([^\/]*)\.(.*)$/","/",$this->BaseUrlPath);

71 
$this
->
BaUPh
 = 
	`eg_a
("/\/$/","",$this->BaseUrlPath);

75 
funi
 
	$RetAny
()

78 
$this
->
m_u
 = "";

79 
$this
->
m_uth
 = "";

80 
$this
->
m_scheme
 = "http";

81 
$this
->
m_ho
 = "";

82 
$this
->
m_pt
 = "80";

83 
$this
->
m_ur
 = "";

84 
$this
->
m_ss
 = "";

85 
$this
->
m_th
 = "/";

86 
$this
->
m_quy
 = "";

87 
$this
->
m_r
 = "";

88 
	}
}

91 
funi
 
OnU
(
$u
,
$queTy
="GET")

93 
$this
->
RetAny
();

94 
	g$this
->
	gJumpCou
 = 0;

95 
	g$this
->
	gm_hphd
 = 
Aay
() ;

96 
	g$this
->
	gm_html
 = '';

97 
	g$this
->
	gTry
 = 0;

98 
	g$this
->
Clo
();

101 
	g$this
->
PriveIn
(
$u
);

102 
	g$this
->
PriveSSessi
(
$queTy
);

106 
funi
 
	$JumpOnU
(
$u
)

108 
$this
->
	`RetAny
();

109 
$this
->
JumpCou
++;

110 
$this
->
m_hphd
 = 
	`Aay
() ;

111 
$this
->
m_html
 = "";

112 
$this
->
	`Clo
();

115 
$this
->
	`PriveIn
(
$u
);

116 
$this
->
	`PriveSSessi
('GET');

117 
	}
}

120 
funi
 
	$tE
()

122 
echo
 "错误信息：".
$this
->
m_r
;

123 
echo
 "<br/>具体返回头：<br/>";

124 
	`fܗch
(
$this
->
m_hphd
 
as
 
$k
=>
$v
){ 
echo
 "$k => $v <br/>\r\n"; }

125 
	}
}

128 
funi
 
	$IsGOK
()

130 if
	`eg
("^2",
$this
->
	`GHd
("http-state")) )

132  
ue
;

136 
$this
->
m_r
 .$this->
	`GHd
("http-state")." - ".$this->GetHead("http-describe")."<br/>";

137  
l
;

139 
	}
}

142 
funi
 
	$IsText
()

144 if
	`eg
("^2",
$this
->
	`GHd
("hp-e")&& 
	`egi
("text|xml",$this->GetHead("content-type")) )

146  
ue
;

150 
$this
->
m_r
 .= "内容为非文本类型或网址重定向<br/>";

151  
l
;

153 
	}
}

156 
funi
 
	$IsCڋTy
(
$y
)

158 if(
	`eg
("^2",
$this
->
	`GHd
("http-state"))

159 && 
$this
->
	`GHd
("cڋ-ty")==
	`ow
(
$y
))

160 {  
ue
; }

163 
$this
->
m_r
 ."类型不对 ".$this->
	`GHd
("content-type")."<br/>";

164  
l
;

166 
	}
}

169 
funi
 
	$SaveToB
(
$vefame
)

171 if(!
$this
->
	`IsGOK
())

173  
l
;

175 if(@
	`of
(
$this
->
m_
))

177 
$this
->
m_r
 = "连接已经关闭！";  
l
;

179 
$
 = 
	`fݒ
(
$vefame
,"w");

180 !
	`of
(
$this
->
m_
))

182 
	`fwre
(
$
,
	`d
(
$this
->
m_
,1024));

184 
	`fo
(
$this
->
m_
);

185 
	`fo
(
$
);

186  
ue
;

187 
	}
}

190 
funi
 
	$SaveToText
(
$vefame
)

192 if(
$this
->
	`IsText
())

194 
$this
->
	`SaveBFe
(
$vefame
);

200 
	}
}

203 
funi
 
	$GHtml
()

205 if(!
$this
->
	`IsText
())

209 if(
$this
->
m_html
!='')

211  
$this
->
m_html
;

213 if(!
$this
->
m_
||@
	`of
($this->m_fp))

217 !
	`of
(
$this
->
m_
))

219 
$this
->
m_html
 .
	`fgs
($this->
m_
,256);

221 @
	`fo
(
$this
->
m_
);

222  
$this
->
m_html
;

223 
	}
}

226 
funi
 
PriveSSessi
(
$queTy
="GET")

228 if(!
$this
->
PriveOnHo
())

230 
$this
->
m_r
 .= "打开远程主机出错!";

231  
	gl
;

233 
	g$this
->
	gTry
++;

234 if(
	g$this
->
GHd
("http-edition")=="HTTP/1.1")

236 
$hpv
 = "HTTP/1.1";

240 
	g$hpv
 = "HTTP/1.0";

242 
	g$ps
 = 
exode
('?',
$this
->
m_uth
);

244 
	g$hdSg
 = '';

247 if(
	g$queTy
=="GET")

249 
$hdSg
 ."GET ".
$this
->
m_uth
." $httpv\r\n";

253 
	g$hdSg
 ."POST ".
$ps
[0]." $httpv\r\n";

255 
	g$this
->
	gm_puthd
["Ho"] = 
$this
->
m_ho
;

258 if(!
ist
(
$this
->
m_puthd
["Accept"]))

260 
	g$this
->
	gm_puthd
["Accept"] = "*/*";

262 if(!
ist
(
$this
->
m_puthd
["User-Agent"]))

264 
	g$this
->
	gm_puthd
["User-Agent"] = "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.2)";

266 if(!
ist
(
$this
->
m_puthd
["Refer"]))

268 
	g$this
->
	gm_puthd
["Rer"] = "hp://".
$this
->
m_puthd
["Host"];

271 
fܗch
(
$this
->
m_puthd
 
as
 
$k
=>
$v
)

273 
$k
 = 
im
($k);

274 
	g$v
 = 
im
(
$v
);

275 if(
	g$k
!=""&&
$v
!="")

277 
$hdSg
 .= "$k: $v\r\n";

280 
uts
(
$this
->
m_
, 
$hdSg
);

281 if(
	g$queTy
=="POST")

283 
$poda
 = "";

284 if(
cou
(
$ps
)>1)

286 
	g$i
=1;$i<
cou
(
$ps
);$i++)

288 
	g$poda
 .
$ps
[
$i
];

293 
	g$poda
 = "OK";

295 
	g$
 = 

(
$poda
);

296 
uts
(
$this
->
m_
,"Content-Type:pplication/x-www-form-urlencoded\r\n");

297 
uts
(
$this
->
m_
,"Content-Length: $plen\r\n");

302 if(
	g$hpv
=="HTTP/1.1")

304 
uts
(
$this
->
m_
,"Connection: Close\r\n\r\n");

308 
uts
(
$this
->
m_
,"\r\n");

310 if(
	g$queTy
=="POST")

312 
uts
(
$this
->
m_
,
$poda
);

316 
	g$hpas
 = 
exode
(" ",
fgs
(
$this
->
m_
,256));

317 
	g$this
->
	gm_hphd
["hp-edi"] = 
im
(
$hpas
[0]);

318 
	g$this
->
	gm_hphd
["hp-e"] = 
im
(
$hpas
[1]);

319 
	g$this
->
	gm_hphd
["http-describe"] = "";

320 
	g$i
=2;$i<
cou
(
$hpas
);$i++)

322 
	g$this
->
	gm_hphd
["hp-desibe"] ." ".
im
(
$hpas
[
$i
]);

326 !
of
(
$this
->
m_
))

328 
	g$le
 = 
im
(
fgs
(
$this
->
m_
,256));

329 if(
	g$le
 == "")

333 
	g$hkey
 = "";

334 
	g$hvue
 = "";

335 
	g$v
 = 0;

336 
	g$i
=0;$i<

(
$le
);$i++)

338 if(
	g$v
==1)

340 
$hvue
 .
$le
[
$i
];

342 if(
	g$le
[
$i
]==":")

344 
$v
 = 1;

346 if(
	g$v
==0)

348 
$hkey
 .
$le
[
$i
];

351 
	g$hkey
 = 
im
(
$hkey
);

352 if(
	g$hkey
!="")

354 
$this
->
m_hphd
[
ow
(
$hkey
)] = 
im
(
$hvue
);

359 if(
of
(
$this
->
m_
))

361 if(
	g$this
->
	gTry
 > 10)

363  
	gl
;

365 
	g$this
->
PriveSSessi
(
$queTy
);

369 if(
eg
("^3",
$this
->
m_hphd
["http-state"]))

371 if(
	g$this
->
	gJumpCou
 > 3)

375 if(
ist
(
$this
->
m_hphd
["location"]))

377 
	g$wu
 = 
$this
->
m_hphd
["location"];

378 if(
egi
("^hp",
$wu
))

380 
	g$this
->
JumpOnU
(
$wu
);

384 
	g$wu
 = 
$this
->
FlU
(
$wu
);

385 
	g$this
->
JumpOnU
(
$wu
);

390 
	g$this
->
	gm_r
 = "无法识别的答复！";

396 
funi
 
	$GHd
(
$hdme
)

398 
$hdme
 = 
	`ow
($headname);

399  
	`ist
(
$this
->
m_hphd
[
$hdme
]) ? $this->m_httphead[$headname] : '';

400 
	}
}

403 
funi
 
	$SHd
(
$skey
,
$svue
)

405 
$this
->
m_puthd
[
$skey
] = 
$svue
;

406 
	}
}

409 
funi
 
	$PriveOnHo
()

411 if(
$this
->
m_ho
=="")

413  
l
;

415 
$o
 = "";

416 
$rr
 = "";

417 
$this
->
m_
 = @
	`fsockݒ
($this->
m_ho
, $this->
m_pt
, 
$o
, 
$rr
,10);

418 if(!
$this
->
m_
)

420 
$this
->
m_r
 = 
$rr
;

421  
l
;

425  
ue
;

427 
	}
}

430 
funi
 
	$Clo
()

432 @
	`fo
(
$this
->
m_
);

433 
	}
}

436 
funi
 
	$FlU
(
$su
)

438 
$i
 = 0;

439 
$dr
 = "";

440 
$pr
 = "";

441 
$oku
 = "";

442 
$thSp
 = 0;

443 
$su
 = 
	`im
($surl);

444 if(
$su
=="")

448 
$pos
 = 
	`os
(
$su
,"#");

449 if(
$pos
>0)

451 
$su
 = 
	`subr
($su,0,
$pos
);

453 if(
$su
[0]=="/")

455 
$oku
 = "hp://".
$this
->
HomeU
.
$su
;

457 if(
$su
[0]==".")

459 if(
	`
(
$su
)<=1)

463 if(
$su
[1]=="/")

465 
$oku
 = "hp://".
$this
->
BaUPh
."/".
	`subr
(
$su
,2,
	`
($surl)-2);

469 
$us
 = 
	`exode
("/",
$su
);

470 
	`fܗch
(
$us
 
as
 
$u
)

472 if(
$u
=="..")

474 
$thSp
++;

476 if(
$i
<
	`cou
(
$us
)-1)

478 
$dr
 .
$us
[
$i
]."/";

482 
$dr
 .
$us
[
$i
];

484 
$i
++;

486 
$us
 = 
	`exode
("/",
$this
->
BaUPh
);

487 if(
	`cou
(
$us
<
$thSp
)

493 
$pr
 = "http://";

494 
$i
=0;$i<
	`cou
(
$us
)-
$thSp
;$i++)

496 
$pr
 .
$us
[
$i
]."/";

498 
$oku
 = 
$pr
.
$dr
;

504 if(
	`
(
$su
)<7)

506 
$oku
 = "hp://".
$this
->
BaUPh
."/".
$su
;

508 if(
	`ow
(
	`subr
(
$su
,0,7))=="http://")

510 
$oku
 = 
$su
;

514 
$oku
 = "hp://".
$this
->
BaUPh
."/".
$su
;

517 
$oku
 = 
	`egi_a
("^(http://)","",$okurl);

518 
$oku
 = 
	`egi_a
("/{1,}","/",$okurl);

519  "hp://".
$oku
;

520 
	}
}

	@include/dedemodule.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
.'/charset.func.php');

7 
que_
(
DEDEINC
.'/dedeatt.class.php');

9 as
	cDedeModu


11 
v
 
	m$modusPh
;

12 
v
 
	m$modus
;

13 
v
 
	m$feLiNames
;

14 
v
 
	m$sysLg
;

15 
v
 
	m$moduLg
;

16 
funi
 
__cڡru
(
$modu˥h
='')

18 
glob
 
$cfg_so_ng
;

19 
	m$this
->
	msysLg
 = 
$this
->
moduLg
 = 
$cfg_so_ng
;

20 
	m$this
->
	mfeLiNames
 = 
y
();

21 
	m$this
->
	mmodusPh
 = 
$modu˥h
;

23 
funi
 
DedeModu
(
$modu˥h
='')

25 
$this
->
__cڡru
(
$modu˥h
);

31 
funi
 
GModuLi
(
$moduty
='')

33 if(
is_y
(
$this
->
modus
))  $this->modules;

35 
	g$dh
 = 
d
(
$this
->
modusPh


 
d
("没找到模块目录：({$this->modulesPath})！");

37 
	g$
 = @
fݒ
(
$this
->
modusPh
.'/modusche.php','w'

 
d
('读取文件权限出错,目录文件'.$this->modulesPath.'/modulescache.php不可写!');

39 
fwre
(
$
,"<"."?php\r\n");

40 
fwre
(
$
,"global \$allmodules;\r\n");

41 
	g$fame
 = 
$dh
->
ad
())

43 if(
egi
("\.xml$",
$fame
))

45 
$mfos
 = 
$this
->
GModuInfo
(
r_a
('.xml','',
$fame
));

46 if(
ist
(
$mfos
['moduty']&& 
	g$moduty
!='' && 
$moduty
!=$minfos['moduletype'])

50 if(
	g$mfos
['hash']!='')

52 
$this
->
modus
[
$mfos
['hash']] = $minfos;

53 
fwre
(
$
,'$'."GLOBALS['allmodules']['{$minfos['hash']}']='{$filename}';\r\n");

57 
fwre
(
$
,'?'.'>');

58 
fo
(
$
);

59 
	g$dh
->
Clo
();

60  
	g$this
->
	gmodus
;

66 
funi
 
	$ACode
(&
$r
)

68 if(
$this
->
moduLg
==$this->
sysLg
)

70  
$r
;

74 if(
$this
->
sysLg
=='utf-8')

76 if(
$this
->
moduLg
=='gbk' 
	`gb2utf8
(
$r
);

77 if(
$this
->
moduLg
=='big5' 
	`gb2utf8
(
	`big52gb
(
$r
));

79 if(
$this
->
sysLg
=='gbk')

81 if(
$this
->
moduLg
=='utf-8' 
	`utf82gb
(
$r
);

82 if(
$this
->
moduLg
=='big5' 
	`big52gb
(
$r
);

84 if(
$this
->
sysLg
=='big5')

86 if(
$this
->
moduLg
=='utf-8' 
	`gb2big5
(
	`utf82gb
(
$r
));

87 if(
$this
->
moduLg
=='gbk' 
	`gb2big5
(
$r
);

91  
$r
;

94 
	}
}

99 
funi
 
	$GHashFe
(
$hash
)

101 
	`ude_
(
$this
->
modusPh
.'/modulescache.php');

102 if(
	`ist
(
$GLOBALS
['lmodus'][
$hash
]))  $GLOBALS['allmodules'][$hash];

103  
$hash
.'.xml';

104 
	}
}

109 
funi
 
GModuInfo
(
$hash
,
$y
='hash')

111 if(
$y
=='fe'
$fame
 = 
$hash
;

112 
	g$fame
 = 
$this
->
modusPh
.'/'.$this->
GHashFe
(
$hash
);

113 
	g$t
 = 0;

114 
	g$mfos
 = 
y
();

115 
	g$mfos
['me']=
$mfos
['team']=$minfos['time']=$minfos['email']=$minfos['url']='';

116 
	g$mfos
['hash']=
$mfos
['indexname']=$minfos['indexurl']='';

117 
	g$mfos
['ismemb']=
$mfos
['autosetup']=$minfos['autodel']=0;

118 
	g$mfos
['fame'] = 
$fame
;

119 
	g$mfos
['fesize'] = 
fesize
(
$fame
)/1024;

120 
	g$mfos
['fesize'] = 
numb_fm
(
$mfos
['filesize'],2,'.','').' Kb';

121 
	g$
 = 
fݒ
(
$fame
,'r'

 
d
("文件 {$filename} 不存在或不可读!");

122 
	g$n
 = 0;

123 !
of
(
$
))

125 
	g$n
++;

126 if(
	g$n
 > 30) ;

127 
	g$le
 = 
fgs
(
$
,256);

128 if(
	g$t
==0)

129 { if(
eg_mch
("/<bafo/is",
$le
)
$t
 = 1; }

132 if(
eg_mch
("/<\/bafo/is",
$le
)) ;

133 
	g$le
 = 
im
(
$le
);

134 
li
(
$skey
,
$svue

exode
('=',
$le
);

135 
	g$skey
 = 
im
(
$skey
);

136 
	g$mfos
[
$skey
] = 
$svue
;

139 
fo
(
$
);

141 if(
ist
(
$mfos
['ng'])
	g$this
->
	gmoduLg
 = 
im
($minfos['lang']);

142 
	g$this
->
	gmoduLg
 = 'gbk';

144 if(
	g$this
->
	gsysLg
=='gb2312'
$this
->
sysLg
 = 'gbk';

145 if(
	g$this
->
	gmoduLg
=='gb2312'
$this
->
moduLg
 = 'gbk';

147 if(
	g$this
->
	gsysLg
 !
$this
->
moduLg
)

149 
fܗch
(
$mfos
 
as
 
$k
=>
$v
$mfos[$k] = 
$this
->
ACode
($v);

152  
	g$mfos
;

158 
funi
 
GFeXml
(
$hash
,
$y
='hash')

160 if(
$y
=='fe'
$fame
 = 
$hash
;

161 
	g$fame
 = 
$this
->
modusPh
.'/'.$this->
GHashFe
(
$hash
);

162 
	g$fexml
 = '';

163 
	g$
 = 
fݒ
(
$fame
,'r'

 
d
("文件 {$filename} 不存在或不可读!");

164 
	g$t
 = 0;

165 !
of
(
$
))

167 
	g$le
 = 
fgs
(
$
,1024);

168 if(
	g$t
==0)

170 if(
eg_mch
("/<modufes/is",
$le
))

172 
$fexml
 .
$le
;

173 
	g$t
 = 1;

179 
	g$fexml
 .
$le
;

182 
fo
(
$
);

183  
	g$fexml
;

190 
funi
 
	$GSyemFe
(
$hashcode
,
$y
,
$Code
=
ue
)

192 
$this
->
	`GModuInfo
(
$hashcode
,
$y
);

193 
$t
 = 
l
;

194 
$fame
 = 
$this
->
modusPh
.'/'.$this->
	`GHashFe
(
$hashcode
);

195 
$
 = 
	`fݒ
(
$fame
,'r'

 
	`d
("文件 {$filename} 不存在或不可读!");

196 
$okda
 = '';

197 !
	`of
(
$
))

199 
$le
 = 
	`fgs
(
$
,1024);

200 if(!
$t
)

202 if(
	`egi
("<{$y}",
$le
)
$t
 = 
ue
;

206 if(
	`egi
("</{$y}",
$le
)) ;

207 
$okda
 .
$le
;

208 
	`unt
(
$le
);

211 
	`fo
(
$
);

212 
$okda
 = 
	`im
($okdata);

213 if(!
	`emy
(
$okda
&& 
$Code
$okd
	`ba64_decode
($okdata);

214 
$okda
 = 
$this
->
	`ACode
($okdata);

215  
$okda
;

216 
	}
}

221 
funi
 
	$WreSyemFe
(
$hashcode
,
$y
)

223 
$fame
 = 
$hashcode
."-{$ntype}.php";

224 
$ame
 = 
$this
->
modusPh
.'/'.
$fame
;

225 
$fe
 = 
$this
->
	`GSyemFe
(
$hashcode
,
$y
);

226 
$
 = 
	`fݒ
(
$ame
,'w'

 
	`d
('生成 {$ntype} 文件失败！');

227 
	`fwre
(
$
,
$fe
);

228 
	`fo
(
$
);

229  
$fame
;

230 
	}
}

235 
funi
 
	$DSyemFe
(
$hashcode
,
$y
)

237 
$fame
 = 
$this
->
modusPh
.'/'.
$hashcode
."-{$ntype}.php";

238 
	`uƚk
(
$fame
);

239 
	}
}

244 
funi
 
	$HasModu
(
$hashcode
)

246 
$modufe
 = 
$this
->
modusPh
.'/'.$this->
	`GHashFe
(
$hashcode
);

247 if(
	`fe_exis
(
$modufe
&& !
	`is_d
($modufe) 
ue
;

248  
l
;

249 
	}
}

254 
funi
 
	$GEncodeFe
(
$fame
,
$iemove
=
l
)

256 
$
 = 
	`fݒ
(
$fame
,'r'

 
	`d
("文件 {$filename} 不存在或不可读!");

257 
$r
 = @
	`d
(
$
,
	`fesize
(
$fame
));

258 
	`fo
(
$
);

259 if(
$iemove
@
	`uƚk
(
$fame
);

260 if(!
	`emy
(
$r
) 
	`ba64_code
($str);

262 
	}
}

267 
funi
 
	$GFeLis
(
$hashcode
)

269 
$d
 = 
w
 
	`DedeAP
();

270 
$fis
 = 
	`y
();

271 
$modufe
 = 
$this
->
modusPh
.'/'.$this->
	`GHashFe
(
$hashcode
);

272 
$
 = 
	`fݒ
(
$modufe
,'r'

 
	`d
("文件 {$modulefile} 不存在或不可读!");

273 
$i
 = 0;

274 !
	`of
(
$
))

276 
$le
 = 
	`fgs
(
$
,1024);

277 if(
	`eg_mch
("/^[\s]{0,}<fe/i",
$le
))

279 
$i
++;

280 
$le
 = 
	`im
(
	`eg_a
("/[><]/","",$line));

281 
$d
->
	`SSour
(
$le
);

282 
$fis
[
$i
]['ty'] = 
$d
->
CA
->
	`GA
('type');

283 
$fis
[
$i
]['me'] = 
$d
->
CA
->
	`GA
('name');

286 
	`fo
(
$
);

287  
$fis
;

288 
	}
}

293 
funi
 
	$DeFes
(
$hashcode
,
$i
=0)

295 if(
$i
==0 
ue
;

298 
$d
 = 
w
 
	`DedeAP
();

299 
$modufe
 = 
$this
->
modusPh
.'/'.$this->
	`GHashFe
(
$hashcode
);

300 
$
 = 
	`fݒ
(
$modufe
,'r'

 
	`d
("文件 {$modulefile} 不存在或不可读!");

301 
$i
 = 0;

302 
$ds
 = '';

303 !
	`of
(
$
))

305 
$le
 = 
	`fgs
(
$
,1024);

306 if(
	`eg_mch
("/^[\s]{0,}<fe/i",
$le
))

308 
$i
++;

309 
$le
 = 
	`im
(
	`eg_a
("/[><]/","",$line));

310 
$d
->
	`SSour
(
$le
);

311 
$fy
 = 
$d
->
CA
->
	`GA
('type');

312 
$fame
 = 
$d
->
CA
->
	`GA
('name');

313 
$fame
 = 
	`r_a
("\\","/",$filename);

314 if(
$fy
=='d'){ 
$ds
[] = 
$fame
; }

315 { @
	`uƚk
(
$fame
); }

318 
$okds
 = 
	`y
();

319 if(
	`is_y
(
$ds
)){

320 
$
 = 
	`cou
(
$ds
) -1;

321 
$i
=
$
;$i>=0;$i--){ @
	`rmd
(
$ds
[$i]); }

323 
	`fo
(
$
);

325  
ue
;

326 
	}
}

331 
funi
 
	$WreFes
(
$hashcode
,
$i
=3)

333 
glob
 
$AdmBaD
;

334 
$d
 = 
w
 
	`DedeAP
();

335 
$modufe
 = 
$this
->
modusPh
.'/'.$this->
	`GHashFe
(
$hashcode
);

336 
$
 = 
	`fݒ
(
$modufe
,'r'

 
	`d
("文件 {$modulefile} 不存在或不可读!");

337 
$i
 = 0;

338 !
	`of
(
$
))

340 
$le
 = 
	`fgs
(
$
,1024);

341 if(
	`eg_mch
("/^[\s]{0,}<fe/i",
$le
))

343 
$i
++;

344 
$le
 = 
	`im
(
	`eg_a
("/[><]/","",$line));

345 
$d
->
	`SSour
(
$le
);

346 
$fy
 = 
$d
->
CA
->
	`GA
('type');

347 
$fame
 = 
$d
->
CA
->
	`GA
('name');

348 
$fame
 = 
	`r_a
("\\","/",$filename);

349 if(!
	`emy
(
$AdmBaD
)
$fame
 = $AdminBaseDir.$filename;

350 if(
$fy
=='dir')

352 if(!
	`is_d
(
$fame
))

354 @
	`mkd
(
$fame
,
$GLOBALS
['cfg_dir_purview']);

356 @
	`chmod
(
$fame
,
$GLOBALS
['cfg_dir_purview']);

360 
$this
->
	`TeD
(
$fame
);

361 if(
$i
==0) ;

362 if(
$i
==3)

364 if(
	`is_fe
(
$fame
))

366 
$cyme
 = @
	`eg_a
("/([^\/]{1,}$)/","bak-$1",
$fame
);

367 @
	`cy
(
$fame
,
$cyme
);

370 if(!
	`emy
(
$fame
))

372 
$fw
 = 
	`fݒ
(
$fame
,'w'

 
	`d
("写入文件 {$filename} 失败，请检查相关目录的权限！");

373 
$
 = '';

374 !
	`of
(
$
))

376 
$l
 = 
	`fgs
(
$
,1024);

377 if(
	`eg_mch
("/^[\s]{0,}<\/fe/i",
	`im
(
$l
))){ ; }

378 
$
 .
$l
;

380 
$
 = 
	`ba64_decode
($ct);

381 if(
$this
->
sysLg
!=$this->
moduLg
)

384 if(
	`egi
('\.(xml|php|c|txt|htm|html|shtml|l|css)$',
$fame
))

386 
$
 = 
$this
->
	`ACode
($ct);

389 if(
	`egi
('\.hp|htm|html|shtml|c|l)$',
$fame
))

391 if(
$this
->
sysLg
=='big5'
$cht
 = 'charset=big5';

392 if(
$this
->
sysLg
=='utf-8'
$cht
 = 'charset=gb2312';

393 
$cht
 = 'charset=gb2312';

394 
$
 = 
	`egi
("cht=([a-z0-9-]*)",
$cht
,$ct);

397 
	`fwre
(
$fw
,
$
);

398 
	`fo
(
$fw
);

403 
	`fo
(
$
);

404  
ue
;

405 
	}
}

410 
funi
 
	$TeD
(
$fame
)

412 
$fs
 = 
	`exode
('/',
$fame
);

413 
$
 = 
	`cou
(
$fs
) - 1 ;

414 
$nd
 = '';

415 
$i
=0;$< 
$
;$i++)

417 if(
$nd
!=''$nd = $nd.'/'.
$fs
[
$i
];

418 
$nd
 = 
$fs
[
$i
];

419 
$rs
 = @
	`is_d
(
$nd
);

420 if!
$rs
 ) {

421 @
	`mkd
(
$nd
,
$GLOBALS
['cfg_dir_purview']);

422 @
	`chmod
(
$nd
,
$GLOBALS
['cfg_dir_purview']);

425  
ue
;

426 
	}
}

431 
funi
 
	$MakeEncodeFe
(
$bad
,
$f
,
$
)

433 
$this
->
feLiNames
 = 
	`y
();

434 
$this
->
	`MakeEncodeFeRun
(
$bad
,
$f
,
$
);

435  
ue
;

436 
	}
}

441 
funi
 
	$MakeEncodeFeTe
(
$bad
,
$f
)

443 
$this
->
feLiNames
 = 
	`y
();

444 
$this
->
	`MakeEncodeFeRunTe
(
$bad
,
$f
);

445  
ue
;

446 
	}
}

451 
funi
 
	$MakeEncodeFeRunTe
(
$bad
,
$f
)

453 
$fame
 = 
$bad
.'/'.
$f
;

454 if(
	`ist
(
$this
->
feLiNames
[
$f
])) ;

455 if(
	`egi
("Thumbs\.db",
$f
)) ;

456 
$this
->
feLiNames
[
$f
] = 1;

457 
$feLi
 = '';

458 if(!
	`fe_exis
(
$fame
))

460 
	`ShowMsg
("文件或文件夹: {$filename} 不存在，无法进行编译!","-1");

461 
	`ex
();

463 if(
	`is_d
(
$fame
))

465 
$dh
 = 
	`d
(
$fame
);

466 
$fame
 = 
$dh
->
	`ad
())

468 if(
$fame
[0]=='.' || 
	`ow
($filename)=='cvs') ;

469 
$nfame
 = 
$f
.'/'.
$fame
;

470 
$this
->
	`MakeEncodeFeRunTe
(
$bad
,
$nfame
);

473 
	}
}

478 
funi
 
	$MakeEncodeFeRun
(
$bad
,
$f
,
$
)

480 
$fame
 = 
$bad
.'/'.
$f
;

481 if(
	`ist
(
$this
->
feLiNames
[
$f
])) ;

482 if(
	`egi
("Thumbs\.db",
$f
)) ;

483 
$this
->
feLiNames
[
$f
] = 1;

484 
$feLi
 = '';

485 if(
	`is_d
(
$fame
))

487 
$feLi
 .= "<fileype='dir'ame='$f'>\r\n";

488 
$feLi
 .= "</file>\r\n";

489 
	`fwre
(
$
,
$feLi
);

490 
$dh
 = 
	`d
(
$fame
);

491 
$fame
 = 
$dh
->
	`ad
())

493 if(
$fame
[0]=='.' || 
	`ow
($filename)=='cvs') ;

494 
$nfame
 = 
$f
.'/'.
$fame
;

495 
$this
->
	`MakeEncodeFeRun
(
$bad
,
$nfame
,
$
);

500 
$feLi
 .= "<fileype='file'ame='$f'>\r\n";

501 
$feLi
 .
$this
->
	`GEncodeFe
(
$fame
);

502 
$feLi
 .= "\r\n</file>\r\n";

503 
	`fwre
(
$
,
$feLi
);

505 
	}
}

510 
funi
 
	$Cˬ
()

512 
	`unt
(
$this
->
modus
);

513 
	`unt
(
$this
->
feLi
);

514 
	`unt
(
$this
->
feLiNames
);

515 
	}
}

	@include/dedesql.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

16 
	g$dsql
 = 
$db
 = 
w
 
DedeSql
(
l
);

17 as
	cDedeSql


19 
v
 
	m$lkID
;

20 
v
 
	m$dbHo
;

21 
v
 
	m$dbUr
;

22 
v
 
	m$dbPwd
;

23 
v
 
	m$dbName
;

24 
v
 
	m$dbPfix
;

25 
v
 
	m$su
;

26 
v
 
	m$quySg
;

27 
v
 
	m$ms
;

28 
v
 
	m$isClo
;

29 
v
 
	m$Check
;

32 
funi
 
	$__cڡru
(
$pc
=
l
,
$nc
=
ue
)

34 
$this
->
isClo
 = 
l
;

35 
$this
->
Check
 = 
ue
;

36 if(
$nc
)

38 
$this
->
	`In
(
$pc
);

42 
funi
 
	$DedeSql
(
$pc
=
l
,
$nc
=
ue
)

44 
$this
->
	`__cڡru
(
$pc
,
$nc
);

45 
	}
}

47 
funi
 
	$In
(
$pc
=
l
)

49 
$this
->
lkID
 = 0;

50 
$this
->
quySg
 = '';

51 
$this
->
ms
 = 
	`Aay
();

52 
$this
->
dbHo
 = 
$GLOBALS
['cfg_dbhost'];

53 
$this
->
dbUr
 = 
$GLOBALS
['cfg_dbuser'];

54 
$this
->
dbPwd
 = 
$GLOBALS
['cfg_dbpwd'];

55 
$this
->
dbName
 = 
$GLOBALS
['cfg_dbname'];

56 
$this
->
dbPfix
 = 
$GLOBALS
['cfg_dbprefix'];

57 
$this
->
su
["me"] = 0;

58 
$this
->
	`On
(
$pc
);

59 
	}
}

62 
funi
 
SSour
(
$ho
,
$uame
,
$pwd
,
$dbme
,
$dbefix
="dede_")

64 
$this
->
dbHo
 = 
$ho
;

65 
	g$this
->
	gdbUr
 = 
$uame
;

66 
	g$this
->
	gdbPwd
 = 
$pwd
;

67 
	g$this
->
	gdbName
 = 
$dbme
;

68 
	g$this
->
	gdbPfix
 = 
$dbefix
;

69 
	g$this
->
	gsu
["me"] = 0;

71 
funi
 
	$SeDB
(
$dbme
)

73 
	`mysql__db
(
$dbme
);

74 
	}
}

77 
funi
 
	$SPam
(
$key
,
$vue
)

79 
$this
->
ms
[
$key
]=
$vue
;

80 
	}
}

83 
funi
 
	$On
(
$pc
=
l
)

85 
glob
 
$dsql
;

87 if(
$dsql
 && !$dsql->
isClo
)

89 
$this
->
lkID
 = 
$dsql
->linkID;

93 if(!
$pc
)

95 
$this
->
lkID
 = @
	`mysql_c
($this->
dbHo
,$this->
dbUr
,$this->
dbPwd
);

99 
$this
->
lkID
 = @
	`mysql_pc
($this->
dbHo
,$this->
dbUr
,$this->
dbPwd
);

103 
	`CySQLPot
(
$this
);

107 if(!
$this
->
lkID
)

109 
$this
->
	`DiyE
("DedeCms错误警告：<font color='red'>连接数据库失败，可能数据库密码不对或数据库服务器出错！</font>");

110 
	`ex
();

112 @
	`mysql__db
(
$this
->
dbName
);

113 
$mysqlv
 = 
	`exode
('.',
$this
->
	`GVsi
());

114 
$mysqlv
 = $mysqlver[0].'.'.$mysqlver[1];

115 if(
$mysqlv
>4.0)

117 @
	`mysql_quy
("SET NAMES '".
$GLOBALS
['cfg_db_nguage']."', cha_t_=by, sql_mode='', iaive_timeout=3600 ;", 
$this
->
lkID
);

119  
ue
;

120 
	}
}

123 
funi
 
	$SLgLk
()

125 @
	`mysql_quy
("SET iaive_timeout=3600, wa_timeout=3600 ;", 
$this
->
lkID
);

126 
	}
}

129 
funi
 
	$GE
()

131 
$r
 = 
	`mysql_r
();

132  
$r
;

133 
	}
}

138 
funi
 
	$Clo
(
$isok
=
l
)

140 
$this
->
	`FeResuA
();

141 if(
$isok
)

143 
	`mysql_o
(
$this
->
lkID
);

144 
$this
->
isClo
 = 
ue
;

145 
$GLOBALS
['dsql'] = 
nu
;

147 
	}
}

150 
funi
 
	$CˬELk
()

152 
	}
}

155 
funi
 
	$CloLk
(
$dblk
)

157 @
	`mysql_o
(
$dblk
);

158 
	}
}

161 
funi
 
ExecuNeQuy
(
$sql
='')

163 
glob
 
$dsql
;

164 if(
	g$dsql
->
	gisClo
)

166 
	g$this
->
On
(
l
);

167 
	g$dsql
->
	gisClo
 = 
l
;

169 if(!
emy
(
$sql
))

171 
	g$this
->
SQuy
(
$sql
);

173 if(
is_y
(
$this
->
ms
))

175 
fܗch
(
$this
->
ms
 
as
 
$key
=>
$vue
)

177 
$this
->
quySg
 = 
r_a
("@".
$key
,"'$value'",$this->queryString);

182 if(
	g$this
->
	gCheck

CheckSql
(
$this
->
quySg
,'update');

183  
mysql_quy
(
$this
->
quySg
,$this->
lkID
);

188 
funi
 
ExecuNeQuy2
(
$sql
='')

190 
glob
 
$dsql
;

191 if(
	g$dsql
->
	gisClo
)

193 
	g$this
->
On
(
l
);

194 
	g$dsql
->
	gisClo
 = 
l
;

197 if(!
emy
(
$sql
))

199 
	g$this
->
SQuy
(
$sql
);

201 if(
is_y
(
$this
->
ms
))

203 
fܗch
(
$this
->
ms
 
as
 
$key
=>
$vue
)

205 
$this
->
quySg
 = 
r_a
("@".
$key
,"'$value'",$this->queryString);

208 
mysql_quy
(
$this
->
quySg
,$this->
lkID
);

209  
mysql_afed_rows
(
$this
->
lkID
);

212 
funi
 
ExecNeQuy
(
$sql
='')

214  
$this
->
ExecuNeQuy
(
$sql
);

218 
funi
 
Execu
(
$id
="me", 
$sql
='')

220 
glob
 
$dsql
;

221 if(
	g$dsql
->
	gisClo
)

223 
	g$this
->
On
(
l
);

224 
	g$dsql
->
	gisClo
 = 
l
;

226 if(!
emy
(
$sql
))

228 
	g$this
->
SQuy
(
$sql
);

232 if(
	g$this
->
	gCheck
)

234 
CheckSql
(
$this
->
quySg
);

237 
	g$t1
 = 
ExecTime
();

239 
	g$this
->
	gsu
[
$id
] = 
mysql_quy
(
$this
->
quySg
,$this->
lkID
);

247 if(
	g$this
->
	gsu
[
$id
]===
l
)

249 
$this
->
DiyE
(
mysql_r
()." <b/>E sql: <fڈc='d'>".$this->
quySg
."</font>");

253 
funi
 
Quy
(
$id
="me",
$sql
='')

255 
$this
->
Execu
(
$id
,
$sql
);

259 
funi
 
GO
(
$sql
='',
$acy
=
MYSQL_ASSOC
)

261 
glob
 
$dsql
;

262 if(
	g$dsql
->
	gisClo
)

264 
	g$this
->
On
(
l
);

265 
	g$dsql
->
	gisClo
 = 
l
;

267 if(!
emy
(
$sql
))

269 if(!
egi
("lim",
$sql
)
	g$this
->
SQuy
(
egi_a
("[,;]$",'',
im
($sql))."imit 0,1;");

270 
	g$this
->
SQuy
(
$sql
);

272 
	g$this
->
Execu
("one");

273 
	g$r
 = 
$this
->
GAay
("e",
$acy
);

274 if(!
is_y
(
$r
))

280 @
mysql__su
(
$this
->
su
["e"]); (
	g$r
);

285 
funi
 
ExecuSaQuy
(
$sql
,
$id
="me")

287 
glob
 
$dsql
;

288 if(
	g$dsql
->
	gisClo
)

290 
	g$this
->
On
(
l
);

291 
	g$dsql
->
	gisClo
 = 
l
;

293 
	g$this
->
	gsu
[
$id
] = @
mysql_quy
(
$sql
,
$this
->
lkID
);

298 
funi
 
GAay
(
$id
="me",
$acy
=
MYSQL_ASSOC
)

300 if(
$this
->
su
[
$id
]==0)

302  
l
;

306  
mysql_tch_y
(
$this
->
su
[
$id
],
$acy
);

310 
funi
 
GObje
(
$id
="me")

312 if(
$this
->
su
[
$id
]==0)

314  
l
;

318  
mysql_tch_obje
(
$this
->
su
[
$id
]);

323 
funi
 
	$IsTab
(
$tbme
)

325 
$this
->
su
[0] = 
	`mysql_li_bs
($this->
dbName
,$this->
lkID
);

326 
$row
 = 
	`mysql_tch_y
(
$this
->
su
[0]))

328 if(
	`ow
(
$row
[0])==ow(
$tbme
))

330 
	`mysql_䓻su
(
$this
->
su
[0]);

331  
ue
;

334 
	`mysql_䓻su
(
$this
->
su
[0]);

335  
l
;

336 
	}
}

339 
funi
 
	$GVsi
(
$isfm
=
ue
)

341 
glob
 
$dsql
;

342 if(
$dsql
->
isClo
)

344 
$this
->
	`On
(
l
);

345 
$dsql
->
isClo
 = 
l
;

347 
$rs
 = 
	`mysql_quy
("SELECT VERSION();",
$this
->
lkID
);

348 
$row
 = 
	`mysql_tch_y
(
$rs
);

349 
$mysql_vsi
 = 
$row
[0];

350 
	`mysql__su
(
$rs
);

351 if(
$isfm
)

353 
$mysql_vsis
 = 
	`exode
(".",
	`im
(
$mysql_vsi
));

354 
$mysql_vsi
 = 
	`numb_fm
(
$mysql_vsis
[0].".".$mysql_versions[1],2);

356  
$mysql_vsi
;

357 
	}
}

360 
funi
 
GTabFlds
(
$tbme
,
$id
="me")

362 
$this
->
su
[
$id
] = 
mysql_li_flds
($this->
dbName
,
$tbme
,$this->
lkID
);

366 
funi
 
GFldObje
(
$id
="me")

368  
mysql_tch_fld
(
$this
->
su
[
$id
]);

372 
funi
 
GTٮRow
(
$id
="me")

374 if(
$this
->
su
[
$id
]==0)

380  
mysql_num_rows
(
$this
->
su
[
$id
]);

385 
funi
 
	$GLaID
()

392  
	`mysql__id
(
$this
->
lkID
);

393 
	}
}

396 
funi
 
FeResu
(
$id
="me")

398 @
mysql__su
(
$this
->
su
[
$id
]);

400 
funi
 
	$FeResuA
()

402 if(!
	`is_y
(
$this
->
su
))

406 
	`fܗch
(
$this
->
su
 
as
 
$kk
 => 
$vv
)

408 if(
$vv
)

410 @
	`mysql__su
(
$vv
);

413 
	}
}

416 
funi
 
	$SQuy
(
$sql
)

418 
$efix
="#@__";

419 
$sql
 = 
	`r_a
(
$efix
,
$this
->
dbPfix
,$sql);

420 
$this
->
quySg
 = 
$sql
;

421 
	}
}

423 
funi
 
	$SSql
(
$sql
)

425 
$this
->
	`SQuy
(
$sql
);

426 
	}
}

429 
funi
 
	$DiyE
(
$msg
)

431 
$rTckFe
 = 
	`dme
(
__FILE__
).'/../data/mysql_error_trace.inc';

432 if
	`fe_exis
(
	`dme
(
__FILE__
).'/../data/mysql_error_trace.php') )

434 @
	`uƚk
(
	`dme
(
__FILE__
).'/../data/mysql_error_trace.php');

436 
$emsg
 = '';

437 
$emsg
 .= "<div><h3>DedeCMS Error Warning!</h3>\r\n";

438 
$emsg
 .= "<div><a href='http://bbs.dedecms.com'arget='_blank' style='color:red'>Technical Support: http://bbs.dedecms.com</a></div>";

439 
$emsg
 .= "<div style='line-helght:160%;font-size:14px;color:green'>\r\n";

440 
$emsg
 ."<div sty='c:blue'><b/>E܅age: <fڈc='d'>".
$this
->
	`GCurU
()."</font></div>\r\n";

441 
$emsg
 .= "<div>Error infos: {$msg}</div>\r\n";

442 
$emsg
 .= "<br /></div></div>\r\n";

444 
echo
 
$emsg
;

446 
$vemsg
 = 'Page: '.
$this
->
	`GCurU
()."\r\nE: ".
$msg
;

448 
$
 = @
	`fݒ
(
$rTckFe
, 'a');

449 @
	`fwre
(
$
, '<'.'?php'."\r\n/*\r\n{$savemsg}\r\n*/\r\n?".">\r\n");

450 @
	`fo
(
$
);

451 
	}
}

454 
funi
 
	$GCurU
()

456 if(!
	`emy
(
$_SERVER
["REQUEST_URI"]))

458 
$stName
 = 
$_SERVER
["REQUEST_URI"];

459 
$nowu
 = 
$stName
;

463 
$stName
 = 
$_SERVER
["PHP_SELF"];

464 if(
	`emy
(
$_SERVER
["QUERY_STRING"])) {

465 
$nowu
 = 
$stName
;

468 
$nowu
 = 
$stName
."?".
$_SERVER
["QUERY_STRING"];

471  
$nowu
;

472 
	}
}

477 if(
ist
(
$GLOBALS
['arrs1']))

479 
	g$v1
 = 
$v2
 = '';

480 
	g$i
=0;
ist
(
$rs1
[
$i
]);$i++)

482 
	g$v1
 .
PCv
(
$rs1
[
$i
]);

484 
	g$i
=0;
ist
(
$rs2
[
$i
]);$i++)

486 
	g$v2
 .
PCv
(
$rs2
[
$i
]);

488 
	g$GLOBALS
[
$v1
] .
$v2
;

492 
funi
 
	$CySQLPot
(&
$ndsql
)

494 
$GLOBALS
['dsql'] = 
$ndsql
;

495 
	}
}

498 
funi
 
CheckSql
(
$db_rg
,
$quyty
='select')

500 
glob
 
$cfg_cook_code
;

501 
	g$n
 = '';

502 
	g$r
='';

503 
	g$d_pos
 = 0;

504 
	g$pos
 = -1;

505 
	g$log_fe
 = 
DEDEINC
.'/../da/'.
md5
(
$cfg_cook_code
).'_safe.txt';

506 
	g$urIP
 = 
GIP
();

507 
	g$gU
 = 
GCurU
();

510 if(
	g$quyty
=='select')

512 
$nٮlow1
 = "[^0-9a-z@\._-]{1,}(union|sleep|benchmark|load_file|outfile)[^0-9a-z@\.-]{1,}";

515 if(
egi
(
$nٮlow1
,
$db_rg
))

517 
uts
(
fݒ
(
$log_fe
,'a+'),"$userIP||$getUrl||$db_string||SelectBreak\r\n");

518 
ex
("<font size='5' color='red'>Safe Alert: Request Error step 1 !</font>");

523 
	gue
)

525 
	g$pos
 = 
os
(
$db_rg
, '\'', 
$pos
 + 1);

526 i(
	g$pos
 ==
l
)

530 
	g$n
 .
subr
(
$db_rg
, 
$d_pos
, 
$pos
 - $old_pos);

531 
	gue
)

533 
	g$pos1
 = 
os
(
$db_rg
, '\'', 
$pos
 + 1);

534 
	g$pos2
 = 
os
(
$db_rg
, '\\', 
$pos
 + 1);

535 i(
	g$pos1
 ==
l
)

539 
if
 (
$pos2
 =
l
 || $pos2 > 
$pos1
)

541 
$pos
 = 
$pos1
;

544 
	g$pos
 = 
$pos2
 + 1;

546 
	g$n
 .= '$s$';

547 
	g$d_pos
 = 
$pos
 + 1;

549 
	g$n
 .
subr
(
$db_rg
, 
$d_pos
);

550 
	g$n
 = 
im
(
ow
(
eg_a
(
y
('~\s+~s' ),ay(' '), 
$n
)));

553 i(
os
(
$n
, 'uni'!=
l
 && 
eg_mch
('~(^|[^a-z])union($|[^[a-z])~s', $clean) != 0)

555 
$
 = 
ue
;

556 
	g$r
="union detect";

560 
if
 (
os
(
$n
, '/*'> 2 || spos($n, '--'!=
l
 || strpos($clean, '#') !== false)

562 
$
 = 
ue
;

563 
	g$r
="comment detect";

567 
if
 (
os
(
$n
, 'p'!=
l
 && 
eg_mch
('~(^|[^a-z])sleep($|[^[a-z])~s', $clean) != 0)

569 
$
 = 
ue
;

570 
	g$r
="slown down detect";

572 
if
 (
os
(
$n
, 'bchmk'!=
l
 && 
eg_mch
('~(^|[^a-z])benchmark($|[^[a-z])~s', $clean) != 0)

574 
$
 = 
ue
;

575 
	g$r
="slown down detect";

577 
if
 (
os
(
$n
, 'ld_fe'!=
l
 && 
eg_mch
('~(^|[^a-z])load_file($|[^[a-z])~s', $clean) != 0)

579 
$
 = 
ue
;

580 
	g$r
="file fun detect";

582 
if
 (
os
(
$n
, 'toutfe'!=
l
 && 
eg_mch
('~(^|[^a-z])into\s+outfile($|[^[a-z])~s', $clean) != 0)

584 
$
 = 
ue
;

585 
	g$r
="file fun detect";

589 
if
 (
eg_mch
('~\([^)]*?~s', 
$n
) != 0)

591 
$
 = 
ue
;

592 
	g$r
="sub select detect";

594 i(!
emy
(
$
))

596 
uts
(
fݒ
(
$log_fe
,'a+'),"$userIP||$getUrl||$db_string||$error\r\n");

597 
ex
("<font size='5' color='red'>Safe Alert: Request Error step 2!</font>");

601  
	g$db_rg
;

	@include/dedetag.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

11 as
	cDedeTag


13 
v
 
	m$IsR
=
FALSE
;

14 
v
 
	m$TagName
="";

15 
v
 
	m$IText
="";

16 
v
 
	m$SPos
=0;

17 
v
 
	m$EndPos
=0;

18 
v
 
	m$CAribu
="";

19 
v
 
	m$TagVue
="";

20 
v
 
	m$TagID
 = 0;

23 
funi
 
	$GName
()

25  
	`ow
(
$this
->
TagName
);

28 
funi
 
	$GVue
()

30  
$this
->
TagVue
;

31 
	}
}

34 
funi
 
	$GTagName
()

36  
	`ow
(
$this
->
TagName
);

37 
	}
}

39 
funi
 
	$GTagVue
()

41  
$this
->
TagVue
;

42 
	}
}

45 
funi
 
	$IsAribu
(
$r
)

47  
$this
->
CAribu
->
	`IsAribu
(
$r
);

48 
	}
}

50 
funi
 
	$GAribu
(
$r
)

52  
$this
->
CAribu
->
	`GA
(
$r
);

53 
	}
}

55 
funi
 
	$GA
(
$r
)

57  
$this
->
CAribu
->
	`GA
(
$r
);

58 
	}
}

60 
funi
 
	$GIText
()

62  
$this
->
IText
;

63 
	}
}

70 as
	cDedeTagP


72 
v
 
	m$NameS
 = 'dede';

73 
v
 
	m$TagSWd
 = '{';

74 
v
 
	m$TagEndWd
 = '}';

75 
v
 
	m$TagMaxL
 = 64;

76 
v
 
	m$ChToLow
 = 
ue
;

77 
v
 
	m$IsCache
 = 
FALSE
;

78 
v
 
	m$TempMkTime
 = 0;

79 
v
 
	m$CacheFe
 = '';

80 
v
 
	m$SourSg
 = '';

81 
v
 
	m$CTags
 = '';

82 
v
 
	m$Cou
 = -1;

83 
v
 
	m$fObj
 = '';

85 
funi
 
	$__cڡru
()

87 if(!
	`ist
(
$GLOBALS
['cfg_tplcache']))

89 
$GLOBALS
['cfg_tplcache'] = 'N';

91 if(
$GLOBALS
['cfg_tplcache']=='Y')

93 
$this
->
IsCache
 = 
ue
;

97 
$this
->
IsCache
 = 
FALSE
;

99 
$this
->
NameS
 = 'dede';

100 
$this
->
TagSWd
 = '{';

101 
$this
->
TagEndWd
 = '}';

102 
$this
->
TagMaxL
 = 64;

103 
$this
->
ChToLow
 = 
ue
;

104 
$this
->
SourSg
 = '';

105 
$this
->
CTags
 = 
	`Aay
();

106 
$this
->
Cou
 = -1;

107 
$this
->
TempMkTime
 = 0;

108 
$this
->
CacheFe
 = '';

111 
funi
 
	$DedeTagP
()

113 
$this
->
	`__cڡru
();

114 
	}
}

117 
funi
 
SNameS
(
$r
,
$s
="{",
$e
="}")

119 
$this
->
NameS
 = 
ow
(
$r
);

120 
	g$this
->
	gTagSWd
 = 
$s
;

121 
	g$this
->
	gTagEndWd
 = 
$e
;

125 
funi
 
	$SDeu
()

127 
$this
->
SourSg
 = '';

128 
$this
->
CTags
 = '';

129 
$this
->
Cou
=-1;

130 
	}
}

133 
funi
 
	$SRefObj
(&
$fObj
)

135 
$this
->
fObj
 = 
$fObj
;

136 
	}
}

138 
funi
 
	$GCou
()

140  
$this
->
Cou
+1;

141 
	}
}

143 
funi
 
	$Cˬ
()

145 
$this
->
	`SDeu
();

146 
	}
}

149 
funi
 
	$LdCache
(
$fame
)

151 
glob
 
$cfg_lche
,
$cfg_lche_d
;

152 if(!
$this
->
IsCache
)

154  
l
;

156 
$cd
 = 
	`dme
(
$fame
);

157 
$ched
 = 
DEDEROOT
.
$cfg_lche_d
;

158 
$ckfe
 = 
	`r_a
(
$cd
,'',
$fame
).
	`subr
(
	`md5
($filename),0,16).'.inc';

159 
$ckfufe
 = 
$ched
.'/'.
$ckfe
;

160 
$ckfufe_t
 = 
$ched
.'/'.
$ckfe
.'.txt';

161 
$this
->
CacheFe
 = 
$ckfufe
;

162 
$this
->
TempMkTime
 = 
	`femtime
(
$fame
);

163 if(!
	`fe_exis
(
$ckfufe
)||!fe_exis(
$ckfufe_t
))

165  
l
;

169 
$
 = 
	`fݒ
(
$ckfufe_t
,'r');

170 
$time_fo
 = 
	`im
(
	`fgs
(
$
,64));

171 
	`fo
(
$
);

172 if(
$time_fo
 !
$this
->
TempMkTime
)

174  
l
;

178 
	`ude
(
$this
->
CacheFe
);

181 if(
	`ist
(
$z
&& 
	`is_y
($z))

183 
	`fܗch
(
$z
 
as
 
$k
=>
$v
)

185 
$this
->
Cou
++;

186 
$ag
 = 
w
 
	`DedeTAg
();

187 
$ag
->
CAribu
 = 
w
 
	`DedeAribu
();

188 
$ag
->
IsR
 = 
FALSE
;

189 
$ag
->
TagName
 = 
$v
[0];

190 
$ag
->
IText
 = 
$v
[1];

191 
$ag
->
SPos
 = 
$v
[2];

192 
$ag
->
EndPos
 = 
$v
[3];

193 
$ag
->
TagVue
 = '';

194 
$ag
->
TagID
 = 
$k
;

195 if(
	`ist
(
$v
[4]&& 
	`is_y
($v[4]))

197 
$i
 = 0;

198 
	`fܗch
(
$v
[4] 
as
 
$k
=>$v)

200 
$ag
->
CAribu
->
Cou
++;

201 
$ag
->
CAribu
->
Ims
[
$k
]=
$v
;

204 
$this
->
CTags
[$this->
Cou
] = 
$ag
;

210 
$this
->
CTags
 = '';

211 
$this
->
Cou
 = -1;

213  
ue
;

214 
	}
}

217 
funi
 
	$SaveCache
()

219 
$
 = 
	`fݒ
(
$this
->
CacheFe
.'.txt',"w");

220 
	`fwre
(
$
,
$this
->
TempMkTime
."\n");

221 
	`fo
(
$
);

222 
$
 = 
	`fݒ
(
$this
->
CacheFe
,"w");

223 
	`ock
(
$
,3);

224 
	`fwre
(
$
,'<'.'?php'."\r\n");

225 if(
	`is_y
(
$this
->
CTags
))

227 
	`fܗch
(
$this
->
CTags
 
as
 
$tid
=>
$ag
)

229 
$yVue
 = 'Aay("'.
$ag
->
TagName
.'",';

230 
$yVue
 .'"'.
	`r_a
('$','\$',r_a("\r","\\r",r_a("\n","\\n",r_a('"','\"',r_a("\\","\\\\",
$ag
->
IText
))))).'"';

231 
$yVue
 .= ",{$ctag->StartPos},{$ctag->EndPos});";

232 
	`fwre
(
$
,"\$z[$tid]={$arrayValue}\n");

233 if(
	`is_y
(
$ag
->
CAribu
->
Ims
))

235 
	`fܗch
(
$ag
->
CAribu
->
Ims
 
as
 
$k
=>
$v
)

237 
$v
 = 
	`r_a
("\\","\\\\",$v);

238 
$v
 = 
	`r_a
('"',"\\".'"',$v);

239 
$v
 = 
	`r_a
('$','\$',$v);

240 
$k
 = 
	`im
(
	`r_a
("'","",$k));

241 if(
$k
=="")

245 if(
$k
!='tagname')

247 
	`fwre
(
$
,"\$z[$tid][4]['$k']=\"$v\";\n");

253 
	`fwre
(
$
,"\n".'?'.'>');

254 
	`fo
(
$
);

255 
	}
}

258 
funi
 
	$LdTeme
(
$fame
)

260 
$this
->
	`SDeu
();

261 if(!
	`fe_exis
(
$fame
))

263 
$this
->
SourSg
 = " $filename Not Found! ";

264 
$this
->
	`PTem
();

268 
$
 = @
	`fݒ
(
$fame
, "r");

269 
$le
 = 
	`fgs
(
$
,1024))

271 
$this
->
SourSg
 .
$le
;

273 
	`fo
(
$
);

274 if(
$this
->
	`LdCache
(
$fame
))

280 
$this
->
	`PTem
();

283 
	}
}

285 
funi
 
	$LdTem
(
$fame
)

287 
$this
->
	`LdTeme
(
$fame
);

288 
	}
}

290 
funi
 
	$LdFe
(
$fame
)

292 
$this
->
	`LdTeme
(
$fame
);

293 
	}
}

296 
funi
 
	$LdSour
(
$r
)

298 
$this
->
	`SDeu
();

299 
$this
->
SourSg
 = 
$r
;

300 
$this
->
IsCache
 = 
FALSE
;

301 
$this
->
	`PTem
();

302 
	}
}

304 
funi
 
	$LdSg
(
$r
)

306 
$this
->
	`LdSour
(
$r
);

307 
	}
}

310 
funi
 
	$GTagID
(
$r
)

312 if(
$this
->
Cou
==-1)

316 if(
$this
->
ChToLow
)

318 
$r
=
	`ow
($str);

320 
	`fܗch
(
$this
->
CTags
 
as
 
$id
=>
$CTag
)

322 if(
$CTag
->
TagName
==
$r
 && !$CTag->
IsR
)

324  
$id
;

329 
	}
}

332 
funi
 
	$GTag
(
$r
)

334 if(
$this
->
Cou
==-1)

338 if(
$this
->
ChToLow
)

340 
$r
=
	`ow
($str);

342 
	`fܗch
(
$this
->
CTags
 
as
 
$id
=>
$CTag
)

344 if(
$CTag
->
TagName
==
$r
 && !$CTag->
IsR
)

346  
$CTag
;

351 
	}
}

353 
funi
 
	$GTagByName
(
$r
)

355  
$this
->
	`GTag
(
$r
);

356 
	}
}

359 
funi
 
	$GTagByID
(
$id
)

361 if(
	`ist
(
$this
->
CTags
[
$id
]))

363  
$this
->
CTags
[
$id
];

369 
	}
}

372 
funi
 
	$AssignV
(
$vme
,
$vvue
)

374 if(!
	`ist
(
$_sys_globs
['define']))

376 
$_sys_globs
['define'] = 'yes';

378 
$_sys_globs
[
$vme
] = 
$vvue
;

379 
	}
}

382 
funi
 
	$Assign
(
$i
,
$r
,
$runfunc
 = 
ue
)

384 if(
	`ist
(
$this
->
CTags
[
$i
]))

386 
$this
->
CTags
[
$i
]->
IsR
 = 
ue
;

387 
$this
->
CTags
[
$i
]->
TagVue
 = 
$r
;

389 if
$this
->
CTags
[
$i
]->
	`GA
('funi')!='' && 
$runfunc
 )

391 
$this
->
CTags
[
$i
]->
TagVue
 = $this->
	`EvFunc

$r
, $this->CTags[$i]->
	`GA
('function'),$this->CTags[$i] );

394 
	}
}

397 
funi
 
	$AssignName
(
$gme
,
$r
)

399 
	`fܗch
(
$this
->
CTags
 
as
 
$id
=>
$CTag
)

401 if(
$CTag
->
TagName
==
$gme
)

403 
$this
->
	`Assign
(
$id
,
$r
);

406 
	}
}

409 
funi
 
	$AssignSysTag
()

411 
glob
 
$_sys_globs
;

412 
$i
=0;$i<=
$this
->
Cou
;$i++)

414 
$CTag
 = 
$this
->
CTags
[
$i
];

415 
$r
 = '';

418 if
$CTag
->
TagName
 == 'global' )

420 
$r
 = 
$this
->
	`GGlobs
(
$CTag
->
	`GA
('name'));

421 if
$this
->
CTags
[
$i
]->
	`GA
('function')!='' )

423 
$r
 = 
$this
->
	`EvFunc
$this->
CTags
[
$i
]->
TagVue
, $this->CTags[$i]->
	`GA
('function'),$this->CTags[$i] );

425 
$this
->
CTags
[
$i
]->
IsR
 = 
ue
;

426 
$this
->
CTags
[
$i
]->
TagVue
 = 
$r
;

430 if
$CTag
->
TagName
 == 'include' )

432 
$fame
 = (
$CTag
->
	`GA
('file')=='' ? $CTag->GetAtt('filename') : $CTag->GetAtt('file') );

433 
$r
 = 
$this
->
	`InudeFe
(
$fame
,
$CTag
->
	`GA
('ismake'));

434 
$this
->
CTags
[
$i
]->
IsR
 = 
ue
;

435 
$this
->
CTags
[
$i
]->
TagVue
 = 
$r
;

439 if
$CTag
->
TagName
 == 'foreach' )

441 
$r
 = 
$this
->
CTags
[
$i
]->
	`GA
('array');

442 if(
	`ist
(
$GLOBALS
[
$r
]))

444 
	`fܗch
(
$GLOBALS
[
$r
] 
as
 
$k
=>
$v
)

446 
$ir
 = '';

447 
$ir
 .
	`eg_a
("/\[fld:key([\r\n\t\]+)\/\]/is",
$k
,
$this
->
CTags
[
$i
]->
IText
);

448 
$r
 .
	`eg_a
("/\[fld:vue([\r\n\t\]+)\/\]/is",
$v
,
$ir
);

451 
$this
->
CTags
[
$i
]->
IsR
 = 
ue
;

452 
$this
->
CTags
[
$i
]->
TagVue
 = 
$r
;

456 if
$CTag
->
TagName
 == 'var' )

458 
$vme
 = 
$this
->
CTags
[
$i
]->
	`GA
('name');

459 if(
$vme
=='')

461 
$r
 = '';

463 if(
$this
->
CTags
[
$i
]->
	`GA
('value')!='')

465 
$_vs
[
$vme
] = 
$this
->
CTags
[
$i
]->
	`GA
('value');

469 
$r
 = (
	`ist
(
$_vs
[
$vme
]) ? $_vars[$vname] : '');

471 
$this
->
CTags
[
$i
]->
IsR
 = 
ue
;

472 
$this
->
CTags
[
$i
]->
TagVue
 = 
$r
;

476 if
$CTag
->
	`GA
('runphp') == 'yes' )

478 
$this
->
	`RunPHP
(
$CTag
,
$i
);

480 if(
	`is_y
(
$this
->
CTags
[
$i
]->
TagVue
))

482 
$this
->
CTags
[
$i
]->
TagVue
 = 'array';

485 
	}
}

488 
funi
 
	$RunPHP
(&
$fObj
,
$i
)

490 
$DedeMeVue
 = 
$phpcode
 = '';

491 if(
$fObj
->
	`GA
('source')=='value')

493 
$phpcode
 = 
$this
->
CTags
[
$i
]->
TagVue
;

497 
$DedeMeVue
 = 
$this
->
CTags
[
$i
]->
TagVue
;

498 
$phpcode
 = 
$fObj
->
	`GIText
();

500 
$phpcode
 = 
	`egi_a
("'@me'|\"@me\"|@me",'$DedeMeValue',$phpcode);

501 @
	`ev
(
$phpcode
);

503 
$this
->
CTags
[
$i
]->
TagVue
 = 
$DedeMeVue
;

504 
$this
->
CTags
[
$i
]->
IsR
 = 
ue
;

505 
	}
}

509 
funi
 
	$GResuNP
()

511 
$ResuSg
 = '';

512 if(
$this
->
Cou
==-1)

514  
$this
->
SourSg
;

516 
$this
->
	`AssignSysTag
();

517 
$xtTagEnd
 = 0;

518 
$rok
 = "";

519 
$i
=0;$i<=
$this
->
Cou
;$i++)

521 if(
$this
->
CTags
[
$i
]->
	`GVue
()!="")

523 if(
$this
->
CTags
[
$i
]->
	`GVue
()=='#@Delete@#')

525 
$this
->
CTags
[
$i
]->
TagVue
 = "";

527 
$ResuSg
 .
	`subr
(
$this
->
SourSg
,
$xtTagEnd
,$this->
CTags
[
$i
]->
SPos
-$nextTagEnd);

528 
$ResuSg
 .
$this
->
CTags
[
$i
]->
	`GVue
();

529 
$xtTagEnd
 = 
$this
->
CTags
[
$i
]->
EndPos
;

532 
$
 = 
	`
(
$this
->
SourSg
);

533 if(
$
>
$xtTagEnd
)

535 
$ResuSg
 .
	`subr
(
$this
->
SourSg
,
$xtTagEnd
,
$
-$nextTagEnd);

537  
$ResuSg
;

538 
	}
}

541 
funi
 
	$GResu
()

543 
$ResuSg
 = '';

544 if(
$this
->
Cou
==-1)

546  
$this
->
SourSg
;

548 
$this
->
	`AssignSysTag
();

549 
$xtTagEnd
 = 0;

550 
$rok
 = "";

551 
$i
=0;$i<=
$this
->
Cou
;$i++)

553 
$ResuSg
 .
	`subr
(
$this
->
SourSg
,
$xtTagEnd
,$this->
CTags
[
$i
]->
SPos
-$nextTagEnd);

554 
$ResuSg
 .
$this
->
CTags
[
$i
]->
	`GVue
();

555 
$xtTagEnd
 = 
$this
->
CTags
[
$i
]->
EndPos
;

557 
$
 = 
	`
(
$this
->
SourSg
);

558 if(
$
>
$xtTagEnd
)

560 
$ResuSg
 .
	`subr
(
$this
->
SourSg
,
$xtTagEnd
,
$
-$nextTagEnd);

562  
$ResuSg
;

563 
	}
}

566 
funi
 
	$Diy
()

568 
echo
 
$this
->
	`GResu
();

569 
	}
}

572 
funi
 
	$SaveTo
(
$fame
)

574 
$
 = @
	`fݒ
(
$fame
,"w"

 
	`d
("DedeTag Engine Create File False");

575 
	`fwre
(
$
,
$this
->
	`GResu
());

576 
	`fo
(
$
);

577 
	}
}

580 
funi
 
	$PTem
()

582 
$TagSWd
 = 
$this
->
TagSWd
;

583 
$TagEndWd
 = 
$this
->
TagEndWd
;

584 
$sPos
 = 0; 
$ePos
 = 0;

585 
$FuTagSWd
 = 
$TagSWd
.
$this
->
NameS
.":";

586 
$sTagEndWd
 = 
$TagSWd
."/".
$this
->
NameS
.":";

587 
$eTagEndWd
 = "/".
$TagEndWd
;

588 
$tsL
 = 
	`
(
$FuTagSWd
);

589 
$sourL
=
	`
(
$this
->
SourSg
);

591 if
$sourL
 <(
$tsL
 + 3) )

595 
$cA
 = 
w
 
	`DedeAribuP
();

596 
$cA
->
chToLow
 = 
$this
->
ChToLow
;

599 
$i
=0; $< 
$sourL
; $i++)

601 
$tTagName
 = '';

604 if(
$i
-1 >= 0)

606 
$ss
 = 
$i
-1;

610 
$ss
 = 0;

612 
$sPos
 = 
	`os
(
$this
->
SourSg
,
$FuTagSWd
,
$ss
);

613 
$isTag
 = 
$sPos
;

614 if(
$i
==0)

616 
$hdTag
 = 
	`subr
(
$this
->
SourSg
,0,
	`
(
$FuTagSWd
));

617 if(
$hdTag
==
$FuTagSWd
)

619 
$isTag
=
ue
; 
$sPos
=0;

622 if(
$isTag
===
FALSE
)

633 
$j
=(
$sPos
+
$tsL
);$j<($sPos+$tsL+
$this
->
TagMaxL
);$j++)

635 if(
$j
>(
$sourL
-1))

639 if
	`eg
("[/ \t\r\n]",
$this
->
SourSg
[
$j
]|| $this->SourSg[$j] =$this->
TagEndWd
 )

645 
$tTagName
 .
$this
->
SourSg
[
$j
];

648 if(
$tTagName
!='')

650 
$i
 = 
$sPos
+
$tsL
;

651 
$dPos
 = -1;

652 
$fuTagEndWdThis
 = 
$sTagEndWd
.
$tTagName
.
$TagEndWd
;

654 
$e1
 = 
	`os
(
$this
->
SourSg
,
$eTagEndWd
, 
$i
);

655 
$e2
 = 
	`os
(
$this
->
SourSg
,
$FuTagSWd
, 
$i
);

656 
$e3
 = 
	`os
(
$this
->
SourSg
,
$fuTagEndWdThis
,
$i
);

660 
$e1
 = 
	`im
($e1); 
$e2
 =rim($e2); 
$e3
 =rim($e3);

661 
$e1
 = ($e1=='' ? '-1' : $e1);

662 
$e2
 = ($e2=='' ? '-1' : $e2);

663 
$e3
 = ($e3=='' ? '-1' : $e3);

665 if(
$e3
==-1)

667 
$dPos
 = 
$e1
;

668 
$
 = 
$dPos
 + 
	`
(
$eTagEndWd
);

671 if(
$e1
==-1)

673 
$dPos
 = 
$e3
;

674 
$
 = 
$dPos
 + 
	`
(
$fuTagEndWdThis
);

680 if(
$e1
 < 
$e2
 && $e1 < 
$e3
 )

682 
$dPos
 = 
$e1
;

683 
$
 = 
$dPos
 + 
	`
(
$eTagEndWd
);

687 
$dPos
 = 
$e3
;

688 
$
 = 
$dPos
 + 
	`
(
$fuTagEndWdThis
);

693 if(
$dPos
==-1)

695 
echo
 "Characterostion $sPos, '$tTagName' Error！<br />\r\n";

698 
$i
 = 
$
;

699 
$ePos
 = 
$dPos
;

702 
$tS
 = '';

703 
$rText
 = '';

704 
$tI
 = 0;

705 
$j
=(
$sPos
+
$tsL
);$j < 
$ePos
;$j++)

707 if(
$tI
==0 && (
$this
->
SourSg
[
$j
]==
$TagEndWd
 && $this->SourceString[$j-1]!="\\") )

709 
$tI
=1;

712 if(
$tI
==0)

714 
$tS
 .
$this
->
SourSg
[
$j
];

718 
$rText
 .
$this
->
SourSg
[
$j
];

722 
$cA
->
	`SSour
(
$tS
);

723 if(
$cA
->
cAribus
->
	`GTagName
()!='')

725 
$this
->
Cou
++;

726 
$CDTag
 = 
w
 
	`DedeTag
();

727 
$CDTag
->
TagName
 = 
$cA
->
cAribus
->
	`GTagName
();

728 
$CDTag
->
SPos
 = 
$sPos
;

729 
$CDTag
->
EndPos
 = 
$i
;

730 
$CDTag
->
CAribu
 = 
$cA
->
cAribus
;

731 
$CDTag
->
IsR
 = 
FALSE
;

732 
$CDTag
->
TagID
 = 
$this
->
Cou
;

733 
$CDTag
->
IText
 = 
$rText
;

734 
$this
->
CTags
[$this->
Cou
] = 
$CDTag
;

739 
$i
 = 
$sPos
+
$tsL
;

744 if(
$this
->
IsCache
)

746 
$this
->
	`SaveCache
();

748 
	}
}

751 
funi
 
	$EvFunc
(
$fldvue
,
$funime
,&
$fObj
)

753 
$DedeFldVue
 = 
$fldvue
;

754 
$funime
 = 
	`r_a
("{\"","[\"",$functionname);

755 
$funime
 = 
	`r_a
("\"}","\"]",$functionname);

756 
$funime
 = 
	`egi_a
("'@me'|\"@me\"|@me",'$DedeFieldValue',$functionname);

757 
$funime
 = "\$DedeFieldValue = ".$functionname;

758 @
	`ev
(
$funime
.";");

759 if(
	`emy
(
$DedeFldVue
))

765  
$DedeFldVue
;

767 
	}
}

770 
funi
 
	$GGlobs
(
$vme
)

772 
$vme
 = 
	`im
($varname);

775 if(
$vme
=="dbuserpwd"||$varname=="cfg_dbpwd")

781 if(
	`ist
(
$GLOBALS
[
$vme
]))

783  
$GLOBALS
[
$vme
];

789 
	}
}

792 
funi
 
InudeFe
(
$fame
,
$ismake
='no')

794 
glob
 
$cfg_df_y
;

795 
	g$r
 = '';

796 if(
	g$fame
=='')

800 if
fe_exis
(
DEDEROOT
."/ms/".
$fame
) )

802 
	g$okfe
 = 
DEDEROOT
."/ms/".
$fame
;

804 if(
fe_exis
(
DEDEROOT
.'/ms/'.
$cfg_df_y
.'/'.
$fame
) )

806 
	g$okfe
 = 
DEDEROOT
.'/ms/'.
$cfg_df_y
.'/'.
$fame
;

814 if(
	g$ismake
!="no")

816 
que_
(
DEDEINC
."/channelunit.func.php");

817 
	g$d
 = 
w
 
DedeTagP
();

818 
	g$d
->
LdTem
(
$okfe
);

819 
MakeOTag
(
$d
,
$this
->
fObj
);

820 
	g$r
 = 
$d
->
GResu
();

824 
	g$
 = @
fݒ
(
$okfe
,"r");

825 
	g$le
=
fgs
(
$
,1024)
	g$r
.=
$le
;

826 
fo
(
$
);

828  
	g$r
;

837 as
	cDedeAribu


839 
v
 
	m$Cou
 = -1;

840 
v
 
	m$Ims
 = "";

842 
funi
 
	$GA
(
$r
)

844 if(
$r
=="")

848 if(
	`ist
(
$this
->
Ims
[
$r
]))

850  
$this
->
Ims
[
$r
];

859 
funi
 
	$GAribu
(
$r
)

861  
$this
->
	`GA
(
$r
);

862 
	}
}

865 
funi
 
	$IsAribu
(
$r
)

867 if(
	`ist
(
$this
->
Ims
[
$r
]) 
ue
;

868  
l
;

869 
	}
}

872 
funi
 
	$GTagName
()

874  
$this
->
	`GA
("tagname");

875 
	}
}

878 
funi
 
	$GCou
()

880  
$this
->
Cou
+1;

881 
	}
}

888 as
	cDedeAribuP


890 
v
 
	m$sourSg
 = "";

891 
v
 
	m$sourMaxSize
 = 1024;

892 
v
 
	m$cAribus
 = "";

893 
v
 
	m$chToLow
 = 
ue
;

894 
funi
 
SSour
(
$r
='')

896 
$this
->
cAribus
 = 
w
 
DedeAribu
();

897 
	m$rL
 = 0;

898 
	m$this
->
	msourSg
 = 
im
(
eg_a
("/[ \r\n\t]{1,}/"," ",
$r
));

901 
	m$this
->
	msourSg
 = 
r_a
('\]',']',
$this
->
sourSg
);

902 
	m$this
->
	msourSg
 = 
r_a
('[','[',
$this
->
sourSg
);

910 
	m$rL
 = 

(
$this
->
sourSg
);

911 if(
	m$rL
>0 && $rL <
$this
->
sourMaxSize
)

913 
$this
->
PAribu
();

918 
funi
 
	$PAribu
()

920 
$d
 = '';

921 
$tm
 = '';

922 
$tmpvue
 = '';

923 
$tdd
 = -1;

924 
$ddg
 = '';

925 
$hasAribu
=
l
;

926 
$rL
 = 
	`
(
$this
->
sourSg
);

929 
$i
=0; $i<
$rL
; $i++)

931 if(
$this
->
sourSg
[
$i
]==' ')

933 
$this
->
cAribus
->
Cou
++;

934 
$tmpvues
 = 
	`exode
('.', 
$tmpvue
);

935 
$this
->
cAribus
->
Ims
['gme'] = ($this->
chToLow
 ? 
	`ow
(
$tmpvues
[0]) : $tmpvalues[0]);

936 if(
	`ist
(
$tmpvues
[1]) && $tmpvalues[1]!='')

938 
$this
->
cAribus
->
Ims
['me'] = 
$tmpvues
[1];

940 
$tmpvue
 = '';

941 
$hasAribu
 = 
ue
;

946 
$tmpvue
 .
$this
->
sourSg
[
$i
];

951 if(!
$hasAribu
)

953 
$this
->
cAribus
->
Cou
++;

954 
$tmpvues
 = 
	`exode
('.', 
$tmpvue
);

955 
$this
->
cAribus
->
Ims
['gme'] = ($this->
chToLow
 ? 
	`ow
(
$tmpvues
[0]) : $tmpvalues[0]);

956 if(
	`ist
(
$tmpvues
[1]) && $tmpvalues[1]!='')

958 
$this
->
cAribus
->
Ims
['me'] = 
$tmpvues
[1];

962 
$tmpvue
 = '';

965 
$i
; $i<
$rL
; $i++)

967 
$d
 = 
$this
->
sourSg
[
$i
];

969 if(
$tdd
==-1)

971 if(
$d
 != '=')

973 
$tm
 .
$d
;

977 if(
$this
->
chToLow
)

979 
$tm
 = 
	`ow
(
	`im
($tmpatt));

983 
$tm
 = 
	`im
($tmpatt);

985 
$tdd
=0;

990 if(
$tdd
==0)

992 
$d
)

997 
$ddg
 = '"';

998 
$tdd
 = 1;

1001 
$ddg
 = '\'';

1002 
$tdd
 = 1;

1005 
$tmpvue
 .
$d
;

1006 
$ddg
 = ' ';

1007 
$tdd
 = 1;

1011 if(
$tdd
==1)

1013 if(
$d
==
$ddg
 && ( 
	`ist
(
$this
->
sourSg
[
$i
-1]) && $this->sourceString[$i-1]!="\\") )

1015 
$this
->
cAribus
->
Cou
++;

1016 
$this
->
cAribus
->
Ims
[
$tm
] = 
	`im
(
$tmpvue
);

1017 
$tm
 = '';

1018 
$tmpvue
 = '';

1019 
$tdd
 = -1;

1023 
$tmpvue
 .
$d
;

1029 if(
$tm
 != '')

1031 
$this
->
cAribus
->
Cou
++;

1032 
$this
->
cAribus
->
Ims
[
$tm
] = 
	`im
(
$tmpvue
);

1035 
	}
}

	@include/dedetemplate.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

9 
funi
 
MakePublicTag
(
$ts
=
y
(),
$fObj
='',
$flds
=
	$y
())

20 
$ts
['gme'] = 
	`eg_a
("[0-9]{1,}$","",$atts['tagname']);

21 
$usfe
 = 
DEDEINC
.'/ib/us_'.
$ts
['tagname'].'.php';

22 if(!
	`fe_exis
(
$usfe
))

24 if(
	`ist
(
$ts
['rstype']) && $atts['rstype']=='string')

30  
	`y
();

35 
	`ude_
(
$usfe
);

36 
$func
 = 'us_'.
$ts
['tagname'];

37  
	`$func
(
$ts
,
$fObj
,
$flds
);

39 
	}
}

42 
funi
 
	$FlAs
(&
$ts
,
$i
)

44 
$is
 = 
	`exode
(',',
$i
);

45 
	`fܗch
(
$is
 
as
 
$t
)

47 
	`li
(
$k
,
$v
)=
	`exode
('=',
$t
);

48 if(!
	`ist
(
$ts
[
$k
]))

50 
$ts
[
$k
] = 
$v
;

53 
	}
}

56 
funi
 
	$FlFlds
(&
$ts
,&
$fObj
,&
$flds
)

58 
glob
 
$_vs
;

59 
	`fܗch
(
$ts
 
as
 
$k
=>
$v
)

61 if(
	`egi
('^fld\.',
$v
))

63 
$key
 = 
	`egi_a
('^fld\.','',
$v
);

64 if
	`ist
(
$flds
[
$key
]) )

66 
$ts
[
$k
] = 
$flds
[
$key
];

69 if(
	`egi
('^v\.',
$v
))

71 
$key
 = 
	`egi_a
('^v\.','',
$v
);

72 if
	`ist
(
$_vs
[
$key
]) )

74 
$ts
[
$k
] = 
$_vs
[
$key
];

77 if(
	`egi
('^glob\.',
$v
))

79 
$key
 = 
	`egi_a
('^glob\.','',
$v
);

80 if
	`ist
(
$GLOBALS
[
$key
]) )

82 
$ts
[
$k
] = 
$GLOBALS
[
$key
];

86 
	}
}

92 as
	cTag


94 
v
 
	m$isComp
=
l
;

95 
v
 
	m$gName
="";

96 
v
 
	m$rText
="";

97 
v
 
	m$tPos
=0;

98 
v
 
	m$dPos
=0;

99 
v
 
	m$cA
="";

100 
v
 
	m$gVue
="";

101 
v
 
	m$gID
 = 0;

104 
funi
 
	$GName
()

106  
	`ow
(
$this
->
gName
);

109 
funi
 
	$GVue
()

111  
$this
->
gVue
;

112 
	}
}

114 
funi
 
	$IsA
(
$r
)

116  
$this
->
cA
->
	`IsAribu
(
$r
);

117 
	}
}

119 
funi
 
	$GA
(
$r
)

121  
$this
->
cA
->
	`GA
(
$r
);

122 
	}
}

124 
funi
 
	$GrText
()

126  
$this
->
rText
;

127 
	}
}

134 as
	cDedeTeme


136 
v
 
	m$gMaxL
 = 64;

137 
v
 
	m$chToLow
 = 
ue
;

138 
v
 
	m$isCache
 = 
ue
;

139 
v
 
	m$isP
 = 
l
;

140 
v
 
	m$isComp
 = 
ue
;

141 
v
 
	m$meD
 = '';

142 
v
 
	m$mpMkTime
 = 0;

143 
v
 
	m$cheFe
 = '';

144 
v
 
	m$cfigFe
 = '';

145 
v
 
	m$budFe
 = '';

146 
v
 
	m$fD
 = '';

147 
v
 
	m$cheD
 = '';

148 
v
 
	m$meFe
 = '';

149 
v
 
	m$sourSg
 = '';

150 
v
 
	m$cTags
 = '';

153 
v
 
	m$cou
 = -1;

154 
v
 
	m$loNum
 = 0;

155 
v
 
	m$fObj
 = '';

156 
v
 
	m$makeLo
 = 0;

157 
v
 
	m$gSWd
 = '{dede:';

158 
v
 
	m$fuTagEndWd
 = '{/dede:';

159 
v
 
	m$sTagEndWd
 = '/}';

160 
v
 
	m$gEndWd
 = '}';

161 
v
 
	m$Cfgs
 = 
y
();

164 
funi
 
__cڡru
(
$med
='',
$fD
='')

168 if(
$med
=='')

170 
$this
->
meD
 = 
DEDEROOT
.'/templates';

174 
	m$this
->
	mmeD
 = 
$med
;

178 if(
	m$fD
=='')

180 if(
ist
(
$GLOBALS
['cfg_df_style']))

182 
$this
->
fD
 = $this->
meD
.'/'.
$GLOBALS
['cfg_df_style'].'/';

186 
	m$this
->
	mfD
 = 
$this
->
meD
;

189 
	m$this
->
	mcheD
 = 
DEDEROOT
.
$GLOBALS
['cfg_tplcache_dir'];

192 
funi
 
DedeTeme
(
$med
='',
$fD
='')

194 
$this
->
__cڡru
(
$med
,
$fD
);

198 
funi
 
	$SObje
(&
$fObj
)

200 
$this
->
fObj
 = 
$fObj
;

201 
	}
}

204 
funi
 
	$SV
(
$k
,
$v
)

206 
$GLOBALS
['_vs'][
$k
] = 
$v
;

207 
	}
}

209 
funi
 
	$Assign
(
$k
,
$v
)

211 
$GLOBALS
['_vs'][
$k
] = 
$v
;

212 
	}
}

215 
funi
 
STagSty
(
$ts
='{dede:',
$d
='{/dede:',
$d
='/}',
$nd
='}')

217 
$this
->
gSWd
 = 
$ts
;

218 
	g$this
->
	gfuTagEndWd
 = 
$d
;

219 
	g$this
->
	gsTagEndWd
 = 
$d
;

220 
	g$this
->
	ggEndWd
 = 
$nd
;

224 
funi
 
	$GCfig
(
$k
)

226  (
	`ist
(
$this
->
Cfgs
[
$k
]) ? $this->tpCfgs[$k] : '');

227 
	}
}

230 
funi
 
	$LdTeme
(
$tmpfe
)

232 if(!
	`fe_exis
(
$tmpfe
))

234 
echo
 " Template Not Found! ";

235 
	`ex
();

237 
$tmpfe
 = 
	`eg_a
("[\\/]{1,}","/",$tmpfile);

238 
$tmpfes
 = 
	`exode
('/',
$tmpfe
);

239 
$tmpfeOyName
 = 
	`eg_a
("(.*)/","",
$tmpfe
);

240 
$this
->
meFe
 = 
$tmpfe
;

241 
$this
->
fD
 = '';

242 
$i
=0; $< 
	`cou
(
$tmpfes
)-1; $i++)

244 
$this
->
fD
 .
$tmpfes
[
$i
].'/';

246 if(!
	`is_d
(
$this
->
cheD
))

248 
$this
->
cheD
 = $this->
fD
;

250 if(
$this
->
cheD
!='')

252 
$this
->
cheD
 = $this->cacheDir.'/';

254 if(
	`ist
(
$GLOBALS
['_DEBUG_CACHE']))

256 
$this
->
cheD
 = $this->
fD
;

258 
$this
->
cheFe
 = $this->
cheD
.
	`eg_a
("\.(wml|html|htm|php)$","_".$this->
	`GEncodeS
(
$tmpfe
).'.c',
$tmpfeOyName
);

259 
$this
->
cfigFe
 = $this->
cheD
.
	`eg_a
("\.(wml|html|htm|php)$","_".$this->
	`GEncodeS
(
$tmpfe
).'_cfig.c',
$tmpfeOyName
);

262 if(
$this
->
isCache
==
l
 || !
	`fe_exis
($this->
cheFe
)

263 || 
	`femtime
(
$this
->
meFe
> femtime($this->
cheFe
))

265 
$t1
 = 
	`ExecTime
();

266 
$
 = 
	`fݒ
(
$this
->
meFe
,'r');

267 
$this
->
sourSg
 = 
	`d
(
$
,
	`fesize
($this->
meFe
));

268 
	`fo
(
$
);

269 
$this
->
	`PTeme
();

277 if(
	`fe_exis
(
$this
->
cfigFe
))

279 
	`ude
(
$this
->
cfigFe
);

282 
	}
}

285 
funi
 
LdSg
(
$r
='')

287 
$this
->
sourSg
 = 
$r
;

288 
	g$hashcode
 = 
md5
(
$this
->
sourSg
);

289 
	g$this
->
	gcheFe
 = 
$this
->
cheD
."/rg_".
$hashcode
.".inc";

290 
	g$this
->
	gcfigFe
 = 
$this
->
cheD
."/rg_".
$hashcode
."_config.inc";

291 
	g$this
->
PTeme
();

295 
funi
 
	$CacheFe
()

297 
glob
 
$gtmpfe
;

298 
$this
->
	`WreCache
();

299  
$this
->
cheFe
;

300 
	}
}

304 
funi
 
	$Diy
()

306 
glob
 
$gtmpfe
;

307 
	`exa
(
$GLOBALS
, 
EXTR_SKIP
);

308 
$this
->
	`WreCache
();

309 
ude
 
$this
->
cheFe
;

310 
	}
}

313 
funi
 
	$SaveTo
(
$vefe
)

315 
	`exa
(
$GLOBALS
, 
EXTR_SKIP
);

316 
$this
->
	`WreCache
();

317 
	`ob_t
();

318 
ude
 
$this
->
cheFe
;

319 
$okr
 = 
	`ob_g_cڋs
();

320 
	`ob_d_n
();

321 
$
 = @
	`fݒ
(
$vefe
,"w"

 
	`d
(" Tag Engine Create File false! ");

322 
	`fwre
(
$
,
$okr
);

323 
	`fo
(
$
);

324 
	}
}

327 
funi
 
WreCache
(
$y
='all')

329 if(!
fe_exis
(
$this
->
cheFe
|| $this->
isCache
==
l


330 || ( 
fe_exis
(
$this
->
meFe
&& (
femtime
($this->meFe> femtime($this->
cheFe
)) ) )

332 if(!
$this
->
isP
)

334 
$this
->
PTeme
();

336 
	g$
 = 
fݒ
(
$this
->
cheFe
,'w'

 
d
("Write Cache File Error! ");

337 
ock
(
$
,3);

338 
fwre
(
$
,
im
(
$this
->
GResu
()));

339 
fo
(
$
);

340 if(
cou
(
$this
->
Cfgs
) > 0)

342 
	g$
 = 
fݒ
(
$this
->
cfigFe
,'w'

 
d
("Write Config File Error! ");

343 
ock
(
$
,3);

344 
fwre
(
$
,'<'.'?php'."\r\n");

345 
fܗch
(
$this
->
Cfgs
 
as
 
$k
=>
$v
)

347 
$v
 = 
r_a
("\"","\\\"",$v);

348 
	g$v
 = 
r_a
("\$","\\\$",
$v
);

349 
fwre
(
$
,"\$this->tpCfgs['$k']=\"$v\";\r\n");

351 
fwre
(
$
,'?'.'>');

352 
fo
(
$
);

410 
funi
 
	$GEncodeS
(
$tmpfe
)

413 
$codeS
 = 
	`subr
(
	`md5
(
$tmpfe
),0,24);

414  
$codeS
;

415 
	}
}

418 
funi
 
	$PTeme
()

420 if(
$this
->
makeLo
 > 5)

424 
$this
->
cou
 = -1;

425 
$this
->
cTags
 = 
	`y
();

426 
$this
->
isP
 = 
ue
;

427 
$sPos
 = 0;

428 
$ePos
 = 0;

429 
$gSWd
 = 
$this
->
gSWd
;

430 
$fuTagEndWd
 = 
$this
->
fuTagEndWd
;

431 
$sTagEndWd
 = 
$this
->
sTagEndWd
;

432 
$gEndWd
 = 
$this
->
gEndWd
;

433 
$tWdL
 = 
	`
(
$gSWd
);

434 
$sourL
 = 
	`
(
$this
->
sourSg
);

435 if
$sourL
 <(
$tWdL
 + 3) )

439 
$cA
 = 
w
 
	`TagAribuP
();

440 
$cA
->
ChToLow
 = 
ue
;

443 
$t
 = 0;

444 
$eTag
 = '';

445 
$tswL
 = 
	`
(
$gSWd
);

446 
$i
=0; $i<
$sourL
; $i++)

448 
$agName
 = '';

451 if(
$i
-1>=0)

453 
$ss
 = 
$i
-1;

457 
$ss
 = 0;

459 
$gPos
 = 
	`os
(
$this
->
sourSg
,
$gSWd
,
$ss
);

462 if(
$gPos
==0 && (
$sourL
-
$i
 < 
$tswL


463 || 
	`subr
(
$this
->
sourSg
,
$i
,
$tswL
)!=
$gSWd
 ))

465 
$gPos
 = -1;

470 
$j
 = 
$gPos
+
$tWdL
; $j < $gPos+$tWdL+
$this
->
gMaxL
; $j++)

472 if(
	`eg
("[ >/\r\n\t\}\.]",
$this
->
sourSg
[
$j
]))

478 
$agName
 .
$this
->
sourSg
[
$j
];

481 if(
$agName
!='')

483 
$i
 = 
$gPos
 + 
$tWdL
;

484 
$dPos
 = -1;

487 
$fuTagEndWdThis
 = 
$fuTagEndWd
.
$agName
.
$gEndWd
;

488 
$e1
 = 
	`os
(
$this
->
sourSg
,
$sTagEndWd
, 
$i
);

489 
$e2
 = 
	`os
(
$this
->
sourSg
,
$gSWd
, 
$i
);

490 
$e3
 = 
	`os
(
$this
->
sourSg
,
$fuTagEndWdThis
,
$i
);

491 
$e1
 = 
	`im
($e1); 
$e2
 =rim($e2); 
$e3
 =rim($e3);

492 
$e1
 = ($e1=='' ? '-1' : $e1);

493 
$e2
 = ($e2=='' ? '-1' : $e2);

494 
$e3
 = ($e3=='' ? '-1' : $e3);

495 if(
$e3
==-1)

498 
$dPos
 = 
$e1
;

499 
$
 = 
$dPos
 + 
	`
(
$sTagEndWd
);

501 if(
$e1
==-1)

504 
$dPos
 = 
$e3
;

505 
$
 = 
$dPos
 + 
	`
(
$fuTagEndWdThis
);

512 if(
$e1
 < 
$e2
 && $e1 < 
$e3
 )

514 
$dPos
 = 
$e1
;

515 
$
 = 
$dPos
 + 
	`
(
$sTagEndWd
);

519 
$dPos
 = 
$e3
;

520 
$
 = 
$dPos
 + 
	`
(
$fuTagEndWdThis
);

525 if(
$dPos
==-1)

527 
echo
 "Characterostion $tagPos, '$ttagName' Error！<br />\r\n";

530 
$i
 = 
$
;

533 
$tS
 = '';

534 
$rText
 = '';

535 
$tI
 = 0;

536 
$j
 = 
$gPos
+
$tWdL
; $j < 
$dPos
; $j++)

538 if(
$tI
==0)

540 if(
$this
->
sourSg
[
$j
]==
$gEndWd
)

542 
$tI
=1; ;

546 
$tS
 .
$this
->
sourSg
[
$j
];

551 
$rText
 .
$this
->
sourSg
[
$j
];

554 
$agName
 = 
	`ow
($ttagName);

557 if(
	`eg
("^if[0-9]{0,}$",
$agName
))

559 
$cA
->
cAribus
 = 
w
 
	`TagAribu
();

560 
$cA
->
cAribus
->
cou
 = 2;

561 
$cA
->
cAribus
->
ems
['gme'] = 
$agName
;

562 
$cA
->
cAribus
->
ems
['cdi'] = 
	`eg_a
("^if[0-9]{0,}[\r\n\]","",
$tS
);

563 
$rText
 = 
	`egi_a
("\{else\}",'<'."?php\r\n}\r\nelse{\r\n".'?'.'>',$innerText);

565 if(
$agName
=='php')

567 
$cA
->
cAribus
 = 
w
 
	`TagAribu
();

568 
$cA
->
cAribus
->
cou
 = 2;

569 
$cA
->
cAribus
->
ems
['gme'] = 
$agName
;

570 
$cA
->
cAribus
->
ems
['code'] = '<'."?php\r\n".
	`im
(
	`eg_a
("^php[0-9]{0,}[\r\n\]","",
$tS
))."\r\n?".'>';

575 
$cA
->
	`SSour
(
$tS
);

577 
$this
->
cou
++;

578 
$cTag
 = 
w
 
	`Tag
();

579 
$cTag
->
gName
 = 
$agName
;

580 
$cTag
->
tPos
 = 
$gPos
;

581 
$cTag
->
dPos
 = 
$i
;

582 
$cTag
->
cA
 = 
$cA
->
cAribus
;

583 
$cTag
->
isComp
 = 
l
;

584 
$cTag
->
gID
 = 
$this
->
cou
;

585 
$cTag
->
rText
 = 
$rText
;

586 
$this
->
cTags
[$this->
cou
] = 
$cTag
;

590 
$i
 = 
$gPos
+
$tWdL
;

594 if
$this
->
cou
 > -1 && $this->
isComp
 )

596 
$this
->
	`CompA
();

598 
	}
}

602 
funi
 
	$CompA
()

604 
$this
->
loNum
++;

605 if(
$this
->
loNum
 > 10)

609 
$ResuSg
 = '';

610 
$xtTagEnd
 = 0;

611 
$i
=0; 
	`ist
(
$this
->
cTags
[$i]); $i++)

613 
$ResuSg
 .
	`subr
(
$this
->
sourSg
, 
$xtTagEnd
, $this->
cTags
[
$i
]->
tPos
 - $nextTagEnd);

614 
$ResuSg
 .
$this
->
	`CompOTag
($this->
cTags
[
$i
]);

615 
$xtTagEnd
 = 
$this
->
cTags
[
$i
]->
dPos
;

617 
$
 = 
	`
(
$this
->
sourSg
);

618 if(
$
 > 
$xtTagEnd
)

620 
$ResuSg
 .
	`subr
(
$this
->
sourSg
,
$xtTagEnd
,
$
-$nextTagEnd);

622 
$this
->
sourSg
 = 
$ResuSg
;

623 
$this
->
	`PTeme
();

624 
	}
}

628 
funi
 
	$GResu
()

630 if(!
$this
->
isP
)

632 
$this
->
	`PTeme
();

634 
$addt
 = '';

635 
$addt
 .= '<'.'?php'."\r\n".'if(!isset($GLOBALS[\'_vars\'])) $GLOBALS[\'_vars\'] =rray(); '."\r\n".'$fields =rray();'."\r\n".'?'.'>';

636  
	`eg_a
("\?".">[ \r\n\t]{0,}<"."\?php","",
$addt
.
$this
->
sourSg
);

637 
	}
}

640 
funi
 
	$CompOTag
(&
$cTag
)

642 
$cTag
->
isComp
 = 
ue
;

643 
$gme
 = 
$cTag
->
gName
;

644 
$vme
 = 
$cTag
->
	`GA
('name');

645 
$rsvue
 = "";

649 if
$gme
 == 'config' )

651 
$this
->
Cfgs
[
$vme
] = 
$cTag
->
	`GA
('value');

653 if
$gme
 == 'global' )

655 
$cTag
->
gVue
 = 
$this
->
	`CompAayV
('glob',
$vme
);

656 if
$cTag
->
	`GA
('function') != '' )

658 
$cTag
->
gVue
 = 
$this
->
	`CompFuni
($cTag->
	`GA
('function'), $cTag->tagValue);

660 
$cTag
->
gVue
 = '<'.'?phpcho '.$cTag->tagValue.'; ?'.'>';

662 if
$gme
 == 'cfg' )

664 
$cTag
->
gVue
 = '$GLOBALS[\'cfg_'.
$vme
.'\']';

665 if
$cTag
->
	`GA
('function')!='' )

667 
$cTag
->
gVue
 = 
$this
->
	`CompFuni
($cTag->
	`GA
('function'), $cTag->tagValue);

669 
$cTag
->
gVue
 = '<'.'?phpcho '.$cTag->tagValue.'; ?'.'>';

671 if
$gme
 == 'object' )

673 
	`li
(
$_obs
,
$_em

	`exode
('->',
$vme
);

674 
$cTag
->
gVue
 = "\$GLOBALS['{$_obs}']->{$_em}";

675 if
$cTag
->
	`GA
('function')!='' )

677 
$cTag
->
gVue
 = 
$this
->
	`CompFuni
($cTag->
	`GA
('function'), $cTag->tagValue);

679 
$cTag
->
gVue
 = '<'.'?phpcho '.$cTag->tagValue.'; ?'.'>';

681 if(
$gme
 == 'var')

683 
$cTag
->
gVue
 = 
$this
->
	`CompAayV
('v', 
$vme
);

685 if
$cTag
->
	`GA
('function')!='' )

687 
$cTag
->
gVue
 = 
$this
->
	`CompFuni
($cTag->
	`GA
('function'), $cTag->tagValue);

689 
$cTag
->
gVue
 = '<'.'?phpcho '.$cTag->tagValue.'; ?'.'>';

691 if(
$gme
 == 'field')

693 
$cTag
->
gVue
 = '$flds[\''.
$vme
.'\']';

694 if
$cTag
->
	`GA
('function')!='' )

696 
$cTag
->
gVue
 = 
$this
->
	`CompFuni
($cTag->
	`GA
('function'), $cTag->tagValue);

698 
$cTag
->
gVue
 = '<'.'?phpcho '.$cTag->tagValue.'; ?'.'>';

700 if
	`eg
("^key[0-9]{0,}",
$gme
) ||reg("^value[0-9]{0,}",$tagname))

702 if
	`eg
("^vue[0-9]{0,}",
$gme
&& 
$vme
!='' )

704 
$cTag
->
gVue
 = '<'.'?phech'.
$this
->
	`CompAayV
(
$gme
,
$vme
).'; ?'.'>';

708 
$cTag
->
gVue
 = '<'.'?phech$'.
$gme
.'; ?'.'>';

711 if
	`eg
("^if[0-9]{0,}$",
$gme
) )

713 
$cTag
->
gVue
 = 
$this
->
	`CompIf
($cTag);

715 if
$gme
=='php' )

717 if(
	`im
(
$cTag
->
	`GIText
())==''$cTag->
gVue
 = $cTag->
	`GA
('code');

720 
$cTag
->
gVue
 = '<'."?php\r\n".
	`im
($cTag->
	`GIText
())."\r\n?".'>';

725 if
	`eg
("^y[0-9]{0,}",
$gme
) )

727 
$kk
 = '$key';

728 
$vv
 = '$value';

729 if(
$cTag
->
	`GA
('key')!='')

731 
$kk
 = '$key'.
$cTag
->
	`GA
('key');

733 if(
$cTag
->
	`GA
('value')!='')

735 
$vv
 = '$vue'.
$cTag
->
	`GA
('value');

737 
$addv
 = '';

738 if(!
	`eg
("\(",
$vme
))

740 
$vme
 = '$GLOBALS[\''.$varname.'\']';

744 
$addv
 = "\r\n".'$myr$geCss->'.
$vme
.";\r\n";

745 
$vme
 = ' $myarrs ';

747 
$rsvue
 = '<'.'?ph'.
$addv
.' fܗch('.
$vme
.''.
$kk
.'=>'.
$vv
.'){ ?'.">";

748 
$rsvue
 .
$cTag
->
	`GIText
();

749 
$rsvue
 .= '<'.'?php } ?'.">\r\n";

750 
$cTag
->
gVue
 = 
$rsvue
;

754 if(
$gme
 == 'include')

756 
$fame
 = 
$cTag
->
	`GA
('file');

757 if(
$fame
=='')

759 
$fame
 = 
$cTag
->
	`GA
('filename');

761 
$cTag
->
gVue
 = 
$this
->
	`CompInude
(
$fame
, 
l
);

762 if(
$cTag
->
gVue
==0) $cTag->tagValue = '';

763 
$cTag
->
gVue
 = '<'.'?phud$this->CompInude("'.
$fame
.'");'."\r\n".' ?'.'>';

765 if
$gme
=='label' )

767 
$bdFunc
 = 
$cTag
->
	`GA
('bind');

768 
$rsvue
 = 'ech'.
$bdFunc
.";\r\n";

769 
$rsvue
 = '<'.'?php '.$rsvalue.' ?'.">\r\n";

770 
$cTag
->
gVue
 = 
$rsvue
;

772 if
$gme
=='datalist' )

775 
	`fܗch
(
$cTag
->
cA
->
ems
 
as
 
$k
=>
$v
)

777 
$v
 = 
$this
->
	`TrimAs
($v);

778 
$rsvue
 .'$ts[\''.
$k
.'\'] = \''.
	`r_a
("'","\\'",
$v
)."';\r\n";

780 
$rsvue
 = '<'.'?php'."\r\n".'$atts =rray();'."\r\n".$rsvalue;

781 
$rsvue
 .= '$blockValue = $this->refObj->GetArcList($atts,$this->refObj,$fields); '."\r\n";

782 
$rsvue
 .= 'foreach( $blockValues $key=>$fields )'."\r\n{\r\n".'?'.">";

783 
$rsvue
 .
$cTag
->
	`GIText
();

784 
$rsvue
 .= '<'.'?php'."\r\n}\r\n".'?'.'>';

785 
$cTag
->
gVue
 = 
$rsvue
;

787 if
$gme
=='pagelist' )

790 
	`fܗch
(
$cTag
->
cA
->
ems
 
as
 
$k
=>
$v
)

792 
$v
 = 
$this
->
	`TrimAs
($v);

793 
$rsvue
 .'$ts[\''.
$k
.'\'] = \''.
	`r_a
("'","\\'",
$v
)."';\r\n";

795 
$rsvue
 = '<'.'?php'."\r\n".'$atts =rray();'."\r\n".$rsvalue;

796 
$rsvue
 .= 'cho $this->refObj->GetPageList($atts,$this->refObj,$fields); '."\r\n".'?'.">\r\n";

797 
$cTag
->
gVue
 = 
$rsvue
;

801 
$bdFunc
 = 
$cTag
->
	`GA
('bind');

802 
$bdTy
 = 
$cTag
->
	`GA
('bindtype');

803 
$ry
 = (
$cTag
->
	`GA
('resulttype')=='' ? $cTag->GetAtt('rstype') : $cTag->GetAtt('resulttype') );

804 
$ry
 = 
	`ow
($rstype);

807 
	`fܗch
(
$cTag
->
cA
->
ems
 
as
 
$k
=>
$v
)

809 if(
	`egi
("(bd|bdty)",
$k
))

813 
$v
 = 
$this
->
	`TrimAs
($v);

814 
$rsvue
 .'$ts[\''.
$k
.'\'] = \''.
	`r_a
("'","\\'",
$v
)."';\r\n";

816 
$rsvue
 = '<'.'?php'."\r\n".'$atts =rray();'."\r\n".$rsvalue;

819 if(
$bdFunc
=='')

821 
$rsvue
 .= '$blockValue = MakePublicTag($atts,$this->refObj,$fields); '."\r\n";

826 if(
$bdTy
==''
$rsvue
 .'$blockVu$this->fObj->'.
$bdFunc
.'($atts,$this->refObj,$fields); '."\r\n";

827 
$rsvue
 .'$blockVu'.
$bdFunc
.'($atts,$this->refObj,$fields); '."\r\n";

831 if(
$ry
=='string')

833 
$rsvue
 .= 'echo $blockValue;'."\r\n".'?'.">";

837 
$rsvue
 .= 'if(is_array($blockValue) && count($blockValue) > 0){'."\r\n";

838 
$rsvue
 .= 'foreach( $blockValues $key=>$fields )'."\r\n{\r\n".'?'.">";

839 
$rsvue
 .
$cTag
->
	`GIText
();

840 
$rsvue
 .= '<'.'?php'."\r\n}\r\n}\r\n".'?'.'>';

842 
$cTag
->
gVue
 = 
$rsvue
;

844  
$cTag
->
gVue
;

845 
	}
}

849 
funi
 
	$CompAayV
(
$vty
,
$vme
)

851 
$okvue
 = '';

853 if(!
	`eg
("\[",
$vme
))

855 if(
	`eg
("^vue",
$vty
))

857 
$vme
 = 
$vty
.'.'.$varname;

859 
$vmes
 = 
	`exode
('.',
$vme
);

860 if(
	`ist
(
$vmes
[1]))

862 
$vme
 = 
$vmes
[0];

863 
$i
=1; 
	`ist
(
$vmes
[$i]); $i++)

865 
$vme
 ."['".
$vmes
[
$i
]."']";

870 if(
	`eg
("\[",
$vme
))

872 
$vmes
 = 
	`exode
('[',
$vme
);

873 
$nd
 = '';

874 
$i
=1;
	`ist
(
$vmes
[$i]);$i++)

876 
$nd
 .'['.
$vmes
[
$i
];

878 if(!
	`eg
("[\"']", 
$nd
)) {

879 
$nd
 = 
	`r_a
('[', '', $arrend);

880 
$nd
 = 
	`r_a
(']', '', $arrend);

881 
$nd
 = "['{$arrend}']";

883 if(
$vty
=='var')

885 
$okvue
 = '$GLOBALS[\'_vs\'][\''.
$vmes
[0].'\']'.
$nd
;

887 if
	`eg
("^vue",
$vty
) )

889 
$okvue
 = '$'.
$vmes
[0].
$nd
;

891 if(
$vty
=='field')

893 
$okvue
 = '$flds[\''.
$vmes
[0].'\']'.
$nd
;

897 
$okvue
 = '$GLOBALS[\''.
$vmes
[0].'\']'.
$nd
;

902 if(
$vty
=='var')

904 
$okvue
 = '$GLOBALS[\'_vs\'][\''.
$vme
.'\']';

906 if
	`eg
("^vue",
$vty
) )

908 
$okvue
 = '$'.
$vty
;

910 if(
$vty
=='field')

912 
$okvue
 = '$'.
	`r_a
(
$vme
);

916 
$okvue
 = '$GLOBALS[\''.
$vme
.'\']';

919  
$okvue
;

920 
	}
}

923 
funi
 
	$CompIf
(
$cTag
)

925 
$cdi
 = 
	`im
(
$cTag
->
	`GA
('condition'));

926 if(
$cdi
 =='')

928 
$cTag
->
gVue
='';  '';

930 
$cdi
 = 
	`eg_a
("/((var\.|field\.|cfg\.|global\.|key[0-9]{0,}\.|value[0-9]{0,}\.)[\._a-z0-9]+)/ies", "private_rt('\\1')", $condition);

931 
$rsvue
 = '<'.'?phif('.
$cdi
.'){ ?'.'>';

932 
$rsvue
 .
$cTag
->
	`GIText
();

933 
$rsvue
 .= '<'.'?php } ?'.'>';

934  
$rsvue
;

935 
	}
}

938 
funi
 
	$TrimAs
(
$v
)

940 
$v
 = 
	`r_a
('<'.'?','&lt;?',$v);

941 
$v
 = 
	`r_a
('?'.'>','?&gt;',$v);

942  
$v
;

943 
	}
}

946 
funi
 
	$CompFuni
(
$funcr
,
$nvue
)

948 
$funcr
 = 
	`r_a
('@quote','"',$funcstr);

949 
$funcr
 = 
	`r_a
('@me',
$nvue
,$funcstr);

950  
$funcr
;

951 
	}
}

954 
funi
 
	$CompInude
(
$fame
, 
$id
=
ue
)

956 
$okfe
 = '';

957 if@
	`fe_exis
(
$fame
) )

959 
$okfe
 = 
$fame
;

961 if@
	`fe_exis
(
$this
->
fD
.
$fame
) )

963 
$okfe
 = 
$this
->
fD
.
$fame
;

965 if@
	`fe_exis
(
$this
->
fD
."../".
$fame
) )

967 
$okfe
 = 
$this
->
fD
."../".
$fame
;

969 if(
$okfe
=='')  0;

970 if!
$id
 )  1;

971 
$
 = 
w
 
	`DedeTeme
(
$this
->
meD
);

972 
$
->
isCache
 = 
$this
->isCache;

973 
$
->
	`SObje
(
$this
->
fObj
);

974 
$
->
	`LdTeme
(
$okfe
);

975  
$
->
	`CacheFe
();

976 
	}
}

984 as
	cTagAribu


986 
v
 
	m$cou
 = -1;

987 
v
 
	m$ems
 = "";

990 
funi
 
	$GA
(
$r
)

992 if(
$r
=="")

996 if(
	`ist
(
$this
->
ems
[
$r
]))

998  
$this
->
ems
[
$r
];

1007 
funi
 
	$GAribu
(
$r
)

1009  
$this
->
	`GA
(
$r
);

1010 
	}
}

1013 
funi
 
	$IsAribu
(
$r
)

1015 if(
	`ist
(
$this
->
ems
[
$r
]) 
ue
;

1016  
l
;

1017 
	}
}

1020 
funi
 
	$GgName
()

1022  
$this
->
	`GA
("tagname");

1023 
	}
}

1026 
funi
 
	$Gcou
()

1028  
$this
->
cou
+1;

1029 
	}
}

1036 as
	cTagAribuP


1038 
v
 
	m$sourSg
 = "";

1039 
v
 
	m$sourMaxSize
 = 1024;

1040 
v
 
	m$cAribus
 = "";

1041 
v
 
	m$chToLow
 = 
ue
;

1042 
funi
 
SSour
(
$r
="")

1044 
$this
->
cAribus
 = 
w
 
TagAribu
();

1045 
	m$rL
 = 0;

1046 
	m$this
->
	msourSg
 = 
im
(
eg_a
("/[ \r\n\t\f]{1,}/"," ",
$r
));

1047 
	m$rL
 = 

(
$this
->
sourSg
);

1048 if(
	m$rL
>0 && $rL <
$this
->
sourMaxSize
)

1050 
$this
->
PAribu
();

1055 
funi
 
	$PAribu
()

1057 
$d
 = '';

1058 
$tm
 = '';

1059 
$tmpvue
 = '';

1060 
$tdd
 = -1;

1061 
$ddg
 = '';

1062 
$hasAribu
=
l
;

1063 
$rL
 = 
	`
(
$this
->
sourSg
);

1066 
$i
=0; $i<
$rL
; $i++)

1068 if(
$this
->
sourSg
[
$i
]==' ')

1070 
$this
->
cAribus
->
cou
++;

1071 
$tmpvues
 = 
	`exode
('.', 
$tmpvue
);

1072 
$this
->
cAribus
->
ems
['gme'] = ($this->
chToLow
 ? 
	`ow
(
$tmpvues
[0]) : $tmpvalues[0]);

1073 if
	`ist
(
$tmpvues
[2]) )

1075 
$okme
 = 
$tmpvues
[1];

1076 
$j
=2;
	`ist
(
$tmpvues
[$j]);$j++)

1078 
$okme
 ."['".
$tmpvues
[
$j
]."']";

1080 
$this
->
cAribus
->
ems
['me'] = 
$okme
;

1082 if(
	`ist
(
$tmpvues
[1]) && $tmpvalues[1]!='')

1084 
$this
->
cAribus
->
ems
['me'] = 
$tmpvues
[1];

1086 
$tmpvue
 = '';

1087 
$hasAribu
 = 
ue
;

1092 
$tmpvue
 .
$this
->
sourSg
[
$i
];

1097 if(!
$hasAribu
)

1099 
$this
->
cAribus
->
cou
++;

1100 
$tmpvues
 = 
	`exode
('.', 
$tmpvue
);

1101 
$this
->
cAribus
->
ems
['gme'] = ($this->
chToLow
 ? 
	`ow
(
$tmpvues
[0]) : $tmpvalues[0]);

1102 if
	`ist
(
$tmpvues
[2]) )

1104 
$okme
 = 
$tmpvues
[1];

1105 
$i
=2;
	`ist
(
$tmpvues
[$i]);$i++)

1107 
$okme
 ."['".
$tmpvues
[
$i
]."']";

1109 
$this
->
cAribus
->
ems
['me'] = 
$okme
;

1111 if(
	`ist
(
$tmpvues
[1]) && $tmpvalues[1]!='')

1113 
$this
->
cAribus
->
ems
['me'] = 
$tmpvues
[1];

1117 
$tmpvue
 = '';

1120 
$i
; $i<
$rL
; $i++)

1122 
$d
 = 
$this
->
sourSg
[
$i
];

1124 if(
$tdd
==-1)

1126 if(
$d
 != '=')

1128 
$tm
 .
$d
;

1132 if(
$this
->
chToLow
)

1134 
$tm
 = 
	`ow
(
	`im
($tmpatt));

1138 
$tm
 = 
	`im
($tmpatt);

1140 
$tdd
=0;

1145 if(
$tdd
==0)

1147 
$d
)

1152 
$ddg
 = '\'';

1153 
$tdd
 = 1;

1156 
$ddg
 = '"';

1157 
$tdd
 = 1;

1160 
$tmpvue
 .
$d
;

1161 
$ddg
 = ' ';

1162 
$tdd
 = 1;

1166 if(
$tdd
==1)

1168 if(
$d
==
$ddg
 && ( 
	`ist
(
$this
->
sourSg
[
$i
-1]) && $this->sourceString[$i-1]!="\\") )

1170 
$this
->
cAribus
->
cou
++;

1171 
$this
->
cAribus
->
ems
[
$tm
] = 
	`im
(
$tmpvue
);

1172 
$tm
 = '';

1173 
$tmpvue
 = '';

1174 
$tdd
 = -1;

1178 
$tmpvue
 .
$d
;

1184 if(
$tm
 != '')

1186 
$this
->
cAribus
->
cou
++;

1187 
$this
->
cAribus
->
ems
[
$tm
] = 
	`im
(
$tmpvue
);

1190 
	}
}

1194 
funi
 
	$ive_
(
$r
)

1196 
$r
 = 
	`exode
('.', 
$r
);

1198 
$rs
 = '$GLOBALS[\'';

1199 if(
$r
[0] == 'cfg')

1201  
$rs
.'cfg_'.
$r
[1]."']";

1203 
	`if
(
$r
[0] == 'var')

1205 
$r
[0] = '_vars';

1206 
$rs
 .
	`imode
('\'][\'', 
$r
);

1207 
$rs
 .= "']";

1208  
$rs
;

1210 
	`if
(
$r
[0] == 'global')

1212 
	`unt
(
$r
[0]);

1213 
$rs
 .
	`imode
('\'][\'', 
$r
);

1214 
$rs
 .= "']";

1215  
$rs
;

1219 if(
$r
[0] == 'field') $arr[0] = 'fields';

1220 
$rs
 = '$'.
$r
[0]."['";

1221 
	`unt
(
$r
[0]);

1222 
$rs
 .
	`imode
('\'][\'', 
$r
);

1223 
$rs
 .= "']";

1224  
$rs
;

1226 
	}
}

	@include/dedevote.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/dedetag.class.php");

8 as
	cDedeVe


10 
v
 
	m$VeInfos
;

11 
v
 
	m$VeNes
;

12 
v
 
	m$VeCou
;

13 
v
 
	m$VeID
;

14 
v
 
	m$dsql
;

17 
funi
 
	$__cڡru
(
$aid
)

19 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

20 
$this
->
VeInfos
 = $this->
dsql
->
	`GO
("Select * From `#@__vote` whereid='$aid'");

21 
$this
->
VeNes
 = 
	`Aay
();

22 
$this
->
VeCou
 = 0;

23 
$this
->
VeID
 = 
$aid
;

24 if(!
	`is_y
(
$this
->
VeInfos
))

28 
$d
 = 
w
 
	`DedeTagP
();

29 
$d
->
	`SNameS
("v","<",">");

30 
$d
->
	`LdSour
(
$this
->
VeInfos
['votenote']);

31 if(
	`is_y
(
$d
->
CTags
))

33 
	`fܗch
(
$d
->
CTags
 
as
 
$ag
)

35 
$this
->
VeNes
[
$ag
->
	`GA
('id')]['count'] = $ctag->GetAtt('count');

36 
$this
->
VeNes
[
$ag
->
	`GA
('id')]['me'] = 
	`im
($ag->
	`GIText
());

37 
$this
->
VeCou
++;

40 
$d
->
	`Cˬ
();

42 
funi
 
	$DedeVe
(
$aid
)

44 
$this
->
	`__cڡru
(
$aid
);

45 
	}
}

46 
funi
 
	$Clo
()

48 
	}
}

51 
funi
 
	$GTٮCou
()

53 if(!
	`emy
(
$this
->
VeInfos
["totalcount"]))

55  
$this
->
VeInfos
["totalcount"];

61 
	}
}

64 
funi
 
	$AddVeCou
(
$aid
)

66 if(
	`ist
(
$this
->
VeNes
[
$aid
]))

68 
$this
->
VeNes
[
$aid
]['count']++;

70 
	}
}

73 
funi
 
GVeFm
(
$leheight
=24,
$bwidth
="100%",
$tbgc
="#EDEDE2",
$tbackgroup
="",
$bbg
="#FFFFFF",
$embgc
="#FFFFFF")

76 if(
$leheight
=="")

78 
$leheight
=24;

80 if(
	g$bwidth
=="")

82 
$bwidth
="100%";

84 if(
	g$tbgc
=="")

86 
$tbgc
="#98C6EF";

88 if(
	g$tbackgroup
!="")

90 
$tbackgroup
="background='$titlebackgroup'";

92 if(
	g$bbg
=="")

94 
$bbg
="#FFFFFF";

96 if(
	g$embgc
=="")

98 
$embgc
="#FFFFFF";

100 
	g$ems
 = "<table width='$tablewidth' border='0' cellspacing='1' cellpadding='1' bgcolor='$tablebg'>\r\n";

101 
	g$ems
 ."<fmame='vefm' mhod='po'i='".
$GLOBALS
['cfg_phpurl']."/vote.php'arget='_blank'>\r\n";

102 
	g$ems
 .= "<inputype='hidden'ame='dopost' value='send' />\r\n";

103 
	g$ems
 ."<puty='hidd'ame='aid' vue='".
$this
->
VeID
."' />\r\n";

104 
	g$ems
 ."<puty='hidd'ame='isme' vue='".
$this
->
VeInfos
['ismore']."' />\r\n";

105 
	g$ems
.="<lign=''><td height='$leheight' sty='bd:1px dashed #818279' bgc='$tbgc' $tbackgroup><rg>".
$this
->
VeInfos
['votename']."</strong></td></tr>\r\n";

106 if(
	g$this
->
	gVeCou
 > 0)

109 
fܗch
(
$this
->
VeNes
 
as
 
$k
=>
$r
)

111 if(
$this
->
VeInfos
['ismore']==0)

113 
$ems
.="<><td height=$leheighbgc=$embgc><puty='dio'ame='veem' vue='$k' />".
$r
['name']."</td></tr>\r\n";

117 
	g$ems
.="<><td height=$leheighbgc=$embgc><puty=checkboxame='veem[]' vue='$k' />".
$r
['name']."</td></tr>\r\n";

120 
	g$ems
 .= "<tr><td height='$lineheight'>\r\n";

121 
	g$ems
 .= "<inputype='submit' style='width:60px;background-color:$titlebgcolor;border:1px dotted #818279'ame='vbt1' value='投票' />\r\n";

122 
	g$ems
 .= "<inputype='button' style='width:80px;background-color:$titlebgcolor;border:1px dotted #818279'ame='vbt2' ";

123 
	g$ems
 ."vue='查看结果' onClick=\"wdow.ݒ('".
$GLOBALS
['cfg_phpu']."/ve.php?do=vw&aid=".
$this
->
VeID
."');\" /></td></tr>\r\n";

125 
	g$ems
.="</form>\r\n</table>\r\n";

126  
	g$ems
;

131 
funi
 
	$SaveVe
(
$veem
)

133 if(
	`emy
(
$veem
))

137 
$ems
 = '';

140 
$nowtime
 = 
	`time
();

141 if(
$nowtime
 > 
$this
->
VeInfos
['endtime'])

145 if(
$nowtime
 < 
$this
->
VeInfos
['starttime'])

151 if(
	`ist
(
$_COOKIE
['DEDE_VOTENAME_AAA']))

153 if(
$_COOKIE
['DEDE_VOTENAME_AAA']==
$this
->
VeInfos
['aid'])

159 
	`tcook
('DEDE_VOTENAME_AAA',
$this
->
VeInfos
['aid'],
	`time
()+360000,'/');

164 
	`tcook
('DEDE_VOTENAME_AAA',
$this
->
VeInfos
['aid'],
	`time
()+360000,'/');

168 if(
$this
->
VeCou
 > 0)

170 
	`fܗch
(
$this
->
VeNes
 
as
 
$k
=>
$v
)

172 if(
$this
->
VeInfos
['ismore']==0)

175 if(
$veem
 =
$k
)

177 
$this
->
VeNes
[
$k
]['count']++; ;

183 if(
	`is_y
(
$veem
&& 
	`_y
(
$k
,$voteitem))

185 
$this
->
VeNes
[
$k
]['count']++;

189 
	`fܗch
(
$this
->
VeNes
 
as
 
$k
=>
$r
)

191 
$ems
 ."<v:nِid='$k' cou='".
$r
['count']."'>".$arr['name']."</v:note>\r\n";

194 
$this
->
dsql
->
	`ExecuNeQuy
("Upd`#@__ve` sٮcou='".($this->
VeInfos
['tٮcou']+1)."',vْe='".
	`addashes
(
$ems
)."' whaid='".$this->
VeID
."'");

196 
	}
}

199 
funi
 
GVeResu
(
$bwidth
="600",
$leheight
="24",
$b˥l
="40%")

201 
$tٮcou
 = 
$this
->
VeInfos
['totalcount'];

202 if(
	g$tٮcou
==0)

204 
$tٮcou
=1;

206 
	g$s
 = "<table width='$tablewidth' border='0' cellspacing='1' cellpadding='1'>\r\n";

207 
	g$s
 .= "<tr height='8'><td width='$tablesplit'></td><td></td></tr>\r\n";

208 
	g$i
=1;

209 
fܗch
(
$this
->
VeNes
 
as
 
$k
=>
$r
)

211 
$s
 ."< height='$leheight'><td sty='bd-btom:1px sid'>".
$i
."、".
$r
['name']."</td>";

212 
	g$c
 = 
$r
['count'];

213 
	g$s
 .= "<td style='border-bottom:1px solid'>

214 <
b
 
bd
='0' 
Υacg
='0' 
ηddg
='2' 
width
='".(($c/$tٮcou)*100)."%'><

><
td
 
height
='16' 
background
='img/vebg.gif' 
y
='border:1px solid #666666;font-size:9pt;line-height:110%'>".$arr['count']."</td></tr></table>

215 </
td
></

>\
r
\
n
";

216 
$i
++;

218 
	g$s
 .= "<tr><td></td><td></td></tr>\r\n";

219 
	g$s
 .= "</table>\r\n";

220  
	g$s
;

	@include/dedevote.inc.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/dedetag.class.php");

8 as
	cDedeVe


10 
v
 
	m$VeInfos
;

11 
v
 
	m$VeNes
;

12 
v
 
	m$VeCou
;

13 
v
 
	m$VeID
;

14 
v
 
	m$dsql
;

17 
funi
 
	$__cڡru
(
$aid
)

19 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

20 
$this
->
VeInfos
 = $this->
dsql
->
	`GO
("Select * From `#@__vote` whereid='$aid'");

21 
$this
->
VeNes
 = 
	`Aay
();

22 
$this
->
VeCou
 = 0;

23 
$this
->
VeID
 = 
$aid
;

24 if(!
	`is_y
(
$this
->
VeInfos
))

28 
$d
 = 
w
 
	`DedeTagP
();

29 
$d
->
	`SNameS
("v","<",">");

30 
$d
->
	`LdSour
(
$this
->
VeInfos
['votenote']);

31 if(
	`is_y
(
$d
->
CTags
))

33 
	`fܗch
(
$d
->
CTags
 
as
 
$ag
)

35 
$this
->
VeNes
[
$ag
->
	`GA
('id')]['count'] = $ctag->GetAtt('count');

36 
$this
->
VeNes
[
$ag
->
	`GA
('id')]['me'] = 
	`im
($ag->
	`GIText
());

37 
$this
->
VeCou
++;

40 
$d
->
	`Cˬ
();

43 
funi
 
	$DedeVe
(
$aid
)

45 
$this
->
	`__cڡru
(
$aid
);

46 
	}
}

48 
funi
 
	$Clo
()

50 
	}
}

53 
funi
 
	$GTٮCou
()

55 if(!
	`emy
(
$this
->
VeInfos
["totalcount"]))

57  
$this
->
VeInfos
["totalcount"];

63 
	}
}

66 
funi
 
	$AddVeCou
(
$aid
)

68 if(
	`ist
(
$this
->
VeNes
[
$aid
]))

70 
$this
->
VeNes
[
$aid
]['count']++;

72 
	}
}

75 
funi
 
GVeFm
(
$leheight
=24,
$bwidth
="100%",
$tbgc
="#EDEDE2",
$tbackgroup
="",
$bbg
="#FFFFFF",
$embgc
="#FFFFFF")

78 if(
$leheight
=="")

80 
$leheight
=24;

82 if(
	g$bwidth
=="")

84 
$bwidth
="100%";

86 if(
	g$tbgc
=="")

88 
$tbgc
="#EDEDE2";

90 if(
	g$tbackgroup
!="")

92 
$tbackgroup
="background='$titlebackgroup'";

94 if(
	g$bbg
=="")

96 
$bbg
="#FFFFFF";

98 if(
	g$embgc
=="")

100 
$embgc
="#FFFFFF";

102 
	g$ems
 = "<table width='$tablewidth' border='0' cellspacing='1' cellpadding='1' bgcolor='$tablebg'>\r\n";

103 
	g$ems
 ."<fmame='vefm' mhod='po'i='".
$GLOBALS
['cfg_phpurl']."/vote.php'arget='_blank'>\r\n";

104 
	g$ems
 .= "<inputype='hidden'ame='dopost' value='send'>\r\n";

105 
	g$ems
 ."<puty='hidd'ame='aid' vue='".
$this
->
VeID
."'>\r\n";

106 
	g$ems
 ."<puty='hidd'ame='isme' vue='".
$this
->
VeInfos
['ismore']."'>\r\n";

107 
	g$ems
.="<lign=''><td height='$leheight' bgc='$tbgc' $tbackgroup>".
$this
->
VeInfos
['votename']."</td></tr>\r\n";

108 if(
	g$this
->
	gVeCou
 > 0)

110 
fܗch
(
$this
->
VeNes
 
as
 
$k
=>
$r
)

112 if(
$this
->
VeInfos
['ismore']==0)

114 
$ems
.="<><td height=$leheighbgc=$embgc><puty='dio'ame='veem' vue='$k'>".
$r
['name']."</td></tr>\r\n";

118 
	g$ems
.="<><td height=$leheighbgc=$embgc><puty=checkboxame='veem[]' vue='$k'>".
$r
['name']."</td></tr>\r\n";

121 
	g$ems
 .= "<tr><td height='$lineheight' bgcolor='#FFFFFF'>\r\n";

122 
	g$ems
 .= "<inputype='submit' style='width:40;background-color:$titlebgcolor;border:1px soild #818279'ame='vbt1' value='投票'>\r\n";

123 
	g$ems
 .= "<inputype='button' style='width:80;background-color:$titlebgcolor;border:1px soild #818279'ame='vbt2' ";

124 
	g$ems
 ."vue='查看结果' onClick=\"wdow.ݒ('".
$GLOBALS
['cfg_phpu']."/ve.php?do=vw&aid=".
$this
->
VeID
."');\"></td></tr>\r\n";

127 
	g$ems
.="</form>\r\n</table>\r\n";

128  
	g$ems
;

133 
funi
 
	$SaveVe
(
$veem
)

135 if(
	`emy
(
$veem
))

139 
$ems
 = '';

142 
$nowtime
 = 
	`time
();

143 if(
$nowtime
 > 
$this
->
VeInfos
['endtime'])

147 if(
$nowtime
 < 
$this
->
VeInfos
['starttime'])

153 if(
	`ist
(
$_COOKIE
['DEDE_VOTENAME_AAA']))

155 if(
$_COOKIE
['DEDE_VOTENAME_AAA']==
$this
->
VeInfos
['aid'])

161 
	`tcook
('DEDE_VOTENAME_AAA',
$this
->
VeInfos
['aid'],
	`time
()+360000,'/');

166 
	`tcook
('DEDE_VOTENAME_AAA',
$this
->
VeInfos
['aid'],
	`time
()+360000,'/');

170 if(
$this
->
VeCou
 > 0)

172 
	`fܗch
(
$this
->
VeNes
 
as
 
$k
=>
$v
)

174 if(
$this
->
VeInfos
['ismore']==0)

177 if(
$veem
 =
$k
)

179 
$this
->
VeNes
[
$k
]['count']++; ;

185 if(
	`is_y
(
$veem
&& 
	`_y
(
$k
,$voteitem))

187 
$this
->
VeNes
[
$k
]['count']++;

191 
	`fܗch
(
$this
->
VeNes
 
as
 
$k
=>
$r
)

193 
$ems
 ."<v:nِid='$k' cou='".
$r
['count']."'>".$arr['name']."</v:note>\r\n";

196 
$this
->
dsql
->
	`ExecuNeQuy
("Upd`#@__ve` sٮcou='".($this->
VeInfos
['tٮcou']+1)."',vْe='".
	`addashes
(
$ems
)."' whaid='".$this->
VeID
."'");

198 
	}
}

201 
funi
 
GVeResu
(
$bwidth
="600",
$leheight
="24",
$b˥l
="40%")

203 
$tٮcou
 = 
$this
->
VeInfos
['totalcount'];

204 if(
	g$tٮcou
==0)

206 
$tٮcou
=1;

208 
	g$s
 = "<table width='$tablewidth' border='0' cellspacing='1' cellpadding='1'>\r\n";

209 
	g$s
 .= "<tr height='8'><td width='$tablesplit'></td><td></td></tr>\r\n";

210 
	g$i
=1;

211 
fܗch
(
$this
->
VeNes
 
as
 
$k
=>
$r
)

213 
$s
 ."< height='$leheight'><td sty='bd-btom:1px sid'>".
$i
."、".
$r
['name']."</td>";

214 
	g$c
 = 
$r
['count'];

215 
	g$s
 .= "<td style='border-bottom:1px solid'>

216 <
b
 
bd
='0' 
Υacg
='0' 
ηddg
='2' 
width
='".(($c/$tٮcou)*100)."%'><

><
td
 
height
='16' 
background
='img/vebg.gif' 
y
='border:1px solid #666666;font-size:9pt;line-height:110%'>".$arr['count']."</td></tr></table>

217 </
td
></

>\
r
\
n
";

219 
	g$s
 .= "<tr><td></td><td></td></tr>\r\n";

220 
	g$s
 .= "</table>\r\n";

221  
	g$s
;

	@include/dialog/config.php

1 <?
php


3 
que_
(
dme
(
__FILE__
)."/../common.inc.php");

4 
que_
(
dme
(
__FILE__
)."/../userlogin.class.php");

7 
	g$dedeNowu
 = '';

8 
	g$s_stName
 = '';

9 
	g$isUOn
 = @
i_g
('allow_url_fopen');

11 
	g$dedeNowu
 = 
GCurU
();

12 
	g$dedeNowus
 = 
exode
("?",
$dedeNowu
);

13 
	g$s_stName
 = 
$dedeNowus
[0];

17 
	g$curLog
 = 
w
 
urLog
();

19 if(
	g$curLog
->
gUrID
() <=0 )

21 if(
emy
(
$admDHd
))

23 
ShowMsg
("<b>提示：需输入后台管理目录才能登录</b><b/><fm>请输入后台管理目录名：<puty='hidd'ame='gage' vue='".
ucode
(
$dedeNowu
)."' /><inputype='text'ame='adminDirHand' value='dede' style='width:120px;' /><input style='width:80px;'ype='submit'ame='sbt' value='转入登录' /></form>", "javascript:;");

24 
ex
();

26 
	g$gu
 = "../../{$admDHd}/log.php?gage=".
ucode
(
$dedeNowu
);

27 
	gecho
 "<scriptanguage='javascript'>location='$gurl';</script>";

28 
ex
();

	@include/dialog/select_images.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
ude
(
DEDEDATA
.'/mark/inc_photowatermark_config.php');

4 if(
	$emy
(
$aivh
))

6 
$aivh
 = '';

7 
	}
}

8 if(
	$emy
(
$imgick
))

10 
$imgick
 = '';

11 
	}
}

12 
	g$aivh
 = 
r_a
('.','',
$aivh
);

13 
	g$aivh
 = 
eg_a
('/{1,}','/',
$aivh
);

14 if(

(
$aivh
< 
	$
(
$cfg_meds_d
))

16 
$aivh
 = 
$cfg_meds_d
;

17 
	}
}

18 
	g$th
 = 
$cfg_bad
.
$aivh
;

19 
	g$aiveu
 = '..'.
$aivh
;

20 if(
	$emy
(
$f
))

22 
$f
 = 'form1.picname';

23 
	}
}

24 if(
	$emy
(
$v
))

26 
$v
 = 'picview';

27 
	}
}

28 if(
	$emy
(
$comeback
))

30 
$comeback
 = '';

31 
	}
}

34 <
	ghtml
>

35 <
	ghd
>

36 <
ma
 
	ghp
-
	gequiv
='Cڋ-Ty' 
cڋ
='text/html; charset=utf-8'>

37 <
t
>图片浏览器</title>

38 <
lk
 
hf
='../../us/img/ba.css' 
l
='ysht' 
ty
='text/css'>

39 <
y
>

40 .
low
 {
bd
-
btom
: 1
px
 
sid
 #CBD8AC;}

41 .
	gpisdiv
 {
	g
:40;
	gt
:3;
	gwidth
:150
px
;
	gheight
:100px;
	gposi
:
absu
;
	gz
-
	gdex
:3;
	gdiy
:
ne
;}

42 </
	gy
>

43 <
	gst
>

44 
funi
 
	$nuLk
(){ ; 
	}
}

45 
funi
 
	$ChgeImage
(
su
){ 
documt
.
	`gEmtById
('picvw').
c
 = su; 
	}
}

46 </
	gst
>

47 </
	ghd
>

48 <
body
 
	gbackground
='img/lbg.gif' 
mg
='0' 
tmg
='0'>

49 <
div
 
id
="ߋr" 
ass
="napisdiv">

50 <
a
 
hf
="javast:nuLk();" 
Click
="documt.gEmtById('ߋr').y.diy='ne';"><
img
 
c
='img/picvwne.gif' 
id
='picvw' 
bd
='0' 
t
='单击关闭预览'></a>

51 </
div
>

52 <
SCRIPT
 
nguage
=
JavaSt
 
c
="js/float.js"></SCRIPT>

53 <
SCRIPT
 
nguage
=
JavaSt
>

54 
funi
 
	$nuLk
(){ ; 
	}
}

55 
funi
 
	$ChgeImage
(
su
){ 
documt
.
	`gEmtById
('ߋr').
y
.
diy
='block';documt.gEmtById('picvw').
c
 = su; 
	}
}

56 
funi
 
	$TNav
()

58 if(
wdow
.
vig
.
urAgt
.
	`dexOf
("MSIE")>=1)  'IE';

59 if(
wdow
.
vig
.
urAgt
.
	`dexOf
("Firefox")>=1)  'FF';

61 
	}
}

62 
funi
 
	$RuImg
(
img
)

64 
wdow
.
ݒ
.
documt
.<?
php
 
echo
 
$f
?>.
vue
=
img
;

65 if(
wdow
.
ݒ
.
documt
.
	`gEmtById
('div<?phpcho $v?>'))

67 if(
	`TNav
()=='IE'){

68 
wdow
.
ݒ
.
documt
.
	`gEmtById
('div<?phech$v?>').
frs
.
	`em
('DXImageTnsfm.Mioso.AhaImageLd').
c
 = 
img
;

69 
wdow
.
ݒ
.
documt
.
	`gEmtById
('div<?phech$v?>').
y
.
width
 = '150px';

70 
wdow
.
ݒ
.
documt
.
	`gEmtById
('div<?phech$v?>').
y
.
height
 = '100px';

73 
wdow
.
ݒ
.
documt
.
	`gEmtById
('div<?phech$v?>').
y
.
backgroundImage
 = "u("+
img
+")";

75 if(
wdow
.
ݒ
.
documt
.
	`gEmtById
('<?phpcho $v?>')){

76 
wdow
.
ݒ
.
documt
.
	`gEmtById
('<?phech$v?>').
c
 = 
img
;

78 if(
documt
.
l

wdow
.
ݒ
=
ue
;

79 
wdow
.
	`o
();

80 
	}
}

81 </
	gSCRIPT
>

82 <
b
 
	gwidth
='100%' 
bd
='0' 
Υacg
='0' 
ηddg
='0' 
ign
="center">

83 <

>

84 <
td
 
cޥ
='4' 
ign
='right'>

85 <
b
 
width
='100%' 
bd
='0' 
ηddg
='0' 
Υacg
='1' 
bgc
='#CBD8AC'>

86 <

 
bgc
='#FFFFFF'>

87 <
td
 
cޥ
='4'>

88 <
b
 
width
='100%' 
bd
='0' 
Υacg
='0' 
ηddg
='2'>

89 <

 
bgc
="#CCCCCC">

90 <
td
 
width
="8%" 
ign
="" 
ass
='low' 
bgc
='#EEF4EA'><
rg
>预览</strong></td>

91 <
td
 
width
="47%" 
ign
="" 
background
="img/wbg.gif" 
ass
='low'><
rg
>点击名称选择图片</strong></td>

92 <
td
 
width
="15%" 
ign
="" 
bgc
='#EEF4EA' 
ass
='low'><
rg
>文件大小</strong></td>

93 <
td
 
width
="30%" 
ign
="" 
background
="img/wbg.gif" 
ass
='low'><
rg
>最后修改时间</strong></td>

94 </

>

95 <

>

96 <
td
 
ass
='low' 
cޥ
='4' 
bgc
='#F9FBF0'>

97 点击“
V
”预览图片，点击图片名选择图片，显示图片后点击该图片关闭预览。

98 </
td
>

99 </

>

100 <?
php


101 
$dh
 = 
d
(
$th
);

102 
	g$ty1
="";

103 
	g$ty2
="";

104 
	g$fe
 = 
$dh
->
	$ad
()) {

107 if(
$fe
!="." && $fe!=".." && !
	`is_d
("$inpath/$file")){

108 
$fesize
 = 
	`fesize
("$inpath/$file");

109 
$fesize
=$filesize/1024;

110 if(
$fesize
!="")

111 if(
$fesize
<0.1){

112 @
	`li
(
$ty1
,
$ty2
)=
	`l
("\.",
$fesize
);

113 
$fesize
=
$ty1
.".".
	`subr
(
$ty2
,0,2);

116 @
	`li
(
$ty1
,
$ty2
)=
	`l
("\.",
$fesize
);

117 
$fesize
=
$ty1
.".".
	`subr
(
$ty2
,0,1);

119 
$fime
 = 
	`femtime
("$inpath/$file");

120 
$fime
 = 
	`MyDe
("Y-m-d H:i:s",$filetime);

123 if(
$fe
 == ".") ;

124 if(
$fe
 == ".."){

125 if(
$aivh
 == "") ;

126 
$tmp
 = 
	`egi_a
("[/][^/]*$","",
$aivh
);

127 
$le
 = "\n<tr>

128 <
td
 
ass
='low' 
cޥ
='2'>

129 <
a
 
hf
='_images.php?imgick=$imgick&v=$v&f=$f&aivh=".ucode($tmp)."'><
img
 
c
=img/
d2
.
gif
 
bd
=0 
width
=16 
height
=16 
ign
=
absmidd
>上级目录</a></
td
>

130 <
td
 
cޥ
='2' 
ass
='low'> 当前目录:
$aivh
</td>

131 </

>

133 
echo
 
$le
;

135 if(
	`is_d
("$inpath/$file")){

136 if(
	`egi
("^_(.*)$",
$fe
); #屏蔽
FrtPage
扩展目录和
lux
隐蔽目录

137 if(
	`egi
("^\.(.*)$",
$fe
)) ;

138 
$le
 = "\n<tr>

139 <
td
 
bgc
='#F9FBF0' 
ass
='low' 
cޥ
='2'>

140 <
a
 
hf
='_images.php?imgick=$imgick&v=$v&f=$f&aivh=".ucode("$aivh/$fe")."'><
img
 
c
=img/
d
.
gif
 
bd
=0 
width
=16 
height
=16 
ign
=
absmidd
>
$fe
</a></
td
>

141 <
td
 
ass
='linerow'>　</td>

142 <
td
 
bgc
='#F9FBF0' 
ass
='linerow'>　</td>

143 </

>";

144 
echo
 "$line";

146 if(
	`egi
("\.(gif|g)",
$fe
)){

148 
$u
 = "$activeurl/$file";

149 
$u
 = 
	`eg_a
("^\.\.","",$reurl);

150 
$u
 = $reurl;

152 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

153 
$ly
 = "";

155 
$le
 = "\n<tr>

156 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>

157 <
a
 
hf
=\"#\" onClick=\"ChangeImage('$reurl');\"><img src='img/picviewnone.gif' width='16' height='16' border='0'lign=absmiddle></a>

158 </
td
>

159 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

160 <
a
 
hf
=#onclick=\"ReturnImg('$reurl');\" $lstyle><img src=img/gif.gif border=0 width=16 height=16lign=absmiddle>$file</a></td>

161 <
td
 
ass
='low'>
$fesize
 
KB
</td>

162 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

163 </

>";

164 
echo
 "$line";

166 if(
	`egi
("\.(jpg)",
$fe
)){

168 
$u
 = "$activeurl/$file";

169 
$u
 = 
	`eg_a
("^\.\.","",$reurl);

170 
$u
 = $reurl;

172 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

173 
$ly
 = "";

175 
$le
 = "\n<tr>

176 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>

177 <
a
 
hf
=\"#\" onClick=\"ChangeImage('$reurl');\"><img src='img/picviewnone.gif' width='16' height='16' border='0'lign=absmiddle></a>

178 </
td
>

179 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

180 <
a
 
hf
=#onclick=\"ReturnImg('$reurl');\" $lstyle><img src=img/jpg.gif border=0 width=16 height=16lign=absmiddle>$file</a>

181 </
td
>

182 <
td
 
ass
='low'>
$fesize
 
KB
</td>

183 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

184 </

>";

185 
echo
 "$line";

187 
	}
}

188 
	g$dh
->
o
();

190 <
	g
>

191 <
td
 
	gcޥ
='4' 
bgc
='#E8F1DE'>

193 <
b
 
width
='100%'>

194 <
fm
 
ai
='_images_po.php' 
mhod
='POST' 
y
="muɝt/fm-da" 
me
='myform'>

195 <
put
 
ty
='hidd' 
me
='aivh' 
vue
='<?phpcho $activepath?>'>

196 <
put
 
ty
='hidd' 
me
='f' 
vue
='<?phpcho $f?>'>

197 <
put
 
ty
='hidd' 
me
='v' 
vue
='<?phpcho $v?>'>

198 <
put
 
ty
='hidd' 
me
='imgick' 
vue
='<?phpcho $imgstick?>'>

199 <
put
 
ty
='hidd' 
me
='job' 
vue
='upload'>

200 <

>

201 <
td
 
background
="img/tbg.gif" 
bgc
="#99CC00">

202 &
nb
;上　传： <
put
 
	gty
='fe' 
me
='imgfe' 
y
='width:250px'/>

203 <
put
 
ty
='checkbox' 
me
='edwmk' 
vue
='1' 
ass
='' <?
php
 if(
$pho_mkup
=='1'
echo
 "checked"; ?> />水印

204 <
put
 
	gty
='checkbox' 
me
='size' 
vue
='1' 
ass
='np' />缩小

205 宽：<
put
 
ty
='xt' 
y
='width:30' 
me
='iwidth' 
vue
='<?phpcho $cfg_ddimg_width?>' />

206 高：<
put
 
ty
='xt' 
y
='width:30' 
me
='iheight' 
vue
='<?phpcho $cfg_ddimg_height?>' />

207 <
put
 
ty
='subm' 
me
='sb1' 
vue
='确定' />

208 </
td
>

209 </

>

210 </
fm
>

211 </
b
>

213 </
td
>

214 </

>

215 </
b
>

216 </
td
>

217 </

>

218 </
b
>

219 </
td
>

220 </

>

221 </
b
>

222 </
body
>

223 </
html
>

	@include/dialog/select_images_post.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
dme
(
__FILE__
)."/../image.func.php");

4 if(
	$emy
(
$imgfe
))

6 
$imgfe
='';

7 
	}
}

8 if(!
	$is_uded_fe
(
$imgfe
))

10 
	`ShowMsg
("你没有选择上传的文件!".
$imgfe
,"-1");

11 
	`ex
();

12 
	}
}

13 
	g$imgfe_me
 = 
im
(
eg_a
("[ \r\n\t\*\%\\/\?><\|\":]{1,}", '', 
$imgfe_me
));

14 if(!
egi
("\.(".
$cfg_imgty
.")", 
$imgfe_me
))

16 
ShowMsg
("你所上传的图片类型不在许可列表，请更改系统对扩展名限定的配置！", "-1");

17 
ex
();

19 
	g$nowtme
 = 
time
();

20 
	g$r
 = 
Aay
("image/pjpeg","image/jpeg","image/gif","image/png","image/xpng","image/wbmp");

21 
	g$imgfe_ty
 = 
ow
(
im
(
$imgfe_ty
));

22 if(!
	$_y
(
$imgfe_ty
,
$r
))

24 
	`ShowMsg
("上传的图片格式错误，请使用JPEG、GIF、PNG、WBMP格式的其中一种！","-1");

25 
	`ex
();

26 
	}
}

27 
	g$md
 = 
MyDe
(
$cfg_add_vy
, 
$nowtme
);

28 if(!
is_d
(
$cfg_bad
.
$aivh
."/$mdir"))

30 
MkdA
(
$cfg_bad
.
$aivh
."/$md",
$cfg_d_purvw
);

31 
CloF
();

33 
	g$fame_me
 = 
$curLog
->
gUrID
().'-'.
dd2ch
(
MyDe
("ymdHis",
$nowtme
).
mt_nd
(100,999));

34 
	g$fame
 = 
$md
.'/'.
$fame_me
;

35 
	g$fs
 = 
exode
('.',
$imgfe_me
);

36 
	g$fame
 = 
$fame
.'.'.
$fs
[
cou
($fs)-1];

37 
	g$fame_me
 = 
$fame_me
.'.'.
$fs
[
cou
($fs)-1];

38 
	g$fufame
 = 
$cfg_bad
.
$aivh
."/".
$fame
;

39 
	$move_uded_fe
(
$imgfe
,
$fufame


 
	`d
("上传文件到 $fullfilename 失败！");

40 @
	`uƚk
(
$imgfe
);

41 if(
	$emy
(
$size
))

43 
$size
 = 0;

44 
	}
}

45 if(
	g$size
==1)

47 if(
_y
(
$imgfe_ty
,
$cfg_pho_tymes
))

49 
ImageResize
(
$fufame
,
$iwidth
,
$iheight
);

54 if(
_y
(
$imgfe_ty
,
$cfg_pho_tymes
))

56 
WImg
(
$fufame
,'up');

60 
	g$fo
 = '';

61 
	g$sizes
[0] = 0; $sizes[1] = 0;

62 
	g$sizes
 = 
gimagesize
(
$fufame
,
$fo
);

63 
	g$imgwidthVue
 = 
$sizes
[0];

64 
	g$imgheightVue
 = 
$sizes
[1];

65 
	g$imgsize
 = 
fesize
(
$fufame
);

66 
	g$quy
 = "INSERT INTO `#@__uploads`(arcid,title,url,mediatype,width,height,playtime,filesize,uptime,mid)

67 
VALUES
 ('0','$filename','".$activepath."/".$filename."','1','$imgwidthValue','$imgheightValue','0','{$imgsize}','{$nowtme}','".$cuserLogin->getUserID()."'); ";

68 
	g$dsql
->
ExecuNeQuy
(
$quy
);

69 
	g$fid
 = 
$dsql
->
GLaID
();

70 
AddMyAdd
(
$fid
, 
$aivh
.'/'.
$fame
);

72 
ShowMsg
("成功上传一幅图片！","_images.php?imgick=$imgick&comeback=".
ucode
(
$fame_me
)."&v=$v&f=$f&aivh=".ucode(
$aivh
)."/$md&d=".
time
());

73 
ex
();

	@include/dialog/select_media.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
	$emy
(
$aivh
))

5 
$aivh
 = '';

6 
	}
}

7 
	g$aivh
 = 
r_a
('.','',
$aivh
);

8 
	g$aivh
 = 
eg_a
("/{1,}",'/',
$aivh
);

9 if(

(
$aivh
< 
	$
(
$cfg_h_meds
))

11 
$aivh
 = 
$cfg_h_meds
;

12 
	}
}

13 
	g$th
 = 
$cfg_bad
.
$aivh
;

14 
	g$aiveu
 = '..'.
$aivh
;

15 if(
	$emy
(
$f
))

17 
$f
 = 'form1.enclosure';

18 
	}
}

20 if(
	$emy
(
$comeback
))

22 
$comeback
 = '';

23 
	}
}

25 <
	ghtml
>

26 <
	ghd
>

27 <
ma
 
	ghp
-
	gequiv
='Cڋ-Ty' 
cڋ
='text/html; charset=utf-8'>

28 <
t
>媒体文件管理器</title>

29 <
lk
 
hf
='../../us/img/ba.css' 
l
='ysht' 
ty
='text/css'>

30 <
y
>

31 .
low
 {
bd
-
btom
: 1
px
 
sid
 #CBD8AC;}

32 </
	gy
>

33 </
	ghd
>

34 <
body
 
	gbackground
='img/lbg.gif' 
mg
='0' 
tmg
='0'>

35 <
SCRIPT
 
nguage
='JavaScript'>

36 
funi
 
	$nuLk
()

39 
	}
}

40 
funi
 
	$RuVue
(
img
)

42 
wdow
.
ݒ
.
documt
.<?
php
 
echo
 
$f
?>.
vue
=
img
;

43 if(
documt
.
l

wdow
.
ݒ
=
ue
;

44 
wdow
.
	`o
();

45 
	}
}

46 </
	gSCRIPT
>

47 <
b
 
	gwidth
='100%' 
bd
='0' 
ηddg
='0' 
Υacg
='1' 
bgc
='#CBD8AC' 
ign
="center">

48 <

 
bgc
='#FFFFFF'>

49 <
td
 
cޥ
='3'>

51 <
b
 
width
='100%' 
bd
='0' 
Υacg
='0' 
ηddg
='2'>

52 <

 
bgc
="#CCCCCC">

53 <
td
 
width
="55%" 
ign
="" 
background
="img/wbg.gif" 
ass
='low'><
rg
>点击名称选择文件</strong></td>

54 <
td
 
width
="15%" 
ign
="" 
bgc
='#EEF4EA' 
ass
='low'><
rg
>文件大小</strong></td>

55 <
td
 
width
="30%" 
ign
="" 
background
="img/wbg.gif" 
ass
='low'><
rg
>最后修改时间</strong></td>

56 </

>

57 <?
php


58 
$dh
 = 
d
(
$th
);

59 
	g$ty1
="";

60 
	g$ty2
="";

61 
	g$fe
 = 
$dh
->
	$ad
()) {

64 if(
$fe
!="." && $fe!=".." && !
	`is_d
("$inpath/$file")){

65 
$fesize
 = 
	`fesize
("$inpath/$file");

66 
$fesize
=$filesize/1024;

67 if(
$fesize
!="")

68 if(
$fesize
<0.1){

69 @
	`li
(
$ty1
,
$ty2
)=
	`l
("\.",
$fesize
);

70 
$fesize
=
$ty1
.".".
	`subr
(
$ty2
,0,2);

73 @
	`li
(
$ty1
,
$ty2
)=
	`l
("\.",
$fesize
);

74 
$fesize
=
$ty1
.".".
	`subr
(
$ty2
,0,1);

76 
$fime
 = 
	`femtime
("$inpath/$file");

77 
$fime
 = 
	`MyDe
("Y-m-d H:i:s",$filetime);

81 if(
$fe
 == ".") ;

82 if(
$fe
 == "..")

84 if(
$aivh
 == "") ;

85 
$tmp
 = 
	`egi_a
("[/][^/]*$","",
$aivh
);

86 
$le
 = "\n<tr>

87 <
td
 
ass
='low'> <
a
 
hf
=
_med
.
php
?
f
=
$f
&
aivh
=".ucode($tmp)."><
img
 
c
=img/
d2
.
gif
 
bd
=0 
width
=16 
height
=16 
ign
=
absmidd
>上级目录</a></td>

88 <
td
 
cޥ
='2' 
ass
='low'> 当前目录:
$aivh
</td>

89 </

>\
r
\
n
";

90 
echo
 
$le
;

92 if(
	`is_d
("$inpath/$file"))

94 if(
	`egi
("^_(.*)$",
$fe
); #屏蔽
FrtPage
扩展目录和
lux
隐蔽目录

95 if(
	`egi
("^\.(.*)$",
$fe
)) ;

96 
$le
 = "\n<tr>

97 <
td
 
bgc
='#F9FBF0' 
ass
='linerow'>

98 <
a
 
hf
=
_med
.
php
?
f
=
$f
&
aivh
=".ucode("
$aivh
/
$fe
")."><
img
 
c
=img/
d
.
gif
 
bd
=0 
width
=16 
height
=16 
ign
=
absmidd
>$file</a>

99 </
td
>

100 <
td
 
ass
='linerow'>-</td>

101 <
td
 
bgc
='#F9FBF0' 
ass
='linerow'>-</td>

102 </

>";

103 
echo
 "$line";

105 if(
	`egi
("\.(swf|y|a)",
$fe
)){

107 
$u
 = "$activeurl/$file";

108 
$u
 = 
	`eg_a
("^\.\.","",$reurl);

109 
$u
 = $reurl;

111 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

112 
$ly
 = "";

114 
$le
 = "\n<tr>

115 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

116 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\"><img src=img/flash.gif border=0 width=16 height=16lign=absmiddle>$file</a>

117 </
td
>

118 <
td
 
ass
='low'>
$fesize
 
KB
</td>

119 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

120 </

>";

121 
echo
 "$line";

123 if(
	`egi
("\.(wmv|i)",
$fe
)){

125 
$u
 = "$activeurl/$file";

126 
$u
 = 
	`eg_a
("^\.\.","",$reurl);

127 
$u
 = $reurl;

129 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

130 
$ly
 = "";

132 
$le
 = "\n<tr>

133 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

134 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\"><img src=img/wmv.gif border=0 width=16 height=16lign=absmiddle>$file</a>

135 </
td
>

136 <
td
 
ass
='low'>
$fesize
 
KB
</td>

137 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

138 </

>";

139 
echo
 "$line";

141 if(
	`egi
("\.m|rmvb)",
$fe
)){

143 
$u
 = "$activeurl/$file";

144 
$u
 = 
	`eg_a
("^\.\.","",$reurl);

145 
$u
 = $reurl;

147 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

148 
$ly
 = "";

150 
$le
 = "\n<tr>

151 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

152 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\"><img src=img/rm.gif border=0 width=16 height=16lign=absmiddle>$file</a>

153 </
td
>

154 <
td
 
ass
='low'>
$fesize
 
KB
</td>

155 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

156 </

>";

157 
echo
 "$line";

159 if(
	`egi
("\.(mp3|wma)",
$fe
)){

161 
$u
 = "$activeurl/$file";

162 
$u
 = 
	`eg_a
("^\.\.","",$reurl);

163 
$u
 = $reurl;

165 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

166 
$ly
 = "";

168 
$le
 = "\n<tr>

169 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

170 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\"><img src=img/mp3.gif border=0 width=16 height=16lign=absmiddle>$file</a>

171 </
td
>

172 <
td
 
ass
='low'>
$fesize
 
KB
</td>

173 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

174 </

>";

175 
echo
 "$line";

177 
	}
}

178 
	g$dh
->
o
();

181 <
	g
>

182 <
td
 
	gcޥ
='3' 
bgc
='#E8F1DE'>

184 <
b
 
width
='100%'>

185 <
fm
 
ai
='_med_po.php' 
mhod
='POST' 
y
="muɝt/fm-da" 
me
='myform'>

186 <
put
 
ty
='hidd' 
me
='aivh' 
vue
='<?phpcho $activepath?>'>

187 <
put
 
ty
='hidd' 
me
='f' 
vue
='<?phpcho $f?>'>

188 <
put
 
ty
='hidd' 
me
='job' 
vue
='upload'>

189 <

>

190 <
td
 
background
="img/tbg.gif" 
bgc
="#99CC00">

191 &
nb
;上　传： <
put
 
	gty
='fe' 
me
='udfe' 
y
='width:320px'>&nb;<puty='subm'ame='sb1' 
vue
='确定'>

192 </
td
>

193 </

>

194 </
fm
>

195 </
b
>

197 </
td
>

198 </

>

199 </
b
>

201 </
td
>

202 </

>

203 </
b
>

205 </
body
>

206 </
html
>

	@include/dialog/select_media_post.php

1 <?
php


2 
ude_
(
dme
(
__FILE__
).'/config.php');

3 
	g$cfg_soty
 = 
$cfg_medty
;

4 
	g$cfg_so_d
 = 
$cfg_h_meds
;

5 
	g$bku
 = 'select_media.php';

6 
	g$udmbty
 = "多媒体文件类型";

7 
que_
(
dme
(
__FILE__
)."/select_soft_post.php");

	@include/dialog/select_soft.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
	$emy
(
$aivh
))

5 
$aivh
 = '';

6 
	}
}

7 
	g$aivh
 = 
r_a
('.','',
$aivh
);

8 
	g$aivh
 = 
eg_a
("/{1,}",'/',
$aivh
);

9 if(

(
$aivh
< 
	$
(
$cfg_so_d
))

11 
$aivh
 = 
$cfg_so_d
;

12 
	}
}

13 
	g$th
 = 
$cfg_bad
.
$aivh
;

14 
	g$aiveu
 = '..'.
$aivh
;

15 if(
	$emy
(
$f
))

17 
$f
='form1.enclosure';

18 
	}
}

20 if(
	$emy
(
$comeback
))

22 
$comeback
 = '';

23 
	}
}

26 <
	ghtml
>

27 <
	ghd
>

28 <
ma
 
	ghp
-
	gequiv
='Cڋ-Ty' 
cڋ
='text/html; charset=utf-8'>

29 <
t
>软件管理器</title>

30 <
lk
 
hf
='../../us/img/ba.css' 
l
='ysht' 
ty
='text/css'>

31 <
y
>

32 .
low
 {
bd
-
btom
: 1
px
 
sid
 #CBD8AC;}

33 </
	gy
>

34 </
	ghd
>

35 <
body
 
	gbackground
='img/lbg.gif' 
mg
='5' 
tmg
='0'>

36 <
SCRIPT
 
nguage
='JavaScript'>

37 
funi
 
	$nuLk
()

40 
	}
}

41 
funi
 
	$RuVue
(
img
)

43 
wdow
.
ݒ
.
documt
.<?
php
 
echo
 
$f
?>.
vue
=
img
;

44 if(
documt
.
l

wdow
.
ݒ
=
ue
;

45 
wdow
.
	`o
();

46 
	}
}

47 </
	gSCRIPT
>

48 <
b
 
	gwidth
='100%' 
bd
='0' 
ηddg
='0' 
Υacg
='1' 
bgc
='#CBD8AC' 
ign
="center">

49 <

>

50 <
td
 
cޥ
='3' 
bgc
='#E8F1DE' 
background
="img/tbg.gif" 
height
='28'>

51 <
fm
 
ai
='_so_po.php' 
mhod
='POST' 
y
="muɝt/fm-da" 
me
='myform'>

52 <
put
 
ty
='hidd' 
me
='aivh' 
vue
='<?phpcho $activepath?>' />

53 <
put
 
ty
='hidd' 
me
='f' 
vue
='<?phpcho $f?>' />

54 <
put
 
ty
='hidd' 
me
='job' 
vue
='upload' />

55 &
nb
;上　传： <
put
 
	gty
='fe' 
me
='udfe' 
size
='25' />

56 &
nb
;

57 改 名：<
put
 
	gty
='' 
me
='wme' 
y
='width:90px' />

58 &
nb
;

59 <
put
 
	gty
='subm' 
me
='sb1' 
vue
='确定' />

60 </
fm
>

61 </
td
>

62 </

>

63 <

 
bgc
='#FFFFFF'>

64 <
td
 
cޥ
='3'>

66 <
b
 
width
='100%' 
bd
='0' 
Υacg
='0' 
ηddg
='2'>

67 <

 
bgc
="#CCCCCC" 
height
="24">

68 <
td
 
width
="55%" 
ign
="" 
background
="img/wbg.gif" 
ass
='low'><
rg
>点击名称选择文件</strong></td>

69 <
td
 
width
="15%" 
ign
="" 
bgc
='#EEF4EA' 
ass
='low'><
rg
>文件大小</strong></td>

70 <
td
 
width
="30%" 
ign
="" 
background
="img/wbg.gif" 
ass
='low'><
rg
>最后修改时间</strong></td>

71 </

>

72 <?
php


73 
$dh
 = 
d
(
$th
);

74 
	g$ty1
 = 
$ty2
 = '';

75 
	g$fe
 = 
$dh
->
	$ad
())

78 if(
$fe
!="." && $fe!=".." && !
	`is_d
("$inpath/$file")){

79 
$fesize
 = 
	`fesize
("$inpath/$file");

80 
$fesize
=$filesize/1024;

81 if(
$fesize
!="")

82 if(
$fesize
<0.1){

83 @
	`li
(
$ty1
,
$ty2
)=
	`l
("\.",
$fesize
);

84 
$fesize
=
$ty1
.".".
	`subr
(
$ty2
,0,2);

87 @
	`li
(
$ty1
,
$ty2
)=
	`l
("\.",
$fesize
);

88 
$fesize
=
$ty1
.".".
	`subr
(
$ty2
,0,1);

90 
$fime
 = 
	`femtime
("$inpath/$file");

91 
$fime
 = 
	`MyDe
("Y-m-d H:i:s",$filetime);

94 if(
$fe
 == ".") ;

95 if(
$fe
 == "..")

97 if(
$aivh
 == "") ;

98 
$tmp
 = 
	`egi_a
("[/][^/]*$","",
$aivh
);

99 
$le
 = "\n<tr height='24'>

100 <
td
 
ass
='low'> <
a
 
hf
='_so.php?f=$f&aivh=".ucode($tmp)."'><
img
 
c
=img/
d2
.
gif
 
bd
=0 
width
=16 
height
=16 
ign
=
absmidd
>上级目录</a></td>

101 <
td
 
cޥ
='2' 
ass
='low'> 当前目录:
$aivh
</td>

102 </

>\
r
\
n
";

103 
echo
 
$le
;

105 if(
	`is_d
("$inpath/$file"))

107 if(
	`egi
("^_(.*)$",
$fe
); #屏蔽
FrtPage
扩展目录和
lux
隐蔽目录

108 if(
	`egi
("^\.(.*)$",
$fe
)) ;

109 
$le
 = "\n<tr height='24'>

110 <
td
 
bgc
='#F9FBF0' 
ass
='linerow'>

111 <
a
 
hf
=
_so
.
php
?
f
=
$f
&
aivh
=".ucode("
$aivh
/
$fe
")."><
img
 
c
=img/
d
.
gif
 
bd
=0 
width
=16 
height
=16 
ign
=
absmidd
>$file</a>

112 </
td
>

113 <
td
 
ass
='linerow'>-</td>

114 <
td
 
bgc
='#F9FBF0' 
ass
='linerow'>-</td>

115 </

>";

116 
echo
 "$line";

118 if(
	`egi
("\.(z|r|tgr.gz)",
$fe
))

120 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

121 
$ly
 = "";

123 
$u
 = "$activeurl/$file";

125 
$u
 = 
	`eg_a
("^\.\.","",$reurl);

126 
$u
 = $reurl;

128 
$le
 = "\n<tr height='24'>

129 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

130 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\" $lstyle><img src=img/zip.gif border=0 width=16 height=16lign=absmiddle>$file</a>

131 </
td
>

132 <
td
 
ass
='low'>
$fesize
 
KB
</td>

133 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

134 </

>";

135 
echo
 "$line";

139 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

140 
$ly
 = '';

142 
$u
 = "$activeurl/$file";

144 
$u
 = 
	`eg_a
("^\.\.","",$reurl);

145 
$u
 = $reurl;

147 
$le
 = "\n<tr height='24'>

148 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

149 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\" $lstyle><img src=img/exe.gif border=0 width=16 height=16lign=absmiddle>$file</a>

150 </
td
>

151 <
td
 
ass
='low'>
$fesize
 
KB
</td>

152 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

153 </

>";

154 
echo
 "$line";

156 
	}
}

157 
	g$dh
->
o
();

160 </
	gb
></
	gtd
></
	g
>

161 <
	g
><
td
 
	gcޥ
='3' 
bgc
='#E8F1DE' 
height
='26'>&
nb
;请点击要选择的文件，红色字样的为刚上传的文件。</
	gtd
></tr>

162 </
	gb
>

163 </
	gbody
>

164 </
	ghtml
>

	@include/dialog/select_soft_post.php

1 <?
php


2 if(!
	$ist
(
$cfg_bad
))

4 
	`ude_
(
	`dme
(
__FILE__
).'/config.php');

5 
	}
}

6 if(
emy
(
$udfe
)
	g$udfe
 = '';

7 if(
emy
(
$udmbty
)
	g$udmbty
 = '软件类型';

8 if(
emy
(
$bku
)
	g$bku
 = 'select_soft.php';

9 
	g$wme
 = ( 
emy
(
$wme
? '' : 
eg_a
("[\\ \"\*\?\t\r\n<>':/|]", "", $newname) );

11 if(!
	$is_uded_fe
(
$udfe
))

13 
	`ShowMsg
("你没有选择上传的文件或选择的文件大小超出限制!", "-1");

14 
	`ex
();

15 
	}
}

18 
	g$cfg_soty
 = 
$cfg_soty
.'|'.
$cfg_imgty
.'|'.
$cfg_medty
;

19 
	g$cfg_soty
 = 
r_a
('||', '|', 
$cfg_soty
);

20 
	g$udfe_me
 = 
im
(
eg_a
("[ \r\n\t\*\%\\/\?><\|\":]{1,}",'',
$udfe_me
));

21 if(!
egi
("\.(".
$cfg_soty
.")", 
$udfe_me
))

23 
ShowMsg
("你所上传的{$uploadmbtype}不在许可列表，请更改系统对扩展名限定的配置！","-1");

24 
ex
();

27 
	g$nowtme
 = 
time
();

28 if(
	g$aivh
==
$cfg_so_d
)

30 
$wd
 = 
MyDe
(
$cfg_add_vy
, 
$nowtme
);

31 
	g$aivh
 = 
$aivh
.'/'.
$wd
;

32 if(!
is_d
(
$cfg_bad
.
$aivh
))

34 
MkdA
(
$cfg_bad
.
$aivh
,
$cfg_d_purvw
);

35 
CloF
();

40 if(!
	$emy
(
$wme
))

42 
$fame
 = 
$wme
;

43 if(!
	`eg
("\.", 
$fame
)
$fs
 = 
	`exode
('.', 
$udfe_me
);

44 
$fs
 = 
	`exode
('.', 
$fame
);

45 if(
	`egi
(
$cfg_n_lowl
, 
$fs
[
	`cou
($fs)-1]))

47 
	`ShowMsg
("你指定的文件名被系统禁止！",'javascript:;');

48 
	`ex
();

50 if(!
	`eg
("\.", 
$fame
)$fam$fame.'.'.
$fs
[
	`cou
($fs)-1];

51 
	}
}

54 
	g$fame
 = 
$curLog
->
gUrID
().'-'.
dd2ch
(
MyDe
('ymdHis',
$nowtme
));

55 
	g$fs
 = 
exode
('.', 
$udfe_me
);

56 if(
egi
(
$cfg_n_lowl
, 
$fs
[
cou
($fs)-1]))

58 
ShowMsg
("你上传了某些可能存在不安全因素的文件，系统拒绝操作！",'javascript:;');

59 
ex
();

61 
	g$fame
 = 
$fame
.'.'.
$fs
[
cou
($fs)-1];

64 
	g$fufame
 = 
$cfg_bad
.
$aivh
.'/'.
$fame
;

65 
	g$fufeu
 = 
$aivh
.'/'.
$fame
;

66 
	$move_uded_fe
(
$udfe
,
$fufame


 
	`d
("上传文件到 $fullfilename 失败！");

67 @
	`uƚk
(
$udfe
);

69 if(
$udfe_ty
 == 'application/x-shockwave-flash')

71 
$medty
=2;

72 
	}
}

73 if(
egi
('image',
$udfe_ty
))

75 
	g$medty
=1;

77 if(
egi
('audio|med|video',
$udfe_ty
))

79 
	g$medty
=3;

83 
	g$medty
=4;

86 
	g$quy
 = "INSERT INTO `#@__uploads`(arcid,title,url,mediatype,width,height,playtime,filesize,uptime,mid)

87 
VALUES
 ('0','$filename','$fullfileurl','$mediatype','0','0','0','{$uploadfile_size}','{$nowtme}','".$cuserLogin->getUserID()."'); ";

89 
	g$dsql
->
ExecuNeQuy
(
$quy
);

90 
	g$fid
 = 
$dsql
->
GLaID
();

91 
AddMyAdd
(
$fid
, 
$fufeu
);

93 
ShowMsg
("成功上传文件！",
$bku
."?comeback=".
ucode
(
$fame
)."&f=$f&aivh=".ucode(
$aivh
)."&d=".
time
());

94 
ex
();

	@include/dialog/select_templets.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
	$emy
(
$aivh
))

5 
$aivh
 = '';

6 
	}
}

7 
	g$cfg_txy
 = 'htm|html|tpl|txt|dtp';

8 
	g$aivh
 = 
r_a
('.','',
$aivh
);

9 
	g$aivh
 = 
eg_a
("/{1,}",'/',
$aivh
);

10 
	g$md
 = 
$cfg_ms_d
;

11 if(

(
$aivh
< 
	$
(
$md
))

13 
$aivh
 = 
$md
;

14 
	}
}

15 
	g$th
 = 
$cfg_bad
.
$aivh
;

16 
	g$aiveu
 = '..'.
$aivh
;

17 if(
	$emy
(
$f
))

19 
$f
='form1.enclosure';

20 
	}
}

21 if(
	$emy
(
$comeback
))

23 
$comeback
 = '';

24 
	}
}

26 <
	ghtml
>

27 <
	ghd
>

28 <
ma
 
	ghp
-
	gequiv
='Cڋ-Ty' 
cڋ
='text/html; charset=utf-8'>

29 <
t
>模板管理器</title>

30 <
lk
 
hf
='../../us/img/ba.css' 
l
='ysht' 
ty
='text/css'>

31 <
y
>

32 .
low
 {
bd
-
btom
: 1
px
 
sid
 #CBD8AC;}

33 </
	gy
>

34 </
	ghd
>

35 <
body
 
	gbackground
='img/lbg.gif' 
mg
='0' 
tmg
='0'>

36 <
SCRIPT
 
nguage
='JavaScript'>

37 
funi
 
	$nuLk
()

40 
	}
}

41 
funi
 
	$RuVue
(
img
)

43 
wdow
.
ݒ
.
documt
.<?
php
 
echo
 
$f
?>.
vue
=
img
;

44 if(
documt
.
l

wdow
.
ݒ
=
ue
;

45 
wdow
.
	`o
();

46 
	}
}

47 </
	gSCRIPT
>

48 <
b
 
	gwidth
='100%' 
bd
='0' 
ηddg
='0' 
Υacg
='1' 
bgc
='#CBD8AC' 
ign
="center">

49 <

 
bgc
='#FFFFFF'>

50 <
td
 
cޥ
='3'>

52 <
b
 
width
='100%' 
bd
='0' 
Υacg
='0' 
ηddg
='2'>

53 <

 
bgc
="#CCCCCC">

54 <
td
 
width
="55%" 
ign
="" 
background
="img/wbg.gif" 
ass
='low'><
rg
>点击名称选择文件</strong></td>

55 <
td
 
width
="15%" 
ign
="" 
bgc
='#EEF4EA' 
ass
='low'><
rg
>文件大小</strong></td>

56 <
td
 
width
="30%" 
ign
="" 
background
="img/wbg.gif" 
ass
='low'><
rg
>最后修改时间</strong></td>

57 </

>

58 <?
php


59 
$dh
 = 
d
(
$th
);

60 
	g$ty1
="";

61 
	g$ty2
="";

62 
	g$fe
 = 
$dh
->
	$ad
()) {

65 if(
$fe
!="." && $fe!=".." && !
	`is_d
("$inpath/$file")){

66 
$fesize
 = 
	`fesize
("$inpath/$file");

67 
$fesize
=$filesize/1024;

68 if(
$fesize
!="")

69 if(
$fesize
<0.1){

70 @
	`li
(
$ty1
,
$ty2
)=
	`l
("\.",
$fesize
);

71 
$fesize
=
$ty1
.".".
	`subr
(
$ty2
,0,2);

74 @
	`li
(
$ty1
,
$ty2
)=
	`l
("\.",
$fesize
);

75 
$fesize
=
$ty1
.".".
	`subr
(
$ty2
,0,1);

77 
$fime
 = 
	`femtime
("$inpath/$file");

78 
$fime
 = 
	`MyDe
("Y-m-d H:i:s",$filetime);

82 if(
$fe
 == ".") ;

83 if(
$fe
 == "..")

85 if(
$aivh
 == "") ;

86 
$tmp
 = 
	`egi_a
("[/][^/]*$","",
$aivh
);

87 
$le
 = "\n<tr>

88 <
td
 
ass
='low'> <
a
 
hf
='_ms.php?f=$f&aivh=".ucode($tmp)."'><
img
 
c
=img/
d2
.
gif
 
bd
=0 
width
=16 
height
=16 
ign
=
absmidd
>上级目录</a></td>

89 <
td
 
cޥ
='2' 
ass
='low'> 当前目录:
$aivh
</td>

90 </

>\
r
\
n
";

91 
echo
 
$le
;

93 if(
	`is_d
("$inpath/$file"))

95 if(
	`egi
("^_(.*)$",
$fe
); #屏蔽
FrtPage
扩展目录和
lux
隐蔽目录

96 if(
	`egi
("^\.(.*)$",
$fe
)) ;

97 
$le
 = "\n<tr>

98 <
td
 
bgc
='#F9FBF0' 
ass
='linerow'>

99 <
a
 
hf
=
_ms
.
php
?
f
=
$f
&
aivh
=".ucode("
$aivh
/
$fe
")."><
img
 
c
=img/
d
.
gif
 
bd
=0 
width
=16 
height
=16 
ign
=
absmidd
>$file</a>

100 </
td
>

101 <
td
 
ass
='linerow'>-</td>

102 <
td
 
bgc
='#F9FBF0' 
ass
='linerow'>-</td>

103 </

>";

104 
echo
 "$line";

106 if(
	`egi
("\.(htm|html)",
$fe
)){

108 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

109 
$ly
 = "";

111 
$u
 = "$activeurl/$file";

113 
$u
 = 
	`eg_a
("\.\.","",$reurl);

114 
$u
 = 
	`eg_a
(
$md
."/","",$reurl);

116 
$le
 = "\n<tr>

117 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

118 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\" $lstyle><img src=img/htm.gif border=0 width=16 height=16lign=absmiddle>$file</a>

119 </
td
>

120 <
td
 
ass
='low'>
$fesize
 
KB
</td>

121 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

122 </

>";

123 
echo
 "$line";

125 if(
	`egi
("\.(css)",
$fe
)){

127 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

128 
$ly
 = "";

130 
$u
 = "$activeurl/$file";

132 
$u
 = 
	`eg_a
("\.\.","",$reurl);

133 
$u
 = 
	`eg_a
(
$md
."/","",$reurl);

135 
$le
 = "\n<tr>

136 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

137 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\" $lstyle><img src=img/css.gif border=0 width=16 height=16lign=absmiddle>$file</a>

138 </
td
>

139 <
td
 
ass
='low'>
$fesize
 
KB
</td>

140 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

141 </

>";

142 
echo
 "$line";

144 if(
	`egi
("\.(js)",
$fe
)){

146 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

147 
$ly
 = "";

149 
$u
 = "$activeurl/$file";

151 
$u
 = 
	`eg_a
("\.\.","",$reurl);

152 
$u
 = 
	`eg_a
(
$md
."/","",$reurl);

154 
$le
 = "\n<tr>

155 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

156 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\" $lstyle><img src=img/js.gif border=0 width=16 height=16lign=absmiddle>$file</a>

157 </
td
>

158 <
td
 
ass
='low'>
$fesize
 
KB
</td>

159 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

160 </

>";

161 
echo
 "$line";

163 if(
	`egi
("\.(jpg)",
$fe
)){

165 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

166 
$ly
 = "";

168 
$u
 = "$activeurl/$file";

170 
$u
 = 
	`eg_a
("\.\.","",$reurl);

171 
$u
 = 
	`eg_a
(
$md
."/","",$reurl);

173 
$le
 = "\n<tr>

174 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

175 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\" $lstyle><img src=img/jpg.gif border=0 width=16 height=16lign=absmiddle>$file</a>

176 </
td
>

177 <
td
 
ass
='low'>
$fesize
 
KB
</td>

178 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

179 </

>";

180 
echo
 "$line";

182 if(
	`egi
("\.(gif|g)",
$fe
)){

184 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

185 
$ly
 = "";

187 
$u
 = "$activeurl/$file";

189 
$u
 = 
	`eg_a
("\.\.","",$reurl);

190 
$u
 = 
	`eg_a
(
$md
."/","",$reurl);

192 
$le
 = "\n<tr>

193 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

194 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\" $lstyle><img src=img/gif.gif border=0 width=16 height=16lign=absmiddle>$file</a>

195 </
td
>

196 <
td
 
ass
='low'>
$fesize
 
KB
</td>

197 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

198 </

>";

199 
echo
 "$line";

201 if(
	`egi
("\.xt)",
$fe
)){

203 if(
$fe
==
$comeback

$ly
 = " style='color:red' ";

204 
$ly
 = "";

206 
$u
 = "$activeurl/$file";

208 
$u
 = 
	`eg_a
("\.\.","",$reurl);

209 
$u
 = 
	`eg_a
(
$md
."/","",$reurl);

211 
$le
 = "\n<tr>

212 <
td
 
ass
='low' 
bgc
='#F9FBF0'>

213 <
a
 
hf
=\"javascript:ReturnValue('$reurl');\" $lstyle><img src=img/txt.gif border=0 width=16 height=16lign=absmiddle>$file</a>

214 </
td
>

215 <
td
 
ass
='low'>
$fesize
 
KB
</td>

216 <
td
 
ign
='' 
ass
='low' 
bgc
='#F9FBF0'>
$fime
</td>

217 </

>";

218 
echo
 "$line";

220 
	}
}

221 
	g$dh
->
o
();

224 <
	g
>

225 <
td
 
	gcޥ
='3' 
bgc
='#E8F1DE'>

227 <
b
 
width
='100%'>

228 <
fm
 
ai
='_ms_po.php' 
mhod
='POST' 
y
="muɝt/fm-da" 
me
='myform'>

229 <
put
 
ty
='hidd' 
me
='aivh' 
vue
='<?phpcho $activepath?>'>

230 <
put
 
ty
='hidd' 
me
='f' 
vue
='<?phpcho $f?>'>

231 <
put
 
ty
='hidd' 
me
='job' 
vue
='upload'>

232 <

>

233 <
td
 
background
="img/tbg.gif" 
bgc
="#99CC00">

234 &
nb
;上　传： <
put
 
	gty
='fe' 
me
='udfe' 
y
='width:320px'>

235 改名：<
put
 
ty
='xt' 
me
='fame' 
vue
='' 
y
='width:100px'>

236 <
put
 
ty
='subm' 
me
='sb1' 
vue
='确定'>

237 </
td
>

238 </

>

239 </
fm
>

240 </
b
>

242 </
td
>

243 </

>

244 </
b
>

246 </
td
>

247 </

>

248 </
b
>

250 </
body
>

251 </
html
>

	@include/dialog/select_templets_post.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
	g$cfg_txy
 = "htm|html|tpl|txt";

4 if(
	$emy
(
$udfe
))

6 
$udfe
 = "";

7 
	}
}

8 if(!
	$is_uded_fe
(
$udfe
))

10 
	`ShowMsg
("你没有选择上传的文件!","-1");

11 
	`ex
();

12 
	}
}

13 if(!
eg
("^xt",
$udfe_ty
))

15 
ShowMsg
("你上传的不是文本类型附件!","-1");

16 
ex
();

18 if(!
egi
("\.(".
$cfg_txy
.")",
$udfe_me
))

20 
ShowMsg
("你所上传的模板文件类型不能被识别，只允许htm、html、tpl、txt扩展名！","-1");

21 
ex
();

23 if(
	g$fame
!='')

25 
$fame
 = 
im
(
eg_a
("[ \r\n\t\*\%\\/\?><\|\":]{1,}",'',$filename));

29 
	g$udfe_me
 = 
im
(
eg_a
("[ \r\n\t\*\%\\/\?><\|\":]{1,}",'',
$udfe_me
));

30 
	g$fame
 = 
$udfe_me
;

31 if(
	g$fame
=='' || !
egi
("\.(".
$cfg_txy
.")",
$fame
))

33 
ShowMsg
("你所上传的文件存在问题，请检查文件类型是否适合！","-1");

34 
ex
();

37 
	g$fufame
 = 
$cfg_bad
.
$aivh
."/".
$fame
;

38 
	$move_uded_fe
(
$udfe
,
$fufame


 
	`d
("上传文件到 $fullfilename 失败！");

39 @
	`uƚk
(
$udfe
);

40 
	`ShowMsg
("成功上传文件！","_ms.php?comeback=".
	`ucode
(
$fame
)."&f=$f&aivh=".ucode(
$aivh
)."&d=".
	`time
());

41 
	`ex
();

	@include/diyform.cls.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
('forbidden');

6 
que_
 
	gDEDEINC
.'/dedetag.class.php';

7 
que_
 
	gDEDEINC
.'/customfields.func.php';

9 as
	cdiyfm


11 
v
 
	m$diyid
;

12 
v
 
	m$db
;

13 
v
 
	m$fo
;

14 
v
 
	m$me
;

15 
v
 
	m$b
;

16 
v
 
	m$public
;

17 
v
 
	m$liTeme
;

18 
v
 
	m$vwTeme
;

19 
v
 
	m$poTeme
;

21 
funi
 
	$diyfm
(
$diyid
){

22 
$this
->
	`__cڡru
(
$diyid
);

24 
funi
 
	$__cڡru
(
$diyid
){

25 
$this
->
diyid
 = 
$diyid
;

26 
$this
->
db
 = 
$GLOBALS
['dsql'];

27 
$quy
 = "select * from #@__diyforms where diyid='{$diyid}'";

28 
$diyfo
 = 
$this
->
db
->
	`ge
(
$quy
);

29 if(!
	`is_y
(
$diyfo
))

31 
	`showMsg
('参数不正确，该自定义表单不存在','javascript:;');

32 
	`ex
();

34 
$this
->
fo
 = 
$diyfo
['info'];

35 
$this
->
me
 = 
$diyfo
['name'];

36 
$this
->
b
 = 
$diyfo
['table'];

37 
$this
->
public
 = 
$diyfo
['public'];

38 
$this
->
liTeme
 = 
$diyfo
['lime'] !'' && 
	`fe_exis
(
DEDEINC
.'/../templets/plus/'.$diyinfo['listtemplate']) ? $diyinfo['listtemplate'] : 'list_diyform.htm';

39 
$this
->
vwTeme
 = 
$diyfo
['vwme'] !'' && 
	`fe_exis
(
DEDEINC
.'/../templets/plus/'.$diyinfo['viewtemplate']) ? $diyinfo['viewtemplate'] : 'view_diyform.htm';;

40 
$this
->
poTeme
 = 
$diyfo
['pome'] !'' && 
	`fe_exis
(
DEDEINC
.'/../templets/plus/'.$diyinfo['posttemplate']) ? $diyinfo['posttemplate'] : 'post_diyform.htm';;

41 
	}
}

43 
funi
 
gFm
(
$ty
 = 'po', 
$vue
 = '', 
$admty
='diy')

45 
glob
 
$cfg_cook_code
;

46 
	g$d
 = 
w
 
DedeTagP
();

47 
	g$d
->
SNameS
("field","<",">");

48 
	g$d
->
LdSour
(
$this
->
fo
);

49 
	g$fmrg
 = '';

50 
	g$fmflds
 = '';

51 
	g$func
 = 
$ty
 == 'post' ? 'GetFormItem' : 'GetFormItemValue';

52 if(
is_y
(
$d
->
CTags
))

54 
fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$g
)

56 if(
$g
->
GA
('autofield'))

58 if(
$ty
 == 'post')

60 
$fmrg
 .
$func
(
$g
,
$admty
);

64 
	g$fmrg
 .
$func
(
$g
,
htmleclchs
(
$vue
[$g->
GName
()],
ENT_QUOTES
),
$admty
);

66 
	g$fmflds
 .
$fmflds
 ='' ? 
$g
->
GName
().','.$g->
GA
('type') : ';'.$tag->GetName().','.$tag->GetAtt('type');

71 
	g$fmrg
 ."<puty=\"hidd\"ame=\"dede_flds\" vue=\"".
$fmflds
."\" />\n";

72 
	g$fmrg
 ."<puty=\"hidd\"ame=\"dede_fldshash\" vue=\"".
md5
(
$fmflds
.
$cfg_cook_code
)."\" />";

73  
	g$fmrg
;

76 
funi
 
	$gFldLi
()

78 
$d
 = 
w
 
	`DedeTagP
();

79 
$d
->
	`SNameS
("field","<",">");

80 
$d
->
	`LdSour
(
$this
->
fo
);

81 
$flds
 = 
	`y
();

82 if(
	`is_y
(
$d
->
CTags
))

84 
	`fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$g
)

86 
$flds
[
$g
->
	`GName
()] = 
	`y
($g->
	`GA
('itemname'), $tag->GetAtt('type'));

89  
$flds
;

90 
	}
}

	@include/downmix.inc.php

1 <?
php


2 
funi
 
	$RndSg
(&
$body
)

5 
$maxpos
 = 1024;

8 
$ftC
 = "#FFFFFF";

11 
$1
 = 
	`chr
(
	`mt_nd
(
	`d
('A'),ord('Z'))).chr(mt_rand(ord('a'),ord('z'))).chr(mt_rand(ord('a'),ord('z'))).mt_rand(100,999);

12 
$2
 = 
	`chr
(
	`mt_nd
(
	`d
('A'),ord('Z'))).chr(mt_rand(ord('a'),ord('z'))).chr(mt_rand(ord('a'),ord('z'))).mt_rand(100,999);

13 
$3
 = 
	`chr
(
	`mt_nd
(
	`d
('A'),ord('Z'))).chr(mt_rand(ord('a'),ord('z'))).chr(mt_rand(ord('a'),ord('z'))).mt_rand(100,999);

14 
$4
 = 
	`chr
(
	`mt_nd
(
	`d
('A'),ord('Z'))).chr(mt_rand(ord('a'),ord('z'))).chr(mt_rand(ord('a'),ord('z'))).mt_rand(100,999);

15 
$dy
[1]['value'] = ".{$st1} { display:none; }";

16 
$dy
[1]['me'] = 
$1
;

17 
$dy
[2]['value'] = ".{$st2} { display:none; }";

18 
$dy
[2]['me'] = 
$2
;

19 
$dy
[3]['value'] = ".{$st3} { display:none; }";

20 
$dy
[3]['me'] = 
$3
;

21 
$dy
[4]['value'] = ".{$st4} { display:none; }";

22 
$dy
[4]['me'] = 
$4
;

23 
$mdd
 = 
	`mt_nd
(1,4);

24 
$dyVue
 = 
$dy
[
$mdd
]['value'];

25 
$dyName
 = 
$dy
[
$mdd
]['name'];

26 
$Sg
 = "<style> $rndstyleValue </style>\r\n";

29 
$dem
[1] = 'font';

30 
$dem
[2] = 'div';

31 
$dem
[3] = 'span';

32 
$dem
[4] = 'p';

35 
$
 = 
	`fݒ
(
DEDEDATA
.'/downmix.data.php','r');

36 
$t
 = 0;

37 
$tٮem
 = 0;

39 !
	`of
(
$
))

41 
$v
 = 
	`im
(
	`fgs
(
$
,128));

42 if(
$t
==1)

44 if(
	`eg
("#d#",
$v
))

48 if(
$v
!='')

50 
$tٮem
++; 
$drg
[$tٮem] = 
	`eg_a
("#,","",
$v
);

53 if(
	`eg
("#t#",
$v
))

55 
$t
 = 1;

58 
	`fo
(
$
);

61 
$bodyn
 = 
	`
(
$body
) - 1;

62 
$os
 = 0;

63 
$i
=0;$i<=
$bodyn
;$i++)

65 if(
$i
+2 >
$bodyn
 || $i<50)

67 
$Sg
 .
$body
[
$i
];

71 
$ag
 = @
	`ow
(
$body
[
$i
].$body[$i+1].$body[$i+2]);

72 if(
$ag
=='</p' || ($ag=='<br' && 
$i
-
$os
>
$maxpos
) )

74 
$dd
 = 
	`mt_nd
(1,4);

75 
$emme
 = 
$dem
[
$dd
];

76 
$dd
 = 
	`mt_nd
(1,
$tٮem
);

77 
$r
 = 
$drg
[
$dd
];

78 if(
$emme
!='font')

80 
$r
 = " <$emname class='$rndstyleName'>$rnstr</$emname> ";

84 
$r
 = " <font color='$fontColor'>$rnstr</font> ";

86 
$Sg
 .
$r
.
$body
[
$i
];

87 
$os
 = 
$i
;

91 
$Sg
 .
$body
[
$i
];

95  
$Sg
;

96 
	}
}

	@include/enums.func.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
("Request Error!");

5 if(!
fe_exis
(
DEDEDATA
.'/enums/system.php'))

7 
WreEnumsCache
();

11 
funi
 
WreEnumsCache
(
$egroup
='')

13 
glob
 
$dsql
;

14 
	g$egroups
 = 
y
();

15 if(
	g$egroup
=='') {

16 
$dsql
->
SQuy
("Selectgroup From `#@__sys_enum` group bygroup ");

19 
	g$dsql
->
SQuy
("Selectgroup From `#@__sys_enum` wheregroup='$egroup' group bygroup ");

21 
	g$dsql
->
Execu
('enum');

22 
	g$ow
 = 
$dsql
->
GAay
('enum')) {

23 
$egroups
[] = 
$ow
['egroup'];

25 
fܗch
(
$egroups
 
as
 
$egroup
)

27 
	g$chefe
 = 
DEDEDATA
.'/ums/'.
$egroup
.'.php';

28 
	g$
 = 
fݒ
(
$chefe
,'w');

29 
fwre
(
$
,'<'."?php\r\nglobal \$em_{$egroup}s;\r\n\$em_{$egroup}s =rray();\r\n");

30 
	g$dsql
->
SQuy
("Selectname,evalue,issign From `#@__sys_enum` wheregroup='$egroup' order by disordersc,valuesc ");

31 
	g$dsql
->
Execu
('enum');

32 
	g$issign
 = -1;

33 
	g$ow
 = 
$dsql
->
GAay
('enum'))

35 
fwre
(
$
,"\$em_{$egroup}s[{$nrow['evalue']}] = '{$nrow['ename']}';\r\n");

36 if(
	g$issign
==-1
$issign
 = 
$ow
['issign'];

38 
fwre
(
$
,'?'.'>');

39 
fo
(
$
);

40 if(
emy
(
$issign
)
WreEnumsJs
(
$egroup
);

46 
funi
 
	$GEnumsTys
(
$v
)

48 
$r
['top'] = $rearr['son'] = 0;

49 if(
$v
==0 
$r
;

50 if(
$v
%500==0) {

51 
$r
['t'] = 
$v
;

54 
$r
['s'] = 
$v
;

55 
$r
['t'] = 
$v
 - ($v%500);

57  
$r
;

58 
	}
}

61 
funi
 
GEnumsFm
(
$egroup
,
$evue
=0,
$fmid
='',
$ə
='')

63 
$chefe
 = 
DEDEDATA
.'/ums/'.
$egroup
.'.php';

64 
ude
(
$chefe
);

65 if(
	g$fmid
=='')

67 
$fmid
 = 
$egroup
;

69 
	g$fms
 = "<selectame='$formid' id='$formid' class='enumselect'>\r\n";

70 
	g$fms
 .= "\t<option value='0' selected='selected'>--请选择--{$seltitle}</option>\r\n";

71 
fܗch
(
$
{'em_'.
$egroup
.'s'} 
as
 
$v
=>
$n
)

73 
$efix
 = (
$v
 > 500 && $v%500 != 0) ? '└─ ' : '';

74 if(
	g$v
==
$evue
)

76 
$fms
 .= "\t<option value='$v' selected='selected'>$prefix$n</option>\r\n";

80 
	g$fms
 .= "\t<option value='$v'>$prefix$n</option>\r\n";

83 
	g$fms
 .= "</select>";

84  
	g$fms
;

88 
funi
 
	$gTDa
(
$egroup
)

90 
$da
 = 
	`y
();

91 
$chefe
 = 
DEDEDATA
.'/ums/'.
$egroup
.'.php';

92 
	`ude
(
$chefe
);

93 
	`fܗch
(
$
{'em_'.
$egroup
.'s'} 
as
 
$k
=>
$v
)

95 if(
$k
 >= 500 && $k%500 == 0) {

96 
$da
[
$k
] = 
$v
;

99  
$da
;

100 
	}
}

104 
funi
 
	$GEnumsJs
(
$egroup
)

106 
glob
 
$
{'em_'.
$egroup
.'s'};

107 
	`ude_
(
DEDEDATA
.'/ums/'.
$egroup
.'.php');

108 
$jsCode
 = "<!--\r\n";

109 
$jsCode
 .= "em_{$egroup}s=new Array();\r\n";

110 
	`fܗch
(
$
{'em_'.
$egroup
.'s'} 
as
 
$k
 => 
$v
)

112 
$jsCode
 .= "em_{$egroup}s[$k]='$v';\r\n";

114 
$jsCode
 .= "-->";

115  
$jsCode
;

116 
	}
}

118 
funi
 
	$WreEnumsJs
(
$egroup
)

120 
$jsfe
 = 
DEDEDATA
.'/ums/'.
$egroup
.'.js';

121 
$
 = 
	`fݒ
(
$jsfe
, 'w');

122 
	`fwre
(
$
, 
	`GEnumsJs
(
$egroup
));

123 
	`fo
(
$
);

124 
	}
}

128 
funi
 
	$GEnumsVue
(
$egroup
,
$evue
=0)

130 
	`ude_
(
DEDEDATA
.'/ums/'.
$egroup
.'.php');

131 if(
	`ist
(
$
{'em_'.
$egroup
.'s'}[
$evue
])) {

132  
$
{'em_'.
$egroup
.'s'}[
$evue
];

137 
	}
}

	@include/filter.inc.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
	$_FrA
(
$fk
,&
$sv
)

9 
glob
 
$cfg_nٮlowr
,
$cfg_ar
;

10 if
	`is_y
(
$sv
) )

12 
	`fܗch
(
$sv
 
as
 
$_k
 => 
$_v
)

14 
$sv
[
$_k
] = 
	`_FrA
(
$fk
,
$_v
);

19 if(
$cfg_nٮlowr
!='' && 
	`egi
($cfg_nٮlowr,
$sv
))

21 
	`ShowMsg
(" $fk hasotllow words!",'-1');

22 
	`ex
();

24 if(
$cfg_ar
!='')

26 
$sv
 = 
	`egi_a
(
$cfg_ar
,"***",$svar);

29  
$sv
;

30 
	}
}

32 
fܗch
(
Aay
('_GET','_POST','_COOKIE'
as
 
$_que
)

34 
fܗch
(
$$_que
 
as
 
$_k
 => 
$_v
)

36 
$
{
$_k
} = 
_FrA
($_k,
$_v
);

	@include/image.class.php

1 <?
php


2 as
	cimage


4 
v
 
	m$chfo
;

5 
v
 
	m$rgfe
;

6 
v
 
	m$imageomfunc
;

7 
v
 
	m$imagefunc
;

8 
v
 
	m$ch
;

9 
v
 
	m$imedgif
;

10 
v
 
	m$wmkquy
;

11 
v
 
	m$wmkxt
;

12 
v
 
	m$thumbus
;

13 
v
 
	m$wmkus
;

15 
funi
 
image
(
$rgfe
, 
$cfg_thumb
, 
$cfg_wmkxt
, 
$pho_wpos
, 
$pho_dphey
, 
$pho_wheight
, 
$pho_wwidth
, 
$cfg_wmkty
, 
$pho_mks
,
$ueMkimg
, 
$ch
 = 
	$y
())

17 
$this
->
	`__cڡru
(
$rgfe
, 
$cfg_thumb
, 
$cfg_wmkxt
, 
$pho_wpos
, 
$pho_dphey
, 
$pho_wheight
, 
$pho_wwidth
, 
$cfg_wmkty
, 
$pho_mks
,
$ueMkimg
, 
$ch
);

20 
funi
 
	`__cڡru
(
$rgfe
, 
$cfg_thumb
, 
$cfg_wmkxt
, 
$pho_wpos
, 
$pho_dphey
, 
$pho_wheight
, 
$pho_wwidth
, 
$cfg_wmkty
, 
$pho_mks
,
$ueMkimg
, 
$ch
 = 
	$y
())

22 
$this
->
thumbus
 = 
$cfg_thumb
;

23 
$this
->
wmkxt
 = 
$cfg_wmkxt
;

24 
$this
->
wmkus
 = 
$pho_wpos
;

25 
$this
->
wmkquy
 = 
$pho_mks
;

26 
$this
->
wmkmwidth
 = 
$pho_wwidth
;

27 
$this
->
wmkmheight
 = 
$pho_wheight
;

28 
$this
->
wmkty
 = 
$cfg_wmkty
;

29 
$this
->
wmks
 = 
$pho_dphey
;

30 
$this
->
imedgif
 = 0;

31 
$this
->
rgfe
 = 
$rgfe
;

32 
$this
->
chfo
 = @
	`gimagesize
(
$rgfe
);

33 
$this
->
ch
 = 
$ch
;

36 
$this
->
chfo
['mime'])

39 
$this
->
imageomfunc
 = 
	`funi_exis
('imagecreatefromjpeg') ? 'imagecreatefromjpeg' : '';

40 
$this
->
imagefunc
 = 
	`funi_exis
('imagejpeg') ? 'imagejpeg' : '';

43 
$this
->
imageomfunc
 = 
	`funi_exis
('imagecreatefromgif') ? 'imagecreatefromgif' : '';

44 
$this
->
imagefunc
 = 
	`funi_exis
('imagegif') ? 'imagegif' : '';

47 
$this
->
imageomfunc
 = 
	`funi_exis
('imagecreatefrompng') ? 'imagecreatefrompng' : '';

48 
$this
->
imagefunc
 = 
	`funi_exis
('imagepng') ? 'imagepng' : '';

52 
$this
->
ch
['size'] = 
	`emy
($this->ch['size']? @
	`fesize
(
$rgfe
) : $this->attach['size'];

53 if(
$this
->
chfo
['mime'] == 'image/gif')

55 
$
 = 
	`fݒ
(
$rgfe
, 'rb');

56 
$rgfecڋ
 = 
	`d
(
$
, 
$this
->
ch
['size']);

57 
	`fo
(
$
);

58 
$this
->
imedgif
 = 
	`os
(
$rgfecڋ
, 'NETSCAPE2.0'==
l
 ? 0 : 1;

60 
	}
}

62 
funi
 
	$thumb
(
$thumbwidth
, 
$thumbheight
, 
$evw
 = 0)

64 
$this
->
	`thumb_gd
(
$thumbwidth
, 
$thumbheight
, 
$evw
);

66 if(
$this
->
thumbus
 =2 && $this->
wmkus
)

68 
$this
->
	`image
($this->
rgfe
, $this->
ch
);

69 
$this
->
ch
['size'] = 
	`fesize
($this->
rgfe
);

71 
	}
}

73 
funi
 
	$wmk
(
$evw
 = 0)

75 if(
$this
->
wmkmwidth
 && $this->
chfo
[0] <$this->wmkmwidth && $this->
wmkmheight
 && $this->attachinfo[1] <= $this->watermarkminheight)

79 
$this
->
	`wmk_gd
(
$evw
);

80 
	}
}

82 
funi
 
	$thumb_gd
(
$thumbwidth
, 
$thumbheight
, 
$evw
 = 0)

85 if(
$this
->
thumbus
 && 
	`funi_exis
('imagecreatetruecolor') && function_exists('imagecopyresampled') && function_exists('imagejpeg'))

87 
$imageomfunc
 = 
$this
->
imageomfunc
;

88 
$imagefunc
 = 
$this
->
thumbus
 =1 ? 'imagejg' : $this->
imagefunc
;

89 
	`li
(
$imagewidth
, 
$imageheight

$this
->
chfo
;

90 if(!
$this
->
imedgif
 && (
$imagewidth
 >
$thumbwidth
 || 
$imageheight
 >
$thumbheight
))

92 
$ch_pho
 = 
	`$imageomfunc
(
$this
->
rgfe
);

93 
$x_tio
 = 
$thumbwidth
 / 
$imagewidth
;

94 
$y_tio
 = 
$thumbheight
 / 
$imageheight
;

95 if((
$x_tio
 * 
$imageheight
< 
$thumbheight
)

97 
$thumb
['height'] = 
	`
(
$x_tio
 * 
$imageheight
);

98 
$thumb
['width'] = 
$thumbwidth
;

102 
$thumb
['width'] = 
	`
(
$y_tio
 * 
$imagewidth
);

103 
$thumb
['height'] = 
$thumbheight
;

105 
$rgfe
 = !
$evw
 ? (
$this
->
thumbus
 =1 ? $this->
rgfe
.'.thumb.jpg' : $this->targetfile) : './watermark_tmp.jpg';

106 
$thumb_pho
 = 
	`imageuec
(
$thumb
['width'], $thumb['height']);

107 
	`imagecymed
(
$thumb_pho
, 
$ch_pho
, 0, 0, 0, 0, 
$thumb
['width'], $thumb['height'], 
$imagewidth
, 
$imageheight
);

108 if(
$this
->
chfo
['mime'] == 'image/jpeg')

110 
	`$imagefunc
(
$thumb_pho
, 
$rgfe
, 100);

114 
	`$imagefunc
(
$thumb_pho
, 
$rgfe
);

116 
$this
->
ch
['thumb'] = $this->
thumbus
 == 1 ? 1 : 0;

119 
	}
}

121 
funi
 
	$wmk_gd
(
$evw
 = 0)

123 if(
$this
->
wmkus
 && 
	`funi_exis
('imagecopy') && function_exists('imagealphablending') && function_exists('imagecopymerge'))

125 
$imagefunc
 = 
$this
->
imageomfunc
;

126 
$imagefunc
 = 
$this
->
imagefunc
;

127 
	`li
(
$imagewidth
, 
$imageheight

$this
->
chfo
;

128 if(
$this
->
wmkty
 < 2)

130 
$wmk_fe
 = 
$this
->
wmkty
 =1 ? 
DEDEROOT
.'/data/mark/mark.png' : DEDEROOT.'/data/mark/mark.gif';

131 
$wmkfo
 = @
	`gimagesize
(
$wmk_fe
);

132 
$wmk_logo
 = 
$this
->
wmkty
 =1 ? @
	`imageomg
(
$wmk_fe
: @
	`imageomgif
($watermark_file);

133 if(!
$wmk_logo
)

137 
	`li
(
$logowidth
, 
$logoheight

$wmkfo
;

141 
$box
 = @
	`imagtfbbox
(
$this
->
wmkxt
['size'], $this->watermarktext['angle'], $this->watermarktext['fontpath'],$this->watermarktext['text']);

142 
$logowidth
 = 
	`max
(
$box
[2], $box[4]- 
	`m
($box[0], $box[6]);

143 
$logoheight
 = 
	`max
(
$box
[1], $box[3]- 
	`m
($box[5], $box[7]);

144 
$ax
 = 
	`m
(
$box
[0], $box[6]) * -1;

145 
$ay
 = 
	`m
(
$box
[5], $box[7]) * -1;

147 
$wmwidth
 = 
$imagewidth
 - 
$logowidth
;

148 
$wmheight
 = 
$imageheight
 - 
$logoheight
;

149 if((
$this
->
wmkty
 < 2 && 
	`is_adab
(
$wmk_fe
|| $this->wmkty =2&& 
$wmwidth
 > 10 && 
$wmheight
 > 10 && !$this->
imedgif
)

151 
$this
->
wmkus
)

155 
$x
 = +5;

156 
$y
 = +5;

159 
$x
 = (
$imagewidth
 - 
$logowidth
) / 2;

160 
$y
 = +5;

163 
$x
 = 
$imagewidth
 - 
$logowidth
 - 5;

164 
$y
 = +5;

167 
$x
 = +5;

168 
$y
 = (
$imageheight
 - 
$logoheight
) / 2;

171 
$x
 = (
$imagewidth
 - 
$logowidth
) / 2;

172 
$y
 = (
$imageheight
 - 
$logoheight
) / 2;

175 
$x
 = 
$imagewidth
 - 
$logowidth
 - 5;

176 
$y
 = (
$imageheight
 - 
$logoheight
) / 2;

179 
$x
 = +5;

180 
$y
 = 
$imageheight
 - 
$logoheight
 - 5;

183 
$x
 = (
$imagewidth
 - 
$logowidth
) / 2;

184 
$y
 = 
$imageheight
 - 
$logoheight
 - 5;

187 
$x
 = 
$imagewidth
 - 
$logowidth
 - 5;

188 
$y
 = 
$imageheight
 - 
$logoheight
 -5;

191 
$d_pho
 = @
	`imageuec
(
$imagewidth
, 
$imageheight
);

192 
$rg_pho
 = 
	`$imagefunc
(
$this
->
rgfe
);

193 
	`imagecy
(
$d_pho
, 
$rg_pho
, 0, 0, 0, 0, 
$imagewidth
, 
$imageheight
);

194 if(
$this
->
wmkty
 == 1)

196 
	`imagecy
(
$d_pho
, 
$wmk_logo
, 
$x
, 
$y
, 0, 0, 
$logowidth
, 
$logoheight
);

198 
	`if
(
$this
->
wmkty
 == 2)

200 if((
$this
->
wmkxt
['shadowx'] || $this->watermarktext['shadowy']) && $this->watermarktext['shadowcolor'])

202 
$shadowcrgb
 = 
	`exode
(',', 
$this
->
wmkxt
['shadowcolor']);

203 
$shadowc
 = 
	`imagecܮlo
(
$d_pho
, 
$shadowcrgb
[0], $shadowcolorrgb[1], $shadowcolorrgb[2]);

204 
	`imagtext
(
$d_pho
, 
$this
->
wmkxt
['size'], $this->watermarktext['angle'],

205 
$x
 + 
$ax
 + 
$this
->
wmkxt
['shadowx'], 
$y
 + 
$ay
 + $this->wmkxt['shadowy'], 
$shadowc
,

206 
$this
->
wmkxt
['fontpath'], $this->watermarktext['text']);

208 
$crgb
 = 
	`exode
(',', 
$this
->
wmkxt
['color']);

209 
$c
 = 
	`imagecܮlo
(
$d_pho
, 
$crgb
[0], $colorrgb[1], $colorrgb[2]);

210 
	`imagtext
(
$d_pho
, 
$this
->
wmkxt
['size'], $this->watermarktext['angle'],

211 
$x
 + 
$ax
, 
$y
 + 
$ay
, 
$c
, 
$this
->
wmkxt
['fontpath'], $this->watermarktext['text']);

215 
	`imaghabndg
(
$wmk_logo
, 
ue
);

216 
	`imagecymge
(
$d_pho
, 
$wmk_logo
, 
$x
, 
$y
, 0, 0, 
$logowidth
, 
$logoheight
, 
$this
->
wmks
);

218 
$rgfe
 = !
$evw
 ? 
$this
->
rgfe
 : './watermark_tmp.jpg';

219 if(
$this
->
chfo
['mime'] == 'image/jpeg')

221 
	`$imagefunc
(
$d_pho
, 
$rgfe
, 
$this
->
wmkquy
);

225 
	`$imagefunc
(
$d_pho
, 
$rgfe
);

227 
$this
->
ch
['size'] = 
	`fesize
($this->
rgfe
);

230 
	}
}

	@include/image.func.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
ude
(
DEDEDATA
.'/mark/inc_photowatermark_config.php');

8 
glob
 
	g$cfg_pho_ty
,
	g$cfg_pho_tymes
,
	g$cfg_pho_sut
;

9 
	g$cfg_pho_ty
['gif'] = 
l
;

10 
	g$cfg_pho_ty
['jg'] = 
l
;

11 
	g$cfg_pho_ty
['g'] = 
l
;

12 
	g$cfg_pho_ty
['wbmp'] = 
l
;

13 
	g$cfg_pho_tymes
 = 
Aay
();

14 
	g$cfg_pho_sut
 = '';

15 if(
funi_exis
("imagecreatefromgif") && function_exists("imagegif"))

17 
	g$cfg_pho_ty
["gif"] = 
ue
;

18 
	g$cfg_pho_tymes
[] = "image/gif";

19 
	g$cfg_pho_sut
 .= "GIF ";

21 if(
funi_exis
("imagecreatefromjpeg") && function_exists("imagejpeg"))

23 
	g$cfg_pho_ty
["jg"] = 
ue
;

24 
	g$cfg_pho_tymes
[] = "image/pjpeg";

25 
	g$cfg_pho_tymes
[] = "image/jpeg";

26 
	g$cfg_pho_sut
 .= "JPEG ";

28 if(
funi_exis
("imagecreatefrompng") && function_exists("imagepng"))

30 
	g$cfg_pho_ty
["g"] = 
ue
;

31 
	g$cfg_pho_tymes
[] = "image/png";

32 
	g$cfg_pho_tymes
[] = "image/xpng";

33 
	g$cfg_pho_sut
 .= "PNG ";

35 if(
funi_exis
("imagecreatefromwbmp") && function_exists("imagewbmp"))

37 
	g$cfg_pho_ty
["wbmp"] = 
ue
;

38 
	g$cfg_pho_tymes
[] = "image/wbmp";

39 
	g$cfg_pho_sut
 .= "WBMP ";

44 
funi
 
ImageResize
(
$cFe
,
$toW
,
$toH
,
$toFe
="")

46 
glob
 
$cfg_pho_ty
;

47 if(
	g$toFe
==''
$toFe
 = 
$cFe
;

48 
	g$fo
 = '';

49 
	g$cInfo
 = 
GImageSize
(
$cFe
,
$fo
);

50 
	g$cInfo
[2])

53 if(!
$cfg_pho_ty
['gif'] 
l
;

54 
	g$im
 = 
imageomgif
(
$cFe
);

57 if(!
$cfg_pho_ty
['jg'] 
l
;

58 
	g$im
 = 
imageomjg
(
$cFe
);

61 if(!
$cfg_pho_ty
['g'] 
l
;

62 
	g$im
 = 
imageomg
(
$cFe
);

65 if(!
$cfg_pho_ty
['bmp'] 
l
;

66 
	g$im
 = 
imageomwbmp
(
$cFe
);

69 
	g$cW
=
ImageSX
(
$im
);

70 
	g$cH
=
ImageSY
(
$im
);

71 if(
	g$cW
<=
$toW
 && 
$cH
<=
$toH
 )  
ue
;

72 
	g$toWH
=
$toW
/
$toH
;

73 
	g$cWH
=
$cW
/
$cH
;

74 if(
	g$toWH
<=
$cWH
)

76 
$oW
=
$toW
;

77 
	g$oH
=
$oW
*(
$cH
/
$cW
);

81 
	g$oH
=
$toH
;

82 
	g$oW
=
$oH
*(
$cW
/
$cH
);

84 if(
	g$cW
>
	g$toW
||
	g$cH
>
	g$toH
)

86 if(
funi_exis
("imagecreatetruecolor"))

88 @
	g$ni
 = 
imageuec
(
$oW
,
$oH
);

89 if(
	g$ni
)

91 
imagecymed
(
$ni
,
$im
,0,0,0,0,
$oW
,
$oH
,
$cW
,
$cH
);

95 
	g$ni
=
image
(
$oW
,
$oH
);

96 
imagecysized
(
$ni
,
$im
,0,0,0,0,
$oW
,
$oH
,
$cW
,
$cH
);

101 
	g$ni
=
image
(
$oW
,
$oH
);

102 
imagecysized
(
$ni
,
$im
,0,0,0,0,
$oW
,
$oH
,
$cW
,
$cH
);

104 
	g$cInfo
[2])

107 
imagegif
(
$ni
,
$toFe
);

110 
imagejg
(
$ni
,
$toFe
,100);

113 
imagng
(
$ni
,
$toFe
);

116 
imagebmp
(
$ni
,
$toFe
);

119  
l
;

121 
imagederoy
(
$ni
);

123 
imagederoy
(
$im
);

124  
	gue
;

128 
funi
 
	$gdvsi
()

131 if(!
	`funi_exis
('phpinfo'))

133 if(
	`funi_exis
('imagecreate'))

144 
	`ob_t
();

145 
	`phpfo
(8);

146 
$modu_fo
 = 
	`ob_g_cڋs
();

147 
	`ob_d_n
();

148 if(
	`eg_mch
("/\bgd\s+vsi\b[^\d\n\r]+?([\d\.]+)/i", 
$modu_fo
,
$mches
))

150 
$gdvsi_h
 = 
$mches
[1];

154 
$gdvsi_h
 = 0;

156  
$gdvsi_h
;

158 
	}
}

161 
funi
 
WImg
(
$cFe
,
$omGo
='up')

163 
ude
(
DEDEDATA
.'/mark/inc_photowatermark_config.php');

164 
que_
(
DEDEINC
.'/image.class.php');

165 if
ist
(
$GLOBALS
['needwatermark']) )

167 
	g$pho_mkup
 = 
$pho_mkdown
 = 
emy
(
$GLOBALS
['needwatermark']) ? '0' : '1';

169 if(
	g$pho_mkup
 !'1' || (
$omGo
=='c' && 
$pho_mkdown
!='1') )

173 
	g$fo
 = '';

174 
	g$cInfo
 = @
gimagesize
(
$cFe
,
$fo
);

175 
	g$cFe_w
 = 
$cInfo
[0];

176 
	g$cFe_h
 = 
$cInfo
[1];

178 if(
	g$cFe_w
 < 
	g$pho_wwidth
 || 
	g$cFe_h
 < 
	g$pho_wheight
)

182 if(
	g$omGo
=='up' && 
$pho_mkup
=='0')

186 if(
	g$omGo
=='down' && 
$pho_mkdown
=='0')

190 
	g$ueMkimg
 = 
DEDEDATA
.'/mk/'.
$pho_mkimg
;

191 if(!
fe_exis
(
$ueMkimg
|| 
emy
(
$pho_mkimg
))

193 
	g$ueMkimg
 = "";

195 if(
	g$pho_wpos
 == 0)

197 
$pho_wpos
 = 
nd
(1, 9);

199 
	g$cfg_wmkxt
 = 
y
();

200 if(
	g$pho_mkty
 == '2')

202 if(
fe_exis
(
DEDEDATA
.'/mark/simhei.ttf'))

204 
$cfg_wmkxt
['fڍh'] = 
DEDEDATA
.'/mark/simhei.ttf';

211 
	g$cfg_wmkxt
['xt'] = 
$pho_wxt
;

212 
	g$cfg_wmkxt
['size'] = 
$pho_ftsize
;

213 
	g$cfg_wmkxt
['angle'] = '0';

214 
	g$cfg_wmkxt
['color'] = '255,255,255';

215 
	g$cfg_wmkxt
['shadowx'] = '0';

216 
	g$cfg_wmkxt
['shadowy'] = '0';

217 
	g$cfg_wmkxt
['shadowcolor'] = '0,0,0';

218 
	g$img
 = 
w
 
image
(
$cFe
,0, 
$cfg_wmkxt
, 
$pho_wpos
, 
$pho_dphey
, 
$pho_wheight
, 
$pho_wwidth
, 
$pho_mkty
, 
$pho_mks
,
$ueMkimg
);

219 
	g$img
->
wmk
(0);

223 
funi
 
ImageResizeNew
(
$cFe
, 
$toW
, 
$toH
, 
$toFe
='', 
$isve
=
ue
)

225 
glob
 
$cfg_pho_ty
, 
$cfg_ddimg_bgc
;

226 if(
	g$toFe
==''
$toFe
 = 
$cFe
;

227 
	g$fo
 = '';

228 
	g$cInfo
 = 
GImageSize
(
$cFe
,
$fo
);

229 
	g$cInfo
[2])

232 if(!
$cfg_pho_ty
['gif'] 
l
;

233 
	g$img
 = 
imageomgif
(
$cFe
);

236 if(!
$cfg_pho_ty
['jg'] 
l
;

237 
	g$img
 = 
imageomjg
(
$cFe
);

240 if(!
$cfg_pho_ty
['g'] 
l
;

241 
	g$img
 = 
imageomg
(
$cFe
);

244 if(!
$cfg_pho_ty
['bmp'] 
l
;

245 
	g$img
 = 
imageomwbmp
(
$cFe
);

249 
	g$width
 = 
imageSX
(
$img
);

250 
	g$height
 = 
imageSY
(
$img
);

252 i(!
	g$width
 || !
	g$height
) {

253  
	gl
;

256 
	g$rg_width
 = 
$toW
;

257 
	g$rg_height
 = 
$toH
;

258 
	g$rg_tio
 = 
$rg_width
 / 
$rg_height
;

260 
	g$img_tio
 = 
$width
 / 
$height
;

262 i(
	g$rg_tio
 > 
	g$img_tio
) {

263 
	g$w_height
 = 
$rg_height
;

264 
	g$w_width
 = 
$img_tio
 * 
$rg_height
;

266 
	g$w_height
 = 
$rg_width
 / 
$img_tio
;

267 
	g$w_width
 = 
$rg_width
;

270 i(
	g$w_height
 > 
	g$rg_height
) {

271 
	g$w_height
 = 
$rg_height
;

273 i(
	g$w_width
 > 
	g$rg_width
) {

274 
	g$w_height
 = 
$rg_width
;

277 
	g$w_img
 = 
ImageCeTrueC
(
$rg_width
, 
$rg_height
);

279 if(
	g$cfg_ddimg_bgc
==0
$bgc
 = 
ImageCAo
(
$w_img
, 0xff, 0xff, 0xff);

280 
	g$bgc
 = 0;

282 i(!@
imagefdg
(
$w_img
, 0, 0, 
$rg_width
-1, 
$rg_height
-1, 
$bgc
))

284  
	gl
;

287 i(!@
imagecymed
(
$w_img
, 
$img
, (
$rg_width
-
$w_width
)/2, (
$rg_height
-
$w_height
)/2, 0, 0, $w_width, $w_height, 
$width
, 
$height
))

289  
	gl
;

293 if(
	g$isve
)

295 
	g$cInfo
[2])

298 
imagegif
(
$w_img
, 
$toFe
);

301 
imagejg
(
$w_img
, 
$toFe
,100);

304 
imagng
(
$w_img
, 
$toFe
);

307 
imagebmp
(
$w_img
, 
$toFe
);

310  
l
;

316 
	g$cInfo
[2])

319 
imagegif
(
$w_img
);

322 
imagejg
(
$w_img
);

325 
imagng
(
$w_img
);

328 
imagebmp
(
$w_img
);

331  
l
;

334 
imagederoy
(
$w_img
);

335 
imagederoy
(
$img
);

336  
	gue
;

	@include/inc/inc_fun_funAdmin.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
	$SpGPy
(
$r
,
$ishd
=0,
$iso
=1)

9 
glob
 
$pys
;

10 
$r
 = '';

11 
$r
 = 
	`im
($str);

12 
$
 = 
	`
(
$r
);

13 if(
$
<2)

15  
$r
;

17 if(
	`cou
(
$pys
)==0)

19 
$
 = 
	`fݒ
(
DEDEINC
.'/data/pinyin.dat','r');

20 !
	`of
(
$
))

22 
$le
 = 
	`im
(
	`fgs
(
$
));

23 
$pys
[
$le
[0].$le[1]] = 
	`subr
($le,3,
	`
($line)-3);

25 
	`fo
(
$
);

27 
$i
=0;$i<
$
;$i++)

29 if(
	`d
(
$r
[
$i
])>0x80)

31 
$c
 = 
$r
[
$i
].$str[$i+1];

32 
$i
++;

33 if(
	`ist
(
$pys
[
$c
]))

35 if(
$ishd
==0)

37 
$r
 .
$pys
[
$c
];

41 
$r
 .
$pys
[
$c
][0];

45 
$r
 .= "_";

47 }if
	`egi
("[a-z0-9]",
$r
[
$i
]) )

49 
$r
 .
$r
[
$i
];

53 
$r
 .= "_";

56 if(
$iso
==0)

58 
	`unt
(
$pys
);

60  
$r
;

61 
	}
}

63 
funi
 
	$SpCeD
(
$h
)

65 
glob
 
$cfg_d_purvw
,
$cfg_bad
,
$cfg_p_mkd
,
$isSaMode
;

66 if(
$h
=='')

68  
ue
;

70 
$k
 = 
l
;

71 
$uh
 = 
$cfg_bad
;

72 
$uh
 = 
	`r_a
("\\","/",$truepath);

73 
$hs
 = 
	`exode
("/",
$h
);

74 
$h
 = "";

75 
	`fܗch
(
$hs
 
as
 
$h
)

77 if(
$h
=="")

81 
$h
 = 
	`im
($spath);

82 
$uh
 ."/".
$h
;

83 if(!
	`is_d
(
$uh
|| !
	`is_wrb
($truepath))

85 if(!
	`is_d
(
$uh
))

87 
$isok
 = 
	`MkdA
(
$uh
,
$cfg_d_purvw
);

91 
$isok
 = 
	`ChmodA
(
$uh
,
$cfg_d_purvw
);

93 if(!
$isok
)

95 
echo
 "޸Ŀ¼".
$uh
." ʧܣ<br>";

96 
	`CloF
();

97  
l
;

101 
	`CloF
();

102  
ue
;

103 
	}
}

105 
funi
 
SpGEd
(
$ame
,
$fvue
,
$nheight
="350",
$y
="Basic",
$gty
="t",
$isfuηge
="false")

107 if(!
ist
(
$GLOBALS
['cfg_html_editor']))

109 
$GLOBALS
['cfg_html_editor']='fck';

111 if(
	g$gty
=="")

113 
$gty
 = "print";

115 if(
	g$GLOBALS
['cfg_html_editor']=='fck')

117 
que_
(
DEDEINC
.'/FCKeditor/fckeditor.php');

118 
	g$fck
 = 
w
 
FCKed
(
$ame
);

119 
	g$fck
->
	gBaPh
 = 
$GLOBALS
['cfg_cmspath'].'/include/FCKeditor/' ;

120 
	g$fck
->
	gWidth
 = '100%' ;

121 
	g$fck
->
	gHeight
 = 
$nheight
 ;

122 
	g$fck
->
	gTobS
 = 
$y
 ;

123 
	g$fck
->
	gCfig
['FuPage'] = 
$isfuηge
;

124 if(
	g$GLOBALS
['cfg_fck_xhtml']=='Y')

126 
$fck
->
Cfig
['EnableXHTML'] = 'true';

127 
	g$fck
->
	gCfig
['EnableSourceXHTML'] = 'true';

129 
	g$fck
->
	gVue
 = 
$fvue
 ;

130 if(
	g$gty
=="print")

132 
$fck
->
Ce
();

136  
	g$fck
->
CeHtml
();

141 
que_
(
DEDEINC
.'/htmledit/dede_editor.php');

142 
	g$ded
 = 
w
 
DedeEd
(
$ame
);

143 
	g$ded
->
	gBaPh
 = 
$GLOBALS
['cfg_cmspath'].'/include/htmledit/' ;

144 
	g$ded
->
	gWidth
 = '100%' ;

145 
	g$ded
->
	gHeight
 = 
$nheight
 ;

146 
	g$ded
->
	gTobS
 = 
ow
(
$y
);

147 
	g$ded
->
	gVue
 = 
$fvue
 ;

148 if(
	g$gty
=="print")

150 
$ded
->
Ce
();

154  
	g$ded
->
CeHtml
();

159 
funi
 
	$SpGNewInfo
()

161 
glob
 
$cfg_vsi
;

162 
$nu
 = 
$_SERVER
['HTTP_HOST'];

163 if
	`egi
("[a-z\-]{1,}\.[a-z]{2,}",
$nu
) ) {

164 
$nu
 = 
	`ucode
($nurl);

167 
$nu
 = "test";

169 
$offU
 = "http://www.de"."decms.com/newinfov5x.php?version={$cfg_version}&formurl={$nurl}";

170  
$offU
;

171 
	}
}

	@include/inc/inc_fun_funString.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
	$SpHtml2Text
(
$r
)

9 
$r
 = 
	`eg_a
("/<sty(.*)\\/style>|<scr(.*)\\/script>|<!--(.*)-->/isU","",$str);

10 
$ext
 = "";

11 
$t
 = 1;

12 
$i
=0;$i<
	`
(
$r
);$i++)

14 if(
$t
==0 && 
$r
[
$i
]==">")

16 
$t
 = 1;

18 if(
$t
==1)

20 if(
$r
[
$i
]=="<")

22 
$t
 = 0;

23 
$ext
 .= " ";

25 if(
	`d
(
$r
[
$i
])>31)

27 
$ext
 .
$r
[
$i
];

31 
$ext
 = 
	`r_a
("　"," ",$alltext);

32 
$ext
 = 
	`eg_a
("/&([^;&]*)(;|&)/","",$alltext);

33 
$ext
 = 
	`eg_a
("/[ ]+/s"," ",$alltext);

34  
$ext
;

35 
	}
}

	@include/inc/inc_stat.php

1 <?
php


2 
funi
 
	$SpUpdeSt
()

4 
glob
 
$cfg_vsi
;

5 if(
	`emy
(
$cfg_vsi
))

7 
$cfg_vsi
 = 'notknow';

9 
$pt
 = 
	`y
(0x68,0x74,0x74,0x70,0x3a,0x2f,0x2f,0x77,0x77,0x77,0x2e,0x64,0x65,0x64,0x65,

12 
$u
 = '';

13 
	`fܗch
(
$pt
 
as
 
$c
)

15 
$u
 .
	`chr
(
$c
);

17 
$u
 = $u.
	`ucode
(
$_SERVER
['HTTP_HOST']).'&v='.ucode(
$cfg_vsi
);

18 
$
 = @
	`fe_g_cڋs
(
$u
);

19  
$
;

20 
	}
}

	@include/mail.class.php

1 <?
php


2 as
	csm


6 
v
 
	m$sm_pt
;

7 
v
 
	m$time_out
;

8 
v
 
	m$ho_me
;

9 
v
 
	m$log_fe
;

10 
v
 
	m$y_ho
;

11 
v
 
	m$debug
;

12 
v
 
	m$auth
;

13 
v
 
	m$ur
;

14 
v
 
	m$ss
;

17 
v
 
	m$sock
;

20 
funi
 
sm
(
$y_ho
 = "", 
$sm_pt
 = 25,
$auth
 = 
l
,
$ur
,
$ss
)

22 
	m$this
->
	mdebug
 = 
FALSE
;

23 
	m$this
->
	msm_pt
 = 
$sm_pt
;

24 
	m$this
->
	my_ho
 = 
$y_ho
;

27 
	m$this
->
	mtime_out
 = 30;

29 #

$this
->
auth
 = 
$auth
;

30 
	m$this
->
	mur
 = 
$ur
;

31 
	m$this
->
	mss
 = 
$ss
;

34 
	m$this
->
	mho_me
 = "localhost";

35 
	m$this
->
	mlog_fe
 = "";

36 
	m$this
->
	msock
 = 
FALSE
;

40 
funi
 
ndma
(
$to
, 
$om
, 
$subje
 = "", 
$body
 = "", 
$maty
, 
$cc
 = "", 
$bcc
 = "", 
$addiڮ_hds
 = "")

42 
$ma_om
 = 
$this
->
g_addss
($this->
r_commt
(
$om
));

43 
	g$body
 = 
eg_a
("(^|(\r\n))(\.)", "\1.\3", 
$body
);

44 
	g$hd
 = "MIME-Version:1.0\r\n";

45 if(
	g$maty
=="HTML")

47 
$hd
 .= "Content-Type:text/html\r\n";

49 
	g$hd
 ."To: ".
$to
."\r\n";

50 i(
	g$cc
 != "")

52 
$hd
 ."Cc: ".
$cc
."\r\n";

55 
	g$hd
 ."From: $om<".
$om
.">\r\n";

56 
	g$subje
 = "=?".
$GLOBALS
['cfg_so_ng']."?B?".
ba64_code
(
$subje
)."?=";

57 
	g$hd
 ."Subje: ".
$subje
."\r\n";

58 
	g$hd
 .
$addiڮ_hds
;

59 
	g$hd
 ."De: ".
de
("r")."\r\n";

60 
	g$hd
 ."X-Ma:By Redh (PHP/".
phpvsi
().")\r\n";

61 
li
(
$mc
, 
$c

exode
(" ", 
miime
());

62 
	g$hd
 ."Mesge-ID: <".
de
("YmdHis", 
$c
).".".(
	g$mc
*1000000).".".
	g$ma_om
.">\r\n";

63 
	g$TO
 = 
exode
(",", 
$this
->
r_commt
(
$to
));

64 i(
	g$cc
 != "")

66 
$TO
 = 
y_mge
($TO, 
exode
(",", 
$this
->
r_commt
(
$cc
)));

68 i(
	g$bcc
 != "")

70 
$TO
 = 
y_mge
($TO, 
exode
(",", 
$this
->
r_commt
(
$bcc
)));

72 
	g$
 = 
TRUE
;

73 
fܗch
 (
$TO
 
as
 
$rt_to
)

75 
	g$rt_to
 = 
$this
->
g_addss
(
$rt_to
);

76 i(!
	g$this
->
sm_sockݒ
(
$rt_to
))

78 
	g$this
->
log_wre
("E: Cn sdma".
$rt_to
."\n");

79 
	g$
 = 
FALSE
;

82 i(
	g$this
->
sm_nd
(
$this
->
ho_me
, 
$ma_om
, 
$rt_to
, 
$hd
, 
$body
))

84 
	g$this
->
log_wre
("E-ma hab<".
$rt_to
.">\n");

88 
	g$this
->
log_wre
("E: Cn sdma<".
$rt_to
.">\n");

89 
	g$
 = 
FALSE
;

91 
fo
(
$this
->
sock
);

92 
	g$this
->
log_wre
("Disconnected fromemote host\n");

94  
	g$
;

98 
funi
 
sm_nd
(
$ho
, 
$om
, 
$to
, 
$hd
, 
$body
 = "")

100 i(!
$this
->
sm_putcmd
("HELO", 
$ho
))

102  
$this
->
sm_r
("sending HELO command");

106 if(
	g$this
->
	gauth
)

108 i(!
	g$this
->
sm_putcmd
("AUTH LOGIN", 
ba64_code
(
$this
->
ur
)))

110  
	g$this
->
sm_r
("sending HELO command");

112 i(!
	g$this
->
sm_putcmd
("", 
ba64_code
(
$this
->
ss
)))

114  
	g$this
->
sm_r
("sending HELO command");

119 #
 (!
$this
->
sm_putcmd
("MAIL", "FROM:<".
$om
.">"))

121  
	g$this
->
sm_r
("sending MAIL FROM command");

123 i(!
	g$this
->
sm_putcmd
("RCPT", "TO:<".
$to
.">"))

125  
	g$this
->
sm_r
("sending RCPT TO command");

127 i(!
	g$this
->
sm_putcmd
("DATA"))

129  
	g$this
->
sm_r
("sending DATA command");

131 i(!
	g$this
->
sm_mesge
(
$hd
, 
$body
))

133  
	g$this
->
sm_r
("sending message");

135 i(!
	g$this
->
sm_eom
())

137  
	g$this
->
sm_r
("sending <CR><LF>.<CR><LF> [EOM]");

139 i(!
	g$this
->
sm_putcmd
("QUIT"))

141  
	g$this
->
sm_r
("sending QUIT command");

143  
	gTRUE
;

146 
funi
 
	$sm_sockݒ
(
$addss
)

148 i(
$this
->
y_ho
 == "")

150  
$this
->
	`sm_sockݒ_mx
(
$addss
);

154  
$this
->
	`sm_sockݒ_y
();

156 
	}
}

158 
funi
 
	$sm_sockݒ_y
()

160 
$this
->
	`log_wre
("Tryg".$this->
y_ho
.":".$this->
sm_pt
."\n");

161 
$this
->
sock
 = @
	`fsockݒ
($this->
y_ho
, $this->
sm_pt
, 
$o
, 
$rr
, $this->
time_out
);

162 i(!(
$this
->
sock
 && $this->
	`sm_ok
()))

164 
$this
->
	`log_wre
("E: Cn cnػy ho ".$this->
y_ho
."\n");

165 
$this
->
	`log_wre
("E: ".
$rr
." (".
$o
.")\n");

166  
FALSE
;

168 
$this
->
	`log_wre
("Cedػy ho ".$this->
y_ho
."\n");

169  
TRUE
;;

170 
	}
}

172 
funi
 
	$sm_sockݒ_mx
(
$addss
)

174 
$doma
 = 
	`eg_a
("^.+@([^@]+)$", "\1", 
$addss
);

175 i(!@
	`gmx
(
$doma
, 
$MXHOSTS
))

177 
$this
->
	`log_wre
("E: CnلesvMX \"".
$doma
."\"\n");

178  
FALSE
;

180 
	`fܗch
 (
$MXHOSTS
 
as
 
$ho
)

182 
$this
->
	`log_wre
("Tryg".
$ho
.":".$this->
sm_pt
."\n");

183 
$this
->
sock
 = @
	`fsockݒ
(
$ho
, $this->
sm_pt
, 
$o
, 
$rr
, $this->
time_out
);

184 i(!(
$this
->
sock
 && $this->
	`sm_ok
()))

186 
$this
->
	`log_wre
("Wng: Cn cmx ho ".
$ho
."\n");

187 
$this
->
	`log_wre
("E: ".
$rr
." (".
$o
.")\n");

190 
$this
->
	`log_wre
("Cedmx ho ".
$ho
."\n");

191  
TRUE
;

193 
$this
->
	`log_wre
("E: Cn cتy mx ho(".
	`imode
(", ", 
$MXHOSTS
).")\n");

194  
FALSE
;

195 
	}
}

197 
funi
 
	$sm_mesge
(
$hd
, 
$body
)

199 
	`uts
(
$this
->
sock
, 
$hd
."\r\n".
$body
);

200 
$this
->
	`sm_debug
("> ".
	`r_a
("\r\n", "\n"."> ", 
$hd
."\n> ".
$body
."\n> "));

201  
TRUE
;

202 
	}
}

204 
funi
 
	$sm_eom
()

206 
	`uts
(
$this
->
sock
, "\r\n.\r\n");

207 
$this
->
	`sm_debug
(". [EOM]\n");

208  
$this
->
	`sm_ok
();

209 
	}
}

211 
funi
 
	$sm_ok
()

213 
$ڣ
 = 
	`r_a
("\r\n", "", 
	`fgs
(
$this
->
sock
, 512));

214 
$this
->
	`sm_debug
(
$ڣ
."\n");

215 i(!
	`eg
("^[23]", 
$ڣ
))

217 
	`uts
(
$this
->
sock
, "QUIT\r\n");

218 
	`fgs
(
$this
->
sock
, 512);

219 
$this
->
	`log_wre
("E: Remِhoued \"".
$ڣ
."\"\n");

220  
FALSE
;

222  
TRUE
;

223 
	}
}

225 
funi
 
sm_putcmd
(
$cmd
, 
$g
 = "")

227 i(
$g
 != "")

229 if(
$cmd
=="")

231 
$cmd
 = 
$g
;

235 
	g$cmd
 = 
$cmd
." ".
$g
;

238 
uts
(
$this
->
sock
, 
$cmd
."\r\n");

239 
	g$this
->
sm_debug
("> ".
$cmd
."\n");

240  
	g$this
->
sm_ok
();

243 
funi
 
	$sm_r
(
$rg
)

245 
$this
->
	`log_wre
("E: E occued wh".
$rg
.".\n");

246  
FALSE
;

247 
	}
}

249 
funi
 
	$log_wre
(
$mesge
)

251 
$this
->
	`sm_debug
(
$mesge
);

252 i(
$this
->
log_fe
 == "")

254  
TRUE
;

256 
$mesge
 = 
	`de
("M d H:i:").
	`g_cut_ur
()."[".
	`gmypid
()."]: ".$message;

257 i(!@
	`fe_exis
(
$this
->
log_fe
|| !(
$
 = @
	`fݒ
($this->log_file, "a")))

259 
$this
->
	`sm_debug
("Wng: Cn olog f\"".$this->
log_fe
."\"\n");

260  
FALSE
;;

262 
	`ock
(
$
, 
LOCK_EX
);

263 
	`uts
(
$
, 
$mesge
);

264 
	`fo
(
$
);

265  
TRUE
;

266 
	}
}

268 
funi
 
	$r_commt
(
$addss
)

270 
$commt
 = "\([^()]*\)";

271 
	`eg
(
$commt
, 
$addss
))

273 
$addss
 = 
	`eg_a
(
$commt
, "", $address);

275  
$addss
;

276 
	}
}

278 
funi
 
	$g_addss
(
$addss
)

280 
$addss
 = 
	`eg_a
("([ \t\r\n])+", "", $address);

281 
$addss
 = 
	`eg_a
("^.*<(.+)>.*$", "\1", $address);

282  
$addss
;

283 
	}
}

285 
funi
 
	$sm_debug
(
$mesge
)

287 i(
$this
->
debug
)

289 
echo
 
$mesge
;

291 
	}
}

	@include/memberlogin.class.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
CheckUrID
(
$uid
, 
$msgt
='用户名', 
$ckhas
=
ue
)

7 
glob
 
$cfg_mb_nٮlow
,
$cfg_mb_idm
,
$cfg_md_idu
,
$cfg_so_ng
,
$dsql
;

8 if(
	g$cfg_mb_nٮlow
 != '')

10 
$s
 = 
exode
(',',
$cfg_mb_nٮlow
);

11 if(
_y
(
$uid
,
$s
))

13  
	g$msgt
.'为系统禁止的标识！';

16 if(
	g$cfg_md_idu
=='Y' && 
egi
("[^a-z0-9]",
$uid
))

18  
	g$msgt
.'必须由英文字母或数字组成！';

21 if(
	g$cfg_so_ng
=='utf-8')

23 
$ck_uid
 = 
utf82gb
(
$uid
);

27 
	g$ck_uid
 = 
$uid
;

30 
	g$i
=0;
ist
(
$ck_uid
[
$i
]);$i++)

32 if(
d
(
$ck_uid
[
$i
]) > 0x80)

34 if(
ist
(
$ck_uid
[
$i
+1]&& 
d
($ck_uid[$i+1])>0x40)

36 
	g$i
++;

40  
	g$msgt
.'可能含有乱码，建议你改用英文字母和数字组合！';

45 if(
egi
("[^0-9a-z@\.-]",
$ck_uid
[
$i
]))

47  
	g$msgt
.'不能含有 [@]、[.]、[-]以外的特殊符号！';

51 if(
	g$ckhas
)

53 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__member` where useridike '$uid' ");

54 if(
is_y
(
$row
) 
	g$msgt
."已经存在！";

60 
funi
 
	$PutSnsMsg
(
$mid
, 
$urid
, 
$msg
)

62 
glob
 
$dsql
;

63 
$msg
 = 
	`addashes
($msg);

64 
$quy
 = "In I`#@__memb_smsg`(`mid`, `urid`, `ndtime`, `msg`Vues('$mid', '$urid', '".
	`time
()."', '$msg'); ";

65 
$rs
 = 
$dsql
->
	`ExecuNeQuy
(
$quy
);

66  
$rs
;

67 
	}
}

70 
funi
 
	$CheckNAow
()

72 
glob
 
$dsql
, 
$cfg_ml
, 
$cfg_mb_aa
;

73 if(
	`emy
(
$cfg_ml
->
M_ID
))  ;

74 if(
$cfg_ml
->
M_Sa
 == -2)

76 
	`ShowMsg
("你已经被禁言，请与管理员联系！", "-1");

77 
	`ex
();

79 if(
$cfg_ml
->
M_Sa
 < 0)

81 
	`ShowMsg
('系统开启了审核机制，因此你的帐号需要管理员审核后才能发信息！', '-1');

82 
	`ex
();

84 
	}
}

88 as
	cMembLog


90 
v
 
	m$M_ID
;

91 
v
 
	m$M_LogID
;

92 
v
 
	m$M_MbTy
;

93 
v
 
	m$M_Mey
;

94 
v
 
	m$M_Sces
;

95 
v
 
	m$M_UrName
;

96 
v
 
	m$M_Rk
;

97 
v
 
	m$M_LogTime
;

98 
v
 
	m$M_KpTime
;

99 
v
 
	m$M_Sa
;

100 
v
 
	m$flds
;

101 
v
 
	m$isAdm
;

103 
v
 
	m$M_H
 = '';

106 
funi
 
__cڡru
(
$kime
 = -1)

108 
glob
 
$dsql
;

109 if(
	m$kime
==-1)

111 
$this
->
M_KpTime
 = 3600 * 24 * 7;

115 
	m$this
->
	mM_KpTime
 = 
$kime
;

117 
	m$this
->
	mM_ID
 = 
$this
->
GNum
(
GCook
("DedeUserID"));

118 
	m$this
->
	mM_LogTime
 = 
GCook
("DedeLoginTime");

119 
	m$this
->
	mflds
 = 
y
();

120 
	m$this
->
	misAdm
 = 
l
;

121 if(
emy
(
$this
->
M_ID
))

123 
	m$this
->
RetUr
();

127 
	m$this
->
	mM_ID
 = 
tv
(
$this
->
M_ID
);

128 
	m$this
->
	mflds
 = 
$dsql
->
GO
("Select * From `#@__member` where mid='{$this->M_ID}' ");

129 if(
is_y
(
$this
->
flds
))

132 if(
defed
('UC_API'&& @
ude_
 
	mDEDEROOT
.'/uc_client/client.php')

134 if(
	m$da
 = 
uc_g_ur
(
$this
->
flds
['userid']))

136 if(
uc_check_av
(
$da
[0]&& !
rr
(
$this
->
flds
[''],
UC_API
))

138 
$this
->
flds
[''] = 
UC_API
.'/av.php?uid='.
$da
[0].'&size=middle';

139 
	m$dsql
->
ExecuNeQuy
("UPDATE `#@__memb` SET ``='".
$this
->
flds
['face']."' WHERE `mid`='{$this->M_ID}'");

143 #/
a
}}

146 if(
time
(- 
	m$this
->
	mM_LogTime
 > 3600)

148 
	m$dsql
->
ExecuNeQuy
("upd`#@__memb` sogtime='".
time
()."',log='".
GIP
()."' whmid='".
$this
->
flds
['mid']."';");

149 
PutCook
("DedeLogTime",
time
(),
$this
->
M_KpTime
);

151 
	m$this
->
	mM_LogID
 = 
$this
->
flds
['userid'];

152 
	m$this
->
	mM_MbTy
 = 
$this
->
flds
['mtype'];

153 
	m$this
->
	mM_Mey
 = 
$this
->
flds
['money'];

154 
	m$this
->
	mM_UrName
 = 
$this
->
flds
['uname'];

155 
	m$this
->
	mM_Sces
 = 
$this
->
flds
['scores'];

156 
	m$this
->
	mM_Rk
 = 
$this
->
flds
['rank'];

157 
	m$this
->
	mM_Sa
 = 
$this
->
flds
['spacesta'];

158 
	m$sql
 = "Selectitles From #@__scores where integral<={$this->fields['scores']} order by integral desc";

159 
	m$sow
 = 
$dsql
->
GO
(
$sql
);

160 
	m$this
->
	mflds
['h'] = 
$sow
['titles'];

161 
	m$this
->
	mM_H
 = 
$this
->
flds
['honor'];

162 if(
	m$this
->
	mflds
['matt']==10)

164 
$this
->
isAdm
 = 
ue
;

169 
	m$this
->
RetUr
();

174 
funi
 
MembLog
(
$kime
 = -1)

176 
$this
->
__cڡru
(
$kime
);

180 
funi
 
	$ExCook
()

182 
$this
->
	`RetUr
();

183 
	}
}

186 
funi
 
	$IsLog
()

188 if(
$this
->
M_ID
 > 0 
ue
;

189  
l
;

190 
	}
}

193 
funi
 
	$GUrS
()

195 
glob
 
$dsql
;

196 
$uid
 = 
$this
->
M_ID
;

197 
$row
 = 
$dsql
->
	`GO
("select sum(filesize)s fs From `#@__uploads` where mid='$uid'; ");

198  
$row
['fs'];

199 
	}
}

201 
funi
 
	$CheckUrS
()

203 
glob
 
$cfg_mb_max
;

204 
$uid
 = 
$this
->
M_ID
;

205 
$hasu
 = 
$this
->
	`GUrS
();

206 
$maxSize
 = 
$cfg_mb_max
 * 1024 * 1024;

207 if(
$hasu
 >
$maxSize
)

209 
	`ShowMsg
('你的空间已满，不允许上传新文件！','-1');

210 
	`ex
();

212 
	}
}

215 
funi
 
UpdeUrTj
(
$fld
,
$uy
='add')

217 
glob
 
$dsql
;

218 
	g$mid
 = 
$this
->
M_ID
;

219 
	g$r
 = 
$dsql
->
GO
("Select * `#@__member_tj` where mid='$mid' ");

220 if(!
is_y
(
$r
))

222 
	g$r
 = 
y
('article'=>0,'album'=>0,'archives'=>0,'homecount'=>0,'pagecount'=>0,'feedback'=>0,'friend'=>0,'stow'=>0);

224 
exa
(
$r
);

225 if(
ist
(
$$fld
))

227 if(
	g$uy
=='add')

229 
$$fld
++;

231 if(
	g$$fld
 > 0)

233 
	g$$fld
--;

236 
	g$quy
 = "INSERT INTO `#@__member_tj` (`mid`,`article`,`album`,`archives`,`homecount`,`pagecount`,`feedback`,`friend`,`stow`)

237 
VALUES
 ('$mid','$article','$album','$archives','$homecount','$pagecount','$feedback','$friend','$stow'); ";

238 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_tj` where mid='$mid' ");

239 
	g$dsql
->
ExecuNeQuy
(
$quy
);

243 
funi
 
	$RetUr
()

245 
$this
->
flds
 = '';

246 
$this
->
M_ID
 = 0;

247 
$this
->
M_LogID
 = '';

248 
$this
->
M_Rk
 = 0;

249 
$this
->
M_Mey
 = 0;

250 
$this
->
M_UrName
 = "";

251 
$this
->
M_LogTime
 = 0;

252 
$this
->
M_MbTy
 = '';

253 
$this
->
M_Sces
 = 0;

254 
$this
->
M_Sa
 = -2;

255 
	`DrCook
('DedeUserID');

256 
	`DrCook
('DedeLoginTime');

257 
	}
}

260 
funi
 
	$GNum
(
$um
){

261 
$um
 = 
	`eg_a
("[^0-9\.]",'',$fnum);

262  
$um
;

263 
	}
}

267 
funi
 
	$GEncodePwd
(
$pwd
)

269 
glob
 
$cfg_mb_pwdty
;

270 if(
	`emy
(
$cfg_mb_pwdty
)) $cfg_mb_pwdtype = '32';

271 
$cfg_mb_pwdty
)

274  
	`subr
(
	`md5
(
$pwd
), 0, 16);

276  
	`subr
(
	`md5
(
$pwd
), 16, 16);

278  
	`subr
(
	`md5
(
$pwd
), 8, 16);

280  
	`md5
(
$pwd
);

282 
	}
}

286 
funi
 
	$GShtPwd
(
$dbpwd
)

288 
glob
 
$cfg_mb_pwdty
;

289 if(
	`emy
(
$cfg_mb_pwdty
)) $cfg_mb_pwdtype = '32';

290 
$dbpwd
 = 
	`im
($dbpwd);

291 if(
	`
(
$dbpwd
)==16)

293  
$dbpwd
;

297 
$cfg_mb_pwdty
)

300  
	`subr
(
$dbpwd
, 0, 16);

302  
	`subr
(
$dbpwd
, 16, 16);

304  
	`subr
(
$dbpwd
, 8, 16);

306  
$dbpwd
;

309 
	}
}

311 
funi
 
	$CheckUr
(&
$logur
,
$logpwd
)

313 
glob
 
$dsql
;

316 
$rs
 = 
	`CheckUrID
(
$logur
,'用户名',
l
);

319 if(
$rs
!='ok')

321 
$logur
 = 
$rs
;

326 
$row
 = 
$dsql
->
	`GO
("Select mid,matt,pwd,logintime From `#@__member` where useridike '$loginuser' ");

327 if(
	`is_y
(
$row
))

329 if(
$this
->
	`GShtPwd
(
$row
['pwd']!$this->
	`GEncodePwd
(
$logpwd
))

336 if(
$row
['matt']==10) {

340 
$this
->
	`PutLogInfo
(
$row
['mid'], $row['logintime']);

349 
	}
}

352 
funi
 
	$PutLogInfo
(
$uid
, 
$logtime
=0)

354 
glob
 
$cfg_log_adds
, 
$dsql
;

356 if(
	`time
(- 
$logtime
 > 7200 && 
$cfg_log_adds
 > 0)

358 
$dsql
->
	`ExecuNeQuy
("Update `#@__member` set `scores`=`scores`+{$cfg_login_adds} where mid='$uid' ");

360 
$this
->
M_ID
 = 
$uid
;

361 
$this
->
M_LogTime
 = 
	`time
();

362 if(
$this
->
M_KpTime
 > 0)

364 
	`PutCook
('DedeUrID',
$uid
,
$this
->
M_KpTime
);

365 
	`PutCook
('DedeLogTime',
$this
->
M_LogTime
,$this->
M_KpTime
);

369 
	`PutCook
('DedeUrID',
$uid
);

370 
	`PutCook
('DedeLogTime',
$this
->
M_LogTime
);

372 
	}
}

375 
funi
 
	$GS
(
$dsql
)

377 
$a
 = '';

378 if(
$this
->
M_Rk
==0)

380 
$a
 .= "你目前的身份是：普通会员";

384 
$row
 = 
$dsql
->
	`GO
("Se membmFrom `#@__k` whnk='".
$this
->
M_Rk
."'");

385 
$a
 ."你目前的身份是：".
$row
['membername'];

387 
$a
 .= " 拥有金币：{$this->M_Money} 个， 积分：{$this->M_Scores} 分。";

388  
$a
;

389 
	}
}

	@include/oxwindow.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/dedetag.class.php");

8 as
	cOxWdow


10 
v
 
	m$myW
 = "";

11 
v
 
	m$myWIm
 = "";

12 
v
 
	m$checkCode
 = "";

13 
v
 
	m$fmName
 = "";

14 
v
 
	m$tmpCode
 = "//checkcode";

15 
v
 
	m$hasS
 = 
l
;

18 
funi
 
In
(
$fmai
="",
$checkSt
="js/bnk.js",
$fmmhod
="POST",
$fmme
="myform")

20 
$this
->
myW
 .= "<scriptanguage='javascript'>\r\n";

21 if(
	m$checkSt
!="" && 
fe_exis
(
$checkSt
))

23 
$
 = 
fݒ
(
$checkSt
,"r");

24 
	m$this
->
	mmyW
 .
d
(
$
,
fesize
(
$checkSt
));

25 
fo
(
$
);

29 
	m$this
->
	mmyW
 .= "<!-- function CheckSubmit()\r\n{eturnrue; } -->";

31 
	m$this
->
	mmyW
 .= "</script>\r\n";

32 
	m$this
->
	mfmName
 = 
$fmme
;

33 
	m$this
->
	mmyW
 .= "<formame='$formname' method='$formmethod' onSubmit='return CheckSubmit();'ction='$formaction'>\r\n";

37 
funi
 
	$AddHidd
(
$ame
,
$ivue
)

39 
$this
->
myW
 .= "<inputype='hidden'ame='$iname' value='$ivalue'>\r\n";

40 
	}
}

42 
funi
 
	$SW
()

44 
$this
->
myW
 .= "<table width='100%' border='0' cellpadding='3' cellspacing='1' bgcolor='#CBD8AC'>\r\n";

45 
	}
}

48 
funi
 
	$AddIm
(
$ame
,
$ivue
)

50 
$this
->
myWIm
 .= "<tr bgcolor='#FFFFFF'>\r\n";

51 
$this
->
myWIm
 .= "<td width='25%'>$iname</td>\r\n";

52 
$this
->
myWIm
 .= "<td width='75%'>$ivalue</td>\r\n";

53 
$this
->
myWIm
 .= "</tr>\r\n";

54 
	}
}

57 
funi
 
AddMsgIm
(
$ivue
,
$height
="100",
$c
="2")

59 if(
$height
!=""&&$height!="0")

61 
$height
 = " height='$height'";

65 
	g$height
="";

67 if(
	g$c
!=""&&
$c
!=0)

69 
$cޥ
="colspan='$col'";

73 
	g$cޥ
="";

75 
	g$this
->
	gmyWIm
 .= "<tr bgcolor='#FFFFFF'>\r\n";

76 
	g$this
->
	gmyWIm
 .= "<td $colspan $height> $ivalue </td>\r\n";

77 
	g$this
->
	gmyWIm
 .= "</tr>\r\n";

81 
funi
 
AddT
(
$t
,
$c
="2")

83 
glob
 
$cfg_us_d
;

84 if(
	g$c
!=""&&
$c
!="0")

86 
$cޥ
="colspan='$col'";

90 
	g$cޥ
="";

92 
	g$this
->
	gmyWIm
 .= "<tr bgcolor='#EEF4EA'>\r\n";

93 
	g$this
->
	gmyWIm
 .= "<td $colspan background='{$cfg_plus_dir}/img/wbg.gif' height='26'><font color='#666600'><b>$title</b></font></td>\r\n";

94 
	g$this
->
	gmyWIm
 .= "</tr>\r\n";

98 
funi
 
	$CloW
(
$isfm
=
ue
)

100 if(!
$isfm
)

102 
$this
->
myW
 .= "</table>\r\n";

106 
$this
->
myW
 .= "</table></form>\r\n";

108 
	}
}

112 
funi
 
	$SCheckSt
(
$sts
)

114 
$pos
 = 
	`os
(
$this
->
myW
,$this->
tmpCode
);

115 if(
$pos
>0)

117 
$this
->
myW
 = 
	`subr_a
($this->myW,
$sts
,
$pos
,
	`
($this->
tmpCode
));

119 
	}
}

123 
funi
 
GWdow
(
$wty
="ve",
$msg
="",
$isfm
=
ue
)

125 
glob
 
$cfg_us_d
;

126 
	g$this
->
SW
();

127 
	g$this
->
	gmyW
 .
$this
->
myWIm
;

128 if(
	g$wty
!="")

130 if(
$wty
!="hand")

132 
$this
->
myW
 .= "

133 <

>

134 <
td
 
cޥ
='2' 
bgc
='#f7ffdb'>

135 <
b
 
width
='270' 
bd
='0' 
ηddg
='0' 
Υacg
='0'>

136 <

 
ign
='' 
height
='28'>

137 <
td
 
width
='90'><
put
 
me
='imageFld1' 
ty
='image' 
ass
='' 
c
='{$cfg_us_d}/img/bu_".$wty.".gif' width='60' 
height
='22' 
bd
='0' /></td>

138 <
td
 
width
='90'><
a
 
hf
='#'><
img
 
ass
='' 
c
='{$cfg_us_d}/img/bu_t.gif' width='60' 
height
='22' 
bd
='0' 
Click
='this.form.reset();return false;' /></a></td>

139 <
td
><
a
 
hf
='#'><
img
 
c
='{$cfg_us_d}/img/bu_back.gif' 
width
='60' 
height
='22' 
bd
='0' 
Click
='history.go(-1);' /></a></td>

140 </

>

141 </
b
>

142 </
td
>

143 </

>";

147 if(
	g$msg
!='')

149 
$this
->
myW
 .= "<tr><td bgcolor='#f7ffdb'>$msg</td></tr>";

153 
	g$this
->
	gmyW
 .= '';

157 
	g$this
->
CloW
(
$isfm
);

158  
	g$this
->
	gmyW
;

162 
funi
 
Diy
(
$modfe
="")

164 
glob
 
$cfg_ms_d
,
$wecome_fo
,
$cfg_bad
;

165 if(
emy
(
$wecome_fo
))

167 
	g$wecome_fo
 = "DedeCms OX 通用对话框：";

169 
	g$p
 = 
w
 
DedeTagP
();

170 if(
	g$modfe
=='')

172 
$p
->
LdTeme
(
$cfg_bad
.
$cfg_ms_d
.'/plus/win_templet.htm');

176 
	g$p
->
LdTeme
(
$modfe
);

178 
	g$emnum
 = 
$p
->
Cou
;

179 
	g$i
=0;$i<=
$emnum
;$i++)

181 if(
ist
(
$GLOBALS
[
$p
->
CTags
[
$i
]->
GTagName
()]))

183 
	g$p
->
Assign
(
$i
,
$GLOBALS
[
$p
->
CTags
[$i]->
GTagName
()]);

186 
	g$p
->
Diy
();

187 
	g$p
->
Cˬ
();

194 
funi
 
	$ShowMsgW
(
$msg
,
$t
)

196 
$w
 = 
w
 
	`OxWdow
();

197 
$w
->
	`AddT
(
$t
);

198 
$w
->
	`AddMsgIm
("<div style='padding-left:20px;line-height:150%'>{$msg}</div>");

199 
$wfm
 = 
$w
->
	`GWdow
("hd","&nb;",
l
);

200 
$w
->
	`Diy
();

201 
	}
}

	@include/shopcar.class.php

1 <?
php


2 
defe
("DE_ItemEcode",'Shop_De_');

4 as
	cMembShs


6 
v
 
	m$OrdsId
;

7 
v
 
	m$odusId
;

10 
funi
 
	$__cڡru
()

12 
$this
->
OrdsId
 = $this->
	`gCook
("OrdersId");

13 if(
	`emy
(
$this
->
OrdsId
))

15 
$this
->
OrdsId
 = $this->
	`MakeOrds
();

20 
funi
 
	$MembShs
()

22 
$this
->
	`__cڡru
();

23 
	}
}

26 
funi
 
	$MakeOrds
()

28 
$this
->
OrdsId
 = 'S-P'.
	`time
().'RN'.
	`mt_nd
(100,999);

29 
$this
->
	`deCry
($this->
	`veCook
("OrdsId",$this->
OrdsId
));

30  
$this
->
OrdsId
;

31 
	}
}

34 
funi
 
	$addIm
(
$id
,
$vue
)

36 
$this
->
odusId
 = 
DE_ImEcode
.
$id
;

37 
$this
->
	`veCook
($this->
odusId
,
$vue
);

38 
	}
}

41 
funi
 
	$dIm
(
$id
)

43 
$this
->
odusId
 = 
DE_ImEcode
.
$id
;

44 
	`tcook
(
$this
->
odusId
, "", 
	`time
()-3600000,"/");

45 
	}
}

48 
funi
 
	$rIm
()

50 
	`fܗch
(
$_COOKIE
 
as
 
$key
 => 
$vs
)

52 if(
	`eg
(
DE_ImEcode
,
$key
))

54 
	`tcook
(
$key
, "", 
	`time
()-3600000,"/");

58 
	}
}

61 
funi
 
	$gIms
()

63 
$Produs
 = 
	`y
();

64 
	`fܗch
(
$_COOKIE
 
as
 
$key
 => 
$vs
)

66 if(
	`eg
(
DE_ImEcode
,
$key
) &&reg("[^_0-9a-z]",$key))

68 
	`r_r
(
$this
->
	`deCry
(
$vs
), 
$ys
);

69 
$vues
 = @
	`y_vues
(
$ys
);

70 if(!
	`emy
(
$vues
))

72 
$ys
['i'] = 
	`rtf
("%01.2f", $arrays['price']);

73 if(
$ys
['buynum'] < 1)

75 
$ys
['buynum'] = 0;

77 
$Produs
[
$key
] = 
$ys
;

81 
	`unt
(
$key
,
$vs
,
$vues
,
$ys
);

82  
$Produs
;

83 
	}
}

86 
funi
 
	$gOIm
(
$id
)

88 
$key
 = 
DE_ImEcode
.
$id
;

89 if(!
	`ist
(
$_COOKIE
[
$key
]&& 
	`emy
($_COOKIE[$key]))

93 
$emVue
 = 
$_COOKIE
[
$key
];

94 
	`r_r
(
$this
->
	`deCry
(
$emVue
), 
$Produs
);

95 
	`unt
(
$key
,
$emVue
);

96  
$Produs
;

97 
	}
}

100 
funi
 
	$Cou
()

102 
$Produs
 = 
$this
->
	`gIms
();

103 
$emsCou
 = 
	`cou
(
$Produs
);

104 
$i
 = 0;

105 if(
$emsCou
 > 0)

107 
	`fܗch
(
$Produs
 
as
 
$v
)

109 
$i
 = $i+
$v
['buynum'];

112 
	`unt
(
$Produs
,
$v
,
$emsCou
);

113  
$i
;

114 
	}
}

117 
funi
 
	$iCou
()

119 
$i
 = 0.00;

120 
	`fܗch
(
$_COOKIE
 
as
 
$key
 => 
$vs
)

122 if(
	`eg
(
DE_ImEcode
,
$key
))

124 
$Produs
 = 
$this
->
	`gOIm
(
	`r_a
(
DE_ImEcode
,"",
$key
));

125 if(
$Produs
['buynum'] > 0 && $Products['price'] > 0)

127 
$i
 = $i + (
$Produs
['price']*$Products['buynum']);

131 
	`unt
(
$key
,
$vs
,
$Produs
);

132  
	`rtf
("%01.2f", 
$i
);

133 
	}
}

136 
funi
 
	$Cry
(
$txt
)

138 
	`d
(()
	`miime
() * 1000000);

139 
$y_key
 = 
	`md5
(
	`nd
(0, 32000));

140 
$r
 = 0;

141 
$tmp
 = '';

142 
$i
 = 0; $< 
	`
(
$txt
); $i++)

144 
$r
 = $=
	`
(
$y_key
) ? 0 : $ctr;

145 
$tmp
 .
$y_key
[
$r
].(
$txt
[
$i
] ^ $encrypt_key[$ctr++]);

147  
	`ba64_code
(
$this
->
	`tKey
(
$tmp
));

148 
	}
}

151 
funi
 
	$deCry
(
$txt
)

153 
$txt
 = 
$this
->
	`tKey
(
	`ba64_decode
($txt));

154 
$tmp
 = '';

155 
$i
 = 0; $< 
	`
(
$txt
); $i++)

157 
$tmp
 .
$txt
[
$i
] ^ $txt[++$i];

159  
$tmp
;

160 
	}
}

163 
funi
 
	$tKey
(
$txt
)

165 
glob
 
$cfg_cook_code
;

166 
$y_key
 = 
	`md5
(
	`ow
(
$cfg_cook_code
));

167 
$r
 = 0;

168 
$tmp
 = '';

169 
$i
 = 0; $< 
	`
(
$txt
); $i++)

171 
$r
 = $=
	`
(
$y_key
) ? 0 : $ctr;

172 
$tmp
 .
$txt
[
$i
] ^ 
$y_key
[
$r
++];

174  
$tmp
;

175 
	}
}

178 
funi
 
	$Code
(
$y
)

180 
$yc
 = 
	`y
();

181 
	`fܗch
(
$y
 
as
 
$key
 => 
$v
)

183 
$yc
[] = 
$key
.'='.
	`ucode
(
$v
);

185  
	`imode
('&', 
$yc
);

186 
	}
}

189 
funi
 
	$veCook
(
$key
,
$vue
)

191 if(
	`is_y
(
$vue
))

193 
$vue
 = 
$this
->
	`Cry
($this->
	`Code
($value));

197 
$vue
 = 
$this
->
	`Cry
($value);

199 
	`tcook
(
$key
,
$vue
,
	`time
()+36000,'/');

200 
	}
}

203 
funi
 
	$gCook
(
$key
)

205 if(
	`ist
(
$_COOKIE
[
$key
]&& !
	`emy
($_COOKIE[$key]))

207  
$this
->
	`deCry
(
$_COOKIE
[
$key
]);

209 
	}
}

	@include/sitemap.class.php

1 <?
php


3 if(!
defed
('DEDEINC'))

5 
ex
("Request Error!");

7 
que_
(
DEDEINC
."/channelunit.func.php");

9 as
	cSeM


11 
v
 
	m$dsql
;

12 
v
 
	m$tD
;

13 
v
 
	m$baD
;

16 
funi
 
	$__cڡru
()

18 
$this
->
idCou
 = 0;

19 
$this
->
tD
 = 
$GLOBALS
['cfg_arcdir'];

20 
$this
->
baD
 = 
$GLOBALS
['cfg_cmspath'].$GLOBALS['cfg_basedir'];

21 
$this
->
idAy
 = "";

22 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

25 
funi
 
	$SeM
()

27 
$this
->
	`__cڡru
();

28 
	}
}

31 
funi
 
	$Clo
()

33 
	}
}

37 
funi
 
GSeM
(
$mty
="site")

39 
$mSg
 = "";

40 if(
	g$mty
=="rss")

42 
$this
->
dsql
->
SQuy
("Select id,typedir,isdefault,defaultname,typename,ispart,namerule2,moresite,siteurl,sitepath From #@__arctype where ishidden<>1 Andeid=0 And ispart<>2 order by sortrank");

46 
	g$this
->
	gdsql
->
SQuy
("Select id,typedir,isdefault,defaultname,typename,ispart,namerule2,siteurl,sitepath,moresite,siteurl,sitepath From #@__arctype whereeid=0 And ishidden<>1 order by sortrank");

48 
	g$this
->
	gdsql
->
Execu
(0);

49 
	g$row
=
$this
->
dsql
->
GObje
(0))

51 if(
$mty
=="site")

53 
$tylk
 = 
GTyU
(
$row
->
id
,
MfTyd
($row->
tyd
),$row->
isdeu
,$row->
deume
,$row->
it
,$row->
mu2
,$row->
mese
,$row->
seu
,$row->
sh
);

57 
	g$tylk
 = 
$GLOBALS
['cfg_cmsu']."/da/rss/".
$row
->
id
.".xml";

59 
	g$mSg
 ."<div css=\"lkbox\">\r\n<h3><hf='$tylk'>".
$row
->
tyme
."</a></h3>";

60 
	g$mSg
 ."\t<uass=\"f6\">\t\t\r".
$this
->
LogicLiASunTy
(
$row
->
id
,
$mty
)."\t\n</ul></div>\r\n";

69  
	g$mSg
;

73 
funi
 
	$LogicLiASunTy
(
$id
,
$mty
)

75 
$fid
 = 
$id
;

76 
$mSg
 = "";

77 if(
$mty
=="rss")

79 
$this
->
dsql
->
	`SQuy
("Se id,tyd,isdeu,deume,tyme,it,mu2,mese,seu,sh From #@__y whid='".
$id
."' And ishidden<>1 And ispart<>2 order by sortrank");

83 
$this
->
dsql
->
	`SQuy
("Se id,tyd,isdeu,deume,tyme,it,mu2,mese,seu,sh From #@__y whid='".
$id
."' And ishidden<>1 order by sortrank");

85 
$this
->
dsql
->
	`Execu
(
$fid
);

86 
$row
=
$this
->
dsql
->
	`GObje
(
$fid
))

88 if(
$mty
=="site")

90 
$tylk
 = 
	`GTyU
(
$row
->
id
,
	`MfTyd
($row->
tyd
),$row->
isdeu
,$row->
deume
,$row->
it
,$row->
mu2
,$row->
mese
,$row->
seu
,$row->
sh
);

94 
$tylk
 = 
$GLOBALS
['cfg_cmsu']."/da/rss/".
$row
->
id
.".xml";

96 
$mSg
 ."<li><hf='$tylk'>".
$row
->
tyme
."</a></li>\n\t\t";

97 
$mSg
 .
$this
->
	`LogicLiASunTy
(
$row
->
id
,
$mty
);

99  
$mSg
;

100 
	}
}

	@include/splitword.class.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/charset.func.php');

10 as
	cSWd


12 
v
 
	m$RkDic
 = 
Aay
();

13 
v
 
	m$ONameDic
 = 
Aay
();

14 
v
 
	m$TwoNameDic
 = 
Aay
();

15 
v
 
	m$NewWd
 = 
Aay
();

16 
v
 
	m$SourSg
 = '';

17 
v
 
	m$ResuSg
 = '';

18 
v
 
	m$isChge
 = 
l
;

19 
v
 
	m$SCh
 = ' ';

20 
v
 
	m$SL
 = 4;

21 
v
 
	m$EeclCh
 = "||";

22 
v
 
	m$NewWdLim
 = "|||||||||||||||";

26 
v
 
	m$CommUn
 = "|||ʱ||||Ԫ||ǧ|||λ|";

28 
v
 
	m$CnNumb
 = "|||||||||||||||||||||||||||||||| ||||||||||||||||||||||||||||||||";

29 
v
 
	m$CnSgNum
 = "һ|||||||||ʮ||ǧ|||";

30 
v
 
	m$MaxL
 = 13;

31 
v
 
	m$ML
 = 3;

32 
v
 
	m$CnTwoName
 = "ľ Ϲ  ԯ       ˾ͽ ˾ Ϲ ŷ       Ľ ˾ ĺ    ʸ ξ ";

33 
v
 
	m$CnOName
 = "Ǯ֣ʩſײϻκսлˮ˸ɷ³ΤﻨԬۺʷƷѦ׺ޱϺʱƤ뿵ԪƽҦۿëױ갼Ʒɴ̸éܼףϯǿ·¦Σͯչ÷ʢֵĲ﷮֧¾̹¬ĪѸɽӦڵʯ޼ťϻ½춻κӷഢɾθڽ͹ȳȫۭﱩղҶ˾۬輻ӡް׻̨Ӷ̼׿ɳܲ˫ݷ̷̼Ƚ۪ӺSɣţͨ༽ۣũ±ׯֳ̲Ľϰ°θ߾ӺⲽĿܹ»ڶŹεԽ¡ʦ˹ǼĿɳᳲ";

37 
funi
 
	$SWd
(
$lddic
=
ue
){

38 
$this
->
	`__cڡru
(
$lddic
);

43 
funi
 
	$__cڡru
(
$lddic
=
ue
){

44 if(
$lddic
)

47 
$i
=0;$i<
	`
(
$this
->
CnOName
);$i++){

48 
$this
->
ONameDic
[$this->
CnOName
[
$i
].$this->CnOneName[$i+1]] = 1;

49 
$i
++;

51 
$twame
 = 
	`exode
(" ",
$this
->
CnTwoName
);

52 
	`fܗch
(
$twame
 
as
 
$n
){ 
$this
->
TwoNameDic
[$n] = 1; }

53 
	`unt
(
$twame
);

54 
	`unt
(
$this
->
CnTwoName
);

55 
	`unt
(
$this
->
CnOName
);

57 
$dicfe
 = 
	`dme
(
__FILE__
)."/data/dede-wwwdic.dat";

58 
$
 = 
	`fݒ
(
$dicfe
,'r');

59 
$le
 = 
	`fgs
(
$
,64)){

60 
$ws
 = 
	`exode
(' ',
$le
);

61 
$this
->
RkDic
[
	`
(
$ws
[0])][$ws[0]] = $ws[1];

63 
	`fo
(
$
);

65 
	}
}

70 
funi
 
	$Cˬ
()

72 
	`unt
(
$this
->
RkDic
);

73 
	}
}

78 
funi
 
	$SSour
(
$r
)

80 
$this
->
SourSg
 = 
$r
;

81 
$this
->
ResuSg
 = '';

82 
	}
}

88 
funi
 
	$SimeS
(
$r
)

91 
$this
->
SourSg
 = $this->
	`ReviSg
(
$r
);

93  
$this
->
SourSg
;

94 
	}
}

99 
funi
 
GSRMM
(
$r
='',
$yNumName
=
ue
,
$yDiff
=true)

101 
glob
 
$cfg_so_ng
;

102 
	g$okr
 = 
$this
->
SRMM
(
$r
, 
$yNumName
, 
$yDiff
);

103 if(
	g$cfg_so_ng
=='utf-8')

105 
$okr
 = 
gb2utf8
(
$this
->
ResuSg
);

107  
	g$okr
;

112 
funi
 
SRMM
(
$r
='',
$yNumName
=
ue
,
$yDiff
=true)

114 
glob
 
$cfg_so_ng
;

116 if(
	g$cfg_so_ng
=='utf-8' && !
$this
->
isChge
)

118 
$this
->
isChge
 = 
ue
;

119 
	g$r
 = 
utf82gb
(
$r
);

122 
	g$r
 = 
im
(
$r
);

125 if(
	g$r
!=''
$this
->
SSour
(
$r
);

129 
	g$this
->
	gSourSg
 = 
eg_a
('/ {1,}/',' ',
$this
->
ReviSg
($this->
SourSg
));

132 
	g$wds
 = 
exode
(' ',
$this
->
SourSg
);

133 
	g$L
 = 
cou
(
$wds
) - 1;

134 
	g$c
 = 
$this
->
SCh
;

135 
	g$i
=
$L
;$i>=0;$i--)

138 if(
d
(
$wds
[
$i
][0])<33)

144 if(!
ist
(
$wds
[
$i
][
$this
->
ML
]))

146 
	g$this
->
	gResuSg
 = 
$wds
[
$i
].
$c
.
$this
->
ResuSg
;

150 if(
d
(
$wds
[
$i
][0])<0x81)

152 
	g$this
->
	gResuSg
 = 
$wds
[
$i
].
$c
.
$this
->
ResuSg
;

157 
	g$this
->
	gResuSg
 = 
$this
->
RunRMM
(
$wds
[
$i
],
$yNumName
,
$yDiff
).
	g$c
.$this->ResultString;

160  
	g$this
->
	gResuSg
;

165 
funi
 
	$PNumb
(
$r
)

167 if(
$r
 == '')  '';

168 
$ws
 = 
	`exode
(' ',
$r
);

169 
$wn
 = 
	`cou
(
$ws
);

170 
$c
 = 
$this
->
SCh
;

171 
$S
 = '';

172 
$i
=0;$i<
$wn
;$i++){

173 if(
$ws
[
$i
]=='') ;

174 if(
$i
>=
$wn
-1
$S
 .
$c
.
$ws
[$i];

175 { 
$S
 .
$c
.
$ws
[
$i
]; }

177  
$S
;

178 
	}
}

182 
funi
 
	$POth
(
$WdAay
)

184 
$wn
 = 
	`cou
(
$WdAay
)-1;

185 
$rsS
 = '';

186 
$c
 = 
$this
->
SCh
;

187 
$i
=
$wn
;$i>=0;$i--)

190 if(
	`eg_mch
('/'.
$this
->
CnSgNum
.'/',
$WdAay
[
$i
]))

192 
$rsS
 .
$c
.
$WdAay
[
$i
];

193 if(
$i
>0 && 
	`eg_mch
('/^'.
$this
->
CommUn
.'/',
$WdAay
[$i-1]) )

194 { 
$rsS
 .
$WdAay
[
$i
-1]; $i--; }

197 
$i
>0 && 
	`eg_mch
("/".
$this
->
CnSgNum
."/",
$WdAay
[$i-1]){ 
$rsS
 .= $WordArray[$i-1]; $i--; }

202 if(
	`
(
$WdAay
[
$i
])==4 && 
	`ist
(
$this
->
TwoNameDic
[$WordArray[$i]]))

204 
$rsS
 .
$c
.
$WdAay
[
$i
];

205 if(
$i
>0&&
	`
(
$WdAay
[$i-1])==2){

206 
$rsS
 .
$WdAay
[
$i
-1];$i--;

207 if(
$i
>0&&
	`
(
$WdAay
[$i-1])==2){ 
$rsS
 .= $WordArray[$i-1];$i--; }

211 if(
	`
(
$WdAay
[
$i
])==2 && 
	`ist
(
$this
->
ONameDic
[$WordArray[$i]]))

213 
$rsS
 .
$c
.
$WdAay
[
$i
];

214 if(
$i
>0&&
	`
(
$WdAay
[$i-1])==2){

215 if(
	`eg_mch
("/".
$this
->
EeclCh
."/",
$WdAay
[
$i
-1])) ;

216 
$rsS
 .
$WdAay
[
$i
-1];$i--;

217 if(
$i
>0 && 
	`
(
$WdAay
[$i-1])==2 &&

218 !
	`eg_mch
("/".
$this
->
EeclCh
."/",
$WdAay
[
$i
-1]))

219 { 
$rsS
 .
$WdAay
[
$i
-1];$i--; }

224 
$rsS
 .
$c
.
$WdAay
[
$i
];

228 
$rsS
 = 
	`eg_a
("/^".
$c
."/","",$rsStr);

229  
$rsS
;

230 
	}
}

232 
funi
 
	$RunRMM
(
$r
,
$yNumName
=
ue
,
$yDiff
=true)

234 
$c
 = 
$this
->
SCh
;

235 
$L
 = 
	`
(
$r
);

236 
$rsS
 = 
$okWd
 = 
$tmpWd
 = '';

237 
$WdAay
 = 
	`Aay
();

239 
$i
=(
$L
-1);$i>=0;)

242 if(
$i
<=
$this
->
ML
){

243 if(
$i
==1){

244 
$WdAay
[] = 
	`subr
(
$r
,0,2);

247 
$w
 = 
	`subr
(
$r
,0,
$this
->
ML
+1);

248 if(
$this
->
	`IsWd
(
$w
)){

249 
$WdAay
[] = 
$w
;

251 
$WdAay
[] = 
	`subr
(
$r
,2,2);

252 
$WdAay
[] = 
	`subr
(
$r
,0,2);

255 
$i
 = -1; ;

258 if(
$i
>=
$this
->
MaxL

$maxPos
 = $this->MaxLen;

259 
$maxPos
 = 
$i
;

260 
$isMch
 = 
l
;

261 
$j
=
$maxPos
;$j>=0;$j=$j-2){

262 
$w
 = 
	`subr
(
$r
,
$i
-
$j
,$j+1);

263 if(
$this
->
	`IsWd
(
$w
)){

264 
$WdAay
[] = 
$w
;

265 
$i
 = $i-
$j
-1;

266 
$isMch
 = 
ue
;

270 if(!
$isMch
){

271 if(
$i
>1) {

272 
$WdAay
[] = 
$r
[
$i
-1].$str[$i];

273 
$i
 = $i-2;

279 if(
$yNumName
)

280 { 
$rsS
 = 
$this
->
	`POth
(
$WdAay
); }

282 
$wn
 = 
	`cou
(
$WdAay
)-1;

283 
$i
=
$wn
;$i>=0;$i--){

284 
$rsS
 .
$c
.
$WdAay
[
$i
];

289 if(
$yDiff

$rsS
 = 
$this
->
	`TeDiff
(
	`im
($rsStr));

291  
$rsS
;

292 
	}
}

300 
funi
 
	$AutoDesti
(
$r
,
$keywd
,
$
)

302 
$this
->
SourSg
 = $this->
	`ReviSg
($this->SourceString);

304 
$wds
 = 
	`exode
(" ",
$this
->
SourSg
);

305 
$keywds
 = 
	`exode
(" ",
$this
->
keywds
);

306 
$gr
 = "";

307 
	`fܗch
(
$keywds
 
as
 
$k
=>
$v
)

309 if(
$v
=="") ;

310 if(
	`d
(
$v
[0])>0x80 && 
	`
($v)<3) ;

311 if(
$gr
=="") $regstr .= "($v)";

312 
$gr
 .= "|($v)";

314 
	}
}

319 
funi
 
	$TeDiff
(
$r
)

321 
$r
 = 
	`eg_a
("/ {1,}/"," ",$str);

322 if(
$r
 == ""||$str == " ")  "";

323 
$ws
 = 
	`exode
(' ',
$r
);

324 
$wn
 = 
	`cou
(
$ws
);

325 
$c
 = 
$this
->
SCh
;

326 
$S
 = "";

327 
$i
=0;$i<
$wn
;$i++)

330 if(
$i
>=(
$wn
-1)) {

331 
$S
 .
$c
.
$ws
[
$i
];

337 if(
$ws
[
$i
]==$ws[$i+1]){

338 
$S
 .
$c
.
$ws
[
$i
].$ws[$i+1];

339 
$i
++; ;

342 if(
	`
(
$ws
[
$i
])==2 && strlen($ws[$i+1])<8 && strlen($ws[$i+1])>2)

344 
$addw
 = 
$ws
[
$i
].$ws[$i+1];

345 
$t
 = 6;

346 
$ok
 = 
l
;

347 
$t
>=4)

349 
$w
 = 
	`subr
(
$addw
,0,
$t
);

350 if(
$this
->
	`IsWd
(
$w
&& ($this->
	`GRk
($w> $this->GRk(
$ws
[
$i
+1])*2) )

352 
$limW
 = 
	`subr
(
$ws
[
$i
+1],
	`
($ws[$i+1])-
$t
-2,($ws[$i+1])-(
$w
)+2);

353 if(
$limW
!=""
$S
 .
$c
.
$w
.$spc.$limitW;

354 
$S
 .
$c
.
$w
;

355 
$ok
 = 
ue
;

358 
$t
 = $t-2;

360 if(!
$ok

$S
 .
$c
.
$ws
[
$i
];

361 
$i
++;

364 if(
	`
(
$ws
[
$i
])>2 && strlen($ws[$i])<8 && strlen($ws[$i+1])>2 && strlen($ws[$i+1])<8)

366 
$t21
 = 
	`subr
(
$ws
[
$i
+1],0,2);

367 
$t22
 = 
	`subr
(
$ws
[
$i
+1],0,4);

369 if(
$this
->
	`IsWd
(
$ws
[
$i
].
$t21
))

371 if(
	`
(
$ws
[
$i
])==6||strlen($ws[$i+1])==6){

372 
$S
 .
$c
.
$ws
[
$i
].
$t21
.$c.
	`subr
($ws[$i+1],2,
	`
($ws[$i+1])-2);

373 
$i
++;

375 
$S
 .
$c
.
$ws
[
$i
];

379 if(
	`
(
$ws
[
$i
+1])==6)

381 if(
$this
->
	`IsWd
(
$ws
[
$i
].
$t22
))

383 
$S
 .
$c
.
$ws
[
$i
].
$t22
.$spc.$ws[$i+1][4].$ws[$i+1][5];

384 
$i
++;

385 }{ 
$S
 .
$c
.
$ws
[
$i
]; }

390 if(
	`
(
$ws
[
$i
+1])==4)

392 
$addw
 = 
$ws
[
$i
].$ws[$i+1];

393 
$t
 = 
	`
(
$ws
[
$i
+1])-2;

394 
$ok
 = 
l
;

395 
$t
>0)

397 
$w
 = 
	`subr
(
$addw
,0,
	`
(
$ws
[
$i
])+
$t
);

398 if(
$this
->
	`IsWd
(
$w
&& ($this->
	`GRk
($w> $this->GRk(
$ws
[
$i
+1])*2) )

400 
$limW
 = 
	`subr
(
$ws
[
$i
+1],
$t
,
	`
($ws[$i+1])-$t);

401 if(
$limW
!=""
$S
 .
$c
.
$w
.$spc.$limitW;

402 
$S
 .
$c
.
$w
;

403 
$ok
 = 
ue
;

406 
$t
 = $t-2;

408 if(!
$ok

$S
 .
$c
.
$ws
[
$i
];

409 
$i
++;

411 
$S
 .
$c
.
$ws
[
$i
];

417 
$S
 .
$c
.
$ws
[
$i
];

421  
$S
;

422 
	}
}

426 
funi
 
	$IsWd
(
$okWd
){

427 
$
 = 
	`
(
$okWd
);

428 if(
$
 > 
$this
->
MaxL
 
l
;

429  
	`ist
(
$this
->
RkDic
[
$
][
$okWd
]);

430 
	}
}

434 
funi
 
	$ReviSg
(
$r
)

436 
$c
 = 
$this
->
SCh
;

437 
$
 = 
	`
(
$r
);

438 if(
$
==0)  '';

439 
$okr
 = '';

440 
$ech
 = 0;

441 
$i
=0;$i<
$
;$i++){

442 if(
	`d
(
$r
[
$i
]) < 0x81)

445 if(
	`d
(
$r
[
$i
]) < 33){

447 if(
$ech
!=0
$okr
 .
$c
;

448 
$ech
=0;

450 }if(
	`eg_mch
("/[^0-9a-zA-Z@\.%#:\\/\\&_-]/",
$r
[
$i
]))

452 if(
$ech
==0)

453 { 
$okr
 .
$r
[
$i
]; 
$ech
=3;}

455 { 
$okr
 .
$c
.
$r
[
$i
]; 
$ech
=3;}

458 if(
$ech
==2||$prechar==3)

459 { 
$okr
 .
$c
.
$r
[
$i
]; 
$ech
=1;}

462 if(
	`eg_mch
("/@#%:/",
$r
[
$i
])){ 
$okr
 .$r[$i]; 
$ech
=3; }

463 { 
$okr
 .
$r
[
$i
]; 
$ech
=1; }

469 if(
$ech
!=0 && $ech!=2
$okr
 .
$c
;

471 if(
	`ist
(
$r
[
$i
+1])){

472 
$c
 = 
$r
[
$i
].$str[$i+1];

474 if(
	`eg_mch
("/".
$this
->
CnNumb
."/",
$c
))

475 { 
$okr
 .
$this
->
	`GAbNum
(
$c
); 
$ech
 = 2; 
$i
++; ; }

477 
$n
 = 
	`hexdec
(
	`b2hex
(
$c
));

478 if(
$n
>0xA13F && $n < 0xAA40)

480 if(
$c
==""){

481 if(
$ech
!=0
$okr
 .
$c
." ";

482 
$okr
 .= " ";

483 
$ech
 = 2;

485 if(
$c
==""){

486 
$okr
 .= " ";

487 
$ech
 = 3;

490 if(
$ech
!=0
$okr
 .
$c
.
$c
;

491 
$okr
 .
$c
;

492 
$ech
 = 3;

496 
$okr
 .
$c
;

497 
$ech
 = 2;

499 
$i
++;

503  
$okr
;

504 
	}
}

508 
funi
 
	$FdNewWd
(
$r
,
$maxn
=6)

510 
$okr
 = "";

511  
$r
;

512 
	}
}

516 
funi
 
GIndexText
(
$r
,
$
=-1)

518 
glob
 
$cfg_so_ng
;

519 if(
	g$r
=='')  '';

520 
	g$okr
 = 
$this
->
SRMM
(
$r
,
ue
,true);

521 
	g$ws
 = 
exode
(' ',
$okr
);

522 
	g$okr
 = 
$wks
 = '';

523 
fܗch
(
$ws
 
as
 
$w
)

525 
	g$w
 = 
im
(
$w
);

527 if(

(
$w
)<2) ;

529 if(!
eg_mch
("/[^0-9:-]/",
$w
)) ;

530 if(

(
$w
)==2&&
d
($w[0])>0x80) ;

531 if(
ist
(
$wks
[
$w
])
	g$wks
[$w]++;

532 
	g$wks
[
$w
] = 1;

534 if(
is_y
(
$wks
))

536 
st
(
$wks
);

537 if(
	g$
==-1)

538 { 
fܗch
(
$wks
 
as
 
$w
=>
$v
)

540 if(
$this
->
GRk
(
$w
)>500
$okr
 .= $w." ";

545 
fܗch
(
$wks
 
as
 
$w
=>
$v
){

546 if((

(
$okr
)+(
$w
)+1)<
$
) $okstr .= $w." ";

551 if(
	g$cfg_so_ng
=='utf-8')

553 
$okr
 = 
gb2utf8
(
$this
->
ResuSg
);

555  
im
(
$okr
);

560 
funi
 
	$GRk
(
$w
){

561 if(
	`ist
(
$this
->
RkDic
[
	`
(
$w
)][$w]))  $this->RankDic[strlen($w)][$w];

563 
	}
}

567 
funi
 
	$GAbNum
(
$um
)

569 
$nums
 = 
	`y
("","","","","","","",

575 
$ums
 = "0123456789+-%.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";

576 
$um
 = 
	`r_a
(
$nums
,
$ums
,$fnum);

577  
$um
;

578 
	}
}

	@include/taglib/adminname.lib.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
funi
 
	$lib_admme
(&
$ag
, &
$fObj
)

6 
glob
 
$dsql
;

7 if(
	`emy
(
$fObj
->
Flds
['dutyadmin']))

9 
$dutyadm
 = 
$GLOBALS
['cfg_df_dutyadmin'];

13 
$row
 = 
$dsql
->
	`GO
("Select uname From `#@__admin` where id='{$refObj->Fields['dutyadmin']}' ");

14 
$dutyadm
 = 
	`ist
(
$row
['ume']? $row['ume'] : 
$GLOBALS
['cfg_df_dutyadmin'];

16  
$dutyadm
;

17 
	}
}

	@include/taglib/arclist.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
	$lib_i
(&
$ag
,&
$fObj
)

7 
glob
 
$vs
;

9 
$autݬtid
 = 0;

10 
$gme
 = 
$ag
->
	`GTagName
();

11 
$chlid
 = 
$ag
->
	`GA
('channelid');

13 if(
$gme
=='imglist' || $tagname=='imginfolist') {

14 
$lity
 = 'image';

16 if(
$gme
=='specart') {

17 
$chlid
 = -1;

18 
$lity
='';

20 if(
$gme
=='coolart') {

21 
$lity
 = 'commend';

23 if(
$gme
=='autolist') {

24 
$autݬtid
 = 
$ag
->
	`GA
('partsort');

27 
$lity
 = 
$ag
->
	`GA
('type');

31 if(
$ag
->
	`GA
('st')!=''
$dby
 = $ctag->GetAtt('sort');

32 if(
$gme
=='h٬t'
$dby
 = 'click';

33 
$dby
 = 
$ag
->
	`GA
('orderby');

36 if(
	`im
(
$ag
->
	`GIText
()!''
$ùext
 = $ctag->GetInnerText();

37 if(
$gme
=='imgli'
$ùext
 = 
	`GSysTems
('part_imglist.htm');

38 if(
$gme
=='imgfi'
$ùext
 = 
	`GSysTems
('part_imginfolist.htm');

39 
$ùext
 = 
	`GSysTems
("part_arclist.htm");

42 if(
$ag
->
	`GA
('tngth')!=''
$tn
 = $ctag->GetAtt('titlelength');

43 
$tn
 = 
$ag
->
	`GA
('titlelen');

46 if(
$ag
->
	`GA
('fޒgth')!=''
$fޒ
 = $ctag->GetAtt('infolength');

47 
$fޒ
 = 
$ag
->
	`GA
('infolen');

49 
$tyid
 = 
	`im
(
$ag
->
	`GA
('typeid'));

50 if(
	`emy
(
$tyid
)) {

51 
$tyid
 = ( 
	`ist
(
$fObj
->
Flds
['tyid']? $fObj->Flds['tyid'] : 
$vs
['typeid'] );

54 if(
$lity
=='autolist') {

55 
$tyid
 = 
	`lib_GAutoChlID
(
$ag
->
	`GA
('partsort'),$typeid);

58 if(
$ag
->
	`GA
('att')=='') {

59 
$ag
 = 
$ag
->
	`GA
('flag');

62 
$ag
 = 
$ag
->
	`GA
('att');

65  
lib_iDe


67 
$fObj
, 
$ag
, 
$tyid
, $ag->
	`GA
('row'), $ag->GA('c'), 
$tn
, 
$fޒ
,

68 
$ag
->
	`GA
('imgwidth'), $ag->GA('imgheight'), 
$lity
, 
$dby
,

69 
$ag
->
	`GA
('keywd'), 
$ùext
, 
$vs
['aid'], $ag->GA('idli'), 
$chlid
,

70 
$ag
->
	`GA
('lim'), 
$ag
,$ctag->GetAtt('orderway'), $ctag->GetAtt('subday'), $ctag->GetAtt('noflag')

72 
	}
}

74 
funi
 
lib_iDe
(&
$fObj
, &
$ag
, 
$tyid
=0, 
$row
=10, 
$c
=1, 
$tn
=30, 
$fޒ
=160,

75 
$imgwidth
=120, 
$imgheight
=90, 
$lity
='l', 
$dby
='deu', 
$keywd
='',

76 
$ùext
='', 
$cid
=0, 
$idli
='', 
$chlid
=0, 
$lim
='', 
$t
='', 
$d
='desc', 
$subday
=0, 
$noag
='')

78 
glob
 
$dsql
,
$PubFlds
,
$cfg_keywd_like
,
$cfg_dex_che
,
$_iEnv
,
$vs
,
$cfg_che_ty
;

79 
	g$row
 = 
ADef
(
$row
,10);

80 
	g$tn
 = 
ADef
(
$tn
,30);

81 
	g$fޒ
 = 
ADef
(
$fޒ
,160);

82 
	g$imgwidth
 = 
ADef
(
$imgwidth
,120);

83 
	g$imgheight
 = 
ADef
(
$imgheight
,120);

84 
	g$lity
 = 
ADef
(
$lity
,'all');

85 
	g$cid
 = 
ADef
(
$cid
,0);

86 
	g$chlid
 = 
ADef
(
$chlid
,0);

87 
	g$dby
 = 
ADef
(
$dby
,'default');

88 
	g$dWay
 = 
ADef
(
$d
,'desc');

89 
	g$subday
 = 
ADef
(
$subday
,0);

90 
	g$le
 = 
$row
;

91 
	g$dby
=
ow
(
$dby
);

92 
	g$keywd
 = 
im
(
$keywd
);

93 
	g$ùext
 = 
im
(
$ùext
);

95 
	g$bwidth
=
$ag
->
GA
('tablewidth');

96 
	g$wr
=
$ag
->
GA
('writer');

97 if(
	g$bwidth
==""
$bwidth
 = 100;

98 if(
emy
(
$c
)
	g$c
 = 1;

99 
	g$cWidth
 = 

(100/
$c
);

100 
	g$bwidth
 = 
$bwidth
."%";

101 
	g$cWidth
 = 
$cWidth
."%";

103 if(
	g$ùext
==''
$ùext
 = 
GSysTems
('part_arclist.htm');

104 if@
	g$ag
->
GA
('gl'=1 ) 
$gl
 = 1;

105 
	g$gl
 = 0;

107 if(
	g$t
=='0'
$t
='';

108 if(
	g$t
=='3'
$t
='f';

109 if(
	g$t
=='1'
$t
='h';

111 
	g$whes
 = 
y
();

112 
	g$mab
 = '#@__archives';

114 if(
	g$idli
=='')

116 if(
$dby
=='ì' && 
$cfg_keywd_like
=='N'{ 
$keywd
=''; }

118 if(
	g$wr
=='this') {

119 
$wmid
 = 
ist
(
$fObj
->
Flds
['mid']) ? $refObj->Fields['mid'] : 0;

120 
	g$whes
[] = "rc.mid = '$wmid' ";

124 if(
	g$subday
 > 0)

126 
	g$ime
 = 
gmmktime
(0, 0, 0, 
gmde
('m'), gmdate('d'), gmdate('Y'));

127 
	g$limday
 = 
$ime
 - (
$subday
 * 24 * 3600);

128 
	g$whes
[] = "rc.senddate > $limitday ";

131 if(
	g$keywd
!='')

133 
$keywd
 = 
r_a
(',', '|', $keyword);

134 
	g$whes
[] = " CONCAT(arc.title,arc.keywords) REGEXP '$keyword' ";

137 if(
egi
('commd',
$lity
)
	g$whes
[] = " FIND_IN_SET('c',rc.flag)>0 ";

138 if(
egi
('image',
$lity
)
	g$whes
[] = " FIND_IN_SET('p',rc.flag)>0 ";

139 if(
	g$t
 != '') {

140 
$ags
 = 
exode
(',', 
$t
);

141 
	g$i
=0; 
ist
(
$ags
[
$i
]); $i++
	g$whes
[] = " FIND_IN_SET('{$flags[$i]}',rc.flag)>0 ";

144 if(!
emy
(
$tyid
&& 
	g$tyid
 != 'top')

147 if
eg
(',', 
$tyid
) )

150 if(
$gl
==1 || 
emy
(
$fObj
->
Flds
['typeid']))

152 
$tyids
 = 
exode
(',', 
$tyid
);

153 
fܗch
(
$tyids
 
as
 
$id
) {

154 
	g$tyidss
[] = 
GSIds
(
$id
);

156 
	g$tyidS
 = 
jo
(',', 
$tyidss
);

157 
	g$tyidss
 = 
exode
(',', 
$tyidS
);

158 
	g$tyidssok
 = 
y_unique
(
$tyidss
);

159 
	g$tyid
 = 
jo
(',', 
$tyidssok
);

161 
	g$whes
[] = "rc.typeid in ($typeid) ";

166 
	g$CrossID
 = '';

167 if(
	g$ag
->
GA
('cross')=='1')

169 
$r
 = 
$dsql
->
GO
("Select `id`,`topid`,`cross`,`crossid`,`ispart`,`typename` From `#@__arctype` where id='$typeid' ");

170 if
	g$r
['oss']==0 || ( 
$r
['oss']==2 && 
im
($arr['crossid']=='') ) )

172 
$whes
[] = 'rc.tyid i('.
GSIds
(
$tyid
).')';

176 
	g$lquy
 = '';

177 if(
	g$r
['cross']==1) {

178 
$lquy
 = "Select id,topid From `#@__arctype` whereypenameike '{$arr['typename']}' And id<>'{$typeid}' Andopid<>'{$typeid}' ";

181 
	g$r
['ossid'] = 
eg_a
('[^0-9,]','',
im
(
$r
['crossid']));

182 if(
	g$r
['ossid']!=''
$lquy
 = "Select id,topid From `#@__arctype` where id in('{$arr['crossid']}') And id<>'{$typeid}' Andopid<>'{$typeid}' ";

184 if(
	g$lquy
!='')

186 
$dsql
->
SQuy
(
$lquy
);

187 
	g$dsql
->
Execu
();

188 
	g$r
 = 
$dsql
->
GAay
())

190 
$CrossID
 .($CrossID=='' ? 
$r
['id'] : ','.$arr['id']);

195 if(
	g$CrossID
==''
$whes
[] = 'rc.tyid i('.
GSIds
(
$tyid
).')';

196 
	g$whes
[] = 'rc.tyid i('.
GSIds
(
$tyid
).','.
$CrossID
.')';

201 if(
egi
('ec', 
$lity
)
	g$chlid
==-1;

203 if(!
emy
(
$chlid
)
	g$whes
[] = " Andrc.channel = '$channelid' ";

205 if(!
emy
(
$noag
))

207 if(!
eg
(',', 
$noag
))

209 
	g$whes
[] = " FIND_IN_SET('$noflag',rc.flag)<1 ";

213 
	g$noags
 = 
exode
(',', 
$noag
);

214 
fܗch
(
$noags
 
as
 
$noag
) {

215 if(
im
(
$noag
)=='') ;

216 
	g$whes
[] = " FIND_IN_SET('$noflag',rc.flag)<1 ";

221 
	g$whes
[] = 'rc.arcrank > -1 ';

228 
	g$dsql
 = '';

229 if(
	g$dby
=='h' || 
$dby
=='ick'
$dsql
 = " order byrc.click $orderWay";

230 if(
	g$dby
 ='s܌k' || 
$dby
=='pubde'
$dsql
 = " order byrc.sortrank $orderWay";

231 if(
	g$dby
 ='id'
$dsql
 = " order byrc.id $orderWay";

232 if(
	g$dby
 ='ì'
$dsql
 = " ord by ABSrc.id - ".
$cid
.")";

233 if(
	g$dby
 ='ϡpo'
$dsql
 = " order byrc.lastpost $orderWay";

234 if(
	g$dby
 ='sces'
$dsql
 = " order byrc.scores $orderWay";

235 if(
	g$dby
 ='nd'
$dsql
 = " order byand()";

236 
	g$dsql
 = " order byrc.sortrank $orderWay";

239 
	g$lim
 = 
im
(
egi_a
('lim','',
$lim
));

240 if(
	g$lim
!=''
$limsql
 = "imit $limit ";

241 
	g$limsql
 = "imit 0,$line ";

243 
	g$whe
 = '';

244 if(
ist
(
$whes
[0])) {

245 
	g$whe
 = 
jo
(' And ',
$whes
);

246 
	g$whe
 = 
eg_a
("^ And",'',
$whe
);

247 
	g$whe
 = 
eg_a
("And[ ]{1,}And",'And ',
$whe
);

249 if(
	g$whe
!=''
$whe
 = " where $orwhere ";

252 
	g$addfld
 = 
im
(
$ag
->
GA
('addfields'));

253 
	g$addfldsSql
 = '';

254 
	g$addfldsSqlJo
 = '';

255 if(
	g$addfld
 !'' && !
emy
(
$chlid
))

257 
$row
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

258 if(
ist
(
$row
['addb']&& 
im
($row['addtable']) != '')

260 
$addb
 = 
im
(
$row
['addtable']);

261 
	g$addflds
 = 
exode
(',', 
$addfld
);

262 
	g$row
['addb'] = 
im
(
$row
['addtable']);

263 
	g$addfldsSql
 = ",addf.".
jo
(',addf.', 
$addflds
);

264 
	g$addfldsSqlJo
 = "eft join `$addtable`ddf onddf.aid =rc.id ";

268 
	g$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.corank,tp.isdefault,tp.defaultname,tp.namerule,

269 

.
mu2
,
	g
.
	git
,.
	gmese
,.
	gseu
,.
sh


270 
$addfldsSql


271 
	gom
 `
	g$mab
` 
c
 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


272 
$addfldsSqlJo


273 
$whe
 
$dsql
 
$limsql
";

275 
$md5hash
 = 
md5
(
$quy
);

276 
	g$yhash
 = (
$cfg_che_ty
=='cڋ' ? 
md5
(
$ùext
) : '');

277 
	g$edSaveCache
 = 
ue
;

279 if(
	g$idli
!='' || 
$GLOBALS
['_iEnv']=='dex' || 
$cfg_dex_che
==0)

281 
$edSaveCache
 = 
l
;

285 
	g$idli
 = 
GAriCache
(
$md5hash
, 
$yhash
);

286 if(
	g$idli
 != '') {

287 
$edSaveCache
 = 
l
;

290 if(
	g$cfg_che_ty
=='cڋ' && 
$idli
 != '')

292 
$idli
 = ($idlist==0 ? '' : $idlist);

293  
	g$idli
;

298 if(
	g$idli
 != '')

300 
$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.corank,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,tp.ispart,

301 

.
mese
,
	g
.
	gseu
,.
sh


302 
$addfldsSql


303 
	gom
 `
	g$mab
` 
c
 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


304 
$addfldsSqlJo


305 
whe
 
c
.
id
 

(
$idli

$dsql
 ";

308 
	g$dsql
->
SQuy
(
$quy
);

309 
	g$dsql
->
Execu
('al');

310 
	g$i
 = '';

311 if(
	g$c
>1
	g$i
 = "<table width='$tablewidth' border='0' cellspacing='0' cellpadding='0'>\r\n";

312 
	g$d2
 = 
w
 
DedeTagP
();

313 
	g$d2
->
SNameS
('field', '[', ']');

314 
	g$d2
->
LdSg
(
$ùext
);

315 
	g$GLOBALS
['autoindex'] = 0;

316 
	g$ids
 = 
y
();

317 
	g$i
=0; $i<
	g$le
; $i++)

319 if(
	g$c
>1
	g$i
 .= "<tr>\r\n";

320 
	g$j
=0; $j<
	g$c
; $j++)

322 if(
	g$c
>1
	g$i
 .= " <td width='$colWidth'>\r\n";

323 if(
	g$row
 = 
$dsql
->
GAay
("al"))

325 
$ids
[] = 
$row
['id'];

327 
	g$row
['fo'] = 
$row
['fos'] = 
_subr
($row['desti'],
$fޒ
);

328 
	g$row
['id'] = 
$row
['id'];

330 if(
	g$row
['corank'] > 0 && $row['arcrank']==0)

332 
$row
['arcrank'] = $row['corank'];

335 
	g$row
['fame'] = 
$row
['cu'] = 
GFeU
($row['id'],$row['typeid'],$row['senddate'],$row['title'],$row['ismake'],

336 
$row
['arcrank'],$row['namerule'],$row['typedir'],$row['money'],$row['filename'],$row['moresite'],$row['siteurl'],$row['sitepath']);

338 
	g$row
['tyu'] = 
GTyU
(
$row
['typeid'],$row['typedir'],$row['isdefault'],$row['defaultname'],$row['ispart'],

339 
$row
['namerule2'],$row['moresite'],$row['siteurl'],$row['sitepath']);

341 if(
	g$row
['lpic'] ='-' || 
$row
['litpic'] == '')

343 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

345 if(!
egi
("^hp://",
$row
['lpic']&& 
	g$GLOBALS
['cfg_multi_site'] == 'Y')

347 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

349 
	g$row
['piame'] = 
$row
['litpic'];

350 
	g$row
['ime'] = 
GDeMK
(
$row
['pubdate']);

351 
	g$row
['tylk'] = "<hf='".
$row
['typeurl']."'>".$row['typename']."</a>";

352 
	g$row
['image'] = "<img src='".
$row
['piame']."' bd='0' width='$imgwidth' height='$imgheight'='".
eg_a
("['><]","",$row['title'])."'>";

353 
	g$row
['imglk'] = "<hf='".
$row
['filename']."'>".$row['image']."</a>";

354 
	g$row
['fut'] = 
$row
['title'];

355 
	g$row
['t'] = 
_subr
(
$row
['t'],
$tn
);

356 if(
	g$row
['c']!=''
$row
['title'] = "<font color='".$row['color']."'>".$row['title']."</font>";

357 if(
eg
('b',
$row
['ag'])
	g$row
['title'] = "<strong>".$row['title']."</strong>";

360 
	g$row
['xk'] = "<hf='".
$row
['filename']."'>".$row['title']."</a>";

362 
	g$row
['usu'] = 
$row
['phpu'] = 
$GLOBALS
['cfg_phpurl'];

363 
	g$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

364 
	g$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

366 if(
is_y
(
$d2
->
CTags
))

368 
fܗch
(
$d2
->
CTags
 
as
 
$k
=>
$ag
)

370 if(
$ag
->
GName
()=='array')

373 
$d2
->
Assign
(
$k
,
$row
);

377 if(
ist
(
$row
[
$ag
->
GName
()])
	g$d2
->
Assign
(
$k
,$row[$ctag->GetName()]);

378 
	g$d2
->
Assign
(
$k
,'');

381 
	g$GLOBALS
['autoindex']++;

384 
	g$i
 .
$d2
->
GResu
()."\r\n";

387 
	g$i
 .= '';

389 if(
	g$c
>1
	g$i
 .= " </td>\r\n";

391 if(
	g$c
>1
	g$i
 +
$c
 - 1;

392 if(
	g$c
>1
	g$i
 .= " </tr>\r\n";

394 if(
	g$c
>1
	g$i
 .= " </table>\r\n";

395 
	g$dsql
->
FeResu
("al");

397 
	g$idsr
 = 
jo
(',',
$ids
);

398 if(
	g$edSaveCache
)

400 if(
	g$idsr
==''
$idsr
 = '0';

401 if(
	g$cfg_che_ty
=='cڋ' && 
$idsr
!='0') {

402 
$idsr
 = 
$i
;

404 
	g$quy
 = "INSERT INTO `#@__cche`(`md5hash`,`yhash`,`uime`,`cheda`VALUES ('".
$md5hash
."','$yhash', '".
time
()."', '$idsstr'); ";

405 
	g$dsql
->
ExecuNeQuy
("DFrom `#@__cche` whmd5hash='".
$md5hash
."' ");

406 
	g$dsql
->
ExecuNeQuy
(
$quy
);

408  
	g$i
;

412 
funi
 
	$GAriCache
(
$md5hash
, 
$yhash
)

414 
glob
 
$dsql
,
$vs
,
$cfg_makesign_che
,
$cfg_dex_che
,
$cfg_che_ty
;

415 if(
$cfg_dex_che
 <= 0)  '';

416 if(
	`ist
(
$vs
['makesign']&& 
$cfg_makesign_che
=='N')  '';

417 
$mtime
 = 
	`time
(- 
$cfg_dex_che
;

418 if(
$cfg_che_ty
=='id') {

419 
$r
 = 
$dsql
->
	`GO
("Select cachedata,uptime From `#@__arccache` where md5hash = '$md5hash' ");

422 
$r
 = 
$dsql
->
	`GO
("Select cachedata,uptime From `#@__arccache` where md5hash = '$md5hash' And stylehash='$stylehash' ");

424 if(!
	`is_y
(
$r
)) {

427 if(
$r
['uime'] < 
$mtime
) {

431  
$r
['cachedata'];

433 
	}
}

435 
funi
 
	$lib_GAutoChlID
(
$stid
,
$tid
)

437 
glob
 
$dsql
;

438 if(
	`emy
(
$stid
)) $sortid = 1;

439 
$gt
 = 
$stid
 - 1;

440 
$row
 = 
$dsql
->
	`GO
("Select id,typename From #@__arctype whereeid='{$topid}' And ispart<2 And ishidden<>'1' order by sortrankscimit $getstart,1");

441 if(!
	`is_y
(
$row
))  0;

442  
$row
['id'];

443 
	}
}

	@include/taglib/arclistsg.lib.php

1 <?
php


2 
funi
 
	$lib_isg
(&
$ag
,&
$fObj
)

4 
glob
 
$dsql
,
$PubFlds
,
$cfg_keywd_like
,
$cfg_dex_che
,
$_iEnv
,
$vs
,
$_sys_globs
;

7 
$i
="typeid|0,row|10,col|1,flag|,titlelen|30,sort|default,keyword|,innertext|,arcid|0,idlist|,channelid|0,limit|,orderway|desc,subday|0";

8 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

9 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

11 
$le
 = 
$row
;

12 
$dby
=
	`ow
(
$st
);

13 if(
$c
=='') $col = 1;

14 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

15 if(
$ùext
==''$ùex
	`GSysTems
("part_arclistsg.htm");

17 if(
	`emy
(
$chlid
&& 
	`ist
(
$GLOBALS
['envs']['channelid'])) {

18 
$chlid
 = 
$GLOBALS
['envs']['channelid'];

21 if(
	`emy
(
$tyid
&& !emy(
$vs
['typeid'])) {

22 
$tyid
 = 
$vs
['typeid'];

25 if(
	`emy
(
$tyid
&&my(
$chlid
))

30 if(!
	`emy
(
$chlid
)
$gquy
 = "Selectddtable,listfields From `#@__channeltype` where id='$channelid' ";

31 
$gquy
 = "Select ch.addtable,listfields From `#@__arctype`peft join `#@__channeltype` ch on ch.id=tp.channeltype where id='$typeid'";

33 
$row
 = 
$dsql
->
	`GO
(
$gquy
);

35 
$whes
 = 
	`y
();

36 
$mab
 = 
	`im
(
$row
['addtable']);

38 if(
$mab
=='')

44 
$lics
 = 
	`y
('aid','typeid');

45 if(!
	`emy
(
$row
['listfields']))

47 
$liflds
 = 
	`exode
(',',
$row
['listfields']);

48 
	`fܗch
(
$liflds
 
as
 
$v
)

50 if(!
	`_y
(
$v
,
$lics
)) $listarcs[] = $v;

53 
$iquy
 = 
	`jo
(',',
$lics
);

54 
$iquy
 .= ",arc.aids id,arc.senddatesubdate";

57 if(
$idli
=='')

59 if(
$dby
=='ì' && 
$cfg_keywd_like
=='N'){ 
$keywd
=''; }

61 if(
$subday
>0)

64 
$ime
 = 
	`gmmktime
(0, 0, 0, 
	`gmde
('m'), gmdate('d'), gmdate('Y'));

65 
$limday
 = 
$ime
 - (
$subday
 * 24 * 3600);

66 
$whes
[] = "rc.senddate > $limitday ";

69 if(
$ag
!='')

71 
$ags
 = 
	`exode
(',',
$ag
);

72 
$i
=0;
	`ist
(
$ags
[$i]);$i++
$whes
[] = " FIND_IN_SET('{$flags[$i]}',flag)>0 ";

75 if(!
	`emy
(
$tyid
))

78 if(
	`eg
(',',
$tyid
)
$whes
[] = "ypeid in ($typeid) ";

82 
$CrossID
 = '';

83 if((
	`ist
(
$vs
['oss']|| 
$ag
->
	`GA
('cross')=='1' ) && $ctag->GetAtt('nocross')!='1')

85 
$r
 = 
$dsql
->
	`GO
("Select `id`,`topid`,`cross`,`crossid`,`ispart`,`typename` From `#@__arctype` where id='$typeid' ");

86 if(
$r
['oss']==0 || ($r['oss']==2 && 
	`im
($arr['crossid']=='')))

87 
$whes
[] = 'yid i('.
	`GSIds
(
$tyid
).')';

90 
$lquy
 = '';

91 if(
$r
['cross']==1) {

92 
$lquy
 = "Select id,topid From `#@__arctype` whereypenameike '{$arr['typename']}' And id<>'{$typeid}' Andopid<>'{$typeid}' ";

95 
$r
['ossid'] = 
	`eg_a
('[^0-9,]','',
	`im
($arr['crossid']));

96 if(
$r
['ossid']!=''
$lquy
 = "Select id,topid From `#@__arctype` where id in('{$arr['crossid']}') And id<>'{$typeid}' Andopid<>'{$typeid}' ";

99 if(
$lquy
!='')

101 
$dsql
->
	`SQuy
(
$lquy
);

102 
$dsql
->
	`Execu
();

103 
$r
 = 
$dsql
->
	`GAay
()) {

104 
$CrossID
 .($CrossID=='' ? 
$r
['id'] : ','.$arr['id']);

109 if(
$CrossID
==''
$whes
[] = 'yid i('.
	`GSIds
(
$tyid
).')';

110 
$whes
[] = 'yid i('.
	`GSIds
(
$tyid
).','.
$CrossID
.')';

115 if(!
	`emy
(
$chlid
)
$whes
[] = " Andrc.channel = '$channelid' ";

121 
$dsql
 = '';

122 if(
$dby
=='h'||$dby=='ick'
$dsql
 = " order byrc.click $orderway";

123 if(
$dby
=='id'
$dsql
 = " order byrc.aid $orderway";

124 if(
$dby
=='ì'
$dsql
 = " ord by ABSrc.id - ".
$cid
.")";

125 if(
$dby
=='nd'
$dsql
 = " order byand()";

126 
$dsql
=" order byrc.aid $orderway";

128 
$lim
 = 
	`im
(
	`egi_a
('limit','',$limit));

129 if(
$lim
!=''
$limsql
 = "imit $limit ";

130 
$limsql
 = "imit 0,$line ";

132 
$whe
 = '';

133 if(
	`ist
(
$whes
[0])) {

134 
$whe
 = 
	`jo
(' And ',
$whes
);

135 
$whe
 = 
	`eg_a
("^ And",'',$orwhere);

136 
$whe
 = 
	`eg_a
("And[ ]{1,}And",'And ',$orwhere);

138 if(
$whe
!='') $orwhere = " where $orwhere ";

140 
$quy
 = "Select $arclistquery,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,

141 

.
mu2
,.
it
,.
mese
,.
seu
,.
sh


142 
om
 `
$mab
` 
c
 

 
jo
 `#@
__y
` 

 

rc.
tyid
p.
id


143 
$whe
 
d
 
c
.
k
 > -1 
$dsql
 
$limsql
";

145 
$md5hash
 = 
	`md5
(
$quy
);

146 
$edche
 = 
ue
;

147 if(
$idli
!=''
$edche
 = 
l
;

149 
$idli
 = 
	`GAriSgCache
(
$md5hash
);

150 if(
$idli
!=''
$edche
 = 
l
;

153 if(
$idli
!='' && 
$_iEnv
 != 'index')

155 
$quy
 = "Select $arclistquery,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,tp.ispart,

156 

.
mese
,.
seu
,.
sh
 
om
 `
$mab
` 
c
 

 
jo
 `#@
__y
`

rc.
tyid
p.
id


157 
whe
 
c
.
aid
 
	`
(
$idli

$dsql
 
$limsql
";

159 
$dsql
->
	`SQuy
(
$quy
);

160 
$dsql
->
	`Execu
("al");

161 
$i
 = "";

162 
$d2
 = 
w
 
	`DedeTagP
();

163 
$d2
->
	`SNameS
("field","[","]");

164 
$d2
->
	`LdSg
(
$ùext
);

165 
$GLOBALS
['autoindex'] = 0;

166 
$ids
 = 
	`y
();

167 
$i
=0;$i<
$le
;$i++)

169 
$j
=0;$j<
$c
;$j++)

171 if(
$c
>1
$i
 .= " <div>\r\n";

172 if(
$row
 = 
$dsql
->
	`GAay
("al"))

174 
$ids
[] = 
$row
['aid'];

176 
$row
['fame'] = $row['cu'] = 
	`GFeU
($row['id'],$row['typeid'],$row['senddate'],$row['title'],1,

177 0,
$row
['namerule'],$row['typedir'],0,'',$row['moresite'],$row['siteurl'],$row['sitepath']);

179 
$row
['tyu'] = 
	`GTyU
($row['typeid'],$row['typedir'],$row['isdefault'],$row['defaultname'],$row['ispart'],

180 
$row
['namerule2'],$row['moresite'],$row['siteurl'],$row['sitepath']);

182 if(
$row
['litpic'] == '-' || $row['litpic'] == '')

184 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

186 if(!
	`egi
("^hp://",
$row
['lpic']&& 
$GLOBALS
['cfg_multi_site'] == 'Y')

188 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

190 
$row
['picname'] = $row['litpic'];

192 
$row
['image'] = "<img src='".$row['piame']."' bd='0'='".
	`eg_a
("['><]","",$row['title'])."' />";

193 
$row
['imglink'] = "<a href='".$row['filename']."'>".$row['image']."</a>";

195 
$row
['ime'] = 
	`GDeMK
($row['pubdate']);

196 
$row
['typelink'] = "<a href='".$row['typeurl']."'>".$row['typename']."</a>";

197 
$row
['fulltitle'] = $row['title'];

198 
$row
['t'] = 
	`_subr
($row['t'],
$tn
);

199 
$row
['textlink'] = "<a href='".$row['filename']."'>".$row['title']."</a>";

200 
$row
['usu'] = $row['phpu'] = 
$GLOBALS
['cfg_phpurl'];

201 
$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

202 
$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

204 if(
	`is_y
(
$d2
->
CTags
))

206 
	`fܗch
(
$d2
->
CTags
 
as
 
$k
=>
$ag
)

208 if(
$ag
->
	`GName
()=='array')

211 
$d2
->
	`Assign
(
$k
,
$row
);

215 if(
	`ist
(
$row
[
$ag
->
	`GName
()])
$d2
->
	`Assign
(
$k
,$row[$ctag->GetName()]);

216 
$d2
->
	`Assign
(
$k
,'');

219 
$GLOBALS
['autoindex']++;

222 
$i
 .
$d2
->
	`GResu
()."\r\n";

225 
$i
 .= '';

227 if(
$c
>1
$i
 .= " </div>\r\n";

229 if(
$c
>1
$i
 += $col - 1;

231 
$dsql
->
	`FeResu
("al");

233 
$idsr
 = 
	`jo
(',',
$ids
);

234 if(
$idsr
!='' && 
$edche
 && 
$cfg_dex_che
>0)

236 
$mtime
 = 
	`time
(- (
$cfg_dex_che
 * 3600);

237 
$quy
 = "INSERT INTO `#@__cche`(`md5hash`,`uime`,`cheda`VALUES ('".
$md5hash
."', '".
	`time
()."', '$idsstr'); ";

238 
$dsql
->
	`ExecuNeQuy
("DFrom `#@__cche` whmd5hash='".
$md5hash
."' or uptime < $mintime ");

239 
$dsql
->
	`ExecuNeQuy
(
$quy
);

241  
$i
;

242 
	}
}

245 
funi
 
	$GAriSgCache
(
$md5hash
)

247 
glob
 
$dsql
,
$vs
,
$cfg_makesign_che
,
$cfg_dex_che
;

249 if(
$cfg_dex_che
<=0)  '';

251 if(
	`ist
(
$vs
['makesign']&& 
$cfg_makesign_che
=='N')  '';

253 
$mtime
 = 
	`time
(- (
$cfg_dex_che
 * 3600);

254 
$r
 = 
$dsql
->
	`GO
("Select cachedata,uptime From `#@__arccache` where md5hash = '$md5hash'nd uptime > $mintime ");

256 if(!
	`is_y
(
$r
))  '';

258  
$r
['cachedata'];

259 
	}
}

261 
funi
 
	$lib_GAutoChlID2
(
$stid
,
$tid
)

263 
glob
 
$dsql
;

264 if(
	`emy
(
$stid
)) $sortid = 1;

265 
$gt
 = 
$stid
 - 1;

266 
$row
 = 
$dsql
->
	`GO
("Select id,typename From #@__arctype whereeid='{$topid}' And ispart<2 And ishidden<>'1' order by sortrankscimit $getstart,1");

267 if(!
	`is_y
(
$row
))  0;

268  
$row
['id'];

269 
	}
}

	@include/taglib/ask.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
	$lib_ask
(&
$ag
,&
$fObj
)

7 
glob
 
$dsql
, 
$vs
, 
$cfg_dbefix
, 
$cfg_cmsu
;

9 
$i
="row|6,qtype|new,tid|0,titlelen|24";

10 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

11 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

13 if!
$dsql
->
	`IsTab
("{$cfg_dbprefix}ask") )  '没安装圈子模块';

15 if(!
	`eg
("/$", 
$cfg_cmsu
)
$cfg_ask_u
 = $cfg_cmsurl."/ask";

16 
$cfg_ask_u
 = 
$cfg_cmsu
."ask";

18 
$ùext
 = 
$ag
->
	`GIText
();

19 if(
	`im
(
$ùext
)==''$ùex
	`GSysTems
("asks.htm");

21 
$qtyQuy
 = '';

22 if(
$tid
>0) $tid = " (tid=$tid Orid2='$tid') And ";

23 
$tid
 = '';

25 if(
$qty
=='commd'
$qtyQuy
 = " $tid digest=1 order by dateline desc ";

27 if(
$qty
=='ok'
$qtyQuy
 = " $tid status=1 order by solvetime desc ";

29 if(
$qty
=='high'
$qtyQuy
 = " $tid status=0 order byeward desc ";

31 
$qtyQuy
 = " $tid status=0 order by disorder desc, dateline desc ";

33 
$p
 = 
w
 
	`DedeTagP
();

34 
$p
->
	`SNameS
('field', '[', ']');

36 
$svgask
 = '';

37 
$quy
 = "select id,id,idname,id2,id2name,itle from `#@__ask` where $qtypeQueryimit 0, $row";

38 
$dsql
->
	`Execu
('me',
$quy
);

39 
$rs
 = 
$dsql
->
	`GAay
('me'))

41 
$rs
['t'] = 
	`_subr
($rs['t'], 
$tn
);

42 
$p
->
	`LdSour
(
$ùext
);

43 if(
$rs
['tid2name'] != '')

45 
$rs
['tid'] = $rs['tid2'];

46 
$rs
['tidname'] = $rs['tid2name'];

48 
$rs
['u'] = 
$cfg_ask_u
."/question.php?id={$rs['id']}";

49 
$rs
['tyu'] = 
$cfg_ask_u
."/browser.php?tid={$rs['tid']}";

50 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
) {

51 if(!
	`emy
(
$rs
[
	`ow
(
$ag
->
	`GName
())])) {

52 
$p
->
	`Assign
(
$gid
,
$rs
[
$ag
->
	`GName
()]);

55 
$svgask
 .
$p
->
	`GResu
();

57  
$svgask
;

58 
	}
}

	@include/taglib/autochannel.lib.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

3 
funi
 
	$lib_autochl
(&
$ag
,&
$fObj
)

5 
glob
 
$dsql
;

7 
$i
='partsort|0,typeid=-1';

8 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

9 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

11 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

12 
$tid
 = 
$tyid
;

13 
$stid
 = 
$st
;

15 if(
$tid
=='-1' || $topid=='')

17 
$tid
 = ( 
	`ist
(
$fObj
->
TyLk
->
TyInfos
['id']) ? $refObj->TypeLink->TypeInfos['id'] : 0);

20 if(
	`emy
(
$stid
)) $sortid = 1;

21 
$gt
 = 
$stid
 - 1;

23 
$row
 = 
$dsql
->
	`GO
("Select id,typename From `#@__arctype` whereeid='{$topid}' And 

24 
it
<2 
And
 
ishidd
<>'1' 
d
 
by
 
s܌k
 
asc
 
lim
 
$gt
,1");

26 if(!
	`is_y
(
$row
) )  '';

27 
$tyid
 = 
$row
['id'];

29 if(
	`im
(
$ùext
)==''$ùex
	`GSysTems
('part_autochannel.htm');

31 
$row
 = 
$dsql
->
	`GO
("Select id,typedir,isdefault,defaultname,ispart,namerule2,typename,moresite,siteurl,sitepath 

32 
From
 `#@
__y
` 
whe
 
id
='$typeid' ");

33 if(!
	`is_y
(
$row
))  '';

35 
$d
 = 
w
 
	`DedeTagP
();

36 
$d
->
	`SNameS
('field','[',']');

37 
$d
->
	`LdSour
(
$ùext
);

38 if(!
	`is_y
(
$d
->
CTags
))

40 
	`unt
(
$d
);

45 
$row
['tylk'] = 
	`GTyU
($row['id'],
	`MfTyd
($row['typedir']),$row['isdefault'],

46 
$row
['defaultname'],$row['ispart'],$row['namerule2'],$row['siteurl'],$row['sitepath']);

47 
	`fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

49 if(
	`ist
(
$row
[
$ag
->
	`GName
()])
$d
->
	`Assign
(
$gid
,$row[$ctag->GetName()]);

51 
$vue
 = 
$d
->
	`GResu
();

52 
	`unt
(
$d
);

53  
$vue
;

55 
	}
}

	@include/taglib/bookcontentlist.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
que_
(
DEDEINC
.'/taglib/booklist.lib.php');

6 
funi
 
	$lib_bookcڋli
(&
$ag
, &
$fObj
)

8 
glob
 
$dsql
, 
$vs
, 
$cfg_dbefix
, 
$cfg_cmsu
;

10 
$i
="row|12,booktype|-1,titlelen|30,orderby|lastpost,author|,keyword|";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 if!
$dsql
->
	`IsTab
("{$cfg_dbprefix}story_books") )  '没安装连载模块';

16  
	`lib_bookli
(
$ag
, 
$fObj
, 1);

18 
	}
}

	@include/taglib/booklist.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

6 
funi
 
	$lib_bookli
(&
$ag
, &
$fObj
, 
$gcڋ
=0)

8 
glob
 
$dsql
, 
$vs
, 
$cfg_dbefix
, 
$cfg_cmsu
;

11 
$i
="row|12,booktype|-1,titlelen|30,orderby|lastpost,author|,keyword|";

12 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

13 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

15 if!
$dsql
->
	`IsTab
("{$cfg_dbprefix}story_books") )  '没安装连载模块';

16 
$addquy
 = '';

18 if(
	`emy
(
$ùext
))

20 if(
$gcڋ
==0
$ùext
 = 
	`GSysTems
('booklist.htm');

21 
$ùext
 = 
	`GSysTems
('bookcontentlist.htm');

25 if(
$bookty
!=-1) {

26 
$addquy
 .= " And b.booktype='{$booktype}' ";

30 if(
$dby
=='commend')

32 
$addquy
 .= " And b.iscommend=1 ";

33 
$dby
 = 'lastpost';

37 if(!
	`emy
(
$auth
))

39 
$addquy
 .= " And b.authorike '$author' ";

43 if(!
	`emy
(
$keywd
))

45 
$keywds
 = 
	`exode
(',', 
$keywd
);

46 
$keywds
 = 
	`y_unique
($keywords);

47 if(
	`cou
(
$keywds
)>0) {

48 
$addquy
 .= " And (";

50 
	`fܗch
(
$keywds
 
as
 
$v
) {

51 
$addquy
 .= " CONCAT(b.author,b.bookname,b.keywords)ike '%$v%' OR";

53 
$addquy
 = 
	`eg_a
(" OR$","",$addquery);

54 
$addquy
 .= ")";

57 
$i
 = '';

58 
$quy
 = "Select b.id,b.catid,b.ischeck,b.booktype,b.iscommend,b.click,b.bookname,b.lastpost,

59 
b
.
auth
,b.
mid
,b.
lpic
,b.
pubde
,b.
wkcc
,b.
mthcc
,b.
desti
,
c
.
asame
,c.asam
as
 
tyme
,c.
bookty

logty


60 
From
 `#@
__y_books
` 
b
 

 
jo
 `#@
__y_log
` 
c
 

 c.
id
=b.
tid


61 
whe
 
b
.
ponum
>0 
And
 b.
ischeck
>0 
$addquy
 
d
 
by
 b.{
$dby
} 
desc
 
lim
 0, 
$row
";

62 
$dsql
->
	`SQuy
(
$quy
);

63 
$dsql
->
	`Execu
();

65 
$nd
 = 
w
 
	`DedeTagP
();

66 
$nd
->
	`SNameS
('field', '[', ']');

67 
$GLOBALS
['autoindex'] = 0;

68 
$row
 = 
$dsql
->
	`GAay
())

70 
$GLOBALS
['autoindex']++;

71 
$row
['title'] = $row['bookname'];

72 
$nd
->
	`LdSg
(
$ùext
);

75 
$row
['contenttitle'] = '';

76 
$row
['contentid'] = '';

77 if(
$gcڋ
==1) {

78 
$ow
 = 
$dsql
->
	`GO
("Select id,title,chapterid From `#@__story_content` where bookid='{$row['id']}' order by id desc ");

79 
$row
['cڋt'] = 
$ow
['title'];

80 
$row
['cڋid'] = 
$ow
['id'];

82 if(
$row
['booktype']==1) {

83 
$row
['cڋu'] = 
$cfg_cmh
.'/book/show-photo.php?id='.$row['contentid'];

86 
$row
['cڋu'] = 
$cfg_cmh
.'/book/story.php?id='.$row['contentid'];

90 
$row
['dmbooku'] = 
$cfg_cmh
.'/book/book.php?id='.$row['id'];

93 
$row
['booku'] = $row['u'] = 
	`GBookU
($row['id'],$row['bookname']);

94 
$row
['logu'] = 
$cfg_cmh
.'/book/list.php?id='.$row['catid'];

95 
$row
['cataloglink'] = "<a href='{$row['catalogurl']}'>{$row['classname']}</a>";

96 
$row
['booklink'] = "<a href='{$row['bookurl']}'>{$row['bookname']}</a>";

97 
$row
['contentlink'] = "<a href='{$row['contenturl']}'>{$row['contenttitle']}</a>";

98 
$row
['imglink'] = "<a href='{$row['bookurl']}'><img src='{$row['litpic']}' width='$imgwidth' height='$imgheight' border='0' /></a>";

100 if(
$row
['ischeck']==2) $row['ischeck']='已完成连载';

101 
$row
['ischeck']='连载中...';

103 if(
$row
['booktype']==0) $row['booktypename']='小说';

104 
$row
['booktypename']='漫画';

106 if(
	`is_y
(
$nd
->
CTags
))

108 
	`fܗch
(
$nd
->
CTags
 
as
 
$gid
=>
$ag
)

110 
$gme
 = 
$ag
->
	`GTagName
();

111 if(
	`ist
(
$row
[
$gme
])
$nd
->
	`Assign
(
$gid
,$row[$tagname]);

112 
$nd
->
	`Assign
(
$gid
,'');

115 
$i
 .
$nd
->
	`GResu
();

118  
$i
;

119 
	}
}

	@include/taglib/cattree.lib.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
funi
 
	$lib_e
(&
$ag
, &
$fObj
)

6 
glob
 
$dsql
;

10 
$i
="showall|,catid|0";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

13 
$vue
 = '';

15 if(
	`emy
(
$tyid
))

17 if
	`ist
(
$fObj
->
TyLk
->
TyInfos
['id']) ) {

18 
$tyid
 = 
$fObj
->
TyLk
->
TyInfos
['id'];

19 
$id
 = 
$fObj
->
TyLk
->
TyInfos
['reid'];

20 
$tid
 = 
$fObj
->
TyLk
->
TyInfos
['topid'];

21 
$chy
 = 
$fObj
->
TyLk
->
TyInfos
['channeltype'];

22 
$it
 = 
$fObj
->
TyLk
->
TyInfos
['ispart'];

23 if(
$id
==0
$tid
 = 
$tyid
;

25 
$tyid
 = 
$id
 = 
$tid
 = 
$chy
 = 
$it
 = 0;

30 
$row
 = 
$dsql
->
	`GO
("Selecteid,topid,channeltype,ispart From `#@__arctype` where id='$typeid' ");

31 if(!
	`is_y
(
$row
))

33 
$tyid
 = 
$id
 = 
$tid
 = 
$chy
 = 
$it
 = 0;

35 
$id
 = 
$row
['reid'];

36 
$tid
 = 
$row
['topid'];

37 
$chy
 = 
$row
['channeltype'];

38 
$it
 = 
$row
['ispart'];

41 if!
	`emy
(
$tid
) )

43 
$tQuy
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath From `#@__arctype` whereeid='$catid' And ishidden<>1 ";

47 if(
$showl
 == "yes" )

49 
$tQuy
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath From `#@__arctype` whereeid='$topid' ";

53 if(
$showl
=='')

55 if
$it
 < 2 && !
	`emy
(
$chy

$showl
 = $channeltype;

56 
$showl
 = 6;

58 
$tQuy
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath From `#@__arctype` whereeid='{$topid}' And channeltype='{$showall}' And ispart<2 And ishidden<>1 ";

61 
$dsql
->
	`Execu
('t', 
$tQuy
);

62 
$row
 = 
$dsql
->
	`GAay
('t'))

64 
$row
['tylk'] = 
	`GOTyUA
($row);

65 
$vue
 .= "<dl class='cattree'>\n";

66 
$vue
 .= "<dt><a href='{$row['typelink']}'>{$row['typename']}</a></dt>\n";

67 
	`eLiS
(
$row
['id'], 
$vue
);

68 
$vue
 .= "</dl>\n";

70  
$vue
;

71 
	}
}

73 
funi
 
	$eLiS
(
$id
, &
$vue
)

75 
glob
 
$dsql
;

76 
$quy
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath From `#@__arctype` whereeid='{$id}' And ishidden<>1 ";

77 
$dsql
->
	`Execu
(
$id
, 
$quy
);

78 
$thisv
 = '';

79 
$row
 = 
$dsql
->
	`GAay
(
$id
))

81 
$row
['tylk'] = 
	`GOTyUA
($row);

82 
$thisv
 .= " <dl class='cattree'>\n";

83 
$thisv
 .= " <dt><a href='{$row['typelink']}'>{$row['typename']}</a></dt>\n";

84 
	`eLiS
(
$row
['id'], 
$thisv
);

85 
$thisv
 .= " </dl>\n";

87 if(
$thisv
!=''
$vue
 .= " <dd>\n$thisv </dd>\n";

88 
	}
}

	@include/taglib/channel.lib.php

1 <?
php


2 
funi
 
	$lib_chl
(&
$ag
,&
$fObj
)

4 
glob
 
$dsql
;

6 
$i
 = "typeid|0,reid|0,row|100,col|1,type|son,currentstyle|,cacheid|";

7 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

8 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

9 
$ùext
 = 
$ag
->
	`GIText
();

10 
$le
 = 
	`emy
(
$row
) ? 100 : $row;

12 
$likeTy
 = '';

14 
$cheid
 = 
	`im
($cacheid);

15 if(
$cheid
 !='') {

16 
$likeTy
 = 
	`GCacheBlock
(
$cheid
);

17 if(
$likeTy
 != '')  $likeType;

20 
$id
 = 0;

21 
$tid
 = 0;

23 if(
	`emy
(
$tyid
))

25 if
	`ist
(
$fObj
->
TyLk
->
TyInfos
['id']) )

27 
$tyid
 = 
$fObj
->
TyLk
->
TyInfos
['id'];

28 
$id
 = 
$fObj
->
TyLk
->
TyInfos
['reid'];

29 
$tid
 = 
$fObj
->
TyLk
->
TyInfos
['topid'];

32 
$tyid
 = 0;

38 
$row2
 = 
$dsql
->
	`GO
("Select * From `#@__arctype` where id='$typeid' ");

39 
$tyid
 = 
$row2
['id'];

40 
$id
 = 
$row2
['reid'];

41 
$tid
 = 
$row2
['topid'];

42 
$istInfos
 = 
ue
;

45 if(
$ty
=='' || $type=='sun') $type='son';

46 if(
$ùext
==''$ùex
	`GSysTems
("channel_list.htm");

48 if(
$ty
=='top')

50 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

51 
From
 `#@
__y
` 
whe
 
id
=0 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0, 
$le
 ";

53 if(
$ty
=='son')

55 if(
$tyid
==0)  '';

56 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

57 
From
 `#@
__y
` 
whe
 
id
='$tyid' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0, 
$le
 ";

59 if(
$ty
=='self')

61 if(
$id
==0)  '';

62 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

63 
From
 `#@
__y
` 
whe
 
id
='$id' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0, 
$le
 ";

66 
$edR
 = 
l
;

67 
$d2
 = 
w
 
	`DedeTagP
();

68 
$d2
->
	`SNameS
('field','[',']');

69 
$d2
->
	`LdSour
(
$ùext
);

71 if(
	`eg
(':l', 
$ùext
)
$edR
 = 
ue
;

73 if(
	`emy
(
$sql
))  '';

74 
$dsql
->
	`SQuy
(
$sql
);

75 
$dsql
->
	`Execu
();

77 
$tٮRow
 = 
$dsql
->
	`GTٮRow
();

79 if(
$ty
=='s' && 
$id
!=0 && 
$tٮRow
==0)

81 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

82 
From
 `#@
__y
` 
whe
 
id
='$id' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0, 
$le
 ";

83 
$dsql
->
	`SQuy
(
$sql
);

84 
$dsql
->
	`Execu
();

86 
$GLOBALS
['autoindex'] = 0;

87 
$i
=0;$< 
$le
;$i++)

89 if(
$c
>1
$likeTy
 .= "<dl>\r\n";

90 
$j
=0; $j<
$c
; $j++)

92 if(
$c
>1
$likeTy
 .= "<dd>\r\n";

93 if(
$row
=
$dsql
->
	`GAay
())

95 
$row
['sonids'] = $row['rel'] = '';

96 if(
$edR
)

98 
$row
['sids'] = 
	`GSIds
($row['id'], 0, 
l
);

99 if(
$row
['sonids']=='') $row['rel'] = '';

100 
$row
['rel'] = "el='dropmenu{$row['id']}'";

103 if(
$row
['id']==
$tyid
 || (
$tid
==$row['id'] && 
$ty
=='t'&& 
$cuty
!='' )

105 
$lkOkr
 = 
$cuty
;

106 
$row
['tylk'] = 
	`GOTyUA
($row);

107 
$lkOkr
 = 
	`r_a
("~l~",
$row
['rel'],$linkOkstr);

108 
$lkOkr
 = 
	`r_a
("~id~",
$row
['id'],$linkOkstr);

109 
$lkOkr
 = 
	`r_a
("~tylk~",
$row
['typelink'],$linkOkstr);

110 
$lkOkr
 = 
	`r_a
("~tyme~",
$row
['typename'],$linkOkstr);

111 
$likeTy
 .
$lkOkr
;

115 
$row
['tylk'] = $row['tyu'] = 
	`GOTyUA
($row);

116 if(
	`is_y
(
$d2
->
CTags
))

118 
	`fܗch
(
$d2
->
CTags
 
as
 
$gid
=>
$ag
)

120 if(
	`ist
(
$row
[
$ag
->
	`GName
()])
$d2
->
	`Assign
(
$gid
,$row[$ctag->GetName()]);

123 
$likeTy
 .
$d2
->
	`GResu
();

126 if(
$c
>1
$likeTy
 .= "</dd>\r\n";

127 
$GLOBALS
['autoindex']++;

130 if(
$c
>1)

132 
$i
 +
$c
 - 1;

133 
$likeTy
 .= " </dl>\r\n";

137 
$dsql
->
	`FeResu
();

138 if(
$cheid
 !='') {

139 
	`WreCacheBlock
(
$cheid
, 
$likeTy
);

141  
$likeTy
;

142 
	}
}

	@include/taglib/channel/img.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
ch_img
(
$fvue
,&
$cTag
,&
$fObj
,
$ame
='')

9 
glob
 
$cfg_bum_width
,
$cfg_bum_row
,
$cfg_bum_c
,
$cfg_bum_gesize
,
$cfg_bum_y
,
$cfg_bum_ddwidth
,
$cfg_baho
,
$cfg_mui_se
;

10 
	g$d
 = 
w
 
DedeTagP
();

11 
	g$d
->
LdSour
(
$fvue
);

12 if(!
is_y
(
$d
->
CTags
))

14 
	g$d
->
Cˬ
();

17 
	g$gey
 = 
$cfg_bum_y
;

18 
	g$maxwidth
 = 
$cfg_bum_width
;

19 
	g$ddmaxwidth
 = 
$cfg_bum_ddwidth
;

20 
	g$gium
 = 
$cfg_bum_gesize
;

21 
	g$row
 = 
$cfg_bum_row
;

22 
	g$ic
 = 
$cfg_bum_c
;

23 
	g$ag
 = 
$d
->
GTag
('pagestyle');

24 if(
is_obje
(
$ag
))

26 
	g$gey
 = 
$ag
->
GA
('value');

27 
	g$maxwidth
 = 
$ag
->
GA
('maxwidth');

28 
	g$ddmaxwidth
 = 
$ag
->
GA
('ddmaxwidth');

29 
	g$gium
 = 
$ag
->
GA
('pagepicnum');

30 
	g$ow
 = 
$ag
->
GA
('row');

31 
	g$ic
 = 
$ag
->
GA
('col');

32 if(
emy
(
$maxwidth
))

34 
	g$maxwidth
 = 
$cfg_bum_width
;

39 
	g$mrow
 = 0;

40 
	g$mc
 = 0;

41 
	g$images
 = 
y
();

42 
	g$rTmp
 = 
$cTag
->
GIText
();

43 if(
im
(
$rTmp
)=='')

45 
$rTmp
 = 
GSysTems
("channel_article_image.htm");

48 if(
	g$gey
==1)

50 
$gesize
 = 
$gium
;

52 if(
	g$gey
==2)

54 
$gesize
 = 1;

58 
	g$gesize
 = 
$ow
 * 
$ic
;

61 if(
is_obje
(
$cTag
&& 
	g$cTag
->
GA
('pagesize') > 0)

63 
	g$gesize
 = 
$cTag
->
GA
('pagesize');

65 if(
emy
(
$gesize
))

67 
	g$gesize
 = 12;

70 
	g$vue
 = '';

71 
	g$GLOBAL
['photoid'] = 0;

72 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

74 if(
	g$ag
->
GName
()=="img")

76 
$flds
 = 
$ag
->
CAribu
->
Ims
;

77 
	g$flds
['xt'] = 
r_a
("'","",
$ag
->
GA
('text'));

78 
	g$flds
['imgc'] = 
im
(
$ag
->
GIText
());

79 
	g$flds
['imgrue'] = 
$flds
['imgsrc'];

80 if(
emy
(
$flds
['ddimg']))

82 
	g$flds
['ddimg'] = 
$flds
['imgsrc'];

84 if(
	g$cfg_mui_se
=='Y')

87 if!
egi
('^hp:', 
$flds
['imgsrc']) ) {

88 
$flds
['imgc'] = 
$cfg_baho
.$fields['imgsrc'];

90 if!
egi
('^hp:', 
$flds
['ddimg']) ) {

91 
	g$flds
['ddimg'] = 
$cfg_baho
.
$flds
['ddimg'];

94 if(
emy
(
$flds
['width']))

96 
	g$flds
['width'] = 
$maxwidth
;

102 
	g$flds
['ext'] = 
r_a
("'",'',
$flds
['text']);

103 
	g$flds
['gey'] = 
$gey
;

104 
	g$d2
 = 
w
 
DedeTagP
();

105 
	g$d2
->
SNameS
("field","[","]");

106 
	g$d2
->
LdSour
(
$rTmp
);

107 if(
	g$GLOBAL
['phoid']>0 && ($GLOBAL['phoid'] % 
	g$gesize
)==0)

109 
$vue
 .= "#p#分页标题#e#";

111 if(
	g$gey
==1)

113 
$flds
['imgwidth'] = '';

114 
	g$flds
['lku'] = 
$flds
['imgsrc'];

115 
	g$flds
['textlink'] = "<br /><a href='{$fields['linkurl']}'arget='_blank'>{$fields['text']}</a>";

117 if(
	g$gey
==2)

119 if(
$flds
['width'] > 
$maxwidth
) {

120 
$flds
['imgwidth'] = " width='$maxwidth' ";

123 
	g$flds
['imgwidth'] = " width='{$fields['width']}' ";

125 
	g$flds
['lku'] = 
$flds
['imgsrc'];

126 if(
	g$flds
['text']!='') {

127 
$flds
['textlink'] = "<br /><a href='{$fields['linkurl']}'arget='_blank'>{$fields['text']}</a>\r\n";

130 
	g$flds
['textlink'] = '';

133 if(
	g$gey
==3)

135 
$flds
['text'] = $fields['textlink'] = '';

136 
	g$flds
['imgc'] = 
$flds
['ddimg'];

137 
	g$flds
['imgwidth'] = " width='$ddmaxwidth' ";

138 
	g$flds
['lku'] = "{$GLOBALS['cfg_phpu']}/showpho.php?aid={$fObj->ArcID}&c=".
ucode
(
$flds
['imgsrctrue'])."&npos={$GLOBAL['photoid']}";

140 if(
is_y
(
$d2
->
CTags
))

142 
fܗch
(
$d2
->
CTags
 
as
 
$gid
=>
$ag
)

144 if(
ist
(
$flds
[
$ag
->
GName
()]))

146 
$d2
->
Assign
(
$gid
,
$flds
[
$ag
->
GName
()]);

149 
	g$vue
 .
$d2
->
GResu
();

151 
	g$GLOBAL
['photoid']++;

154  
	g$vue
;

	@include/taglib/channel/softlinks.lib.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
funi
 
ch_solks
(
$fvue
, &
$ag
, &
$fObj
, 
$ame
='', 
$dowdge
=
l
)

6 
glob
 
$dsql
;

7 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__softconfig` ");

8 
	g$phh
 = 
$GLOBALS
['cfg_phpurl'];

9 
	g$dowƚks
 = '';

10 if(
	g$row
['dowy']!='0' && !
$dowdge
)

12 
$mpS
 = 
GSysTems
("channel_downlinkpage.htm");

13 
	g$lks
 = 
$phh
."/dowd.php?ݒ=0&aid=".
$fObj
->
ArcID
."&cid=".$fObj->
ChlID
;

14 
	g$dowƚks
 = 
r_a
("~lk~", 
$lks
, 
$mpS
);

15  
	g$dowƚks
;

19  
ch_solks_l
(
$fvue
, 
$ag
, 
$fObj
, 
$row
);

24 
funi
 
	$ch_solks_l
(
$fvue
, &
$ag
, &
$fObj
, &
$row
)

26 
glob
 
$dsql
, 
$cfg_phpu
;

27 
$phh
 = 
$cfg_phpu
;

28 
$d
 = 
w
 
	`DedeTagP
();

29 
$d
->
	`LdSour
(
$fvue
);

30 if!
	`is_y
(
$d
->
CTags
) )

32 
$d
->
	`Cˬ
();

35 
$mpS
 = 
	`GSysTems
('channel_downlinks.htm');

36 
$dowƚks
 = '';

37 
	`fܗch
(
$d
->
CTags
 
as
 
$ag
)

39 if(
$ag
->
	`GName
()=='link')

41 
$lk
 = 
	`im
(
$ag
->
	`GIText
());

42 
$rvName
 = 
	`im
(
$ag
->
	`GA
('text'));

43 
$iol
 = 
	`im
(
$ag
->
	`GA
('islocal'));

46 if(!
	`ist
(
$fLk
&& 
$iol
==1$fLk = 
$lk
;

47 if(
$iol
==1 && 
$row
['islocal'] != 1) ;

50 if(!
	`egi
('^hp://|^thund://|^p://|^ashg://', 
$lk
))

52 
$lk
 = 
$GLOBALS
['cfg_mainsite'].$link;

54 
$dowds
 = 
	`gDowds
(
$lk
);

55 
$uhash
 = 
	`subr
(
	`md5
(
$lk
), 0, 24);

56 if(
$row
['gotojump']==1)

58 
$lk
 = 
$phh
."/download.php?open=2&id={$refObj->ArcID}&uhash={$uhash}";

60 
$mp
 = 
	`r_a
("~lk~",
$lk
,
$mpS
);

61 
$mp
 = 
	`r_a
("~rv~",
$rvName
,$temp);

62 
$mp
 = 
	`r_a
("~dowds~",
$dowds
,$temp);

63 
$dowƚks
 .
$mp
;

66 
$d
->
	`Cˬ
();

69 
$lkCou
 = 1;

70 if(
$row
['ismese']==1 && $row['mesedo']==1 && 
	`im
($row['ses'])!='' && 
	`ist
(
$fLk
))

72 
$fLk
 = 
	`egi_a
("http://([^/]*)/", '/', $firstLink);

73 
$row
['ses'] = 
	`eg_a
("[\r\n]{1,}", "\n", $row['sites']);

74 
$ses
 = 
	`exode
("\n", 
	`im
(
$row
['sites']));

75 
	`fܗch
(
$ses
 
as
 
$se
)

77 if(
	`im
(
$se
)=='') ;

78 
	`li
(
$lk
,
$rvName

	`exode
('|', 
$se
);

79 
$lk
 = 
	`im

	`eg_a
("/$", "",$lk).
$fLk
;

80 
$dowds
 = 
	`gDowds
(
$lk
);

81 
$uhash
 = 
	`subr
(
	`md5
(
$lk
), 0, 24);

82 if(
$row
['gotojump']==1)

84 
$lk
 = 
$phh
."/download.php?open=2&id={$refObj->ArcID}&uhash={$uhash}";

86 
$mp
 = 
	`r_a
("~lk~", 
$lk
, 
$mpS
);

87 
$mp
 = 
	`r_a
("~rv~", 
$rvName
, $temp);

88 
$mp
 = 
	`r_a
("~dowds~", 
$dowds
, $temp);

89 
$dowƚks
 .
$mp
;

92  
$dowƚks
;

93 
	}
}

95 
funi
 
	$gDowds
(
$u
)

97 
glob
 
$dsql
;

98 
$hash
 = 
	`md5
(
$u
);

99 
$quy
 = "select downloads from `#@__downloads` where hash='$hash' ";

100 
$row
 = 
$dsql
->
	`GO
(
$quy
);

101 if(
	`is_y
(
$row
))

103 
$dowds
 = 
$row
['downloads'];

107 
$dowds
 = 0;

109  
$dowds
;

110 
	}
}

	@include/taglib/channel/specialtopic.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
ch_ecic
(
$nefo
, 
$cTag
, 
$fObj
, 
$ame
='')

7 
que_
(
DEDEINC
.'/taglib/arclist.lib.php');

8 if(
	g$nefo
=='')  '';

9 
	g$neid
 = 
$cTag
->
GA
('noteid');

10 
	g$rvue
 = '';

11 
	g$mpS
 = 
GSysTems
('channel_spec_note.htm');

12 
	g$d
 = 
w
 
DedeTagP
();

13 
	g$d
->
LdSour
(
$nefo
);

14 if(
is_y
(
$d
->
CTags
))

16 
fܗch
(
$d
->
CTags
 
as
 
$k
=>
$ag
)

18 
$nْame
 = 
$ag
->
GA
('name');

20 if(
	g$neid
 !'' && 
$ag
->
GA
('neid'!
$neid
)

24 
	g$iuto
 = 
$ag
->
GA
('isauto');

25 
	g$idli
 = 
im
(
$ag
->
GA
('idlist'));

26 
	g$rownum
 = 
im
(
$ag
->
GA
('rownum'));

27 
	g$keywds
 = '';

28 
	g$yid
 = 0;

29 if(
emy
(
$rownum
)
	g$rownum
 = 40;

32 if(
	g$iuto
==1)

34 
$idli
 = '';

35 
	g$keywds
 = 
im
(
$ag
->
GA
('keywords'));

36 
	g$yid
 = 
$ag
->
GA
('typeid');

39 
	g$liTem
 = 
im
(
$ag
->
GIText
())!='' ? $ag->GIText(: 
GSysTems
('spec_arclist.htm');

41 
	g$idvue
 = 
lib_iDe


43 
$fObj
, 
	g$ag
, 
	g$yid
, 
	g$rownum
, $ag->
GA
('col'), $ctag->GetAtt('titlelen'),$ctag->GetAtt('infolen'),

44 
	g$ag
->
GA
('imgwidth'), $ag->GA('imgheight'), 'l', 'deu', 
	g$keywds
, 
	g$liTem
, 0, 
	g$idli
,

45 
	g$ag
->
GA
('channel'), '', $ctag->GetAtt('att')

47 
	g$ner
 = 
r_a
('~nْame~', 
$nْame
, 
$mpS
);

48 
	g$ner
 = 
r_a
('~ec_i~', 
$idvue
, 
$ner
);

49 
	g$rvue
 .
$ner
;

50 if(
	g$neid
 !'' && 
$ag
->
GA
('neid')==
$neid
) ;

53 
	g$d
->
Cˬ
();

54  
	g$rvue
;

	@include/taglib/channel/stepselect.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
ch_
(
$fvue
,&
$cTag
,&
$fObj
,
$ame
='')

9  
GEnumsVue2
(
$ame
,
$fvue
);

13 
funi
 
	$GEnumsVue2
(
$egroup
,
$evue
=0)

15 if!
	`ist
(
$GLOBALS
['em_'.
$egroup
.'s']) )

17 
$chefe
 = 
DEDEDATA
.'/ums/'.
$egroup
.'.php';

18 if(!
	`fe_exis
(
$chefe
))

20 
	`que_
(
DEDEINC
.'/enums.func.php');

21 
	`WreEnumsCache
();

23 if(!
	`fe_exis
(
$chefe
))

29 
	`que_
(
$chefe
);

32 if(
$evue
>=500)

34 if(
$evue
 % 500 == 0)

36  (
	`ist
(
$GLOBALS
['em_'.
$egroup
.'s'][
$evue
]) ? $GLOBALS['em_'.$egroup.'s'][$evalue] : '');

40 
$im
 = 
$evue
 % 500;

41 
$evue
 = 
$evue
 - 
$im
;

42  
$GLOBALS
['em_'.
$egroup
.'s'][
$evue
].' -- '.$GLOBALS['em_'.$egroup.'s'][
$evue
];

45 
	}
}

	@include/taglib/channelartlist.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
que_
(
DEDEINC
.'/arc.partview.class.php');

6 
funi
 
	$lib_chϹli
(&
$ag
,&
$fObj
)

8 
glob
 
$dsql
,
$vs
,
$_sys_globs
;

11 
$i
 = 'typeid|0,row|20,cacheid|';

12 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

13 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

15 
$i
 = '';

17 
$cheid
 = 
	`im
($cacheid);

18 if(
$cheid
 !='') {

19 
$i
 = 
	`GCacheBlock
(
$cheid
);

20 if(
$i
!='')  $artlist;

23 if(
	`emy
(
$tyid
))

25 
$tyid
 = ( !
	`emy
(
$fObj
->
TyLk
->
TyInfos
['id']) ? $refObj->TypeLink->TypeInfos['id'] : 0 );

28 if(
$ùext
==''$ùex
	`GSysTems
('part_channelartlist.htm');

29 
$tٮnum
 = 
$row
;

30 if(
	`emy
(
$tٮnum
)) $totalnum = 20;

33 
$tyids
 = 
	`y
();

34 if(
$tyid
==0 || $typeid=='top') {

35 
$sql
 = "eid=0 And ispart<>2 And ishidden<>1 And channeltype>0 ";

39 if(!
	`eg
(',',
$tyid
)) {

40 
$sql
 = "eid='$typeid' And ispart<>2 And ishidden<>1 ";

43 
$sql
 = " id in($typeid) And ispart<>2 And ishidden<>1 ";

46 
$dsql
->
	`SQuy
("Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath 

47 
om
 `#@
__y
` 
whe
 
$sql
 
d
 
by
 
s܌k
 
asc
 
lim
 
$tٮnum
");

48 
$dsql
->
	`Execu
();

49 
$row
 = 
$dsql
->
	`GAay
()) {

50 
$tyids
[] = 
$row
;

53 if(!
	`ist
(
$tyids
[0]))  '';

55 
$GLOBALS
['itemindex'] = 0;

56 
$GLOBALS
['itemparity'] = 1;

57 
$i
=0;
	`ist
(
$tyids
[$i]);$i++)

59 
$GLOBALS
['itemindex']++;

60 
$pv
 = 
w
 
	`PtVw
(
$tyids
[
$i
]['id']);

61 
$pv
->
Flds
['tyu'] = 
	`GOTyUA
(
$tyids
[
$i
]);

62 
$pv
->
	`STem
(
$ùext
,'string');

63 
$i
 .
$pv
->
	`GResu
();

64 
$GLOBALS
['itemparity'] = ($GLOBALS['itemparity']==1 ? 2 : 1);

67 
$GLOBALS
['vs']['tyid'] = 
$_sys_globs
['typeid'];

68 
$GLOBALS
['envs']['reid'] = '';

69 if(
$cheid
 !='') {

70 
	`WreCacheBlock
(
$cheid
, 
$i
);

72  
$i
;

73 
	}
}

	@include/taglib/demotag.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
funi
 
	$lib_demag
(&
$ag
,&
$fObj
)

8 
glob
 
$dsql
,
$vs
;

11 
$i
="row|12,titlelen|24";

12 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

13 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 
$vue
 = '';

19 
$vue
 = 'Hello Word!';

22  
$vue
;

23 
	}
}

	@include/taglib/feedback.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

15 
funi
 
	$lib_edback
(&
$ag
,&
$fObj
)

17 
glob
 
$dsql
;

18 
$i
="row|12,titlelen|24,infolen|100";

19 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

20 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

21 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

22 
$tٮrow
 = 
$row
;

23 
$vue
 = '';

24 if(
	`emy
(
$ùext
))

26 
$ùext
 = 
	`GSysTems
('tag_feedback.htm');

28 
$wsql
 = " where ischeck=1 ";

29 
$equy
 = "SELECT * FROM `#@__feedback` $wsql ORDER BY id DESC LIMIT 0 , $totalrow";

30 
$p
 = 
w
 
	`DedeTagP
();

31 
$p
->
	`SNameS
('field','[',']');

32 
$p
->
	`LdSour
(
$ùext
);

34 
$dsql
->
	`Execu
('fb',
$equy
);

35 
$r
=
$dsql
->
	`GAay
('fb'))

37 
$r
['t'] = 
	`_subr
($r[''],
$tn
);

38 
$r
['msg'] = 
	`jrim
($r['msg'],
$fޒ
);

39 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
)

41 if(!
	`emy
(
$r
[
$ag
->
	`GName
()]))

43 
$p
->
	`Assign
(
$gid
,
$r
[
$ag
->
	`GName
()]);

46 
$vue
 .
$p
->
	`GResu
();

48  
$vue
;

49 
	}
}

	@include/taglib/flink.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
	$lib_k
(&
$ag
,&
$fObj
)

9 
glob
 
$dsql
;

10 
$i
="type|textall,row|24,titlelen|24,linktype|1,typeid|0";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 
$tٮrow
 = 
$row
;

15 
$vue
 = '';

17 
$wsql
 = " where ischeck >= '$linktype' ";

18 if(
$tyid
 == 0)

20 
$wsql
 .= '';

24 
$wsql
 .= "Andypeid = '$typeid'";

26 if(
$ty
=='image')

28 
$wsql
 .= " Andogo<>'' ";

30 if(
$ty
=='text')

32 
$wsql
 .= " Andogo='' ";

35 
$equy
 = "Select * from #@__flink $wsql order by sortrankscimit 0,$totalrow";

37 if(
	`im
(
$ag
->
	`GIText
())==''
$ùext
 = "<li>[field:link /]</li>";

38 
$ùext
 = 
$ag
->
	`GIText
();

40 
$dsql
->
	`SQuy
(
$equy
);

41 
$dsql
->
	`Execu
();

42 
$dbrow
=
$dsql
->
	`GObje
())

44 if(
$ty
=='text'||$type=='textall')

46 
$lk
 = "<hf='".
$dbrow
->
u
."'g='_bnk'>".
	`_subr
($dbrow->
webme
,
$tn
)."</a> ";

48 if(
$ty
=='image')

50 
$lk
 = "<hf='".
$dbrow
->
u
."'g='_bnk'><img src='".$dbrow->
logo
."' width='88' height='31' border='0'></a> ";

54 if(
$dbrow
->
logo
=='')

56 
$lk
 = "<hf='".
$dbrow
->
u
."'g='_bnk'>".
	`_subr
($dbrow->
webme
,
$tn
)."</a> ";

60 
$lk
 = "<hf='".
$dbrow
->
u
."'g='_bnk'><img src='".$dbrow->
logo
."' width='88' height='31' border='0'></a> ";

63 
$rbxt
 = 
	`eg_a
("/\[fld:u([\/\s]{0,})\]/isU", 
$row
['u'], 
$ùext
);

64 
$rbxt
 = 
	`eg_a
("/\[fld:webme([\/\s]{0,})\]/isU", 
$row
['webname'], $rbtext);

65 
$rbxt
 = 
	`eg_a
("/\[fld:logo([\/\s]{0,})\]/isU", 
$row
['logo'], $rbtext);

66 
$rbxt
 = 
	`eg_a
("/\[fld:lk([\/\s]{0,})\]/isU", 
$lk
, $rbtext);

67 
$vue
 .
$rbxt
;

69  
$vue
;

70 
	}
}

	@include/taglib/group.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
	$lib_group
(&
$ag
,&
$fObj
)

7 
glob
 
$dsql
, 
$vs
, 
$cfg_dbefix
, 
$
;

9 
$i
="row|6,orderby|threads,titlelen|30";

10 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

11 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

13 if!
$this
->
dsql
->
	`IsTab
("{$cfg_dbprefix}groups") )  '没安装圈子模块';

15 if(!
	`eg
("/$", 
$
)
$cfg_group_u
 = $.'/group';

16 
$cfg_group_u
 = 
$
.'group';

18 
$ùext
 = 
$ag
->
	`GIText
();

19 if(
	`im
(
$ùext
)==''$ùex
	`GSysTems
("groups.htm");

21 
$li
 = '';

22 
$this
->
dsql
->
	`SQuy
("SELECT groupimg,groupid,groupname FROM `#@__groups` WHERE ishidden=0 ORDER BY $orderby DESC LIMIT 0,{$row}");

23 
$this
->
dsql
->
	`Execu
();

24 
$p
 = 
w
 
	`DedeTagP
();

25 
$p
->
	`SNameS
('field', '[', ']');

26 
$rs
 = 
$this
->
dsql
->
	`GAay
())

28 
$p
->
	`LdSour
(
$ùext
);

29 
$rs
['grouame'] = 
	`_subr
($rs['grouame'], 
$tn
);

30 
$rs
['u'] = 
$cfg_group_u
."/group.php?id={$rs['groupid']}";

31 
$rs
['icon'] = $rs['groupimg'];

32 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
)

34 if!
	`emy
(
$rs
[
	`ow
(
$ag
->
	`GName
())]) ) {

35 
$p
->
	`Assign
(
$gid
,
$rs
[
$ag
->
	`GName
()]);

38 
$li
 .
$p
->
	`GResu
();

40  
$li
;

41 
	}
}

	@include/taglib/groupthread.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
	$lib_grouhad
(&
$ag
,&
$fObj
)

7 
glob
 
$dsql
, 
$vs
, 
$cfg_dbefix
, 
$
;

9 
$i
="gid|0,orderby|dateline,orderway|desc,row|12,titlelen|30";

10 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

11 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

13 if!
$this
->
dsql
->
	`IsTab
("{$cfg_dbprefix}groups") )  '没安装圈子模块';

15 if(!
	`eg
("/$", 
$
)
$cfg_group_u
 = $."/group";

16 
$cfg_group_u
 = 
$
."group";

18 
$ùext
 = 
$ag
->
	`GIText
();

19 if(
	`im
(
$ùext
)==''$ùex
	`GSysTems
('groupthreads.htm');

21 
$WheSql
 = " WHERE.closed=0 ";

22 
$dby
 = 't.'.$orderby;

23 if(
$gid
 > 0
$WheSql
 .= " AND.gid='$gid' ";

25 
$quy
 = "SELECT.subject,t.gid,t.tid,t.lastpost,g.groupname FROM `#@__group_threads` 

26 

 
jo
 `#@
__groups
` 
g
 

 g.
groupid
=
t
.
gid


27 
$WheSql
 
ORDER
 
BY
 
$dby
 
$dway
 
LIMIT
 0,{
$row
}";

29 
$this
->
dsql
->
	`SQuy
(
$quy
);

30 
$this
->
dsql
->
	`Execu
();

31 
$p
 = 
w
 
	`DedeTagP
();

32 
$p
->
	`SNameS
('field', '[', ']');

33 if(!
	`ist
(
$li
)) $list = '';

34 
$rs
 = 
$this
->
dsql
->
	`GAay
())

36 
$p
->
	`LdSour
(
$ùext
);

37 
$rs
['subje'] = 
	`_subr
($rs['subje'], 
$tn
);

38 
$rs
['u'] = 
$cfg_group_u
."/viewthread.php?id={$rs['gid']}&tid={$rs['tid']}";

39 
$rs
['groupu'] = 
$cfg_group_u
."/group.php?id={$rs['gid']}";

40 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
) {

41 if(!
	`emy
(
$rs
[
	`ow
(
$ag
->
	`GName
())]){ 
$p
->
	`Assign
(
$gid
, $rs[$ctag->GetName()]); }

43 
$li
 .
$p
->
	`GResu
();

45  
$li
;

46 
	}
}

	@include/taglib/hotwords.lib.php

1 <?
php


2 
funi
 
	$lib_hwds
(&
$ag
,&
$fObj
)

4 
glob
 
$cfg_phpu
,
$dsql
;

6 
$i
="num|6,subday|365,maxlength|16";

7 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

8 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

10 
$nowtime
 = 
	`time
();

11 if(
	`emy
(
$subday
)) $subday = 365;

12 if(
	`emy
(
$num
)) $num = 6;

13 if(
	`emy
(
$maxngth
)) $maxlength = 20;

14 
$maxngth
 = $maxlength+1;

15 
$mtime
 = 
$nowtime
 - (
$subday
 * 24 * 3600);

17 
$dsql
->
	`SQuy
("Select keyword From `#@__search_keywords` whereasttime>$mintime Andength(keyword)<$maxlength order by count descimit 0,$num");

18 
$dsql
->
	`Execu
('hw');

19 
$hwd
 = '';

20 
$row
=
$dsql
->
	`GAay
('hw')){

21 
$hwd
 ."　<hf='".
$cfg_phpu
."/ch.php?keywd=".
	`ucode
(
$row
['keyword'])."'>".$row['keyword']."</a> ";

23  
$hwd
;

24 
	}
}

	@include/taglib/infoguide.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

6 
funi
 
	$lib_foguide
(&
$ag
,&
$fObj
)

8 
glob
 
$dsql
,
$tiv
,
$fy
,
$hasSEnumJs
,
$cfg_cmh
,
$cfg_mase
;

15 
$cmh
 = ( (
	`emy
(
$cfg_cmh
|| 
	`eg
('[/$]', $cfg_cmspath)) ? $cfg_cmspath.'/' : $cfg_cmspath );

17 if(
	`emy
(
$fObj
->
Flds
['typeid']))

19 
$row
 = 
$dsql
->
	`GO
("Select id From `#@__arctype` where channeltype='-8' Andeid = '0' ");

20 
$tyid
 = (
	`is_y
(
$row
) ? $row['id'] : 0);

21 if(
	`emy
(
$tyid
))

28 
$tyid
 = 
$fObj
->
Flds
['typeid'];

31 
$rText
 = 
	`im
(
$ag
->
	`GIText
());

32 if(
	`emy
(
$rText
)$rTex
	`GSysTems
("info_guide.htm");

33 
$p
 = 
w
 
	`DedeTagP
();

34 
$p
->
	`SNameS
('field','[',']');

35 
$p
->
	`LdSour
(
$rText
);

37 
$vue
 = 
$li
 = '';

39 
$flds
 = 
	`y
('tiv'=>'','fy'=>'','tyid'=>
$tyid
);

41 if(
$hasSEnumJs
 !='has' )

43 
$vue
 .'<snguage="javast"y="xt/javast" src="'.
$cfg_mase
.
$cmh
.'images/enums.js"></script>'."\r\n";

44 
$GLOBALS
['hasSetEnumJs'] = 'hasset';

47 
$flds
['nativeplace'] = $fields['infotype'] = '';

49 if(
	`emy
(
$tiv
)) $nativeplace = 0;

50 if(
	`emy
(
$fy
)) $infotype = 0;

52 
$flds
['nativeplace'] .= "<inputype='hidden' id='hidden_nativeplace'ame='nativeplace' value='{$nativeplace}' />\r\n";

53 
$flds
['nativeplace'] .= "<span class='infosearchtxt'>地区：</span><span id='span_nativeplace'></span>\r\n";

54 
$flds
['nativeplace'] .= "<span id='span_nativeplace_son'></span><br />\r\n";

55 
$flds
['nativeplace'] .= "<scriptanguage='javascript'ype='text/javascript' src='{$cfg_mainsite}{$cmspath}data/enums/nativeplace.js'></script>\r\n";

56 
$flds
['tiv'] .'<snguage="javast">MakeTSe("tiv", '.
$tiv
.');</script>'."\r\n";

58 
$flds
['infotype'] .= "<inputype='hidden' id='hidden_infotype'ame='infotype' value='{$infotype}' />\r\n";

59 
$flds
['infotype'] .= "<span class='infosearchtxt'>类型：</span><span id='span_infotype'></span>\r\n";

60 
$flds
['infotype'] .= "<span id='span_infotype_son'></span><br />\r\n";

61 
$flds
['infotype'] .= "<scriptanguage='javascript'ype='text/javascript' src='{$cfg_mainsite}{$cmspath}data/enums/infotype.js'></script>\r\n";

62 
$flds
['fy'] .'<snguage="javast">MakeTSe("fy", '.
$fy
.');</script>'."\r\n";

64 if(
	`is_y
(
$p
->
CTags
))

66 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
)

68 if(
	`ist
(
$flds
[
$ag
->
	`GName
()])) {

69 
$p
->
	`Assign
(
$gid
,
$flds
[
$ag
->
	`GName
()]);

72 
$vue
 .
$p
->
	`GResu
();

75  
$vue
;

76 
	}
}

	@include/taglib/infolink.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
que_
(
DEDEINC
.'/enums.func.php');

6 
que_
(
DEDEROOT
.'/data/enums/nativeplace.php');

7 
que_
(
DEDEROOT
.'/data/enums/infotype.php');

10 
funi
 
	$lib_fޚk
(&
$ag
,&
$fObj
)

12 
glob
 
$dsql
,
$tiv
,
$fy
,
$hasSEnumJs
,
$cfg_cmh
,
$cfg_mase
;

13 
glob
 
$em_tivs
,
$em_fys
;

20 
$cmh
 = ( (
	`emy
(
$cfg_cmh
|| !
	`eg
('/$', $cfg_cmspath)) ? $cfg_cmspath.'/' : $cfg_cmspath );

21 
$bau
 = 
	`eg_a
('/$', '', 
$cfg_mase
).
$cmh
;

23 
$smys
 = '';

24 if!
	`emy
(
$fObj
->
TyLk
->
TyInfos
['smalltypes']) ) {

25 
$smys
 = 
	`exode
(',', 
$fObj
->
TyLk
->
TyInfos
['smalltypes']);

28 if(
	`emy
(
$fObj
->
Flds
['typeid'])) {

29 
$row
 = 
$dsql
->
	`GO
("Select id From `#@__arctype` where channeltype='-8' Andeid = '0' ");

30 
$tyid
 = (
	`is_y
(
$row
) ? $row['id'] : 0);

33 
$tyid
 = 
$fObj
->
Flds
['typeid'];

36 
$rText
 = 
	`im
(
$ag
->
	`GIText
());

37 if(
	`emy
(
$rText
)$rTex
	`GSysTems
("info_link.htm");

38 
$p
 = 
w
 
	`DedeTagP
();

39 
$p
->
	`SNameS
('field','[',']');

40 
$p
->
	`LdSour
(
$rText
);

42 
$vue
 = 
$li
 = '';

43 
$chlid
 = ( 
	`emy
(
$fObj
->
TyLk
->
TyInfos
['channeltype']) ? -8 : $refObj->TypeLink->TypeInfos['channeltype'] );

45 
$flds
 = 
	`y
('tiv'=>'','fy'=>'','tyid'=>
$tyid
,

46 'chlid'=>
$chlid
,'linkallplace'=>'','linkalltype'=>'');

48 
$flds
['nativeplace'] = $fields['infotype'] = '';

50 
$flds
['linkallplace'] = "<a href='{$baseurl}plus/list.php?channelid={$channelid}&tid={$typeid}&infotype={$infotype}'>不限</a>";

51 
$flds
['linkalltype'] = "<a href='{$baseurl}plus/list.php?channelid={$channelid}&tid={$typeid}&nativeplace={$nativeplace}'>不限</a>";

54 if(
	`emy
(
$tiv
))

56 
	`fܗch
(
$em_tivs
 
as
 
$eid
=>
$em
)

58 if(
$eid
 % 500 != 0) ;

59 
$flds
['nativeplace'] .= " <a href='{$baseurl}plus/list.php?channelid={$channelid}&tid={$typeid}&nativeplace={$eid}&infotype={$infotype}'>{$em}</a>\r\n";

64 
$sty
 = ( (
$tiv
 % 500 != 0) ? $nativeplace : 0 );

65 
$tty
 = ( (
$tiv
 % 500 == 0) ? $nativeplace : ( $nativeplace-($nativeplace%500) ) );

66 
$flds
['nativeplace'] = "<a href='{$baseurl}plus/list.php?channelid={$channelid}&tid={$typeid}&nativeplace={$toptype}&infotype={$infotype}'><b>{$em_nativeplaces[$toptype]}</b></a> &gt;&gt; ";

67 
	`fܗch
(
$em_tivs
 
as
 
$eid
=>
$em
)

69 if(
$eid
 < 
$tty
+1 || $eid > $toptype+499) ;

70 if(
$eid
 =
$tiv
) {

71 
$flds
['nativeplace'] .= " <b>{$em}</b>\r\n";

74 
$flds
['nativeplace'] .= " <a href='{$baseurl}plus/list.php?channelid={$channelid}&tid={$typeid}&nativeplace={$eid}&infotype={$infotype}'>{$em}</a>\r\n";

80 if(
	`emy
(
$fy
|| 
	`is_y
(
$smys
))

82 
	`fܗch
(
$em_fys
 
as
 
$eid
=>
$em
)

84 if(!
	`is_y
(
$smys
&& 
$eid
 % 500 != 0) ;

85 if(
	`is_y
(
$smys
&& !
	`_y
(
$eid
, $smalltypes)) ;

86 if(
$eid
 =
$fy
) {

87 
$flds
['infotype'] .= " <b>{$em}</b>\r\n";

90 
$flds
['infotype'] .= " <a href='{$baseurl}plus/list.php?channelid={$channelid}&tid={$typeid}&infotype={$eid}&nativeplace={$nativeplace}'>{$em}</a>\r\n";

96 
$sty
 = ( (
$fy
 % 500 != 0) ? $infotype : 0 );

97 
$tty
 = ( (
$fy
 % 500 == 0) ? $infotype : ( $infotype-($infotype%500) ) );

98 
$flds
['infotype'] .= "<a href='{$baseurl}plus/list.php?channelid={$channelid}&tid={$typeid}&infotype={$toptype}&nativeplace={$nativeplace}'><b>{$em_infotypes[$toptype]}</b></a> &gt;&gt; ";

99 
	`fܗch
(
$em_fys
 
as
 
$eid
=>
$em
)

101 if(
$eid
 < 
$tty
+1 || $eid > $toptype+499) ;

102 if(
$eid
 =
$fy
) {

103 
$flds
['infotype'] .= " <b>{$em}</b>\r\n";

106 
$flds
['infotype'] .= " <a href='{$baseurl}plus/list.php?channelid={$channelid}&tid={$typeid}&infotype={$eid}&nativeplace={$nativeplace}'>{$em}</a>\r\n";

112 if(
	`is_y
(
$p
->
CTags
))

114 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
)

116 if(
	`ist
(
$flds
[
$ag
->
	`GName
()])) {

117 
$p
->
	`Assign
(
$gid
,
$flds
[
$ag
->
	`GName
()]);

120 
$vue
 .
$p
->
	`GResu
();

123  
$vue
;

124 
	}
}

	@include/taglib/likearticle.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
	$lib_likie
(&
$ag
,&
$fObj
)

7 
glob
 
$dsql
;

10 
$i
="row|12,titlelen|28,infolen|150,col|1,tablewidth|100,mytypeid|0,byabs|0,imgwidth|120,imgheight|90";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

13 
$vue
 = '';

15 if(
	`emy
(
$bwidth
)) $tablewidth = 100;

16 if(
	`emy
(
$c
)) $col = 1;

17 
$cWidth
 = 
	`
(100/
$c
);

18 
$bwidth
 = $tablewidth."%";

19 
$cWidth
 = $colWidth."%";

21 
$ids
 = 
	`y
();

22 
$tids
 = 
	`y
();

24 if(!
	`emy
(
$fObj
->
Flds
['tags'])) {

25 
$keywd
 = 
$fObj
->
Flds
['tags'];

28 
$keywd
 = ( !
	`emy
(
$fObj
->
Flds
['keywords']) ? $refObj->Fields['keywords'] : '' );

31 
$tyid
 = ( !
	`emy
(
$mytyid
) ? $mytypeid : 0 );

32 if(
	`emy
(
$tyid
))

34 if(!
	`emy
(
$fObj
->
Tylk
->
TyInfos
['reid'])) {

35 
$tyid
 = 
$fObj
->
Tylk
->
TyInfos
['reid'];

38 if(!
	`emy
(
$fObj
->
Flds
['tyid'])
$tyid
 = $refObj->Fields['typeid'];

42 if!
	`emy
(
$tyid
&& !
	`eg
(',', $typeid) ) {

43 
$tyid
 = 
	`GSIds
($typeid);

46 
$limRow
 = 
$row
 - 
	`cou
(
$ids
);

47 
$keywd
 = '';

48 if(!
	`emy
(
$fObj
->
Flds
['keywords']))

50 
$keywds
 = 
	`exode
(',' , 
	`im
(
$fObj
->
Flds
['keywords']));

51 
$keywd
 = '';

52 
$n
 = 1;

53 
	`fܗch
(
$keywds
 
as
 
$k
)

55 if(
$n
 > 3) ;

57 if(
	`im
(
$k
)=='') ;

58 
$k
 = 
	`addashes
($k);

60 
$keywd
 .= ($keyword=='' ? " CONCAT(arc.keywords,' ',arc.title)ike '%$k%' " : " OR CONCAT(arc.keywords,' ',arc.title)ike '%$k%' ");

61 
$n
++;

64 
$cid
 = (!
	`emy
(
$fObj
->
Flds
['id']) ? $refObj->Fields['aid'] : 0);

65 if
	`emy
(
$cid
|| 
$byabs
==0 ) {

66 
$dquy
 = " order byrc.id desc ";

69 
$dquy
 = " ord by ABSrc.id - ".
$cid
.") ";

71 if(
$keywd
 != '')

73 if(!
	`emy
(
$tyid
)) {

74 
$tyid
 = " Andrc.typeid in($typeid) Andrc.id<>$arcid ";

76 
$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.corank,tp.isdefault,tp.defaultname,tp.namerule,

77 

.
mu2
,.
it
,.
mese
,.
seu
,.
sh


78 
om
 `#@
__chives
` 
c
 

 
jo
 `#@
__y
` 

 

rc.
tyid
p.
id


79 
whe
 
c
.
k
>-1 
	`d
 (
$keywd

$tyid
 
$dquy
 
lim
 0, 
$row
";

83 if(!
	`emy
(
$tyid
)) {

84 
$tyid
 = "rc.typeid in($typeid) Andrc.id<>$arcid ";

86 
$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.corank,tp.isdefault,tp.defaultname,tp.namerule,

87 

.
mu2
,.
it
,.
mese
,.
seu
,.
sh


88 
om
 `#@
__chives
` 
c
 

 
jo
 `#@
__y
` 

 

rc.
tyid
p.
id


89 
whe
 
c
.
k
>-1 
d
 
$tyid
 
$dquy
 
lim
 0, 
$row
";

92 
$ùext
 = 
	`im

$ag
->
	`GIText
() );

93 if(
$ùext
==''$ùex
	`GSysTems
('part_arclist.htm');

95 
$dsql
->
	`SQuy
(
$quy
);

96 
$dsql
->
	`Execu
('al');

97 
$i
 = '';

98 if(
$c
 > 1) {

99 
$i
 = "<table width='$tablewidth' border='0' cellspacing='0' cellpadding='0'>\r\n";

101 
$d2
 = 
w
 
	`DedeTagP
();

102 
$d2
->
	`SNameS
('field', '[', ']');

103 
$d2
->
	`LdSg
(
$ùext
);

104 
$GLOBALS
['autoindex'] = 0;

105 
$le
 = 
$row
;

106 
$i
=0; $< 
$le
; $i++)

108 if(
$c
>1
$i
 .= "<tr>\r\n";

109 
$j
=0; $j < 
$c
; $j++)

111 if(
$c
>1
$i
 .= " <td width='$colWidth'>\r\n";

112 if(
$row
 = 
$dsql
->
	`GAay
("al"))

114 
$ids
[] = 
$row
['id'];

116 
$row
['fo'] = $row['fos'] = 
	`_subr
($row['desti'],
$fޒ
);

117 
$row
['id'] = $row['id'];

119 if(
$row
['corank'] > 0 && $row['arcrank']==0)

121 
$row
['arcrank'] = $row['corank'];

124 
$row
['fame'] = $row['cu'] = 
	`GFeU
($row['id'],$row['typeid'],$row['senddate'],$row['title'],$row['ismake'],

125 
$row
['arcrank'],$row['namerule'],$row['typedir'],$row['money'],$row['filename'],$row['moresite'],$row['siteurl'],$row['sitepath']);

127 
$row
['tyu'] = 
	`GTyU
($row['typeid'],$row['typedir'],$row['isdefault'],$row['defaultname'],$row['ispart'],

128 
$row
['namerule2'],$row['moresite'],$row['siteurl'],$row['sitepath']);

130 if(
$row
['litpic'] == '-' || $row['litpic'] == '')

132 
$row
['lpic'] = 
$GLOBALS
['cfg_cmspath'].'/images/defaultpic.gif';

134 if(!
	`egi
("^hp://",
$row
['lpic']&& 
$GLOBALS
['cfg_multi_site'] == 'Y')

136 
$row
['lpic'] = 
$GLOBALS
['cfg_mainsite'].$row['litpic'];

138 
$row
['picname'] = $row['litpic'];

139 
$row
['ime'] = 
	`GDeMK
($row['pubdate']);

140 
$row
['typelink'] = "<a href='".$row['typeurl']."'>".$row['typename']."</a>";

141 
$row
['image'] = "<img src='".$row['piame']."' bd='0' width='$imgwidth' height='$imgheight'='".
	`eg_a
("['><]","",$row['title'])."'>";

142 
$row
['imglink'] = "<a href='".$row['filename']."'>".$row['image']."</a>";

143 
$row
['fulltitle'] = $row['title'];

144 
$row
['t'] = 
	`_subr
($row['t'],
$tn
);

145 if(
$row
['color']!='') $row['title'] = "<font color='".$row['color']."'>".$row['title']."</font>";

146 if(
	`eg
('b',
$row
['flag'])) $row['title'] = "<strong>".$row['title']."</strong>";

147 
$row
['textlink'] = "<a href='".$row['filename']."'>".$row['title']."</a>";

148 
$row
['usu'] = $row['phpu'] = 
$GLOBALS
['cfg_phpurl'];

149 
$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

150 
$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

152 if(
	`is_y
(
$d2
->
CTags
))

154 
	`fܗch
(
$d2
->
CTags
 
as
 
$k
=>
$ag
)

156 if(
$ag
->
	`GName
()=='array') {

157 
$d2
->
	`Assign
(
$k
,
$row
);

160 if(
	`ist
(
$row
[
$ag
->
	`GName
()])
$d2
->
	`Assign
(
$k
,$row[$ctag->GetName()]);

161 
$d2
->
	`Assign
(
$k
,'');

164 
$GLOBALS
['autoindex']++;

167 
$i
 .
$d2
->
	`GResu
()."\r\n";

172 
$i
 .= '';

174 if(
$c
>1
$i
 .= " </td>\r\n";

177 if(
$c
>1
$i
 += $col - 1;

178 if(
$c
>1
$i
 .= " </tr>\r\n";

181 if(
$c
>1
$i
 .= " </table>\r\n";

182 
$dsql
->
	`FeResu
("al");

183  
$i
;

184 
	}
}

	@include/taglib/likepage.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
que_
(
dme
(
__FILE__
).'/likesgpage.lib.php');

6 
funi
 
	$lib_likage
(&
$ag
,&
$fObj
)

8  
	`lib_likesgge
(
$ag
, 
$fObj
);

9 
	}
}

	@include/taglib/likesgpage.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
	$lib_likesgge
(&
$ag
,&
$fObj
)

7 
glob
 
$dsql
;

10 
$i
="row|8";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

13 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

15 
$aid
 = (
	`ist
(
$fObj
->
Flds
['aid']) ? $refObj->Fields['aid'] : 0);

17 
$vue
 = '';

18 if(
$ùext
==''$ùex
	`GSysTems
("part_likesgpage.htm");

20 
$likeid
 = (
	`emy
(
$fObj
->
Flds
['likeid']) ? 'all' : $refObj->Fields['likeid']);

22 
$dsql
->
	`SQuy
("Selectid,title,filename From `#@__sgpage` whereikeidike '$likeid'imit 0,$row");

23 
$dsql
->
	`Execu
();

24 
$p
 = 
w
 
	`DedeTagP
();

25 
$p
->
	`SNameS
('field','[',']');

26 
$p
->
	`LdSour
(
$ùext
);

27 
$row
 = 
$dsql
->
	`GAay
())

29 if(
$aid
 !
$row
['aid'])

31 
$row
['u'] = 
$GLOBALS
['cfg_cmsurl'].'/'.$row['filename'];

32 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
) {

33 if(!
	`emy
(
$row
[
$ag
->
	`GName
()])
$p
->
	`Assign
(
$gid
,$row[$ctag->GetName()]);

35 
$vue
 .
$p
->
	`GResu
();

39 
$vue
 .'<dd css="cur"><>'.
$row
['title'].'</span></dd>';

42  
$vue
;

43 
	}
}

	@include/taglib/loop.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
.'/dedevote.class.php');

7 
funi
 
	$lib_lo
(&
$ag
,&
$fObj
)

9 
glob
 
$dsql
;

10 
$i
="table|,tablename|,row|8,sort|,if|,ifcase|";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 
$ùext
 = 
	`im
(
$ag
->
	`GIxt
());

15 
$vue
 = '';

16 if(!
	`emy
(
$b
)
$bme
 = $table;

18 if(
$bme
==''||
$ùext
=='')  '';

19 if(
$if
!=''
$if
 = $if;

21 if(
$st
!='') $sort = " order by $sort desc ";

22 if(
$if
!='') $ifcase=" where $ifcase ";

23 
$dsql
->
	`SQuy
("Select * From $tablename $ifcase $sortimit 0,$row");

24 
$dsql
->
	`Execu
();

25 
$p
 = 
w
 
	`DedeTagP
();

26 
$p
->
	`SNameS
("field","[","]");

27 
$p
->
	`LdSour
(
$ùext
);

28 
$GLOBALS
['autoindex'] = 0;

29 
$row
 = 
$dsql
->
	`GAay
())

31 
$GLOBALS
['autoindex']++;

32 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
)

34 if(
$ag
->
	`GName
()=='array')

36 
$p
->
	`Assign
(
$gid
, 
$row
);

40 if!
	`emy
(
$row
[
$ag
->
	`GName
()])
$p
->
	`Assign
(
$gid
,$row[$ctag->GetName()]);

43 
$vue
 .
$p
->
	`GResu
();

45  
$vue
;

46 
	}
}

	@include/taglib/memberinfos.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
	$lib_membfos
(&
$ag
,&
$fObj
)

9 
glob
 
$dsql
,
$sqlCt
;

10 
$i
="mid|0";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 if(
	`emy
(
$mid
))

16 if(!
	`emy
(
$fObj
->
Flds
['mid'])
$mid
 = $refObj->Fields['mid'];

17 
$mid
 = 1;

21 
$mid
 = 
	`tv
($mid);

24 
$vue
 = '';

25 
$rText
 = 
	`im
(
$ag
->
	`GIText
());

26 if(
	`emy
(
$rText
)$rTex
	`GSysTems
('memberinfos.htm');

28 
$sql
 = "Select mb.*,ms.spacename,ms.sign,ar.membernamesankname From `#@__member` mb

29 

 
jo
 `#@
__memb_a
` 
ms
 

 ms.
mid
 = 
mb
.mid

30 

 
jo
 `#@
__k
` 

 

r.
nk
 = 
mb
.rank

31 
whe
 
mb
.
mid
='{$mid}' 
lim
 0,1 ";

33 
$p
 = 
w
 
	`DedeTagP
();

34 
$p
->
	`SNameS
('field','[',']');

35 
$p
->
	`LdSour
(
$rText
);

37 
$dsql
->
	`Execu
('mb',
$sql
);

38 
$row
 = 
$dsql
->
	`GAay
('mb'))

40 if(
$row
['matt']==10)  '';

41 
$row
['au'] = 
$GLOBALS
['cfg_basehost'].'/member/index.php?uid='.$row['userid'];

42 if(
	`emy
(
$row
['face'])) {

43 
$row
[''] = 
$GLOBALS
['cfg_memberurl'].'/images/nopic.gif';

45 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
)

47 if(
	`ist
(
$row
[
$ag
->
	`GName
()])){ 
$p
->
	`Assign
(
$gid
,$row[$ctag->GetName()]); }

49 
$vue
 .
$p
->
	`GResu
();

51  
$vue
;

52 
	}
}

	@include/taglib/memberlist.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
	$lib_membli
(&
$ag
,&
$fObj
)

9 
glob
 
$dsql
,
$sqlCt
;

10 
$i
="row|6,iscommend|0,orderby|logintime,signlen|50";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 
$vue
 = '';

15 
$rText
 = 
	`im
(
$ag
->
	`GIText
());

16 if(
	`emy
(
$rText
)$rTex
	`GSysTems
('memberlist.htm');

18 
$whesql
 = ' where mb.spacesta>-1 And mb.matt<10 ';

20 if(
$iscommd
 > 0
$whesql
 .= " And mb.matt='$iscommend' ";

22 
$sql
 = "Select mb.*,ms.spacename,ms.sign From `#@__member` mb

23 

 
jo
 `#@
__memb_a
` 
ms
 

 ms.
mid
 = 
mb
.mid

24 
$whesql
 
d
 
by
 
mb
.{
$dby
} 
desc
 
lim
 0,
$row
 ";

26 
$p
 = 
w
 
	`DedeTagP
();

27 
$p
->
	`SNameS
('field','[',']');

28 
$p
->
	`LdSour
(
$rText
);

30 
$dsql
->
	`Execu
('mb',
$sql
);

31 
$row
 = 
$dsql
->
	`GAay
('mb'))

33 
$row
['au'] = 
$GLOBALS
['cfg_basehost'].'/member/index.php?uid='.$row['userid'];

34 if(
	`emy
(
$row
['face'])) {

35 
$row
[''] = 
$GLOBALS
['cfg_memberurl'].'/images/nopic.gif';

37 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
){

38 if(
	`ist
(
$row
[
$ag
->
	`GName
()])){ 
$p
->
	`Assign
(
$gid
,$row[$ctag->GetName()]); }

40 
$vue
 .
$p
->
	`GResu
();

42  
$vue
;

43 
	}
}

	@include/taglib/myad.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
que_
(
DEDEINC
.'/taglib/mytag.lib.php');

6 
funi
 
	$lib_myad
(&
$ag
, &
$fObj
)

8 
$i
 = "typeid|0,name|";

9 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

10 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

12 
$body
 = 
	`lib_GMyTagT
(
$fObj
, 
$tyid
, 
$me
, '#@__myad');

14  
$body
;

15 
	}
}

	@include/taglib/mytag.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
	$lib_myg
(&
$ag
, &
$fObj
)

7 
$i
 = "typeid|0,name|,ismake|no";

8 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

9 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

11 if(
	`im
(
$ismake
)=='') $ismake = 'no';

12 
$body
 = 
	`lib_GMyTagT
(
$fObj
, 
$tyid
, 
$me
, '#@__mytag');

14 if(
$ismake
=='yes')

16 
	`que_
(
DEDEINC
.'/arc.partview.class.php');

17 
$pvCy
 = 
w
 
	`PtVw
(
$tyid
);

18 
$pvCy
->
	`STem
(
$body
,"string");

19 
$body
 = 
$pvCy
->
	`GResu
();

21  
$body
;

22 
	}
}

24 
funi
 
	$lib_GMyTagT
(&
$fObj
, 
$tyid
,
$gme
,
$bme
)

26 
glob
 
$dsql
;

27 if(
$gme
=='')  '';

28 if(
	`im
(
$tyid
)=='') $typeid=0;

29 if!
	`emy
(
$fObj
->
Flds
['tyid']&& 
$tyid
==0) $typeid = $refObj->Fields['typeid'];

31 
$tysql
 = 
$row
 = '';

32 if(
$tyid
 > 0
$tysql
 = " Andyid in(0,".
	`GTids
($typeid).") ";

34 
$row
 = 
$dsql
->
	`GO
(" Select * From $tablename whereagnameike '$tagname' $typesql order byypeid desc ");

35 if(!
	`is_y
(
$row
))  '';

37 
$nowtime
 = 
	`time
();

38 if(
$row
['timeset']==1

39 && (
$nowtime
<
$row
['starttime'] || $nowtime>$row['endtime']) )

41 
$body
 = 
$row
['expbody'];

45 
$body
 = 
$row
['normbody'];

48  
$body
;

49 
	}
}

	@include/taglib/php.lib.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
funi
 
	$lib_php
(&
$ag
, &
$fObj
)

6 
$phpcode
 = 
	`im
(
$ag
->
	`GIText
());

7 if(
$phpcode
=='')  '';

8 
	`ob_t
();

9 
	`exa
(
$GLOBALS
, 
EXTR_SKIP
);

10 @
	`ev
(
$phpcode
);

11 
$vue
 = 
	`ob_g_cڋs
();

12 
	`ob_n
();

13  
$vue
;

14 
	}
}

	@include/taglib/softmsg.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
funi
 
	$lib_somsg
(&
$ag
,&
$fObj
)

8 
glob
 
$dsql
;

12 
$vue
 = '';

13 
$row
 = 
$dsql
->
	`GO
(" select * From `#@__softconfig` ");

14 if(
	`is_y
(
$row
)
$vue
 = $row['downmsg'];

15  
$vue
;

16 
	}
}

	@include/taglib/sonchannel.lib.php

1 <?
php


2 
funi
 
	$lib_schl
(&
$ag
,&
$fObj
)

4 
glob
 
$_sys_globs
,
$dsql
;

6 
$i
 = "row|100,nosonmsg|,col|1";

7 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

8 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

9 
$ùext
 = 
$ag
->
	`GIText
();

11 
$tyid
 = 
$_sys_globs
['typeid'];

12 if(
	`emy
(
$tyid
))

14  
$ag
->
	`GA
('nosonmsg');

17 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

18 
From
 `#@
__y
` 
whe
 
id
='$tyid' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0,
$row
";

21 
$d2
 = 
w
 
	`DedeTagP
();

22 
$d2
->
	`SNameS
("field","[","]");

23 
$d2
->
	`LdSour
(
$ùext
);

24 
$dsql
->
	`SQuy
(
$sql
);

25 
$dsql
->
	`Execu
();

26 
$le
 = 
$row
;

27 
$GLOBALS
['autoindex'] = 0;

28 
$likeTy
 = '';

29 
$i
=0;$< 
$le
;$i++)

31 if(
$c
>1
$likeTy
 .= "<dl>\r\n";

32 
$j
=0;$j<
$c
;$j++)

34 if(
$c
>1
$likeTy
 .= "<dd>\r\n";

35 if(
$row
=
$dsql
->
	`GAay
())

37 
$row
['tylk'] = $row['tyu'] = 
	`GOTyUA
($row);

38 if(
	`is_y
(
$d2
->
CTags
))

40 
	`fܗch
(
$d2
->
CTags
 
as
 
$gid
=>
$ag
){

41 if(
	`ist
(
$row
[
$ag
->
	`GName
()])
$d2
->
	`Assign
(
$gid
,$row[$ctag->GetName()]);

44 
$likeTy
 .
$d2
->
	`GResu
();

46 if(
$c
>1
$likeTy
 .= "</dd>\r\n";

47 
$GLOBALS
['autoindex']++;

49 if(
$c
>1)

51 
$i
 +
$c
 - 1;

52 
$likeTy
 .= " </dl>\r\n";

55 
$dsql
->
	`FeResu
();

56  
$likeTy
;

57 
	}
}

	@include/taglib/sql.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
funi
 
	$lib_sql
(&
$ag
,&
$fObj
)

8 
glob
 
$dsql
,
$sqlCt
;

9 
$i
="sql|";

10 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

11 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 
	`eg_mch_l
("/~([A-Za-z0-9]+)~/s", 
$sql
, 
$cdis
);

15 if(
	`is_y
(
$cdis
))

17 
	`fܗch
 (
$cdis
[1] 
as
 
$key
 => 
$vue
)

19 if(
	`ist
(
$fObj
->
Flds
[
$vue
]))

21 
$sql
 = 
	`r_a
(
$cdis
[0][
$key
], "'".
	`addashes
(
$fObj
->
Flds
[
$vue
])."'", $sql);

26 
$vue
 = '';

27 
$Ixt
 = 
	`im
(
$ag
->
	`GIText
());

29 if(
$sql
=='' || 
$Ixt
=='')  '';

30 if(
	`emy
(
$sqlCt
)) $sqlCt = 0;

32 
$p
 = 
w
 
	`DedeTagP
();

33 
$p
->
	`SNameS
('field','[',']');

34 
$p
->
	`LdSour
(
$Ixt
);

36 
$this
 = 'sq'.
$sqlCt
;

37 
$dsql
->
	`Execu
(
$this
,
$sql
);

38 
$GLOBALS
['autoindex'] = 0;

39 
$row
 = 
$dsql
->
	`GAay
(
$this
))

41 
$sqlCt
++;

42 
$GLOBALS
['autoindex']++;

43 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
)

45 if(
$ag
->
	`GName
()=='array')

47 
$p
->
	`Assign
(
$gid
,
$row
);

51 if!
	`emy
(
$row
[
$ag
->
	`GName
()])
$p
->
	`Assign
(
$gid
,$row[$ctag->GetName()]);

54 
$vue
 .
$p
->
	`GResu
();

56  
$vue
;

57 
	}
}

	@include/taglib/tag.lib.php

1 <?
php


4 
funi
 
	$lib_g
(&
$ag
,&
$fObj
)

6 
glob
 
$dsql
,
$vs
,
$cfg_cmsu
;

8 
$i
="row|30,sort|new,getall|0,typeid|0";

9 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

10 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

12 
$IText
 = 
$ag
->
	`GIText
();

13 if(
	`im
(
$IText
)==''$ITex
	`GSysTems
('tag_one.htm');

14 
$vue
 = '';

16 
$y
 = 
$st
;

17 
$num
 = 
$row
;

19 
$addsql
 = '';

21 if(
$gl
==0 && 
	`ist
(
$fObj
->
Flds
['gs']&& !
	`emy
($refObj->Fields['aid']))

23 
$dsql
->
	`SQuy
("Selectid From `#@__taglist` whereid = '{$refObj->Fields['aid']}' ");

24 
$dsql
->
	`Execu
();

25 
$ids
 = '';

26 
$row
 = 
$dsql
->
	`GAay
())

28 
$ids
 .$ids=='' ? 
$row
['tid'] : ','.$row['tid'] );

30 if(
$ids
 != '')

32 
$addsql
 = " where id in($ids) ";

34 if(
$addsql
=='')  '';

38 if(!
	`emy
(
$tyid
))

40 
$addsql
 = " whereypeid='$typeid' ";

44 if(
$y
=='nd'
$dby
 = 'and() ';

45 if(
$y
=='wk'
$dby
=' weekcc desc ';

46 if(
$y
=='mth'
$dby
=' monthcc desc ';

47 if(
$y
=='h'
$dby
=' count desc ';

48 
$dby
 = 'ddtime desc ';

50 
$dsql
->
	`SQuy
("Select * From `#@__tagindex` $addsql order by $orderbyimit 0,$num");

51 
$dsql
->
	`Execu
();

53 
$p
 = 
w
 
	`DedeTagP
();

54 
$p
->
	`SNameS
('field','[',']');

55 
$p
->
	`LdSour
(
$IText
);

56 
$row
 = 
$dsql
->
	`GAay
())

58 
$row
['keyword'] = $row['tag'];

59 
$row
['g'] = 
	`htmleclchs
($row['tag']);

60 
$row
['lk'] = 
$cfg_cmsu
."/gs.php?/".
	`ucode
($row['keyword'])."/";

61 
$row
['highlight'] = 0;

62 if(
$row
['monthcc']>1000 || $row['weekcc']>300 )

64 
$row
['highlight'] = 
	`mt_nd
(3,4);

66 if(
$row
['count']>3000)

68 
$row
['highlight'] = 
	`mt_nd
(5,6);

72 
$row
['highlight'] = 
	`mt_nd
(1,2);

74 
	`fܗch
(
$p
->
CTags
 
as
 
$gid
=>
$ag
)

76 if(
	`ist
(
$row
[
$ag
->
	`GName
()]))

78 
$p
->
	`Assign
(
$gid
,
$row
[
$ag
->
	`GName
()]);

81 
$vue
 .
$p
->
	`GResu
();

83  
$vue
;

84 
	}
}

	@include/taglib/type.lib.php

1 <?
php


3 if(!
defed
('DEDEINC')
ex
('Request Error!');

5 
funi
 
	$lib_ty
(&
$ag
,&
$fObj
)

7 
glob
 
$dsql
,
$vs
;

9 
$i
='typeid|0';

10 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

11 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

12 
$ùext
 = 
	`im
(
$ag
->
	`GIText
());

14 if(
$tyid
==0) {

15 
$tyid
 = ( 
	`ist
(
$fObj
->
TyLk
->
TyInfos
['id']? $fObj->TyLk->TyInfos['id'] : 
$vs
['typeid'] );

18 if(
	`emy
(
$tyid
))  '';

20 
$row
 = 
$dsql
->
	`GO
("Select id,typedir,isdefault,defaultname,ispart,namerule2,typename,moresite,siteurl,sitepath 

21 
From
 `#@
__y
` 
whe
 
id
='$typeid' ");

22 if(!
	`is_y
(
$row
))  '';

23 if(
	`im
(
$ùext
)==''$ùex
	`GSysTems
("part_type_list.htm");

25 
$d
 = 
w
 
	`DedeTagP
();

26 
$d
->
	`SNameS
('field','[',']');

27 
$d
->
	`LdSour
(
$ùext
);

28 if(!
	`is_y
(
$d
->
CTags
))

30 
	`unt
(
$d
);

35 
$row
['tylk'] = $row['tyu'] = 
	`GOTyUA
($row);

36 
	`fܗch
(
$d
->
CTags
 
as
 
$gid
=>
$ag
)

38 if(
	`ist
(
$row
[
$ag
->
	`GName
()])
$d
->
	`Assign
(
$gid
,$row[$ctag->GetName()]);

40 
$vue
 = 
$d
->
	`GResu
();

41 
	`unt
(
$d
);

42  
$vue
;

44 
	}
}

	@include/taglib/vote.lib.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
.'/dedevote.class.php');

7 
funi
 
	$lib_ve
(&
$ag
,&
$fObj
)

9 
glob
 
$dsql
;

10 
$i
="id|0,lineheight|24,tablewidth|100%,titlebgcolor|#EDEDE2,titlebackgroup|,tablebg|#FFFFFF";

11 
	`FlAsDeu
(
$ag
->
CAribu
->
Ims
,
$i
);

12 
	`exa
(
$ag
->
CAribu
->
Ims
, 
EXTR_SKIP
);

14 if(
	`emy
(
$id
)) $id=0;

15 if(
$id
==0)

17 
$row
 = 
$dsql
->
	`GO
("selectid From `#@__vote` order byid descimit 0,1");

18 if(!
	`ist
(
$row
['aid']))  '';

19 
$id
=
$row
['aid'];

21 
$vt
 = 
w
 
	`DedeVe
(
$id
);

22  
$vt
->
	`GVeFm
(
$leheight
,
$bwidth
,
$tbgc
,
$tbackgroup
,
$bbg
);

23 
	}
}

	@include/tpllib/plus_ask.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
funi
 
	$us_ask
(&
$ts
,&
$fObj
,&
$flds
)

6 
glob
 
$dsql
,
$_vs
;

8 
$i
 = "titlelen=40,row=8,typeid=0,sort=";

9 
	`FlAs
(
$ts
,
$i
);

10 
	`FlFlds
(
$ts
,
$flds
,
$fObj
);

11 
	`exa
(
$ts
, 
EXTR_OVERWRITE
);

13 
$whesql
 = ' 1 ';

14 if(
$st
=='') {

15 
$dby
 = 'order by id desc';

17 if(
$st
=='commend')

19 
$whesql
 .= ' And digest=1';

20 
$dby
 = ' order by dateline desc';

22 if(
$st
=='ok')

24 
$whesql
 .= ' And status=1 ';

25 
$dby
 = ' order by solvetime desc';

27 if(
$st
=='expiredtime')

29 
$whesql
 .= ' And status=0 ';

30 
$dby
 = ' order byxpiredtimesc, dateline desc';

32 if(
$st
=='reward')

34 
$whesql
 .= ' And status=0 ';

35 
$dby
 = ' order byeward desc';

39 
$whesql
 .= ' And status=0 ';

40 
$dby
 = ' order by disorder desc, dateline desc';

42 
$quy
 = "select id,id,idname,id2,id2name,itle from `#@__ask` where $wheresql $orderbyimit $row";

43 
$dsql
->
	`SQuy
(
$quy
);

44 
$dsql
->
	`Execu
('an');

45 
$r
 = 
	`y
();

46 
$row
 = 
$dsql
->
	`GAay
('an'))

49 if(
$row
['tid2'] != 0)

50 
$row
['typelink'] = $row['typedata'] = " <a href='browser.php?tid2={$row['tid2']}'>{$row['tid2name']}</a>\r\n";

52 
$row
['typelink'] = $row['typedata'] = " <a href='browser.php?tid={$row['tid']}'>{$row['tidname']}</a>\r\n";

53 
$row
['t'] = 
	`_subr
($row['t'],
$tn
);

54 
$r
[] = 
$row
;

56  
$r
;

57 
	}
}

	@include/tpllib/plus_channel.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

3 
que_
(
DEDEINC
.'/channelunit.func.php');

5 
funi
 
	$us_chl
(&
$ts
, &
$fObj
, &
$flds
)

7 
glob
 
$dsql
,
$_vs
;

9 
$i
 = "typeid=0,reid=0,row=100,type=son,currentstyle=";

10 
	`FlAs
(
$ts
,
$i
);

11 
	`FlFlds
(
$ts
,
$flds
,
$fObj
);

12 
	`exa
(
$ts
, 
EXTR_OVERWRITE
);

14 
$le
 = 
	`emy
(
$row
) ? 100 : $row;

15 
$Aay
 = 
	`y
();

16 
$id
 = 0;

17 
$tid
 = 0;

20 if(
	`emy
(
$tyid
))

22 if
	`ist
(
$fObj
->
TyLk
->
TyInfos
['id']) )

24 
$tyid
 = 
$fObj
->
TyLk
->
TyInfos
['id'];

25 
$id
 = 
$fObj
->
TyLk
->
TyInfos
['reid'];

26 
$tid
 = 
$fObj
->
TyLk
->
TyInfos
['topid'];

29 
$tyid
 = 0;

35 
$row2
 = 
$dsql
->
	`GO
("Select * From `#@__arctype` where id='$typeid' ");

36 
$tyid
 = 
$row2
['id'];

37 
$id
 = 
$row2
['reid'];

38 
$tid
 = 
$row2
['topid'];

39 
$istInfos
 = 
ue
;

42 if(
$ty
=='' || $type=='sun') $type='son';

44 if(
$ty
=='top')

46 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

47 
From
 `#@
__y
` 
whe
 
id
=0 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0, 
$le
 ";

49 if(
$ty
=='son')

51 if(
$tyid
==0 
$Aay
;

52 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

53 
From
 `#@
__y
` 
whe
 
id
='$tyid' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0, 
$le
 ";

55 if(
$ty
=='self')

57 if(
$id
==0 
$Aay
;

58 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

59 
From
 `#@
__y
` 
whe
 
id
='$id' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0, 
$le
 ";

63 
$edR
 = 
ue
;

65 if(
	`emy
(
$sql
) 
$Aay
;

67 
$dsql
->
	`Execu
('me',
$sql
);

68 
$tٮRow
 = 
$dsql
->
	`GTٮRow
('me');

71 if(
$ty
=='s' && 
$id
!=0 && 
$tٮRow
==0)

73 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl,sitepath

74 
From
 `#@
__y
` 
whe
 
id
='$id' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0, 
$le
 ";

75 
$dsql
->
	`Execu
('me', 
$sql
);

77 
$GLOBALS
['autoindex'] = 0;

78 
$row
=
$dsql
->
	`GAay
())

80 
$row
['currentstyle'] = $row['sonids'] = $row['rel'] = '';

81 if(
$edR
)

83 
$row
['sids'] = 
	`GSIds
($row['id'], 0, 
l
);

84 if(
$row
['sonids']=='') $row['rel'] = '';

85 
$row
['rel'] = "el='dropmenu{$row['id']}'";

88 if(
$row
['id']==
$tyid
 || (
$tid
==$row['id'] && 
$ty
=='t'&& 
$cuty
!='' )

90 
$row
['cuty'] = 
$cuty
;

92 
$row
['tylk'] = $row['tyu'] = 
	`GOTyUA
($row);

93 
$Aay
[] = 
$row
;

94 
$GLOBALS
['autoindex']++;

97 
$dsql
->
	`FeResu
();

98  
$Aay
;

99 
	}
}

	@include/tpllib/plus_memberlist.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
	$us_membli
(&
$ts
,&
$fObj
,&
$flds
)

9 
glob
 
$dsql
,
$_vs
;

10 
$i
 = "row=6,iscommend=0,orderby=logintime,signlen=50";

11 
	`FlAs
(
$ts
,
$i
);

12 
	`FlFlds
(
$ts
,
$flds
,
$fObj
);

13 
	`exa
(
$ts
, 
EXTR_OVERWRITE
);

15 
$y
 = 
	`y
();

17 
$whesql
 = ' where mb.spacesta > -1 AND mb.matt != 10';

19 if(
$iscommd
 > 0
$whesql
 .= " And mb.matt='$iscommend' ";

21 
$sql
 = "Select mb.*,ms.spacename,ms.sign From `#@__member` mb

22 

 
jo
 `#@
__memb_a
` 
ms
 

 ms.
mid
 = 
mb
.mid 
$whesql
 
d
 
by
 mb.{
$dby
} 
desc
 
lim
 0,
$row
 ";

24 
$dsql
->
	`Execu
('mb',
$sql
);

25 
$row
 = 
$dsql
->
	`GAay
('mb'))

27 
$row
['au'] = 
$GLOBALS
['cfg_basehost'].'/member/index.php?uid='.$row['userid'];

28 if(
	`emy
(
$row
['face'])) {

29 
$row
[''] = 
$GLOBALS
['cfg_memberurl'].'/images/nopic.gif';

31 
$y
[] = 
$row
;

33  
$y
;

34 
	}
}

	@include/tpllib/plus_newvisitor.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
funi
 
	$us_wvis
(&
$ts
,&
$fObj
,&
$flds
)

9 
glob
 
$dsql
,
$_vs
,
$cfg_membu
;

11 
$i
 = "titlelen=30,infolen=200,row=6";

12 
	`FlAs
(
$ts
,
$i
);

13 
	`FlFlds
(
$ts
,
$flds
,
$fObj
);

14 
	`exa
(
$ts
, 
EXTR_OVERWRITE
);

15 
$mid
 = 
$_vs
['mid'];

17 
$quy
 = "Select h.*,mb.face,mb.useridsoginid,mb.uname,s.sign From `#@__member_vhistory` h

18 

 
jo
 `#@
__memb
` 
mb
 

 mb.
mid
 = 
h
.
vid


19 

 
jo
 `#@
__memb_a
` 
s
 

 s.
mid
 = 
h
.
vid


20 
whe
 
h
.
mid
='$mid' 
d
 
by
 h.
vtime
 
desc
 
lim
 0,
$row
";

22 
$dsql
->
	`SQuy
(
$quy
);

23 
$dsql
->
	`Execu
("al");

24 
$r
 = 
	`y
();

25 
$row
 = 
$dsql
->
	`GAay
("al"))

27 
$row
['u'] = 
$cfg_membu
."/index.php?uid=".$row['loginid'];

28 if(
	`im
(
$row
['face'])=='')

30 
$row
[''] = 
$cfg_membu
.'/images/nopic.gif';

32 
$r
[] = 
$row
;

34 
$dsql
->
	`FeResu
("al");

35  
$r
;

36 
	}
}

	@include/tpllib/plus_spacenewart.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
funi
 
	$us_awt
(&
$ts
,&
$fObj
,&
$flds
)

6 
glob
 
$dsql
,
$_vs
;

8 
$i
 = "channel=1,titlelen=30,infolen=200,row=8,imgwidth=120,imgheight=90";

9 
	`FlAs
(
$ts
,
$i
);

10 
	`FlFlds
(
$ts
,
$flds
,
$fObj
);

11 
	`exa
(
$ts
, 
EXTR_OVERWRITE
);

13 
$quy
 = "Selectrc.*,mt.mtypename,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,

14 

.
mu2
,.
it
,.
mese
,.
seu
,.
sh


15 
om
 `#@
__chives
` 
c


16 

 
jo
 `#@
__y
` 

 

 
c
.
tyid
p.
id


17 

 
jo
 `#@
__mtys
` 
mt
 

 mt.
mtyid
=
c
.
mty


18 
whe
 
c
.
mid
='{$_vs['mid']}' 
d
rc.
chl
=
$chl


19 
d
 
by
 
id
 
desc
 
lim
 0,
$row
";

21 
$dsql
->
	`SQuy
(
$quy
);

22 
$dsql
->
	`Execu
("al");

23 
$i
 = '';

24 
$r
 = 
	`y
();

25 
$row
 = 
$dsql
->
	`GAay
("al"))

28 
$row
['fos'] = 
	`_subr
($row['desti'],
$fޒ
);

29 
$row
['id'] = $row['id'];

31 
$row
['cu'] = 
	`GFeU
($row['id'],$row['typeid'],$row['senddate'],$row['title'],$row['ismake'],

32 
$row
['arcrank'],$row['namerule'],$row['typedir'],$row['money'],$row['filename'],$row['moresite'],$row['siteurl'],$row['sitepath']);

34 
$row
['tyu'] = 
	`GTyU
($row['typeid'],$row['typedir'],$row['isdefault'],$row['defaultname'],$row['ispart'],

35 
$row
['namerule2'],$row['moresite'],$row['siteurl'],$row['sitepath']);

37 if(
$row
['litpic']=='')

39 
$row
['litpic'] = '/images/defaultpic.gif';

41 if(!
	`egi
("^hp://",
$row
['litpic']))

43 
$row
['piame'] = $row['lpic'] = 
$GLOBALS
['cfg_cmsurl'].$row['litpic'];

47 
$row
['picname'] = $row['litpic'] = $row['litpic'];

49 
$row
['ime'] = 
	`GDeMK
($row['pubdate']);

50 
$row
['typelink'] = "<a href='".$row['typeurl']."'>".$row['typename']."</a>";

51 
$row
['image'] = "<img src='".$row['piame']."' bd='0' width='$imgwidth' height='$imgheight'='".
	`eg_a
("['><]","",$row['title'])."'>";

52 
$row
['imglink'] = "<a href='".$row['filename']."'>".$row['image']."</a>";

53 
$row
['fulltitle'] = $row['title'];

54 
$row
['t'] = 
	`_subr
($row['t'],
$tn
);

55 if(
$row
['color']!='') {

56 
$row
['title'] = "<font color='".$row['color']."'>".$row['title']."</font>";

58 if(
	`eg
('b',
$row
['flag']))

60 
$row
['title'] = "<strong>".$row['title']."</strong>";

64 
$row
['textlink'] = "<a href='".$row['filename']."'>".$row['title']."</a>";

66 
$row
['usu'] = $row['phpu'] = 
$GLOBALS
['cfg_phpurl'];

67 
$row
['membu'] = 
$GLOBALS
['cfg_memberurl'];

68 
$row
['mu'] = 
$GLOBALS
['cfg_templeturl'];

70 
$r
[] = 
$row
;

72 
$dsql
->
	`FeResu
("al");

73  
$r
;

74 
	}
}

	@include/typelink.class.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

6 
que_
(
DEDEINC
."/channelunit.func.php");

8 as
	cTyLk


10 
v
 
	m$tyD
;

11 
v
 
	m$dsql
;

12 
v
 
	m$TyID
;

13 
v
 
	m$baD
;

14 
v
 
	m$modD
;

15 
v
 
	m$dexU
;

16 
v
 
	m$dexName
;

17 
v
 
	m$TyInfos
;

18 
v
 
	m$SSymb
;

19 
v
 
	m$vuePosi
;

20 
v
 
	m$vuePosiName
;

21 
v
 
	m$OiAayLi
;

25 
funi
 
	$__cڡru
(
$tyid
)

27 
$this
->
dexU
 = 
$GLOBALS
['cfg_basehost'].$GLOBALS['cfg_indexurl'];

28 
$this
->
dexName
 = 
$GLOBALS
['cfg_indexname'];

29 
$this
->
baD
 = 
$GLOBALS
['cfg_basedir'];

30 
$this
->
modD
 = 
$GLOBALS
['cfg_templets_dir'];

31 
$this
->
SSymb
 = 
$GLOBALS
['cfg_list_symbol'];

32 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

33 
$this
->
TyID
 = 
$tyid
;

34 
$this
->
vuePosi
 = '';

35 
$this
->
vuePosiName
 = '';

36 
$this
->
tyD
 = '';

37 
$this
->
OiAayLi
 = '';

40 
$quy
 = "Selectp.*,ch.typenames ctypename,ch.addtable,ch.issystem From `#@__arctype`peft join `#@__channeltype` ch

41 

 
ch
.
id
=

.
chy
 
whe
p.id='$typeid' ";

42 if(
$tyid
 > 0)

44 
$this
->
TyInfos
 = $this->
dsql
->
	`GO
(
$quy
);

45 if(
	`is_y
(
$this
->
TyInfos
))

47 
$this
->
TyInfos
['mpdex'] = 
	`MfTem
($this->TypeInfos['tempindex']);

48 
$this
->
TyInfos
['mi'] = 
	`MfTem
($this->TypeInfos['templist']);

49 
$this
->
TyInfos
['mie'] = 
	`MfTem
($this->TypeInfos['temparticle']);

56 
funi
 
	$TyLk
(
$tyid
)

58 
$this
->
	`__cڡru
(
$tyid
);

59 
	}
}

62 
funi
 
	$Clo
()

64 
	}
}

67 
funi
 
	$STyID
(
$tyid
)

69 
$this
->
TyID
 = 
$tyid
;

70 
$this
->
vuePosi
 = "";

71 
$this
->
vuePosiName
 = "";

72 
$this
->
tyD
 = "";

73 
$this
->
OiAayLi
 = "";

76 
$quy
 = "

77 
Se
 #@
__y
.*,#@
__chy
.
tyme
 
as
 
yme


78 
From
 #@
__y
 

 
jo
 #@
__chy


79 

 #@
__chy
.
id
=#@
__y
.
chy
 
whe
 #@__arctype.id='$typeid' ";

80 
$this
->
dsql
->
	`SQuy
(
$quy
);

81 
$this
->
TyInfos
 = $this->
dsql
->
	`GO
();

82 
	}
}

85 
funi
 
	$GTyD
()

87 if(
	`emy
(
$this
->
TyInfos
['typedir']))

89  
$GLOBALS
['cfg_cmspath'].$GLOBALS['cfg_arcdir'];

93  
$this
->
TyInfos
['typedir'];

95 
	}
}

99 
funi
 
	$GPosiLk
(
$ik
=
ue
)

101 
$dexge
 = "<hf='".
$this
->
dexU
."'>".$this->
dexName
."</a>";

102 if(
$this
->
vuePosi
!="" && 
$ik
)

104  
$this
->
vuePosi
;

106 if(
$this
->
vuePosiName
!="" && !
$ik
)

108  
$this
->
vuePosiName
;

110 if(
$this
->
TyID
==0)

112 if(
$ik
)

114  
$dexge
;

123 if(
$ik
)

125 
$this
->
vuePosi
 = $this->
	`GOTyLk
($this->
TyInfos
);

126 if(
$this
->
TyInfos
['reid']!=0)

129 
$this
->
	`LogicGPosi
($this->
TyInfos
['id'],
ue
);

131 
$this
->
vuePosi
 = 
$dexge
.$this->
SSymb
.$this->valuePosition;

132  
$this
->
vuePosi
.$this->
SSymb
;

136 
$this
->
vuePosiName
 = $this->
TyInfos
['typename'];

137 if(
$this
->
TyInfos
['reid']!=0)

140 
$this
->
	`LogicGPosi
($this->
TyInfos
['id'],
l
);

142  
$this
->
vuePosiName
;

145 
	}
}

148 
funi
 
	$GPosiName
()

150  
$this
->
	`GPosiLk
(
l
);

151 
	}
}

154 
funi
 
	$LogicGPosi
(
$id
,
$ik
)

156 
$this
->
dsql
->
	`SQuy
("Se id,id,tyme,tyd,isdeu,it,deume,mu2,mese,seu,sh From #@__y whid='".
$id
."'");

157 
$tfos
 = 
$this
->
dsql
->
	`GO
();

158 if(
$ik
)

160 
$this
->
vuePosi
 = $this->
	`GOTyLk
(
$tfos
).$this->
SSymb
.$this->valuePosition;

164 
$this
->
vuePosiName
 = 
$tfos
['tyme'].$this->
SSymb
.$this->valuePositionName;

166 if(
$tfos
['reid']>0)

168 
$this
->
	`LogicGPosi
(
$tfos
['id'],
$ik
);

175 
	}
}

178 
funi
 
	$GOTyLk
(
$tyfos
)

180 
$tyge
 = 
$this
->
	`GOTyU
(
$tyfos
);

181 
$tylk
 = "<hf='".
$tyge
."'>".
$tyfos
['typename']."</a>";

182  
$tylk
;

183 
	}
}

186 
funi
 
	$GOTyU
(
$tyfos
)

188  
	`GTyU
(
$tyfos
['id'],
	`MfTyd
($typeinfos['typedir']),$typeinfos['isdefault'],$typeinfos['defaultname'],

189 
$tyfos
['ispart'],$typeinfos['namerule2'],$typeinfos['moresite'],$typeinfos['siteurl'],$typeinfos['sitepath']);

190 
	}
}

196 
funi
 
	$GOiAay
(
$hid
=0,
$ݔ
=0,
$chy
=0,
$ursg
=0)

198  
$this
->
	`GOiLi
(
$hid
,
$ݔ
,
$chy
,
$ursg
);

199 
	}
}

201 
funi
 
	$GOiLi
(
$hid
=0,
$ݔ
=0,
$chy
=0,
$ursg
=0)

203 
glob
 
$cfg_adm_chl
;

204 if(
	`emy
(
$cfg_adm_chl
)) $cfg_admin_channel = 'all';

206 if(!
$this
->
dsql
$this->dsq
$GLOBALS
['dsql'];

207 
$this
->
OiAayLi
 = '';

209 if(
$hid
>0)

211 
$row
 = 
$this
->
dsql
->
	`GO
("Select id,typename,ispart,channeltype From #@__arctype where id='$hid'");

212 
$chy
 = 
$row
['channeltype'];

213 if(
$row
['ispart']==1) {

214 
$this
->
OiAayLi
 ."<ti vue='".
$row
['id']."' style='background-color:#DFDFDB;color:#888888' selected>".$row['typename']."</option>\r\n";

217 
$this
->
OiAayLi
 ."<ti vue='".
$row
['id']."' selected>".$row['typename']."</option>\r\n";

221 if(
$chy
==0
$sql
 = '';

222 
$sql
=" And channeltype='$channeltype' ";

225 if(
	`is_y
(
$ݔ
&& 
$cfg_adm_chl
 != 'all')

227 if
	`cou
(
$ݔ
) == 0 )

229 
$quy
 = "Select id,typename,ispart From `#@__arctype` where 1=2 ";

233 
$adm_log_tmp
 = 
$adm_log
 = 
	`jo
(',', 
$ݔ
);

234 
$this
->
dsql
->
	`SQuy
("Selecteid From `#@__arctype` where id in($admin_catalog) group byeid ");

235 
$this
->
dsql
->
	`Execu
();

236 
$tidr
 = '';

237 
$row
 = 
$this
->
dsql
->
	`GObje
())

239 if(
$row
->
id
==0) ;

240 
$tidr
 .($tidr=='' ? 
$row
->
id
 : ','.$row->reid);

242 
$adm_log
 .','.
$tidr
;

243 
$adm_logs
 = 
	`exode
(',', 
$adm_log
);

244 
$adm_logs
 = 
	`y_unique
($admin_catalogs);

245 
$adm_log
 = 
	`jo
(',', 
$adm_logs
);

246 
$quy
 = "Select id,typename,ispart From `#@__arctype` where ispart<>2 And id in({$admin_catalog}) Andeid=0 $ctsql";

251 
$quy
 = "Select id,typename,ispart From `#@__arctype` where ispart<>2 Andeid=0 $ctsql order by sortranksc";

254 
$this
->
dsql
->
	`SQuy
(
$quy
);

255 
$this
->
dsql
->
	`Execu
();

256 
$row
=
$this
->
dsql
->
	`GObje
())

258 if(
$row
->
id
!=
$hid
)

260 if(
$row
->
it
==1) {

261 
$this
->
OiAayLi
 ."<ti vue='".
$row
->
id
."' sty='background-c:#EFEFEF;c:#666666'>".$row->
tyme
."</option>\r\n";

264 
$this
->
OiAayLi
 ."<ti vue='".
$row
->
id
."'>".$row->
tyme
."</option>\r\n";

267 
$this
->
	`LogicGOiAay
(
$row
->
id
, "─", 
$ݔ
);

269  
$this
->
OiAayLi
;

270 
	}
}

272 
funi
 
	$LogicGOiAay
(
$id
, 
$
, 
$ݔ
=0)

274 
glob
 
$cfg_adm_chl
;

275 if(
	`emy
(
$cfg_adm_chl
)) $cfg_admin_channel = 'all';

277 
$this
->
dsql
->
	`SQuy
("Se id,tyme,iFrom #@__y whid='".
$id
."' And ispart<>2 order by sortranksc");

278 
$this
->
dsql
->
	`Execu
(
$id
);

279 
$row
=
$this
->
dsql
->
	`GObje
(
$id
))

281 if(
	`is_y
(
$ݔ
&& 
$cfg_adm_chl
 != 'all')

283 if(!
	`_y
(
$row
->
id
, 
$ݔ
)) ;

285 if(
$row
->
it
==1) {

286 
$this
->
OiAayLi
 ."<ti vue='".
$row
->
id
."' sty='background-c:#EFEFEF;c:#666666'>$".$row->
tyme
."</option>\r\n";

289 
$this
->
OiAayLi
 ."<ti vue='".
$row
->
id
."'>$".$row->
tyme
."</option>\r\n";

291 
$this
->
	`LogicGOiAay
(
$row
->
id
, 
$
."─", 
$ݔ
);

293 
	}
}

297 
funi
 
GChlLi
(
$tyid
=0,
$id
=0,
$row
=8,
$tyty
='sun',
$ùext
='',

298 
$c
=1,
$bwidth
=100,
$myùext
='')

300 if(
$tyid
==0)

302 
$tyid
 = 
$this
->
TyID
;

304 if(
	g$row
=="")

306 
$row
 = 8;

308 if(
	g$id
=="")

310 
$id
 = 0;

312 if(
	g$c
=="")

314 
$c
 = 1;

316 
	g$bwidth
 = 
r_a
("%","",
$bwidth
);

317 if(
	g$bwidth
=="")

319 
$bwidth
=100;

321 if(
	g$c
=="")

323 
$c
 = 1;

325 
	g$cWidth
 = 

(100/
$c
);

326 
	g$bwidth
 = 
$bwidth
."%";

327 
	g$cWidth
 = 
$cWidth
."%";

328 if(
	g$tyty
=="")

330 
$tyty
="sun";

332 if(
	g$ùext
=="")

334 
$ùext
 = 
GSysTems
("channel_list.htm");

336 if(
	g$id
==0 && 
$tyid
>0)

338 
$dbrow
 = 
$this
->
dsql
->
GO
("Selecteid From #@__arctype where id='$typeid' ");

339 if(
is_y
(
$dbrow
))

341 
	g$id
 = 
$dbrow
['reid'];

344 
	g$likeTy
 = "";

345 if(
	g$tyty
=="top")

347 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl

348 
From
 #@
__y
 
whe
 
id
=0 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0,
	g$row
";

350 if(
	g$tyty
=="sun"||
$tyty
=="son")

352 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl

353 
From
 #@
__y
 
whe
 
id
='$tyid' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0,
	g$row
";

355 if(
	g$tyty
=="self")

357 
$sql
 = "Select id,typename,typedir,isdefault,ispart,defaultname,namerule2,moresite,siteurl

358 
From
 #@
__y
 
whe
 
id
='$id' 
And
 
ishidd
<>1 
d
 
by
 
s܌k
 
asc
 
lim
 0,
	g$row
";

362 
	g$d2
 = 
w
 
DedeTagP
();

363 
	g$d2
->
SNameS
("field","[","]");

364 
	g$d2
->
LdSour
(
$ùext
);

365 
	g$this
->
	gdsql
->
SQuy
(
$sql
);

366 
	g$this
->
	gdsql
->
Execu
();

367 
	g$le
 = 
$row
;

368 
	g$GLOBALS
['autoindex'] = 0;

369 if(
	g$c
>1)

371 
	g$likeTy
 = "<table width='$tablewidth' border='0' cellspacing='0' cellpadding='0'>\r\n";

373 
	g$i
=0;$i<
	g$le
;$i++)

375 if(
	g$c
>1)

377 
	g$likeTy
 .= "<tr>\r\n";

379 
	g$j
=0;$j<
	g$c
;$j++)

381 if(
	g$c
>1
	g$likeTy
 .= " <td width='$colWidth'>\r\n";

382 if(
	g$row
=
$this
->
dsql
->
GAay
())

385 if(
$row
['id']=="$tyid" && 
$myùext
 != '')

387 
$lkOkr
 = 
$myùext
;

388 
	g$row
['tylk'] = 
$this
->
GOTyU
(
$row
);

389 
	g$lkOkr
 = 
r_a
("~tylk~",
$row
['tylk'],
$lkOkr
);

390 
	g$lkOkr
 = 
r_a
("~tyme~",
$row
['tyme'],
$lkOkr
);

391 
	g$likeTy
 .
$lkOkr
;

396 
	g$row
['tylk'] = 
$this
->
GOTyU
(
$row
);

397 if(
is_y
(
$d2
->
CTags
))

399 
fܗch
(
$d2
->
CTags
 
as
 
$gid
=>
$ag
)

401 if(
ist
(
$row
[
$ag
->
GName
()]))

403 
$d2
->
Assign
(
$gid
,
$row
[
$ag
->
GName
()]);

407 
	g$likeTy
 .
$d2
->
GResu
();

410 if(
	g$c
>1)

412 
	g$likeTy
 .= " </td>\r\n";

414 
	g$GLOBALS
['autoindex']++;

417 if(
	g$c
>1)

419 
	g$i
 +
$c
 - 1;

421 if(
	g$c
>1)

423 
	g$likeTy
 .= " </tr>\r\n";

427 if(
	g$c
>1)

429 
	g$likeTy
 .= " </table>\r\n";

431 
	g$this
->
	gdsql
->
FeResu
();

432  
	g$likeTy
;

	@include/typeunit.class.admin.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
que_
(
DEDEINC
."/channelunit.func.php");

6 as
	cTyUn


8 
v
 
	m$dsql
;

9 
v
 
	m$tD
;

10 
v
 
	m$baD
;

11 
v
 
	m$idCou
;

12 
v
 
	m$idAy
;

13 
v
 
	m$shtName
;

14 
v
 
	m$CogNums
;

17 
funi
 
	$__cڡru
()

19 
$this
->
idCou
 = 0;

20 
$this
->
tD
 = 
$GLOBALS
['cfg_cmspath'].$GLOBALS['cfg_arcdir'];

21 
$this
->
baD
 = 
$GLOBALS
['cfg_basedir'];

22 
$this
->
shtName
 = 
$GLOBALS
['art_shortname'];

23 
$this
->
idAy
 = '';

24 
$this
->
dsql
 = 0;

27 
funi
 
	$TyUn
()

29 
$this
->
	`__cڡru
();

30 
	}
}

33 
funi
 
	$Clo
()

35 
	}
}

38 
funi
 
	$UpdeCogNum
()

40 
$this
->
dsql
->
	`SQuy
("SELECTypeid,count(typeid)s dd FROM `#@__arctiny` wherercrank <>-2 group byypeid");

41 
$this
->
dsql
->
	`Execu
();

42 
$row
 = 
$this
->
dsql
->
	`GAay
())

44 
$this
->
CogNums
[
$row
['typeid']] = $row['dd'];

46 
	}
}

48 
funi
 
	$GTٮArc
(
$tid
)

50 if(!
	`is_y
(
$this
->
CogNums
))

52 
$this
->
	`UpdeCogNum
();

54 if(!
	`ist
(
$this
->
CogNums
[
$tid
]))

60 
$tٮnum
 = 0;

61 
$ids
 = 
	`exode
(',',
	`GSIds
(
$tid
));

62 
	`fܗch
(
$ids
 
as
 
$tid
)

64 if(
	`ist
(
$this
->
CogNums
[
$tid
]))

66 
$tٮnum
 +
$this
->
CogNums
[
$tid
];

69  
$tٮnum
;

71 
	}
}

74 
funi
 
	$LiATy
(
$chl
=0,
$nowd
=0)

76 
glob
 
$cfg_adm_chl
, 
$adm_logs
;

77 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

80 if(
$cfg_adm_chl
=='array')

82 
$adm_log
 = 
	`jo
(',', 
$adm_logs
);

83 
$this
->
dsql
->
	`SQuy
("Selecteid From `#@__arctype` where id in($admin_catalog) group byeid ");

84 
$this
->
dsql
->
	`Execu
();

85 
$tidr
 = '';

86 
$row
 = 
$this
->
dsql
->
	`GObje
())

88 if(
$row
->
id
==0) ;

89 
$tidr
 .($tidr=='' ? 
$row
->
id
 : ','.$row->reid);

91 
$adm_log
 .','.
$tidr
;

92 
$adm_logs
 = 
	`exode
(',', 
$adm_log
);

93 
$adm_logs
 = 
	`y_unique
($admin_catalogs);

96 
$this
->
dsql
->
	`SQuy
("Select id,typedir,typename,ispart,sortrank,ishidden From `#@__arctype` whereeid=0 order by sortrank");

97 
$this
->
dsql
->
	`Execu
(0);

98 
$row
 = 
$this
->
dsql
->
	`GObje
(0))

100 if
$cfg_adm_chl
=='y' && !
	`_y
(
$row
->
id
, 
$adm_logs
) )

104 
$tyD
 = 
$row
->
tyd
;

105 
$tyName
 = 
$row
->
tyme
;

106 
$it
 = 
$row
->
it
;

107 
$id
 = 
$row
->
id
;

108 
$nk
 = 
$row
->
s܌k
;

109 if(
$row
->
ishidd
=='1')

111 
$nss
 = "<font color='red'>[隐]</font>";

115 
$nss
 = '';

117 
echo
 "<table width='100%' border='0' cellspacing='0' cellpadding='2'>\r\n";

119 if(
$it
==0)

121 
echo
 " <tr bgcolor='#F5FAE4'>\r\n";

122 
echo
 " <td width='2%' css='ble'><img sty='curs:por' onClick=\"LdSuns('suns".
$id
."',$id);\" src='img/dedeexplode.gif' width='11' height='11'></td>\r\n";

123 
echo
 " <td css='ble'><b width='98%' bd='0' clacg='0' caddg='0'><><td width='50%'><puass=''y='checkbox'ame='tids[]' vue='{$id}'><hf='log_do.php?cid=".
$id
."&doiArchives' oncڋxtmu=\"CommMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\">{$nss}".$tyName."[ID:".$id."]</a>(文档：".
$this
->
	`GTٮArc
($id).") <a onclick=\"AlertMsg('快捷编辑窗口','$id');\" href=\"javascript:;\"><img src='img/write2.gif'/></a>";

124 
echo
 " </td><tdlign='right'>";

125 
echo
 "<a href='{$GLOBALS['cfg_phpurl']}/list.php?tid={$id}'arget='_blank'>预览</a>";

126 
echo
 "|<a href='catalog_do.php?cid={$id}&dopost=listArchives'>内容</a>";

127 
echo
 "|<a href='catalog_add.php?id={$id}'>增加子类</a>";

128 
echo
 "|<a href='catalog_edit.php?id={$id}'>更改</a>";

129 
echo
 "|<a href='catalog_do.php?dopost=moveCatalog&typeid={$id}'>移动</a>";

130 
echo
 "|<hf='log_d.php?id={$id}&tydme=".
	`ucode
(
$tyName
)."'>删除</a>";

131 
echo
 "&nbsp; <inputype='text'ame='sortrank{$id}' value='{$rank}' style='width:25;height:16'></td></tr></table></td></tr>\r\n";

134 if(
$it
==1)

136 
echo
 " <tr bgcolor='#F5FAE4'>\r\n";

137 
echo
 " <td width='2%' css='ble'><img sty='curs:por' onClick=\"LdSuns('suns".
$id
."',$id);\" src='img/dedeexplode.gif' width='11' height='11'></td>\r\n";

138 
echo
 " <td css='ble'><b width='98%' bd='0' clacg='0' caddg='0'><><td width='50%'><puass=''y='checkbox'ame='tids[]' vue='{$id}'><hf='log_do.php?cid=".
$id
."&doiArchives' oncڋxtmu=\"CommMuPtvt,this,$id,'".
	`ucode
(
$tyName
)."')\">{$nss}".$typeName."[ID:".$id."]</a> <a onclick=\"AlertMsg('快捷编辑窗口','$id');\" href=\"javascript:;\"> <img src='img/write2.gif'/> </a>";

139 
echo
 " </td><tdlign='right'>";

140 
echo
 "<a href='{$GLOBALS['cfg_phpurl']}/list.php?tid={$id}'arget='_blank'>预览</a>";

141 
echo
 "|<a href='catalog_do.php?cid={$id}&dopost=listArchives'>内容</a>";

142 
echo
 "|<a href='catalog_add.php?id={$id}'>增加子类</a>";

143 
echo
 "|<a href='catalog_edit.php?id={$id}'>更改</a>";

144 
echo
 "|<a href='catalog_do.php?dopost=moveCatalog&typeid={$id}'>移动</a>";

145 
echo
 "|<hf='log_d.php?id={$id}&tydme=".
	`ucode
(
$tyName
)."'>删除</a>";

146 
echo
 "&nbsp; <inputype='text'ame='sortrank{$id}' value='{$rank}' style='width:25;height:16'></td></tr></table></td></tr>\r\n";

149 if(
$it
==2)

151 
echo
 " <tr height='24' bgcolor='#F5FAE4'>\r\n";

152 
echo
 " <td width='2%' css='ble2'><img sty='curs:por' onClick=\"LdSuns('suns".
$id
."',$id);\" src='img/dedeexplode.gif' width='11' height='11'></td>\r\n";

153 
echo
 " <td css='ble2'><b width='98%' bd='0' clacg='0' caddg='0'><><td width='50%'><puass=''y='checkbox'ame='tids[]' vue='{$id}'><hf='log_ed.php?id=".
$id
."' oncڋxtmu=\"SgMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\">{$nss}".$typeName."[ID:".$id."]</a> <a onclick=\"AlertMsg('快捷编辑窗口','$id');\" href=\"javascript:;\"><img src='img/write2.gif'/></a>";

154 
echo
 " </td><tdlign='right'>";

155 
echo
 "<a href='{$typeDir}'arget='_blank'>预览</a>";

156 
echo
 "|<a href='catalog_edit.php?id={$id}'>更改</a>";

157 
echo
 "|<a href='catalog_do.php?dopost=moveCatalog&typeid={$id}'>移动</a>";

158 
echo
 "|<hf='log_d.php?id={$id}&tydme=".
	`ucode
(
$tyName
)."'>删除</a>";

159 
echo
 "&nbsp; <inputype='text'ame='sortrank{$id}' value='{$rank}' style='width:25;height:16'></td></tr></table></td></tr>\r\n";

161 
echo
 " <><td cޥ='2' id='suns".
$id
."'>";

162 
$ϡid
 = 
	`GCook
('lastCid');

163 if(
$chl
==
$id
 || 
$ϡid
==$id || 
	`ist
(
$GLOBALS
['exl']|| 
$cfg_adm_chl
=='array')

165 
echo
 " <table width='100%' border='0' cellspacing='0' cellpadding='0'>\r\n";

166 
$this
->
	`LogicLiASunTy
(
$id
,"　");

167 
echo
 " </table>\r\n";

169 
echo
 "</td></tr>\r\n</table>\r\n";

171 
	}
}

174 
funi
 
	$LogicLiASunTy
(
$id
,
$
)

176 
glob
 
$cfg_adm_chl
, 
$adm_logs
;

177 
$fid
 = 
$id
;

178 
$this
->
dsql
->
	`SQuy
("Se id,id,tyd,tyme,it,s܌k,ishidd From `#@__y` whid='".
$id
."' order by sortrank");

179 
$this
->
dsql
->
	`Execu
(
$fid
);

180 if(
$this
->
dsql
->
	`GTٮRow
(
$fid
)>0)

182 
$row
 = 
$this
->
dsql
->
	`GObje
(
$fid
))

184 if(
$cfg_adm_chl
=='y' && !
	`_y
(
$row
->
id
, 
$adm_logs
) )

188 
$tyD
 = 
$row
->
tyd
;

189 
$tyName
 = 
$row
->
tyme
;

190 
$id
 = 
$row
->
id
;

191 
$id
 = 
$row
->
id
;

192 
$it
 = 
$row
->
it
;

193 if(
$
=="　")

195 
$dd
 = 2;

199 
$dd
 = 3;

201 
$nk
 = 
$row
->
s܌k
;

202 if(
$row
->
ishidd
=='1')

204 
$nss
 = "<font color='red'>[隐]</font>";

208 
$nss
 = '';

212 if(
$it
==0)

214 
echo
 "< height='24' oncڋxtmu=\"CommMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\">\r\n";

215 
echo
 "<td class='nbline'>";

216 
echo
 "<table width='98%' border='0' cellspacing='0' cellpadding='0'>";

217 
echo
 "<tr onMouseMove=\"javascript:this.bgColor='#FAFCE0';\" onMouseOut=\"javascript:this.bgColor='#FFFFFF';\"><td width='50%'>";

218 
echo
 "<puass=''y='checkbox'ame='tids[]' vue='{$id}'><hf='log_do.php?cid=".
$id
."&doiArchives'>$ ·{$nss}".
$tyName
."[ID:".$id."]</a>(文档：".
$this
->
	`GTٮArc
($id).") <a onclick=\"AlertMsg('快捷编辑窗口','$id');\" href=\"javascript:;\"><img src='img/write2.gif'/></a>";

219 
echo
 "</td><tdlign='right'>";

220 
echo
 "<a href='{$GLOBALS['cfg_phpurl']}/list.php?tid={$id}'arget='_blank'>预览</a>";

221 
echo
 "|<a href='catalog_do.php?cid={$id}&dopost=listArchives'>内容</a>";

222 
echo
 "|<a href='catalog_add.php?id={$id}'>增加子类</a>";

223 
echo
 "|<a href='catalog_edit.php?id={$id}'>更改</a>";

224 
echo
 "|<a href='catalog_do.php?dopost=moveCatalog&typeid={$id}'>移动</a>";

225 
echo
 "|<hf='log_d.php?id={$id}&tydme=".
	`ucode
(
$tyName
)."'>删除</a>";

226 
echo
 "&nbsp; <inputype='text'ame='sortrank{$id}' value='{$rank}' style='width:25;height:16'></td></tr></table></td></tr>\r\n";

230 if(
$it
==1)

232 
echo
 " < height='24' oncڋxtmu=\"CommMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\">\r\n";

233 
echo
 "<td class='nbline'><table width='98%' border='0' cellspacing='0' cellpadding='0'><tr onMouseMove=\"javascript:this.bgColor='#FAFCE0';\" onMouseOut=\"javascript:this.bgColor='#FFFFFF';\"><td width='50%'>";

234 
echo
 "<puass=''y='checkbox'ame='tids[]' vue='{$id}'><hf='log_do.php?cid=".
$id
."&doiArchives'>$ ·{$nss}".
$tyName
."[ID:".$id."]</a> <a onclick=\"AlertMsg('快捷编辑窗口','$id');\" href=\"javascript:;\"><img src='img/write2.gif'/></a>";

235 
echo
 "</td><tdlign='right'>";

236 
echo
 "<a href='{$GLOBALS['cfg_phpurl']}/list.php?tid={$id}'arget='_blank'>预览</a>";

237 
echo
 "|<a href='catalog_do.php?cid={$id}&dopost=listArchives'>内容</a>";

238 
echo
 "|<a href='catalog_add.php?id={$id}'>增加子类</a>";

239 
echo
 "|<a href='catalog_edit.php?id={$id}'>更改</a>";

240 
echo
 "|<a href='catalog_do.php?dopost=moveCatalog&typeid={$id}'>移动</a>";

241 
echo
 "|<hf='log_d.php?id={$id}&tydme=".
	`ucode
(
$tyName
)."'>删除</a>";

242 
echo
 "&nbsp; <inputype='text'ame='sortrank{$id}' value='{$rank}' style='width:25;height:16'></td></tr></table></td></tr>\r\n";

246 if(
$it
==2)

248 
echo
 "< height='24' oncڋxtmu=\"SgMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\">\r\n";

249 
echo
 "<td class='bline2'><table width='98%' border='0' cellspacing='0' cellpadding='0'>";

250 
echo
 "<tr onMouseMove=\"javascript:this.bgColor='#FAFCE0';\" onMouseOut=\"javascript:this.bgColor='#FFFFFF';\"><td width='50%'>";

251 
echo
 "<puass=''y='checkbox'ame='tids[]' vue='{$id}'><hf='log_do.php?cid=".
$id
."&doiArchives'>$ ·{$nss}".
$tyName
."[ID:".$id."]</a> <a onclick=\"AlertMsg('快捷编辑窗口','$id');\" href=\"javascript:;\"><img src='img/write2.gif'/></a>";

252 
echo
 "</td><tdlign='right'>";

253 
echo
 "<a href='{$typeDir}'arget='_blank'>预览</a>";

254 
echo
 "|<a href='catalog_edit.php?id={$id}'>更改</a>";

255 
echo
 "|<a href='catalog_do.php?dopost=moveCatalog&typeid={$id}'>移动</a>";

256 
echo
 "|<hf='log_d.php?id={$id}&tydme=".
	`ucode
(
$tyName
)."'>删除</a>";

257 
echo
 "&nbsp; <inputype='text'ame='sortrank{$id}' value='{$rank}' style='width:25;height:16'></td></tr></table></td></tr>\r\n";

259 
$this
->
	`LogicLiASunTy
(
$id
,
$
."　");

262 
	}
}

265 
funi
 
	$GSunTys
(
$id
,
$chl
=0)

267 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

268 
$this
->
idAay
[$this->
idCou
]=
$id
;

269 
$this
->
idCou
++;

270 
$fid
 = 
$id
;

271 if(
$chl
!=0)

273 
$csql
 = " And channeltype=$channel ";

277 
$csql
 = "";

279 
$this
->
dsql
->
	`SQuy
("Select id From `#@__arctype` whereeid=$id $csql");

280 
$this
->
dsql
->
	`Execu
("gs".
$fid
);

284 
$row
=
$this
->
dsql
->
	`GObje
("gs".
$fid
))

286 
$nid
 = 
$row
->
id
;

287 
$this
->
	`GSunTys
(
$nid
,
$chl
);

290  
$this
->
idAay
;

291 
	}
}

294 
funi
 
	$DTy
(
$id
,
$isDFe
)

296 
$this
->
idCou
 = 0;

297 
$this
->
idAay
 = "";

298 
$this
->
	`GSunTys
(
$id
);

299 
$quy
 = "

300 
Se
 #@
__y
.*,#@
__chy
.
tyme
 
as
 
yme
,

301 #@
__chy
.
addb


302 
From
 `#@
__y
` 

 
jo
 #@
__chy


303 

 #@
__chy
.
id
=#@
__y
.
chy


304 
whe
 #@
__y
.
id
='$id'

306 
$tyfos
 = 
$this
->
dsql
->
	`GO
(
$quy
);

307 
$tݚfos
 = 
$this
->
dsql
->
	`GO
("Se mese,seu From `#@__y` whid='".
$tyfos
['topid']."'");

308 if(!
	`is_y
(
$tyfos
))

310  
l
;

312 
$d
 = 
$tyfos
['typedir'];

313 
$addb
 = 
$tyfos
['addtable'];

314 
$it
 = 
$tyfos
['ispart'];

315 
$deume
 = 
$tyfos
['defaultname'];

318 
	`fܗch
(
$this
->
idAay
 
as
 
$id
)

320 
$myrow
 = 
$this
->
dsql
->
	`GO
("Select * From `#@__arctype` where id='$id'");

321 if(
$myrow
['topid']>0)

323 
$mytrow
 = 
$this
->
dsql
->
	`GO
("Se mese,seu From `#@__y` whid='".
$myrow
['topid']."'");

324 if(
	`is_y
(
$mytrow
&& !
	`emy
($mytoprow))

326 
	`fܗch
(
$mytrow
 
as
 
$k
=>
$v
)

328 if(!
	`eg
("[0-9]",
$k
))

330 
$myrow
[
$k
] = 
$v
;

338 if(
$myrow
['ispart']==2 && $myrow['typedir']=='')

340 if
	`is_fe
(
$this
->
baD
.'/'.
$myrow
['defaultname']) )

342 @
	`uƚk
(
$this
->
baD
.'/'.
$myrow
['defaultname']);

347 
$this
->
dsql
->
	`ExecuNeQuy
("Delete From `#@__arctype` where id='$id'");

348 
$this
->
dsql
->
	`ExecuNeQuy
("Delete From `#@__arctiny` whereypeid='$id'");

349 
$this
->
dsql
->
	`ExecuNeQuy
("Delete From `#@__archives` whereypeid='$id'");

350 
$this
->
dsql
->
	`ExecuNeQuy
("Delete From `#@__spec` whereypeid='$id'");

351 
$this
->
dsql
->
	`ExecuNeQuy
("Delete From `#@__feedback` whereypeid='$id'");

352 if(
$addb
!="")

354 
$this
->
dsql
->
	`ExecuNeQuy
("Delete From $addtable whereypeid='$id'");

360 if(
$it
==2 && 
$d
=="")

362 if
	`is_fe
(
$this
->
baD
."/".
$deume
) )

364 @
	`uƚk
(
$this
->
baD
."/".
$deume
);

367 @
	`t
(
$this
->
idAay
);

368 
$this
->
idCou
 = 0;

369  
ue
;

370 
	}
}

373 
funi
 
	$RmDFe
(
$d
)

375 if(!
	`fe_exis
(
$d
)) ;

376 
$dh
 = 
	`d
(
$d
);

377 
$fe
 = 
$dh
->
	`ad
())

379 if(
$fe
 == "." || $file == "..")

383 if(
	`is_fe
("$indir/$file"))

385 @
	`uƚk
("$indir/$file");

389 
$this
->
	`RmDFe
("$indir/$file");

391 if(
	`is_d
("$indir/$file"))

393 @
	`rmd
("$indir/$file");

396 
$dh
->
	`o
();

398 
	}
}

	@include/typeunit.class.menu.php

1 <?
php


2 if(!
defed
('DEDEINC'))

4 
ex
("Request Error!");

7 
que_
(
DEDEROOT
."/data/cache/inc_catalog_base.inc");

9 as
	cTyUn


11 
v
 
	m$dsql
;

12 
v
 
	m$aChls
;

13 
v
 
	m$isAdmA
;

16 
funi
 
__cڡru
(
$ogs
='')

18 
glob
 
$_Cs
;

19 
	m$this
->
	mdsql
 = 
$GLOBALS
['dsql'];

20 
	m$this
->
	maChls
 = 
Aay
();

21 
	m$this
->
	misAdmA
 = 
l
;

22 if(!
emy
(
$ogs
&& 
	m$ogs
!='-1')

24 
$this
->
aChls
 = 
exode
(',',
$ogs
);

25 
fܗch
(
$this
->
aChls
 
as
 
$cid
)

27 if(
	m$_Cs
[
$cid
][0]==0)

29 
$this
->
dsql
->
SQuy
("Select id,ispart From `#@__arctype` whereeid=$cid");

30 
	m$this
->
	mdsql
->
Execu
();

31 
	m$row
 = 
$this
->
dsql
->
GObje
())

34 
$this
->
aChls
[] = 
$row
->
id
;

41 
	m$this
->
	misAdmA
 = 
ue
;

45 
funi
 
TyUn
(
$ogs
='')

47 
$this
->
__cڡru
(
$ogs
);

51 
funi
 
	$Clo
()

53 
	}
}

56 
funi
 
	$LiATy
(
$chl
=0,
$nowd
=0)

59 
glob
 
$cfg_adm_chl
, 
$adm_logs
;

62 if(
$cfg_adm_chl
=='array')

64 
$adm_log
 = 
	`jo
(',', 
$adm_logs
);

65 
$this
->
dsql
->
	`SQuy
("Selecteid From `#@__arctype` where id in($admin_catalog) group byeid ");

66 
$this
->
dsql
->
	`Execu
();

67 
$tidr
 = '';

68 
$row
 = 
$this
->
dsql
->
	`GObje
())

70 if(
$row
->
id
==0) ;

71 
$tidr
 .($tidr=='' ? 
$row
->
id
 : ','.$row->reid);

73 
$adm_log
 .','.
$tidr
;

74 
$adm_logs
 = 
	`exode
(',', 
$adm_log
);

75 
$adm_logs
 = 
	`y_unique
($admin_catalogs);

78 
$this
->
dsql
->
	`SQuy
("Select id,typedir,typename,ispart,channeltype From `#@__arctype` whereeid=0 order by sortrank");

80 
$this
->
dsql
->
	`Execu
(0);

81 
$ϡid
 = 
	`GCook
('lastCidMenu');

82 
$row
=
$this
->
dsql
->
	`GObje
(0))

84 if
$cfg_adm_chl
=='y' && !
	`_y
(
$row
->
id
, 
$adm_logs
) )

89 
$tyD
 = 
$row
->
tyd
;

90 
$tyName
 = 
$row
->
tyme
;

91 
$it
 = 
$row
->
it
;

92 
$id
 = 
$row
->
id
;

93 
$chy
 = 
$row
->
chy
;

96 if(
$it
==0)

98 
$smu
 = " oncڋxtmu=\"CommMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\"";

101 if(
$it
==1)

103 
$smu
 = " oncڋxtmu=\"CommMuPtvt,this,$id,'".
	`ucode
(
$tyName
)."')\"";

114 
$smu
 = " oncڋxtmu=\"JumpMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\" ";

116 
echo
 "<dl class='topcc'>\r\n";

117 
echo
 " <dd class='dlf'><img style='cursor:pointer' onClick=\"LoadSuns('suns{$id}',{$id});\" src='img/tree_explode.gif' width='11' height='11'></dd>\r\n";

118 
echo
 " <dd css='d'><hf='log_do.php?cid=".
$id
."&doiArchives'{$smu}>".
$tyName
."</a></dd>\r\n";

119 
echo
 "</dl>\r\n";

120 
echo
 "<div id='suns".
$id
."' class='sunct'>";

121 if(
$ϡid
==
$id
 || 
$cfg_adm_chl
=='array')

123 
$this
->
	`LogicLiASunTy
(
$id
, "　");

125 
echo
 "</div>\r\n";

127 
	}
}

130 
funi
 
	$LogicLiASunTy
(
$id
,
$
,
$edcheck
=
ue
)

132 
glob
 
$cfg_adm_chl
, 
$adm_logs
;

133 
$fid
 = 
$id
;

134 
$this
->
dsql
->
	`SQuy
("Se id,id,tyd,tyme,it,chy From `#@__y` whid='".
$id
."' order by sortrank");

135 
$this
->
dsql
->
	`Execu
(
$fid
);

136 if(
$this
->
dsql
->
	`GTٮRow
(
$fid
)>0)

138 
$row
=
$this
->
dsql
->
	`GObje
(
$fid
))

140 if(
$cfg_adm_chl
=='y' && !
	`_y
(
$row
->
id
, 
$adm_logs
) )

144 
$tyD
 = 
$row
->
tyd
;

145 
$tyName
 = 
$row
->
tyme
;

146 
$id
 = 
$row
->
id
;

147 
$id
 = 
$row
->
id
;

148 
$it
 = 
$row
->
it
;

149 
$chy
 = 
$row
->
chy
;

150 if(
$
=="　")

152 
$dd
 = 2;

156 
$dd
 = 3;

160 if(
	`_y
(
$id
,
$this
->
aChls
|| 
$edcheck
===
l
 || $this->
isAdmA
===
ue
)

163 if(
$it
==0||
	`emy
($ispart))

165 
$smu
 = " oncڋxtmu=\"CommMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\"";

166 
$timg
 = " <img src='img/tree_page.gif'> ";

170 if(
$it
==1)

172 
$smu
 = " oncڋxtmu=\"CommMuPtvt,this,$id,'".
	`ucode
(
$tyName
)."')\"";

173 
$timg
 = " <img src='img/tree_part.gif'> ";

187 
$timg
 = " <img src='img/tree_page.gif'> ";

188 
$smu
 = " oncڋxtmu=\"JumpMuvt,this,$id,'".
	`ucode
(
$tyName
)."')\" ";

190 
echo
 " <table class='sunlist'>\r\n";

191 
echo
 " <tr>\r\n";

192 
echo
 " <td>".
$
.
$timg
."<hf='log_do.php?cid=".
$id
."&doiArchives'{$smu}>".
$tyName
."</a></td>\r\n";

193 
echo
 " </tr>\r\n";

194 
echo
 " </table>\r\n";

195 
$this
->
	`LogicLiASunTy
(
$id
,
$
."　",
l
);

199 
	}
}

	@include/typeunit.class.selector.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 
que_
(
DEDEROOT
."/data/cache/inc_catalog_base.inc");

6 as
	cTyUnSe


8 
v
 
	m$dsql
;

11 
funi
 
	$__cڡru
()

13 
glob
 
$_Cs
;

14 
$this
->
dsql
 = 
$GLOBALS
['dsql'];

17 
funi
 
	$TyUnSe
()

19 
$this
->
	`__cڡru
();

20 
	}
}

23 
funi
 
	$Clo
({ 
	}
}

25 
funi
 
	$LiATy
(
$chl
=0)

28 
glob
 
$cfg_adm_chl
, 
$adm_logs
, 
$rgid
, 
$dvue
;

30 
$dvues
 = 
	`y
();

31 if(!
	`emy
(
$dvue
)
$dvues
 = 
	`exode
(',', $oldvalue);

33 if(
$cfg_adm_chl
=='array')

35 
$adm_log
 = 
	`jo
(',', 
$adm_logs
);

36 
$this
->
dsql
->
	`SQuy
("Selecteid From `#@__arctype` where id in($admin_catalog) group byeid ");

37 
$this
->
dsql
->
	`Execu
();

38 
$tidr
 = '';

39 
$row
 = 
$this
->
dsql
->
	`GObje
())

41 if(
$row
->
id
==0) ;

42 
$tidr
 .($tidr=='' ? 
$row
->
id
 : ','.$row->reid);

44 
$adm_log
 .','.
$tidr
;

45 
$adm_logs
 = 
	`exode
(',', 
$adm_log
);

46 
$adm_logs
 = 
	`y_unique
($admin_catalogs);

49 
$this
->
dsql
->
	`SQuy
("Select id,typedir,typename,ispart,channeltype From `#@__arctype` whereeid=0 order by sortrank");

51 
$this
->
dsql
->
	`Execu
(0);

52 
$ϡid
 = 
	`GCook
('lastCidMenu');

53 
$row
=
$this
->
dsql
->
	`GObje
(0))

55 if
$cfg_adm_chl
=='y' && !
	`_y
(
$row
->
id
, 
$adm_logs
) )

59 
$tyD
 = 
$row
->
tyd
;

60 
$tyName
 = 
$row
->
tyme
;

61 
$it
 = 
$row
->
it
;

62 
$id
 = 
$row
->
id
;

63 
$chy
 = 
$row
->
chy
;

64 
$ischeck
 = 
	`_y
(
$id
, 
$dvues
) ? ' checked' : '';

65 
$chackRadio
 = "<inputype='radio'ame='seltypeid' value='{$id}' $ischeck />";

66 if(
$rgid
=='tyid2'
$chackRadio
 = "<inputype='checkbox'ame='seltypeid' id='seltypeid{$id}' value='{$id}' $ischeck />";

67 if((!
	`emy
(
$chl
&& 
$chy
 !=$chl|| 
$it
!=0)

69 
$chackRadio
 = '';

71 
$st
 = '';

72 
$this
->
	`LogicLiASunTy
(
$id
, 
$chl
, 
$st
);

73 if(
$chackRadio
=='' && 
$st
=='') ;

74 
echo
 "<div class='quickselItem'>\r\n";

75 
echo
 " <div class='topcat'>{$chackRadio}{$typeName}</div>\r\n";

76 if(
$st
!=''
echo
 " <div class='soncat'>{$soncat}</div>\r\n";

77 
echo
 "</div>\r\n";

79 
	}
}

82 
funi
 
	$LogicLiASunTy
(
$id
, 
$chl
=0, &
$st
)

84 
glob
 
$cfg_adm_chl
, 
$adm_logs
, 
$rgid
, 
$dvue
;

85 
$fid
 = 
$id
;

86 
$dvues
 = 
	`y
();

87 if(!
	`emy
(
$dvue
)
$dvues
 = 
	`exode
(',', $oldvalue);

88 
$this
->
dsql
->
	`SQuy
("Se id,id,tyd,tyme,it,chy From `#@__y` whid='".
$id
."' order by sortrank");

89 
$this
->
dsql
->
	`Execu
(
$fid
);

90 
$row
=
$this
->
dsql
->
	`GObje
(
$fid
))

92 if(
$cfg_adm_chl
=='y' && !
	`_y
(
$row
->
id
, 
$adm_logs
) )

96 
$tyD
 = 
$row
->
tyd
;

97 
$tyName
 = 
$row
->
tyme
;

98 
$id
 = 
$row
->
id
;

99 
$id
 = 
$row
->
id
;

100 
$it
 = 
$row
->
it
;

101 
$chy
 = 
$row
->
chy
;

102 
$ischeck
 = 
	`_y
(
$id
, 
$dvues
) ? ' checked' : '';

103 
$chackRadio
 = "<inputype='radio'ame='seltypeid' value='{$row->id}' $ischeck />";

104 if(
$rgid
=='tyid2'
$chackRadio
 = "<inputype='checkbox'ame='seltypeid' id='seltypeid{$id}' value='{$id}' $ischeck />";

105 if(
$it
!=0)

107 
$chackRadio
 = '';

109 if(
$chy
!=
$chl
 && !
	`emy
($channel))

113 if(
$chackRadio
 !='' )

115 
$st
 ." <div css='em'>".
$chackRadio
.
$tyName
."</div>\r\n";

116 
$this
->
	`LogicLiASunTy
(
$id
, 
$chl
, 
$st
);

120 
$st
 ." <by='r:bh' /><div css='em'><b>".
$tyName
."：</b></div>\r\n";

121 
$this
->
	`LogicLiASunTy
(
$id
, 
$chl
, 
$st
);

122 
$st
 .= " <br style='clear:both' />";

125 
	}
}

	@include/uploadsafe.inc.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

4 if(
ist
(
$_FILES
['GLOBALS'])
ex
('Requestotllow!');

8 
	g$cfg_n_lowl
 = "php|pl|cgi|asp|aspx|jsp|php3|shtm|shtml";

9 
	g$keyr
 = 
y
('name','type','tmp_name','size');

11 
fܗch
(
$_FILES
 
as
 
$_key
=>
$_vue
)

13 
fܗch
(
$keyr
 
as
 
$k
)

15 if(!
ist
(
$_FILES
[
$_key
][
$k
]))

17 
ex
('Request Error!');

20 if
egi
('^(cfg_|GLOBALS)',
$_key
) )

22 
ex
('Request varotllow for uploadsafe!');

24 
	g$$_key
 = 
$_FILES
[
$_key
]['tmp_me'] = 
r_a
("\\\\","\\",$_FILES[$_key]['tmp_name']);

25 
	g$
{
	g$_key
.'_me'} = 
$_FILES
[
$_key
]['name'];

26 
	g$
{
	g$_key
.'_ty'} = 
$_FILES
[
$_key
]['ty'] = 
egi_a
('[^0-9a-z\./]','',$_FILES[$_key]['type']);

27 
	g$
{
	g$_key
.'_size'} = 
$_FILES
[
$_key
]['size'] = 
eg_a
('[^0-9]','',$_FILES[$_key]['size']);

28 if(!
emy
(
$
{
$_key
.'_me'}&& (
egi
("\.(".
$cfg_n_lowl
.")$",${$_key.'_me'}|| !
eg
("\.",${$_key.'_name'})) )

30 if(!
defed
('DEDEADMIN'))

32 
ex
('Upload filetypeotllow !');

35 if(
emy
(
$
{
$_key
.'_size'}))

37 
	g$
{
	g$_key
.'_size'} = @
fesize
(
$$_key
);

	@include/userlogin.class.php

1 <?
php


2 if(!
defed
('DEDEINC')
ex
('Request Error!');

3 
ssi_t
();

6 
funi
 
	$TePurvw
(
$n
)

8 
$rs
 = 
l
;

9 
$purvw
 = 
$GLOBALS
['curLog']->
	`gPurvw
();

10 if(
	`egi
('adm_AowA',
$purvw
))

12  
ue
;

14 if(
$n
=='')

16  
ue
;

18 if(!
	`ist
(
$GLOBALS
['groupRanks']))

20 
$GLOBALS
['groupRks'] = 
	`exode
(' ',
$purvw
);

22 
$ns
 = 
	`exode
(',',
$n
);

23 
	`fܗch
(
$ns
 
as
 
$n
)

26 if(
$n
=='')

30 if(
	`_y
(
$n
,
$GLOBALS
['groupRanks']))

32 
$rs
 = 
ue
; ;

35  
$rs
;

36 
	}
}

38 
funi
 
	$CheckPurvw
(
$n
)

40 if(!
	`TePurvw
(
$n
))

42 
	`ShowMsg
("对不起，你没有权限执行此操作！<br/><br/><a href='javascript:history.go(-1);'>点击此返回上一页&gt;&gt;</a>",'javascript:;');

43 
	`ex
();

45 
	}
}

48 
funi
 
	$TeAdm
()

50 
$purvw
 = 
$GLOBALS
['curLog']->
	`gPurvw
();

51 if(
	`egi
('adm_AowA',
$purvw
))

53  
ue
;

57  
l
;

59 
	}
}

61 
	g$DedeUrCogs
 = 
Aay
();

64 
funi
 
	$CheckCog
(
$cid
, 
$msg
)

66 
glob
 
$cfg_adm_chl
, 
$adm_logs
;

67 if(
$cfg_adm_chl
=='l' || 
	`TeAdm
())

69  
ue
;

71 if!
	`_y
(
$cid
, 
$adm_logs
) )

73 
	`ShowMsg
(" $msg <br/><br/><a href='javascript:history.go(-1);'>点击此返回上一页&gt;&gt;</a>",'javascript:;');

74 
	`ex
();

76  
ue
;

77 
	}
}

83 
funi
 
	$AddMyAdd
(
$fid
, 
$fame
)

85 
$cheFe
 = 
DEDEDATA
.'/che/add-'.
	`ssi_id
().'.inc';

86 if(!
	`fe_exis
(
$cheFe
))

88 
$
 = 
	`fݒ
(
$cheFe
, 'w');

89 
	`fwre
(
$
, '<'.'?php'."\r\n");

90 
	`fwre
(
$
, "\$myaddons =rray();\r\n");

91 
	`fwre
(
$
, "\$maNum = 0;\r\n");

92 
	`fo
(
$
);

94 
	`ude
(
$cheFe
);

95 
$
 = 
	`fݒ
(
$cheFe
, 'a');

96 
$rPos
 = 
$maNum
;

97 
$maNum
++;

98 
	`fwre
(
$
, "\$myaddons[\$maNum] =rray('$fid', '$filename');\r\n");

99 
	`fwre
(
$
, "\$maNum = $maNum;\r\n");

100 
	`fo
(
$
);

101 
	}
}

103 
funi
 
CˬMyAdd
(
$aid
=0, 
$t
='')

105 
glob
 
$dsql
;

106 
	g$cheFe
 = 
DEDEDATA
.'/che/add-'.
ssi_id
().'.inc';

107 
	g$_SESSION
['bigfe_fo'] = 
y
();

108 
	g$_SESSION
['fe_fo'] = 
y
();

109 if(!
fe_exis
(
$cheFe
))

114 if(!
emy
(
$aid
))

116 
ude
(
$cheFe
);

117 
fܗch
(
$myadds
 
as
 
$adds
)

119 if(!
emy
(
$t
)) {

120 
	g$dsql
->
ExecuNeQuy
("Update `#@__uploads` setrcid='$aid',title='$title' whereid='{$addons[0]}'");

123 
	g$dsql
->
ExecuNeQuy
("Update `#@__uploads` setrcid='$aid' whereid='{$addons[0]}' ");

127 @
uƚk
(
$cheFe
);

131 as
	curLog


133 
v
 
	m$urName
 = '';

134 
v
 
	m$urPwd
 = '';

135 
v
 
	m$urID
 = '';

136 
v
 
	m$admD
 = '';

137 
v
 
	m$urTy
 = '';

138 
v
 
	m$urChl
 = '';

139 
v
 
	m$urPurvw
 = '';

140 
v
 
	m$kpUrIDTag
 = 'dede_admin_id';

141 
v
 
	m$kpUrTyTag
 = 'dede_admin_type';

142 
v
 
	m$kpUrChlTag
 = 'dede_admin_channel';

143 
v
 
	m$kpUrNameTag
 = 'dede_admin_name';

144 
v
 
	m$kpUrPurvwTag
 = 'dede_admin_purview';

145 
v
 
	m$kpAdmStyTag
 = 'dede_admin_style';

146 
v
 
	m$admSty
 = 'dedecms';

149 
funi
 
__cڡru
(
$admd
='')

151 
glob
 
$adm_th
;

152 if(
ist
(
$_SESSION
[
$this
->
kpUrIDTag
]))

154 
	m$this
->
	murID
 = 
$_SESSION
[
$this
->
kpUrIDTag
];

155 
	m$this
->
	murTy
 = 
$_SESSION
[
$this
->
kpUrTyTag
];

156 
	m$this
->
	murChl
 = 
$_SESSION
[
$this
->
kpUrChlTag
];

157 
	m$this
->
	murName
 = 
$_SESSION
[
$this
->
kpUrNameTag
];

158 
	m$this
->
	murPurvw
 = 
$_SESSION
[
$this
->
kpUrPurvwTag
];

159 
	m$this
->
	madmSty
 = 
$_SESSION
[
$this
->
kpAdmStyTag
];

162 if(
	m$admd
!='')

164 
$this
->
admD
 = 
$admd
;

168 
	m$this
->
	madmD
 = 
$adm_th
;

172 
funi
 
urLog
(
$admd
='')

174 
$this
->
__cڡru
(
$admd
);

178 
funi
 
	$checkUr
(
$uame
,
$uwd
)

180 
glob
 
$dsql
;

183 
$this
->
urName
 = 
	`eg_a
("[^0-9a-zA-Z_@!\.-]",'',
$uame
);

184 
$this
->
urPwd
 = 
	`eg_a
("[^0-9a-zA-Z_@!\.-]",'',
$uwd
);

185 
$pwd
 = 
	`subr
(
	`md5
(
$this
->
urPwd
),5,20);

186 
$dsql
->
	`SQuy
("Sedm.*,y.purvwFrom `#@__adm`dme jo `#@__admty`ty oy.nkdm.uy whadm.uridik'".
$this
->
urName
."'imit 0,1");

187 
$dsql
->
	`Execu
();

188 
$row
 = 
$dsql
->
	`GObje
();

189 if(!
	`ist
(
$row
->
pwd
))

193 if(
$pwd
!=
$row
->
pwd
)

199 
$log
 = 
	`GIP
();

200 
$this
->
urID
 = 
$row
->
id
;

201 
$this
->
urTy
 = 
$row
->
uy
;

202 
$this
->
urChl
 = 
$row
->
tyid
;

203 
$this
->
urName
 = 
$row
->
ume
;

204 
$this
->
urPurvw
 = 
$row
->
purvws
;

205 
$quy
 = "upd`#@__adm` sog='$log',logtime='".
	`time
()."' whid='".
$row
->
id
."'";

206 
$dsql
->
	`ExecuNeQuy
(
$quy
);

207 
$sql
 = "upd#@__memb sogtime=".
	`time
().",og='$log' whmid=".
$row
->
id
;

208 
$dsql
->
	`ExecuNeQuy
(
$sql
);

211 
	}
}

215 
funi
 
	$kpUr
()

217 if(
$this
->
urID
 !'' && $this->
urTy
 != '')

219 
glob
 
$admchefe
,
$admy
;

220 if(
	`emy
(
$admy
)) $adminstyle = 'dedecms';

222 @
	`ssi_gi
(
$this
->
kpUrIDTag
);

223 
$_SESSION
[
$this
->
kpUrIDTag
] = $this->
urID
;

225 @
	`ssi_gi
(
$this
->
kpUrTyTag
);

226 
$_SESSION
[
$this
->
kpUrTyTag
] = $this->
urTy
;

228 @
	`ssi_gi
(
$this
->
kpUrChlTag
);

229 
$_SESSION
[
$this
->
kpUrChlTag
] = $this->
urChl
;

231 @
	`ssi_gi
(
$this
->
kpUrNameTag
);

232 
$_SESSION
[
$this
->
kpUrNameTag
] = $this->
urName
;

234 @
	`ssi_gi
(
$this
->
kpUrPurvwTag
);

235 
$_SESSION
[
$this
->
kpUrPurvwTag
] = $this->
urPurvw
;

237 @
	`ssi_gi
(
$this
->
kpAdmStyTag
);

238 
$_SESSION
[
$this
->
kpAdmStyTag
] = 
$admy
;

240 
	`PutCook
('DedeUrID', 
$this
->
urID
, 3600 * 24, '/');

241 
	`PutCook
('DedeLogTime', 
	`time
(), 3600 * 24, '/');

243 
$this
->
	`ReWreAdmChl
();

251 
	}
}

254 
funi
 
	$ReWreAdmChl
()

257 
$cheFe
 = 
DEDEDATA
.'/che/admt_'.
$this
->
urID
.'.inc';

259 
$tyid
 = 
	`im
(
$this
->
urChl
);

260 if
	`emy
(
$tyid
|| 
$this
->
	`gUrTy
() >= 10 ) {

261 
$fCfig
 = "\$cfg_admin_channel = 'all';\r\n\$admin_catalogs =rray();\r\n";

264 
$fCfig
 = "\$cfg_admin_channel = 'array';\r\n";

266 
$
 = 
	`fݒ
(
$cheFe
, 'w');

267 
	`fwre
(
$
, '<'.'?php'."\r\n");

268 
	`fwre
(
$
, 
$fCfig
);

269 if!
	`emy
(
$tyid
) )

271 
$tyids
 = 
	`exode
(',', 
$tyid
);

272 
$tyid
 = '';

273 
	`fܗch
(
$tyids
 
as
 
$tid
)

275 
$tyid
 .$tyid=='' ? 
	`GSIdsUL
(
$tid
) : ','.GetSonIdsUL($tid) );

277 
$tyids
 = 
	`exode
(',', 
$tyid
);

278 
$tyidew
 = 
	`y_unique
(
$tyids
);

279 
$tyid
 = 
	`jo
(',', 
$tyidew
);

280 
	`fwre
(
$
, "\$admin_catalogs =rray($typeid);\r\n");

282 
	`fwre
(
$
, '?'.'>');

283 
	`fo
(
$
);

284 
	}
}

287 
funi
 
	$exUr
()

289 
	`CˬMyAdd
();

290 @
	`ssi_uegi
(
$this
->
kpUrIDTag
);

291 @
	`ssi_uegi
(
$this
->
kpUrTyTag
);

292 @
	`ssi_uegi
(
$this
->
kpUrChlTag
);

293 @
	`ssi_uegi
(
$this
->
kpUrNameTag
);

294 @
	`ssi_uegi
(
$this
->
kpUrPurvwTag
);

295 
	`DrCook
('dedeAdmindir');

296 
	`DrCook
('DedeUserID');

297 
	`DrCook
('DedeLoginTime');

298 
$_SESSION
 = 
	`y
();

299 
	}
}

302 
funi
 
	$gUrChl
()

304 if(
$this
->
urChl
 != '')

306  
$this
->
urChl
;

312 
	}
}

315 
funi
 
	$gUrTy
()

317 if(
$this
->
urTy
 != '')

319  
$this
->
urTy
;

325 
	}
}

327 
funi
 
	$gUrRk
()

329  
$this
->
	`gUrTy
();

330 
	}
}

333 
funi
 
	$gUrID
()

335 if(
$this
->
urID
 != '')

337  
$this
->
urID
;

343 
	}
}

346 
funi
 
	$gUrName
()

348 if(
$this
->
urName
 != '')

350  
$this
->
urName
;

356 
	}
}

359 
funi
 
	$gPurvw
()

361  
$this
->
urPurvw
;

362 
	}
}

366 
funi
 
	$GSIdsUL
(
$id
, 
$chl
=0, 
$addthis
=
ue
)

368 
glob
 
$_Cs
;

369 
$GLOBALS
['idAay'] = 
	`y
();

370 if!
	`is_y
(
$_Cs
) )

372 
	`que_
(
DEDEROOT
."/data/cache/inc_catalog_base.inc");

374 
	`GSIdsLogicUL
(
$id
,
$_Cs
,
$chl
,
$addthis
);

375 
$rquy
 = 
	`jo
(',', 
$GLOBALS
['idArray']);

376  
$rquy
;

377 
	}
}

380 
funi
 
	$GSIdsLogicUL
(
$id
,
$sA
,
$chl
=0,
$addthis
=
l
)

382 if(
$id
!=0 && 
$addthis
)

384 
$GLOBALS
['idAay'][
$id
] = $id;

386 
	`fܗch
(
$sA
 
as
 
$k
=>
$v
)

388 if
$v
[0]==
$id
 && (
$chl
==0 || $v[1]==$channel ))

390 
	`GSIdsLogicUL
(
$k
,
$sA
,
$chl
,
ue
);

393 
	}
}

	@include/vdimgck.php

1 <?
php


3 
	g$ssSavePh
 = 
dme
(
__FILE__
)."/../data/sessions/";

4 if(
is_wrb
(
$ssSavePh
&& 
	$is_adab
(
$ssSavePh
)){ 
	`ssi_ve_th
($ssSavePh); 
	}
}

6 
ssi_t
();

9 
	g$drg
 = '';

10 
	g$i
=0; $i<4; $i++
	g$drg
 .
chr
(
mt_nd
(65,90));

13 if(
funi_exis
("imagecreate"))

16 
	g$ime
 = 
time
();

17 if(
emy
(
$_SESSION
['dd_ckr_ϡ']||my($_SESSION['dd_ckr']|| (
	g$ime
 - 
	g$_SESSION
['dd_ckstr_last'] > 5))

19 
	g$_SESSION
['dd_ckr'] = 
ow
(
$drg
);

20 
	g$_SESSION
['dd_ckr_ϡ'] = 
$ime
;

22 
	g$drg
 = 
$_SESSION
['dd_ckstr'];

23 
	g$dcod
 = 

(
$drg
);

26 
	g$im
 = 
image
(50,20);

27 
ImageCAo
(
$im
, 255,255,255);

30 
	g$leC1
 = 
ImageCAo
(
$im
,240,220,180);

31 
	g$leC2
 = 
ImageCAo
(
$im
,250,250,170);

32 
	g$j
=3;$j<=16;$j=
$j
+3)

34 
image
(
$im
,2,
$j
,48,$j,
$leC1
);

36 
	g$j
=2;$j<52;$j=
$j
+(
mt_nd
(3,6)))

38 
image
(
$im
,
$j
,2,$j-6,18,
$leC2
);

42 
	g$bdc
 = 
ImageCAo
(
$im
, 0x99,0x99,0x99);

43 
imageg
(
$im
, 0, 0, 49, 19, 
$bdc
);

46 
	g$ftC
 = 
ImageCAo
(
$im
, 48,61,50);

47 
	g$i
=0;$i<
	g$dcod
;$i++)

49 
	g$bc
 = 
mt_nd
(0,1);

50 
	g$drg
[
$i
] = 
ou
(
$drg
[$i]);

51 
imagerg
(
$im
, 5, 
$i
*10+6, 
mt_nd
(2,4), 
$drg
[$i], 
$ftC
);

54 
hd
("Pragma:no-cache\r\n");

55 
hd
("Cache-Control:no-cache\r\n");

56 
hd
("Expires:0\r\n");

59 if(
funi_exis
("imagejpeg"))

61 
hd
("content-type:image/jpeg\r\n");

62 
imagejg
(
$im
);

66 
hd
("content-type:image/png\r\n");

67 
imagng
(
$im
);

69 
ImageDeroy
(
$im
);

70 
ex
();

75 
	g$_SESSION
['dd_ckstr'] = "abcd";

76 
	g$_SESSION
['dd_ckstr_last'] = '';

77 
hd
("content-type:image/jpeg\r\n");

78 
hd
("Pragma:no-cache\r\n");

79 
hd
("Cache-Control:no-cache\r\n");

80 
hd
("Expires:0\r\n");

81 
	g$
 = 
fݒ
("data/vdcode.jpg","r");

82 
echo
 
d
(
$
,
fesize
("data/vdcode.jpg"));

83 
fo
(
$
);

84 
ex
();

	@include/zip.class.php

1 <?
php


2 as
	cz


4 
v
 
	m$dac
, 
	m$_d
 = 
y
();

5 
v
 
	m$eof__d
 = "\x50\x4b\x05\x06\x00\x00\x00\x00";

6 
v
 
	m$d_offt
 = 0; v 
	m$ds
 = 
Aay
(".");

8 
funi
 
	$g_Li
(
$z_me
)

10 
$t
 = '';

11 
$z
 = @
	`fݒ
(
$z_me
, 'rb');

12 if(!
$z
)

16 
$d
 = 
$this
->
	`RdCD
(
$z
,
$z_me
);

17 @
	`wd
(
$z
);

18 @
	`fek
(
$z
, 
$d
['offset']);

19 
$i
=0; $i<
$d
['entries']; $i++)

21 
$hd
 = 
$this
->
	`RdCFeHds
(
$z
);

22 
$hd
['dex'] = 
$i
;
$fo
['filename'] = $header['filename'];

23 
$fo
['ed_fame'] = 
$hd
['stored_filename'];

24 
$fo
['size'] = 
$hd
['size'];$info['compressed_size']=$header['compressed_size'];

25 
$fo
['c'] = 
	`ou
(
	`dechex

$hd
['crc'] ));

26 
$fo
['mtime'] = 
$hd
['mtime']; $info['comment'] = $header['comment'];

27 
$fo
['fd'] = (
$hd
['external']==0x41FF0010||$header['external']==16)?1:0;

28 
$fo
['dex'] = 
$hd
['index'];$info['status'] = $header['status'];

29 
$t
[]=
$fo
; 
	`unt
(
$hd
);

31  
$t
;

34 
funi
 
	$Add
(
$fes
,
$com
)

36 if(!
	`is_y
(
$fes
[0]))

38 
$fes
=
	`Aay
($files);

40 
$i
=0;
$fes
[$i];$i++)

42 
$
 = 
$fes
[
$i
];

43 if(!
	`_Aay
(
	`dme
(
$
[0]),
$this
->
ds
))

45 
$this
->
	`add_D
(
	`dme
(
$
[0]));

47 if(
	`bame
(
$
[0]))

49 
$t
[
	`bame
(
$
[0])]=
$this
->
	`add_Fe
($[1],$[0],
$com
);

52  
$t
;

53 
	}
}

55 
funi
 
	$g_fe
()

57 
$da
 = 
	`imode
('', 
$this
 -> 
dac
);

58 
$d
 = 
	`imode
('', 
$this
 -> 
_d
);

59  
$da
 . 
$d
 . 
$this
 -> 
eof__d
 .

60 
	`ck
('v', (
$this
 -> 
_d
)).pack('v', ($this -> ctrl_dir)).

61 
	`ck
('V', 
	`
(
$d
).ack('V', sn(
$da
)) . "\x00\x00";

62 
	}
}

64 
funi
 
	$add_d
(
$me
)

66 
$me
 = 
	`r_a
("\\", "/", $name);

67 
$
 = "\x50\x4b\x03\x04\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00";

68 
$
 .
	`ck
("V",0).ck("V",0).ck("V",0).ck("v", 
	`
(
$me
) );

69 
$
 .
	`ck
("v", 0 ).
$me
.pack("V", 0).pack("V", 0).pack("V", 0);

70 
$this
 -> 
dac
[] = 
$
;

71 
$w_offt
 = 
	`
(
	`imode
("", 
$this
->
dac
));

72 
$cdc
 = "\x50\x4b\x01\x02\x00\x00\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00";

73 
$cdc
 .
	`ck
("V",0).ck("V",0).ck("V",0).ck("v", 
	`
(
$me
) );

74 
$cdc
 .
	`ck
("v", 0 ).pack("v", 0 ).pack("v", 0 ).pack("v", 0 );

75 
$ext
 = "\xff\xff\xff\xff";

76 
$cdc
 .
	`ck
("V", 16 ).ck("V", 
$this
 -> 
d_offt
 ).
$me
;

77 
$this
 -> 
_d
[] = 
$cdc
;

78 
$this
 -> 
d_offt
 = 
$w_offt
;

79 
$this
 -> 
ds
[] = 
$me
;

80 
	}
}

84 
funi
 
CompeZFe
(
$fame
, 
$tozfame
,
$y
='dir')

86 i(@
funi_exis
('gzcompress'))

88 if(
$y
=='dir')

90 
$fi
 = 
$this
->
LiDFes
(
$fame
);

92 if(
	g$y
=='file')

94 
$fi
[] = 
$fame
;

98 
	g$fi
 = 
$fame
;

100 
	g$i
 = 0;

101 if(
cou
(
$fi
)>0)

103 
fܗch
(
$fi
 
as
 
$fame
)

105 i(
is_fe
(
$fame
))

107 
	g$i
++;

108 
	g$fd
 = 
fݒ
 (
$fame
, "r");

109 if(
fesize
(
$fame
)>0)

111 
	g$cڋ
 = 
d
(
$fd
, 
fesize
(
$fame
));

115 
	g$cڋ
 = ' ';

117 
fo
 (
$fd
);

120 
	g$this
->
add_Fe
(
$cڋ
, 
$fame
);

123 
	g$out
 = 
$this
->
g_fe
();

124 
	g$
 = 
fݒ
(
$tozfame
, "w");

125 
fwre
(
$
, 
$out
, 

($out));

126 
fo
(
$
);

128  
	g$i
;

137 
funi
 
	$LiDFes
(
$dme
)

139 
$fes
 = 
	`y
();

140 if(
	`is_d
(
$dme
))

142 
$fh
 = 
	`ݒd
(
$dme
);

143 (
$fe
 = 
	`add
(
$fh
)!=
l
)

145 i(
	`rcmp
(
$fe
, '.')==0 || strcmp($file, '..')==0)

149 
$fh
 = 
$dme
 . '/' . 
$fe
;

150 i
	`is_d
(
$fh
) )

152 
$fes
 = 
	`y_mge
($fes, 
$this
->
	`LiDFes
(
$fh
));

156 
	`y_push
(
$fes
, 
$fh
);

159 
	`od
(
$fh
);

163 
$fes
 = 
l
;

165  
$fes
;

166 
	}
}

168 
funi
 
	$add_Fe
(
$da
, 
$me
, 
$com
 = 1)

170 
$me
 = 
	`r_a
('\\', '/', $name);

171 
$dtime
 = 
	`dechex
(
$this
->
	`DosTime
());

173 
$hexdtime
 = '\x' . 
$dtime
[6] . $dtime[7].'\x'.$dtime[4] . $dtime[5]

174 . '\x' . 
$dtime
[2] . $dtime[3].'\x'.$dtime[0].$dtime[1];

175 
	`ev
('$hexdtim"' . 
$hexdtime
 . '";');

176 if(
$com
)

177 
$
 = "\x50\x4b\x03\x04\x14\x00\x00\x00\x08\x00".
$hexdtime
;

180 
$
 = "\x50\x4b\x03\x04\x0a\x00\x00\x00\x00\x00".
$hexdtime
;

182 
$unc_n
 = 
	`
(
$da
); 
$c
 = 
	`c32
($data);

183 if(
$com
)

185 
$zda
 = 
	`gzcomess
(
$da
); 
$c_n
 = 
	`
($zdata);

186 
$zda
 = 
	`subr
(subr($zda, 0, 
	`
($zdata) - 4), 2);

190 
$zda
 = 
$da
;

192 
$c_n
=
	`
(
$zda
);

193 
$
 .
	`ck
('V', 
$c
).ck('V', 
$c_n
).ck('V', 
$unc_n
);

194 
$
 .
	`ck
('v', 
	`
(
$me
)).ck('v', 0).$me.
$zda
;

195 
$
 .
	`ck
('V', 
$c
).ck('V', 
$c_n
).ck('V', 
$unc_n
);

196 
$this
 -> 
dac
[] = 
$
;

197 
$w_offt
 = 
	`
(
	`imode
('', 
$this
->
dac
));

198 if(
$com
)

200 
$cdc
 = "\x50\x4b\x01\x02\x00\x00\x14\x00\x00\x00\x08\x00";

204 
$cdc
 = "\x50\x4b\x01\x02\x14\x00\x0a\x00\x00\x00\x00\x00";

206 
$cdc
 .
$hexdtime
.
	`ck
('V', 
$c
).ck('V', 
$c_n
).ck('V', 
$unc_n
);

207 
$cdc
 .
	`ck
('v', 
	`
(
$me
) ).pack('v', 0 ).pack('v', 0 );

208 
$cdc
 .
	`ck
('v', 0 ).pack('v', 0 ).pack('V', 32 );

209 
$cdc
 .
	`ck
('V', 
$this
 -> 
d_offt
 );

210 
$this
 -> 
d_offt
 = 
$w_offt
;

211 
$cdc
 .
$me
;

212 
$this
 -> 
_d
[] = 
$cdc
;

213  
ue
;

214 
	}
}

216 
funi
 
	$DosTime
()

218 
$timay
 = 
	`gde
();

219 i(
$timay
['year'] < 1980)

221 
$timay
['year'] = 1980; $timearray['mon'] = 1;

222 
$timay
['mday'] = 1; $timearray['hours'] = 0;

223 
$timay
['minutes'] = 0; $timearray['seconds'] = 0;

225  ((
$timay
['year'] - 1980) << 25) | ($timearray['mon'] << 21) | ($timearray['mday'] << 16) | ($timearray['hours'] << 11) |

226 (
$timay
['minutes'] << 5) | ($timearray['seconds'] >> 1);

227 
	}
}

231 
funi
 
	$ExaA
 ( 
$zn
, 
$to
)

233 if(
	`subr
(
$to
,-1)!="/")

235 
$to
 .= "/";

237 
$fes
 = 
$this
->
	`g_Li
(
$zn
);

238 
$
 = 
	`cou
(
$fes
);

239 if(
	`is_y
(
$fes
))

241 
$i
=0;$i<
$
;$i++)

243 if(
$fes
[
$i
]['folder']==1)

245 @
	`mkd
(
$to
.
$fes
[
$i
]['fame'],
$GLOBALS
['cfg_dir_purview']);

246 @
	`chmod
(
$to
.
$fes
[
$i
]['fame'],
$GLOBALS
['cfg_dir_purview']);

250 
$this
->
	`Exa
 (
$zn
,
$to
);

251 
	}
}

253 
funi
 
Exa
 ( 
$zn
, 
$to
, 
$dex
 = 
Aay
(-1) )

255 
$ok
 = 0; 
	g$z
 = @
fݒ
(
$zn
,'rb');

256 if(!
	g$z
)

260 
	g$cd
 = 
$this
->
RdCD
(
$z
,
$zn
);

261 
	g$pos_y
 = 
$cd
['offset'];

262 if(!
is_y
(
$dex
))

264 
	g$dex
 = 
y
(
$dex
);

266 
	g$i
=0; 
ist
(
$dex
[
$i
]);$i++)

268 if(
tv
(
$dex
[
$i
])!=$dex[$i]||$dex[$i]>
$cd
['entries'])

273 
	g$i
=0; $i<
	g$cd
['entries']; $i++)

275 @
fek
(
$z
, 
$pos_y
);

276 
	g$hd
 = 
$this
->
RdCFeHds
(
$z
);

277 
	g$hd
['dex'] = 
$i
; 
	g$pos_y
 = 
l
(
$z
);

278 @
wd
(
$z
); 
fek
($z, 
$hd
['offset']);

279 if(
_y
("-1",
$dex
)||_y(
$i
,$index))

281 
	g$
[
$hd
['fame']]=
$this
->
ExaFe
($hd, 
$to
, 
$z
);

285 
fo
(
$z
);

286  
	g$
;

289 
funi
 
	$RdFeHd
(
$z
)

291 
$by_da
 = 
	`d
(
$z
, 30);

292 
$da
 = 
	`uack
('vchk/vid/vvsi/vag/vcomessi/vmtime/vmde/Vc/Vcomesd_size/Vsize/vfame_n/vexa_n', 
$by_da
);

293 
$hd
['fame'] = 
	`d
(
$z
, 
$da
['filename_len']);

294 i(
$da
['extra_len'] != 0)

296 
$hd
['exa'] = 
	`d
(
$z
, 
$da
['extra_len']);

300 
$hd
['extra'] = '';

302 
$hd
['comessi'] = 
$da
['compression'];$header['size'] = $data['size'];

303 
$hd
['comesd_size'] = 
$da
['compressed_size'];

304 
$hd
['c'] = 
$da
['crc']; $header['flag'] = $data['flag'];

305 
$hd
['mde'] = 
$da
['mdate'];$header['mtime'] = $data['mtime'];

306 i(
$hd
['mdate'] && $header['mtime'])

308 
$hour
=(
$hd
['mtime']&0xF800)>>11;
$mu
=($header['mtime']&0x07E0)>>5;

309 
$cde
=(
$hd
['mtime']&0x001F)*2;
$yr
=(($header['mdate']&0xFE00)>>9)+1980;

310 
$mth
=(
$hd
['mde']&0x01E0)>>5;
$day
=$header['mdate']&0x001F;

311 
$hd
['mtime'] = 
	`mktime
(
$hour
, 
$mu
, 
$cde
, 
$mth
, 
$day
, 
$yr
);

315 
$hd
['mtime'] = 
	`time
();

317 
$hd
['stored_filename'] = $header['filename'];

318 
$hd
['status'] = "ok";

319  
$hd
;

320 
	}
}

322 
funi
 
	$RdCFeHds
(
$z
)

324 
$by_da
 = 
	`d
(
$z
, 46);

325 
$hd
 = 
	`uack
('vchkid/vid/vvsi/vvsi_exaed/vag/vcomessi/vmtime/vmde/Vc/Vcomesd_size/Vsize/vfame_n/vexa_n/vcommt_n/vdisk/v/Vex/Vofft', 
$by_da
);

326 i(
$hd
['filename_len'] != 0)

328 
$hd
['fame'] = 
	`d
(
$z
,$header['filename_len']);

332 
$hd
['filename'] = '';

334 i(
$hd
['extra_len'] != 0)

336 
$hd
['exa'] = 
	`d
(
$z
, $header['extra_len']);

340 
$hd
['extra'] = '';

342 i(
$hd
['comment_len'] != 0)

344 
$hd
['commt'] = 
	`d
(
$z
, $header['comment_len']);

348 
$hd
['comment'] = '';

350 i(
$hd
['mdate'] && $header['mtime'])

352 
$hour
 = (
$hd
['mtime'] & 0xF800) >> 11;

353 
$mu
 = (
$hd
['mtime'] & 0x07E0) >> 5;

354 
$cde
 = (
$hd
['mtime'] & 0x001F)*2;

355 
$yr
 = ((
$hd
['mdate'] & 0xFE00) >> 9) + 1980;

356 
$mth
 = (
$hd
['mdate'] & 0x01E0) >> 5;

357 
$day
 = 
$hd
['mdate'] & 0x001F;

358 
$hd
['mtime'] = 
	`mktime
(
$hour
, 
$mu
, 
$cde
, 
$mth
, 
$day
, 
$yr
);

362 
$hd
['mtime'] = 
	`time
();

364 
$hd
['stored_filename'] = $header['filename'];

365 
$hd
['status'] = 'ok';

366 i(
	`subr
(
$hd
['filename'], -1) == '/')

368 
$hd
['external'] = 0x41FF0010;

370  
$hd
;

371 
	}
}

373 
funi
 
	$RdCD
(
$z
,
$z_me
)

375 
$size
 = 
	`fesize
(
$z_me
);

376 i(
$size
 < 277)

378 
$maximum_size
 = 
$size
;

382 
$maximum_size
=277;

384 @
	`fek
(
$z
, 
$size
-
$maximum_size
);

385 
$pos
 = 
	`l
(
$z
); 
$bys
 = 0x00000000;

387 
$pos
 < 
$size
)

389 
$by
 = @
	`d
(
$z
, 1); 
$bys
=($by<< 8| 
	`Ord
($byte);

390 i(
$bys
 == 0x504b0506)

392 
$pos
++; ;

394 
$pos
++;

396 
$da
 = @
	`uack
('vdisk/vdisk_t/vdisk_s/vs/Vsize/Vofft/vcommt_size',
	`d
(
$z
, 18));

397 i(
$da
['comment_size'] != 0)

399 
$d
['commt'] = 
	`d
(
$z
, 
$da
['comment_size']);

403 
$d
['commt'] = ''; $d['s'] = 
$da
['entries'];

405 
$d
['disk_s'] = 
$da
['disk_entries'];

406 
$d
['offt'] = 
$da
['offset'];$centd['disk_start'] = $data['disk_start'];

407 
$d
['size'] = 
$da
['size']; $centd['disk'] = $data['disk'];

408  
$d
;

409 
	}
}

411 
funi
 
	$ExaFe
(
$hd
,
$to
,
$z
)

413 
$hd
 = 
$this
->
	`adfehd
(
$z
);

414 
$hd
['ex'] = (!
	`ist
($header['external']) ? 0 : $header['external']);

415 if(
	`subr
(
$to
,-1)!="/")

417 
$to
.="/";

419 if(!@
	`is_d
(
$to
))

421 @
	`mkd
(
$to
,
$GLOBALS
['cfg_dir_purview']);

423 i(!(
$hd
['external']==0x41FF0010)&&!($header['external']==16))

425 i(
$hd
['compression']==0)

427 
$
 = @
	`fݒ
(
$to
.
$hd
['filename'], 'wb');

428 if(!
$
)

432 
$size
 = 
$hd
['compressed_size'];

433 
$size
 != 0)

435 
$ad_size
 = (
$size
 < 2048 ? $size : 2048);

436 
$bufr
 = 
	`d
(
$z
, 
$ad_size
);

437 
$by_da
 = 
	`ck
('a'.
$ad_size
, 
$bufr
);

438 @
	`fwre
(
$
, 
$by_da
, 
$ad_size
);

439 
$size
 -
$ad_size
;

441 
	`fo
(
$
);

442 
	`touch
(
$to
.
$hd
['filename'], $header['mtime']);

446 
$
 = @
	`fݒ
(
$to
.
$hd
['filename'].'.gz','wb');

447 if(!
$
)

451 
$by_da
 = 
	`ck
('va1a1Va1a1', 0x8b1f, 
	`Chr
(
$hd
['compression']),

452 
	`Chr
(0x00), 
	`time
(), Chr(0x00), Chr(3));

453 
	`fwre
(
$
, 
$by_da
, 10);

454 
$size
 = 
$hd
['compressed_size'];

455 
$size
 != 0)

457 
$ad_size
 = (
$size
 < 1024 ? $size : 1024);

458 
$bufr
 = 
	`d
(
$z
, 
$ad_size
);

459 
$by_da
 = 
	`ck
('a'.
$ad_size
, 
$bufr
);

460 @
	`fwre
(
$
, 
$by_da
, 
$ad_size
);

461 
$size
 -
$ad_size
;

464 
$by_da
 = 
	`ck
('VV', 
$hd
['crc'], $header['size']);

465 
	`fwre
(
$
, 
$by_da
,8); 
	`fo
($fp);

466 
$gzp
 = @
	`gzݒ
(
$to
.
$hd
['fame'].'.gz','rb'

 
	`d
("Cetterchivest compress");

467 if(!
$gzp
)

471 
$
 = @
	`fݒ
(
$to
.
$hd
['filename'],'wb');

472 if(!
$
)

476 
$size
 = 
$hd
['size'];

477 
$size
 != 0)

479 
$ad_size
 = (
$size
 < 2048 ? $size : 2048);

480 
$bufr
 = 
	`gzad
(
$gzp
, 
$ad_size
);

481 
$by_da
 = 
	`ck
('a'.
$ad_size
, 
$bufr
);

482 @
	`fwre
(
$
, 
$by_da
, 
$ad_size
);

483 
$size
 -
$ad_size
;

485 
	`fo
(
$
); 
	`gzo
(
$gzp
);

486 
	`touch
(
$to
.
$hd
['filename'], $header['mtime']);

487 @
	`uƚk
(
$to
.
$hd
['filename'].'.gz');

490  
ue
;

491 
	}
}

	@index.php

1 <?
php


2 if(!
fe_exis
(
dme
(
__FILE__
).'/data/common.inc.php'))

4 
hd
('Location:install/index.php');

5 
ex
();

8 if(
ist
(
$_GET
['upcache']))

10 
que_
 (
dme
(
__FILE__
) . "/include/common.inc.php");

11 
que_
 
	gDEDEINC
."/arc.partview.class.php";

12 
	g$GLOBALS
['_arclistEnv'] = 'index';

13 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__homepageset`");

14 
	g$row
['m'] = 
MfTem
(
$row
['templet']);

15 
	g$pv
 = 
w
 
PtVw
();

16 
	g$pv
->
STem
(
$cfg_bad
 . 
$cfg_ms_d
 . "/" . 
$row
['templet']);

17 
	g$pv
->
SaveToHtml
(
dme
(
__FILE__
).'/index.html');

18 
ude
(
dme
(
__FILE__
).'/index.html');

19 
ex
();

23 
hd
('HTTP/1.1 301 Moved Permanently');

24 
hd
('Location:index.html');

	@install/common.inc.php

1 <?
php


3 
	g$cfg_dbho
 = '~dbhost~';

4 
	g$cfg_dbme
 = '~dbname~';

5 
	g$cfg_dbur
 = '~dbuser~';

6 
	g$cfg_dbpwd
 = '~dbpwd~';

7 
	g$cfg_dbefix
 = '~dbprefix~';

8 
	g$cfg_db_nguage
 = '~dblang~';

	@install/config.cache.inc.php

1 <?
php


2 
	g$cfg_baho
 = '~baseurl~';

3 
	g$cfg_cmh
 = '~basepath~';

4 
	g$cfg_cook_code
 = '~cookieEncode~';

5 
	g$cfg_dexu
 = '~indexurl~';

6 
	g$cfg_backup_d
 = 'backupdata';

7 
	g$cfg_dexme
 = '主页';

8 
	g$cfg_webme
 = '~webname~';

9 
	g$cfg_admema
 = '~adminmail~';

10 
	g$cfg_html_ed
 = 'fck';

11 
	g$cfg_cd
 = '/a';

12 
	g$cfg_meds_d
 = '/uploads';

13 
	g$cfg_ddimg_width
 = 240;

14 
	g$cfg_ddimg_height
 = 180;

15 
	g$cfg_imgty
 = 'jpg|gif|png';

16 
	g$cfg_soty
 = 'zip|gz|rar|iso|doc|xsl|ppt|wps';

17 
	g$cfg_medty
 = 'swf|mpg|mp3|rm|rmvb|wmv|wma|wav|mid|mov';

18 
	g$cfg_ee
 = 6;

19 
	g$cfg_li_symb
 = ' > ';

20 
	g$cfg_nٮlowr
 = '非典|艾滋病|阳痿';

21 
	g$cfg_ar
 = '她妈|它妈|他妈|你妈|去死|贱人';

22 
	g$cfg_edbackcheck
 = 'N';

23 
	g$cfg_keywd_a
 = 'Y';

24 
	g$cfg_fck_xhtml
 = 'N';

25 
	g$cfg_df_y
 = 'default';

26 
	g$cfg_mui_se
 = 'N';

27 
	g$cfg_dede_log
 = 'N';

28 
	g$cfg_powby
 = 'Copyright &copy; 2002-2009 DEDECMS. 织梦科技 版权所有';

29 
	g$cfg_ct
 = 'N';

30 
	g$cfg_uto
 = 'N';

31 
	g$cfg_uto_size
 = 5;

32 
	g$cfg_au_desti
 = 240;

33 
	g$cfg_p_ho
 = '';

34 
	g$cfg_p_pt
 = 21;

35 
	g$cfg_p_ur
 = '';

36 
	g$cfg_p_pwd
 = '';

37 
	g$cfg_p_ro
 = '/';

38 
	g$cfg_p_mkd
 = 'N';

39 
	g$cfg_edback_ck
 = 'Y';

40 
	g$cfg_li_s
 = 'Y';

41 
	g$cfg_mb_ݒ
 = 'Y';

42 
	g$cfg_mb_bum
 = 'Y';

43 
	g$cfg_mb_ud
 = 'Y';

44 
	g$cfg_mb_ud_size
 = 1024;

45 
	g$cfg_mb_ndl
 = 'Y';

46 
	g$cfg_mb_rmdown
 = 'Y';

47 
	g$cfg_i_time
 = 8;

48 
	g$cfg_mb_addty
 = 'swf|mpg|mp3|rm|rmvb|wmv|wma|wav|mid|mov|zip|rar|doc|xsl|ppt|wps';

49 
	g$cfg_mb_max
 = 500;

50 
	g$cfg_keywd_like
 = 'N';

51 
	g$cfg_dex_max
 = 10000;

52 
	g$cfg_dex_che
 = 86400;

53 
	g$cfg_lche
 = 'Y';

54 
	g$cfg_lche_d
 = '/data/tplcache';

55 
	g$cfg_makesign_che
 = 'N';

56 
	g$cfg_rm_me
 = 'Y';

57 
	g$cfg_c_dlk
 = 'N';

58 
	g$cfg_c_autic
 = 'Y';

59 
	g$cfg_c_autokeywd
 = 'Y';

60 
	g$cfg_t_maxn
 = 60;

61 
	g$cfg_bum_width
 = 800;

62 
	g$cfg_check_t
 = 'Y';

63 
	g$cfg_bum_row
 = 3;

64 
	g$cfg_bum_c
 = 4;

65 
	g$cfg_bum_gesize
 = 12;

66 
	g$cfg_bum_y
 = 2;

67 
	g$cfg_bum_ddwidth
 = 200;

68 
	g$cfg_mb_nٮlow
 = 'www,bbs,ftp,mail,user,users,admin,administrator';

69 
	g$cfg_mb_idm
 = 3;

70 
	g$cfg_mb_pwdm
 = 3;

71 
	g$cfg_mb_pwdty
 = '32';

72 
	g$cfg_md_idu
 = 'N';

73 
	g$cfg_mb_nk
 = 10;

74 
	g$cfg_edback_time
 = 30;

75 
	g$cfg_edback_num
 = 30;

76 
	g$cfg_md_ma
 = 'N';

77 
	g$cfg_mb_aa
 = 0;

78 
	g$cfg_vdcode_memb
 = 'Y';

79 
	g$cfg_mb_ckt
 = 'Y';

80 
	g$cfg_mb_edday
 = 7;

81 
	g$cfg_ii_sub
 = 2;

82 
	g$cfg_ii_add
 = 2;

83 
	g$cfg_edback_add
 = 5;

84 
	g$cfg_edback_sub
 = 5;

85 
	g$cfg_ch_max
 = 50000;

86 
	g$cfg_ch_maxrc
 = 300;

87 
	g$cfg_ch_time
 = 3;

88 
	g$cfg_baiduws_lim
 = '100';

89 
	g$cfg_updi
 = '15';

90 
	g$cfg_ndma_bysm
 = 'Y';

91 
	g$cfg_sm_rv
 = 'smtp.qq.com';

92 
	g$cfg_sm_pt
 = '25';

93 
	g$cfg_sm_urma
 = '';

94 
	g$cfg_sm_ur
 = '';

95 
	g$cfg_sm_sswd
 = '';

96 
	g$cfg_le_ty
 = 'nps';

97 
	g$cfg_ud_swch
 = 'Y';

98 
	g$cfg_lch_lim
 = '1';

99 
	g$cfg_wre
 = 'N';

100 
	g$cfg_de
 = 'Y';

101 
	g$cfg_keywds
 = '';

102 
	g$cfg_desti
 = '';

103 
	g$cfg_ben
 = '';

104 
	g$cfg_ed_tyid2
 = 'Y';

105 
	g$cfg_che_ty
 = 'id';

106 
	g$cfg_max_
 = 50;

107 
	g$cfg_tyd_df
 = 'Y';

108 
	g$cfg_makedex
 = 'N';

109 
	g$cfg_make_dt
 = 'N';

110 
	g$cfg_make_ext
 = 'Y';

111 
	g$cfg_edback_fbid
 = 'N';

112 
	g$cfg_jump_
 = 'Y';

113 
	g$cfg_sk_pwd
 = '';

114 
	g$cfg_add_domabd
 = 'N';

115 
	g$cfg_add_doma
 = '';

116 
	g$cfg_df_dutyadm
 = 'admin';

117 
	g$cfg_mb_lownrc
 = 'Y';

118 
	g$cfg_mb_lowg
 = 'Y';

119 
	g$cfg_mb_admlock
 = 'N';

120 
	g$cfg_ndc_sces
 = 10;

121 
	g$cfg_ndfb_sces
 = 3;

122 
	g$cfg_mb_arc
 = 0;

123 
	g$cfg__adds
 = 10;

124 
	g$cfg_mefo_adds
 = 20;

125 
	g$cfg_mey_sces
 = 50;

126 
	g$cfg_mb_wmee
 = 'N';

127 
	g$cfg_c_dme
 = 'Y';

128 
	g$cfg_pucche_time
 = 36000;

129 
	g$cfg_c_ick
 = -1;

130 
	g$cfg_add_vy
 = 'ymd';

131 
	g$cfg_qk_udl
 = 'Y';

132 
	g$cfg_log_adds
 = 2;

133 
	g$cfg_ud_adds
 = 10;

134 
	g$cfg_ddimg_fu
 = 'N';

135 
	g$cfg_ddimg_bgc
 = 0;

136 
	g$cfg_upic_cut
 = 'Y';

	@install/index.php

1 <?
	gphp


2 @
t_time_lim
(0);

4 
r_ptg
(
E_ALL
 || ~
E_NOTICE
);

6 
	g$vMsg
 = ' V5.5 UTF8';

7 
	g$s_ng
 = 'utf-8';

8 
	g$dfDbme
 = 'dedecmsv55utf8';

9 
	g$rmsg
 = '';

10 
	g$sLockfe
 = 
dme
(
__FILE__
).'/install_lock.txt';

11 
	g$moduCacheFe
 = 
dme
(
__FILE__
).'/modules.tmp.inc';

13 
defe
('DEDEINC',
dme
(
__FILE__
).'/../include');

14 
defe
('DEDEDATA',
dme
(
__FILE__
).'/../data');

15 
defe
('DEDEROOT',
eg_a
("[\\/]l",'',
dme
(
__FILE__
)));

16 
hd
("Content-Type:ext/html; charset={$s_lang}");

18 
que_
(
DEDEROOT
.'/install/install.inc.php');

20 
fܗch
(
Aay
('_GET','_POST','_COOKIE'
as
 
$_que
)

22 
fܗch
(
$$_que
 
as
 
$_k
 => 
$_v

$
{$_k} = 
RunMagicQues
($_v);

25 
que_
(
DEDEINC
.'/common.func.php');

27 if(
	$fe_exis
(
$sLockfe
))

29 
	`ex
(" 程序已运行安装，如果你确定要重新安装，请先从FTP中删除 install/install_lock.txt！");

30 
	}
}

32 if(
	$emy
(
$
))

34 
$
 = 1;

35 
	}
}

40 if(
	g$
==1)

42 
ude
('./templates/step-1.html');

43 
ex
();

49 if(
	g$
==2)

51 
$phpv
 = 
phpvsi
();

52 
	g$_os
 = @
gv
('OS');

53 
	g$_gd
 = 
gdvsi
();

54 
	g$_rv
 = 
$_SERVER
['SERVER_SOFTWARE'];

55 
	g$_ho
 = (
emy
(
$_SERVER
['REMOTE_ADDR']) ? $_SERVER['REMOTE_HOST'] : $_SERVER['REMOTE_ADDR']);

56 
	g$_me
 = 
$_SERVER
['SERVER_NAME'];

57 
	g$_max_executi_time
 = 
i_g
('max_execution_time');

58 
	g$_low_n
 = (
i_g
('allow_call_time_pass_reference') ? '<font color=green>[√]On</font>' : '<font color=red>[×]Off</font>');

59 
	g$_low_u_fݒ
 = (
i_g
('allow_url_fopen') ? '<font color=green>[√]On</font>' : '<font color=red>[×]Off</font>');

60 
	g$__mode
 = (
i_g
('safe_mode') ? '<font color=red>[×]On</font>' : '<font color=green>[√]Off</font>');

61 
	g$_gd
 = (
$_gd
>0 ? '<font color=green>[√]On</font>' : '<font color=red>[×]Off</font>');

62 
	g$_mysql
 = (
funi_exis
('mysql_connect') ? '<font color=green>[√]On</font>' : '<font color=red>[×]Off</font>');

64 if(
	g$_mysql
=='<font color=red>[×]Off</font>')

66 
$_mysql_r
 = 
ue
;

70 
	g$_mysql_r
 = 
l
;

73 
	g$_ds
 = 
y
(

84 
ude
('./templates/step-2.html');

85 
ex
();

91 if(
	g$
==3)

93 if(!
emy
(
$_SERVER
['REQUEST_URI']))

95 
$stName
 = 
$_SERVER
['REQUEST_URI'];

99 
	g$stName
 = 
$_SERVER
['PHP_SELF'];

102 
	g$bath
 = 
egi_a
('/l(.*)$','',
$stName
);

104 if(
emy
(
$_SERVER
['HTTP_HOST']))

106 
	g$bau
 = 'hp://'.
$_SERVER
['HTTP_HOST'];

110 
	g$bau
 = "hp://".
$_SERVER
['SERVER_NAME'];

113 
	g$d_cookEncode
 = 
chr
(
mt_nd
(
d
('A'),ord('Z'))).chr(mt_rand(ord('a'),ord('z'))).chr(mt_rand(ord('A'),ord('Z'))).chr(mt_rand(ord('A'),ord('Z'))).chr(mt_rand(ord('a'),ord('z'))).mt_rand(1000,9999).chr(mt_rand(ord('A'),ord('Z')));

115 
ude
('./templates/step-3.html');

116 
ex
();

122 if(
	g$
==4)

125 
$cn
 = 
mysql_c
(
$dbho
,
$dbur
,
$dbpwd


 
d
("<script>alert('数据库服务器或登录密码无效，\\n\\n无法连接数据库，请重新设定！');history.go(-1);</script>");

127 
mysql_quy
("CREATE DATABASE IF NOT EXISTS `".
$dbme
."`;",
$cn
);

129 
mysql__db
(
$dbme


 
d
("<script>alert('选择数据库失败，可能是你没权限，请预先创建一个数据库！');history.go(-1);</script>");

132 
	g$rs
 = 
mysql_quy
("SELECT VERSION();",
$cn
);

133 
	g$row
 = 
mysql_tch_y
(
$rs
);

134 
	g$mysqlVsis
 = 
exode
('.',
im
(
$row
[0]));

135 
	g$mysqlVsi
 = 
$mysqlVsis
[0].".".$mysqlVersions[1];

137 
mysql_quy
("SET NAMES '$dbng',cha_t_=by,sql_mode='';",
$cn
);

139 
	g$
 = 
fݒ
(
dme
(
__FILE__
)."/common.inc.php","r");

140 
	g$cfigS1
 = 
d
(
$
,
fesize
(
dme
(
__FILE__
)."/common.inc.php"));

141 
fo
(
$
);

143 
	g$
 = 
fݒ
(
dme
(
__FILE__
)."/config.cache.inc.php","r");

144 
	g$cfigS2
 = 
d
(
$
,
fesize
(
dme
(
__FILE__
)."/config.cache.inc.php"));

145 
fo
(
$
);

148 
	g$cfigS1
 = 
r_a
("~dbho~",
$dbho
,
$cfigS1
);

149 
	g$cfigS1
 = 
r_a
("~dbme~",
$dbme
,
$cfigS1
);

150 
	g$cfigS1
 = 
r_a
("~dbur~",
$dbur
,
$cfigS1
);

151 
	g$cfigS1
 = 
r_a
("~dbpwd~",
$dbpwd
,
$cfigS1
);

152 
	g$cfigS1
 = 
r_a
("~dbefix~",
$dbefix
,
$cfigS1
);

153 
	g$cfigS1
 = 
r_a
("~dbng~",
$dbng
,
$cfigS1
);

155 @
chmod
(
DEDEROOT
.'/data',0777);

156 
	g$
 = 
fݒ
(
DEDEROOT
."/da/comm.c.php","w"

 
d
("<script>alert('写入配置失败，请检查../data目录是否可写入！');history.go(-1);</script>");

157 
fwre
(
$
,
$cfigS1
);

158 
fo
(
$
);

161 
	g$cmh
 = 
im
(
eg_a
('/{1,}','/',
$cmh
));

162 if(
	g$cmh
!='' && !
eg
('^/',
$cmh
)) $cmspath = '/'.$cmspath;

164 if(
	g$cmh
==''
$dexU
 = '/';

165 
	g$dexU
 = 
$cmh
;

167 
	g$cfigS2
 = 
r_a
("~bau~",
$bau
,
$cfigS2
);

168 
	g$cfigS2
 = 
r_a
("~bath~",
$cmh
,
$cfigS2
);

169 
	g$cfigS2
 = 
r_a
("~dexu~",
$dexU
,
$cfigS2
);

170 
	g$cfigS2
 = 
r_a
("~cookEncode~",
$cookcode
,
$cfigS2
);

171 
	g$cfigS2
 = 
r_a
("~webme~",
$webme
,
$cfigS2
);

172 
	g$cfigS2
 = 
r_a
("~admma~",
$admma
,
$cfigS2
);

174 
	g$
 = 
fݒ
(
DEDEROOT
.'/data/config.cache.inc.php','w');

175 
fwre
(
$
,
$cfigS2
);

176 
fo
(
$
);

178 
	g$
 = 
fݒ
(
DEDEROOT
.'/data/config.cache.bak.php','w');

179 
fwre
(
$
,
$cfigS2
);

180 
fo
(
$
);

182 if(
	g$mysqlVsi
 >= 4.1)

184 
$sql4tmp
 = "ENGINE=MyISAM DEFAULT CHARSET=".
$dbng
;

189 
	g$quy
 = '';

190 
	g$
 = 
fݒ
(
dme
(
__FILE__
).'/sql-dftables.txt','r');

191 !
of
(
$
))

193 
	g$le
 = 
rim
(
fgs
(
$
,1024));

194 if(
eg
(";$",
$le
))

196 
	g$quy
 .
$le
."\n";

197 
	g$quy
 = 
r_a
('#@__',
$dbefix
,
$quy
);

198 if(
	g$mysqlVsi
 < 4.1)

200 
	g$rs
 = 
mysql_quy
(
$quy
,
$cn
);

204 if(
egi
('CREATE',
$quy
))

206 
	g$rs
 = 
mysql_quy
(
egi_a
('TYPE=MyISAM',
$sql4tmp
,
$quy
),
$cn
);

210 
	g$rs
 = 
mysql_quy
(
$quy
,
$cn
);

213 
	g$quy
='';

215 if(!
eg
("^(//|--)",
$le
))

217 
	g$quy
 .
$le
;

220 
fo
(
$
);

223 
	g$quy
 = '';

224 
	g$
 = 
fݒ
(
dme
(
__FILE__
).'/sql-dfdata.txt','r');

225 !
of
(
$
))

227 
	g$le
 = 
rim
(
fgs
(
$
,1024));

228 if(
eg
(";$",
$le
))

230 
	g$quy
 .
$le
;

231 
	g$quy
 = 
r_a
('#@__',
$dbefix
,
$quy
);

232 if(
	g$mysqlVsi
 < 4.1
	g$rs
 = 
mysql_quy
(
$quy
,
$cn
);

233 
	g$rs
 = 
mysql_quy
(
r_a
('#~ng~#',
$dbng
,
$quy
),
$cn
);

234 
	g$quy
='';

236 if(!
eg
("^(//|--)",
$le
))

238 
	g$quy
 .
$le
;

241 
fo
(
$
);

244 
	g$cquy
 = "Update `{$dbprefix}sysconfig` set value='{$baseurl}' where varname='cfg_basehost';";

245 
mysql_quy
(
$cquy
,
$cn
);

246 
	g$cquy
 = "Update `{$dbprefix}sysconfig` set value='{$cmspath}' where varname='cfg_cmspath';";

247 
mysql_quy
(
$cquy
,
$cn
);

248 
	g$cquy
 = "Update `{$dbprefix}sysconfig` set value='{$indexUrl}' where varname='cfg_indexurl';";

249 
mysql_quy
(
$cquy
,
$cn
);

250 
	g$cquy
 = "Update `{$dbprefix}sysconfig` set value='{$cookieencode}' where varname='cfg_cookie_encode';";

251 
mysql_quy
(
$cquy
,
$cn
);

252 
	g$cquy
 = "Update `{$dbprefix}sysconfig` set value='{$webname}' where varname='cfg_webname';";

253 
mysql_quy
(
$cquy
,
$cn
);

254 
	g$cquy
 = "Update `{$dbprefix}sysconfig` set value='{$adminmail}' where varname='cfg_adminemail';";

255 
mysql_quy
(
$cquy
,
$cn
);

259 
	g$admquy
 = "INSERT INTO `{$dbefix}adm` VALUES (1, 10, '$admur', '".
subr
(
md5
(
$admpwd
),5,20)."', 'adm', '', '', 0, '".
time
()."', '127.0.0.1');";

260 
mysql_quy
(
$admquy
,
$cn
);

263 
	g$admquy
 = "INSERT INTO `{$dbprefix}member` (`mid`,`mtype`,`userid`,`pwd`,`uname`,`sex`,`rank`,`money`,`email`,

264 `
sces
` ,`
	gmt
` ,`
	g
`,`
	gquei
`,`
	gsw
` ,`
	gjotime
` ,`
	gjo
` ,`
	glogtime
` ,`
	glog
` )

265 
VALUES
 ('1','个人','$adminuser','".md5($adminpwd)."','$adminuser','男','100','0','','10000','10','','0','','".time()."','','0',''); ";

266 
mysql_quy
(
$admquy
,
$cn
);

268 
	g$admquy
 = "INSERT INTO `{$dbprefix}member_person` (`mid`,`onlynet`,`sex`,`uname`,`qq`,`msn`,`tel`,`mobile`,`place`,`oldplace`,`birthday`,`star`,

269 `
come
` , `
	geduti
` , `
	gheight
` , `
	gbodyty
` , `
	gblood
` , `
	gvoti
` , `
	gsmoke
` , `
	gm
` , `
	ghou
` ,`
	gdrk
` , `
	gdgty
` , `
	gnguage
` , `
	gtu
` , `
	glovemsg
` , `
	gaddss
`,`
	guime
`)

270 
VALUES
 ('1', '1', '男', '{$adminuser}', '', '', '', '', '0', '0','1980-01-01', '1', '0', '0', '160', '0', '0', '0', '0', '0', '0','0', '0', '', '', '', '','0'); ";

271 
mysql_quy
(
$admquy
,
$cn
);

273 
	g$admquy
 = "INSERT INTO `{$dbprefix}member_tj` (`mid`,`article`,`album`,`archives`,`homecount`,`pagecount`,`feedback`,`friend`,`stow`)

274 
VALUES
 ('1','0','0','0','0','0','0','0','0'); ";

275 
mysql_quy
(
$admquy
,
$cn
);

277 
	g$admquy
 = "Insert Into `{$dbprefix}member_space`(`mid` ,`pagesize` ,`matt` ,`spacename` ,`spacelogo` ,`spacestyle`, `sign` ,`spacenews`)

278 
Vues
('1','10','0','{$adminuser}的空间','','person','',''); ";

279 
mysql_quy
(
$admquy
,
$cn
);

281 
mysql_o
(
$cn
);

284 if(!
ist
(
$modus
|| !
is_y
($modules))

287 
	g$
 = 
fݒ
(
$sLockfe
,'w');

288 
fwre
(
$
,'ok');

289 
fo
(
$
);

290 
ude
('./templates/step-5.html');

291 
ex
();

295 
	g$modu
 = 
jo
(',',
$modus
);

296 
	g$
 = 
fݒ
(
$moduCacheFe
,'w');

297 
fwre
(
$
,'<'.'?php'."\r\n");

298 
fwre
(
$
,'$lModu = "'.
$modu
.'"; '."\r\n");

299 
fwre
(
$
,'?'.'>');

301 if(!
	g$
)

304 
	g$
 = 
fݒ
(
$sLockfe
,'w');

305 
fwre
(
$
,'ok');

306 
fo
(
$
);

307 
	g$rmsg
 = "<font color='red'>由于无法写入模块缓存，安装可选模块失败，请登录后在模块管理处安装。</font>";

308 
ude
('./templates/step-5.html');

309 
ex
();

311 
fo
(
$
);

312 
ude
('./templates/step-4.html');

313 
ex
();

315 
ex
();

321 if(
	g$
==5)

323 
hd
("location:module-install.php");

324 
ex
();

330 if(
	g$
==10)

332 
hd
("Pragma:no-cache\r\n");

333 
hd
("Cache-Control:no-cache\r\n");

334 
hd
("Expires:0\r\n");

335 
	g$cn
 = @
mysql_c
(
$dbho
,
$dbur
,
$dbpwd
);

336 if(
	g$cn
)

338 
	g$rs
 = 
mysql__db
(
$dbme
,
$cn
);

339 if(!
	g$rs
)

341 
	g$rs
 = 
mysql_quy
(" CREATE DATABASE `$dbme`; ",
$cn
);

342 if(
	g$rs
)

344 
mysql_quy
(" DROP DATABASE `$dbme`; ",
$cn
);

345 
	gecho
 "<font color='green'>信息正确</font>";

349 
	gecho
 "<font color='red'>数据库不存在，也没权限创建新的数据库！</font>";

354 
	gecho
 "<font color='green'>信息正确</font>";

359 
	gecho
 "<font color='red'>数据库连接失败！</font>";

361 @
mysql_o
(
$cn
);

362 
ex
();

	@install/install.inc.php

1 <?
php


2 
funi
 
	$RunMagicQues
(&
$r
)

4 if(!
	`g_magic_ques_gpc
()) {

5 if
	`is_y
(
$r
) )

6 
	`fܗch
(
$r
 
as
 
$key
 => 
$v
$r[$key] = 
	`RunMagicQues
($val);

8 
$r
 = 
	`addashes
($str);

10  
$r
;

11 
	}
}

13 
funi
 
	$gdvsi
()

16 if(!
	`funi_exis
('phpinfo'))

18 if(
	`funi_exis
('imagecreate'))  '2.0';

23 
	`ob_t
();

24 
	`phpfo
(8);

25 
$modu_fo
 = 
	`ob_g_cڋs
();

26 
	`ob_d_n
();

27 if(
	`eg_mch
("/\bgd\s+vsi\b[^\d\n\r]+?([\d\.]+)/i", 
$modu_fo
,
$mches
){ 
$gdvsi_h
 = $matches[1]; }

28 { 
$gdvsi_h
 = 0; }

29  
$gdvsi_h
;

31 
	}
}

33 
funi
 
	$GBackA˹
(
$msg
,
$is
=0)

35 
glob
 
$s_ng
;

36 
$msg
 = 
	`r_a
('"','`',$msg);

37 if(
$is
==1
$msg
 = "<script>\r\n<!--\r\nlert(\"{$msg}\");\r\n-->\r\n</script>\r\n";

38 
$msg
 = "<script>\r\n<!--\r\nlert(\"{$msg}\");history.go(-1);\r\n-->\r\n</script>\r\n";

39 
$msg
 = "<meta http-equiv=content-type content='text/html; charset={$s_lang}'>\r\n".$msg;

40  
$msg
;

41 
	}
}

44 
funi
 
	$TeWre
(
$d
)

46 
$tfe
 = '_dedet.txt';

47 
$d
 = 
	`eg_a
('/$','',$d);

48 
$
 = @
	`fݒ
(
$d
.'/'.
$tfe
,'w');

49 if(!
$
 
l
;

52 
	`fo
(
$
);

53 
$rs
 = @
	`uƚk
(
$d
.'/'.
$tfe
);

54 if(
$rs
 
ue
;

55  
l
;

57 
	}
}

59 
funi
 
	$ReWreCfigAuto
()

61 
glob
 
$dsql
;

62 
$cfigfe
 = 
DEDEROOT
.'/data/config.cache.inc.php';

63 if(!
	`is_wrb
(
$cfigfe
))

65 
echo
 "配置文件'{$configfile}'不支持写入，无法修改系统配置参数！";

67 
	`ex
();

69 
$
 = 
	`fݒ
(
$cfigfe
,'w');

70 
	`ock
(
$
,3);

71 
	`fwre
(
$
,"<"."?php\r\n");

72 
$dsql
->
	`SQuy
("Select `varname`,`type`,`value`,`groupid` From `#@__sysconfig` order byidsc ");

73 
$dsql
->
	`Execu
();

74 
$row
 = 
$dsql
->
	`GAay
())

76 if(
$row
['ty']=='numb'
	`fwre
(
$
,"\${$row['varname']} = ".$row['value'].";\r\n");

77 
	`fwre
(
$
,"\${$row['vme']} = '".
	`r_a
("'",'',
$row
['value'])."';\r\n");

79 
	`fwre
(
$
,"?".">");

80 
	`fo
(
$
);

81 
	}
}

84 
funi
 
	$UpDeCCache
()

86 
glob
 
$dsql
,
$cfg_mui_se
;

87 
$che1
 = 
DEDEDATA
."/cache/inc_catalog_base.inc";

88 
$dsql
->
	`SQuy
("Select id,reid,channeltype,issend From `#@__arctype`");

89 
$dsql
->
	`Execu
();

90 
$1
 = 
	`fݒ
(
$che1
,'w');

91 
$phph
 = '?';

92 
$1Hd
 = "<{$phph}php\r\nglobal \$_Cs;\r\n\$_Cs=array();\r\n";

93 
	`fwre
(
$1
,
$1Hd
);

94 
$row
=
$dsql
->
	`GObje
())

96 
	`fwre
(
$1
,"\$_Cs[{$row->id}]=array({$row->reid},{$row->channeltype},{$row->issend});\r\n");

98 
	`fwre
(
$1
,"{$phph}>");

99 
	`fo
(
$1
);

100 
	}
}

	@install/module-install.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 @
t_time_lim
(0);

5 
	g$vMsg
 = ' V5.5 UTF8';

6 
	g$rmsg
 = '';

7 
	g$sLockfe
 = 
dme
(
__FILE__
).'/install_lock.txt';

8 
	g$moduCacheFe
 = 
dme
(
__FILE__
).'/modules.tmp.inc';

9 
	g$moduD
 = 
DEDEROOT
.'/data/module';

10 
	g$AdmBaD
 = 
DEDEROOT
.'/dede/';

12 if(
	$fe_exis
(
$sLockfe
))

14 
	`ex
(" 程序已运行安装，如果你确定要重新安装，请先从FTP中删除 install/install_lock.txt！");

15 
	}
}

17 
que_
(
DEDEINC
.'/dedemodule.class.php');

18 
que_
(
dme
(
__FILE__
).'/modulescache.php');

19 
que_
(
dme
(
__FILE__
).'/install.inc.php');

21 if(
emy
(
$
)
	g$
 = 0;

24 if(
	g$
==9999)

26 
$
 = 
fݒ
(
$sLockfe
,'w');

27 
fwre
(
$
,'ok');

28 
fo
(
$
);

29 
ReWreCfigAuto
();

30 
UpDeCCache
();

31 @
uƚk
('./modules.tmp.inc');

32 
ude
('./templates/step-5.html');

33 
ex
();

37 if(!
	$fe_exis
(
$moduCacheFe
))

39 
$msg
 = "<font color='red'>由于无法找到模块缓存文件，安装可选模块失败，请登录后在模块管理处安装。</font><br /><br />";

40 
$msg
 .= "<a href='module-install.php?step=9999'arget='_top'>点击此完成安装 &gt;&gt;</a>";

41 
	`ShowMsg
(
$msg
,'javascript:;');

42 
	`ex
();

43 
	}
}

46 if(!
	$TeWre
(
$moduD
))

48 
$msg
 = "<font color='red'>目录 {$moduleDir} 不支持写入，不能安装模块，请登录后在模块管理处安装。</font><br /><br />";

49 
$msg
 .= "<a href='module-install.php?step=9999'arget='_top'>点击此完成安装 &gt;&gt;</a>";

50 
	`ShowMsg
(
$msg
,"javascript:;");

51 
	`ex
();

52 
	}
}

54 
ude
(
$moduCacheFe
);

55 
	g$modus
 = 
l
(',',
$lModu
);

56 
	g$tٮMod
 = 
cou
(
$modus
);

57 if(
	g$
 >
$tٮMod
)

59 
$msg
 = "<font color='red'>完成所有模块的安装！</font><br /><br />";

60 
	g$msg
 .= "<a href='module-install.php?step=9999'arget='_top'>点击此进行下一步操作 &gt;&gt;</a>";

61 
ShowMsg
(
$msg
,'javascript:;');

62 
ex
();

64 
	g$moduHash
 = 
$modus
[
$
];

65 
	g$moduFe
 = 
$lmodus
[
$moduHash
];

67 
	g$dm
 = 
w
 
DedeModu
(
$moduD
);

69 
	g$mfos
 = 
$dm
->
GModuInfo
(
$moduHash
);

70 
exa
(
$mfos
, 
EXTR_SKIP
);

71 
	g$murg
 = 
addashes
(
$dm
->
GSyemFe
(
$moduHash
,'menustring'));

73 
	g$quy
 = "INSERT INTO `#@__sys_module`(`hashcode` , `modname` , `indexname` , `indexurl` , `ismember` , `menustring` )

74 
VALUES
 ('$moduleHash' , '$name' , '$indexname' , '$indexurl' , '$ismember' , '$menustring' ) ";

76 
	g$rs
 = 
$dsql
->
ExecuNeQuy
("Delete From `#@__sys_module` where hashcodeike '$moduleHash' ");

77 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

79 if(!
	g$rs
)

81 
	g$msg
 = "<font color='red'>保存数据库信息失败，无法完成你选择的模块安装！</font><br /><br />";

82 
	g$msg
 .= "<a href='module-install.php?step=9999'arget='_top'>点击此进行下一步操作 &gt;&gt;</a>";

83 
ex
();

87 
	g$dm
->
WreFes
(
$moduHash
,1);

88 
	g$dm
->
WreSyemFe
(
$moduHash
,'readme');

90 
	g$tupsql
 = 
$dm
->
GSyemFe
(
$moduHash
,'setupsql40');

93 
	g$mysql_vsi
 = 
$dsql
->
GVsi
(
ue
);

94 
	g$tupsql
 = 
egi_a
('ENGINE=MyISAM','TYPE=MyISAM',
$tupsql
);

95 
	g$sql41tmp
 = 'ENGINE=MyISAM DEFAULT CHARSET='.
$cfg_db_nguage
;

97 if(
	g$mysql_vsi
 >= 4.1) {

98 
$tupsql
 = 
egi_a
('TYPE=MyISAM',
$sql41tmp
,$setupsql);

102 if(
	g$cfg_cmh
=='/'
$cfg_cmh
 = '';

104 
	g$rou
 = 
$cfg_baho
.
$cfg_cmh
;

105 
	g$tupsql
 = 
egi_a
('_ROOTURL_',
$rou
,
$tupsql
);

106 
	g$tupsql
 = 
eg_a
("[\r\n]{1,}","\n",
$tupsql
);

107 
	g$sqls
 = 
l
(";[ \t]{0,}\n", 
$tupsql
);

109 
	$fܗch
(
$sqls
 
as
 
$sql
) {

110 if(
	`im
(
$sql
)!=''
$dsql
->
	`execunequy
($sql);

111 
	}
}

113 
	g$dm
->
Cˬ
();

115 
	g$
 = 
$
 + 1;

116 
ShowMsg
("模块 {$name} 安装完成，准备下一模块安装...", "module-install.php?step={$step}");

117 
ex
();

	@install/modulescache.php

1 <?
php


2 
glob
 
	g$lmodus
;

3 
	g$GLOBALS
['allmodules']['0a7bea5dbe571d35def883cbec796437']='0a7bea5dbe571d35def883cbec796437.xml';

4 
	g$GLOBALS
['allmodules']['0cce60bc0238aa03804682c801584991']='0cce60bc0238aa03804682c801584991.xml';

5 
	g$GLOBALS
['allmodules']['1f35620fb42d452fa2bdc1dee1690f92']='1f35620fb42d452fa2bdc1dee1690f92.xml';

6 
	g$GLOBALS
['allmodules']['572606600345b1a4bb8c810bbae434cc']='572606600345b1a4bb8c810bbae434cc.xml';

7 
	g$GLOBALS
['allmodules']['59155be87ea60c5c65ec1f7a46a0fc9d']='59155be87ea60c5c65ec1f7a46a0fc9d.xml';

8 
	g$GLOBALS
['allmodules']['72ffa6fabe3c236f9238a2b281bc0f93']='72ffa6fabe3c236f9238a2b281bc0f93.xml';

9 
	g$GLOBALS
['allmodules']['7badb72a3ff79af2a7112beee60cb970']='7badb72a3ff79af2a7112beee60cb970.xml';

10 
	g$GLOBALS
['allmodules']['867af26e9c1ccf22a1cf67e756cf5acc']='867af26e9c1ccf22a1cf67e756cf5acc.xml';

11 
	g$GLOBALS
['allmodules']['8964eda9013d1df0afea08ed63243436']='8964eda9013d1df0afea08ed63243436.xml';

12 
	g$GLOBALS
['allmodules']['acb8b88eb4a6d4bfc375c18534f9439e']='acb8b88eb4a6d4bfc375c18534f9439e.xml';

13 
	g$GLOBALS
['allmodules']['b437d85a7a7bc778c9c79b5ec36ab9aa']='b437d85a7a7bc778c9c79b5ec36ab9aa.xml';

14 
	g$GLOBALS
['allmodules']['be722dbfa3cb3cb5628aab2d767ff62e']='be722dbfa3cb3cb5628aab2d767ff62e.xml';

15 
	g$GLOBALS
['allmodules']['bea7dee377430430cc03219c827a4fb8']='bea7dee377430430cc03219c827a4fb8.xml';

16 
	g$GLOBALS
['allmodules']['dfcb5cd4d7bc0e3f7eb655e62dd6bc64']='dfcb5cd4d7bc0e3f7eb655e62dd6bc64.xml';

	@member/ajax_feedback.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
AjaxHd
();

4 if(
	g$myu
 == '')

6 
ex
('');

10 
	g$uid
 = 
$cfg_ml
->
M_LogID
;

11 
	g$
 = 
$cfg_ml
->
flds
[''] ='' ? 
$GLOBALS
['cfg_memberurl'].'/images/nopic.gif' : $cfg_ml->fields['face'];

12 
	gecho
 "用户名：{$cfg_ml->M_UserName} <inputame=\"notuser\"ype=\"checkbox\" id=\"notuser\" value=\"1\" />匿名评论\r\n";

13 if(
	g$cfg_edback_ck
=='Y')

15 
echo
 "验证码：<inputame=\"validate\"ype=\"text\" id=\"validate\" size=\"10\" style=\"height:18px;width:60px;margin-right:6px;\" class=\"nb\" />";

16 
	gecho
 "<img src='{$cfg_cmsurl}/include/vdimgck.php' style='cursor:pointer' id='validateimg' onclick=\"this.src=this.src+'?'\"itle='点击我更换图片'lt='点击我更换图片' />\r\n";

	@member/ajax_loginsta.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
AjaxHd
();

4 if(
	g$myu
 == '')

6 
ex
('');

8 
	g$uid
 = 
$cfg_ml
->
M_LogID
;

9 
	g$
 = 
$cfg_ml
->
flds
[''] ='' ? 
$GLOBALS
['cfg_memberurl'].'/images/nopic.gif' : $cfg_ml->fields['face'];

11 <
div
 
	gass
="userinfo">

12 <
div
 
ass
="wcome">你好：<
rg
><?
php
 
echo
 
$cfg_ml
->
M_UrName
; ?></
	grg
>，欢迎登录 </
	gdiv
>

13 <
div
 
	gass
="userface">

14 <
a
 
hf
="<?phech$cfg_membu; ?>/dex.php"><
img
 
c
="<?phech$;?>" 
width
="52" 
height
="52" /></a>

15 </
div
>

16 <
div
 
ass
="mylink">

17 <
ul
>

18 <
li
><
a
 
hf
="<?phpcho $cfg_memberurl; ?>/guestbook_admin.php">我的留言</a></li>

19 <
li
><
a
 
hf
="<?phpcho $cfg_memberurl; ?>/mystow.php">我的收藏</a></li>

20 <
li
><
a
 
hf
="<?phpcho $cfg_memberurl; ?>/article_add.php">发表文章</a></li>

21 <
li
><
a
 
hf
="<?phpcho $cfg_memberurl; ?>/myfriend.php">好友管理</a></li>

22 <
li
><
a
 
hf
="<?phpcho $cfg_memberurl; ?>/visit-history.php">访客记录</a></li>

23 <
li
><
a
 
hf
="<?phpcho $cfg_memberurl; ?>/search.php">查找好友</a></li>

24 </
ul
>

25 </
div
>

26 <
div
 
ass
="uclink">

27 <
a
 
hf
="<?phpcho $cfg_memberurl; ?>/index.php">会员中心</a> |

28 <
a
 
hf
="<?phpcho $cfg_memberurl; ?>/edit_fullinfo.php">资料</a> |

29 <
a
 
hf
="<?phpcho $myurl;?>">空间</a> |

30 <
a
 
hf
="<?phpcho $cfg_memberurl; ?>/index_do.php?fmdo=login&dopost=exit">退出登录</a>

31 </
div
>

32 </
div
><!-- /
urfo
 -->

	@member/album_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

5 
CheckRk
(0,0);

6 if(
	g$cfg_mb_l
=='Y')

8 
ShowMsg
("由于系统开启了精简版会员空间，你访问的功能不可用！","-1");

9 
ex
();

11 if(
	g$cfg_mb_bum
=='N')

13 
ShowMsg
("对不起，由于系统关闭了图集功能，你访问的功能不可用！","-1");

14 
ex
();

16 
que_
(
DEDEINC
."/dedetag.class.php");

17 
que_
(
DEDEINC
."/customfields.func.php");

18 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

19 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

20 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 2;

21 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

22 if(
	$emy
(
$fmhtml
))

24 
$fmhtml
 = 0;

25 
	}
}

30 if(
	$emy
(
$do
))

32 
$quy
 = "Select * From `#@__channeltype` where id='$channelid'; ";

33 
$cInfos
 = 
$dsql
->
	`GO
(
$quy
);

34 if(!
	`is_y
(
$cInfos
))

36 
	`ShowMsg
('模型参数不正确', '-1');

37 
	`ex
();

41 if(
$cInfos
['ndnk'] > 
$cfg_ml
->
M_Rk
)

43 
$row
 = 
$dsql
->
	`GO
("Se membmFrom `#@__k` whnk='".
$cInfos
['sendrank']."' ");

44 
	`ShowMsg
("对不起，需要[".
$row
['membername']."]才能在这个频道发布文档！","-1","0",5000);

45 
	`ex
();

47 if(
$cInfos
['uy']!='' && $cInfos['uy'] !
$cfg_ml
->
M_MbTy
)

49 
	`ShowMsg
("对不起，需要[".
$cInfos
['usertype']."帐号]才能在这个频道发布文档！","-1","0",5000);

50 
	`ex
();

52 
	`ude
(
DEDEMEMBER
."/templets/album_add.htm");

53 
	`ex
();

54 
	}
}

59 if(
	g$do
=='save')

61 
$maxwidth
 = 
ist
($maxwidth&& 
is_numic
($maxwidth) ? $maxwidth : 800;

62 
	g$gium
 = 
ist
(
$gium
&& 
is_numic
($pagepicnum) ? $pagepicnum : 12;

63 
	g$ddmaxwidth
 = 
ist
(
$ddmaxwidth
&& 
is_numic
($ddmaxwidth) ? $ddmaxwidth : 200;

64 
	g$ow
 = 
ist
(
$ow
&& 
is_numic
($prow) ? $prow : 3;

65 
	g$pc
 = 
ist
(
$pc
&& 
is_numic
($pcol) ? $pcol : 3;

66 
	g$gey
 = 
_y
(
$gey
,
y
('1','2','3')) ? $pagestyle : 2;

67 
ude
(
DEDEMEMBER
.'/inc/archives_check.php');

68 
	g$imgus
 = "{dede:pagestyle maxwidth='$maxwidth'agepicnum='$pagepicnum' ddmaxwidth='$ddmaxwidth'ow='$prow' col='$pcol' value='$pagestyle'/}\r\n";

69 
	g$hase
 = 
l
;

70 
	g$ddisf
=1;

73 if(
	g$fmhtml
==1)

75 
$imagebody
 = 
rashes
($imagebody);

76 
	g$imgus
 .
GCurCڋAlbum
(
$imagebody
,
$cysour
,
$lpiame
);

77 if(
	g$ddisf
==1 && 
$lpic
=='' && !
emy
(
$lpiame
))

79 
$lpic
 = 
$lpiame
;

80 
	g$hase
 = 
ue
;

83 
	g$fo
 = '';

86 
	g$i
=1;$i<=120;$i++)

89 if(
ist
(
$_FILES
['imgfe'.
$i
]['tmp_me']&& 
is_uded_fe
($_FILES['imgfile'.$i]['tmp_name']) )

91 
	g$ifo
 = 
r_a
("'","`",
rashes
(
$
{'imgmsg'.
$i
}));

92 if(!
is_uded_fe
(
$_FILES
['imgfe'.
$i
]['tmp_name']))

98 
	g$r
 = 
Aay
("image/pjpeg","image/jpeg","image/gif","image/png","image/xpng","image/wbmp");

99 if(!
_y
(
$_FILES
['imgfe'.
$i
]['ty'],
$r
))

103 
	g$fame
 = 
MembUds
('imgfe'.
$i
,'',
$cfg_ml
->
M_ID
,'image','',0,0,
l
);

104 if(
	g$fame
!='')

106 
SaveUdInfo
(
$t
,
$fame
,1);

110 if(
	g$gey
 > 2)

112 
	g$lpiame
 = 
GImageMDD
(
$fame
,
$ddmaxwidth
);

113 if(
	g$lpiame
 != '')

115 
SaveUdInfo
(
$t
.' 小图',
$lpiame
,1);

120 
	g$lpiame
 = 
$fame
;

122 
	g$imgfe
 = 
$cfg_bad
.
$fame
;

123 if(
is_fe
(
$imgfe
))

125 
	g$iu
 = 
$fame
;

126 
	g$fo
 = '';

127 
	g$imgfos
 = @
gimagesize
(
$imgfe
,
$fo
);

128 
	g$imgus
 ."{dede:img ddimg='$lpiame'ext='$ifo' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

131 if(!
	g$hase
 && 
	g$lpic
=='' && !
emy
(
$lpiame
))

133 
$lpic
 = 
$lpiame
;

134 
	g$hase
 = 
ue
;

138 
	g$imgus
 = 
addashes
(
$imgus
);

141 
	g$im
 = 1;

142 if(!
ist
(
$fmhtml
))

144 
	g$fmhtml
 = 0;

146 
	g$add_f
 = 
$add_v
 = '';

147 if(!
emy
(
$dede_addflds
))

149 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

150 
	g$add_f
 = '';

151 
	g$add_v
 = '';

152 if(
is_y
(
$addflds
))

154 
fܗch
(
$addflds
 
as
 
$v
)

156 if(
	g$v
=='')

160 
	g$vs
 = 
exode
(',',
$v
);

161 if(!
ist
(
$
{
$vs
[0]}))

163 
	g$
{
	g$vs
[0]} = '';

165 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],0);

166 
	g$add_f
 .','.
$vs
[0];

167 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

173 if(
	g$lpic
!='')

175 
$ag
 = 'p';

179 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$mid
);

180 if(
emy
(
$cID
))

182 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

183 
ex
();

187 
	g$Quy
 = "INSERT INTO `#@__archives`(id,typeid,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

188 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gdesti
,
	gkeywds
,
	gmty
)

189 
VALUES
 ('$arcID','$typeid','$sortrank','$flag','$ismake','$channelid','$arcrank','0','$money','$title','$shorttitle',

191 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

193 
	g$gr
 = 
$dsql
->
GE
();

194 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID' ");

195 
ShowMsg
("把数据保存到数据库主表 `#@__archives` 时出错，请联系管理员。","javascript:;");

196 
ex
();

200 
	g$addb
 = 
im
(
$cInfos
['addtable']);

201 if(
emy
(
$addb
))

203 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

204 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

205 
ShowMsg
("没找到当前模型[{$channelid}]的主表信息，无法完成操作！。","javascript:;");

206 
ex
();

210 
	g$quy
 = "INSERT INTO `$addtable`(aid,typeid,userip,redirecturl,templet,pagestyle,maxwidth,imgurls,row,col,isrm,ddmaxwidth,pagepicnum{$inadd_f})

211 
Vues
('$cID','$tyid','$ur','','','$gey','$maxwidth','$imgus','$ow','$pc','$im','$ddmaxwidth','$gium'{
$add_v
}); ";

212 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

214 
	g$gr
 = 
$dsql
->
GE
();

215 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

216 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

217 
ShowMsg
("把数据保存到数据库附加表 `{$addb}` 时出错，请联系管理员！".
$gr
,"javascript:;");

218 
ex
();

223 
	g$dsql
->
ExecuNeQuy
("Upd`#@__memb` s sces=sces+{$cfg_ndc_sces} whmid='".
$cfg_ml
->
M_ID
."' ; ");

225 
couArchives
(
$chlid
);

228 
InTags
(
$gs
,
$cID
);

229 
	g$tU
 = 
MakeA
(
$cID
,
ue
);

230 if(
	g$tU
=='')

232 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

236 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/api/uc.func.php')

239 
	g$ed
['icon'] = 'thread';

240 
	g$ed
['title_template'] = '<b>{username} 在网站发布了一篇图集</b>';

241 
	g$ed
['t_da'] = 
y
('uame' => 
$cfg_ml
->
M_UrName
);

242 
	g$ed
['body_template'] = '<b>{subject}</b><br>{message}';

243 
	g$u
 = !
rr
(
$tU
,'hp://'? (
	g$cfg_baho
.
	g$tU
) : $artUrl;

244 
	g$ed
['body_da'] = 
y
('subje' => "<hf=\"".
$u
."\">$t</a>", 'mesge' => 
_subr
(
r_gs
(
eg_a
("/\[.+?\]/is", '', 
$desti
)), 150));

245 
	g$ed
['images'][] = 
y
('u' => 
$cfg_baho
.'/images/scores.gif', 'link'=> $cfg_basehost);

246 
uc_ed_ne
(
$cfg_ml
->
M_LogID
,
$ed
);

248 
	g$row
 = 
$dsql
->
GO
("SELECT `sces`,`urid` FROM `#@__memb` WHERE `mid`='".
$cfg_ml
->
M_ID
."' AND `matt`<>10");

249 
uc_ed_ne
(
$row
['urid'], 
$cfg_ndc_sces
);

251 #/
a
}}

254 
	g$msg
 = "

256 <
a
 
hf
='bum_add.php?cid=$tyid'><
u
>继续发布图集</u></a>

257 &
nb
;&
	gnb
;

258 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看图集</u></a>

259 &
nb
;&
	gnb
;

260 <
a
 
	ghf
='bum_ed.php?aid=".$cID."&chlid=$chlid'><
u
>更改图集</u></a>

261 &
nb
;&
	gnb
;

262 <
a
 
	ghf
='cڋ_li.php?chlid={$chlid}'><
u
>已发布图集管理</u></a>

264 
$wt
 = "成功发布图集！";

265 
	g$wecome_fo
 = "图集管理::发布图集";

266 
	g$w
 = 
w
 
OxWdow
();

267 
	g$w
->
AddT
("成功发布图集：");

268 
	g$w
->
AddMsgIm
(
$msg
);

269 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

270 
	g$w
->
Diy
();

	@member/album_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(
	g$cfg_mb_l
=='Y')

6 
ShowMsg
("由于系统开启了精简版会员空间，你访问的功能不可用！","-1");

7 
ex
();

9 if(
	g$cfg_mb_bum
=='N')

11 
ShowMsg
("对不起，由于系统关闭了图集功能，你访问的功能不可用！","-1");

12 
ex
();

14 
que_
(
DEDEINC
."/dedetag.class.php");

15 
que_
(
DEDEINC
."/customfields.func.php");

16 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

17 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

18 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 2;

19 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

20 if(
	$emy
(
$fmhtml
))

22 
$fmhtml
 = 0;

23 
	}
}

28 if(
	$emy
(
$do
))

31 
$cQuy
 = "Selectrc.*,ch.addtable,ch.fieldset,ch.arcsta

32 
From
 `#@
__chives
` 
c
 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
rc.
chl


33 
whe
 
c
.
id
='$aid' 
And
rc.
mid
='".$cfg_ml->M_ID."'; ";

34 
$row
 = 
$dsql
->
	`GO
(
$cQuy
);

35 if(!
	`is_y
(
$row
))

37 
	`ShowMsg
("读取文档信息出错!","-1");

38 
	`ex
();

40 if(
$row
['arcrank']>=0)

42 
$dtime
 = 
	`time
();

43 
$maxtime
 = 
$cfg_mb_edday
 * 24 *3600;

44 if(
$dtime
 - 
$row
['ndde'] > 
$maxtime
)

46 
	`ShowMsg
("这篇文档已经锁定，你不能再修改它！","-1");

47 
	`ex
();

50 
$addRow
 = 
$dsql
->
	`GO
("Select * From `{$row['addtable']}` whereid='$aid'; ");

51 
$d
 = 
w
 
	`DedeTagP
();

52 
$d
->
	`LdSour
(
$addRow
['imgurls']);

53 
$abfo
 = 
$d
->
	`GTagByName
('pagestyle');

54 
	`ude
(
DEDEMEMBER
."/templets/album_edit.htm");

55 
	`ex
();

56 
	}
}

61 if(
	g$do
=='save')

63 
$maxwidth
 = 
ist
($maxwidth&& 
is_numic
($maxwidth) ? $maxwidth : 800;

64 
	g$gium
 = 
ist
(
$gium
&& 
is_numic
($pagepicnum) ? $pagepicnum : 12;

65 
	g$ddmaxwidth
 = 
ist
(
$ddmaxwidth
&& 
is_numic
($ddmaxwidth) ? $ddmaxwidth : 200;

66 
	g$ow
 = 
ist
(
$ow
&& 
is_numic
($prow) ? $prow : 3;

67 
	g$pc
 = 
ist
(
$pc
&& 
is_numic
($pcol) ? $pcol : 3;

68 
	g$gey
 = 
_y
(
$gey
,
y
('1','2','3')) ? $pagestyle : 2;

70 
ude
(
DEDEMEMBER
.'/inc/archives_check_edit.php');

71 
	g$imgus
 = "{dede:pagestyle maxwidth='$maxwidth'agepicnum='$pagepicnum'

72 
ddmaxwidth
='$ddmaxwidth' 
row
='$ow' 
c
='$pc' 
vue
='$gey'/}\
	gr
\
	gn
";

73 
	g$hase
 = 
l
;

74 
	g$ddisf
=1;

77 if(
	g$fmhtml
==1)

79 
$imagebody
 = 
rashes
($imagebody);

80 
	g$imgus
 .
GCurCڋAlbum
(
$imagebody
,
$cysour
,
$lpiame
);

81 if(
	g$ddisf
==1 && 
$lpic
=='' && !
emy
(
$lpiame
))

83 
$lpic
 = 
$lpiame
;

84 
	g$hase
 = 
ue
;

87 
	g$fo
 = '';

90 
	g$i
=1;$i<=120;$i++)

94 if(
ist
(
$
{'imgu'.
$i
}|| (ist(
$_FILES
['imgfe'.$i]['tmp_me']&& 
is_uded_fe
($_FILES['imgfile'.$i]['tmp_name'])))

96 
	g$ifo
 = 
r_a
("'","`",
rashes
(
$
{'imgmsg'.
$i
}));

97 if(!
is_uded_fe
(
$_FILES
['imgfe'.
$i
]['tmp_name']))

99 
	g$iu
 = 
rashes
(
$
{'imgu'.
$i
});

102 if(
ist
(
$
{'imgu'.
$i
}))

104 
	g$lpiame
 = 
$iu
;

105 
	g$fame
 = 
$iu
;

108 if(
	g$gey
 > 2)

110 
	g$lpiame
 = 
GImageMDD
(
$fame
,
$ddmaxwidth
);

111 if(
	g$lpiame
 != '')

113 
SaveUdInfo
(
$t
.' 小图',
$lpiame
,1);

124 
	g$r
 = 
Aay
("image/pjpeg","image/jpeg","image/gif","image/png","image/xpng","image/wbmp");

125 if(!
_y
(
$_FILES
['imgfe'.
$i
]['ty'],
$r
))

129 if(
ist
(
$
{'imgu'.
$i
}))

131 
	g$fame
 = 
$
{'imgu'.
$i
};

135 
	g$fame
 = '';

137 
	g$fame
 = 
MembUds
('imgfe'.
$i
,
$fame
,
$cfg_ml
->
M_ID
,'image','',0,0,
l
);

138 if(
	g$fame
!='')

140 
SaveUdInfo
(
$t
,
$fame
,1);

142 
	g$lpiame
 = 
$fame
;

145 if(
	g$gey
 > 2)

147 
	g$lpiame
 = 
GImageMDD
(
$fame
,
$ddmaxwidth
);

148 if(
	g$lpiame
 != '')

150 
SaveUdInfo
(
$t
.' 小图',
$lpiame
,1);

154 
	g$imgfe
 = 
$cfg_bad
.
$fame
;

155 if(
is_fe
(
$imgfe
))

157 
	g$iu
 = 
$fame
;

158 
	g$fo
 = '';

159 
	g$imgfos
 = @
gimagesize
(
$imgfe
,
$fo
);

160 
	g$imgus
 ."{dede:img ddimg='$lpiame'ext='$ifo' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

162 if(!
	g$hase
 && 
	g$lpic
=='' && !
emy
(
$lpiame
))

164 
$lpic
 = 
$lpiame
;

165 
	g$hase
 = 
ue
;

169 
	g$imgus
 = 
addashes
(
$imgus
);

172 
	g$add_f
 = '';

173 if(!
	$emy
(
$dede_addflds
))

175 
$addflds
 = 
	`exode
(';',
$dede_addflds
);

176 if(
	`is_y
(
$addflds
))

178 
	`fܗch
(
$addflds
 
as
 
$v
)

180 if(
$v
=='')

184 
$vs
 = 
	`exode
(',',
$v
);

185 if(!
	`ist
(
$
{
$vs
[0]}))

187 
$
{
$vs
[0]} = '';

189 
$
{
$vs
[0]} = 
	`GFldVueA
(${$vs[0]},$vs[1],
$aid
);

190 
$add_f
 .','.
$vs
[0]." ='".
$
{$vs[0]}."' ";

193 
	}
}

196 if(
	g$lpic
!='')

198 
$ag
 = 'p';

203 
	g$upQuy
 = "Update `#@__archives` set

204 
ismake
='$ismake',

205 
	gk
='$arcrank',

206 
	gtyid
='$typeid',

207 
	gt
='$title',

208 
	glpic
='$litpic',

209 
	gdesti
='$description',

210 
	gkeywds
='$keywords',

211 
	gmty
='$mtypesid',

212 
	gag
='$flag'

213 
whe
 
id
='$aid' 
And
 
mid
='$mid'; ";

214 if(!
	g$dsql
->
	$ExecuNeQuy
(
$upQuy
))

216 
	`ShowMsg
("把数据保存到数据库主表时出错，请联系管理员！".
$dsql
->
	`GE
(),"-1");

217 
	`ex
();

218 
	}
}

220 
	g$im
 = 0;

222 if(
	g$addb
!='')

224 
$quy
 = "Update `$addtable`

225 
t
 
tyid
='$typeid',

226 
	ggey
='$pagestyle',

227 
	gmaxwidth
 = '$maxwidth',

228 
	gddmaxwidth
 = '$ddmaxwidth',

229 
	ggium
 = '$pagepicnum',

230 
	gimgus
='$imgurls',

231 
	grow
='$prow',

232 
	gc
='$pcol',

233 
	gur
='$userip',

234 
	gim
='$im'{
$add_f
}

235 
whe
 
aid
='$aid'; ";

236 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

238 
ShowMsg
("更新附加表 `$addb` 时出错，请联系管理员！".
$dsql
->
GE
(),"javascript:;");

239 
ex
();

243 
UpIndexKey
(
$aid
,
$k
,
$tyid
,
$s܌k
,
$gs
);

244 
	g$tU
 = 
MakeA
(
$aid
,
ue
);

245 if(
	g$tU
=='')

247 
$tU
 = 
$cfg_phpu
."/view.php?aid=$aid";

253 
	g$msg
 = "　　请选择你的后续操作：

254 <
a
 
hf
='bum_add.php?cid=$tyid'><
u
>发布新图集</u></a>

255 &
nb
;&
	gnb
;

256 <
a
 
	ghf
='chives_do.php?chlid=$chlid&aid=".$aid."&dod'><
u
>查看更改</u></a>

257 &
nb
;&
	gnb
;

258 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看图集</u></a>

259 &
nb
;&
	gnb
;

260 <
a
 
	ghf
='cڋ_li.php?chlid=$chlid'><
u
>管理图集</u></a> ";

262 
$wt
 = "成功更改图集！";

263 
	g$wecome_fo
 = "图集管理::更改图集";

264 
	g$w
 = 
w
 
OxWdow
();

265 
	g$w
->
AddT
("成功更改图集：");

266 
	g$w
->
AddMsgIm
(
$msg
);

267 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

268 
	g$w
->
Diy
();

	@member/archives_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/dedetag.class.php");

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

6 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

7 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 1;

8 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

9 
	g$mtysid
 = 
ist
(
$mtysid
&& 
is_numic
($mtypesid) ? $mtypesid : 0;

14 if(
	$emy
(
$do
))

16 
$cInfos
 = 
$dsql
->
	`GO
("Select * From `#@__channeltype` where id='$channelid'; ");

17 if(!
	`is_y
(
$cInfos
))

19 
	`ShowMsg
('模型不存在', '-1');

20 
	`ex
();

24 if(
$cInfos
['sendrank']>0 || $cInfos['usertype']!='')

26 
	`CheckRk
(0,0);

30 if(
$cInfos
['ndnk'] > 
$cfg_ml
->
M_Rk
)

32 
$row
 = 
$dsql
->
	`GO
("Se membmFrom `#@__k` whnk='".
$cInfos
['sendrank']."' ");

33 
	`ShowMsg
("对不起，需要[".
$row
['membername']."]才能在这个频道发布文档！","-1","0",5000);

34 
	`ex
();

36 if(
$cInfos
['uy']!='' && $cInfos['uy'] !
$cfg_ml
->
M_MbTy
)

38 
	`ShowMsg
("对不起，需要[".
$cInfos
['usertype']."帐号]才能在这个频道发布文档！","-1","0",5000);

39 
	`ex
();

41 
	`ude
(
DEDEMEMBER
."/templets/archives_add.htm");

42 
	`ex
();

43 
	}
}

47 if(
	g$do
=='save')

49 
ude
(
dme
(
__FILE__
).'/inc/archives_check.php');

52 
	g$add_f
 = 
$add_v
 = '';

53 if(!
emy
(
$dede_addflds
))

55 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

56 
	g$add_f
 = '';

57 
	g$add_v
 = '';

58 if(
is_y
(
$addflds
))

60 
fܗch
(
$addflds
 
as
 
$v
)

62 if(
	g$v
=='')

66 
	g$vs
 = 
exode
(',',
$v
);

67 if(!
ist
(
$
{
$vs
[0]}))

69 
	g$
{
	g$vs
[0]} = '';

73 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

75 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,$vs[1]);

78 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],0);

80 
	g$add_f
 .','.
$vs
[0];

81 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

87 if(
	g$lpic
!=''
$ag
 = 'p';

90 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$mid
);

91 if(
emy
(
$cID
))

93 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

94 
ex
();

98 
	g$Quy
 = "INSERT INTO `#@__archives`(id,typeid,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

99 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gdesti
,
	gkeywds
,
	gmty
)

100 
VALUES
 ('$arcID','$typeid','$sortrank','$flag','$ismake','$channelid','$arcrank','0','$money','$title','$shorttitle',

102 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

104 
	g$gr
 = 
$dsql
->
GE
();

105 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID' ");

106 
ShowMsg
("把数据保存到数据库主表 `#@__archives` 时出错，请联系管理员。","javascript:;");

107 
ex
();

111 
	g$addb
 = 
im
(
$cInfos
['addtable']);

112 if(
emy
(
$addb
))

114 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

115 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

116 
ShowMsg
("没找到当前模型[{$channelid}]的主表信息，无法完成操作。","javascript:;");

117 
ex
();

121 
	g$quy
 = "INSERT INTO `{$addtable}`(aid,typeid,userip,redirecturl,templet{$inadd_f}) Values('$arcID','$typeid','$userip','',''{$inadd_v})";

122 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

124 
	g$gr
 = 
$dsql
->
GE
();

125 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

126 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

127 
ShowMsg
("把数据保存到数据库附加表 `{$addtable}` 时出错<br>error:{$gerr}，请联系管理员！","javascript:;");

128 
ex
();

133 
	g$dsql
->
ExecuNeQuy
("Upd`#@__memb` s sces=sces+{$cfg_ndc_sces} whmid='".
$cfg_ml
->
M_ID
."' ; ");

135 
couArchives
(
$chlid
);

138 
InTags
(
$gs
,
$cID
);

139 
	g$tU
 = 
MakeA
(
$cID
,
ue
);

140 if(
	g$tU
=='')

142 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

146 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/api/uc.func.php')

149 
	g$ed
['icon'] = 'thread';

150 
	g$ed
['title_template'] = '<b>{username} 在网站发布了一篇内容</b>';

151 
	g$ed
['t_da'] = 
y
('uame' => 
$cfg_ml
->
M_UrName
);

152 
	g$ed
['body_template'] = '<b>{subject}</b><br>{message}';

153 
	g$u
 = !
rr
(
$tU
,'hp://'? (
	g$cfg_baho
.
	g$tU
) : $artUrl;

154 
	g$ed
['body_da'] = 
y
('subje' => "<hf=\"".
$u
."\">$t</a>", 'mesge' => 
_subr
(
r_gs
(
eg_a
("/\[.+?\]/is", '', 
$desti
)), 150));

155 
	g$ed
['images'][] = 
y
('u' => 
$cfg_baho
.'/images/scores.gif', 'link'=> $cfg_basehost);

156 
uc_ed_ne
(
$cfg_ml
->
M_LogID
,
$ed
);

158 
	g$row
 = 
$dsql
->
GO
("SELECT `sces`,`urid` FROM `#@__memb` WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

159 
uc_ed_ne
(
$row
['urid'],
$cfg_ndc_sces
);

161 #/
a
}}

164 
	g$msg
 = "

166 <
a
 
hf
='chives_add.php?cid=$tyid&chlid=$chlid'><
u
>继续发布内容</u></a>

167 &
nb
;&
	gnb
;

168 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看内容</u></a>

169 &
nb
;&
	gnb
;

170 <
a
 
	ghf
='chives_ed.php?chlid=$chlid&aid=$cID'><
u
>更改内容</u></a>

171 &
nb
;&
	gnb
;

172 <
a
 
	ghf
='cڋ_li.php?chlid={$chlid}'><
u
>已发布内容管理</u></a>

174 
$wt
 = "成功发布内容！";

175 
	g$wecome_fo
 = "内容管理::发布内容";

176 
	g$w
 = 
w
 
OxWdow
();

177 
	g$w
->
AddT
("成功发布内容：");

178 
	g$w
->
AddMsgIm
(
$msg
);

179 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

180 
	g$w
->
Diy
();

	@member/archives_do.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
	$emy
(
$do
))

5 
$do
 = '';

6 
	}
}

7 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

8 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 1;

14 if(
	g$do
=="delStow")

16 
CheckRk
(0,0);

17 
	g$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? "mystow.php" : $_COOKIE['ENV_GOBACK_URL'];

18 
	g$dsql
->
ExecuNeQuy
("DFrom #@__memb_ow whaid='$aid' And mid='".
$cfg_ml
->
M_ID
."'; ");

20 
	g$row
 = 
$dsql
->
GO
("SELECT COUNT(*ASumFROM `#@__memb_ow` WHERE `mid`='".
$cfg_ml
->
M_ID
."' ");

21 
	g$dsql
->
ExecuNeQuy
("UPDATE #@__memb_tj SET `ow`='$row[nums]' WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

23 
ShowMsg
("成功删除一条收藏记录！",
$ENV_GOBACK_URL
);

24 
ex
();

31 if(
	g$do
=="addArc")

33 if(
$chlid
==1)

35 
$addc
 = 'tie_add.php?chlid='.
$chlid
;

37 if(
	g$chlid
==2)

39 
$addc
 = 'bum_add.php?chlid='.
$chlid
;

41 if(
	g$chlid
==3)

43 
$addc
 = 'so_add.php?chlid='.
$chlid
;

47 
	g$row
 = 
$dsql
->
GO
("Select useraddcon From `#@__channeltype` where id='$channelid' ");

48 if(!
is_y
(
$row
))

50 
ShowMsg
("模型参数错误!","-1");

51 
ex
();

53 
	g$addc
 = 
$row
['useraddcon'];

54 if(
im
(
$addc
)=='')

56 
$addc
 = 'archives_add.php';

58 
	g$addc
 = 
$addc
."?channelid=$channelid";

60 
hd
("Location:$addcon");

61 
ex
();

68 if(
	g$do
=="edit")

70 
CheckRk
(0,0);

71 if(
	g$chlid
==1)

73 
$ed
 = 'tie_ed.php?chlid='.
$chlid
;

75 if(
	g$chlid
==2)

77 
$ed
 = 'bum_ed.php?chlid='.
$chlid
;

79 if(
	g$chlid
==3)

81 
$ed
 = 'so_ed.php?chlid='.
$chlid
;

85 
	g$row
 = 
$dsql
->
GO
("Select usereditcon From `#@__channeltype` where id='$channelid' ");

86 if(!
is_y
(
$row
))

88 
ShowMsg
("参数错误!","-1");

89 
ex
();

91 
	g$ed
 = 
$row
['usereditcon'];

92 if(
im
(
$ed
)=='')

94 
$ed
 = 'archives_edit.php';

96 
	g$ed
 = 
$ed
."?channelid=$channelid";

98 
hd
("Location:$edit"."&aid=$aid");

99 
ex
();

106 if(
	g$do
=="delArc")

108 
CheckRk
(0,0);

109 
ude_
(
DEDEMEMBER
."/inc/inc_batchup.php");

110 
	g$ENV_GOBACK_URL
 = 
emy
(
$_COOKIE
['ENV_GOBACK_URL']) ? 'content_list.php?channelid=' : $_COOKIE['ENV_GOBACK_URL'];

113 
	g$equy
 = "Selectrc.channel,arc.senddate,arc.arcrank,ch.maintable,ch.addtable,ch.issystem,ch.arcsta From `#@__arctiny`rc

114 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl
 
whe
rc.id='$aid' ";

116 
$row
 = 
$dsql
->
GO
(
$equy
);

117 if(!
is_y
(
$row
))

119 
ShowMsg
("你没有权限删除这篇文档！","-1");

120 
ex
();

122 if(
im
(
$row
['maintable'])=='') $row['maintable'] = '#@__archives';

123 if(
	g$row
['issystem']==-1)

125 
$equy
 = "Se mid from `{$row['addb']}` whaid='$aid' And mid='".
$cfg_ml
->
M_ID
."' ";

129 
	g$equy
 = "Se mid,lpiom `{$row['mab']}` whid='$aid' And mid='".
$cfg_ml
->
M_ID
."' ";

131 
	g$r
 = 
$dsql
->
GO
(
$equy
);

132 if(!
is_y
(
$r
))

134 
ShowMsg
("你没有权限删除这篇文档！","-1");

135 
ex
();

138 if(
	g$row
['arcrank']>=0)

140 
$dtime
 = 
time
();

141 
	g$maxtime
 = 
$cfg_mb_edday
 * 24 *3600;

142 if(
	g$dtime
 - 
	g$row
['ndde'] > 
	g$maxtime
)

144 
ShowMsg
("这篇文档已经锁定，你不能再删除它！","-1");

145 
ex
();

149 
	g$chlid
 = 
$row
['channel'];

150 
	g$row
['lpic'] = (
ist
(
$r
['litpic']) ? $arr['litpic'] : '');

153 if(
	g$row
['issyem']!=-1
$rs
 = 
DArc
(
$aid
);

154 
	g$rs
 = 
DArcSg
(
$aid
);

157 if(
im
(
$row
['lpic'])!='' && 
eg
("^".
$cfg_ur_d
."/{$cfg_ml->M_ID}",$row['litpic']))

159 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__uploads` where urlike '{$row['litpic']}' And mid='{$cfg_ml->M_ID}' ");

160 @
uƚk
(
$cfg_bad
.
$row
['litpic']);

163 if(
	g$ENV_GOBACK_URL
=='content_list.php?channelid=')

165 
$ENV_GOBACK_URL
 = $ENV_GOBACK_URL.
$chlid
;

167 if(
	g$rs
)

170 
couArchives
(
$chlid
);

172 
	g$dsql
->
ExecuNeQuy
("Upd`#@__memb` s sces=sces-{$cfg_ndc_sces} whmid='".
$cfg_ml
->
M_ID
."' And (scores-{$cfg_sendarc_scores}) > 0; ");

173 
ShowMsg
("成功删除一篇文档！",
$ENV_GOBACK_URL
);

174 
ex
();

178 
ShowMsg
("删除文档失败！",
$ENV_GOBACK_URL
);

179 
ex
();

181 
ex
();

188 if(
	g$do
=="viewArchives")

190 
CheckRk
(0,0);

191 
hd
("loti:".
$cfg_phpu
."/vw.php?aid=".
$aid
);

198 if(
	g$do
=="delUploads")

200 
CheckRk
(0,0);

201 if(
emy
(
$ids
))

203 
	g$ids
 = '';

206 
	g$tj
 = 0;

207 if(
	g$ids
=='')

209 
$ow
 = 
$dsql
->
GO
("Select url,mid From `#@__uploads` whereid='$aid'; ");

210 if(
is_y
(
$ow
&& 
	g$ow
['mid']==
$cfg_ml
->
M_ID
)

212 
$dsql
->
ExecuNeQuy
("Delete From `#@__uploads` whereid='$aid'; ");

213 if(
fe_exis
(
$cfg_bad
.
$ow
['url']))

215 @
uƚk
(
$cfg_bad
.
$ow
['url']);

218 
	g$tj
++;

222 
	g$ids
 = 
exode
(',',
$ids
);

223 
fܗch
(
$ids
 
as
 
$aid
)

225 
	g$aid
 = 
eg_a
("[^0-9]","",
$aid
);

226 
	g$ow
 = 
$dsql
->
GO
("Select url,mid From #@__uploads whereid='$aid'; ");

227 if(
is_y
(
$ow
&& 
	g$ow
['mid']==
$cfg_ml
->
M_ID
)

229 
$dsql
->
ExecuNeQuy
("Delete From `#@__uploads` whereid='$aid'; ");

230 
	g$tj
++;

231 if(
fe_exis
(
$cfg_bad
.
$ow
['url']))

233 @
uƚk
(
$cfg_bad
.
$ow
['url']);

238 
ShowMsg
("成功删除 $tj 个附件！",
$ENV_GOBACK_URL
);

239 
ex
();

	@member/archives_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 
que_
(
DEDEINC
."/customfields.func.php");

6 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

7 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

8 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 1;

9 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

10 
	g$mtysid
 = 
ist
(
$mtysid
&& 
is_numic
($mtypesid) ? $mtypesid : 0;

15 if(
	$emy
(
$do
))

18 
$cQuy
 = "Selectrc.*,ch.addtable,ch.fieldset,arc.mtypes mtypeid,ch.arcsta

19 
From
 `#@
__chives
` 
c
 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
rc.
chl


20 
whe
 
c
.
id
='$aid' 
And
rc.
mid
='".$cfg_ml->M_ID."'; ";

21 
$row
 = 
$dsql
->
	`GO
(
$cQuy
);

22 if(!
	`is_y
(
$row
))

24 
	`ShowMsg
("读取文档信息出错!","-1");

25 
	`ex
();

27 if(
$row
['arcrank']>=0)

29 
$dtime
 = 
	`time
();

30 
$maxtime
 = 
$cfg_mb_edday
 * 24 *3600;

31 if(
$dtime
 - 
$row
['ndde'] > 
$maxtime
)

33 
	`ShowMsg
("这篇文档已经锁定，你不能再修改它！","-1");

34 
	`ex
();

37 
$addRow
 = 
$dsql
->
	`GO
("Select * From `{$row['addtable']}` whereid='$aid'; ");

38 
$cInfos
 = 
$dsql
->
	`GO
("Select * From `#@__channeltype` where id='{$row['channel']}'; ");

39 
	`ude
(
DEDEMEMBER
."/templets/archives_edit.htm");

40 
	`ex
();

41 
	}
}

46 if(
	g$do
=='save')

48 
ude
(
DEDEMEMBER
.'/inc/archives_check_edit.php');

51 
	g$add_f
 = '';

52 if(!
emy
(
$dede_addflds
))

54 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

55 if(
is_y
(
$addflds
))

57 
fܗch
(
$addflds
 
as
 
$v
)

59 if(
	g$v
=='')

63 
	g$vs
 = 
exode
(',',
$v
);

64 if(!
ist
(
$
{
$vs
[0]}))

66 
	g$
{
	g$vs
[0]} = '';

70 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

72 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,$vs[1]);

75 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$aid
);

77 
	g$add_f
 .','.
$vs
[0]." ='".
$
{$vs[0]}."' ";

83 if(
	g$lpic
!='')

85 
$ag
 = 'p';

89 
	g$upQuy
 = "Update `#@__archives` set

90 
ismake
='$ismake',

91 
	gk
='$arcrank',

92 
	gtyid
='$typeid',

93 
	gt
='$title',

94 
	glpic
='$litpic',

95 
	gdesti
='$description',

96 
	gkeywds
='$keywords',

97 
	gmty
 = '$mtypesid',

98 
	gag
='$flag'

99 
whe
 
id
='$aid' 
And
 
mid
='$mid'; ";

100 if(!
	g$dsql
->
ExecuNeQuy
(
$upQuy
))

102 
ShowMsg
("把数据保存到数据库主表时出错，请联系管理员！".
$dsql
->
GE
(),"-1");

103 
ex
();

106 if(
	g$addb
!='')

108 
$upQuy
 = "Update `$addtable` setypeid='$typeid'{$inadd_f}, userip='$userip' whereid='$aid' ";

109 if(!
	g$dsql
->
ExecuNeQuy
(
$upQuy
))

111 
ShowMsg
("更新附加表 `$addtable` 时出错，请联系管理员！","javascript:;");

112 
ex
();

115 
UpIndexKey
(
$aid
,
$k
,
$tyid
,
$s܌k
,
$gs
);

116 
	g$tU
 = 
MakeA
(
$aid
,
ue
);

117 if(
	g$tU
=='')

119 
$tU
 = 
$cfg_phpu
."/view.php?aid=$aid";

123 
	g$msg
 = "　　请选择你的后续操作：

124 <
a
 
hf
='chives_add.php?cid=$tyid&chlid=$chlid'><
u
>发布新内容</u></a>

125 &
nb
;&
	gnb
;

126 <
a
 
	ghf
='chives_do.php?chlid=$chlid&aid=".$aid."&dod'><
u
>查看更改</u></a>

127 &
nb
;&
	gnb
;

128 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看内容</u></a>

129 &
nb
;&
	gnb
;

130 <
a
 
	ghf
='cڋ_li.php?chlid=$chlid'><
u
>管理内容</u></a>

132 
$wt
 = "成功更改内容！";

133 
	g$wecome_fo
 = "内容管理::更改内容";

134 
	g$w
 = 
w
 
OxWdow
();

135 
	g$w
->
AddT
("成功更改内容：");

136 
	g$w
->
AddMsgIm
(
$msg
);

137 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

138 
	g$w
->
Diy
();

	@member/archives_sg_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/dedetag.class.php");

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
dme
(
__FILE__
)."/inc/inc_catalog_options.php");

6 
que_
(
dme
(
__FILE__
)."/inc/inc_archives_functions.php");

7 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 1;

8 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

9 
	g$mtysid
 = 
ist
(
$mtysid
&& 
is_numic
($mtypesid) ? $mtypesid : 0;

14 if(
	$emy
(
$do
))

16 
$cInfos
 = 
$dsql
->
	`GO
("Select * From `#@__channeltype` where id='$channelid'; ");

17 if(!
	`is_y
(
$cInfos
))

19 
	`ShowMsg
('模型不存在', '-1');

20 
	`ex
();

24 if(
$cInfos
['sendrank']>0 || $cInfos['usertype']!='')

26 
	`CheckRk
(0,0);

30 if(
$cInfos
['ndnk'] > 
$cfg_ml
->
M_Rk
)

32 
$row
 = 
$dsql
->
	`GO
("Se membmFrom `#@__k` whnk='".
$cInfos
['sendrank']."' ");

33 
	`ShowMsg
("对不起，需要[".
$row
['membername']."]才能在这个频道发布文档！","-1","0",5000);

34 
	`ex
();

36 if(
$cInfos
['uy']!='' && $cInfos['uy'] !
$cfg_ml
->
M_MbTy
)

38 
	`ShowMsg
("对不起，需要[".
$cInfos
['usertype']."帐号]才能在这个频道发布文档！","-1","0",5000);

39 
	`ex
();

41 
	`ude
(
DEDEMEMBER
."/templets/archives_sg_add.htm");

42 
	`ex
();

43 
	}
}

47 if(
	g$do
=='save')

49 
ude_
(
DEDEINC
."/image.func.php");

50 
ude_
(
DEDEINC
."/oxwindow.class.php");

51 if(!
	g$cfg_ml
->
IsLog
(|| 
	g$cfg_vdcode_memb
=='Y')

53 
$svi
 = 
GCkVdVue
();

54 if(
ow
(
$vdcode
)!=
$svi
 || $svali=='')

56 
RetVdVue
();

57 
ShowMsg
("验证码错误！","-1");

58 
ex
();

62 
	g$ag
 = '';

63 
	g$autokey
 = 
$me
 = 
$dlk
 = 
$autޙpic
 = 0;

64 
	g$ur
 = 
GIP
();

66 if(
	g$tyid
==0)

68 
ShowMsg
('请指定文档隶属的栏目！','-1');

69 
ex
();

72 
	g$quy
 = "Selectp.ispart,tp.channeltype,tp.issend,ch.issends cissend,ch.sendrank,ch.arcsta,ch.addtable,ch.usertype

73 
From
 `#@
__y
` 

 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
p.
chy
 
whe
p.id='$typeid' ";

74 
$cInfos
 = 
$dsql
->
GO
(
$quy
);

77 if(
	g$cInfos
['isnd']!=1 || 
$cInfos
['it']!=0 || $cInfos['chy']!=
$chlid
 || $cInfos['cissend']!=1)

79 
ShowMsg
("你所选择的栏目不支持投稿！","-1");

80 
ex
();

84 if(
	g$cInfos
['ndnk'] > 
	g$cfg_ml
->
	gM_Rk
 )

86 
	g$row
 = 
$dsql
->
GO
("Se membmFrom #@__k whnk='".
$cInfos
['sendrank']."' ");

87 
ShowMsg
("对不起，需要[".
$row
['membername']."]才能在这个频道发布文档！","-1","0",5000);

88 
ex
();

91 if(
	g$cInfos
['uy'] !='' && 
$cInfos
['uy'] !
$cfg_ml
->
M_MbTy
)

93 
ShowMsg
("对不起，需要[".
$cInfos
['usertype']."]才能在这个频道发布文档！","-1","0",5000);

94 
ex
();

98 if(
	g$cInfos
['arcsta']==0)

100 
$k
 = 0;

102 if(
	g$cInfos
['arcsta']==1)

104 
$k
 = 0;

108 
	g$k
 = -1;

112 
	g$s܌k
 = 
$ndde
 = 
$pubde
 = 
time
();

113 
	g$t
 = 
_subrR
(
HtmlR
(
$t
,1),
$cfg_t_maxn
);

114 
	g$mid
 = 
$cfg_ml
->
M_ID
;

117 
	g$lpic
 = 
MembUds
('lpic','',
$cfg_ml
->
M_ID
,'image','',
$cfg_ddimg_width
,
$cfg_ddimg_height
,
l
);

118 if(
	g$lpic
!='')

120 
SaveUdInfo
(
$t
,
$lpic
,1);

124 
	g$add_f
 = 
$add_v
 = '';

125 if(!
emy
(
$dede_addflds
))

127 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

128 
	g$add_f
 = '';

129 
	g$add_v
 = '';

130 if(
is_y
(
$addflds
))

132 
fܗch
(
$addflds
 
as
 
$v
)

134 if(
	g$v
=='')

138 
	g$vs
 = 
exode
(',',
$v
);

139 if(!
ist
(
$
{
$vs
[0]}))

141 
	g$
{
	g$vs
[0]} = '';

145 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

147 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,$vs[1]);

150 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],0);

152 
	g$add_f
 .',`'.
$vs
[0].'`';

153 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

159 
	g$cID
 = 
GIndexKey
(0,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$mid
);

160 if(
emy
(
$cID
))

162 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

163 
ex
();

167 
	g$addb
 = 
im
(
$cInfos
['addtable']);

168 if(
emy
(
$addb
))

170 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

171 
ShowMsg
("没找到当前模型[{$channelid}]的主表信息，无法完成操作。","javascript:;");

172 
ex
();

176 
	g$quy
 = "INSERT INTO `{$addtable}`(aid,typeid,arcrank,mid,channel,title,senddate,litpic,userip{$inadd_f}) Values('$arcID','$typeid','$arcrank','$mid','$channelid','$title','$senddate','$litpic','$userip'{$inadd_v})";

177 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

179 
	g$gr
 = 
$dsql
->
GE
();

180 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

181 
ShowMsg
("把数据保存到数据库附加表 `{$addtable}` 时出错，请联系管理员！","javascript:;");

182 
ex
();

187 
	g$dsql
->
ExecuNeQuy
("Upd`#@__memb` s sces=sces+{$cfg_ndc_sces} whmid='".
$cfg_ml
->
M_ID
."' ; ");

190 
	g$tU
 = 
MakeA
(
$cID
,
ue
);

191 if(
	g$tU
=='')

193 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

197 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/api/uc.func.php')

200 
	g$ed
['icon'] = 'thread';

201 
	g$ed
['title_template'] = '<b>{username} 在网站发布了一篇内容</b>';

202 
	g$ed
['t_da'] = 
y
('uame' => 
$cfg_ml
->
M_UrName
);

203 
	g$ed
['body_template'] = '<b>{subject}</b><br>{message}';

204 
	g$u
 = !
rr
(
$tU
,'hp://'? (
	g$cfg_baho
.
	g$tU
) : $artUrl;

205 
	g$ed
['body_da'] = 
y
('subje' => "<hf=\"".
$u
."\">$t</a>", 'mesge' => 
_subr
(
r_gs
(
eg_a
("/\[.+?\]/is", '', 
$desti
)), 150));

206 
	g$ed
['images'][] = 
y
('u' => 
$cfg_baho
.'/images/scores.gif', 'link'=> $cfg_basehost);

207 
uc_ed_ne
(
$cfg_ml
->
M_LogID
,
$ed
);

209 
	g$row
 = 
$dsql
->
GO
("SELECT `sces`,`urid` FROM `#@__memb` WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

210 
uc_ed_ne
(
$row
['urid'],
$cfg_ndc_sces
);

212 #/
a
}}

215 
	g$msg
 = "

217 <
a
 
hf
='chives_sg_add.php?chlid=$chlid'><
u
>继续发布内容</u></a>

218 &
nb
;&
	gnb
;

219 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看内容</u></a>

220 &
nb
;&
	gnb
;

221 <
a
 
	ghf
='chives_sg_ed.php?chlid=$chlid&aid=$cID'><
u
>更改内容</u></a>

222 &
nb
;&
	gnb
;

223 <
a
 
	ghf
='cڋ_sg_li.php?chlid={$chlid}'><
u
>已发布内容管理</u></a>

225 
$wt
 = "成功发布内容！";

226 
	g$wecome_fo
 = "内容管理::发布内容";

227 
	g$w
 = 
w
 
OxWdow
();

228 
	g$w
->
AddT
("成功发布内容：");

229 
	g$w
->
AddMsgIm
(
$msg
);

230 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

231 
	g$w
->
Diy
();

	@member/archives_sg_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 
que_
(
DEDEINC
."/customfields.func.php");

6 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

7 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

8 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 1;

9 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

10 
	g$mtysid
 = 
ist
(
$mtysid
&& 
is_numic
($mtypesid) ? $mtypesid : 0;

15 if(
	$emy
(
$do
))

18 
$cQuy
 = "Select ch.*,arc.* From `#@__arctiny`rc

19 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl
 
whe
rc.id='$aid' ";

20 
$cInfos
 = 
$dsql
->
	`GO
(
$cQuy
);

21 if(!
	`is_y
(
$cInfos
))

23 
	`ShowMsg
("读取文档信息出错!","-1");

24 
	`ex
();

26 
$addRow
 = 
$dsql
->
	`GO
("Select * From `{$cInfos['addtable']}` whereid='$aid'; ");

27 if(
$addRow
['mid']!=
$cfg_ml
->
M_ID
)

29 
	`ShowMsg
("对不起，你没权限操作此文档！","-1");

30 
	`ex
();

32 
$addRow
['id'] = $addRow['aid'];

33 
	`ude
(
DEDEMEMBER
."/templets/archives_sg_edit.htm");

34 
	`ex
();

35 
	}
}

40 if(
	g$do
=='save')

42 
que_
(
DEDEINC
."/image.func.php");

43 
que_
(
DEDEINC
."/oxwindow.class.php");

45 
	g$ag
 = '';

46 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

47 
	g$ur
 = 
GIP
();

48 
	g$ckhash
 = 
md5
(
$aid
.
$cfg_cook_code
);

49 if(
	g$ckhash
!=
$idhash
)

51 
ShowMsg
('校对码错误，你没权限修改此文档或操作不合法！','-1');

52 
ex
();

55 if(
	g$tyid
==0)

57 
ShowMsg
('请指定文档隶属的栏目！','-1');

58 
ex
();

60 
	g$quy
 = "Selectp.ispart,tp.channeltype,tp.issend,ch.issends cissend,ch.sendrank,ch.arcsta,ch.addtable,ch.usertype

61 
From
 `#@
__y
` 

 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
p.
chy
 
whe
p.id='$typeid' ";

62 
$cInfos
 = 
$dsql
->
GO
(
$quy
);

63 
	g$addb
 = 
$cInfos
['addtable'];

66 if(
	g$cInfos
['isnd']!=1 || 
$cInfos
['it']!=0|| $cInfos['chy']!=
$chlid
 || $cInfos['cissend']!=1)

68 
ShowMsg
("你所选择的栏目不支持投稿！","-1");

69 
ex
();

73 if(
	g$cInfos
['arcsta']==0)

75 
$k
 = 0;

77 if(
	g$cInfos
['arcsta']==1)

79 
$k
 = 0;

83 
	g$k
 = -1;

87 
	g$t
 = 
_subrR
(
HtmlR
(
$t
,1),
$cfg_t_maxn
);

88 
	g$mid
 = 
$cfg_ml
->
M_ID
;

91 
	g$lpic
 = 
MembUds
('lpic',
$dlpic
,
$mid
,'image','',
$cfg_ddimg_width
,
$cfg_ddimg_height
,
l
);

92 if(
	g$lpic
!='')

94 
SaveUdInfo
(
$t
,
$lpic
,1);

98 
	g$lpic
 =
$dlpic
;

102 
	g$add_f
 = '';

103 if(!
emy
(
$dede_addflds
))

105 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

106 if(
is_y
(
$addflds
))

108 
fܗch
(
$addflds
 
as
 
$v
)

110 if(
	g$v
=='')

114 
	g$vs
 = 
exode
(',',
$v
);

115 if(!
ist
(
$
{
$vs
[0]}))

117 
	g$
{
	g$vs
[0]} = '';

121 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

123 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,$vs[1]);

126 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$aid
);

128 
	g$add_f
 .',`'.
$vs
[0]."` ='".
$
{$vs[0]}."' ";

133 if(
	g$addb
!='')

135 
$upQuy
 = "Update `$addtable` set `title`='$title',`typeid`='$typeid',`arcrank`='$arcrank',litpic='$litpic',userip='$userip'{$inadd_f} whereid='$aid' ";

136 if(!
	g$dsql
->
ExecuNeQuy
(
$upQuy
))

138 
ShowMsg
("更新附加表 `$addtable` 时出错，请联系管理员！","javascript:;");

139 
ex
();

143 
UpIndexKey
(
$aid
,0,
$tyid
,
$s܌k
,'');

145 
	g$tU
 = 
MakeA
(
$aid
,
ue
);

147 if(
	g$tU
=='')

149 
$tU
 = 
$cfg_phpu
."/view.php?aid=$aid";

153 
	g$msg
 = "　　请选择你的后续操作：

154 <
a
 
hf
='chives_sg_add.php?cid=$tyid'><
u
>发布新内容</u></a>

155 &
nb
;&
	gnb
;

156 <
a
 
	ghf
='chives_do.php?chlid=$chlid&aid=".$aid."&dod'><
u
>查看更改</u></a>

157 &
nb
;&
	gnb
;

158 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看内容</u></a>

159 &
nb
;&
	gnb
;

160 <
a
 
	ghf
='cڋ_sg_li.php?chlid=$chlid'><
u
>管理内容</u></a>

162 
$wt
 = "成功更改内容！";

163 
	g$wecome_fo
 = "内容管理::更改内容";

164 
	g$w
 = 
w
 
OxWdow
();

165 
	g$w
->
AddT
("成功更改内容：");

166 
	g$w
->
AddMsgIm
(
$msg
);

167 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

168 
	g$w
->
Diy
();

	@member/article_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/dedetag.class.php");

4 
que_
(
DEDEINC
."/customfields.func.php");

5 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

6 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

7 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 1;

8 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

9 
	g$mtysid
 = 
ist
(
$mtysid
&& 
is_numic
($mtypesid) ? $mtypesid : 0;

14 if(
	$emy
(
$do
))

16 
$cInfos
 = 
$dsql
->
	`GO
("Select * From `#@__channeltype` where id='$channelid'; ");

19 if(
$cInfos
['sendrank']>0 || $cInfos['usertype']!='')

21 
	`CheckRk
(0,0);

25 if(
$cInfos
['ndnk'] > 
$cfg_ml
->
M_Rk
)

27 
$row
 = 
$dsql
->
	`GO
("Se membmFrom `#@__k` whnk='".
$cInfos
['sendrank']."' ");

28 
	`ShowMsg
("对不起，需要[".
$row
['membername']."]才能在这个频道发布文档！","-1","0",5000);

29 
	`ex
();

31 if(
$cInfos
['uy']!='' && $cInfos['uy'] !
$cfg_ml
->
M_MbTy
)

33 
	`ShowMsg
("对不起，需要[".
$cInfos
['usertype']."帐号]才能在这个频道发布文档！","-1","0",5000);

34 
	`ex
();

36 
	`ude
(
DEDEMEMBER
."/templets/article_add.htm");

37 
	`ex
();

38 
	}
}

43 if(
	g$do
=='save')

45 
ude
(
DEDEMEMBER
.'/inc/archives_check.php');

48 
	g$add_f
 = 
$add_v
 = '';

49 if(!
emy
(
$dede_addflds
))

51 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

52 
	g$add_f
 = '';

53 
	g$add_v
 = '';

54 if(
is_y
(
$addflds
))

56 
fܗch
(
$addflds
 
as
 
$v
)

58 if(
	g$v
=='')

62 
	g$vs
 = 
exode
(',',
$v
);

63 if(!
ist
(
$
{
$vs
[0]}))

65 
	g$
{
	g$vs
[0]} = '';

67 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],0);

68 
	g$add_f
 .','.
$vs
[0];

69 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

75 if(
	g$lpic
!='')

77 
$ag
 = 'p';

79 
	g$body
 = 
AlyHtmlBody
(
$body
,
$desti
);

80 
	g$body
 = 
HtmlR
(
$body
,-1);

83 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$mid
);

84 if(
emy
(
$cID
))

86 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

87 
ex
();

91 
	g$Quy
 = "INSERT INTO `#@__archives`(id,typeid,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

92 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gdesti
,
	gkeywds
,
	gmty
)

93 
VALUES
 ('$arcID','$typeid','$sortrank','$flag','$ismake','$channelid','$arcrank','0','$money','$title','$shorttitle',

95 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

97 
	g$gr
 = 
$dsql
->
GE
();

98 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID' ");

99 
ShowMsg
("把数据保存到数据库主表 `#@__archives` 时出错，请联系管理员。","javascript:;");

100 
ex
();

104 
	g$addb
 = 
im
(
$cInfos
['addtable']);

105 if(
emy
(
$addb
))

107 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

108 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

109 
ShowMsg
("没找到当前模型[{$channelid}]的主表信息，无法完成操作！。","javascript:;");

110 
ex
();

114 
	g$quy
 = "INSERT INTO `{$addtable}`(aid,typeid,userip,redirecturl,templet,body{$inadd_f}) Values('$arcID','$typeid','$userip','','','$body'{$inadd_v})";

115 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

117 
	g$gr
 = 
$dsql
->
GE
();

118 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

119 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

120 
ShowMsg
("把数据保存到数据库附加表 `{$addtable}` 时出错，请联系管理员！","javascript:;");

121 
ex
();

126 
	g$dsql
->
ExecuNeQuy
("Upd`#@__memb` s sces=sces+{$cfg_ndc_sces} whmid='".
$cfg_ml
->
M_ID
."' ; ");

128 
couArchives
(
$chlid
);

131 
InTags
(
$gs
,
$cID
);

132 
	g$tU
 = 
MakeA
(
$cID
,
ue
);

133 if(
	g$tU
=='')

135 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

139 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/api/uc.func.php')

142 
	g$ed
['icon'] = 'thread';

143 
	g$ed
['title_template'] = '<b>{username} 在网站发布了一篇文章</b>';

144 
	g$ed
['t_da'] = 
y
('uame' => 
$cfg_ml
->
M_UrName
);

145 
	g$ed
['body_template'] = '<b>{subject}</b><br>{message}';

146 
	g$u
 = !
rr
(
$tU
,'hp://'? (
	g$cfg_baho
.
	g$tU
) : $artUrl;

147 
	g$ed
['body_da'] = 
y
('subje' => "<hf=\"".
$u
."\">$t</a>", 'mesge' => 
_subr
(
r_gs
(
eg_a
("/\[.+?\]/is", '', 
$desti
)), 150));

148 
	g$ed
['images'][] = 
y
('u' => 
$cfg_baho
.'/images/scores.gif', 'link'=> $cfg_basehost);

149 
uc_ed_ne
(
$cfg_ml
->
M_LogID
,
$ed
);

151 
	g$row
 = 
$dsql
->
GO
("SELECT `sces`,`urid` FROM `#@__memb` WHERE `mid`='".
$cfg_ml
->
M_ID
."' AND `matt`<>10");

152 
uc_ed_ne
(
$row
['urid'], 
$cfg_ndc_sces
);

154 #/
a
}}

157 
	g$msg
 =

159 <
a
 
hf
='tie_add.php?cid=$tyid'><
u
>继续发布文章</u></a>

160 &
nb
;&
	gnb
;

161 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文章</u></a>

162 &
nb
;&
	gnb
;

163 <
a
 
	ghf
='tie_ed.php?chlid=$chlid&aid=$cID'><
u
>更改文章</u></a>

164 &
nb
;&
	gnb
;

165 <
a
 
	ghf
='cڋ_li.php?chlid={$chlid}'><
u
>已发布文章管理</u></a>";

166 
$wt
 = "成功发布文章！";

167 
	g$wecome_fo
 = "文章管理::发布文章";

168 
	g$w
 = 
w
 
OxWdow
();

169 
	g$w
->
AddT
("成功发布文章：");

170 
	g$w
->
AddMsgIm
(
$msg
);

171 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

172 
	g$w
->
Diy
();

	@member/article_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 
que_
(
DEDEINC
."/customfields.func.php");

6 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

7 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

8 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 1;

9 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

10 
	g$mtysid
 = 
ist
(
$mtysid
&& 
is_numic
($mtypesid) ? $mtypesid : 0;

15 if(
	$emy
(
$do
))

18 
$cQuy
 = "Selectrc.*,ch.addtable,ch.fieldset,arc.mtypes mtypeid,ch.arcsta

19 
From
 `#@
__chives
` 
c
 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
rc.
chl


20 
whe
 
c
.
id
='$aid' 
And
rc.
mid
='".$cfg_ml->M_ID."'; ";

21 
$row
 = 
$dsql
->
	`GO
(
$cQuy
);

22 if(!
	`is_y
(
$row
))

24 
	`ShowMsg
("读取文章信息出错!","-1");

25 
	`ex
();

27 if(
$row
['arcrank']>=0)

29 
$dtime
 = 
	`time
();

30 
$maxtime
 = 
$cfg_mb_edday
 * 24 *3600;

31 if(
$dtime
 - 
$row
['ndde'] > 
$maxtime
)

33 
	`ShowMsg
("这篇文档已经锁定，你不能再修改它！","-1");

34 
	`ex
();

37 
$addRow
 = 
$dsql
->
	`GO
("Select * From `{$row['addtable']}` whereid='$aid'; ");

38 
	`ude
(
DEDEMEMBER
."/templets/article_edit.htm");

39 
	`ex
();

40 
	}
}

45 if(
	g$do
=='save')

47 
ude
(
DEDEMEMBER
.'/inc/archives_check_edit.php');

50 
	g$add_f
 = '';

51 if(!
emy
(
$dede_addflds
))

53 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

54 if(
is_y
(
$addflds
))

56 
fܗch
(
$addflds
 
as
 
$v
)

58 if(
	g$v
=='')

62 
	g$vs
 = 
exode
(',',
$v
);

63 if(!
ist
(
$
{
$vs
[0]}))

65 
	g$
{
	g$vs
[0]} = '';

67 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$aid
);

68 
	g$add_f
 .','.
$vs
[0]." ='".
$
{$vs[0]}."' ";

72 
	g$body
 = 
AlyHtmlBody
(
$body
,
$desti
);

73 
	g$body
 = 
HtmlR
(
$body
,-1);

76 if(
	g$lpic
!='')

78 
$ag
 = 'p';

82 
	g$upQuy
 = "Update `#@__archives` set

83 
ismake
='$ismake',

84 
	gk
='$arcrank',

85 
	gtyid
='$typeid',

86 
	gt
='$title',

87 
	glpic
='$litpic',

88 
	gdesti
='$description',

89 
	gmty
 = '$mtypesid',

90 
	gkeywds
='$keywords',

91 
	gag
='$flag'

92 
whe
 
id
='$aid' 
And
 
mid
='$mid'; ";

93 if(!
	g$dsql
->
ExecuNeQuy
(
$upQuy
))

95 
ShowMsg
("把数据保存到数据库主表时出错，请联系管理员！".
$dsql
->
GE
(),"-1");

96 
ex
();

98 if(
	g$addb
!='')

100 
$upQuy
 = "Update `$addtable` setypeid='$typeid',body='$body'{$inadd_f},userip='$userip' whereid='$aid' ";

101 if(!
	g$dsql
->
ExecuNeQuy
(
$upQuy
))

103 
ShowMsg
("更新附加表 `$addtable` 时出错，请联系管理员！","javascript:;");

104 
ex
();

107 
UpIndexKey
(
$aid
,
$k
,
$tyid
,
$s܌k
,
$gs
);

108 
	g$tU
 = 
MakeA
(
$aid
,
ue
);

109 if(
	g$tU
=='')

111 
$tU
 = 
$cfg_phpu
."/view.php?aid=$aid";

115 
	g$msg
 = "　　请选择你的后续操作：

116 <
a
 
hf
='tie_add.php?cid=$tyid'><
u
>发布新文章</u></a>

117 &
nb
;&
	gnb
;

118 <
a
 
	ghf
='chives_do.php?chlid=$chlid&aid=".$aid."&dod'><
u
>查看更改</u></a>

119 &
nb
;&
	gnb
;

120 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文章</u></a>

121 &
nb
;&
	gnb
;

122 <
a
 
	ghf
='cڋ_li.php?chlid=$chlid'><
u
>管理文章</u></a>

124 
$wt
 = "成功更改文章！";

125 
	g$wecome_fo
 = "文章管理::更改文章";

126 
	g$w
 = 
w
 
OxWdow
();

127 
	g$w
->
AddT
("成功更改文章：");

128 
	g$w
->
AddMsgIm
(
$msg
);

129 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

130 
	g$w
->
Diy
();

	@member/buy.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckRk
(0,0);

4 
	g$myu
 = 
$cfg_baho
.
$cfg_memb_d
.'/dex.php?uid='.
$cfg_ml
->
M_LogID
;

5 
	g$meyrds
 = '';

6 
	g$membtys
 = '';

7 
	g$dsql
->
SQuy
("Select * From #@__moneycard_type ");

8 
	g$dsql
->
Execu
();

9 
	g$row
 = 
$dsql
->
	$GObje
())

11 
$row
->
mey
 = 
	`rtf
("%01.2f", $row->money);

12 
$meyrds
 .= "<tr>

13 <
td
><
put
 
ty
='dio' 
me
='pid' 
vue
='{$row->tid}'></td>

14 <
td
><
rg
>{
$row
->
ame
}</strong></td>

15 <
td
>{
$row
->
num
}</td>

16 <
td
>{
$row
->
mey
}</td>

17 </

>

19 
	}
}

20 
	g$dsql
->
SQuy
("Select #@__member_type.*,#@__arcrank.membername,#@__arcrank.moneys cm From #@__member_typeeft join #@__arcrank on #@__arcrank.rank = #@__member_type.rank ");

21 
	g$dsql
->
Execu
();

22 
	g$row
 = 
$dsql
->
	$GObje
())

24 
$row
->
mey
 = 
	`rtf
("%01.2f", $row->money);

25 
$membtys
 .= "<tr>

26 <
td
><
put
 
ty
='dio' 
me
='pid' 
vue
='{$row->aid}'></td>

27 <
td
><
rg
>{
$row
->
ame
}</strong></td>

28 <
td
>{
$row
->
membme
}</td>

29 <
td
>{
$row
->
exime
}</td>

30 <
td
>{
$row
->
mey
}</td>

31 </

>

33 
	}
}

34 
	g$l
 = 
w
 
DedeTeme
();

35 
	g$l
->
LdTeme
(
DEDEMEMBER
.'/templets/buy.htm');

36 
	g$l
->
Diy
();

	@member/buy_action.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

5 
que_
 
	gDEDEINC
.'/dedetemplate.class.php';

7 
	g$odu
 = 
ist
(
$odu
? 
	$im
(
$odu
) : '';

8 
$mid
 = 
$cfg_ml
->
M_ID
;

9 
$y
 = '';

10 
$ame
 = '';

11 
$i
 = '';

13 if(
	`ist
(
$pd_code
&& ist(
$pd_vify
&& 
	`md5
("ymt".$pd_code.
$cfg_cook_code
) == $pd_verify)

16 
	`r_r
(
	`mchSCode
(
$pd_code
,'DECODE'),
$mch_Po
);

17 
	`fܗch
(
$mch_Po
 
as
 
$k
 => 
$v

$$k
 = $v;

18 
$row
 = 
$dsql
->
	`GO
("SELECT * FROM #@__member_operation WHERE mid='$mid' And sta=0 ANDroduct='$product'");

19 if(!
	`ist
(
$row
['buyid']))

21 
	`ShowMsg
("请不要重复提交表单!", 'javascript:;');

22 
	`ex
();

24 
$buyid
 = 
$row
['buyid'];

26 
	}
}

29 
	g$buyid
 = '';

30 
	g$mtime
 = 
time
();

31 
	g$buyid
 = 'M'.
$mid
.'T'.
$mtime
.'RN'.
mt_nd
(100,999);

33 if(!
emy
(
$odu
))

35 
	g$dsql
->
ExecuNeQuy
("Delete From #@__member_operation where mid='$mid' And sta=0 Androduct='$product'");

39 if(
	$emy
(
$odu
))

41 
	`ShowMsg
("请选择一个产品!", 'javascript:;');

42 
	`ex
();

43 
	}
}

45 
	g$pid
 = 
ist
(
$pid
&& 
is_numic
($pid) ? $pid : 0;

46 if(
	g$odu
=='member')

48 
$y
 = "会员升级";

49 
	g$row
 = 
$dsql
->
GO
("Select * From #@__member_type whereid='{$pid}'");

50 if(!
is_y
(
$row
))

52 
ShowMsg
("无法识别你的订单！", 'javascript:;');

53 
ex
();

55 
	g$ame
 = 
$row
['pname'];

56 
	g$i
 = 
$row
['money'];

58 
if
(
$odu
 == 'card')

60 
$y
 = "点卡购买";

61 
	g$row
 = 
$dsql
->
GO
("Select * From #@__moneycard_type whereid='{$pid}'");

62 if(!
is_y
(
$row
))

64 
ShowMsg
("无法识别你的订单！", 'javascript:;');

65 
ex
();

67 
	g$ame
 = 
$row
['pname'];

68 
	g$i
 = 
$row
['money'];

71 if(!
	$ist
(
$le_ymt
))

73 
$quy
 = "

74 
INSERT
 
INTO
 #@
	`__memb_ݔi
(`
buyid
` , `
ame
` , `
odu
` , `
mey
` , `
mtime
` , `
pid
` , `
mid
` , `
a
` ,`
dfo
`)

75 
	`VALUES
 ('$buyid', '$pname', '$product' , '$price' , '$mtime' , '$pid' , '$mid' , '0' , '$ptype');

77 
$isok
 = 
$dsql
->
	`ExecuNeQuy
(
$quy
);

78 if(!
$isok
)

80 
echo
 "数据库出错，请重新尝试！".
$dsql
->
	`GE
();

81 
	`ex
();

83 if(
$i
=='')

85 
echo
 "无法识别你的订单！";

86 
	`ex
();

89 
$i
 = 
	`rtf
("%01.2f", $price);

91 
$ymt_li
 = 
	`y
();

92 
	`fܗch
(
$ymt_
 
as
 
$k
 => 
$v
)

94 
$mp_r
['me'] = 
$cfg_y_fo
['me'][
$k
];

95 
$mp_r
['logo'] = 'images/y/'.
$cfg_y_fo
['logo'][
$k
];

96 
$mp_r
['des'] = 
$cfg_y_fo
['des'][
$k
];

97 
$mp_r
['vue'] = 
$v
;

98 
$mp_r
['exp'] = 
	`rtf
("%01.2f", 
$i
*
$ymt_exp
[
$k
]);

99 
$ymt_li
[] = 
$mp_r
;

102 
$_code
 = '';

103 
	`fܗch
(
$_REQUEST
 
as
 
$key
 => 
$v
)

105 
$_code
 .= $pr_encode ? "&$key=$val" : "$key=$val";

108 
$_code
 = 
	`r_a
('=', '', 
	`mchSCode
($pr_encode));

110 
$_vify
 = 
	`md5
("ymt".
$_code
.
$cfg_cook_code
);

112 
$mp_r
 = 
NULL
;

113 
$l
 = 
w
 
	`DedeTeme
();

114 
$l
->
	`LdTeme
(
DEDEMEMBER
.'/templets/buy_action_payment.htm');

115 
$l
->
	`Diy
();

117 
	}

	g}
{

118 if(!
_y
(
$le_ymt
,
$ymt_
))

120 
ShowMsg
("支付接口无效,或没开启！", 'javascript:;');

121 
ex
();

123 
que_
 
	gDEDEMEMBER
.'/c/cfig_y_'.
	g$le_ymt
.'.php';

	@member/caicai.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/arc.caicai.class.php");

4 
	g$st
 = 
im
(
emy
(
$st
? 'ϡpo' : 
egi_a
('[^0-9a-z]','',$sort));

5 if(!
egi
("^(sces|badpo|goodpo)$",
$st
))

7 
	g$st
 = 'lastpost';

9 
	g$tid
 = (
ist
(
$tid
? 
	$tv
(
$tid
) : 0);

10 
$t1
 = 
	`ExecTime
();

11 
$tyquy
 = '';

14 if(
$tid
!=0)

16 
$r
 = 
$dsql
->
	`GO
("Select * From `#@__arctype` where id='$tid' And corank=0 ");

17 if(
$cfg_li_s
=='Y')

19 
$CrossID
 = 
	`GSIds
(
$tid
,
$r
['channeltype']);

23 
$CrossID
 = 
$tid
;

25 if(
$r
['cross']>0)

27 
$lquy
 = '';

28 if(
$r
['cross']==1)

30 
$lquy
 = "Select id,topid From `#@__arctype` whereypenameike '{$arr['typename']}' And id<>'{$tid}' Andopid<>'{$tid}' ";

34 
$r
['ossid'] = 
	`eg_a
('[^0-9,]','',
	`im
($arr['crossid']));

35 if(
$r
['crossid']!='')

37 
$lquy
 = "Select id,topid From `#@__arctype` where id in('{$arr['crossid']}') And id<>'{$tid}' Andopid<>'{$tid}' ";

40 if(
$lquy
!='')

42 
$dsql
->
	`SQuy
(
$lquy
);

43 
$dsql
->
	`Execu
();

44 
$r
 = 
$dsql
->
	`GAay
())

46 
$CrossID
 .($CrossID=='' ? 
$r
['id'] : ','.$arr['id']);

50 
$tyquy
 = "rc.typeid in($CrossID) And ";

51 
	}
}

52 
	g$dli
 = 
w
 
Caii
();

53 
	g$dli
->
	ggeSize
 = 15;

54 
	g$dli
->
	gmaxPageSize
 = 100;

55 
	g$maxrc
 = 
$dli
->
geSize
 * $dli->
maxPageSize
;

56 
	g$quy
 = "Selectrc.*,m.userid,m.face,

57 

.
tyd
,
	g
.
	gtyme
,.
	gisdeu
,.
	gdeume
,.
	gmu
,.
	gmu2
,.
	git
,.
	gmese
,.
	gseu
,.
sh


58 
	gFrom
 `#@
	g__chives
` 
c
 

 
	gjo
 `#@
	g__y
` 

 

 
	g
.
	gid
rc.
tyid
e 
jo
 `#@
__memb
` 
m
 om.
mid
=arc.mid

59 
whe
 
$tyquy
 
c
.
k
>-1

60 
d
 
by
 
c
.`{
$st
}` 
desc
 
lim
 
$maxrc
 ";

61 
$dli
->
SPam
('tid',
$tid
);

62 
	g$dli
->
SPam
('st',
$st
);

63 
	g$dli
->
STeme
(
DEDEMEMBER
.'/templets/caicai.htm');

64 
	g$dli
->
SSour
(
$quy
);

65 
	g$dli
->
Diy
();

	@member/check_card.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
	g$svi
 = 
GCkVdVue
();

5 if(
ow
(
$vdcode
)!=
$svi
 || $svali=="")

7 
ShowMsg
("验证码错误！","-1");

8 
ex
();

11 
	g$rdid
 = 
eg_a
("[^0-9A-Za-z-]","",
$rdid
);

12 if(
	$emy
(
$rdid
))

14 
	`ShowMsg
("卡号为空！","-1");

15 
	`ex
();

16 
	}
}

18 
	g$row
 = 
$dsql
->
GO
("SELECT * FROM #@__moneycard_record WHERE cardid='$cardid' ");

20 if(!
	$is_y
(
$row
))

22 
	`ShowMsg
("卡号错误：不存在此卡号！","-1");

23 
	`ex
();

24 
	}
}

26 if(
	g$row
['isexp']==-1)

28 
ShowMsg
("此卡号已经失效，不能再次使用！","-1");

29 
ex
();

32 
	g$hasMey
 = 
$row
['num'];

33 
	g$dsql
->
ExecuNeQuy
("UPDATE #@__meyrd_cd SET uid='".
$cfg_ml
->
M_ID
."',ixp='-1',utime='".
time
()."' WHERE cardid='$cardid' ");

34 
	g$dsql
->
ExecuNeQuy
("UPDATE #@__memb SET mey=mey+$hasMey WHERE mid='".
$cfg_ml
->
M_ID
."'");

36 
ShowMsg
("充值成功，你本次增加的金币为：{$hasMoney} 个！",-1);

37 
ex
();

	@member/config.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 
que_
(
DEDEINC
.'/filter.inc.php');

4 
que_
(
DEDEINC
.'/memberlogin.class.php');

5 
que_
(
DEDEINC
.'/dedetemplate.class.php');

8 
	g$dedeNowu
 = 
$s_stName
 = '';

9 
	g$dedeNowu
 = 
GCurU
();

10 
	g$dedeNowus
 = 
exode
('?', 
$dedeNowu
);

11 
	g$s_stName
 = 
$dedeNowus
[0];

14 if(
	g$cfg_mb_ݒ
=='N')

16 
ShowMsg
("系统关闭了会员功能，因此你无法访问此页面！","javascript:;");

17 
ex
();

19 
	g$kime
 = 
ist
(
$kime
&& 
is_numic
($keeptime) ? $keeptime : -1;

20 
	g$cfg_ml
 = 
w
 
MembLog
(
$kime
);

23 
	g$myu
 = '';

24 if(
	g$cfg_ml
->
	$IsLog
())

26 
$myu
 = 
$cfg_membu
."/dex.php?uid=".
	`ucode
(
$cfg_ml
->
M_LogID
);

27 if(!
	`eg
('^hp:',
$myu
))

29 
$myu
 = 
$cfg_baho
.$myurl;

31 
	}
}

34 
funi
 
	$CheckRk
(
$nk
=0, 
$mey
=0)

36 
glob
 
$cfg_ml
,
$cfg_membu
;

37 if(!
$cfg_ml
->
	`IsLog
())

39 
	`hd
("Loti:{$cfg_membu}/log.php?gou=".
	`ucode
(
	`GCurU
()));

40 
	`ex
();

44 if(
$cfg_ml
->
M_Rk
 < 
$nk
)

46 
$edme
 = "";

47 if(
$cfg_ml
->
M_Rk
==0)

49 
$row
 = 
$dsql
->
	`GO
("Select membername From #@__arcrank whereank='$rank'");

50 
$myme
 = "普通会员";

51 
$edme
 = 
$row
['membername'];

55 
$dsql
->
	`SQuy
("Se membmFrom #@__k whnk='$nk' Onk='".
$cfg_ml
->
M_Rk
."' order byank desc");

56 
$dsql
->
	`Execu
();

57 
$row
 = 
$dsql
->
	`GObje
();

58 
$edme
 = 
$row
->
membme
;

59 if(
$row
 = 
$dsql
->
	`GObje
())

61 
$myme
 = 
$row
->
membme
;

65 
$myme
 = "普通会员";

68 
	`ShowMsg
("对不起，需要：<span style='font-size:11pt;color:red'>$needname</span> 才能访问本页面。<br>你目前的等级是：<span style='font-size:11pt;color:red'>$myname</span> 。","-1",0,5000);

69 
	`ex
();

71 if(
$cfg_ml
->
M_Mey
 < 
$mey
)

73 
	`ShowMsg
("对不起，需要花费金币：< sty='ft-size:11;c:d'>$mey</> 才能访问本页面。<br>你目前拥有的金币是：< sty='ft-size:11;c:d'>".
$cfg_ml
->
M_Mey
."</span> 。","-1",0,5000);

74 
	`ex
();

77 
	}
}

80 
funi
 
	$couArchives
(
$chlid
)

82 
glob
 
$cfg_ml
,
$dsql
;

83 
$id
 = ()
$chlid
;

84 if(
$cfg_ml
->
	`IsLog
())

86 
$chy
 = 
	`y
(1 => 'article',2 => 'album',3 => 'soft',-8 => 'infos');

87 if(
	`ist
(
$chy
[
$id
]))

89 
$_fld
 = 
$chy
[
$id
];

93 
$_fld
 = 'articles';

95 
$row
 = 
$dsql
->
	`GO
("SELECT COUNT(*ASumFROM #@__chiveWHERE chl='$id' AND mid='".
$cfg_ml
->
M_ID
."'");

97 
$dsql
->
	`ExecuNeQuy
("UPDATE #@__memb_tj SET ".
$_fld
."='".
$row
['nums']."' WHERE mid='".
$cfg_ml
->
M_ID
."'");

101  
l
;

103 
	}
}

	@member/content_list.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/typelink.class.php");

5 
que_
(
DEDEINC
."/datalistcp.class.php");

6 
que_
(
DEDEMEMBER
."/inc/inc_list_functions.php");

7 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

8 
	g$cid
 = 
ist
(
$cid
&& 
is_numic
($cid) ? $cid : 0;

9 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 0;

10 
	g$mtysid
 = 
ist
(
$mtysid
&& 
is_numic
($mtypesid) ? $mtypesid : 0;

11 if(!
	$ist
(
$keywd
))

13 
$keywd
 = '';

14 
	}
}

15 if(!
	$ist
(
$k
))

17 
$k
 = '';

18 
	}
}

19 
	g$posime
 = '';

20 
	g$mid
 = 
$cfg_ml
->
M_ID
;

21 
	g$
 = 
w
 
TyLk
(
$cid
);

22 
	g$cInfos
 = 
$
->
dsql
->
GO
("Selectrcsta,issend,issystem,usertype From `#@__channeltype` where id='$channelid'; ");

23 if(!
	$is_y
(
$cInfos
))

25 
	`ShowMsg
('模型不存在', '-1');

26 
	`ex
();

27 
	}
}

28 
	g$ca
 = 
$cInfos
['arcsta'];

29 
	g$dtime
 = 
time
();

30 
	g$maxtime
 = 
$cfg_mb_edday
 * 24 *3600;

33 if(
	g$cInfos
['uy'] !='' && 
$cInfos
['uy']!=
$cfg_ml
->
M_MbTy
)

35 
ShowMsg
('你无权限访问该部分', '-1');

36 
ex
();

39 if(
	g$cid
==0)

41 
$row
 = 
$
->
dsql
->
GO
("Selectypename From #@__channeltype where id='$channelid'");

42 if(
is_y
(
$row
))

44 
	g$posime
 = 
$row
['typename'];

49 
	g$posime
 = 
r_a
(
$cfg_li_symb
,"",
$
->
GPosiName
())." ";

51 
	g$wheSql
 = " whererc.channel = '$channelid' Andrc.mid='$mid' ";

52 if(
	g$keywd
!='')

54 
$keywd
 = 
_subr
(
im
(
eg_a
("[><\|\"\r\n\t%\*\.\?\(\)\$ ;,'%-]","",
rashes
($keyword))),30);

55 
	g$keywd
 = 
addashes
(
$keywd
);

56 
	g$wheSql
 .= " And (arc.titleike '%$keyword%') ";

58 if(
	g$cid
!=0)

60 
$wheSql
 ." Andrc.tyid i(".
GSIds
(
$cid
).")";

62 
	g$asi
 = '';

63 
	g$dsql
->
SQuy
("SELECT * FROM `#@__mtypes` WHERE `mid` = '$cfg_ml->M_ID';");

64 
	g$dsql
->
Execu
();

65 
	g$row
 = 
$dsql
->
	$GAay
())

67 
$asi
 ."<ti vue='cڋ_li.php?chlid=".
$chlid
."&mtysid=".
$row
['mtypeid']."'>".$row['mtypename']."</option>\r\n";

68 
	}
}

69 if(
	g$mtysid
 != 0 )

71 
$wheSql
 .= " Andrc.mtype = '$mtypesid'";

73 
	g$quy
 = "selectrc.id,arc.typeid,arc.senddate,arc.flag,arc.ismake,arc.channel,arc.arcrank,

74 
c
.
ick
,
	gc
.
	gt
,c.
	gc
,c.
	glpic
,c.
	gpubde
,c.
	gmid
,
	g
.
	gtyme
,
	gch
.
tyme
 
as
 
chame


75 
	gom
 `#@
	g__chives
` 
c


76 

 
	gjo
 `#@
	g__y
` 

 

 
	g
.
	gid
=
c
.
tyid


77 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


78 
$wheSql
 
d
 
by
 
c
.
ndde
 
desc
 ";

79 
$dli
 = 
w
 
DaLiCP
();

80 
	g$dli
->
	ggeSize
 = 20;

81 
	g$dli
->
SPam
("dopost","listArchives");

82 
	g$dli
->
SPam
("keywd",
$keywd
);

83 
	g$dli
->
SPam
("cid",
$cid
);

84 
	g$dli
->
SPam
("chlid",
$chlid
);

85 
	g$dli
->
STeme
(
DEDEMEMBER
."/templets/content_list.htm");

86 
	g$dli
->
SSour
(
$quy
);

87 
	g$dli
->
Diy
();

	@member/content_sg_list.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/typelink.class.php");

5 
que_
(
DEDEINC
."/datalistcp.class.php");

6 
que_
(
DEDEMEMBER
."/inc/inc_list_functions.php");

7 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

8 
	g$cid
 = 
ist
(
$cid
&& 
is_numic
($cid) ? $cid : 0;

9 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 0;

10 
	g$mtysid
 = 
ist
(
$mtysid
&& 
is_numic
($mtypesid) ? $mtypesid : 0;

11 if(!
	$ist
(
$keywd
))

13 
$keywd
 = '';

14 
	}
}

15 if(!
	$ist
(
$k
))

17 
$k
 = '';

18 
	}
}

19 
	g$posime
 = '';

20 
	g$mid
 = 
$cfg_ml
->
M_ID
;

21 
	g$
 = 
w
 
TyLk
(
$cid
);

22 
	g$cInfos
 = 
$
->
dsql
->
GO
("Selectrcsta,issend,issystem,usertype,typename,addtable From `#@__channeltype` where id='$channelid'; ");

23 if(!
	$is_y
(
$cInfos
))

25 
	`ShowMsg
('模型不存在', '-1');

26 
	`ex
();

27 
	}
}

28 
	g$ca
 = 
$cInfos
['arcsta'];

31 if(
	g$cInfos
['uy'] !='' && 
$cInfos
['uy']!=
$cfg_ml
->
M_MbTy
)

33 
ShowMsg
('你无权限访问该部分', '-1');

34 
ex
();

37 if(
	g$cid
==0)

39 
$posime
 = 
$cInfos
['typename']." &gt;&gt; ";

43 
	g$posime
 = 
r_a
(
$cfg_li_symb
," &gt;&gt; ",
$
->
GPosiName
())." &gt;&gt; ";

45 
	g$wheSql
 = " whererc.channel = '$channelid' Andrc.mid='$mid' ";

46 if(
	g$keywd
!='')

48 
$keywd
 = 
_subr
(
im
(
eg_a
("[><\|\"\r\n\t%\*\.\?\(\)\$ ;,'%-]","",
rashes
($keyword))),30);

49 
	g$keywd
 = 
addashes
(
$keywd
);

50 
	g$wheSql
 .= " And (arc.titleike '%$keyword%') ";

52 if(
	g$cid
!=0)

54 
$wheSql
 ." Andrc.tyid i(".
GSIds
(
$cid
).")";

57 
	g$quy
 = "selectrc.aid,arc.aids id,arc.typeid,arc.senddate,arc.channel,arc.click,arc.title,arc.mid,tp.typename

58 
om
 `{
$cInfos
['addb']}` 
c


59 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


60 
$wheSql


61 
d
 
by
 
c
.
aid
 
desc
 ";

62 
$dli
 = 
w
 
DaLiCP
();

63 
	g$dli
->
	ggeSize
 = 20;

64 
	g$dli
->
SPam
("dopost","listArchives");

65 
	g$dli
->
SPam
("keywd",
$keywd
);

66 
	g$dli
->
SPam
("cid",
$cid
);

67 
	g$dli
->
SPam
("chlid",
$chlid
);

68 
	g$dli
->
STeme
(
DEDEMEMBER
."/templets/content_sg_list.htm");

69 
	g$dli
->
SSour
(
$quy
);

70 
	g$dli
->
Diy
();

	@member/control.php

1 <?
php


2 
hd
("location:index.php");

	@member/edit_baseinfo.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(!
	$ist
(
$do
))

6 
$do
 = '';

7 
	}
}

8 
	g$row
=
$dsql
->
GO
(" * from `#@__memb` whmid='".
$cfg_ml
->
M_ID
."'");

9 
	g$
 = 
$row
['face'];

10 if(
	g$do
=='save')

12 
$svi
 = 
GCkVdVue
();

14 if(
ow
(
$vdcode
!
$svi
 || $svali=='')

16 
RetVdVue
();

17 
ShowMsg
('验证码错误！','-1');

18 
ex
();

20 if(!
is_y
(
$row
|| 
	g$row
['pwd']!=
md5
(
$dpwd
))

22 
ShowMsg
('你输入的旧密码错误或没填写，不允许修改资料！','-1');

23 
ex
();

25 if(
	g$uwd
!=
$uwdok
)

27 
ShowMsg
('你两次输入的新密码不一致！','-1');

28 
ex
();

30 if(
	g$uwd
=='')

32 
$pwd
 = 
$row
['pwd'];

36 
	g$pwd
 = 
md5
(
$uwd
);

37 
	g$pwd2
 = 
subr
(
md5
(
$uwd
),5,20);

39 
	g$addupquy
 = '';

42 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

44 
	g$emaw
 = 
$ema
 !
$row
['email'] ? $email : '';

45 
	g$uesu
 = 
uc_ur_ed
(
$cfg_ml
->
M_LogID
, 
$dpwd
, 
$uwd
, 
$emaw
);

47 #/
a
}}

50 if(
	g$ema
 !
$row
['ema'] || (
$wquei
 !0 && 
$wsw
 != ''))

52 if(
$row
['quei']!=0 && ($row['quei'] !
$quei
 || $row['sw'] !
$sw
))

54 
ShowMsg
('你的旧安全问题及答案不正确，不能修改Email或安全问题！','-1');

55 
ex
();

59 if(
	g$ema
 !
$row
['email'])

61 if(!
CheckEma
(
$ema
))

63 
ShowMsg
('Email格式不正确！','-1');

64 
ex
();

68 
	g$addupquy
 .= ",email='$email'";

73 if(
	g$wquei
 !0 && 
$wsw
 != '')

75 if(

(
$wsw
) > 30)

77 
ShowMsg
('你的新安全问题的答案太长了，请保持在30字节以内！','-1');

78 
ex
();

82 
	g$addupquy
 .= ",safequestion='$newsafequestion',safeanswer='$newsafeanswer'";

88 if(
	g$ume
 !
$row
['uname'])

90 
$rs
 = 
CheckUrID
(
$ume
,'昵称或公司名称',
l
);

91 if(
	g$rs
!='ok')

93 
ShowMsg
(
$rs
,'-1');

94 
ex
();

96 
	g$addupquy
 .= ",uname='$uname'";

100 if!
_y
(
$x
,
y
('男','女','保密')) )

102 
ShowMsg
('请选择正常的性别！','-1');

103 
ex
();

106 
	g$quy1
 = "Upd`#@__memb` swd='$pwd',x='$x'{$addupquy} whmid='".
$cfg_ml
->
M_ID
."' ";

107 
	g$dsql
->
ExecuNeQuy
(
$quy1
);

110 if(
	g$cfg_ml
->
	gflds
['mt']==10 && 
$pwd2
!="")

112 
$quy2
 = "Upd`#@__adm` swd='$pwd2' whid='".
$cfg_ml
->
M_ID
."' ";

113 
	g$dsql
->
ExecuNeQuy
(
$quy2
);

115 
ShowMsg
('成功更新你的基本资料！','edit_baseinfo.php',0,5000);

116 
ex
();

118 
ude
(
DEDEMEMBER
."/templets/edit_baseinfo.htm");

	@member/edit_face.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(!
	$ist
(
$do
))

6 
$do
 = '';

7 
	}
}

8 if(!
	$ist
(
$backu
))

10 
$backu
 = 'edit_face.php';

11 
	}
}

12 if(
	g$do
=='save')

14 
$maxngth
 = 
$cfg_max_
 * 1024;

15 
	g$urd
 = 
$cfg_ur_d
.'/'.
$cfg_ml
->
M_ID
;

16 if(!
eg
('^'.
$urd
,
$d
))

18 
	g$d
 = '';

20 if(
is_uded_fe
(
$
))

22 if(@
fesize
(
$_FILES
['']['tmp_me']> 
	g$maxngth
)

24 
ShowMsg
("你上传的头像文件超过了系统限制大小：{$cfg_max_face} K！", '-1');

25 
ex
();

28 if(
egi
("\.(jpg|gif|g)$", 
$d
&& 
fe_exis
(
$cfg_bad
.$oldface))

30 @
uƚk
(
$cfg_bad
.
$d
);

33 
	g$
 = 
MembUds
('', 
$d
, 
$cfg_ml
->
M_ID
, 'image', 'myface', 180, 180);

37 
	g$
 = 
$d
;

39 
	g$quy
 = "update `#@__member` set `face` = '$face' where mid='{$cfg_ml->M_ID}' ";

40 
	g$dsql
->
ExecuNeQuy
(
$quy
);

41 
ShowMsg
('成功更新头像信息！', 
$backu
);

42 
ex
();

44 if(
	g$do
=='delold')

46 if(
emy
(
$d
))

48 
ShowMsg
("没有可删除的头像！", "-1");

49 
ex
();

51 
	g$urd
 = 
$cfg_ur_d
.'/'.
$cfg_ml
->
M_ID
;

52 if(!
eg
('^'.
$urd
, 
$d
))

54 
	g$d
 = '';

56 if(
egi
("\.(jpg|gif|g)$", 
$d
&& 
fe_exis
(
$cfg_bad
.$oldface))

58 @
uƚk
(
$cfg_bad
.
$d
);

60 
	g$quy
 = "update `#@__member` set `face` = '' where mid='{$cfg_ml->M_ID}' ";

61 
	g$dsql
->
ExecuNeQuy
(
$quy
);

62 
ShowMsg
('成功删除原来的头像！', 
$backu
);

63 
ex
();

66 
	g$
 = 
$cfg_ml
->
flds
['face'];

67 
ude
(
DEDEMEMBER
."/templets/edit_face.htm");

68 
ex
();

	@member/edit_fullinfo.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
.'/enums.func.php');

5 if(!
ist
(
$do
)
	g$do
 = '';

7 if(
	g$do
=='')

9 if(
$cfg_ml
->
M_MbTy
=='个人')

11 
$row
 = 
$dsql
->
GO
(" * from `#@__memb_rs` whmid='".
$cfg_ml
->
M_ID
."'");

12 if(!
is_y
(
$row
))

14 
	g$quy
 = "INSERT INTO `#@__member_person` (`mid` , `onlynet` , `sex` , `uname` , `qq` , `msn` , `tel` , `mobile` , `place` , `oldplace` ,

15 `
bthday
` , `
	g
` , `
	gcome
` , `
	geduti
` , `
	gheight
` , `
	gbodyty
` , `
	gblood
` , `
	gvoti
` , `
	gsmoke
` , `
	gm
` , `
	ghou
` ,

16 `
	gdrk
` , `
	gdgty
` , `
	gnguage
` , `
	gtu
` , `
	glovemsg
` , `
	gaddss
`,`
	guime
`)

17 
VALUES
 ('{$cfg_ml->M_ID}', '1', '{$cfg_ml->flds['
x
']}', '{$cfg_ml->flds['
ume
']}', '', '', '', '', '0', '0',

19 
	g$dsql
->
ExecuNeQuy
(
$quy
);

20 
	g$row
 = 
$dsql
->
GO
(" * from `#@__memb_rs` whmid='".
$cfg_ml
->
M_ID
."'");

21 if(!
is_y
(
$row
))

23 
ShowMsg
("系统出错，请联系管理员！","-1");

24 
ex
();

26 
	g$dsql
->
ExecuNeQuy
("update `#@__member` set spacesta=2 where mid='{$cfg_ml->M_ID}' And spacesta > -1 ");

28 
ude
(
DEDEMEMBER
."/templets/edit_info_person.htm");

30 
if
(
$cfg_ml
->
M_MbTy
=='企业')

32 
$row
 = 
$dsql
->
GO
(" * from `#@__memb_comny` whmid='".
$cfg_ml
->
M_ID
."'");

33 if(!
is_y
(
$row
))

35 
	g$uime
 = 
time
();

36 
	g$quy
 = "INSERT INTO `#@__member_company` (`mid`,`company`,`product`,`place`,`vocation`,`cosize`,`tel`,`fax`,`linkman`,`address`,`mobile`,`email`,`url`,`uptime`,`checked`,`introduce`)

37 
VALUES
 ('{$cfg_ml->M_ID}','{$cfg_ml->flds['
ume
']}','odu','0','0','0','','','','','','{$cfg_ml->flds['
ema
']}','','$uptime','0',''); ";

38 
	g$dsql
->
ExecuNeQuy
(
$quy
);

39 
	g$row
 = 
$dsql
->
GO
(" * from `#@__memb_comny` whmid='".
$cfg_ml
->
M_ID
."'");

40 if(!
is_y
(
$row
))

42 
ShowMsg
("系统出错，请联系管理员！","-1");

43 
ex
();

45 
	g$dsql
->
ExecuNeQuy
("update `#@__member` set spacesta=2 where mid='{$cfg_ml->M_ID}' And spacesta > -1 ");

47 
ude
(
DEDEMEMBER
."/templets/edit_info_company.htm");

48 
ex
();

52 
hd
('location:edit_baseinfo.php');

53 
ex
();

60 if(
	g$do
=='save')

62 if(
$cfg_ml
->
M_MbTy
=='个人')

64 if(
emy
(
$cy
)
$a
 = 
$ov
;

65 
	g$a
 = 
$cy
;

67 if(
emy
(
$dcy
)
	g$da
 = 
$dov
;

68 
	g$da
 = 
$dcy
;

70 if(!
ist
(
$tu
)
	g$u
 = '';

71 
	g$u
 = 
jo
(',',
$tu
);

73 if(!
ist
(
$nguage
)
	g$guage
 = '';

74 
	g$guage
 = 
jo
(',',
$nguage
);

76 if(
	g$bthday
==''
$bthday
 = '1980-01-01';

78 
	g$ume
 = 
HtmlR
(
$ume
,2);

79 
	g$ume
 = 
HtmlR
(
$ume
,2);

80 
	g$qq
 = 
GAbNum
(
$qq
);

81 
	g$m
 = 
HtmlR
(
$m
,2);

82 
	g$l
 = 
GAbNum
(
$l
);

83 
	g$mobe
 = 
GAbNum
(
$mobe
);

84 
	g$lovemsg
 = 
_subrR
(
HtmlR
(
$lovemsg
,0),100);

85 
	g$addss
 = 
_subrR
(
HtmlR
(
$addss
,1),50);

86 
	g$uime
 = 
time
();

88 
	g$row
 = 
$dsql
->
GO
("SELECT `x` FROM `#@__memb_rs` WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

89 
	g$x
 = 
ist
(
$row
['x']&& !
emy
($row['sex']) ? $row['sex'] : '保密';

91 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_person` where mid='{$cfg_ml->M_ID}' ");

92 
	g$quy
 = "Insert Into `#@__member_person`(`mid` ,`onlynet` ,`sex` ,`uname` ,`qq` ,`msn` ,`tel` ,`mobile` ,`place` ,`oldplace` ,

93 `
bthday
` ,`
	g
` ,`
	gcome
` ,`
	geduti
` ,`
	gheight
` , `
	gbodyty
` , `
	gblood
` , `
	gvoti
` , `
	gsmoke
` ,

94 `
	gm
` , `
	ghou
` ,`
	gdrk
` , `
	gdgty
` , `
	gnguage
` , `
	gtu
` , `
	glovemsg
` ,`
	guime
`, `
	gaddss
`)

95 
VALUES
 ('{$cfg_ml->M_ID}', '$lyt', '$x', '{$cfg_ml->flds['
ume
']}', '$qq', '$msn', '$tel', '$mobile', '$place', '$oldplace',

98 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

99 if(!
	g$rs
)

101 
ShowMsg
("保存信息时发生错误，请联系管理员！".
$dsql
->
GE
(),'javascript:;');

102 
ex
();

104 if(
	g$cfg_ml
->
	gM_Sa
 >= 0) {

105 
$dsql
->
ExecuNeQuy
("update `#@__member` set spacesta=2 where mid='{$cfg_ml->M_ID}' And spacesta < 2 ");

107 
ShowMsg
("成功修改你的资料！",'edit_fullinfo.php');

108 
ex
();

110 if(
	g$cfg_ml
->
	gM_MbTy
=='企业')

112 
$urd
 = 
$cfg_ur_d
.'/'.
$cfg_ml
->
M_ID
;

113 if(!
eg
('^'.
$urd
,
$dcom
))

115 
	g$dcom
 = '';

117 if(
is_uded_fe
(
$com
))

120 if(
	g$dcom
!='' && 
fe_exis
(
$cfg_bad
.
$dcom
))

122 @
uƚk
(
$cfg_bad
.
$dcom
);

125 
	g$com
 = 
MembUds
('com', '', 
$cfg_ml
->
M_ID
, 'image', 'comface', 600, 450);

129 
	g$com
 = 
$dcom
;

132 if(
emy
(
$cy
))

134 
	g$a
 = 
$ov
;

138 
	g$a
 = 
$cy
;

140 
	g$l
 = 
GAbNum
(
$l
);

141 
	g$x
 = 
GAbNum
(
$x
);

142 
	g$mobe
 = 
GAbNum
(
$mobe
);

143 
	g$ema
 = 
_subrR
(
egi_a
("[^0-9a-z\.@-]",'',
$ema
),50);

144 
	g$u
 = 
_subrR
(
egi_a
("[^0-9a-z\.:/-]",'',
$u
),50);

145 
	g$odu
 = 
_subrR
(
HtmlR
(
$odu
,1),20);

146 
	g$lkm
 = 
_subrR
(
HtmlR
(
$lkm
,1),20);

147 
	g$comny
 = 
_subrR
(
HtmlR
(
$comny
,1),36);

148 
	g$addss
 = 
_subrR
(
HtmlR
(
$addss
,1),50);

149 
	g$odu
 = 
HtmlR
(
$odu
,-1);

150 
	g$uime
 = 
time
();

151 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_company` where mid='{$cfg_ml->M_ID}' ");

152 
	g$quy
 = "INSERT INTO `#@__member_company` (`mid` , `company` , `product` , `place` , `vocation` , `cosize` , `tel` , `fax` , `linkman` , `address`,`uptime` ,`mobile`,`email`,`url`, `introduce` ,`comface`)

153 
VALUES
 ('{$cfg_ml->M_ID}','$company','$product','$place','$vocation','$cosize','$tel','$fax','$linkman','$address','$uptime','$mobile','$email','$url','$introduce', '$comface'); ";

154 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

155 if(!
	g$rs
)

157 
ShowMsg
("保存信息时发生错误，请联系管理员！".
$dsql
->
GE
(),'javascript:;');

158 
ex
();

160 if(
	g$cfg_ml
->
	gM_Sa
 >= 0) {

161 
$dsql
->
ExecuNeQuy
("update `#@__member` set spacesta=2 where mid='{$cfg_ml->M_ID}' And spacesta < 2 ");

163 
ShowMsg
("成功修改你的企业资料！",'edit_fullinfo.php');

167 
ShowMsg
('系统没提供 '.
$cfg_ml
->
M_MbTy
.' 用户的详细信息数据接口！', '-1');

168 
ex
();

	@member/edit_space_info.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(!
	$ist
(
$do
))

6 
$do
 = '';

7 
	}
}

9 if(
	g$do
=='save')

11 
$maxngth
 = 
$cfg_max_
 * 1024;

12 
	g$urd
 = 
$cfg_ur_d
.'/'.
$cfg_ml
->
M_ID
;

13 if(!
eg
('^'.
$urd
, 
$dalogo
))

15 
	g$dalogo
 = '';

17 if(
is_uded_fe
(
$alogo
))

19 if(@
fesize
(
$_FILES
['alogo']['tmp_me']> 
	g$maxngth
)

21 
ShowMsg
("你上传的Logo文件超过了系统限制大小：{$cfg_max_face} K！", '-1');

22 
ex
();

25 if(
egi
("\.(jpg|gif|g)$", 
$dalogo
&& 
fe_exis
(
$cfg_bad
.$oldspacelogo))

27 @
uƚk
(
$cfg_bad
.
$dalogo
);

30 
	g$alogo
 = 
MembUds
('alogo','',
$cfg_ml
->
M_ID
,'image','mylogo', 200, 50);

34 
	g$alogo
 = 
$dalogo
;

36 
	g$gesize
 = 
tv
(
$gesize
);

37 
	g$ame
 = 
_subrR
(
HtmlR
(
$ame
,2),50);

38 
	g$sign
 = 
_subrR
(
HtmlR
(
$sign
),100);

39 
	g$aws
 = 
HtmlR
(
$aws
,-1);

40 
	g$quy
 = "update `#@__member_space` set `pagesize` = '$pagesize',`spacename`='$spacename' , spacelogo='$spacelogo', `sign` = '$sign' ,`spacenews`='$spacenews' where mid='{$cfg_ml->M_ID}' ";

41 
	g$dsql
->
ExecuNeQuy
(
$quy
);

42 if(
	g$cfg_ml
->
	gM_Sa
 >= 0) {

43 
$dsql
->
ExecuNeQuy
("update `#@__member` set spacesta=1 where mid='{$cfg_ml->M_ID}' And spacesta < 1 ");

45 
ShowMsg
('成功更新空间信息！','edit_space_info.php');

46 
ex
();

50 
	g$row
 = 
$dsql
->
GO
(" * from `#@__memb_a` whmid='".
$cfg_ml
->
M_ID
."'");

51 if(!
is_y
(
$row
))

53 
	g$quy
 = "Insert Into `#@__member_space`(`mid` ,`pagesize` ,`matt` ,`spacename` ,`spacelogo` , `sign` ,`spacenews`)

54 
Vues
('{$cfg_ml->M_ID}', '10', '0', '{$cfg_ml->M_UserName}的空间', '', '', ''); ";

55 
	g$row
['spacename'] = '';

56 
	g$row
['sign'] = '';

57 
	g$row
['pagesize'] = 10;

58 
	g$row
['spacestyle'] = 'person';

59 
	g$row
['spacenews'] = '';

61 
exa
(
$row
);

62 
ude
(
dme
(
__FILE__
)."/templets/edit_space_info.htm");

63 
ex
();

	@member/feedback.php

1 <?
php


2 
	g$cfg_fmmemb
 = 
ue
;

3 
que_
(
dme
(
__FILE__
).'/../plus/feedback.php');

	@member/flink_main.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(
	g$cfg_mb_l
=='Y')

6 
ShowMsg
("由于系统开启了精简版会员空间，你访问的功能不可用！","-1");

7 
ex
();

9 if(
	$emy
(
$do
))

11 
$do
 = '';

12 
	}
}

13 if(
	g$do
=="addnew")

15 
AjaxHd
();

16 
	g$row
 = 
$dsql
->
GO
("Se cou(*add From `#@__memb_k` whmid='".
$cfg_ml
->
M_ID
."' ");

17 if(
	g$row
['dd']>=50)

19 
echo
 "<font color='red'>增加网址失败，因为已经达到五十个网址的上限！</font>";

20 
GLkLi
(
$dsql
);

21 
ex
();

23 if(!
egi
("^hp://",
$u
))

25 
	g$u
 = "hp://".
HtmlR
(
$u
, 2);

27 
	g$t
 = 
HtmlR
(
$t
);

28 
	g$quy
 = "INSERT INTO `#@__memb_k`(mid,t,uVALUES(".
$cfg_ml
->
M_ID
.",'$title','$url'); ";

29 
	g$dsql
->
ExecuNeQuy
(
$quy
);

30 
	gecho
 "<font color='red'>成功增加一链接！</font>";

31 
GLkLi
(
$dsql
);

32 
ex
();

34 if(
	g$do
=="del")

36 
AjaxHd
();

37 
	g$aid
 = 
tv
(
$aid
);

38 if(
emy
(
$aid
))

40 
ex
("<font color='red'>参数错误！</font>");

42 
	g$dsql
->
ExecuNeQuy
("DFrom `#@__memb_k` whaid='$aid' And mid='".
$cfg_ml
->
M_ID
."';");

43 
	gecho
 "<font color='red'>成功删除链接：{$aid}</font>";

44 
GLkLi
(
$dsql
);

46 if(
	g$do
=="update")

48 
AjaxHd
();

49 
	g$aid
 = 
tv
(
$aid
);

50 if(!
egi
("^hp://",
$u
))

52 
	g$u
 = "hp://".
HtmlR
(
$u
,2);

54 
	g$t
 = 
HtmlR
(
$t
);

55 
	g$upquy
 = "Upd`#@__memb_k` s='$t',u='$u' whaid='$aid' And mid='".
$cfg_ml
->
M_ID
."'; ";

56 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$upquy
);

57 if(
	g$rs
)

59 
	gecho
 "<font color='red'>成功更新链接：{$title}</font>";

60 
GLkLi
(
$dsql
);

61 
ex
();

65 
	gecho
 "<font color='red'>更新链接：{$title} 失败！</font>";

66 
GLkLi
(
$dsql
);

67 
ex
();

70 if(
	g$do
=="reload")

72 
AjaxHd
();

73 
GLkLi
(
$dsql
);

74 
ex
();

80 
que_
(
dme
(
__FILE__
)."/templets/flink_main.htm");

81 
ex
();

85 
funi
 
	$GLkLi
(
$dsql
)

87 
glob
 
$cfg_ml
;

88 
$dsql
->
	`SQuy
("Se * From `#@__memb_k` whmid='".
$cfg_ml
->
M_ID
."' order byid desc");

89 
$dsql
->
	`Execu
();

90 
$j
=0;

91 
$row
 = 
$dsql
->
	`GAay
())

93 
$j
++;

94 
$le
 = "

95 <
div
 
ass
='item flink'>

96 <
div
 
ass
='itemHead' >

97 <
div
 
ass
='fRight'>

98 <

 
ass
='emDigg'><
a
 
hf
='#' 
ick
='UpdeTy({$row['
aid
']})'>[更新]</a></span>

99 <

 
ass
='emMage'><
a
 
hf
='#' 
ick
='DTy({$row['
aid
']})'>[删除]</a></span>

100 </
div
>

101 <

 
ass
='emT'>名称：<
put
 
me
='t{$row['
aid
']}' 
ty
='xt' 
id
='t{$row['aid']}' 
vue
='{$row['
t
']}' class='text' /></span>

102 <
div
 
ass
=' mT10'>网址：<
put
 
me
='u{$row['
aid
']}' 
ty
='xt' 
id
='u{$row['aid']}' 
vue
='{$row['
u
']}' class='text' /></div>

103 </
div
>

104 </
div
>

105 <
hr
 
ass
='dotted' />";

106 
echo
 
$le
;

108 if(
$j
==0)

110 
echo
 "尚无任何链接";

112 
	}
}

	@member/guestbook_admin.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
	g$gesize
 = 
ist
(
$gesize
&& 
is_numic
($pagesize) ? $pagesize : 5;

5 
	g$go
 = 
ist
(
$go
&& 
is_numic
($go? 
	$max
(1,
$go
) : 1;

6 if(
	$emy
(
$do
))

8 
$do
 = '';

9 
	}
}

12 if(
	g$do
=='getlist')

14 
AjaxHd
();

15 
GLi
(
$dsql
,
$go
,
$gesize
);

16 
ex
();

20 if(
	g$do
=='del')

22 if(!
emy
(
$aid
))

24 
$aid
 = 
tv
($aid);

25 
	g$dsql
->
ExecuNeQuy
("DFrom `#@__memb_guebook` whaid='$aid' And mid='".
$cfg_ml
->
M_ID
."'; ");

27 if(!
emy
(
$ids
))

29 
	g$ids
 = 
eg_a
("[^0-9,]",'',
$ids
);

30 if(
	g$ids
!='')

32 
$dsql
->
ExecuNeQuy
("DFrom `#@__memb_guebook` whaid in($idsAnd mid='".
$cfg_ml
->
M_ID
."'; ");

35 
AjaxHd
();

36 
GLi
(
$dsql
,
$go
,
$gesize
);

37 
ex
();

41 if(
	g$do
=='')

43 
$row
 = 
$dsql
->
GO
("Se cou(*add From `#@__memb_guebook` whmid='".
$cfg_ml
->
M_ID
."'; ");

44 
	g$tٮRow
 = 
$row
['dd'];

45 
ude
(
dme
(
__FILE__
)."/templets/guestbook_admin.htm");

49 
funi
 
	$GLi
(
$dsql
,
$go
,
$gesize
)

51 
glob
 
$cfg_phpu
,
$cfg_ml
;

52 
$gesize
 = 
	`tv
($pagesize);

53 
$go
 = 
	`tv
($pageno);

54 
$t
 = (
$go
-1* 
$gesize
;

55 
$dsql
->
	`SQuy
("Se * From `#@__memb_guebook` whmid='".
$cfg_ml
->
M_ID
."' order byid descimit $start,$pagesize ");

56 
$dsql
->
	`Execu
();

57 
$le
 = '';

58 
$row
 = 
$dsql
->
	`GAay
())

61 
$le
 .= "<table cellspacing='1' class='list mB10'>

62 <
thd
>

63 <

>

64 <
th
 
cޥ
='2' ><
rg
 
ass
='fLe'>留言标题：".$row['t']."</rg><

 class='fRight'>

65 <
put
 
me
=\"ids\"y=\"checkbox\" id=\"ids\" vue=\"".
$row
['aid']."\" />

66 <
a
 
hf
='#' 
ick
='DNe(".$row['
aid
'].")'>删除</a></

></
th
>

67 </

>

68 </
thd
>

69 <
tbody
>

70 <

>

71 <
td
 
width
='15%' 
ign
='' 
vign
='top'>用户称呼：".$row['uname']."</td>

72 <
td
>时间：".MyDe("
Y
-
m
-
d
 
H
:
i
",$row['dtime'])."&
nb
;
IP
地址：".$row['ip']."&nbsp;";

74 if(!
	`emy
(
$row
['gid']))

76 
$le
 .= " <a href='index.php?uid={$row['uname']}&action=infos'arget='_blank'>资料</a> <a href='index.php?uid={$row['uname']}'arget='_blank'>空间</a> <a href='index.php?uid={$row['uname']}&action=guestbook'arget='_blank'>回复</a> ";

78 
$le
 .= "

79 </
td
>

80 </

>

81 <

>

82 <
td
 
ign
='' 
vign
='t'><
p
>
Ema
：".$row['email']."</p><p>联系电话：".$row['tel']."</p><p>其它：".$row['qq']."</p></td>

83 <
td
 
ign
='' 
vign
='top'>".Text2Html($row['msg'])."</td>

84 </

>

85 </
tbody
>

86 </
b
>";

89 
$le
 = $line == '' ? '暂无留言' : $line;

90 
echo
 
$le
;

91 
	}
}

	@member/inc/archives_check.php

1 <?
php


2 if(!
defed
('DEDEMEMBER')
ex
('dedecms');

4 
ude_
(
DEDEINC
.'/image.func.php');

5 
ude_
(
DEDEINC
.'/oxwindow.class.php');

6 if(!
	g$cfg_ml
->
IsLog
(|| 
	g$cfg_vdcode_memb
=='Y')

8 
$svi
 = 
GCkVdVue
();

9 if(
ow
(
$vdcode
)!=
$svi
 || $svali=='')

11 
RetVdVue
();

12 
ShowMsg
('验证码错误！', '-1');

13 
ex
();

17 
	g$ag
 = '';

18 
	g$autokey
 = 
$me
 = 
$dlk
 = 
$autޙpic
 = 0;

19 
	g$ur
 = 
GIP
();

21 if(
	g$tyid
==0)

23 
ShowMsg
('请指定文档隶属的栏目！', '-1');

24 
ex
();

27 
	g$quy
 = "Selectp.ispart,tp.channeltype,tp.issend,ch.issends cissend,ch.sendrank,ch.arcsta,ch.addtable,ch.usertype

28 
From
 `#@
__y
` 

 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
p.
chy
 
whe
p.id='$typeid' ";

29 
$cInfos
 = 
$dsql
->
GO
(
$quy
);

32 if(
	g$cInfos
['isnd']!=1 || 
$cInfos
['it']!=0 || $cInfos['chy']!=
$chlid
 || $cInfos['cissend']!=1)

34 
ShowMsg
("你所选择的栏目不支持投稿！","-1");

35 
ex
();

39 if(
	g$cInfos
['ndnk'] > 
	g$cfg_ml
->
	gM_Rk
 )

41 
	g$row
 = 
$dsql
->
GO
("Se membmFrom #@__k whnk='".
$cInfos
['sendrank']."' ");

42 
ShowMsg
("对不起，需要[".
$row
['membername']."]才能在这个频道发布文档！","-1","0",5000);

43 
ex
();

46 if(
	g$cInfos
['uy'] !='' && 
$cInfos
['uy'] !
$cfg_ml
->
M_MbTy
)

48 
ShowMsg
("对不起，需要[".
$cInfos
['usertype']."]才能在这个频道发布文档！","-1","0",5000);

49 
ex
();

53 if(
	g$cInfos
['arcsta']==0)

55 
$ismake
 = 0;

56 
	g$k
 = 0;

58 if(
	g$cInfos
['arcsta']==1)

60 
$ismake
 = -1;

61 
	g$k
 = 0;

65 
	g$ismake
 = 0;

66 
	g$k
 = -1;

70 
	g$mey
 = 0;

71 
	g$ag
 = 
$sh܉
 = 
$c
 = 
$sour
 = '';

72 
	g$s܌k
 = 
$ndde
 = 
$pubde
 = 
time
();

73 
	g$t
 = 
_subrR
(
HtmlR
(
$t
,1),
$cfg_t_maxn
);

74 
	g$wr
 = 
_subrR
(
HtmlR
(
$wr
,1),20);

75 if(
emy
(
$desti
)
	g$desti
 = '';

76 
	g$desti
 = 
_subrR
(
HtmlR
(
$desti
,1),250);

77 
	g$keywds
 = 
_subrR
(
HtmlR
(
$gs
,1),30);

78 
	g$mid
 = 
$cfg_ml
->
M_ID
;

81 
	g$lpic
 = 
MembUds
('lpic','',
$cfg_ml
->
M_ID
,'image','',
$cfg_ddimg_width
,
$cfg_ddimg_height
,
l
);

82 if(
	g$lpic
!='')

84 
SaveUdInfo
(
$t
,
$lpic
,1);

88 if(
	g$cfg_mb_ckt
=='Y')

90 
$row
 = 
$dsql
->
GO
("Select * From `#@__archives` whereitleike '$title' ");

91 if(
is_y
(
$row
))

93 
ShowMsg
("对不起，请不要发布重复文档！","-1","0",5000);

94 
ex
();

	@member/inc/archives_check_edit.php

1 <?
php


2 if(!
defed
('DEDEMEMBER')
ex
('dedecms');

4 
que_
(
DEDEINC
."/image.func.php");

5 
que_
(
DEDEINC
."/oxwindow.class.php");

7 
	g$ag
 = '';

8 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

9 
	g$ur
 = 
GIP
();

10 
	g$ckhash
 = 
md5
(
$aid
.
$cfg_cook_code
);

11 if(
	g$ckhash
!=
$idhash
)

13 
ShowMsg
('校对码错误，你没权限修改此文档或操作不合法！','-1');

14 
ex
();

16 if(
	g$tyid
==0)

18 
ShowMsg
('请指定文档隶属的栏目！','-1');

19 
ex
();

21 
	g$quy
 = "Selectp.ispart,tp.channeltype,tp.issend,ch.issends cissend,ch.sendrank,ch.arcsta,ch.addtable,ch.usertype

22 
From
 `#@
__y
` 

 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
p.
chy
 
whe
p.id='$typeid' ";

23 
$cInfos
 = 
$dsql
->
GO
(
$quy
);

24 
	g$addb
 = 
$cInfos
['addtable'];

27 if(
	g$cInfos
['isnd']!=1 || 
$cInfos
['it']!=0|| $cInfos['chy']!=
$chlid
 || $cInfos['cissend']!=1)

29 
ShowMsg
("你所选择的栏目不支持投稿！","-1");

30 
ex
();

34 if(
	g$cInfos
['arcsta']==0)

36 
$ismake
 = 0;

37 
	g$k
 = 0;

39 if(
	g$cInfos
['arcsta']==1)

41 
$ismake
 = -1;

42 
	g$k
 = 0;

46 
	g$ismake
 = 0;

47 
	g$k
 = -1;

51 
	g$t
 = 
_subrR
(
HtmlR
(
$t
,1),
$cfg_t_maxn
);

52 
	g$wr
 = 
_subrR
(
HtmlR
(
$wr
,1),20);

53 if(
emy
(
$desti
)
	g$desti
 = '';

54 
	g$desti
 = 
_subrR
(
HtmlR
(
$desti
,1),250);

55 
	g$keywds
 = 
_subrR
(
HtmlR
(
$gs
,1),30);

56 
	g$mid
 = 
$cfg_ml
->
M_ID
;

57 
	g$idm
 = (
$cfg_ml
->
flds
['mt']==10 ? 
ue
 : 
l
);

59 
	g$lpic
 = 
MembUds
('lpic', 
$dlpic
, 
$mid
, 'image', '', 
$cfg_ddimg_width
, 
$cfg_ddimg_height
, 
l
, 
$idm
);

60 if(
	g$lpic
 != '')

62 
SaveUdInfo
(
$t
, 
$lpic
, 1);

66 
	g$lpic
 =
$dlpic
;

	@member/inc/config_pay_alipay.php

1 <?
php


2 
que_
(
DEDEMEMBER
."/paycenter/alipay/alipay_config.php");

3 
que_
(
DEDEMEMBER
."/paycenter/alipay/alipay_service.php");

4 if(
	g$ymt_exp
[2] < 0) $payment_exp[2] = 0;

5 
	g$pii_ex
 = 
$i
*
$ymt_exp
[2];

6 
	g$m
 = 
y
(

8 "r" => 
$r
,

9 "tu_u" => 
$tu_u
,

10 "nify_u" => 
$nify_u
,

11 "_put_cht" => 
$_put_cht
,

12 "subje" => 
$y
,

13 "body" => 
$ame
,

14 "out_ade_no" => 
$buyid
,

19 "i" => 
rtf
("%01.2f", 
$i
),

22 "show_u" => 
$show_u
,

23 "Δ_ema" => 
$Δ_ema


25 
	g$ay
 = 
w
 
ay_rvi
(
$m
,
$cury_code
,
$sign_ty
);

26 
	g$lk
 = 
$ay
->
_u
();

28 
	gecho
 '<html>

29 <
	ghd
>

30 <
	gt
>转到支付宝支付页面</title>

31 </
	ghd
>

32 <
body
 
	gLd
="document.alipay.submit();">

33 <
fm
 
me
="ay" 
ai
="'.$lk.'" 
mhod
="post">

34 </
fm
>

35 </
body
>

36 </
html
>';

37 
ex
;

	@member/inc/config_pay_cbpayment.php

1 <?
php


2 
que_
(
DEDEMEMBER
."/paycenter/cbpayment/cbpayment_config.php");

3 if(
	g$ymt_exp
[3] < 0) $payment_exp[3] = 0;

4 
	g$pii_ex
 = 
$i
*
$ymt_exp
[3];

6 
	g$v_oid
 = 
im
(
$buyid
);

7 if(
	g$pii_ex
 > 0
	g$i
 = 
$i
+
$pii_ex
;

8 
	g$v_amou
 = 
rtf
("%01.2f", 
$i
);

10 
	g$xt
 = 
$v_amou
.
$v_meyty
.
$v_oid
.
$v_mid
.
$v_u
.
$key
;

11 
	g$v_md5fo
 = 
ou
(
md5
(
$xt
));

13 
	g$mk1
 = 
im
(
$y
);

14 
	g$mk2
 = 
im
(
$ame
);

16 
	g$v_rcvme
 = '站长';

17 
	g$v_rcvaddr
 = '深圳';

18 
	g$v_rcvl
 = '0755-83791960';

19 
	g$v_rcvpo
 = '100080';

20 
	g$v_rcvmobe
 = '13838384381';

22 
	g$v_dme
 = 
$cfg_ml
->
M_UrName
;

23 
	g$v_daddr
 = '深圳';

24 
	g$v_dl
 = '0755-83791960';

25 
	g$v_dpo
 = 518000;

26 
	g$v_dema
 = 'service@nps.cn';

27 
	g$v_dmobe
 = 13838384581;

29 
	g$rRequeU
 = 
$v_po_u
.'?v_mid='.
$v_mid
.'&v_oid='.
$v_oid
.'&v_amou='.
$v_amou
.'&v_meyty='.
$v_meyty


30 .'&v_u='.
$v_u
.'&v_md5fo='.
$v_md5fo
.'&mk1='.
$mk1
.'&mk2='.
$mk2
;

32 
	gecho
 '<html>

33 <
	ghd
>

34 <
	gt
>转到网银在线支付页面</title>

35 </
	ghd
>

36 <
body
 
	gld
="document.cbpayment.submit();">

37 <
fm
 
me
="cbymt" 
ai
="'.$rRequeU.'" 
mhod
="post">

38 </
fm
>

39 </
body
>

40 </
html
>';

41 
ex
;

	@member/inc/config_pay_nps.php

1 <?
php


3 
ude_
 
	gDEDEMEMBER
.'/paycenter/nps/nps_config.inc.php';

5 if(
	g$ymt_exp
[1] < 0.01) $payment_exp[1] = 0;

6 
	g$pii_ex
 = 
$i
*
$ymt_exp
[1];

7 
	g$i
 = 
$i
+
$pii_ex
;

9 
funi
 
	$HexToS
(
$hex
)

11 
$rg
="";

12 
$i
=0;$i<
	`
(
$hex
)-1;$i+=2){ 
$rg
.=
	`chr
(
	`hexdec
($hex[$i].$hex[$i+1])); }

13  
$rg
;

14 
	}
}

16 
funi
 
	$SToHex
(
$rg
)

18 
$hex
="";

19 
$i
=0;$i<
	`
(
$rg
);$i++){ 
$hex
.=
	`dechex
(
	`d
($string[$i])); }

20 
$hex
=
	`ou
($hex);

21  
$hex
;

22 
	}
}

25 
	g$m_nguage
 = 1;

26 
	g$s_me
 = "陈康";

27 
	g$s_addr
 = "深圳";

28 
	g$s_pocode
 = 518000;

29 
	g$s_l
 = "0755-83791960";

30 
	g$r_me
 = "陈大康";

31 
	g$r_addr
 = "深圳";

32 
	g$r_pocode
 = 100080;

33 
	g$r_l
 = "010-81234567";

34 
	g$r_eml
 = "service@nps.cn";

35 
	g$m_us
 = 0;

36 
	g$m_ocucy
 = 1;

38 
	g$m_id
 = 
$cfg_mcht
;

39 
	g$m_did
 = 
$buyid
;

40 
	g$m_mou
 = 
$i
;

41 
	g$m_u
 = 
$cfg_baho
."/paycenter/nps/pay_back_nps.php";

42 
	g$m_ocommt
 = 
$cfg_ml
->
M_ID
;

43 
	g$mode
 = 
GDeTimeMk
(
$mtime
);

47 
	g$m_fo
 = 
$m_id
."|".
$m_did
."|".
$m_mou
."|".
$m_ocucy
."|".
$m_u
."|".
$m_nguage
;

48 
	g$s_fo
 = 
$s_me
."|".
$s_addr
."|".
$s_pocode
."|".
$s_l
."|".
$s_eml
;

49 
	g$r_fo
 = 
$r_me
."|".
$r_addr
."|".
$r_pocode
."|".
$r_l
."|".
$r_eml
."|".
$m_ocommt
."|".
$m_us
."|".
$mode
;

51 
	g$OrdInfo
 = 
$m_fo
."|".
$s_fo
."|".
$r_fo
;

54 
	g$OrdInfo
 = 
SToHex
(
$OrdInfo
);

55 
	g$dige
 = 
ou
(
md5
(
$OrdInfo
.
$cfg_msswd
));

57 
	g$rRequeU
 = 
$ymt_u
.'?OrdMesge='.
$OrdInfo
.'&dige='.
$dige
.'&M_ID='.
$cfg_mcht
;

60 
	gecho
 '<html>

61 <
	ghd
>

62 <
	gt
>转到
	gNPS
支付页面</title>

63 </
	ghd
>

64 <
body
 
	gld
="document.nps.submit();">

65 <
fm
 
me
="s" 
ai
="'.$rRequeU.'" 
mhod
="post">

66 </
fm
>

67 </
body
>

68 </
html
>';

69 
ex
;

	@member/inc/config_pay_tenpay.php

1 <?
php


4 
	g$rSpid
 = 
$ymt_urid
[0];

6 
	g$rSpkey
 = 
$ymt_key
[0];

17 if(!
ist
(
$BkTy
)
	g$BkTy
 = 0;

18 
	g$BkTy
 = 
eg_a
("[^0-9]","",
$BkTy
);

19 if(
	g$BkTy
 < 1) $BankType = 0;

20 
	g$rBkTy

$BkTy
;

21 
	g$rCmdNo
 = "1";

22 
	g$rBlDe

de
('Ymd');

24 if(!
ist
(
$ame
)
	g$ame
 = '服务购买';

25 
	g$rDesc
 = 
$ame
;

27 
	g$rBuyId
 = "";

29 
	g$rS
 = 
$ymt_urid
[0];

31 if(
	g$ymt_exp
[0] < 0) $payment_exp[0] = 0;

32 
	g$pii_ex
 = 
$i
*
$ymt_exp
[0];

33 
	g$i
 = 
$i
+
$pii_ex
;

35 
	g$rTٮF
 = 
$i
*100;

36 if
	g$rTٮF
 < 1){

37 
	g$dsql
->
Clo
();

38 
ex
('金额不对');

40 
	g$rSpBlNo
 = 
$buyid
;;

45 
	g$rTniId
 = 
$rSpid
 . 
$rBlDe
 . 
time
();

47 
	g$rFTy
 = "1";

49 
	g$rRU
 = 
$cfg_baho
."/member/paycenter/tenpay/notify_handler.php";

51 
	g$rAach
 = "my_magic_string";

53 
	g$rSignText
 = "cmdno=" . 
$rCmdNo
 . "&de=" . 
$rBlDe
 . "&bga_id=" . 
$rS
 .

54 "&i_id=" . 
$rTniId
 . "&_bo=" . 
$rSpBlNo
 .

55 "&tٮ_e=" . 
$rTٮF
 . "&e_ty=" . 
$rFTy
 . "&tu_u=" . 
$rRU
 .

56 "&ch=" . 
$rAach
 . "&key=" . 
$rSpkey
;

57 
	g$rSign
 = 
ou
(
md5
(
$rSignText
));

60 
	g$rReque
 = "cmdno=" . 
$rCmdNo
 . "&de=" . 
$rBlDe
 . "&bga_id=" . 
$rS
 .

61 "&i_id=" . 
$rTniId
 . "&_bo=" . 
$rSpBlNo
 .

62 "&tٮ_e=" . 
$rTٮF
 . "&e_ty=" . 
$rFTy
 . "&tu_u=" . 
$rRU
 .

63 "&ch=" . 
$rAach
 . "&bk_ty=" . 
$rBkTy
 . "&desc=" . 
$rDesc
 .

64 "&purchar_id=" . 
$rBuyId
 .

65 "&sign=" . 
$rSign
 ;

66 
	g$rRequeU
 = "hps://www.ay.com/cgi-b/v1.0/y_ge.cgi?".
$rReque
;

69 if(
	g$cfg_so_ng
 == 'utf-8')

71 
$rRequeU
 = 
utf82gb
($strRequestUrl);

72 
	gecho
 '<html>

73 <
	ghd
>

74 <
	gt
>转到财付通支付页面</title>

75 </
	ghd
>

76 <
body
 
	gld
="document.tenpay.submit();">

77 <
fm
 
me
="ay" 
ai
="y/ay/ay_gbk_ge.php?rReU='.ucode($rRequeU).'" 
mhod
="post">

78 </
fm
>

79 </
body
>

80 </
html
>'; 

82 
	gecho
 '<html>

83 <
	ghd
>

84 <
	gt
>转到财付通支付页面</title>

85 </
	ghd
>

86 <
body
 
	gld
="document.tenpay.submit();">

87 <
fm
 
me
="ay" 
ai
="'.$rRequeU.'" 
mhod
="post">

88 </
fm
>

89 </
body
>

90 </
html
>';

92 
	gex
;

	@member/inc/config_pay_yeepay.php

1 ﻿<?
php


2 
ude_
 
	gDEDEMEMBER
.'/paycenter/yeepay/yeepay_config.php';

4 if(
	g$ymt_exp
[4] < 0) $payment_exp[4] = 0;

5 
	g$pii_ex
 = 
$i
*
$ymt_exp
[4];

7 if(
	g$pii_ex
 > 0
	g$i
 = 
$i
+
$pii_ex
;

10 ##易宝支付平台统一使用
GBK
/
GB2312
编码方式,参数如用到中文，请注意转码

14 
	g$p2_Ord
 = 
im
(
$buyid
);

18 
	g$p3_Amt
 = 
$i
;

21 
	g$p4_Cur
 = "CNY";

25 
	g$p5_Pid
 = 
im
(
$ame
);

28 
	g$p6_Pt
 = 
im
(
$y
);

31 
	g$p7_Pdesc
 = '';

34 
	g$p8_U
 = 
$cfg_baho
.'/member/paycenter/yeepay/callback.php';

37 ##商户可以任意填写1
K
 的字符串,支付成功时将原样返回.

38 
	g$_MP
 = 'member';

42 
	g$_NdReڣ
 = 1;

46 
	g$pd_FId
 = '';

48 
	g$hmac
 = 
gReqHmacSg
(
$p2_Ord
,
$p3_Amt
,
$p4_Cur
,
$p5_Pid
,
$p6_Pt
,
$p7_Pdesc
,
$p8_U
,
$_MP
,
$pd_FId
,
$_NdReڣ
);

49 
	g$qURL_LeCmd
 = 'paycenter/yeepay/yeepay_gbk.php';

50 
	gecho
 '

51 <
	ghtml
>

52 <
	ghd
>

53 <
	gt
>
To
 
YPay
 
	gPage
</title>

54 <
body
 
	gld
="document.yeepay.submit();">

55 <
fm
 
me
="yy" 
ai
="'.$qURL_LeCmd.'" 
mhod
="post">

56 <
put
 
ty
="hidd" 
me
="p0_Cmd" 
vue
="'.$p0_Cmd.'">

57 <
put
 
ty
="hidd" 
me
="p1_MId" 
vue
="'.$p1_MerId.'">

58 <
put
 
ty
="hidd" 
me
="p2_Ord" 
vue
="'.$p2_Order.'">

59 <
put
 
ty
="hidd" 
me
="p3_Amt" 
vue
="'.$p3_Amt.'">

60 <
put
 
ty
="hidd" 
me
="p4_Cur" 
vue
="'.$p4_Cur.'">

61 <
put
 
ty
="hidd" 
me
="p5_Pid" 
vue
="'.$p5_Pid.'">

62 <
put
 
ty
="hidd" 
me
="p6_Pt" 
vue
="'.$p6_Pcat.'">

63 <
put
 
ty
="hidd" 
me
="p7_Pdesc" 
vue
="'.$p7_Pdesc.'">

64 <
put
 
ty
="hidd" 
me
="p8_U" 
vue
="'.$p8_Url.'">

65 <
put
 
ty
="hidd" 
me
="p9_SAF" 
vue
="'.$p9_SAF.'">

66 <
put
 
ty
="hidd" 
me
="_MP" 
vue
="'.$pa_MP.'">

67 <
put
 
ty
="hidd" 
me
="pd_FId" 
vue
="'.$pd_FrpId.'">

68 <
put
 
ty
="hidd" 
me
="_NdReڣ" 
vue
="'.$pr_NeedResponse.'">

69 <
put
 
ty
="hidd" 
me
="hmac" 
vue
="'.$hmac.'">

70 <
put
 
ty
="hidd" 
me
="ng" 
vue
="'.$cfg_soft_lang.'">

71 <
put
 
ty
="hidd" 
me
="qURL_Le" 
vue
="'.$reqURL_onLine.'">

72 </
fm
>

73 </
body
>

74 </
html
>';exit;

	@member/inc/config_space.php

1 <?
php


2 if(!
defed
('DEDEMEMBER')
ex
('dedecms');

5 if(
	g$cfg_mb_ݒ
=='N')

7 
ShowMsg
("系统关闭了会员功能，因此你无法访问此页面！","javascript:;");

8 
ex
();

11 
	g$_vs
 = 
GUrSInfos
();

12 
	g$_vs
['bloglks'] = 
$_vs
['curtitle'] = '';

17 if(
	g$_vs
['spacesta'] == -2)

19 
ShowMsg
("用户：{$_vars['userid']} 被禁言，因此个人空间禁止访问！", "-1");

20 
ex
();

23 if(
	g$_vs
['spacesta'] < 0)

25 
ShowMsg
("用户：{$_vars['userid']} 的资料尚未通过审核，因此空间禁止访问！", "-1");

26 
ex
();

29 if!
ist
(
$_vs
['mt']
	g$_vs
['matt'] = 0;

30 if(
	g$_vs
['mt'] =10 && 
$cfg_mb_admlock
=='Y'

31 && !
ist
(
$cfg_ml
->
flds
) && $cfg_ml->fields['matt']==10 ))

33 
ShowMsg
('系统设置了禁止访问管理员的个人空间！', '-1');

34 
ex
();

39 if(
	g$_vs
['spacestyle']=='')

41 if(
$_vs
['mtype']=='个人') {

42 
$_vs
['spacestyle'] = 'person';

44 if(
	g$_vs
['mtype']=='企业') {

45 
$_vs
['spacestyle'] = 'company';

48 
	g$_vs
['spacestyle'] = 'person';

52 if(!
is_d
(
DEDEMEMBER
.'/a/'.
$_vs
['spacestyle']))

54 
	g$_vs
['spacestyle'] = 'person';

58 
	g$mtyr
 = 
y
();

59 
	g$dsql
->
Execu
('mty', " * from `#@__mtys` whmid='".
$_vs
['mid']."'");

60 
	g$row
 = 
$dsql
->
GAay
('mty'))

62 
$mtyr
[] = 
$row
;

66 
	g$_vs
['bloglks'] = 
y
();

67 
	g$quy
 = "selectp.channeltype,ch.typename from `#@__arctype`p 

68 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=

.
chy


69 
whe
 (
ch
.
uy
='' 
OR
 ch.uy 
like
 '{$_vs['
mty
']}'
And
 

.
chy
<>1 Andp.
isnd
=1 Andp.
ishidd
=0 
group
 
by
p.chy 
d
 by 
	$ABS
(

.
chy

asc
";

70 
$dsql
->
	`Execu
('c', 
$quy
);

71  
$row
 = 
$dsql
->
	`GAay
('ctc') )

73 
$_vs
['bloglks'][
$row
['channeltype']] = $row['typename'];

74 
	}
}

78 if(
	g$_vs
['mtype']=='企业')

80 
que_
(
DEDEINC
.'/enums.func.php');

81 
	g$quy
 = " * from `#@__memb_comny` whmid='".
$_vs
['mid']."'";

82 
	g$comny
 = 
$db
->
GO
(
$quy
);

83 
	g$comny
['voti'] = 
GEnumsVue
('voti', 
$comny
['vocation']);

84 
	g$comny
['cosize'] = 
GEnumsVue
('cosize', 
$comny
['cosize']);

85 
	g$tm
 = 
GEnumsTys
(
$comny
['place']);

86 
	g$ovid
 = 
$tm
['top'];

87 
	g$ovme
 = (
ist
(
$em_tivs
[
$ovid
]) ? $em_nativeplaces[$provinceid] : '');

88 
	g$cyme
 = (
ist
(
$em_tivs
[
$tm
['son']]) ? $em_nativeplaces[$tmpplace['son']] : '');

89 
	g$comny
['a'] = 
$ovme
.' - '.
$cyme
;

90 
	g$_vs
 = 
y_mge
(
$comny
, 
$_vs
);

91 if(
	g$ai
 ='fos'
$ai
 = 'introduce';

92 
	g$_vs
['com'] = 
emy
(
$_vs
['comface']) ? 'images/comface.png' : $_vars['comface'];

100 
funi
 
	$GUrSInfos
()

102 
glob
 
$dsql
,
$uid
,
$cfg_membu
;

103 
$_vs
 = 
	`y
();

104 
$urid
 = 
	`eg_a
("[\r\n\\*%]",'',
$uid
);

105 
$quy
 = "Select m.mid,m.mtype,m.userid,m.uname,m.sex,m.rank,m.email,m.scores,

106 
m
.
aa
,m.

,m.
logtime
,

107 
s
.*,
t
.*,
r
.
membme
,
m
.
mt


108 
From
 `#@
__memb
` 
m


109 

 
jo
 `#@
__memb_a
` 
s
 

 s.
mid
=
m
.mid

110 

 
jo
 `#@
__memb_tj
` 
t
 

.
mid
=
m
.mid

111 

 
jo
 `#@
__k
` 
r
 

.
nk
=
m
.rank

112 
whe
 
m
.
urid
 
like
 '$uid' ";

113 
$_vs
 = 
$dsql
->
	`GO
(
$quy
);

114 if(!
	`is_y
(
$_vs
))

116 
	`ShowMsg
("你访问的用户可能已经被删除！","javascript:;");

117 
	`ex
();

119 if(
$_vs
['face']=='')

121 if(
$_vs
['sex']=='女')

123 
$_vs
['face'] = 'images/dfboy.gif';

127 
$_vs
['face'] = 'images/dfgril.gif';

130 
$_vs
['urid_e'] = 
	`ucode
($_vars['userid']);

131 
$_vs
['uru'] = 
$cfg_membu
."/index.php?uid=".$_vars['userid_e'];

132 if(
$_vs
['membername']=='开放浏览')

134 
$_vs
['membername'] = '限制会员';

136  
$_vs
;

137 
	}
}

	@member/inc/inc_archives_functions.php

1 <?
php


2 if(!
defed
('DEDEMEMBER')
ex
('dedecms');

3 
que_
(
DEDEINC
.'/image.func.php');

4 
que_
(
DEDEINC
.'/archives.func.php');

7 
CheckNAow
();

11 
funi
 
	$GCurCڋAlbum
(
$body
,
$rfu
,&
$fdd
)

13 
glob
 
$cfg_mui_se
,
$cfg_baho
,
$ddmaxwidth
,
$cfg_bad
,
$gey
,
$cfg_mb_rmdown
,
$t
,
$cfg_ml
,
$cfg_ur_d
;

14 
	`ude_
(
DEDEINC
."/dedecollection.func.php");

15 if(
	`emy
(
$ddmaxwidth
)) $ddmaxwidth = 240;

16 
$rsimg
 = '';

17 
$baho
 = "hp://".
$_SERVER
["HTTP_HOST"];

18 
$img_y
 = 
	`y
();

19 
	`eg_mch_l
("/(c|SRC)=[\"|'| ]{0,}(hp:\/\/([^>]*)\.(gif|jpg|g))/isU",
$body
,
$img_y
);

20 
$img_y
 = 
	`y_unique
($img_array[2]);

21 
$imgU
 = 
$cfg_ur_d
."/".
$cfg_ml
->
M_ID
;

22 
$imgPh
 = 
$cfg_bad
.
$imgU
;

23 if(!
	`is_d
(
$imgPh
."/"))

25 
	`MkdA
(
$imgPh
,
$GLOBALS
['cfg_dir_purview']);

26 
	`CloF
();

28 
$mliSecd
 = 
	`MyDe
("ymdHis",
	`time
());

29 
	`fܗch
(
$img_y
 
as
 
$key
=>
$vue
)

31 if(
	`egi
(
$baho
,
$vue
))

35 if(
$cfg_baho
!=
$baho
 && 
	`egi
($cfg_baho,
$vue
))

39 if(!
	`egi
("^hp://",
$vue
))

43 if(
$cfg_mb_rmdown
=='Y')

45 
$vue
 = 
	`im
($value);

46 
$y
 = 
	`subr
(
$vue
,-4,4);

47 if(!
	`egi
("\.(gif|jpg|g)",
$y
))

49 
$y
 = ".jpg";

51 
$dFeName
 = 
$imgPh
."/".
$mliSecd
.
$key
.
$y
;

52 
$iu
 = 
$imgU
."/".
$mliSecd
.
$key
.
$y
;

56 
$rs
 = 
	`DownImageKp
(
$vue
,
$rfu
,
$dFeName
,'',0,30);

57 if(
$rs
)

59 if(
$gey
 > 2)

61 
$lpiame
 = 
	`GImageMDD
(
$iu
,
$ddmaxwidth
);

62 if(
$lpiame
!='')

64 
	`SaveUdInfo
(
$t
,
$lpiame
,1,
$addfos
);

69 
$lpiame
 = '';

71 if(
	`emy
(
$fdd
))

73 
$fdd
 = 
$lpiame
;

74 if(!
	`fe_exis
(
$cfg_bad
.
$fdd
))

76 
$fdd
 = 
$iu
;

79 @
	`WImg
(
$dFeName
,'down');

80 
$fo
 = '';

81 
$imgfos
 = 
	`GImageSize
(
$dFeName
,
$fo
);

82 
	`SaveUdInfo
(
$t
,
$iu
,1,
$imgfos
);

83 
$rsimg
 ."{dede:img ddimg='$lpiame'ext='' width='".
$imgfos
[0]."' height='".$imginfos[1]."'} $iurl {/dede:img}\r\n";

88 
$rsimg
 .= "{dede:img ddimg='$value'ext='' width='0' height='0'} $value {/dede:img}\r\n";

91  
$rsimg
;

92 
	}
}

95 
funi
 
GImageMDD
(
$fame
, 
$ddm
, 
$dme
='')

97 if(
$dme
!='' && !
egi
("^http://",$oldname))

99 
	g$ddpicok
 = 
$dme
;

103 
	g$ddn
 = 
subr
(
$fame
,-3);

104 
	g$ddpicok
 = 
eg_a
("\.".
$ddn
."$", "-.".$ddn, 
$fame
);

106 
	g$toFe
 = 
$GLOBALS
['cfg_bad'].
$ddpicok
;

107 
ImageResize
(
$GLOBALS
['cfg_bad'].
$fame
, 
$ddm
, 300, 
$toFe
);

108  
	g$ddpicok
;

114 
funi
 
SaveUdInfo
(
$t
,
$fame
,
$meday
=1,
$addfos
='')

116 
glob
 
$dsql
,
$cfg_ml
,
$cfg_bad
;

117 if(
	g$fame
=='')

119  
l
;

121 if(!
is_y
(
$addfos
))

123 
	g$addfos
[0] = 
$addfos
[1] = $addinfos[2] = 0;

125 if(
	g$meday
==1)

127 
$fo
 = '';

128 
	g$addfos
 = 
GImageSize
(
$cfg_bad
.
$fame
,
$fo
);

130 
	g$addfos
[2] = @
fesize
(
$cfg_bad
.
$fame
);

131 
	g$row
 = 
$dsql
->
GO
("Seid,t,u From `#@__uds` whuik'$fame' And mid='".
$cfg_ml
->
M_ID
."'; ");

132 
	g$uime
 = 
time
();

133 if(
is_y
(
$row
))

135 
	g$quy
 = "Update `#@__uploads` setitle='$title',mediatype='$medaitype',

136 
width
='{$addfos[0]}',
	gheight
='{$addfos[1]}',
	gfesize
='{$addfos[2]}',
	guime
='$uptime'

137 
whe
 
aid
='{$row['aid']}'; ";

138 
	g$dsql
->
ExecuNeQuy
(
$quy
);

142 
	g$quy
 = "INSERT INTO `#@__uploads`(title,url,mediatype,width,height,playtime,filesize,uptime,mid)

143 
VALUES
 ('$title','$filename','$medaitype','".$addinfos[0]."','".$addinfos[1]."','0','".$addinfos[2]."','$uptime','".$cfg_ml->M_ID."'); ";

144 
	g$dsql
->
ExecuNeQuy
(
$quy
);

146  
	gue
;

151 
funi
 
	$GFmImA
(
$ag
)

153  
	`GFmIm
(
$ag
,'member');

154 
	}
}

159 
funi
 
GFldVueA
(
$dvue
,
$dty
,
$aid
=0,
$job
='add',
$addv
='')

161  
GFldVue
(
$dvue
,
$dty
,
$aid
,
$job
,
$addv
,'member');

166 
funi
 
	$GFmImVueA
(
$ag
,
$fvue
)

168  
	`GFmImVue
(
$ag
,
$fvue
,'member');

169 
	}
}

172 
funi
 
PrtAutoFldsAdd
(&
$fldt
,
$ldty
='all')

174 
$d
 = 
w
 
DedeTagP
();

175 
	g$d
->
SNameS
('field','<','>');

176 
	g$d
->
LdSour
(
$fldt
);

177 
	g$dede_addflds
 = '';

178 if(
is_y
(
$d
->
CTags
))

180 
fܗch
(
$d
->
CTags
 
as
 
$tid
=>
$ag
)

182 if(
$ldty
!='autofld' || 
$ag
->
GA
('autofield')==1 )

184 
$dede_addflds
 .$dede_addflds=="" ? 
$ag
->
GName
().",".$ag->
GA
('type') : ";".$ctag->GetName().",".$ctag->GetAtt('type') );

185 
echo
 
GFmImA
(
$ag
);

189 
	gecho
 "<puty='hidd'ame='dede_addflds' vue=\"".
	g$dede_addflds
."\">\r\n";

193 
funi
 
PrtAutoFldsEd
(&
$fldt
,&
$fldVues
,
$ldty
='all')

195 
$d
 = 
w
 
DedeTagP
();

196 
	g$d
->
SNameS
("field","<",">");

197 
	g$d
->
LdSour
(
$fldt
);

198 
	g$dede_addflds
 = "";

199 if(
is_y
(
$d
->
CTags
))

201 
fܗch
(
$d
->
CTags
 
as
 
$tid
=>
$ag
)

203 if(
$ldty
!='autofield'

204 || (
$ldty
=='autofld' && 
$ag
->
GA
('autofield')==1) )

206 
$dede_addflds
 .$dede_addflds=='' ? 
$ag
->
GName
().",".$ag->
GA
('type') : ";".$ctag->GetName().",".$ctag->GetAtt('type') );

207 
echo
 
GFmImVueA
(
$ag
,
$fldVues
[$ag->
GName
()]);

211 
	gecho
 "<puty='hidd'ame='dede_addflds' vue=\"".
	g$dede_addflds
."\">\r\n";

217 
funi
 
	$MakeA
(
$aid
,
$ismakesign
=
l
)

219 
glob
 
$cfg_makedex
,
$cfg_bad
,
$cfg_ms_d
,
$cfg_df_y
;

220 
	`ude_
(
DEDEINC
.'/arc.archives.class.php');

221 if(
$ismakesign
)

223 
$vs
['makesign'] = 'yes';

225 
$c
 = 
w
 
	`Archives
(
$aid
);

226 
$u
 = 
$c
->
	`MakeHtml
();

227 if(
	`ist
(
$tyid
))

229 
$eRow
 = 
$c
->
dsql
->
	`GO
("Select id From `#@__arctiny` where id<$aid Andrcrank>-1 Andypeid='$typeid' order by id desc");

230 
$xtRow
 = 
$c
->
dsql
->
	`GO
("Select id From `#@__arctiny` where id>$aid Andrcrank>-1 Andypeid='$typeid' order by idsc");

231 if(
	`is_y
(
$eRow
))

233 
$c
 = 
w
 
	`Archives
(
$eRow
['id']);

234 
$c
->
	`MakeHtml
();

236 if(
	`is_y
(
$xtRow
))

238 
$c
 = 
w
 
	`Archives
(
$xtRow
['id']);

239 
$c
->
	`MakeHtml
();

242  
$u
;

243 
	}
}

246 
funi
 
AlyHtmlBody
(
$body
,&
$desti
,
$dty
='')

248 
glob
 
$cfg_mb_rmdown
,
$cfg_baho
,
$cfg_au_desti
,
$cID
;

249 
	g$autޙpic
 = (
emy
(
$autޙpic
) ? '' : $autolitpic);

250 
	g$body
 = 
rashes
(
$body
);

253 if(
	g$cfg_mb_rmdown
=='Y')

255 
$body
 = 
GCurCڋ
($body);

259 if(
	g$desti
=='' && 
$cfg_au_desti
>0)

261 
$desti
 = 
_subr
(
html2xt
(
$body
),
$cfg_au_desti
);

262 
	g$desti
 = 
im
(
eg_a
('/#p#|#e#/','',
$desti
));

263 
	g$desti
 = 
addashes
(
$desti
);

265 
	g$body
 = 
addashes
(
$body
);

266  
	g$body
;

272 
funi
 
	$GCurCڋ
(&
$body
)

274 
glob
 
$cfg_mui_se
,
$cfg_baho
,
$cfg_bad
,
$cfg_ur_d
,
$t
,
$cfg_ml
;

275 
	`ude_
(
DEDEINC
."/dedecollection.func.php");

276 
$htd
 = 
w
 
	`DedeHpDown
();

277 
$baho
 = "hp://".
$_SERVER
["HTTP_HOST"];

278 
$img_y
 = 
	`y
();

279 
	`eg_mch_l
("/(c|SRC)=[\"|'| ]{0,}(hp:\/\/([^>]*)\.(gif|jpg|g))/isU",
$body
,
$img_y
);

280 
$img_y
 = 
	`y_unique
($img_array[2]);

281 
$imgU
 = 
$cfg_ur_d
."/".
$cfg_ml
->
M_ID
;

282 
$imgPh
 = 
$cfg_bad
.
$imgU
;

283 if(!
	`is_d
(
$imgPh
."/"))

285 
	`MkdA
(
$imgPh
,
$GLOBALS
['cfg_dir_purview']);

286 
	`CloF
();

288 
$mliSecd
 = 
	`MyDe
("ymdHis",
	`time
());

289 
	`fܗch
(
$img_y
 
as
 
$key
=>
$vue
)

291 if(
	`egi
(
$baho
,
$vue
))

295 if(
$cfg_baho
!=
$baho
 && 
	`egi
($cfg_baho,
$vue
))

299 if(!
	`egi
("^hp://",
$vue
))

303 
$htd
->
	`OnU
(
$vue
);

304 
$y
 = 
$htd
->
	`GHd
("content-type");

305 
$y
 = 
	`subr
(
$vue
,-4,4);

306 if(!
	`egi
("\.(jpg|gif|g)",
$y
))

308 if(
$y
=='image/gif')

310 
$y
 = ".gif";

312 if(
$y
=='image/png')

314 
$y
 = ".png";

318 
$y
 = '.jpg';

321 
$mliSecdN
 = 
	`dd2ch
(
$mliSecd
.'-'.
	`mt_nd
(1000,8000));

322 
$vue
 = 
	`im
($value);

323 
$dFeName
 = 
$imgPh
."/".
$mliSecdN
.'-'.
$key
.
$y
;

324 
$feu
 = 
$imgU
."/".
$mliSecdN
.'-'.
$key
.
$y
;

325 
$rs
 = 
$htd
->
	`SaveToB
(
$dFeName
);

326 if(
$rs
)

328 
$body
 = 
	`r_a
(
$vue
,
$feu
,$body);

329 @
	`WImg
(
$dFeName
,'down');

331 
$fo
 = '';

332 
$imgfos
 = 
	`GImageSize
(
$dFeName
,
$fo
);

333 
	`SaveUdInfo
(
$t
,
$feu
,1,
$imgfos
);

335 
$htd
->
	`Clo
();

336  
$body
;

337 
	}
}

348 
funi
 
UdOImage
(
$uame
,
$hdu
='',
$ieme
=1,
$
='')

350 
glob
 
$cfg_ml
,
$cfg_bad
,
$cfg_image_d
,
$dsql
,
$t
, $dsql;

351 if(
	g$
!='')

353 
$t
 = 
$
;

355 
	g$ime
 = 
time
();

356 
	g$fame
 = '';

357 
	g$im_up
 = 
l
;

358 
	g$hdu
 = 
im
(
$hdu
);

360 if(!
emy
(
$_FILES
[
$uame
]['tmp_me']&& 
is_uded_fe
($_FILES[$upname]['tmp_name']))

362 
	g$iy
 = 0;

363 
	g$r
 = 
Aay
("image/pjpeg","image/jpeg","image/gif","image/png");

364 
	g$_FILES
[
$uame
]['ty'] = 
ow
(
im
(
$_FILES
[$upname]['type']));

365 if(!
_y
(
$_FILES
[
$uame
]['ty'],
$r
))

367 
ShowMsg
("上传的图片格式错误，请使用JPEG、GIF、PNG格式的其中一种！","-1");

368 
ex
();

370 if(!
emy
(
$hdu
&& !
egi
("^hp://",$hdu&& 
fe_exis
(
$cfg_bad
.$handurl) )

372 
	g$dsql
->
ExecuNeQuy
("Delete From #@__uploads where urlike '$handurl' ");

373 
	g$fuU
 = 
egi_a
("\.([a-z]*)$","",
$hdu
);

377 
	g$vh
 = 
$cfg_image_d
."/".
rime
("%Y-%m",
$ime
);

378 
CeD
(
$vh
);

379 
	g$fuU
 = 
$vh
."/".
rime
("%d",
$ime
).
dd2ch
(rime("%H%M%S",$ime).'0'.
$cfg_ml
->
M_ID
.'0'.
mt_nd
(1000,9999));

381 if(
ow
(
$_FILES
[
$uame
]['type'])=="image/gif")

383 
$fuU
 = $fullUrl.".gif";

385 if(
ow
(
$_FILES
[
$uame
]['type'])=="image/png")

387 
$fuU
 = $fullUrl.".png";

391 
	g$fuU
 = 
$fuU
.".jpg";

395 @
move_uded_fe
(
$_FILES
[
$uame
]['tmp_me'],
$cfg_bad
.
$fuU
);

396 
	g$fame
 = 
$fuU
;

399 @
WImg
(
$imgfe
,'up');

400 
	g$im_up
 = 
ue
;

405 if(
	g$hdu
=='')

411 if(
	g$ieme
==1 && 
egi
("^hp://",
$hdu
))

413 
	g$ddfos
 = 
GRemeImage
(
$hdu
,
$curLog
->
gUrID
());

414 if(!
is_y
(
$ddfos
))

416 
	g$lpic
 = "";

420 
	g$fame
 = 
$ddfos
[0];

422 
	g$im_up
 = 
ue
;

428 
	g$fame
 = 
$hdu
;

431 
	g$imgfe
 = 
$cfg_bad
.
$fame
;

432 if(
is_fe
(
$imgfe
&& 
	g$im_up
 && 
	g$fame
!='')

434 
$fo
 = "";

435 
	g$imgfos
 = 
GImageSize
(
$imgfe
,
$fo
);

438 
	g$quy
 = "

439 
INSERT
 
INTO
 #@
__uds
(
t
,
u
,
medty
,
width
,
height
,
aytime
,
fesize
,
uime
,
mid
)

440 
VALUES
 ('$title','$filename','1','".$imginfos[0]."','".$imginfos[1]."','0','".filesize($imgfile)."','".time()."','".$cfg_ml->M_ID."');

442 
	g$dsql
->
ExecuNeQuy
(
$quy
);

444  
	g$fame
;

	@member/inc/inc_batchup.php

1 <?
php


2 if(!
defed
('DEDEMEMBER'))

4 
ex
("dedecms");

6 
que_
(
DEDEINC
."/channelunit.func.php");

8 
funi
 
	$DArc
(
$aid
)

10 
glob
 
$dsql
,
$cfg_cook_code
,
$cfg_ml
,
$cfg_ud_swch
,
$cfg_meds_d
;

11 
$aid
 = 
	`tv
($aid);

14 
$
 = '';

15 
$cu
 = '';

17 
$cQuy
 = "Selectrc.*,ch.addtable,tp.typedir,tp.typename,tp.namerule,tp.namerule2,tp.ispart,tp.moresite,tp.siteurl,tp.sitepath,ch.nid

18 
om
 `#@
__chives
` 
c


19 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


20 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


21 
whe
 
c
.
id
='$aid' ";

22 
$cRow
 = 
$dsql
->
	`GO
(
$cQuy
);

23 if(!
	`is_y
(
$cRow
))

25  
l
;

29 
$dsql
->
	`ExecuNeQuy
(" Delete From `#@__arctiny` where id='$aid' ");

30 if(
$cRow
['addtable']!='')

33 if(
$cfg_ud_swch
 == 'Y')

36 
$cRow
['nid'])

39 
$nid
 = "imgurls";

42 
$nid
 = "body";

45 
$nid
 = "softlinks";

48 
$nid
 = "body";

51 
$nid
 = "";

54 if(
$nid
 !="")

56 
$row
 = 
$dsql
->
	`GO
("SELECT $nid FROM ".
$cRow
['addtable']." WHEREid = '$aid'");

57 
$li
 = 
$dsql
->
	`GO
("SELECTitpic FROM `#@__archives` WHERE id = '$aid'");

58 if(
$li
['litpic'] != "")

60 
$lpic
 = 
DEDEROOT
.
$li
['litpic'];

61 if(
	`fe_exis
(
$lpic
&& !
	`is_d
($litpic))

63 @
	`uƚk
(
$lpic
);

66 
$tmame
 = '/(\\'.
$cfg_meds_d
.'.+?)(\"| )/';

69 
	`eg_mch_l
("$tmame", 
$row
["$nid"], 
$dme
);

72 
$dme
 = 
	`y_unique
($delname['1']);

73 
	`fܗch
 (
$dme
 
as
 
$v
)

75 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__uploads` where url='$var' AND mid = '$cfg_ml->M_ID'");

76 
$uame
 = 
DEDEROOT
.
$v
;

77 if(
	`fe_exis
(
$uame
&& !
	`is_d
($upname))

79 @
	`uƚk
(
$uame
);

84 
$dsql
->
	`ExecuNeQuy
("DFrom `".
$cRow
['addtable']."` whereid='$aid' ");

86 
$dsql
->
	`ExecuNeQuy
(" Delete From `#@__archives` where id='$aid' ");

87 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__feedback` whereid='$aid'");

88 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__member_stow` whereid='$aid'");

89 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__taglist ` whereid='$aid'");

92 if(
$cRow
['ismake']==-1||$arcRow['arcrank']!=0 ||$arcRow['typeid']==0||$arcRow['money']>0)

94  
ue
;

96 
$cu
 = 
	`GFeU
(
$cRow
['id'],$arcRow['typeid'],$arcRow['senddate'],$arcRow['title'],$arcRow['ismake'],

97 
$cRow
['arcrank'],$arcRow['namerule'],$arcRow['typedir'],$arcRow['money'],$arcRow['filename']);

98 if(!
	`eg
("\?",
$cu
))

100 
$htmlfe
 = 
	`GTruePh
().
	`r_a
(
$GLOBALS
['cfg_baho'],'',
$cu
);

101 if(
	`fe_exis
(
$htmlfe
&& !
	`is_d
($htmlfile))

103 @
	`uƚk
(
$htmlfe
);

104 
$cus
 = 
	`exode
(".",
$htmlfe
);

105 
$ame
 = 
$cus
[
	`cou
($arcurls)-1];

106 
$ame
 = 
	`eg_a
("(\.$ame)$","",
$htmlfe
);

107 
$i
=2;$i<=100;$i++)

109 
$htmlfe
 = 
$ame
."_$i".".".
$ame
;

110 if(
	`fe_exis
(
$htmlfe
&& !
	`is_d
($htmlfe)@
	`uƚk
($htmlfile);

117 
$fameh
 = 
DEDEDATA
."/xtda/".(
	`
(
$aid
/5000))."/{$aid}-".
	`subr
(
	`md5
(
$cfg_cook_code
),0,16).".txt";

118 if(
	`is_fe
(
$fame
))

120 @
	`uƚk
(
$fame
);

122  
ue
;

123 
	}
}

126 
funi
 
	$DArcSg
(
$aid
)

128 
glob
 
$dsql
,
$cfg_cook_code
,
$cfg_ml
,
$cfg_ud_swch
,
$cfg_meds_d
;

129 
$aid
 = 
	`tv
($aid);

132 
$
 = '';

133 
$cu
 = '';

135 
$cQuy
 = "Selectrc.id,arc.typeid,arc.senddate,arc.arcrank,ch.addtable,ch.nid,

136 

.
tyd
,.
tyme
,.
mu
,.
mu2
,.
it
,.
mese
,.
seu
,.
sh


137 
om
 `#@
__y
` 
c


138 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


139 

 
jo
 `#@
__chy
` 
ch
 

 ch.
id
=
c
.
chl


140 
whe
 
c
.
id
='$aid' ";

141 
$cRow
 = 
$dsql
->
	`GO
(
$cQuy
);

143 if(!
	`is_y
(
$cRow
))

145  
l
;

149 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__arctiny` where id='$aid' ");

150 
$dsql
->
	`ExecuNeQuy
("DFrom `".
$cRow
['addtable']."` whereid='$aid' ");

151 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__feedback` whereid='$aid'");

152 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__member_stow` whereid='$aid'");

153 
$dsql
->
	`ExecuNeQuy
("Delete From `#@__taglist ` whereid='$aid'");

156 if(
$cRow
['arcrank']!=0 ||$arcRow['typeid']==0)

158  
ue
;

160 
$cu
 = 
	`GFeU
(
$cRow
['id'],$arcRow['typeid'],$arcRow['senddate'],'',1,

161 
$cRow
['arcrank'],$arcRow['namerule'],$arcRow['typedir'],0,'');

162 if(!
	`eg
("\?",
$cu
))

164 
$htmlfe
 = 
	`GTruePh
().
	`r_a
(
$GLOBALS
['cfg_baho'],'',
$cu
);

165 if(
	`fe_exis
(
$htmlfe
&& !
	`is_d
($htmlfile))

167 @
	`uƚk
(
$htmlfe
);

168 
$cus
 = 
	`exode
(".",
$htmlfe
);

169 
$ame
 = 
$cus
[
	`cou
($arcurls)-1];

170 
$ame
 = 
	`eg_a
("(\.$ame)$","",
$htmlfe
);

171 
$i
=2;$i<=100;$i++)

173 
$htmlfe
 = 
$ame
."_$i".".".
$ame
;

174 if(
	`fe_exis
(
$htmlfe
&& !
	`is_d
($htmlfe)@
	`uƚk
($htmlfile);

180 
$fameh
 = 
DEDEDATA
."/xtda/".(
	`
(
$aid
/5000))."/{$aid}-".
	`subr
(
	`md5
(
$cfg_cook_code
),0,16).".txt";

181  
ue
;

182 
	}
}

185 
funi
 
	$GTruePh
()

187 
$uh
 = 
$GLOBALS
["cfg_basedir"];

188  
$uh
;

189 
	}
}

	@member/inc/inc_catalog_options.php

1 <?
php


2 if(!
defed
('DEDEMEMBER'))

4 
ex
("dedecms");

7 
funi
 
	$GOiLi
(
$lid
=0,
$chy
=0)

9 
glob
 
$OiAayLi
,
$chls
,
$dsql
;

10 
$dsql
->
	`SQuy
("Select id,typename From `#@__channeltype` ");

11 
$dsql
->
	`Execu
();

12 
$chls
 = 
	`Aay
();

13 
$row
 = 
$dsql
->
	`GObje
())

15 
$chls
[
$row
->
id
] = $row->
tyme
;

17 
$OiAayLi
 = "";

18 
$quy
 = "Select id,typename,ispart,channeltype,issend From `#@__arctype` where ispart<2 Andeid=0 order by sortranksc ";

19 
$dsql
->
	`SQuy
(
$quy
);

20 
$dsql
->
	`Execu
();

21 
$ed
 = '';

22 
$row
=
$dsql
->
	`GObje
())

24 if(
$lid
==
$row
->
id
)

26 
$ed
 = " selected='$selected'";

28 if(
$row
->
chy
==
$chy
 && $row->
isnd
==1)

30 if(
$row
->
it
==0)

32 
$OiAayLi
 ."<ti vue='".
$row
->
id
."' css='ti3'{$ed}>".$row->
tyme
."</option>\r\n";

34 if(
$row
->
it
==1)

36 
$OiAayLi
 ."<ti vue='".
$row
->
id
."' css='ti2'{$ed}>".$row->
tyme
."</option>\r\n";

39 
$ed
 = '';

40 
	`LogicGOiAay
(
$row
->
id
,"─",
$chy
,
$lid
);

42  
$OiAayLi
;

43 
	}
}

45 
funi
 
	$LogicGOiAay
(
$id
,
$
,
$chy
,
$lid
=0)

47 
glob
 
$OiAayLi
,
$chls
,
$dsql
;

48 
$ed
 = '';

49 
$dsql
->
	`SQuy
("Se id,tyme,it,chy,isnd From `#@__y` whid='".
$id
."' And ispart<2 order by sortranksc");

50 
$dsql
->
	`Execu
(
$id
);

51 
$row
=
$dsql
->
	`GObje
(
$id
))

53 if(
$lid
==
$row
->
id
)

55 
$ed
 = " selected='$selected'";

57 if(
$row
->
chy
==
$chy
 && $row->
isnd
==1)

59 if(
$row
->
it
==0)

61 
$OiAayLi
 ."<ti vue='".
$row
->
id
."' css='ti3'{$ed}>$".$row->
tyme
."</option>\r\n";

63 if(
$row
->
it
==1)

65 
$OiAayLi
 ."<ti vue='".
$row
->
id
."' css='ti2'{$ed}>$".$row->
tyme
."</option>\r\n";

68 
$ed
 = '';

69 
	`LogicGOiAay
(
$row
->
id
,
$
."─",
$chy
,
$lid
);

71 
	}
}

73 
funi
 
	$assifiti
(
$mid
, 
$mtyid
 = 0, 
$chlid
=1)

75 
glob
 
$dsql
;

76 
$li
 = 
$ed
 = '';

77 
$quey
 = "SELECT * FROM `#@__mtypes` WHERE mid = '$mid' And channelid='$channelid' ;";

78 
$dsql
->
	`SQuy
(
$quey
);

79 
$dsql
->
	`Execu
();

80 
$row
 = 
$dsql
->
	`GAay
())

82 if(
$mtyid
 != 0){

83 if(
$mtyid
 =
$row
['mtypeid'])

85 
$ed
 = " selected";

88 
$li
 ."<ti vue='".
$row
['mtypeid']."' class='option3'{$selected}>".$row['mtypename']."</option>\r\n";

89 
$ed
 = '';

91  
$li
;

92 
	}
}

	@member/inc/inc_list_functions.php

1 <?
php


2 if(!
defed
('DEDEMEMBER'))

4 
ex
("dedecms");

8 
funi
 
	$IsCommdArchives
(
$iscommd
)

10 
$s
 = '';

11 if(
	`eg
('c',
$iscommd
))

13 
$s
 .= '推荐';

15 if(
	`eg
('h',
$iscommd
))

17 
$s
 .= ' 头条';

19 if(
	`eg
('p',
$iscommd
))

21 
$s
 .= ' 图片';

23 if(
	`eg
('j',
$iscommd
))

25 
$s
 .= ' 跳转';

27  
$s
;

28 
	}
}

31 
funi
 
	$GCommdT
(
$t
,
$iscommd
)

33 if(
	`eg
('c',
$iscommd
))

35 
$t
 = "$title<font color='red'>(推荐)</font>";

38 
	}
}

41 
	g$GLOBALS
['RndTrunID'] = 1;

42 
funi
 
	$GC
(
$c1
,
$c2
)

44 
$GLOBALS
['RndTrunID']++;

45 if(
$GLOBALS
['RndTrunID']%2==0)

47  
$c1
;

51  
$c2
;

53 
	}
}

56 
funi
 
	$CheckPic
(
$piame
)

58 if(
$piame
!="")

60  
$piame
;

66 
	}
}

69 
funi
 
	$IsHtmlArchives
(
$ismake
)

71 if(
$ismake
==1)

75 if(
$ismake
==-1)

83 
	}
}

86 
funi
 
	$GRkName
(
$k
)

88 
glob
 
$cAay
;

89 if(!
	`is_y
(
$cAay
))

91 
$dsql
->
	`SQuy
("Select * from #@__arcrank");

92 
$dsql
->
	`Execu
();

93 
$row
 = 
$dsql
->
	`GObje
())

95 
$cAay
[
$row
->
nk
]=$row->
membme
;

98 if(
	`ist
(
$cAay
[
$k
]))

100  
$cAay
[
$k
];

106 
	}
}

109 
funi
 
	$IsPicArchives
(
$piame
)

111 if(
$piame
!="")

119 
	}
}

	@member/inc/inc_pwd_functions.php

1 <?
php


2 if(!
defed
('DEDEMEMBER'))

4 
ex
("dedecms");

8 
funi
 
	$ndom
(
$ngth
, 
$numic
 = 0)

10 
PHP_VERSION
 < '4.2.0' && 
	`mt_d
(()
	`miime
() * 1000000);

11 if(
$numic
)

13 
$hash
 = 
	`rtf
('%0'.
$ngth
.'d', 
	`mt_nd
(0, 
	`pow
(10, $length) - 1));

17 
$hash
 = '';

18 
$chs
 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz';

19 
$max
 = 
	`
(
$chs
) - 1;

20 
$i
 = 0; $< 
$ngth
; $i++)

22 
$hash
 .
$chs
[
	`mt_nd
(0, 
$max
)];

25  
$hash
;

26 
	}
}

29 
funi
 
	$ndma
(
$ema
, 
$mat
, 
$mabody
, 
$hds
)

31 
glob
 
$cfg_ndma_bysm
, 
$cfg_sm_rv
, 
$cfg_sm_pt
, 
$cfg_sm_urma
, 
$cfg_sm_ur
, 
$cfg_sm_sswd
, 
$cfg_admema
;

32 if(
$cfg_ndma_bysm
 == 'Y')

34 
$maty
 = 'TXT';

35 
	`que_
(
DEDEINC
.'/mail.class.php');

36 
$sm
 = 
w
 
	`sm
(
$cfg_sm_rv
,
$cfg_sm_pt
,
ue
,
$cfg_sm_urma
,
$cfg_sm_sswd
);

37 
$sm
->
debug
 = 
l
;

38 
$sm
->
	`ndma
(
$ema
, 
$cfg_sm_urma
, 
$mat
, 
$mabody
, 
$maty
);

42 @
	`ma
(
$ema
, 
$mat
, 
$mabody
, 
$hds
);

44 
	}
}

47 
funi
 
	$wma
(
$mid
,
$urid
,
$mato
,
$ty
,
$nd
)

49 
glob
 
$db
,
$cfg_admema
,
$cfg_webme
,
$cfg_baho
,
$cfg_membu
;

50 
$matime
 = 
	`time
();

51 
$ndv
 = 
	`ndom
(8);

52 
$mat
 = 
$cfg_webme
.":密码修改";

53 
$mato
 = $mailto;

54 
$hds
 = "From: ".
$cfg_admema
."\r\nReply-To: $cfg_adminemail";

55 
$mabody
 = "亲爱的".
$urid
."：\r\n您好！感谢您使用".
$cfg_webme
."网。\r\n".$cfg_webme."应您的要求，重新设置密码：（注：如果您没有提出申请，请检查您的信息是否泄漏。）\r\n本次临时登陆密码为：".
$ndv
." 请于三天内登陆下面网址确认修改。\r\n".
$cfg_baho
.
$cfg_membu
."/asswd.php?do=gsswd&id=".
$mid
;

56 if(
$ty
 == 'INSERT')

58 
$key
 = 
	`md5
(
$ndv
);

59 
$sql
 = "INSERT INTO `#@__pwd_tmp` (`mid` ,`membername` ,`pwd` ,`mailtime`)VALUES ('$mid', '$userid', '$key', '$mailtime');";

60 if(
$db
->
	`ExecuNeQuy
(
$sql
))

62 if(
$nd
 == 'Y')

64 
	`ndma
(
$mato
,
$mat
,
$mabody
,
$hds
);

65  
	`showmsg
('EMAIL修改验证码已经发送到原来的邮箱请查收', 'login.php','','5000');

67 
	`if
(
$nd
 == 'N')

69  
	`showmsg
('稍后跳转到修改页', 
$cfg_baho
.
$cfg_membu
."/asswd.php?do=gsswd&amp;id=".
$mid
."&amp;key=".
$ndv
);

74  
	`showmsg
('对不起修改失败，请联系管理员', 'login.php');

77 
	`if
(
$ty
 == 'UPDATE')

79 
$key
 = 
	`md5
(
$ndv
);

80 
$sql
 = "UPDATE `#@__pwd_tmp` SET `pwd` = '$key',mailtime = '$mailtime' WHERE `mid` ='$mid';";

81 if(
$db
->
	`ExecuNeQuy
(
$sql
))

83 if(
$nd
 == 'Y')

85 
	`ndma
(
$mato
,
$mat
,
$mabody
,
$hds
);

86 
	`showmsg
('EMAIL修改验证码已经发送到原来的邮箱请查收', 'login.php');

88 
	`if
(
$nd
 == 'N')

90  
	`showmsg
('稍后跳转到修改页', 
$cfg_baho
.
$cfg_membu
."/asswd.php?do=gsswd&amp;id=".
$mid
."&amp;key=".
$ndv
);

95 
	`showmsg
('对不起修改失败，请与管理员联系', 'login.php');

98 
	}
}

101 
funi
 
	$memb
(
$ma
,
$urid
)

103 
glob
 
$db
;

104 
$sql
 = "Select mid,email,safequestion From #@__member wheremail='$mail' AND userid = '$userid'";

105 
$row
 = 
$db
->
	`GO
(
$sql
);

106 if(!
	`is_y
(
$row
))

108  
	`ShowMsg
("对不起，用户ID输入错误！","-1");

112  
$row
;

114 
	}
}

117 
funi
 

(
$mid
,
$urid
,
$mato
, 
$nd
 = 'Y')

119 
glob
 
$db
;

120 
	g$tim
= (60*10);

121 
	g$dtime
 = 
time
();

122 
	g$sql
 = "Select * From #@__pwd_tmp where mid = '$mid'";

123 
	g$row
 = 
$db
->
GO
(
$sql
);

124 if(!
is_y
(
$row
))

128 
wma
(
$mid
,
$urid
,
$mato
,'INSERT',
$nd
);

132 
if
(
$dtime
 - 
$tim
 > 
$row
['mailtime'])

134 
wma
(
$mid
,
$urid
,
$mato
,'UPDATE',
$nd
);

140  
showmsg
('对不起，请10分钟后再重新申请', 'login.php');

	@member/inc/space_action.php

1 <?
php


2 if(!
defed
('DEDEMEMBER')
ex
('dedecms');

5 
	g$addqSql
 = '';

6 if(
	g$cfg_mb_lownrc
=='N')

8 
$addqSql
 .= " Andrc.arcrank > -1 ";

10 if(
ist
(
$mty
)
	g$mty
 = 
tv
($mtype);

11 if(!
	$emy
(
$mty
))

13 
$addqSql
 .= " Andrc.mtype = '$mtype' ";

14 
	}
}

19 if(
	g$ai
=='article')

21 if(
emy
(
$mty
)) {

22 
$mty
 = 0;

24 
ude_
(
DEDEINC
.'/arc.memberlistview.class.php');

25 
ude_
(
DEDEINC
.'/channelunit.func.php');

26 
	g$quy
 = "Selectrc.*,mt.mtypename,addt.body,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,tp.ispart,tp.moresite,tp.siteurl,tp.sitepath

27 
om
 `#@
__chives
` 
c


28 

 
jo
 `#@
__addڬtie
` 
addt
 

ddt.
aid
=
c
.
id


29 

 
jo
 `#@
__y
` 

 

p.
id
=
c
.
tyid


30 

 
jo
 `#@
__mtys
` 
mt
 

 mt.
mtyid
=
c
.
mty


31 
whe
 
c
.
mid
='{$_vs['mid']}' 
$addqSql
 
And
rc.
chl
=1 
d
 
by
rc.
id
 
desc
";

32 
$dli
 = 
w
 
MembLivw
();

33 
	g$dli
->
	ggeSize
 = 8;

34 
	g$dli
->
SPam
("mty",
$mty
);

35 
	g$dli
->
SPam
("uid",
$_vs
['userid']);

36 
	g$dli
->
SPam
("ai",
$ai
);

37 
	g$dli
->
STeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/listarticle.htm");

38 
	g$dli
->
SSour
(
$quy
);

39 
	g$dli
->
Diy
();

40 
ex
();

46 if(
	g$ai
=='vwchives' && !
emy
(
$aid
&& 
	$is_numic
(
$aid
))

48 if(
	`emy
(
$mty
)) {

49 
$mty
 = 0;

51 
	`ude_
(
DEDEINC
.'/arc.memberlistview.class.php');

52 
	`ude_
(
DEDEINC
.'/channelunit.func.php');

55 
$sql
 = "select fb.*,mb.userid,mb.faces mface,mb.spacesta,mb.scores from `#@__feedback` fb

56 

 
jo
 `#@
__memb
` 
mb
 

 mb.
mid
 = 
fb
.mid

57 
whe
 
fb
.
aid
='$aid' 
d
 fb.
ischeck
='1' 
d
 
by
 fb.
id
 
desc
 
lim
 0, 50";

58 
$msgs
 = 
	`y
();

59 
$dsql
->
	`Execu
('fb', 
$sql
);

60 
$row
 = 
$dsql
->
	`GAay
('fb'))

62 
$msgs
[] = 
$row
;

66 
$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,

67 

.
it
,.
mese
,.
seu
,.
sh
,

.
body
 
om
 `#@
__chives
` 
c


68 

 
jo
 `#@
__y
` 

 

 
c
.
tyid
p.
id


69 

 
jo
 `#@
__addڬtie
` 

 

r.
aid
=
c
.
id


70 
whe
 
c
.
mid
='{$_vs['mid']}' 
And
rc.
chl
=1 
d
 

.
tyid
=

.
id
ndr.
aid
='$aid' ";

71 
$ow
 = 
$dsql
->
	`GO
(
$quy
);

72 if!
	`is_y
(
$ow
) )

74 
	`ShowMsg
(' 读取文档时发生未知错误! ', '-1');

75 
	`ex
();

79 
$dli
 = 
w
 
	`MembLivw
();

80 
$dli
->
	`STeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/blog.htm");

81 
$dli
->
	`Diy
();

82 
	`ex
();

83 
	}
}

88 if(
	g$ai
=='archives')

90 if(
emy
(
$mty
)) $mtype = 0;

91 
ude_
(
DEDEINC
.'/arc.memberlistview.class.php');

92 
ude_
(
DEDEINC
.'/channelunit.func.php');

95 if(
	g$cfg_mb_arc
 > 0 && 
emy
(
$chlid
))

97 
	g$chlid
 = 
tv
(
$cfg_mb_arc
);

99 if(
emy
(
$chlid
))

101 
	g$chlid
 = 0;

102 
	g$quy
 = "Selectrc.*,mt.mtypename,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,tp.ispart,tp.moresite,tp.siteurl,tp.sitepath

103 
om
 `#@
__chives
` 
c


104 

 
jo
 `#@
__y
` 

 

 
c
.
tyid
p.
id


105 

 
jo
 `#@
__mtys
` 
mt
 

 mt.
mtyid
=
c
.
mty


106 
whe
 
c
.
mid
='{$_vs['mid']}' 
$addqSql
 
d
 
by
rc.
id
 
desc
";

110 
	g$chlid
 = 
tv
(
$chlid
);

111 
	g$chRow
 = 
$dsql
->
GO
("Select issystem,addtable,listfields From `#@__channeltype` where id='$channelid' ");

112 if(!
is_y
(
$chRow
)
d
(' Channel Error! ');

113 if(
	g$chRow
['issystem']==-1)

115 
$addb
 = 
im
(
$chRow
['addtable']);

116 
	g$liflds
 = 
exode
(',',
$chRow
['listfields']);

117 
	g$liflds_r
 = 'c.'.
jo
(',c.',
$liflds
);

118 if(
	g$liflds_r
!='arc.') {

119 
$liflds_r
 = $listfields_str.',';

122 
	g$liflds_r
 = '';

124 
	g$quy
 = "Selectrc.aid,arc.aids id,arc.typeid,''s mtypename,1s ismake,0s money,''s filename,{$listfields_str}

125 

.
tyd
,
	g
.
	gtyme
,.
	gisdeu
,.
	gdeume
,.
	gmu
,.
	gmu2
,.
	git
,.
	gmese
,.
	gseu
,.
sh


126 
	gom
 `{
	g$addb
}` 
c


127 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


128 
whe
 
c
.
mid
='{$_vs['mid']}' 
And
rc.
chl
='$chlid' 
$addqSql
 
d
 
by
rc.
aid
 
desc
";

132 
	g$quy
 = "Selectrc.*,mt.mtypename,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,tp.ispart,tp.moresite,tp.siteurl,tp.sitepath

133 
om
 `#@
__chives
` 
c


134 

 
jo
 `#@
__y
` 

 

 
c
.
tyid
p.
id


135 

 
jo
 `#@
__mtys
` 
mt
 

 mt.
mtyid
=
c
.
mty


136 
whe
 
c
.
mid
='{$_vs['mid']}' 
And
rc.
chl
='$chlid' 
$addqSql
 
d
 
by
rc.
id
 
desc
";

139 
	g$dli
 = 
w
 
MembLivw
();

140 
	g$dli
->
	ggeSize
 = 8;

141 
	g$dli
->
SPam
("mty",
$mty
);

142 
	g$dli
->
SPam
("uid",
$_vs
['userid']);

143 
	g$dli
->
SPam
("chlid",
$chlid
);

144 
	g$dli
->
SPam
("ai",
$ai
);

145 
	g$dli
->
STeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/listarchives.htm");

146 
	g$dli
->
SSour
(
$quy
);

147 
	g$dli
->
Diy
();

148 
ex
();

155 if(
	g$ai
=='album')

157 if(
emy
(
$mty
)) {

158 
$mty
 = 0;

160 
ude_
(
DEDEINC
.'/arc.memberlistview.class.php');

161 
ude_
(
DEDEINC
.'/channelunit.func.php');

162 
	g$quy
 = "Selectrc.*,mt.mtypename,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,tp.ispart,tp.moresite,tp.siteurl,tp.sitepath

163 
om
 `#@
__chives
` 
c


164 

 
jo
 `#@
__y
` 

 

 
c
.
tyid
p.
id


165 

 
jo
 `#@
__mtys
` 
mt
 

 mt.
mtyid
=
c
.
mty


166 
whe
 
c
.
mid
='{$_vs['mid']}' 
And
rc.
chl
=2 
$addqSql
 
d
 
by
rc.
id
 
desc
";

167 
$dli
 = 
w
 
MembLivw
();

168 
	g$dli
->
	ggeSize
 = 8;

169 
	g$dli
->
SPam
("mty",
$mty
);

170 
	g$dli
->
SPam
("uid",
$_vs
['userid']);

171 
	g$dli
->
SPam
("ai",
$ai
);

172 
	g$dli
->
STeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/listalbum.htm");

173 
	g$dli
->
SSour
(
$quy
);

174 
	g$dli
->
Diy
();

175 
ex
();

182 if(
	g$ai
=='guestbook')

184 if(
emy
(
$mty
)) {

185 
$mty
 = 0;

187 
ude_
(
DEDEINC
.'/datalistcp.class.php');

188 
	g$quy
 = "Select mg.*, mb.face, mb.userid From `#@__member_guestbook` mg 

189 

 
jo
 `#@
__memb
` 
mb
 

 mb.
mid
=
mg
.mid

190 
whe
 
mg
.
mid
='{$_vs['mid']}' 
d
 
by
 mg.
aid
 
desc
";

191 
$dli
 = 
w
 
DaLiCP
();

192 
	g$dli
->
	ggeSize
 = 8;

193 
	g$dli
->
SPam
("uid",
$_vs
['userid']);

194 
	g$dli
->
SPam
("ai",
$ai
);

195 
	g$dli
->
STeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/guestbook.htm");

196 
	g$dli
->
SSour
(
$quy
);

197 
	g$dli
->
Diy
();

198 
ex
();

205 if(
	g$ai
=='friend')

207 if(
emy
(
$mty
)) {

208 
$mty
 = 0;

210 
ude_
(
DEDEINC
.'/arc.memberlistview.class.php');

211 
ude_
(
DEDEINC
.'/channelunit.func.php');

212 
	g$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,tp.namerule2,tp.ispart,tp.moresite,tp.siteurl,tp.sitepath

213 
om
 `#@
__chives
` 
c


214 

 
jo
 `#@
__y
` 

 

 
c
.
tyid
p.
id


215 
whe
 
c
.
mid
='{$_vs['mid']}' 
$addqSql
 
d
 
by
rc.
id
 
desc
";

216 
$dli
 = 
w
 
MembLivw
();

217 
	g$dli
->
	ggeSize
 = 8;

218 
	g$dli
->
SPam
("mty",
$mty
);

219 
	g$dli
->
SPam
("uid",
$_vs
['userid']);

220 
	g$dli
->
SPam
("ai",
$ai
);

221 
	g$dli
->
STeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/friend.htm");

222 
	g$dli
->
SSour
(
$quy
);

223 
	g$dli
->
Diy
();

224 
ex
();

231 if(
	g$ai
=='infos')

233 
ude_
(
DEDEDATA
.'/enums/nativeplace.php');

234 
ude_
(
DEDEINC
."/enums.func.php");

235 
	g$row
 = 
$dsql
->
GO
("select * from `#@__member_person` where mid='{$_vars['mid']}' ");

236 
	g$d
 = 
w
 
DedeTeme
();

237 
	g$d
->
LdTeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/infos.htm");

238 
	g$d
->
diy
();

245 if(
	g$ai
=='guestbooksave')

247 
CheckRk
(0,0);

248 
	g$svi
 = 
GCkVdVue
();

249 if(
ow
(
$vdcode
)!=
$svi
 || $svali=='')

251 
RetVdVue
();

252 
ShowMsg
('验证码错误！', '-1');

253 
ex
();

255 
	g$uidnum
 = 
tv
(
$uidnum
);

256 if(
emy
(
$uidnum
))

258 
ShowMsg
('参数错误！', '-1');

259 
ex
();

261 if(

(
$msg
)<6)

263 
ShowMsg
('你的留言内容太短！', '-1');

264 
ex
();

266 
	g$ume
 = 
HtmlR
(
$ume
, 1);

267 
	g$msg
 = 
_subrR
(
HtmlR
(
$msg
), 2048);

268 if(
	g$cfg_ml
->
	gM_UrName
 !'' && 
$cfg_ml
->
M_ID
 !
$uidnum
)

270 
$gid
 = 
$cfg_ml
->
M_UrName
;

274 
	g$gid
 = '';

276 
	g$quy
 = "INSERT INTO `#@__member_guestbook`(mid,gid,msg,uname,ip,dtime)

277 
VALUES
 ('$uidnum','$gid','$msg','$uname','".GetIP()."',".time()."); ";

278 
	g$dsql
->
ExecuNeQuy
(
$quy
);

279 
ShowMsg
('成功提交你的留言！', "index.php?uid={$uid}&action=guestbook");

280 
ex
();

287 if(
	g$ai
=='newfriend')

289 
CheckRk
(0,0);

290 if(
	g$_vs
['mid']==
$cfg_ml
->
M_ID
)

292 
ShowMsg
("你不能加自己为好友！","dex.php?uid=".
$uid
);

293 
ex
();

295 
	g$addtime
 = 
time
();

296 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__member_friends` where fid='{$_vars['mid']}' And mid='{$cfg_ml->M_ID}' ");

297 if(
is_y
(
$row
))

299 
ShowMsg
("该用户已经是你的好友！","dex.php?uid=".
$uid
);

300 
ex
();

305 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

307 if(
	g$da
 = 
uc_g_ur
(
$cfg_ml
->
M_LogID
)
uc_nd_add
(
$uid
,
$da
[0]);

309 #/
a
}}

311 
	g$quy
 = "INSERT INTO `#@__member_friends` (`fid` , `floginid` , `funame` , `mid` , `addtime` , `ftype`)

312 
VALUES
 ('{$_vs['
mid
']}' , '{$_vs['
urid
']}' , '{$_vs['
ume
']}' , '{$cfg_ml->M_ID}' , '$addtime' , '0'); ";

313 
	g$dsql
->
ExecuNeQuy
(
$quy
);

315 
	g$row
 = 
$dsql
->
GO
("SELECT COUNT(*ASumFROM `#@__memb_nds` WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

316 
	g$dsql
->
ExecuNeQuy
("UPDATE `#@__memb_tj` SET frnd='$row[nums]' WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

318 
ShowMsg
("成功添加好友！","dex.php?uid=".
$uid
);

319 
ex
();

327 if(
	g$ai
=='blackfriend')

329 
CheckRk
(0,0);

330 if(
	g$_vs
['mid']==
$cfg_ml
->
M_ID
)

332 
ShowMsg
("你不能加自己到黑名单！","dex.php?uid=".
$uid
);

333 
ex
();

335 
	g$addtime
 = 
time
();

336 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__member_friends` where fid='{$_vars['mid']}' And mid='{$cfg_ml->M_ID}' ");

337 if(
is_y
(
$row
))

339 
ShowMsg
("该用户已经是你的好友！","dex.php?uid=".
$uid
);

340 
ex
();

344 
	g$quy
 = "INSERT INTO `#@__member_friends` (`fid` , `floginid` , `funame` , `mid` , `addtime` , `ftype`)

345 
VALUES
 ('{$cfg_ml->M_ID}' , '{$cfg_ml->M_LogID}' , '{$cfg_ml->M_UrName}' , '{$_vs['
mid
']}' , '$addtime' , '-1'); ";

346 
	g$dsql
->
ExecuNeQuy
(
$quy
);

347 
ShowMsg
("成功添加好友在黑名单！","dex.php?uid=".
$uid
);

348 
ex
();

355 
if
(
$ai
 == 'introduce')

357 
$d
 = 
w
 
DedeTeme
();

358 
	g$d
->
LdTeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/introduce.htm");

359 
	g$d
->
diy
();

362 
if
 (
$ai
 == 'contact')

364 
$d
 = 
w
 
DedeTeme
();

365 
	g$d
->
LdTeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/contact.htm");

366 
	g$d
->
diy
();

372 
if
(
$ai
 == 'products')

374 
$mty
 = 
ist
($mty&& 
is_numic
($mtype) ? $mtype : 0;

375 if(
	g$ai
 == 'products') {

376 
$chl
 = 6;

378 
ude_
(
DEDEINC
.'/arc.memberlistview.class.php');

379 
ude_
(
DEDEINC
.'/channelunit.func.php');

381 
	g$quy
 = "Selectrc.*,tp.typedir,tp.typename,tp.isdefault,tp.defaultname,tp.namerule,

382 

.
mu2
,
	g
.
	git
,.
	gmese
,.
	gseu
,.
sh
 
	gom
 `#@
	g__chives
` 
c


383 

 
	gjo
 `#@
	g__y
` 

 

 
	gc
.
	gtyid
p.
id


384 
whe
 
c
.
mid
='{$_vs['mid']}' 
d
rc.
chl
='$chl' 
$addqSql
 
d
 
by
rc.
id
 
desc
";

386 
$dli
 = 
w
 
MembLivw
();

387 
	g$dli
->
	ggeSize
 = 12;

388 
	g$dli
->
SPam
('mty', 
$mty
);

389 
	g$dli
->
SPam
('uid', 
$_vs
['userid']);

390 
	g$dli
->
SPam
('ai', 
$ai
);

391 
	g$dli
->
STeme
(
DEDEMEMBER
."/space/{$_vars['spacestyle']}/listproducts.htm");

392 
	g$dli
->
SSour
(
$quy
);

393 
	g$dli
->
Diy
();

394 
ex
();

	@member/index.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 if(
	$emy
(
$uid
))

5 
$uid
 = '';

6 
	}
}

9 
	g$tmpr
 = @
gb2utf8
(
$uid
);

10 
	g$tmpr2
 = @
utf82gb
(
$tmpr
);

11 if(
	g$tmpr2
==
$uid
$uid = 
$tmpr
;

13 if(
	$emy
(
$ai
))

15 
$ai
 = '';

16 
	}
}

17 if(
	$emy
(
$aid
))

19 
$aid
 = '';

20 
	}
}

23 if(
	g$uid
=='')

25 
$iscڌ
 = 'yes';

26 if(!
	g$cfg_ml
->
IsLog
())

28 
ude_
(
dme
(
__FILE__
)."/templets/index-notlogin.htm");

29 
ex
();

33 
	g$mfos
 = 
$dsql
->
GO
("Se * From `#@__memb_tj` whmid='".
$cfg_ml
->
M_ID
."'; ");

34 
	g$mfos
['tٮu'] = 
$cfg_ml
->
GUrS
();

35 
	g$mfos
['tٮu'] = 
numb_fm
(
$mfos
['totaluse']/1024/1024,2);

36 if(
	g$cfg_mb_max
 > 0) {

37 
	g$ddsize
 = 

(
$mfos
['tٮu']/
$cfg_mb_max
) * 100 );

40 
	g$ddsize
 = 0;

43 
que_
(
DEDEINC
.'/channelunit.func.php');

46 
	g$chives
 = 
y
();

47 
	g$sql
 = "selectrc.*, category.namerule, category.typedir, category.moresite, category.siteurl, category.sitepath, mem.userid

48 
om
 #@
__chives
 
c


49 

 
jo
 #@
__y
 
gy
 

 cegy.
id
=
c
.
tyid


50 

 
jo
 #@
__memb
 
mem
 

 mem.
mid
=
c
.mid

51 
whe
 
c
.
k
 > -1

52 
d
 
by
 
c
.
s܌k
 
desc
 
lim
 8";

53 
$dsql
->
SQuy
(
$sql
);

54 
	g$dsql
->
Execu
();

55 
	g$row
 = 
$dsql
->
GAay
())

57 
$row
['htmlu'] = 
GFeU
($row['id'], $row['typeid'], $row['senddate'], $row['title'], $row['ismake'], $row['arcrank'], $row['namerule'], $row['typedir'], $row['money'], $row['filename'], $row['moresite'], $row['siteurl'], $row['sitepath']);

58 
	g$chives
[] = 
$row
;

62 
	g$_vs
['mid'] = 
$cfg_ml
->
M_ID
;

64 
	g$cfg_ml
->
	gflds
[''] = 
emy
(
$cfg_ml
->
flds
['face']) ? 'images/nopic.gif' : $cfg_ml->fields['face'];

67 
	g$vܙes
 = 
y
();

68 
	g$dsql
->
Execu
('fl',"Select * From `#@__member_stow` where mid='{$cfg_ml->M_ID}'imit 5");

69 
	g$r
 = 
$dsql
->
GAay
('fl'))

71 
$vܙes
[] = 
$r
;

75 
	g$sql
 = "Select * From `#@__member_friends` where mid='{$cfg_ml->M_ID}' And ftype!='-1' order byddtime descimit 10";

76 
	g$nds
 = 
y
();

77 
	g$dsql
->
SQuy
(
$sql
);

78 
	g$dsql
->
Execu
();

79 
	g$row
 = 
$dsql
->
GAay
()) {

80 
$nds
[] = 
$row
;

83 
	g$pms
 = 
$dsql
->
GO
("SELECT COUNT(*) ASums FROM #@__member_pms WHEREoid='{$cfg_ml->M_ID}' AND `hasview`=0 AND folder = 'inbox'");

85 
	g$d
 = 
w
 
DedeTeme
();

86 
	g$l
 = 
dme
(
__FILE__
)."/templets/index.htm";

87 
	g$d
->
LdTeme
(
$l
);

88 
	g$d
->
diy
();

98 
que_
(
DEDEMEMBER
.'/inc/config_space.php');

99 if(
	g$ai
 == '')

101 
ude_
(
DEDEINC
."/channelunit.func.php");

102 
	g$d
 = 
w
 
DedeTeme
();

103 
	g$lfe
 = 
DEDEMEMBER
."/space/{$_vars['spacestyle']}/index.htm";

106 
	g$vtime
 = 
time
();

107 
	g$ϡ_vtime
 = 
GCook
('last_vtime');

108 
	g$ϡ_vid
 = 
GCook
('last_vid');

109 if(
emy
(
$ϡ_vtime
))

111 
	g$ϡ_vtime
 = 0;

113 if(
	g$vtime
 - 
	g$ϡ_vtime
 > 3600 || !
egi
(','.
$uid
.',',','.
$ϡ_vid
.',') )

115 if(
	g$ϡ_vid
!='')

117 
$ϡ_vids
 = 
exode
(',',
$ϡ_vid
);

118 
	g$i
 = 0;

119 
	g$ϡ_vid
 = 
$uid
;

120 
fܗch
(
$ϡ_vids
 
as
 
$lsid
)

122 if(
	g$i
>10)

126 if(
	g$lsid
 !
$uid
)

128 
$i
++;

129 
	g$ϡ_vid
 .','.
$ϡ_vid
;

135 
	g$ϡ_vid
 = 
$uid
;

137 
PutCook
('ϡ_vtime', 
$vtime
, 3600*24, '/');

138 
PutCook
('ϡ_vid', 
$ϡ_vid
, 3600*24, '/');

139 if(
	g$cfg_ml
->
IsLog
(&& $cfg_ml->
	gM_LogID
 !
$uid
)

141 
$v
 = 
GIP
();

142 
	g$r
 = 
$dsql
->
GO
("Select * From `#@__member_vhistory` where mid='{$_vars['mid']}' And vid='{$cfg_ml->M_ID}' ");

143 if(
is_y
(
$r
))

145 
	g$dsql
->
ExecuNeQuy
("Update `#@__member_vhistory` set vip='$vip',vtime='$vtime',count=count+1 where mid='{$_vars['mid']}' And vid='{$cfg_ml->M_ID}' ");

149 
	g$quy
 = "Insert Into `#@__member_vhistory`(mid,loginid,vid,vloginid,count,vip,vtime)

150 
Vues
('{$_vs['
mid
']}','{$_vs['
urid
']}','{$cfg_ml->M_ID}','{$cfg_ml->M_LoginID}','1','$vip','$vtime'); ";

151 
	g$dsql
->
ExecuNeQuy
(
$quy
);

154 
	g$dsql
->
ExecuNeQuy
("Update `#@__member_tj` set homecount=homecount+1 where mid='{$_vars['mid']}' ");

156 
	g$d
->
LdTeme
(
$lfe
);

157 
	g$d
->
diy
();

158 
ex
();

162 
que_
(
DEDEMEMBER
.'/inc/space_action.php');

163 
ex
();

	@member/index_do.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
emy
(
$do
)
	g$do
 = '';

4 if(
emy
(
$fmdo
)
	g$fmdo
 = '';

9 if(
	g$fmdo
=='sendMail')

11 
CheckRk
(0,0);

12 if!
CheckEma
(
$cfg_ml
->
flds
['email']) )

14 
ShowMsg
('你的邮箱格式有错误！', '-1');

15 
ex
();

17 if(
	g$cfg_ml
->
	gflds
['spacesta'] != -10)

19 
ShowMsg
('你的帐号不在邮件验证状态，本操作无效！', '-1');

20 
ex
();

22 
	g$urhash
 = 
md5
(
$cfg_cook_code
.'--'.
$cfg_ml
->
flds
['mid'].'--'.$cfg_ml->fields['email']);

23 
	g$u
 = 
$cfg_baho
.(
emy
(
$cfg_cmh
) ? '/' : $cfg_cmspath)."/member/index_do.php?fmdo=checkMail&mid={$cfg_ml->fields['mid']}&userhash={$userhash}&do=1";

24 
	g$u
 = 
egi_a
('hp://', '', 
$u
);

25 
	g$u
 = 'hp://'.
egi_a
('//', '/', 
$u
);

26 
	g$mat
 = "{$cfg_webname}--会员邮件验证通知";

27 
	g$mabody
 = '';

28 
	g$mabody
 .= "尊敬的用户，您好：\r\n";

29 
	g$mabody
 .= "欢迎注册成为[{$cfg_webname}]的会员。\r\n";

30 
	g$mabody
 .= "要通过注册，还必须进行最后一步操作，请点击或复制下面链接到地址栏访问这地址：\r\n\r\n";

31 
	g$mabody
 .= "{$url}\r\n\r\n";

32 
	g$mabody
 .= "Power by http://www.dedecms.com 织梦内容管理系统！\r\n";

34 
	g$hds
 = "From: ".
$cfg_admema
."\r\nReply-To: ".$cfg_adminemail;

35 if(
	g$cfg_ndma_bysm
 ='Y' && !
emy
(
$cfg_sm_rv
))

37 
$maty
 = 'TXT';

38 
que_
(
DEDEINC
.'/mail.class.php');

39 
	g$sm
 = 
w
 
sm
(
$cfg_sm_rv
,
$cfg_sm_pt
,
ue
,
$cfg_sm_urma
,
$cfg_sm_sswd
);

40 
	g$sm
->
	gdebug
 = 
l
;

41 
	g$sm
->
ndma
(
$cfg_ml
->
flds
['ema'], 
$cfg_sm_urma
, 
$mat
, 
$mabody
, 
$maty
);

45 @
ma
(
$cfg_ml
->
flds
['ema'], 
$mat
, 
$mabody
, 
$hds
);

48 
ShowMsg
('成功发送邮件，请稍后登录你的邮箱进行接收！', '-1');

49 
ex
();

51 if(
	g$fmdo
=='checkMail')

53 
$mid
 = 
tv
($mid);

54 if(
emy
(
$mid
))

56 
ShowMsg
('你的效验串不合法！', '-1');

57 
ex
();

59 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__member` where mid='{$mid}' ");

60 
	g$edUrhash
 = 
md5
(
$cfg_cook_code
.'--'.
$mid
.'--'.
$row
['email']);

61 if(
	g$edUrhash
 !
$urhash
)

63 
ShowMsg
('你的效验串不合法！', '-1');

64 
ex
();

66 if(
	g$row
['spacesta'] != -10)

68 
ShowMsg
('你的帐号不在邮件验证状态，本操作无效！', '-1');

69 
ex
();

71 
	g$dsql
->
ExecuNeQuy
("Update `#@__member` set spacesta=0 where mid='{$mid}' ");

72 
ShowMsg
('操作成功，请重新登录系统！', 'login.php');

73 
ex
();

78 if(
	g$fmdo
=='user')

82 if(
$do
=="checkuser")

84 
AjaxHd
();

85 
	g$msg
 = '';

86 
	g$uid
 = 
im
(
$uid
);

87 if(
	g$ckty
==0)

89 
$msgt
='用户笔名';

94 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

96 
	g$uesu
 = 
uc_ur_checkme
(
$uid
);

97 if(
	g$uesu
 > 0)

99 
	gecho
 "<font color='#4E7504'><b>√用户名可用</b></font>";

101 
if
(
$uesu
 == -1)

103 
echo
 "<font color='red'><b>×用户名不合法</b></font>";

105 
if
(
$uesu
 == -2)

107 
echo
 "<font color='red'><b>×包含要允许注册的词语</b></font>";

109 
if
(
$uesu
 == -3)

111 
echo
 "<font color='red'><b>×用户名已经存在</b></font>";

113 
ex
();

115 #/
a
}}

116 
	g$msgt
='用户名';

118 if(
	g$ckty
!=0 || 
$cfg_mb_wmee
=='N') {

119 
$msg
 = 
CheckUrID
(
$uid
, 
$msgt
);

122 
	g$msg
 = 
CheckUrID
(
$uid
, 
$msgt
, 
l
);

124 if(
	g$msg
=='ok')

126 
$msg
 = "<font color='#4E7504'><b>√{$msgtitle}可以使用</b></font>";

130 
	g$msg
 = "<font color='red'><b>×{$msg}</b></font>";

132 
echo
 
	g$msg
;

133 
ex
();

137 if(
	g$do
=="checkmail")

139 
AjaxHd
();

142 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

144 
	g$uesu
 = 
uc_ur_checkema
(
$ema
);

145 if(
	g$uesu
 > 0) {

146 
	gecho
 "<font color='#4E7504'><b>√可以使用</b></font>";

147 } 
if
(
$uesu
 == -4) {

148 
echo
 "<font color='red'><b>×Email 格式有误！</b></font>";

149 } 
if
(
$uesu
 == -5) {

150 
echo
 "<font color='red'><b>×Email 不允许注册！</b></font>";

151 } 
if
(
$uesu
 == -6) {

152 
echo
 "<font color='red'><b>×该 Email 已经被注册！</b></font>";

154 
ex
();

156 #/
a
}}

158 if(
	g$cfg_md_ma
=='N')

160 
$msg
 = "<font color='#4E7504'><b>√可以使用</b></font>";

164 if(!
CheckEma
(
$ema
))

166 
	g$msg
 = "<font color='#4E7504'><b>×Email格式有误</b></font>";

170 
	g$row
 = 
$dsql
->
GO
("Select mid From `#@__member` wheremailike '$email'imit 1");

171 if(!
is_y
(
$row
)) {

172 
	g$msg
 = "<font color='#4E7504'><b>√可以使用</b></font>";

175 
	g$msg
 = "<font color='red'><b>×Email已经被另一个帐号占用！</b></font>";

179 
echo
 
	g$msg
;

180 
ex
();

184 if(
	g$do
=="regnew")

187 
que_
(
dme
(
__FILE__
)."/reg_new.php");

188 
ex
();

194 if(
	g$do
=="money2s")

196 
CheckRk
(0,0);

197 if(
	g$cfg_mey_sces
==0)

199 
ShowMsg
('系统禁用了积分与金币兑换功能！', '-1');

200 
ex
();

202 
	g$mey
 = 
emy
(
$mey
? 0 : 
tv
($money);

203 if(
emy
(
$mey
))

205 
ShowMsg
('你没指定要兑换多少金币！', '-1');

206 
ex
();

209 
	g$edsces
 = 
$mey
 * 
$cfg_mey_sces
;

210 if(
	g$cfg_ml
->
	gflds
['sces'] < 
	g$edsces
 )

212 
ShowMsg
('你你积分不足，不能换取这么多的金币！', '-1');

213 
ex
();

215 
	g$lmsces
 = 
$cfg_ml
->
flds
['sces'] - 
$edsces
;

218 
	g$mtime
 = 
time
();

219 
	g$quy
 = "INSERT INTO `#@__member_operation`(`buyid` , `pname` , `product` , `money` , `mtime` , `pid` , `mid` , `sta` ,`oldinfo`)

220 
VALUES
 ('ScoresToMoney', '积分换金币操作', 'stc' , '0' , '$mtime' , '0' , '{$cfg_ml->M_ID}' , '0' , '用 {$needscores} 积分兑了换金币：{$money} 个'); ";

221 
	g$dsql
->
ExecuNeQuy
(
$quy
);

223 
	g$dsql
->
ExecuNeQuy
("upd`#@__memb` s `sces`=$lmsces, meymey + $mey whmid='".
$cfg_ml
->
M_ID
."' ");

224 
ShowMsg
('成功兑换指定量的金币！', 'operation.php');

225 
ex
();

234 if(
	g$fmdo
=='login')

238 if(
$do
=="login")

240 if(!
ist
(
$vdcode
))

242 
$vdcode
 = '';

244 
	g$svi
 = 
GCkVdVue
();

245 if(
ow
(
$vdcode
)!=
$svi
 || $svali=='')

247 
RetVdVue
();

248 
ShowMsg
("验证码错误！","-1");

249 
ex
();

251 if(
CheckUrID
(
$urid
,'',
l
)!='ok')

253 
ShowMsg
("你输入的用户名 {$userid} 不合法！","-1");

254 
ex
();

256 if(
	g$pwd
=='')

258 
ShowMsg
("密码不能为空！","-1",0,2000);

259 
ex
();

263 
	g$rs
 = 
$cfg_ml
->
CheckUr
(
$urid
,
$pwd
);

266 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

269 
li
(
$uid
, 
$uame
, 
$sswd
, 
$ema

uc_ur_log
(
$urid
, 
$pwd
);

270 if(
	g$uid
 > 0) {

271 
	g$sswd
 = 
md5
(
$sswd
);

273 if(!
	g$rs
) {

275 
	g$row
 = 
$dsql
->
GO
("SELECT `money`,`scores` FROM `#@__arcrank` WHERE `rank`='10' ");

276 
	g$sces
 = 
is_y
(
$row
) ? $row['scores'] : 0;

277 
	g$mey
 = 
is_y
(
$row
) ? $row['money'] : 0;

278 
	g$logtime
 = 
$jotime
 = 
time
();

279 
	g$log
 = 
$jo
 = 
GIP
();

280 
	g$s
 = 
$dsql
->
ExecuNeQuy
("INSERT INTO #@__member SET `mtype`='个人',`userid`='$username',`pwd`='$password',`uname`='$username',`sex`='男' ,`rank`='10',`money`='$money', `email`='$email', `scores`='$scores', `matt`='0', `face`='',`safequestion`='0',`safeanswer`='', `jointime`='$jointime',`joinip`='$joinip',`logintime`='$logintime',`loginip`='$loginip';");

281 if(
	g$s
) {

282 
	g$mid
 = 
$dsql
->
GLaID
();

283 
	g$da
 = 
y


286 `
bthday
`='1980-01-01', `
	g
`='1', `
	gcome
`='0', `
	geduti
`='0', `
	gheight
`='160', `
	gbodyty
`='0', `
	gblood
`='0', `
	gvoti
`='0', `
	gsmoke
`='0', `
	gm
`='0', `
	ghou
`='0',

287 `
	gdrk
`='0', `
	gdgty
`='0', `
	gnguage
`='', `
	gtu
`='', `
	glovemsg
`='', `
	gaddss
`='',`
	guime
`='0';",

292 
fܗch
(
$da
 
as
 
$v

	g$dsql
->
ExecuNeQuy
($val);

295 
	g$rs
 = 1;

296 
	g$row
 = 
$dsql
->
GO
("SELECT `mid`, `pwd` FROM #@__member WHERE `userid`='$username'");

297 if(
ist
(
$row
['mid']))

299 
	g$cfg_ml
->
PutLogInfo
(
$row
['mid']);

300 if(
	g$sswd
!=
$row
['pwd']
$dsql
->
ExecuNeQuy
("UPDATE #@__member SET `pwd`='$password' WHERE mid='$row[mid]'");

303 
	g$ucsyog
 = 
uc_ur_syog
(
$uid
);

304 } 
if
(
$uid
 == -1) {

306 if(
$rs
) {

307 
$row
 = 
$dsql
->
GO
("SELECT `email` FROM #@__member WHERE userid='$userid'");

308 
	g$uid
 = 
uc_ur_gi
(
$urid
, 
$pwd
, 
$row
['email']);

309 if(
	g$uid
 > 0
	g$ucsyog
 = 
uc_ur_syog
(
$uid
);

311 
	g$rs
 = -1;

314 
	g$rs
 = -1;

317 #/
a
}}

319 if(
	g$rs
==0)

321 
ShowMsg
("用户名不存在！","-1",0,2000);

322 
ex
();

324 if(
	g$rs
==-1) {

325 
ShowMsg
("密码错误！","-1",0,2000);

326 
ex
();

328 if(
	g$rs
==-2) {

329 
ShowMsg
("管理员帐号不允许从前台登录！","-1",0,2000);

330 
ex
();

334 if(
emy
(
$gou
|| 
egi
("action|_do",$gourl))

336 
ShowMsg
("成功登录，5秒钟后转向系统主页...","index.php",0,2000);

340 
ShowMsg
("成功登录，现在转向指定页面...",
$gou
,0,2000);

342 
ex
();

347 if(
	g$do
=="exit")

349 
$cfg_ml
->
ExCook
();

351 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

353 
	g$ucsyog
 = 
uc_ur_syogout
();

355 #/
a
}}

356 
ShowMsg
("成功退出登录！","index.php",0,2000);

357 
ex
();

362 
ShowMsg
("本页面禁止返回!","index.php");

	@member/login.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
dme
(
__FILE__
)."/templets/login.htm");

	@member/mtypes.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckRk
(0,0);

4 
	g$do
 = 
ist
(
$do
? 
	$im
(
$do
) : '';

5 if(
$do
 == '')

7 if(
	`emy
(
$chlid
)) $channelid = 0;

8 
$chlid
 = 
	`tv
($channelid);

9 
$mtyr
 = 
	`y
();

10 
$addquy
 = '';

11 if(!
	`emy
(
$chlid
)
$addquy
 = " And channelid='$channelid' ";

12 
$quy
 = "select * from `#@__mtypes` where mid='{$cfg_ml->M_ID}' $addquery ";

13 
$dsql
->
	`SQuy
(
$quy
);

14 
$dsql
->
	`Execu
();

15 
$row
 = 
$dsql
->
	`GAay
())

17 
$mtyr
[] = 
$row
;

19 
$l
 = 
w
 
	`DedeTeme
();

20 
$l
->
	`LdTeme
(
DEDEMEMBER
.'/templets/mtypes.htm');

21 
$l
->
	`Diy
();

22 
	`ex
();

23 
	}
}

24 
if
 (
$do
 == 'add')

26 
$mtyme
 = 
HtmlR
(
im
($mtypename));

27 
	g$chlid
 = 
tv
(
$chlid
);

28 if(
emy
(
$chlid
)
	g$chlid
 = 1;

29 if(

(
$mtyme
) > 40 || strlen($mtypename) < 2)

31 
ShowMsg
('分类名称必须大于两个字节少于40个字节', '-1');

32 
ex
();

34 
	g$quy
 = "insert into `#@__mtypes`(mtypename, channelid, mid) values ('$mtypename', '$channelid', '$cfg_ml->M_ID'); ";

35 if(
	g$dsql
->
ExecuNeQuy
(
$quy
))

37 
ShowMsg
('增加分类成功', 'mtypes.php');

41 
ShowMsg
('增加分类失败', '-1');

43 
ex
();

45 
if
 (
$do
 == 'save')

47 if(
ist
(
$mtyidr
&& 
is_y
($mtypeidarr))

49 
$dids
 = '0';

50 
	g$mtyidr
 = 
y_fr
(
$mtyidr
, 'is_numeric');

51 
fܗch
(
$mtyidr
 
as
 
$did
)

53 
	g$dids
 .','.
$did
;

54 
unt
(
$mtyme
[
$did
]);

56 
	g$quy
 = "delete from `#@__mtypes` where mtypeid in ($delids)nd mid='$cfg_ml->M_ID';";

57 
	g$dsql
->
ExecNeQuy
(
$quy
);

59 
fܗch
 (
$mtyme
 
as
 
$id
 => 
$me
)

61 
$me
 = 
HtmlR
($name);

62 
	g$quy
 = "update `#@__mtypes` set mtypename='$name' where mtypeid='$id'nd mid='$cfg_ml->M_ID'";

63 
	g$dsql
->
ExecuNeQuy
(
$quy
);

65 
ShowMsg
('分类修改完成','mtypes.php');

	@member/myfriend.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(
	g$cfg_mb_l
=='Y')

6 
ShowMsg
("由于系统开启了精简版会员空间，你访问的功能不可用！","-1");

7 
ex
();

9 
que_
(
DEDEINC
."/datalistcp.class.php");

11 if(!
	$ist
(
$y
))

13 
$y
 = 0;

14 
	}
}

15 if(!
	$ist
(
$do
))

17 
$do
 = '';

18 
	}
}

21 if(
	g$do
=='upsta')

23 
$ids
 = 
eg_a
("[^0-9,]","",$ids);

24 if(
	g$a
=='good')

26 
$upa
 = " ftype=1 ";

28 if(
	g$a
=='bad')

30 
$upa
 = " ftype=-1 ";

34 
	g$upa
 = " ftype=0 ";

36 
	g$dsql
->
ExecuNeQuy
("Update `#@__member_friends` set $upsta where id in($ids) And mid='{$cfg_ml->M_ID}' ");

39 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_/.php' && 
	g$a
!='bad')

41 if(
$da
 = 
uc_g_ur
(
$cfg_ml
->
M_LogID
)
uc_nd_add
(
$uid
, $data[0]);

43 #/
a
}}

45 if(
	g$a
=='good')

47 
ShowMsg
("成功把指定好友设为关注好友！","myfriend.php?ftype=1");

49 if(
	g$a
=='bad')

51 
ShowMsg
("成功把指定好友放入黑名单！","myfriend.php?ftype=-1");

55 
ShowMsg
("成功把指定好友转为普通好友！","myfriend.php");

57 
ex
();

61 if(
	g$do
=='del')

63 
$ids
 = 
eg_a
("[^0-9,]","",$ids);

65 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

67 if(
	g$da
 = 
uc_g_ur
(
$cfg_ml
->
M_LogID
))

69 
li
(
$uid
, 
$uame
, 
$ema

$da
;

70 
	g$ndids
 = @
exode
(",", 
$ids
);

71 if(!
emy
(
$ndids
)
uc_nd_de
(
$uid
 , $friendids);

74 #/
a
}}

75 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__member_friends` where id in($ids) And mid='{$cfg_ml->M_ID}' ");

76 
ShowMsg
("成功删除所选的好友！","mynd.php?y=".
$y
);

77 
ex
();

83 
	g$wsql
 = '';

84 if(
emy
(
$y
))

86 
	g$wsql
 = " mid='{$cfg_ml->M_ID}' And ftype <> '-1' ";

87 
	g$ame
 = "所有好友";

89 if(
	g$y
==1)

91 
$wsql
 = " mid='{$cfg_ml->M_ID}' And ftype = '1' ";

92 
	g$ame
 = "特别关注";

94 if(
	g$y
==-1)

96 
$wsql
 = " mid='{$cfg_ml->M_ID}' And ftype = '-1' ";

97 
	g$ame
 = "黑名单";

100 
	g$quy
 = "Select * From `#@__member_friends` where $wsql order by id desc";

101 
	g$dli
 = 
w
 
DaLiCP
();

102 
	g$dli
->
	ggeSize
 = 20;

103 
	g$dli
->
SPam
("y",
$y
);

104 
	g$dli
->
STeme
(
dme
(
__FILE__
).'/templets/myfriend.htm');

105 
	g$dli
->
SSour
(
$quy
);

106 
	g$dli
->
Diy
();

109 
funi
 
gUrInfo
(
$uid
,
$_fld
 = 'uname')

111 
glob
 
$dsql
;

112 
	g$row
 = 
$dsql
->
GO
("SELECT M.*,S.spacename,S.sign FROM #@__member AS M LEFT JOIN #@__member_space AS S ON M.mid=M.mid WHERE M.mid='$uid'");

113 if(
ist
(
$row
[
$_fld
]))

115 if(
	g$_fld
 == 'face')

117 
$row
[
$_fld
] = 
emy
($row[$_field]) ? 'images/dfboy.gif' : $row[$_field];

119  
	g$row
[
$_fld
];

	@member/mypay.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
.'/datalistcp.class.php');

5 
tcook
('ENV_GOBACK_URL', 
GCurU
(), 
time
()+3600, '/');

6 
	g$quy
 = "Se * From `#@__memb_ݔi` whmid='".
$cfg_ml
->
M_ID
."' Androduct='archive' order byid desc";

7 
	g$dli
 = 
w
 
DaLiCP
();

8 
	g$dli
->
	ggeSize
 = 20;

9 
	g$dli
->
STeme
(
DEDEMEMBER
.'/templets/mypay.htm');

10 
	g$dli
->
SSour
(
$quy
);

11 
	g$dli
->
Diy
();

	@member/mystow.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
tcook
("ENV_GOBACK_URL",
GCurU
(),
time
()+3600,"/");

6 
	g$ty
 = 
ist
(
$ty
? 
	$im
(
$ty
) : '';

7 
$l
 = '';

8 if(
$ty
 == '')

10 
$sql
 = "Se * From `#@__memb_ow` whmid='".
$cfg_ml
->
M_ID
."' order by id desc";

11 
$l
 = 'mystow';

12 
	}
}

15 
	g$sql
 = "select *,count(aid)sum from #@__member_stow group byid order byum desc";

16 
	g$l
 = 'stowtop';

19 
	g$dli
 = 
w
 
DaLiCP
();

20 
	g$dli
->
	ggeSize
 = 20;

21 
	g$dli
->
STeme
(
DEDEMEMBER
."/templets/$tpl.htm");

22 
	g$dli
->
SSour
(
$sql
);

23 
	g$dli
->
Diy
();

	@member/operation.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
CheckRk
(0,0);

5 
tcook
("ENV_GOBACK_URL",
GCurU
(),
time
()+3600,"/");

7 
funi
 
	$GS
(
$a
){

8 if(
$a
==0)  '未付款';

9 if(
$a
==1)  '已付款';

11 
	}
}

13 
	g$sql
 = "Se * From `#@__memb_ݔi` whmid='".
$cfg_ml
->
M_ID
."' Androduct<>'archive' order byid desc";

14 
	g$dli
 = 
w
 
DaLiCP
();

15 
	g$dli
->
	ggeSize
 = 20;

16 
	g$dli
->
STeme
(
DEDEMEMBER
."/templets/operation.htm");

17 
	g$dli
->
SSour
(
$sql
);

18 
	g$dli
->
Diy
();

	@member/paycenter/alipay/alipay_config.php

1 <?
php


2 
	g$r
 = 
$ymt_urid
[2];

3 
	g$cury_code
 = 
$ymt_key
[2];

4 
	g$Δ_ema
 = 
$ymt_ema
[2];

5 
	g$_put_cht
 = 
$cfg_so_ng
;

6 
	g$sign_ty
 = "MD5";

7 
	g$t
 = "http";

8 
	g$nify_u
 = 
$cfg_baho
."/member/paycenter/alipay/notify_url.php";

9 
	g$tu_u
 = 
$cfg_baho
."/member/paycenter/alipay/return_url.php";

10 
	g$show_u
 = ""

	@member/paycenter/alipay/alipay_notify.php

1 <?
php


2 as
	cay_nify


4 
v
 
	m$geway
;

5 
v
 
	m$cury_code
;

6 
v
 
	m$r
;

7 
v
 
	m$sign_ty
;

8 
v
 
	m$mysign
;

9 
v
 
	m$_put_cht
 ;

10 
v
 
	m$t
;

12 
funi
 
ay_nify
(
$r
,
$cury_code
,
$sign_ty
 = "MD5",
$_put_cht
 = "GBK",
$t
= "https")

14 
$this
->
r
 = 
$r
;

15 
	m$this
->
	mcury_code
 = 
$cury_code
;

16 
	m$this
->
	msign_ty
 = 
$sign_ty
;

17 
	m$this
->
	mmysign
 = "";

18 
	m$this
->
	m_put_cht
 = 
$_put_cht
 ;

19 
	m$this
->
	mt
 = 
$t
;

20 if(
	m$this
->
	mt
 == "https")

22 
$this
->
geway
 = "https://www.alipay.com/cooperate/gateway.do?";

23 } 
	m$this
->
	mgeway
 = "http://notify.alipay.com/trade/notify_query.do?";

27 
funi
 
	$nify_vify
()

31 if(
$this
->
t
 == "https")

33 
$vyfy_u
 = 
$this
->
geway
. "rviify_vify" ."&r=" .$this->
r
. "&nify_id=".
$_POST
["notify_id"];

37 
$vyfy_u
 = 
$this
->
geway
. "r=".$this->
r
."&nify_id=".
$_POST
["notify_id"];

39 
$vyfy_su
 = 
$this
->
	`g_vify
(
$vyfy_u
);

40 
$po
 = 
$this
->
	`_fr
(
$_POST
);

41 
$st_po
 = 
$this
->
	`g_st
(
$po
);

42 
	`li
 (
$key
, 
$v

	`ch
 (
$st_po
))

44 
$g
.=
$key
."=".
$v
."&";

46 
$er
 = 
	`subr
(
$g
,0,
	`cou
($arg)-2);

47 
$this
->
mysign
 = $this->
	`sign
(
$er
.$this->
cury_code
);

48 i(
	`egi
("ue$",
$vyfy_su
&& 
$this
->
mysign
 =
$_POST
["sign"])

50  
ue
;

54  
l
;

56 
	}
}

58 
funi
 
	$tu_vify
()

61 
$st_g

$this
->
	`g_st
(
$_GET
);

62 
	`li
 (
$key
, 
$v

	`ch
 (
$st_g
))

64 if(
$key
 != "sign" && $key != "sign_type")

66 
$g
.=
$key
."=".
$v
."&";

69 
$er
 = 
	`subr
(
$g
,0,
	`cou
($arg)-2);

70 
$this
->
mysign
 = $this->
	`sign
(
$er
.$this->
cury_code
);

74 
	`log_su
("tu_u_log=".
$_GET
["sign"]."&".
$this
->
mysign
."&".$this->
	`cht_decode
(
	`imode
(",",$_GET),$this->
_put_cht
 ));

75 i(
$this
->
mysign
 =
$_GET
["sign"])

77  
ue
;

81  
l
;

83 
	}
}

85 
funi
 
g_vify
(
$u
,
$time_out
 = "60")

87 
$ur
 = 
r_u
(
$u
);

88 
	g$o
 = "";

89 
	g$rr
 = "";

90 
	g$ts
 = "";

91 if(
	g$ur
["scheme"] == "https")

93 
$ts
 = "ssl://";

94 
	g$ur
["port"] = "443";

98 
	g$ts
 = "tcp://";

99 
	g$ur
["port"] = "80";

101 
	g$
=@
fsockݒ
(
$ts
 . 
$ur
['ho'],$ur['pt'],
$o
,
$rr
,
$time_out
);

102 if(!
	g$
)

104 
d
("ERROR: $errno - $errstr<br />\n");

108 
uts
(
$
, "POST ".
$ur
["path"]." HTTP/1.1\r\n");

109 
uts
(
$
, "Ho: ".
$ur
["host"]."\r\n");

110 
uts
(
$
, "Content-type:pplication/x-www-form-urlencoded\r\n");

111 
uts
(
$
, "Cڋ-ngth: ".

(
$ur
["query"])."\r\n");

112 
uts
(
$
, "Connection: close\r\n\r\n");

113 
uts
(
$
, 
$ur
["query"] . "\r\n\r\n");

114 !
of
(
$
))

116 
	g$fo
[]=@
fgs
(
$
, 1024);

118 
fo
(
$
);

119 
	g$fo
 = 
imode
(",",
$fo
);

120 
li
 (
$key
, 
$v

ch
 (
$_POST
))

122 
$g
.=
$key
."=".
$v
."&";

124 
log_su
("nify_u_log=".
$u
.
$this
->
cht_decode
(
$fo
,$this->
_put_cht
));

125 
log_su
("nify_u_log=".
$this
->
cht_decode
(
$g
,$this->
_put_cht
));

126  
	g$fo
;

130 
funi
 
	$g_st
(
$y
)

132 
	`kst
(
$y
);

133 
	`t
(
$y
);

134  
$y
;

135 
	}
}

137 
funi
 
	$sign
(
$er
)

139 
$sign
='';

140 if(
$this
->
sign_ty
 == 'MD5')

142 
$sign
 = 
	`md5
(
$er
);

144 
	`if
(
$this
->
sign_ty
 =='DSA')

148 
	`d
("DSA 签名方法待后续开发，请先使用MD5签名方式");

152 
	`d
("支付宝暂不支持".
$this
->
sign_ty
."类型的签名方式");

154  
$sign
;

156 
	}
}

158 
funi
 
	$_fr
(
$m
)

161 
$
 = 
	`y
();

162 
	`li
 (
$key
, 
$v

	`ch
 (
$m
))

164 if(
$key
 ="sign" || $key ="sign_ty" || 
$v
 == "")

170 
$
[
$key
] = 
$m
[$key];

174  
$
;

175 
	}
}

178 
funi
 
cht_code
(
$put
,
$_ouut_cht
 ,
$_put_cht
 ="GBK" )

180 
$ouut
 = "";

181 if(!
ist
(
$_ouut_cht
) )

183 
	g$_ouut_cht
 = 
$this
->
m
['_input_charset '];

185 if(
	g$_put_cht
 =
$_ouut_cht
 || 
$put
 ==
nu
 )

187 
$ouut
 = 
$put
;

189 
if
 (
funi_exis
("mb_convert_encoding"))

191 
	g$ouut
 = 
mb_cvt_codg
(
$put
,
$_ouut_cht
,
$_put_cht
);

193 
if
(
funi_exis
("iconv"))

195 
	g$ouut
 = 
icv
(
$_put_cht
,
$_ouut_cht
,
$put
);

199 
d
("sorry, you haveoibs support for charset change.");

201  
	g$ouut
;

205 
funi
 
cht_decode
(
$put
,
$_put_cht
 ,
$_ouut_cht
="GBK" )

207 
$ouut
 = "";

208 if(!
ist
(
$_put_cht
) )

210 
	g$_put_cht
 = 
$this
->
_put_cht
 ;

212 if(
	g$_put_cht
 =
$_ouut_cht
 || 
$put
 ==
nu
 )

214 
$ouut
 = 
$put
;

216 
if
 (
funi_exis
("mb_convert_encoding"))

218 
	g$ouut
 = 
mb_cvt_codg
(
$put
,
$_ouut_cht
,
$_put_cht
);

220 
if
(
funi_exis
("iconv"))

222 
	g$ouut
 = 
icv
(
$_put_cht
,
$_ouut_cht
,
$put
);

226 
d
("sorry, you haveoibs support for charset changes.");

228  
	g$ouut
;

	@member/paycenter/alipay/alipay_service.php

1 <?
php


2 as
	cay_rvi


4 
v
 
	m$geway
 = "https://www.alipay.com/cooperate/gateway.do?";

5 
v
 
	m$m
;

6 
v
 
	m$cury_code
;

7 
v
 
	m$mysign
;

10 
funi
 
ay_rvi
(
$m
,
$cury_code
,
$sign_ty
 = "MD5",
$t
= "https")

12 
$this
->
m
 = $this->
_fr
(
$m
);

13 
	m$this
->
	mcury_code
 = 
$cury_code
;

14 
	m$this
->
	msign_ty
 = 
$sign_ty
;

15 
	m$this
->
	mmysign
 = '';

16 
	m$this
->
	mt
 = 
$t
;

17 if(
	m$m
['_input_charset'] == "")

19 
$this
->
m
['_input_charset']='GBK';

21 if(
	m$this
->
	mt
 == "https")

23 
$this
->
geway
 = "https://www.alipay.com/cooperate/gateway.do?";

27 
	m$this
->
	mgeway
 = "http://www.alipay.com/cooperate/gateway.do?";

29 
	m$st_y
 = 
y
();

30 
	m$g
 = "";

31 
	m$st_y
 = 
$this
->
g_st
($this->
m
);

32 
li
 (
$key
, 
$v

ch
 (
$st_y
))

34 
$g
.=
$key
."=".
$this
->
cht_code
(
$v
,$this->
m
['_input_charset'])."&";

36 
	m$er
 = 
subr
(
$g
,0,
cou
($arg)-2);

37 
	m$this
->
	mmysign
 = 
$this
->
sign
(
$er
.$this->
cury_code
);

40 
funi
 
	$_u
()

42 
$u
 = 
$this
->
geway
;

43 
$st_y
 = 
	`y
();

44 
$g
 = "";

45 
$st_y
 = 
$this
->
	`g_st
($this->
m
);

46 
	`li
 (
$key
, 
$v

	`ch
 (
$st_y
))

48 
$g
.=
$key
."=".
	`ucode
(
$this
->
	`cht_code
(
$v
,$this->
m
['_input_charset']))."&";

50 
$u
.
$g
."sign=" .
$this
->
mysign
 ."&sign_ty=".$this->
sign_ty
;

51  
$u
;

52 
	}
}

54 
funi
 
	$g_st
(
$y
)

56 
	`kst
(
$y
);

57 
	`t
(
$y
);

58  
$y
;

59 
	}
}

61 
funi
 
	$sign
(
$er
)

63 
$mysign
 = "";

64 if(
$this
->
sign_ty
 == 'MD5')

66 
$mysign
 = 
	`md5
(
$er
);

68 
	`if
(
$this
->
sign_ty
 =='DSA')

72 
	`d
("DSA 签名方法待后续开发，请先使用MD5签名方式");

76 
	`d
("支付宝暂不支持".
$this
->
sign_ty
."类型的签名方式");

78  
$mysign
;

79 
	}
}

81 
funi
 
	$_fr
(
$m
)

85 
$
 = 
	`y
();

86 
	`li
 (
$key
, 
$v

	`ch
 (
$m
))

88 if(
$key
 ="sign" || $key ="sign_ty" || 
$v
 == "")

94 
$
[
$key
] = 
$m
[$key];

98  
$
;

99 
	}
}

102 
funi
 
cht_code
(
$put
,
$_ouut_cht
 ,
$_put_cht
 ="GBK" )

104 
$ouut
 = "";

105 if(!
ist
(
$_ouut_cht
) )

107 
	g$_ouut_cht
 = 
$this
->
m
['_input_charset '];

109 if(
	g$_put_cht
 =
$_ouut_cht
 || 
$put
 ==
nu
)

111 
$ouut
 = 
$put
;

113 
if
 (
funi_exis
("mb_convert_encoding"))

115 
	g$ouut
 = 
mb_cvt_codg
(
$put
,
$_ouut_cht
,
$_put_cht
);

117 
if
(
funi_exis
("iconv"))

119 
	g$ouut
 = 
icv
(
$_put_cht
,
$_ouut_cht
,
$put
);

123 
d
("sorry, you haveoibs support for charset change.");

125  
	g$ouut
;

	@member/paycenter/alipay/notify_url.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../include/common.inc.php");

3 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

4 
que_
(
DEDEINC
."/memberlogin.class.php");

5 
que_
(
dme
(
__FILE__
)."/alipay_config.php");

6 
que_
(
dme
(
__FILE__
)."/alipay_notify.php");

7 
	g$cfg_ml
 = 
w
 
MembLog
();

8 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

9 if(
	g$cfg_ml
->
	gM_ID
>0)

11 
	g$bu
 = 
$cfg_baho
."/member/control.php";

15 
	g$bu
 = "javascript:;";

17 
	g$ay
 = 
w
 
ay_nify
(
$r
,
$cury_code
,
$sign_ty
,
$_put_cht
,
$t
);

18 
	g$vify_su
 = 
$ay
->
nify_vify
();

19 if(
	g$vify_su
)

23 
	g$dgd
=
$_POST
['out_trade_no'];

24 
	g$tٮ
=
$_POST
['total_fee'];

25 
	g$ive_me
 =
$_POST
['receive_name'];

26 
	g$ive_addss
 =
$_POST
['receive_address'];

27 
	g$ive_z
 =
$_POST
['receive_zip'];

28 
	g$ive_phe
 =
$_POST
['receive_phone'];

29 
	g$ive_mobe
 =
$_POST
['receive_mobile'];

30 
	g$ade_us
=
$_POST
['trade_status'];

31 if(
	g$_POST
['trade_status'] == 'TRADE_FINISHED')

35 
$buyid
 = 
$dgd
;

38 
	g$row
 = 
$dsql
->
GO
("Select * From #@__member_operation where buyid='$buyid' ");

39 if(!
is_y
(
$row
)||
	g$row
['sta']==2)

41 
$dfo
 = 
$row
['oldinfo'];

42 
ex
("success");

44 
	g$mid
 = 
$row
['mid'];

45 
	g$pid
 = 
$row
['pid'];

48 
	g$dsql
->
ExecuNeQuy
("Update #@__member_operation set sta=1 where buyid='$buyid' ");

53 if(
	g$row
['product']=='member')

55 
$row
 = 
$dsql
->
GO
(" Selectank,exptime From #@__member_type whereid='{$row['pid']}' ");

56 
	g$nk
 = 
$row
['rank'];

57 
	g$exime
 = 
$row
['exptime'];

58 
	g$equy
 = " Update #@__member set

59 
membty
='$nk',
	gexime
='$exime',
	guime
='".time()."' 
whe
 
ID
='$mid' ";

60 
$dsql
->
ExecuNeQuy
(
$equy
);

63 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='会员升级成功！' where buyid='$buyid' ");

64 
	g$dsql
->
Clo
();

68 if(
	g$row
['product']=='card')

70 
$row
 = 
$dsql
->
GO
("Select cardid From #@__moneycard_record where ctid='$pid' And isexp='0' ");

73 if(!
is_y
(
$row
))

75 
	g$ow
 = 
$dsql
->
GO
("Selectum From #@__moneycard_type whereid='$pid' ");

76 
	g$dnum
 = 
$ow
['num'];

77 
	g$equy
 = " Upd#@__memb s mey=mey+".
$dnum
." where mid='$mid' ";

78 
	g$dsql
->
ExecuNeQuy
(
$equy
);

80 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='直接充值了 {$dnum} 金币到帐号！' where buyid='$buyid' ");

81 
ex
();

85 
	g$rdid
 = 
$row
['cardid'];

86 
	g$dsql
->
ExecuNeQuy
(" Upd#@__meyrd_cd s uid='$mid',ixp='1',utime='".
time
()."' where cardid='$cardid' ");

89 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='充值密码：{$cardid}' where buyid='$buyid' ");

92 
	gecho
 "success";

94 
log_su
("verify_success");

98 
	gecho
 "fail";

100 
log_su
 ("verify_failed");

103 
funi
 
	$log_su
(
$wd
)

105 
$
 = 
	`fݒ
("log.txt","a");

106 
	`ock
(
$
, 
LOCK_EX
) ;

107 
	`fwre
(
$
,
$wd
."：执行日期：".
	`rime
("%Y%m%d%H%I%S",
	`time
())."\t\n");

108 
	`ock
(
$
, 
LOCK_UN
);

109 
	`fo
(
$
);

110 
	}
}

	@member/paycenter/alipay/return_url.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../include/common.inc.php");

3 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

4 
que_
(
DEDEINC
."/memberlogin.class.php");

5 
que_
(
dme
(
__FILE__
)."/alipay_config.php");

6 
que_
(
dme
(
__FILE__
)."/alipay_notify.php");

7 
	g$cfg_ml
 = 
w
 
MembLog
();

8 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

9 if(
	g$cfg_ml
->
	gM_ID
>0
	g$bu
 = 
$cfg_baho
."/member/control.php";

10 
	g$bu
 = "javascript:;";

11 
	g$ay
 = 
w
 
ay_nify
(
$r
,
$cury_code
,
$sign_ty
,
$_put_cht
,
$t
);

12 
	g$vify_su
 = 
$ay
->
tu_vify
();

14 
	g$dgd
 =
$_GET
['out_trade_no'];

15 
	g$tٮ_e
 =
$_GET
['total_fee'];

16 
	g$ive_me
 =
$_GET
['receive_name'];

17 
	g$ive_addss
 =
$_GET
['receive_address'];

18 
	g$ive_z
 =
$_GET
['receive_zip'];

19 
	g$ive_phe
 =
$_GET
['receive_phone'];

20 
	g$ive_mobe
 =
$_GET
['receive_mobile'];

21 if(
	g$vify_su
)

25 
	g$buyid
 = 
$dgd
;

28 
	g$row
 = 
$dsql
->
GO
("Select * From #@__member_operation where buyid='$buyid' ");

29 if(!
is_y
(
$row
)||
	g$row
['sta']==2)

31 
$dfo
 = 
$row
['oldinfo'];

32 
	g$msg
 = "本交易已经完成！，系统返回信息( $oldinfo ) <br><br> <a href='$burl'arget='_bank'>返回主页</a> ";

33 
ShowMsg
(
$msg
,"javascript:;");

34 
	g$dsql
->
Clo
();

35 
ex
();

37 
	g$mid
 = 
$row
['mid'];

38 
	g$pid
 = 
$row
['pid'];

41 
	g$dsql
->
ExecuNeQuy
("Update #@__member_operation set sta=1 where buyid='$buyid' ");

46 if(
	g$row
['product']=='member')

48 
$row
 = 
$dsql
->
GO
(" Selectank,exptime From #@__member_type whereid='{$row['pid']}' ");

49 
	g$nk
 = 
$row
['rank'];

50 
	g$exime
 = 
$row
['exptime'];

51 
	g$equy
 = " Upd#@__memb s membty='$nk',exime='$exime',uime='".
time
()."' where mid='$mid' ";

52 
	g$dsql
->
ExecuNeQuy
(
$equy
);

55 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='会员升级成功！' where buyid='$buyid' ");

56 
	g$dsql
->
Clo
();

57 
ShowMsg
("成功完成交易！",
$bu
);

58 
ex
();

62 if(
	g$row
['product']=='card')

64 
$row
 = 
$dsql
->
GO
("Select cardid From #@__moneycard_record where ctid='$pid' And isexp='0' ");

67 if(!
is_y
(
$row
))

69 
	g$ow
 = 
$dsql
->
GO
("Selectum From #@__moneycard_type whereid='$pid' ");

70 
	g$dnum
 = 
$ow
['num'];

71 
	g$equy
 = " Upd#@__memb s mey=mey+".
$dnum
." where mid='$mid' ";

72 
	g$dsql
->
ExecuNeQuy
(
$equy
);

74 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='直接充值了 {$dnum} 金币到帐号！' where buyid='$buyid' ");

75 
ShowMsg
("由于此点卡已经卖完，系统直接为你的帐号增加了：{$dnum} 个金币！",
$bu
);

76 
ex
();

80 
	g$rdid
 = 
$row
['cardid'];

81 
	g$dsql
->
ExecuNeQuy
(" Upd#@__meyrd_cd s uid='$mid',ixp='1',utime='".
time
()."' where cardid='$cardid' ");

84 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='充值密码：{$cardid}' where buyid='$buyid' ");

85 
ShowMsg
("交易成功！<a href='$burl'arget='_bank'><u>[返回]</u></a><br> 充值密码：{$cardid}","javascript:;");

86 
ex
();

89 
log_su
("verify_success");

93 
	g$msg
 = "支付失败.";

94 
ShowMsg
(
$msg
,"javascript:;");

97 
log_su
 ("verify_failed");

98 
	gex
;

102 
funi
 
	$log_su
(
$wd
)

104 
$
 = 
	`fݒ
("log.txt","a");

105 
	`ock
(
$
, 
LOCK_EX
) ;

106 
	`fwre
(
$
,
$wd
."：执行日期：".
	`rime
("%Y%m%d%H%I%S",
	`time
())."\t\n");

107 
	`ock
(
$
, 
LOCK_UN
);

108 
	`fo
(
$
);

109 
	}
}

	@member/paycenter/cbpayment/autoreceive.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../include/common.inc.php");

3 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

4 
que_
(
dme
(
__FILE__
)."/cbpayment_config.php");

5 
que_
(
DEDEINC
."/memberlogin.class.php");

6 
	g$cfg_ml
 = 
w
 
MembLog
();

7 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

9 
	g$v_oid
 =
im
(
$_POST
['v_oid']);

10 
	g$v_pmode
 =
im
(
$_POST
['v_pmode']);

11 
	g$v_pus
 =
im
(
$_POST
['v_pstatus']);

12 
	g$v_prg
 =
im
(
$_POST
['v_pstring']);

13 
	g$v_amou
 =
im
(
$_POST
['v_amount']);

14 
	g$v_meyty
 =
im
(
$_POST
['v_moneytype']);

15 
	g$mk1
 =
im
(
$_POST
['remark1' ]);

16 
	g$mk2
 =
im
(
$_POST
['remark2' ]);

17 
	g$v_md5r
 =
im
(
$_POST
['v_md5str' ]);

19 
	g$md5rg
=
ou
(
md5
(
$v_oid
.
$v_pus
.
$v_amou
.
$v_meyty
.
$key
));

20 i(
	g$v_md5r
==
$md5rg
)

22 if(
$v_pus
=="20")

24 
$buyid
 = 
$v_oid
;

27 
	g$row
 = 
$dsql
->
GO
("Select * From #@__member_operation where buyid='$buyid' ");

28 if(!
is_y
(
$row
)||
	g$row
['sta']==2)

30 
$dfo
 = 
$row
['oldinfo'];

31 
ex
('ok');

33 
	g$mid
 = 
$row
['mid'];

34 
	g$pid
 = 
$row
['pid'];

37 
	g$dsql
->
ExecuNeQuy
("Update #@__member_operation set sta=1 where buyid='$buyid' ");

42 if(
	g$row
['product']=='member')

44 
$row
 = 
$dsql
->
GO
(" Selectank,exptime From #@__member_type whereid='{$row['pid']}' ");

45 
	g$nk
 = 
$row
['rank'];

46 
	g$exime
 = 
$row
['exptime'];

47 
	g$equy
 = " Update #@__member set

48 
membty
='$nk',
	gexime
='$exime',
	guime
='".time()."' 
whe
 
mid
='$mid' ";

49 
$dsql
->
ExecuNeQuy
(
$equy
);

52 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='会员升级成功！' where buyid='$buyid' ");

56 if(
	g$row
['product']=='card')

58 
$row
 = 
$dsql
->
GO
("Select cardid From #@__moneycard_record where ctid='$pid' And isexp='0' ");

61 if(!
is_y
(
$row
))

63 
	g$ow
 = 
$dsql
->
GO
("Selectum From #@__moneycard_type whereid='$pid' ");

64 
	g$dnum
 = 
$ow
['num'];

65 
	g$equy
 = " Upd#@__memb s mey=mey+".
$dnum
." where mid='$mid' ";

66 
	g$dsql
->
ExecuNeQuy
(
$equy
);

69 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='直接充值了 {$dnum} 金币到帐号！' where buyid='$buyid' ");

70 
ex
();

74 
	g$rdid
 = 
$row
['cardid'];

75 
	g$dsql
->
ExecuNeQuy
(" Upd#@__meyrd_cd s uid='$mid',ixp='1',utime='".
time
()."' where cardid='$cardid' ");

78 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='充值密码：{$cardid}' where buyid='$buyid' ");

82 
	gecho
 "ok";

86 
	gecho
 "error";

	@member/paycenter/cbpayment/cbpayment_config.php

1 <?
php


2 
	g$v_mid
 = 
$ymt_urid
[3];

3 
	g$v_u
 = 
$cfg_baho
.'/member/paycenter/cbpayment/receive.php';

4 
	g$key
 = 
$ymt_key
[3];

5 
	g$v_meyty
 = 'CNY';

6 
	g$v_rcvema
 = 
$ymt_ema
[3];

7 
	g$v_po_u
 = 'https://pay3.chinabank.com.cn/PayGate';

	@member/paycenter/cbpayment/receive.php

1 < ?     

4   *                        . . .  

6   *  @                      

7   *  @                        

8   *  @          $        :         .    ,   $  

9   *  @           $         :  1 . 1  $  

10   *  @       $     :  2 0 0 9 / 0 8 / 0 4  0 4 : 0 8 : 3 7  $  

12         _     (        ( _ _     _ _ ) . " / . . / . . / . . /        /       .    .    " ) ;  

13         _              . ' /    _    .      .    ' ;  

14         _     (        ( _ _     _ _ ) . " /          _       .    " ) ;  

15         _     (        . " /            .      .    " ) ;  

16  
	g$
    _    =                 ( ) ;  

17  
	g$
    _   - >             ( $    _   - >  _   ) ;  

18    ( $    _   - >  _   > 0 )  $      =  $    _         . " /       /        .    " ;  

19       $      =  "           : ; " ;  

21  
	g$
  _         =     ( $ _     [ '  _    ' ] ) ;        / /  7bSvv _    [USS     

22  
$
  _         =     ( $ _     [ '  _      ' ] ) ;     / /  /eNe_W[&{2N      

23  
$
  _         =     ( $ _     [ '  _        ' ] ) ;    / /   /eNr`  2 0 /eNR 3 0 /eN1Y%   

24  
	g$
  _         =     ( $ _     [ '  _        ' ] ) ;    / /  /eN~gOo`    /eN[S_v _        = 2 0 1Y%SVS_v _        = 3 0 e, [&{2N    

25  
$
  _         =     ( $ _     [ '  _       ' ] ) ;      / /  US[E/eNё  

26  
$
  _            =     ( $ _     [ '  _          ' ] ) ;  / / US[E/eN^y      

27  
$
       1    =     ( $ _     [ '       1 '  ] ) ;       / / lW[k1  

28  
$
       2    =     ( $ _     [ '       2 '  ] ) ;      / / lW[k2  

29  
$
  _   5      =     ( $ _     [ '  _   5    '  ] ) ;    / / bQvM  5 !h<P    

31  
	g$
   5       =           (   5 ( $  _    . $  _        . $  _       . $  _          . $    ) ) ;  

33     ( $  _   5    = = $   5       )  

35     ( $  _        = = " 2 0 " ) {  

36    / / /
e

N
R  

37    
$
       =  $  _    ;  

38    / / 
	gS

	gUS

	gOo
` 
	gh

	gg
US
v
 
	ggHe
'` 

39    
	g$
     =  $     - >       ( "        *       # @ _ _       _                      = ' $      '  " ) ;  

40      ( !   _      ( $    ) | | $    [ '    ' ] = = 2 ) {  

41     
$
         =  $    [ '        ' ] ;  

42     
	g$
     =  " ,gN]~[|~ԏVOo`(  $         )  <   > <   >  <       = ' $     '        = ' _     ' > ԏV;Nu< /  >  " ;  

43            ( $    , "           : ; " ) ;  

44     
	g$
     - >      ( ) ;  

45         ( ) ;  

47    
	g$
     =  $    [ '    ' ] ;  

48    
	g$
     =  $    [ '    ' ] ;  

49    / / 
	gf

	ge

	gN

	gr
`:
N
]N>
k
  

50    
$
     - >                 ( "        # @ _ _       _                  = 1             = ' $      '  " ) ;  

52    / / NT  

54      ( $    [ '        ' ] = = '       ' )  

56     
$
     =  $     - >       ( "             ,              # @ _ _       _               = ' { $    [ '    ' ] } '  " ) ;  

57     
	g$
      =  $    [ '     ' ] ;  

58     
	g$
         =  $    [ '        ' ] ;  

59     
	g$
        =   "         # @ _ _             

60                     = ' $     ' ,        = ' $        ' ,       = ' " .     ( ) . " '          = ' $    '  " ;  

61     
$
     - >                 ( $       ) ;  

62     / / 
	gf

	ge

	gN

	gr
`:
N
]
sQ
  

63     
$
     - >                 ( "         # @ _ _       _                  = 2 ,        = ' ~R'             = ' $      '  " ) ;  

64     
	g$
     - >      ( ) ;  

65            ( " R[N" , $     ) ;  

66         ( ) ;  

68    / / 
	gS

	gN

	gT
  

69           ( $    [ '        ' ] = = '     ' )  

71     
$
     =  $     - >       ( "                    # @ _ _          _                  = ' $    '           = ' 0 '  " ) ;  

72     / / 
	gY

	gg
~
b
 
	gN0R
g
	gy
{|
	gW

	gvaS
 
	gv

	gc
:
N
(
u7b

X

R
ё^  

73       ( !   _      ( $    ) ) {  

74      
$
      =  $     - >       ( "                  # @ _ _          _               = ' $    '  " ) ;  

75      
$
      =  $     [ '    ' ] ;  

76      
$
        =   "         # @ _ _                 =      + " . $     . "           = ' $    '  " ;  

77      
$
     - >                 ( $       ) ;  

78      / / 
f

e

N

r
`:N]
sQ
  

79      
$
     - >                 ( "         # @ _ _       _                  = 2 ,        = ' vcEQ<PN  { $     }  ё^0R^S'             = ' $      '  " ) ;  

80             ( " 1uNdkS]~VS[|~vc:N`Ov^SXRN{ $     }  *Nё^" , $     ) ;  

81      
$
     - >      ( ) ;  

82          ( ) ;  

83     }     {  

84      
$
        =  $    [ '       ' ] ;  

85      
$
     - >                 ( "         # @ _ _          _               = ' $    ' ,      = ' 1 ' ,      = ' " .     ( ) . " '              = ' $       '  " ) ;  

86      / / 
f

e

N

r
`:N]
sQ
  

87      
$
     - >                 ( "         # @ _ _       _                  = 2 ,        = ' <P[{ $       } '             = ' $      '  " ) ;  

88             ( " NR<       = ' $     '        = ' _     ' > <  > [ ԏV] < /  > < /  > <   >  <P[{ $       } " , "           : ; " ) ;  

89      
$
     - >      ( ) ;  

90          ( ) ;  

93   }     {  

94           ( " /eN1Y%" , "           : ; " ) ;  

95        ;  

97  }     {  

98          ( " !h1Y%, Su! " , "           : ; " ) ;  

99       ;  

	@member/paycenter/nps/nps_config.inc.php

1 <?
php


3 
	g$cfg_mcht
 = 
$ymt_urid
[1];

5 
	g$cfg_msswd
 = 
$ymt_key
[1];

7 
	g$s_eml
 = 
$ymt_ema
[1];

9 
	g$ymt_u
 = 'https://payment.nps.cn/PHPReceiveMerchantAction.do';

	@member/paycenter/nps/pay_back_nps.php

1 <?
php


2 
que_
 
dme
(
__FILE__
).'/../../../include/common.inc.php';

3 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

4 
que_
 
dme
(
__FILE__
).'/nps_config.inc.php';

5 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

6 
	g$cfg_ml
 = 
w
 
MembLog
();

7 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

8 if(
	g$cfg_ml
->
	gM_ID
 > 0
ex
('请登录操作!');

9 
	g$bu
 = "javascript:;";

11 if(
emy
(
$_POST
['m_orderid']))

13 
ex
("非法访问！");

20 
	g$membid
 = 
$m_ocommt
;

21 
	g$buyid
 = 
eg_a
("[^0-9A-Za-z]","",
$m_did
);

22 
	g$mS
 = 
$_POST
['m_status'];

23 
	g$OrdInfo
 = 
$OrdMesge
;

24 
	g$signMsg
 = 
$Dige
;

26 
	g$wmd5fo
 = 
$wmd5fo
;

27 
	g$dige
 = 
ou
(
md5
(
$OrdInfo
.
$cfg_msswd
));

30 
	g$wxt
 = 
$m_id
.
$m_did
.
$m_mou
.
$cfg_msswd
.
$mS
;

31 
	g$myDige
 = 
ou
(
md5
(
$wxt
));

32 
	g$mysign
 =
md5
(
$cfg_mcht
.
$buyid
.
$mey
.
$sucss
.
$cfg_msswd
);

36 if(
	g$dige
 =
$signMsg
 && 
$mS
==2){

37 
$OrdInfo
 = 
HexToS
($OrderInfo);

38 if(
	g$wmd5fo
 =
$myDige
)

41 
$row
 = 
$dsql
->
GO
("Select * From #@__member_operation where buyid='$buyid' ");

42 if(!
is_y
(
$row
)||
	g$row
['sta']==2){

43 
$dfo
 = 
$row
['oldinfo'];

44 
	g$msg
 = "本交易已经完成！，系统返回信息( $oldinfo ) <br><br> <a href='control.php'>返回主页</a> ";

45 
ShowMsg
(
$msg
,"javascript:;");

46 
	g$dsql
->
Clo
();

47 
ex
();

49 
	g$mid
 = 
$row
['mid'];

50 
	g$pid
 = 
$row
['pid'];

52 
	g$dsql
->
ExecuNeQuy
("Update #@__member_operation set sta=1 where buyid='$buyid' ");

56 if(
	g$row
['product']=='member')

58 
$row
 = 
$dsql
->
GO
(" Selectank,exptime From #@__member_type whereid='{$row['pid']}' ");

59 
	g$nk
 = 
$row
['rank'];

60 
	g$exime
 = 
$row
['exptime'];

61 
	g$equy
 = " Update #@__member set 

62 
membty
='$nk',
	gexime
='$exime',
	guime
='".time()."' 
whe
 
mid
='$mid' ";

63 
$dsql
->
ExecuNeQuy
(
$equy
);

65 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='会员升级成功！' where buyid='$buyid' ");

66 
	g$dsql
->
Clo
();

67 
ShowMsg
("成功完成交易！",
$bu
);

68 
ex
();

71 if(
	g$row
['product']=='card')

73 
$row
 = 
$dsql
->
GO
("Select cardid From #@__moneycard_record where ctid='$pid' And isexp='0' ");

75 if(!
is_y
(
$row
)){

76 
	g$ow
 = 
$dsql
->
GO
("Selectum From #@__moneycard_type whereid='$pid' ");

77 
	g$dnum
 = 
$ow
['num'];

78 
	g$equy
 = " Upd#@__memb s mey=mey+".
$dnum
." where mid='$mid' ";

79 
	g$dsql
->
ExecuNeQuy
(
$equy
);

81 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='直接充值了 {$dnum} 金币到帐号！' where buyid='$buyid' ");

82 
ShowMsg
("由于此点卡已经卖完，系统直接为你的帐号增加了：{$dnum} 个金币！",
$bu
);

83 
	g$dsql
->
Clo
();

84 
ex
();

86 
	g$rdid
 = 
$row
['cardid'];

87 
	g$dsql
->
ExecuNeQuy
(" Upd#@__meyrd_cd s uid='$mid',ixp='1',utime='".
time
()."' where cardid='$cardid' ");

89 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='充值密码：{$cardid}' where buyid='$buyid' ");

90 
ShowMsg
("交易成功！<a href='control.php'><u>[返回]</u></a><br> 充值密码：{$cardid}","javascript:;");

91 
	g$dsql
->
Clo
();

92 
ex
();

96 
ShowMsg
("交易密钥错误，请与管理员联系！",
$bu
);

97 
ex
();

100 
ShowMsg
("交易密钥错误，请与管理员联系！",
$bu
);

101 
ex
();

	@member/paycenter/tenpay/notify_handler.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../include/common.inc.php");

3 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

4 
que_
(
DEDEINC
."/memberlogin.class.php");

5 
impt_que_vbs
("gpc", "frm_");

6 
	g$cfg_ml
 = 
w
 
MembLog
();

7 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

8 if(
	g$cfg_ml
->
	gM_ID
>0)

10 
	g$bu
 = 
$cfg_baho
."/member/control.php";

14 
	g$bu
 = "javascript:;";

18 
	g$rSpid
 = 
$ymt_urid
[0];

21 
	g$rSpkey
 = 
$ymt_key
[0];

24 
	g$rCmdno
 = 
$m_cmdno
;

25 
	g$rPayResu
 = 
$m_y_su
;

26 
	g$rPayInfo
 = 
$m_y_fo
;

27 
	g$rBlDe
 = 
$m_de
;

28 
	g$rBgaId
 = 
$m_bga_id
;

29 
	g$rTniId
 = 
$m_i_id
;

30 
	g$rSpBo
 = 
$m__bo
;

31 
	g$rTٮF
 = 
$m_tٮ_e
;

32 
	g$rFTy
 = 
$m_e_ty
;

33 
	g$rAach
 = 
$m_ch
;

34 
	g$rMd5Sign
 = 
$m_sign
;

37 
	g$iROK
 = 0;

38 
	g$iInvidSpid
 = 1;

39 
	g$iInvidSign
 = 2;

40 
	g$iTyE
 = 3;

44 
	g$rReڣText
 = "cmdno=" . 
$rCmdno
 . "&y_su=" . 
$rPayResu
 .

45 "&de=" . 
$rBlDe
 . "&i_id=" . 
$rTniId
 .

46 "&_bo=" . 
$rSpBo
 . "&tٮ_e=" . 
$rTٮF
 .

47 "&e_ty=" . 
$rFTy
 . "&ch=" . 
$rAach
 .

48 "&key=" . 
$rSpkey
;

50 
	g$rLolSign
 = 
ou
(
md5
(
$rReڣText
));

52 if
	g$rLolSign
 !
$rMd5Sign
)

54 
$msg
 = "验证MD5签名失败.";

55 
ShowMsg
(
$msg
,"javascript:;");

56 
	gex
;

59 if
	g$rSpid
 !
$rBgaId
 )

61 
$msg
 = "错误的商户号.";

62 
ShowMsg
(
$msg
,"javascript:;");

63 
	gex
;

66 if
	g$rPayResu
 != "0" )

68 
$msg
 = "支付失败.";

69 
ShowMsg
(
$msg
,"javascript:;");

70 
	gex
;

74 
	g$buyid
 = 
$rSpBo
;

76 
	g$row
 = 
$dsql
->
GO
("Select * From #@__member_operation where buyid='$buyid' ");

77 if(!
is_y
(
$row
)||
	g$row
['sta']==2)

79 
$dfo
 = 
$row
['oldinfo'];

80 
	g$msg
 = "本交易已经完成！，系统返回信息( $oldinfo ) <br><br> <a href='$burl'arget='_bank'>返回主页</a> ";

81 
ShowMsg
(
$msg
,"javascript:;");

82 
	g$dsql
->
Clo
();

83 
ex
();

85 
	g$mid
 = 
$row
['mid'];

86 
	g$pid
 = 
$row
['pid'];

89 
	g$dsql
->
ExecuNeQuy
("Update #@__member_operation set sta=1 where buyid='$buyid' ");

94 if(
	g$row
['product']=='member')

96 
$row
 = 
$dsql
->
GO
(" Selectank,exptime From #@__member_type whereid='{$row['pid']}' ");

97 
	g$nk
 = 
$row
['rank'];

98 
	g$exime
 = 
$row
['exptime'];

99 
	g$equy
 = " Update #@__member set

100 
membty
='$nk',
	gexime
='$exime',
	guime
='".time()."' 
whe
 
mid
='$mid' ";

101 
$dsql
->
ExecuNeQuy
(
$equy
);

104 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='会员升级成功！' where buyid='$buyid' ");

105 
ShowMsg
("成功完成交易！",
$bu
);

106 
ex
();

110 if(
	g$row
['product']=='card')

112 
$row
 = 
$dsql
->
GO
("Select cardid From #@__moneycard_record where ctid='$pid' And isexp='0' ");

115 if(!
is_y
(
$row
)){

116 
	g$ow
 = 
$dsql
->
GO
("Selectum From #@__moneycard_type whereid='$pid' ");

117 
	g$dnum
 = 
$ow
['num'];

118 
	g$equy
 = " Upd#@__memb s mey=mey+".
$dnum
." where mid='$mid' ";

119 
	g$dsql
->
ExecuNeQuy
(
$equy
);

122 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='直接充值了 {$dnum} 金币到帐号！' where buyid='$buyid' ");

123 
ShowMsg
("由于此点卡已经卖完，系统直接为你的帐号增加了：{$dnum} 个金币！",
$bu
);

124 
ex
();

128 
	g$rdid
 = 
$row
['cardid'];

129 
	g$dsql
->
ExecuNeQuy
(" Upd#@__meyrd_cd s uid='$mid',ixp='1',utime='".
time
()."' where cardid='$cardid' ");

132 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='充值密码：{$cardid}' where buyid='$buyid' ");

133 
ShowMsg
("交易成功！<a href='$burl'arget='_bank'><u>[返回]</u></a><br> 充值密码：{$cardid}","javascript:;");

134 
ex
();

	@member/paycenter/tenpay/tenpay_gbk_page.php

1 <!
DOCTYPE
 
html
 
	gPUBLIC
 "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

2 <
html
 
	gxms
="http://www.w3.org/1999/xhtml">

3 <
hd
>

4 <
ma
 
hp
-
equiv
="Cڋ-Ty" 
cڋ
="text/html; charset=gb2312" />

5 <
t
>ת-
DeDeCMS
</title>

6 </
hd
>

7 <
body
 
ld
="document.tenpay.submit();">

8 <
fm
 
me
="ay" 
ai
="<?phechudecode($_GET['rReU']);?>" 
mhod
="post">

9 </
fm
>

10 </
body
>

11 </
body
>

12 </
html
>

	@member/paycenter/yeepay/callback.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../include/common.inc.php");

3 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

4 
que_
(
DEDEINC
."/memberlogin.class.php");

5 
	gude_
 'yeepay_config.php';

6 
	g$cfg_ml
 = 
w
 
MembLog
();

7 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

9 ##支付成功回调有两次，都会通知到在线支付请求参数中的
p8_U
上：浏览器重定向;服务器点对点通讯.

12 
	g$tu
 = 
gClBackVue
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
,
$hmac
);

14 #判断返回签名是否正确（
True
/
F
）

15 
	g$bR
 = 
CheckHmac
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
,
$hmac
);

18 if(
	g$bR
)

20 if(
	g$r1_Code
=="1")

25 if(
$r9_BTy
=="1")

27 
sucss_db
(
$r6_Ord
);

29 
if
(
$r9_BTy
=="2")

31 #如果需要应答机制则必须回写流,以
sucss
开头,大小写不敏感.

32 
echo
 "success";

33 
sucss_db
(
$r6_Ord
);

35 
if
(
$r9_BTy
=="3")

37 
sucss_db
(
$r6_Ord
);

39 
ShowMsg
('支付成功!',"javascript:;");

40 
	gex
;

46 
ShowMsg
('交易信息被篡!',"javascript:;");

47 
	gex
;

51 
funi
 
	$sucss_db
(
$buyid
){

52 
glob
 
$dsql
,
$cfg_ml
,
$r3_Amt
;

53 
$mey
 = 
	`o
(
$r3_Amt
);

55 
$row
 = 
$dsql
->
	`GO
("Select * From #@__member_operation where buyid='$buyid' ");

56 if(!
	`is_y
(
$row
)||$row['sta']==2)

58 if(
	`ist
(
$row
['sta']))

60 
	`ShowMsg
(
$row
['oldinfo'],"javascript:;");

61 
	`ex
();

65 
	`ShowMsg
('订单不存在!',"javascript:;");

66 
	`ex
();

69 if(
$mey
 !
$row
['money'])

71 
	`ShowMsg
('交易信息被篡!',"javascript:;");

72 
ex
;

75 
$mid
 = 
$row
['mid'];

76 
$pid
 = 
$row
['pid'];

79 
$dsql
->
	`ExecuNeQuy
("Update #@__member_operation set sta=1 where buyid='$buyid' ");

84 if(
$row
['product']=='member')

86 
$row
 = 
$dsql
->
	`GO
(" Selectank,exptime From #@__member_type whereid='{$row['pid']}' ");

87 
$nk
 = 
$row
['rank'];

88 
$exime
 = 
$row
['exptime'];

89 
$equy
 = " Update #@__member set

90 
membty
='$nk',
exime
='$exime',
uime
='".time()."' 
whe
 
mid
='$mid' ";

91 
$dsql
->
	`ExecuNeQuy
(
$equy
);

94 
$dsql
->
	`ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='会员升级成功！' where buyid='$buyid' ");

97 if(
$row
['product']=='card')

99 
$row
 = 
$dsql
->
	`GO
("Select cardid From #@__moneycard_record where ctid='$pid' And isexp='0' ");

102 if(!
	`is_y
(
$row
))

104 
$ow
 = 
$dsql
->
	`GO
("Selectum From #@__moneycard_type whereid='$pid' ");

105 
$dnum
 = 
$ow
['num'];

106 
$equy
 = " Upd#@__memb s mey=mey+".
$dnum
." where mid='$mid' ";

107 
$dsql
->
	`ExecuNeQuy
(
$equy
);

110 
$dsql
->
	`ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='直接充值了 {$dnum} 金币到帐号！' where buyid='$buyid' ");

111 
	`ex
();

115 
$rdid
 = 
$row
['cardid'];

116 
$dsql
->
	`ExecuNeQuy
(" Upd#@__meyrd_cd s uid='$mid',ixp='1',utime='".
	`time
()."' where cardid='$cardid' ");

119 
$dsql
->
	`ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='充值密码：{$cardid}' where buyid='$buyid' ");

122  
NULL
;

123 
	}
}

	@member/paycenter/yeepay/yeepay_config.php

1 <?
php


2 
	g$p1_MId
 = 
$ymt_urid
[4];

3 
	g$mchtKey
 = 
$ymt_key
[4];

6 
	g$qURL_Le
 = "https://www.yeepay.com/app-merchant-proxy/node";

11 
	g$p0_Cmd
 = 'Buy';

15 
	g$p9_SAF
 = "0";

19 
funi
 
	$gReqHmacSg
(
$p2_Ord
,
$p3_Amt
,
$p4_Cur
,
$p5_Pid
,
$p6_Pt
,
$p7_Pdesc
,
$p8_U
,
$_MP
,
$pd_FId
,
$_NdReڣ
)

21 
glob
 
$p0_Cmd
,
$p9_SAF
,
$p1_MId
,
$mchtKey
;

24 
$sbOld
 = "";

26 
$sbOld
 = $sbOld.
$p0_Cmd
;

28 
$sbOld
 = $sbOld.
$p1_MId
;

30 
$sbOld
 = $sbOld.
$p2_Ord
;

32 
$sbOld
 = $sbOld.
$p3_Amt
;

34 
$sbOld
 = $sbOld.
$p4_Cur
;

36 
$sbOld
 = $sbOld.
$p5_Pid
;

38 
$sbOld
 = $sbOld.
$p6_Pt
;

40 
$sbOld
 = $sbOld.
$p7_Pdesc
;

42 
$sbOld
 = $sbOld.
$p8_U
;

44 
$sbOld
 = $sbOld.
$p9_SAF
;

46 
$sbOld
 = $sbOld.
$_MP
;

48 
$sbOld
 = $sbOld.
$pd_FId
;

50 
$sbOld
 = $sbOld.
$_NdReڣ
;

52  
	`HmacMd5
(
$sbOld
,
$mchtKey
);

54 
	}
}

56 
funi
 
	$gClbackHmacSg
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
)

58 
glob
 
$p1_MId
,
$mchtKey
,
$qURL_Le
,
$p9_SAF
;

61 
$sbOld
 = "";

62 #加入商家
ID


63 
$sbOld
 = $sbOld.
$p1_MId
;

65 
$sbOld
 = $sbOld.
$r0_Cmd
;

67 
$sbOld
 = $sbOld.
$r1_Code
;

68 #加入交易
ID


69 
$sbOld
 = $sbOld.
$r2_TrxId
;

71 
$sbOld
 = $sbOld.
$r3_Amt
;

73 
$sbOld
 = $sbOld.
$r4_Cur
;

74 #加入产品
Id


75 
$sbOld
 = $sbOld.
$r5_Pid
;

76 #加入订单
ID


77 
$sbOld
 = $sbOld.
$r6_Ord
;

78 #加入用户
ID


79 
$sbOld
 = $sbOld.
$r7_Uid
;

81 
$sbOld
 = $sbOld.
$r8_MP
;

83 
$sbOld
 = $sbOld.
$r9_BTy
;

85  
	`HmacMd5
(
$sbOld
,
$mchtKey
,'gbk');

87 
	}
}

91 
funi
 
	$gClBackVue
(&
$r0_Cmd
,&
$r1_Code
,&
$r2_TrxId
,&
$r3_Amt
,&
$r4_Cur
,&
$r5_Pid
,&
$r6_Ord
,&
$r7_Uid
,&
$r8_MP
,&
$r9_BTy
,&
$hmac
)

93 
$r0_Cmd
 = 
$_REQUEST
['r0_Cmd'];

94 
$r1_Code
 = 
$_REQUEST
['r1_Code'];

95 
$r2_TrxId
 = 
$_REQUEST
['r2_TrxId'];

96 
$r3_Amt
 = 
$_REQUEST
['r3_Amt'];

97 
$r4_Cur
 = 
$_REQUEST
['r4_Cur'];

98 
$r5_Pid
 = 
$_REQUEST
['r5_Pid'];

99 
$r6_Ord
 = 
$_REQUEST
['r6_Order'];

100 
$r7_Uid
 = 
$_REQUEST
['r7_Uid'];

101 
$r8_MP
 = 
$_REQUEST
['r8_MP'];

102 
$r9_BTy
 = 
$_REQUEST
['r9_BType'];

103 
$hmac
 = 
$_REQUEST
['hmac'];

104  
nu
;

105 
	}
}

107 
funi
 
	$CheckHmac
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
,
$hmac
)

109 if(
$hmac
 =
	`gClbackHmacSg
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
))

110  
ue
;

112  
l
;

113 
	}
}

115 
funi
 
HmacMd5
(
$da
,
$key
,
$ng
='utf-8')

123 if(
$GLOBALS
['cfg_so_ng'] !'utf-8' || 
$ng
!='utf-8'){

124 if(!
funi_exis
('iconv')){

125 
ex
('Not install iconvib!');

127 
	g$key
 = 
icv
("GB2312","UTF-8//IGNORE",
$key
);

128 
	g$da
 = 
icv
("GB2312","UTF-8//IGNORE",
$da
);

131 
	g$b
 = 64;

132 i(

(
$key
> 
	g$b
) {

133 
	g$key
 = 
ck
("H*",
md5
(
$key
));

135 
	g$key
 = 
r_d
(
$key
, 
$b
, 
chr
(0x00));

136 
	g$ad
 = 
r_d
('', 
$b
, 
chr
(0x36));

137 
	g$ad
 = 
r_d
('', 
$b
, 
chr
(0x5c));

138 
	g$k_ad
 = 
$key
 ^ 
$ad
 ;

139 
	g$k_ad
 = 
$key
 ^ 
$ad
;

141  
md5
(
$k_ad
 . 
ck
("H*",md5(
$k_ad
 . 
$da
)));

	@member/paycenter/yeepay/yeepay_gbk.php

1 <?
php


3 
unt
(
$GLOBALS
, 
$_ENV
, 
$HTTP_GET_VARS
, 
$HTTP_POST_VARS
, 
$HTTP_COOKIE_VARS
, 
$HTTP_SERVER_VARS
, 
$HTTP_ENV_VARS
);

5 
funi
 
GGPC
(
$k
, 
$v
='R') {

6 
$v
) {

7 'G': 
$v
 = &
$_GET
; ;

8 'P': 
$v
 = &
$_POST
; ;

9 'C': 
$v
 = &
$_COOKIE
; ;

10 'R': 
$v
 = &
$_REQUEST
; ;

12 if(
ist
(
$_POST
['ng']&& 
	g$_POST
['ng'] ='utf-8' && ist(
$v
[
$k
])){

13 if(!
funi_exis
('icv')
ex
('Not install iconvib!');

14 
	g$v
[
$k
] = 
icv
("UTF-8","GB2312//IGNORE",
$v
[$k]);

16  
ist
(
$v
[
$k
]? 
	g$v
[$k] : 
NULL
;

19 
	g$_q
 = 
y
(

23 
fܗch
(
$_q
 
as
 
$k

	g$$k
 = 
GGPC
($k,'P');

26 <
	ghtml
>

27 <
	ghd
>

28 <
	gt
>
To
 
YPay
 
	gPage
</title>

29 <
ma
 
	ghp
-
	gequiv
="Cڋ-Ty" 
cڋ
="text/html; charset=gb2312" />

30 <
body
 
ld
="document.yeepay.submit();">

31 <
fm
 
me
="yy" 
ai
="<?phech$qURL_Le;?>" 
mhod
="post">

32 <
put
 
ty
="hidd" 
me
="p0_Cmd" 
vue
="<?phpcho $p0_Cmd?>">

33 <
put
 
ty
="hidd" 
me
="p1_MId" 
vue
="<?phpcho $p1_MerId?>">

34 <
put
 
ty
="hidd" 
me
="p2_Ord" 
vue
="<?phpcho $p2_Order?>">

35 <
put
 
ty
="hidd" 
me
="p3_Amt" 
vue
="<?phpcho $p3_Amt?>">

36 <
put
 
ty
="hidd" 
me
="p4_Cur" 
vue
="<?phpcho $p4_Cur?>">

37 <
put
 
ty
="hidd" 
me
="p5_Pid" 
vue
="<?phpcho $p5_Pid?>">

38 <
put
 
ty
="hidd" 
me
="p6_Pt" 
vue
="<?phpcho $p6_Pcat?>">

39 <
put
 
ty
="hidd" 
me
="p7_Pdesc" 
vue
="<?phpcho $p7_Pdesc?>">

40 <
put
 
ty
="hidd" 
me
="p8_U" 
vue
="<?phpcho $p8_Url?>">

41 <
put
 
ty
="hidd" 
me
="p9_SAF" 
vue
="<?phpcho $p9_SAF?>">

42 <
put
 
ty
="hidd" 
me
="_MP" 
vue
="<?phpcho $pa_MP?>">

43 <
put
 
ty
="hidd" 
me
="pd_FId" 
vue
="<?phpcho $pd_FrpId?>">

44 <
put
 
ty
="hidd" 
me
="_NdReڣ" 
vue
="<?phpcho $pr_NeedResponse?>">

45 <
put
 
ty
="hidd" 
me
="hmac" 
vue
="<?phpcho $hmac?>">

46 </
fm
>

47 </
body
>

48 </
html
>

	@member/pm.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(
	g$cfg_mb_l
=='Y')

6 
ShowMsg
('由于系统开启了精简版会员空间，你不能向其它会员发短信息，不过你可以向他留言！','-1');

7 
ex
();

11 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

13 if(
	g$da
 = 
uc_g_ur
(
$cfg_ml
->
M_LogID
)
uc_pm_loti
(
$da
[0]);

15 #/
a
}}

17 if(!
	$ist
(
$do
))

19 
$do
 = '';

20 
	}
}

22 
CheckNAow
();

26 if(
	g$do
=='send')

29 
$sql
 = "Select * From `#@__member_friends` where mid='{$cfg_ml->M_ID}' And ftype!='-1' order byddtime descimit 20";

30 
	g$nds
 = 
y
();

31 
	g$dsql
->
SQuy
(
$sql
);

32 
	g$dsql
->
Execu
();

33 
	g$row
 = 
$dsql
->
GAay
()) {

34 
$nds
[] = 
$row
;

37 
ude_
(
dme
(
__FILE__
).'/templets/pm-send.htm');

38 
ex
();

44 if(
	g$do
=='read')

46 
$sql
 = "Select * From `#@__member_friends` where mid='{$cfg_ml->M_ID}' And ftype!='-1' order byddtime descimit 20";

47 
	g$nds
 = 
y
();

48 
	g$dsql
->
SQuy
(
$sql
);

49 
	g$dsql
->
Execu
();

50 
	g$row
 = 
$dsql
->
GAay
()) {

51 
$nds
[] = 
$row
;

53 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__member_pms` where id='$id' And (fromid='{$cfg_ml->M_ID}' Oroid='{$cfg_ml->M_ID}')");

54 if(!
is_y
(
$row
))

56 
ShowMsg
('对不起，你指定的消息不存在或你没权限查看！','-1');

57 
ex
();

59 
	g$dsql
->
ExecuNeQuy
("Update `#@__member_pms` set hasview=1 where id='$id' And folder='inbox' Andoid='{$cfg_ml->M_ID}'");

60 
	g$dsql
->
ExecuNeQuy
("Update `#@__member_pms` set hasview=1 where folder='outbox' Andoid='{$cfg_ml->M_ID}'");

61 
ude_
(
dme
(
__FILE__
).'/templets/pm-read.htm');

62 
ex
();

68 if(
	g$do
=='savesend')

70 if(
$subje
=='')

72 
ShowMsg
("请填写信息标题!","-1");

73 
ex
();

75 
	g$msg
 = 
CheckUrID
(
$msgtoid
,"用户名",
l
);

76 if(
	g$msg
!='ok')

78 
ShowMsg
(
$msg
,"-1");

79 
ex
();

81 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__member` where useridike '$msgtoid' ");

82 if(!
is_y
(
$row
))

84 
ShowMsg
("你指定的用户不存在,不能发送信息!","-1");

85 
ex
();

87 
	g$subje
 = 
_subrR
(
HtmlR
(
$subje
,1),60);

88 
	g$mesge
 = 
_subrR
(
HtmlR
(
$mesge
,0),1024);

89 
	g$ndtime
 = 
$wrime
 = 
time
();

92 
	g$quy1
 = "INSERT INTO `#@__member_pms` (`floginid`,`fromid`,`toid`,`tologinid`,`folder`,`subject`,`sendtime`,`writetime`,`hasview`,`isadmin`,`message`)

93 
VALUES
 ('{$cfg_ml->M_LogID}','{$cfg_ml->M_ID}','{$row['
mid
']}','{$row['
urid
']}','inbox','$subject','$sendtime','$writetime','0','0','$message'); ";

96 
	g$quy2
 = "INSERT INTO `#@__member_pms` (`floginid`,`fromid`,`toid`,`tologinid`,`folder`,`subject`,`sendtime`,`writetime`,`hasview`,`isadmin`,`message`)

97 
VALUES
 ('{$cfg_ml->M_LogID}','{$cfg_ml->M_ID}','{$row['
mid
']}','{$row['
urid
']}','outbox','$subject','$sendtime','$writetime','0','0','$message'); ";

98 
	g$dsql
->
ExecuNeQuy
(
$quy1
);

99 
	g$dsql
->
ExecuNeQuy
(
$quy2
);

100 
ShowMsg
("成功发送一条信息!","pm.php?dopost=outbox");

101 
ex
();

107 if(
	g$do
=='del')

109 
$ids
 = 
eg_a
("[^0-9,]","",$ids);

110 if(
	g$fd
=='inbox')

112 
$boxsql
="Select * From `#@__member_pms` where id in($ids) And folderike 'inbox' Andoid='{$cfg_ml->M_ID}'";

113 
	g$dsql
->
SQuy
(
$boxsql
);

114 
	g$dsql
->
Execu
();

115 
	g$quy
='';

116 
	g$row
 = 
$dsql
->
GAay
())

118 if(
$row
 && $row['isadmin']==1)

120 
$quy
 = "Update `#@__member_pms` set writetime='0' where id='{$row['id']}' And folder='inbox' Andoid='{$cfg_ml->M_ID}' And isadmin='1';";

121 
	g$dsql
->
ExecuNeQuy
(
$quy
);

125 
	g$quy
 = "Delete From `#@__member_pms` where id in($ids) Andoid='{$cfg_ml->M_ID}' And folderike 'inbox'";

129 if(
	g$fd
=='outbox')

131 
$quy
 = "Delete From `#@__member_pms` where id in($ids) And fromid='{$cfg_ml->M_ID}' And folderike 'outbox' ";

135 
	g$quy
 = "Delete From `#@__member_pms` where id in($ids) And fromid='{$cfg_ml->M_ID}' Oroid='{$cfg_ml->M_ID}' And folderike 'outbox' Or (folderike 'inbox' And hasview='0')";

137 
	g$dsql
->
ExecuNeQuy
(
$quy
);

138 
ShowMsg
("成功删除指定的消息!","pm.php?fd=".
$fd
);

139 
ex
();

147 if(!
ist
(
$fd
))

149 
	g$fd
 = 'inbox';

151 
que_
(
DEDEINC
."/datalistcp.class.php");

152 
	g$wsql
 = '';

153 if(
	g$fd
=='outbox')

155 
$wsql
 = " `fromid`='{$cfg_ml->M_ID}' And folderike 'outbox' ";

156 
	g$ame
 = "发件箱";

158 
if
(
$fd
=='inbox')

160 
$quy
 = "Select * From `#@__member_pms` where folderike 'outbox' And isadmin='1'";

161 
	g$dsql
->
SQuy
(
$quy
);

162 
	g$dsql
->
Execu
();

163 
	g$row
 = 
$dsql
->
GAay
())

165 
$row2
 = 
$dsql
->
GO
("Select * From `#@__member_pms` where fromid = '$row[id]' Andoid='{$cfg_ml->M_ID}'");

166 if(!
is_y
(
$row2
))

168 
	g$row3
= "INSERT INTO

169 `#@
__memb_pms
` (`
ogid
`,`
	gomid
`,`
	gtoid
`,`
	gtogid
`,`
	gfd
`,`
	gsubje
`,`
	gndtime
`,`
	gwrime
`,`
	ghasvw
`,`
	gidm
`,`
	gmesge
`)

170 
VALUES
 ('adm','{$row['
id
']}','{$cfg_ml->M_ID}','{$cfg_ml->M_LogID}','box','{$row['
subje
']}','{$row['
ndtime
']}','{$row['
wrime
']}','{$row['
hasvw
']}','{$row['
idm
']}','{$row['
mesge
']}')";

171 
	g$dsql
->
ExecuNeQuy
(
$row3
);

174 
	g$wsql
 = "oid='{$cfg_ml->M_ID}' And folder='inbox' And writetime!=''";

175 
	g$ame
 = "收件箱";

180 
	g$wsql
 = " `fromid` ='{$cfg_ml->M_ID}' And folderike 'outbox'";

181 
	g$ame
 = "已发信息";

183 
	g$quy
 = "Select * From `#@__member_pms` where $wsql order by sendtime desc";

184 
	g$dli
 = 
w
 
DaLiCP
();

185 
	g$dli
->
	ggeSize
 = 20;

186 
	g$dli
->
SPam
("do",
$do
);

187 
	g$dli
->
STeme
(
DEDEMEMBER
.'/templets/pm-main.htm');

188 
	g$dli
->
SSour
(
$quy
);

189 
	g$dli
->
Diy
();

	@member/reg_new.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
	g$cfg_mb_lowg
=='N')

5 
ShowMsg
('系统关闭了新用户注册！', 'index.php');

6 
ex
();

8 if(
	g$cfg_ml
->
	$IsLog
())

10 
	`ShowMsg
('你已经登陆系统，无需重新注册！', 'index.php');

11 
	`ex
();

12 
	}
}

13 if(!
	$ist
(
$do
))

15 
$do
 = '';

16 
	}
}

17 if(
	g$do
=='regok')

19 
$svi
 = 
GCkVdVue
();

20 if(
ow
(
$vdcode
)!=
$svi
 || $svali=='')

22 
RetVdVue
();

23 
ShowMsg
('验证码错误！', '-1');

24 
ex
();

26 
	g$urid
 = 
im
(
$urid
);

27 
	g$pwd
 = 
im
(
$uwd
);

28 
	g$pwdc
 = 
im
(
$uwdok
);

29 
	g$rs
 = 
CheckUrID
(
$urid
, '用户名');

30 if(
	g$rs
 != 'ok')

32 
ShowMsg
(
$rs
, '-1');

33 
ex
();

35 if(

(
$urid
> 20 || sn(
$ume
) > 36)

37 
ShowMsg
('你的用户名或用户笔名过长，不允许注册！', '-1');

38 
ex
();

40 if(

(
$urid
< 
	g$cfg_mb_idm
 || sn(
$pwd
< 
	g$cfg_mb_pwdm
)

42 
ShowMsg
("你的用户名或密码过短，不允许注册！","-1");

43 
ex
();

45 if(
	g$pwdc
 !
$pwd
)

47 
ShowMsg
('你两次输入的密码不一致！', '-1');

48 
ex
();

51 
	g$ume
 = 
HtmlR
(
$ume
, 1);

53 if(
	g$cfg_mb_wmee
=='N')

55 
$row
 = 
$dsql
->
GO
("Select * From `#@__member` where unameike '$uname' ");

56 if(
is_y
(
$row
))

58 
ShowMsg
('用户笔名或公司名称不能重复！', '-1');

59 
ex
();

62 if(!
CheckEma
(
$ema
))

64 
ShowMsg
('Email格式不正确！', '-1');

65 
ex
();

69 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/uc_client/client.php')

71 
	g$uid
 = 
uc_ur_gi
(
$urid
, 
$pwd
, 
$ema
);

72 if(
	g$uid
 <= 0)

74 if(
$uid
 == -1)

76 
ShowMsg
("用户名不合法！","-1");

77 
ex
();

79 
if
(
$uid
 == -2)

81 
ShowMsg
("包含要允许注册的词语！","-1");

82 
ex
();

84 
if
(
$uid
 == -3)

86 
ShowMsg
("你指定的用户名 {$userid} 已存在，请使用别的用户名！","-1");

87 
ex
();

89 
if
(
$uid
 == -5)

91 
ShowMsg
("你使用的Email 不允许注册！","-1");

92 
ex
();

94 
if
(
$uid
 == -6)

96 
ShowMsg
("你使用的Email已经被另一帐号注册，请使其它帐号","-1");

97 
ex
();

101 
ShowMsg
("注删失改！","-1");

102 
ex
();

107 
	g$ucsyog
 = 
uc_ur_syog
(
$uid
);

110 #/
a
}}

112 if(
	g$cfg_md_ma
=='Y')

114 
$row
 = 
$dsql
->
GO
("Select mid From `#@__member` wheremailike '$email' ");

115 if(
is_y
(
$row
))

117 
ShowMsg
('你使用的Email已经被另一帐号注册，请使其它帐号！', '-1');

118 
ex
();

123 
	g$row
 = 
$dsql
->
GO
("Select mid From `#@__member` where useridike '$userid' ");

124 if(
is_y
(
$row
))

126 
ShowMsg
("你指定的用户名 {$userid} 已存在，请使用别的用户名！", "-1");

127 
ex
();

129 if(
	g$quei
==0)

131 
$sw
 = '';

135 if(

(
$sw
)>30)

137 
ShowMsg
('你的新安全问题的答案太长了，请控制在30字节以内！', '-1');

138 
ex
();

143 
	g$dfsces
 = 0;

144 
	g$dfmey
 = 0;

145 
	g$dk
 = 
$dsql
->
GO
("Select money,scores From `#@__arcrank` whereank='10' ");

146 if(
is_y
(
$dk
))

148 
	g$dfmey
 = 
$dk
['money'];

149 
	g$dfsces
 = 
$dk
['scores'];

151 
	g$jotime
 = 
time
();

152 
	g$logtime
 = 
time
();

153 
	g$jo
 = 
GIP
();

154 
	g$log
 = 
GIP
();

155 
	g$pwd
 = 
md5
(
$uwd
);

157 
	g$aS
 = (
$cfg_mb_aa
 < 0 ? $cfg_mb_spacesta : 0);

159 
	g$Quy
 = "INSERT INTO `#@__member` (`mtype` ,`userid` ,`pwd` ,`uname` ,`sex` ,`rank` ,`money` ,`email` ,`scores` ,

160 `
mt
`, `
	gaa
` ,`
	g
`,`
	gquei
`,`
	gsw
` ,`
	gjotime
` ,`
	gjo
` ,`
	glogtime
` ,`
	glog
` )

161 
VALUES
 ('$mtype','$userid','$pwd','$uname','$sex','10','$dfmoney','$email','$dfscores',

163 if(
	g$dsql
->
ExecuNeQuy
(
$Quy
))

165 
	g$mid
 = 
$dsql
->
GLaID
();

168 if(
	g$mty
=='个人')

170 
$fosquy
 = "INSERT INTO `#@__member_person` (`mid` , `onlynet` , `sex` , `uname` , `qq` , `msn` , `tel` , `mobile` , `place` , `oldplace` ,

171 `
bthday
` , `
	g
` , `
	gcome
` , `
	geduti
` , `
	gheight
` , `
	gbodyty
` , `
	gblood
` , `
	gvoti
` , `
	gsmoke
` , `
	gm
` , `
	ghou
` ,

172 `
	gdrk
` , `
	gdgty
` , `
	gnguage
` , `
	gtu
` , `
	glovemsg
` , `
	gaddss
`,`
	guime
`)

173 
VALUES
 ('$mid', '1', '{$sex}', '{$uname}', '', '', '', '', '0', '0',

175 
	g$a
='person';

177 if(
	g$mty
=='企业')

179 
$fosquy
 = "INSERT INTO `#@__member_company`(`mid`,`company`,`product`,`place`,`vocation`,`cosize`,`tel`,`fax`,`linkman`,`address`,`mobile`,`email`,`url`,`uptime`,`checked`,`introduce`)

180 
VALUES
 ('{$mid}','{$uname}','product','0','0','0','','','','','','{$email}','','0','0',''); ";

181 
	g$a
='company';

185 
	g$fosquy
 = '';

186 
	g$a
='person';

190 
	g$dsql
->
ExecuNeQuy
(
$fosquy
);

193 
	g$membtjquy
 = "INSERT INTO `#@__member_tj` (`mid`,`article`,`album`,`archives`,`homecount`,`pagecount`,`feedback`,`friend`,`stow`)

194 
VALUES
 ('$mid','0','0','0','0','0','0','0','0'); ";

195 
	g$dsql
->
ExecuNeQuy
(
$membtjquy
);

198 
	g$aquy
 = "Insert Into `#@__member_space`(`mid` ,`pagesize` ,`matt` ,`spacename` ,`spacelogo` ,`spacestyle`, `sign` ,`spacenews`)

199 
Vues
('{$mid}','10','0','{$uname}的空间','','$space','',''); ";

200 
	g$dsql
->
ExecuNeQuy
(
$aquy
);

203 
	g$dsql
->
ExecuNeQuy
("INSERT INTO `#@__member_flink`(mid,title,url) VALUES('$mid','织梦内容管理系统','http://www.dedecms.com'); ");

208 
	g$cfg_ml
 = 
w
 
MembLog
(7*3600);

209 
	g$rs
 = 
$cfg_ml
->
CheckUr
(
$urid
, 
$uwd
);

212 if(
	g$cfg_mb_aa
==-10)

214 
$urhash
 = 
md5
(
$cfg_cook_code
.'--'.
$mid
.'--'.
$ema
);

215 
	g$u
 = 
$cfg_baho
.(
emy
(
$cfg_cmh
) ? '/' : $cfg_cmspath)."/member/index_do.php?fmdo=checkMail&mid={$mid}&userhash={$userhash}&do=1";

216 
	g$u
 = 
egi_a
('hp://', '', 
$u
);

217 
	g$u
 = 'hp://'.
egi_a
('//', '/', 
$u
);

218 
	g$mat
 = "{$cfg_webname}--会员邮件验证通知";

219 
	g$mabody
 = '';

220 
	g$mabody
 .= "尊敬的用户，您好：\r\n";

221 
	g$mabody
 .= "欢迎注册成为[{$cfg_webname}]的会员。\r\n";

222 
	g$mabody
 .= "要通过注册，还必须进行最后一步操作，请点击或复制下面链接到地址栏访问这地址：\r\n\r\n";

223 
	g$mabody
 .= "{$url}\r\n\r\n";

224 
	g$mabody
 .= "Power by http://www.dedecms.com 织梦内容管理系统！\r\n";

226 
	g$hds
 = "From: ".
$cfg_admema
."\r\nReply-To: ".$cfg_adminemail;

227 if(
	g$cfg_ndma_bysm
 ='Y' && !
emy
(
$cfg_sm_rv
))

229 
$maty
 = 'TXT';

230 
que_
(
DEDEINC
.'/mail.class.php');

231 
	g$sm
 = 
w
 
sm
(
$cfg_sm_rv
,
$cfg_sm_pt
,
ue
,
$cfg_sm_urma
,
$cfg_sm_sswd
);

232 
	g$sm
->
	gdebug
 = 
l
;

233 
	g$sm
->
ndma
(
$ema
, 
$cfg_sm_urma
, 
$mat
, 
$mabody
, 
$maty
);

237 @
ma
(
$ema
, 
$mat
, 
$mabody
, 
$hds
);

242 
ShowMsg
("注册成功，3秒钟后转向系统主页...","index.php",0,2000);

243 
ex
();

247 
ShowMsg
("注册失败，请检查资料是否有误或与管理员联系！", "-1");

248 
ex
();

252 
	g$sql
 = "desc #@__member";

253 
	g$dsql
->
SQuy
(
$sql
);

254 
	g$dsql
->
Execu
();

255 
	g$row
 = 
$dsql
->
	$GAay
()) {

256 if(
$row
['Field'] == 'mtype')

258 
$tys
 = 
$row
['Type'];

261 
	}
}

262 
	g$tys
 = 
r_a
(
y
('um', '(', ')', '\''), '', 
$tys
);

263 
	g$tys
 = 
exode
(',', 
$tys
);

266 
que_
(
DEDEMEMBER
."/templets/reg-new.htm");

	@member/resetpassword.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
que_
(
DEDEMEMBER
."/inc/inc_pwd_functions.php");

4 if(
	$emy
(
$do
))

6 
$do
 = "";

7 
	}
}

8 if(
	g$do
 == "")

10 
ude
(
dme
(
__FILE__
)."/templets/resetpassword.htm");

12 
if
(
$do
 == "getpwd")

16 if(!
ist
(
$vdcode
))

18 
$vdcode
 = '';

20 
	g$svi
 = 
GCkVdVue
();

21 if(
ow
(
$vdcode
)!=
$svi
 || $svali=='')

23 
RetVdVue
();

24 
ShowMsg
("对不起，验证码输入错误！","-1");

25 
ex
();

29 if(
emy
(
$ma
&&my(
$urid
))

31 
showmsg
('对不起，请输入用户名或邮箱', '-1');

32 
	gex
;

33 }
if
(!
eg
("(.*)@(.*)\.(.*)",
$ma
))

35 
showmsg
('对不起，请输入正确的邮箱格式', '-1');

36 
	gex
;

38 
if
(
CheckUrID
(
$urid
,'',
l
)!='ok')

40 
ShowMsg
("你输入的用户名 {$userid} 不合法！","-1");

41 
ex
();

43 
	g$memb
 = 
memb
(
$ma
,
$urid
);

46 if(
	g$ty
 == 1)

50 if(
$cfg_ndma_bysm
 == "Y")

52 

(
$memb
['mid'],
$urid
,$member['email']);

55 
showmsg
('对不起邮件服务暂未开启，请联系管理员', 'login.php');

56 
ex
();

60 }
if
(
$ty
 == 2)

62 if(
$memb
['safequestion'] == 0)

64 
showmsg
('对不起您尚未设置安全密码，请通过邮件方式重设密码', 'login.php');

65 
	gex
;

67 
que_
(
dme
(
__FILE__
)."/templets/resetpassword3.htm");

69 
ex
();

71 
if
(
$do
 == "safequestion")

73 
$mid
 = 
eg_a
("[^0-9]","",
$id
);

74 
	g$sql
 = "Select safequestion,safeanswer,userid,email From #@__member where mid = '$mid'";

75 
	g$row
 = 
$db
->
GO
(
$sql
);

76 if(
emy
(
$quei
))

78 
	g$quei
 = '';

80 if(
emy
(
$sw
))

82 
	g$sw
 = '';

84 if(
	g$row
['quei'] =
$quei
 && 
$row
['sw'] =
$sw
)

86 

(
$mid
,
$row
['userid'],$row['email'],'N');

87 
ex
();

91 
ShowMsg
("对不起，您的安全问题或答案回答错误","-1");

92 
ex
();

96 
if
(
$do
 == "getpasswd")

99 if(
emy
(
$id
))

101 
ShowMsg
("对不起，请不要非法提交","login.php");

102 
ex
();

104 
	g$mid
 = 
eg_a
("[^0-9]","",
$id
);

105 
	g$row
 = 
$db
->
GO
("Select * From #@__pwd_tmp where mid = '$mid'");

106 if(
emy
(
$row
))

108 
ShowMsg
("对不起，请不要非法提交","login.php");

109 
ex
();

111 if(
emy
(
$
))

113 
	g$tim
= (60*60*24*3);

114 
	g$dtime
 = 
time
();

115 if(
	g$dtime
 - 
	g$tim
 > 
	g$row
['mailtime'])

117 
	g$db
->
execunequy
("DELETE FROM `#@__pwd_tmp` WHERE `md` = '$id';");

118 
ShowMsg
("对不起，临时密码修改期限已过期","login.php");

119 
ex
();

121 
que_
(
dme
(
__FILE__
)."/templets/resetpassword2.htm");

123 
if
(
$
 == 2)

125 if(
ist
(
$key
))

127 
$pwdtmp
 = 
$key
;

129 
	g$
 = 
md5
(
im
(
$pwdtmp
));

130 if(
	g$row
['pwd'] =
$
)

132 if(
$pwd
 != "")

134 if(
$pwd
 =
$pwdok
)

136 
$pwdok
 = 
md5
($pwdok);

137 
	g$sql
 = "DELETE FROM `#@__pwd_tmp` WHERE `mid` = '$id';";

138 
	g$db
->
execunequy
(
$sql
);

139 
	g$sql
 = "UPDATE `#@__member` SET `pwd` = '$pwdok' WHERE `mid` = '$id';";

140 if(
	g$db
->
execunequy
(
$sql
))

142 
showmsg
('更改密码成功，请牢记新密码', 'login.php');

143 
	gex
;

147 
showmsg
('对不起，新密码为空或填写不一致', '-1');

148 
	gex
;

150 
showmsg
('对不起，临时密码错误', '-1');

151 
	gex
;

	@member/search.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
.'/enums.func.php');

5 
que_
(
DEDEINC
.'/datalistcp.class.php');

8 
CheckNAow
();

10 
	g$addsqls
 = 
y
();

11 
	g$ov
 = 
emy
(
$ov
? 0 : 
tv
($province);

12 
	g$cy
 = 
emy
(
$cy
? 0 : 
tv
($city);

13 
	g$mage
 = 
emy
(
$mage
? 0 : 
tv
($minage);

14 
	g$maxage
 = 
emy
(
$maxage
? 0 : 
tv
($maxage);

16 if(
emy
(
$x
)
	g$x
 = '';

17 if(
emy
(
$keywd
)
	g$keywd
 = '';

19 
	g$keywd
 = 
FrSrch
(
rashes
(
$keywd
));

20 
	g$keywd
 = 
addashes
(
_subr
(
$keywd
,20));

22 if(!
	$emy
(
$keywd
)) {

23 
$addsqls
[] = " (mb.useridike '%$keyword%' Or mb.unameike '%$keyword%') ";

24 
	}
}

26 if(
	$emy
(
$cy
)) {

27 
$a
 = 
$ov
;

28 
	}
}

30 
	g$a
 = 
$cy
;

33 if
	g$a
%500 != 0 )

35 
$addsqls
[] = " mp.place='$place' ";

39 if(
	g$a
!=0)

41 
$mp
 = 
$a
 - 1;

42 
	g$maxp
 = 
$a
 + 500;

43 
	g$addsqls
[] = " mp.place>'$minp' And mp.place<'$maxp' ";

47 if(
	g$x
!='') {

48 
$addsqls
[] = " mp.sex = '$sex' ";

51 if(
	g$mage
!=0) {

52 
$addsqls
[] = " YEAR(CURDATE())-YEAR(mp.birthday)>='$minage' ";

55 if(
	g$maxage
!=0) {

56 
$addsqls
[] = " YEAR(CURDATE())-YEAR(mp.birthday)<='$maxage' ";

59 
	g$addsqls_r
 = 
jo
(' And ',
$addsqls
);

60 if(
	g$addsqls_r
!='') {

61 
$addsqls_r
 = ' And '.$addsqls_str;

64 
	g$addsql
 = " whmb.a> -1 ".
$addsqls_r
;

66 
	g$quy
 = "Select mb.*,mp.place,YEAR(CURDATE())-YEAR(mp.birthday)sge,mp.lovemsg From `#@__member` mb

67 

 
jo
 `#@
__memb_rs
` 
mp
 

 mp.
mid
=
mb
.mid

68 {
$addsql
} 
d
 
by
 
mb
.
logtime
 
desc
";

69 
$dli
 = 
w
 
DaLiCP
();

70 
	g$dli
->
	ggeSize
 = 8;

71 
	g$dli
->
SPam
('keywd',
$keywd
);

72 
	g$dli
->
SPam
('ov',
$ov
);

73 
	g$dli
->
SPam
('cy',
$cy
);

74 
	g$dli
->
SPam
('mage',
$mage
);

75 
	g$dli
->
SPam
('maxage',
$maxage
);

76 
	g$dli
->
SPam
('x',
$x
);

77 
	g$dli
->
STeme
(
DEDEMEMBER
.'/templets/search.htm');

78 
	g$dli
->
SSour
(
$quy
);

79 
	g$dli
->
Diy
();

	@member/shops_orders.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
ude_
 
	gDEDEINC
.'/datalistcp.class.php';

5 
funi
 
	$GS
(
$a
,
$oid
)

7 
glob
 
$dsql
;

8 
$row
 = 
$dsql
->
	`GO
("SELECTaytype FROM #@__shops_orders WHERE oid='$oid'");

9 if(
$a
==0)

11 if(
$row
['paytype'] == 2){

14 }
	`if
(
$row
['paytype'] == 3){

16  '未付款&gt;<hf="../us/shs_bk.php?pid='.
$row
['paytype'].'"arget="_blank">付款</a>';

17 }
	`if
(
$row
['paytype'] == 4){

19  '未付款&gt;<hf="../us/shs_bk.php?pid='.
$row
['paytype'].'"arget="_blank">付款</a>';

20 }
	`if
(
$row
['paytype'] == 5){

22  '未付款&gt;<hf="shs_pot.php?oid='.
$oid
.'"arget="_blank">付款</a>';

23 }
	`if
(
$row
['paytype'] == 1){

25  '未付款&gt;<hf="../us/shs_buyai.php?oid='.
$oid
.'"arget="_blank">付款</a>';

28 
	`if
(
$a
==1)

32 
	`if
(
$a
==2)

34  '<hf="shs_odus.php?do=ok&oid='.
$oid
.'">确认</a>';

40 
	}
}

42 
	g$sql
 = "SELECT * FROM #@__shs_dWHERE urid='".
$cfg_ml
->
M_ID
."' ORDER BY stime DESC";

43 
	g$dl
 = 
w
 
DaLiCP
();

44 
	g$dl
->
	ggeSize
 = 20;

46 
	g$dl
->
STeme
(
dme
(
__FILE__
)."/templets/shops_orders.htm");

47 
	g$dl
->
SSour
(
$sql
);

48 
	g$dl
->
Diy
();

	@member/shops_point.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 if(
	$ist
(
$oid
))

5 
$oid
 = 
	`egi_a
("[^-0-9A-Z]","",$oid);

6 
$rs
 = 
$dsql
->
	`GO
("SELECTayty,iCou FROM #@__shs_dWHERE urid='".
$cfg_ml
->
M_ID
."' AND oid='$oid'");

7 if(
$rs
['paytype']!=5)

9 
	`ShowMsg
("订单不支持该支付方式！","javascript:;");

10 
	`ex
();

12 
$iCou
 = 
$row
['priceCount'];

14 
$membs
 = 
$dsql
->
	`GO
("SELECT `mey` FROM #@__memb WHERE mid='".
$cfg_ml
->
M_ID
."'");

15 if(
$membs
['mey'] < 
$iCou
)

17 
	`ShowMsg
("支付失败点数不够！","-1");

18 
	`ex
();

21 if(
$dsql
->
	`ExecuNeQuy
("UPDATE `#@__shs_ds` SET `e`='1' WHERE `oid`='$oid' AND `urid`='".
$cfg_ml
->
M_ID
."' AND `state`<1"))

23 
$s
 = 
$dsql
->
	`ExecuNeQuy
("UPDATE #@__member SET money=money-$priceCount WHERE mid='{$cfg_ml->M_ID}'");

24 
	`ShowMsg
("下单,支付成功,等待商家发货！","../memb/shs_odus.php?oid=".
$oid
);

25 
	`ex
();

29 
	`ShowMsg
("支付失败,请联系管理员！","-1");

30 
	`ex
();

32 
	}
}

35 
ex
("403 Forbidden!");

	@member/shops_products.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
ude_
 
	gDEDEINC
.'/datalistcp.class.php';

4 
	g$do
 = 
ist
(
$do
? 
	$im
(
$do
) : '';

5 
$oid
 = 
	`ist
($oid? 
	`egi_a
("[^-0-9A-Z]","",$oid) : '';

6 
$addsql
 = '';

7 if(!
	$emy
(
$oid
))

9 if(
$do
=='ok')

11 
$dsql
->
	`ExecuNeQuy
("UPDATE #@__shops_orders SET `state`='4' WHERE oid='$oid'");

12 
	`ShowMsg
("已确认订单！",'shs_odus.php?oid='.
$oid
);

13 
	`ex
();

16 
$row
 = 
$dsql
->
	`GO
("SELECT * FROM #@__shs_urfWHERE urid='".
$cfg_ml
->
M_ID
."' AND oid='$oid'");

17 if(!
	`ist
(
$row
['oid']))

19 
	`ShowMsg
("订单不存在！",-1);

20 
	`ex
();

22 
$row
['des'] = 
	`rashes
($row['des']);

23 
$rs
 = 
$dsql
->
	`GO
("SELECT s,ime,i,di,iCou,pid FROM #@__shs_dWHERE urid='".
$cfg_ml
->
M_ID
."' AND oid='$oid'");

24 
$row
['e'] = 
$rs
['state'];

25 
$row
['ime'] = 
$rs
['stime'];

26 
$row
['i'] = 
$rs
['price'];

27 
$row
['di'] = 
$rs
['dprice'];

28 
$row
['iCou'] = 
$rs
['priceCount'];

29 
$rs
 = 
$dsql
->
	`GO
("SELECT `dname` FROM #@__shops_delivery WHEREid='$rs[pid]' LIMIT 0,1");

30 
$row
['dme'] = 
$rs
['dname'];

31 
	`unt
(
$rs
);

32 
$addsql
 = " AND oid='".
$oid
."'";

33 
	}
}

35 
	g$sql
 = "SELECT * FROM #@__shs_oduWHERE urid='".
$cfg_ml
->
M_ID
."' $addsql ORDER BYid ASC";

36 
	g$dl
 = 
w
 
DaLiCP
();

37 
	g$dl
->
	ggeSize
 = 20;

38 if(!
emy
(
$oid
)
	g$dl
->
SPam
('oid',$oid);

40 
	g$dl
->
STeme
(
dme
(
__FILE__
)."/templets/shops_products.htm");

41 
	g$dl
->
SSour
(
$sql
);

42 
	g$dl
->
Diy
();

44 
funi
 
	$GS
(
$a
,
$oid
)

46 
glob
 
$dsql
;

47 
$row
 = 
$dsql
->
	`GO
("SELECTaytype FROM #@__shops_orders WHERE oid='$oid'");

48 if(
$a
==0)

50 if(
$row
['paytype'] == 2)

55 
	`if
(
$row
['paytype'] == 3)

58  '未付款&gt;<hf="../us/shs_bk.php?pid='.
$row
['paytype'].'"arget="_blank">付款</a>';

60 
	`if
(
$row
['paytype'] == 4)

63  '未付款&gt;<hf="../us/shs_bk.php?pid='.
$row
['paytype'].'"arget="_blank">付款</a>';

65 
	`if
(
$row
['paytype'] == 5)

68  '未付款&gt;<hf="shs_pot.php?oid='.
$oid
.'"arget="_blank">付款</a>';

70 
	`if
(
$row
['paytype'] == 1)

73  '未付款&gt;<hf="../us/shs_buyai.php?oid='.
$oid
.'"arget="_blank">付款</a>';

76 
	`if
(
$a
==1)

80 
	`if
(
$a
==2)

82  '<hf="shs_odus.php?do=ok&oid='.
$oid
.'">确认</a>';

88 
	}
}

90 
funi
 
	$rTime
(
$oid
)

92 
glob
 
$dsql
;

93 
$row
 = 
$dsql
->
	`GO
("SELECT stime FROM #@__shops_orders WHERE oid='$oid'");

94  
	`Myde
('Y-m-d h:i:s',
$row
['stime']);

95 
	}
}

	@member/soft_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

4 
CheckRk
(0,0);

5 if(
	g$cfg_mb_l
=='Y')

7 
ShowMsg
("由于系统开启了精简版会员空间，你访问的功能不可用！","-1");

8 
ex
();

10 
que_
(
DEDEINC
."/dedetag.class.php");

11 
que_
(
DEDEINC
."/customfields.func.php");

12 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

13 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

14 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 3;

15 
	g$tyid
 = 
ist
(
$tyid
&& 
is_numic
($typeid) ? $typeid : 0;

20 if(
	$emy
(
$do
))

22 
$cInfos
 = 
$dsql
->
	`GO
("Select * From `#@__channeltype` where id='$channelid'; ");

23 if(!
	`is_y
(
$cInfos
))

25 
	`ShowMsg
('模型不正确', '-1');

26 
	`ex
();

30 if(
$cInfos
['sendrank']>0 || $cInfos['usertype']!='')

32 
	`CheckRk
(0,0);

36 if(
$cInfos
['ndnk'] > 
$cfg_ml
->
M_Rk
)

38 
$row
 = 
$dsql
->
	`GO
("Se membmFrom `#@__k` whnk='".
$cInfos
['sendrank']."' ");

39 
	`ShowMsg
("对不起，需要[".
$row
['membername']."]才能在这个频道发布文档！","-1","0",5000);

40 
	`ex
();

42 if(
$cInfos
['uy']!='' && $cInfos['uy'] !
$cfg_ml
->
M_MbTy
)

44 
	`ShowMsg
("对不起，需要[".
$cInfos
['usertype']."帐号]才能在这个频道发布文档！","-1","0",5000);

45 
	`ex
();

47 
	`ude
(
DEDEMEMBER
."/templets/soft_add.htm");

48 
	`ex
();

49 
	}
}

54 if(
	g$do
=='save')

56 
$desti
 = '';

57 
ude
(
DEDEMEMBER
.'/inc/archives_check.php');

60 
	g$add_f
 = '';

61 
	g$add_v
 = '';

62 if(!
emy
(
$dede_addflds
))

64 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

65 
	g$add_f
 = '';

66 
	g$add_v
 = '';

67 if(
is_y
(
$addflds
))

69 
fܗch
(
$addflds
 
as
 
$v
)

71 if(
	g$v
=='')

75 
	g$vs
 = 
exode
(',',
$v
);

76 if(!
ist
(
$
{
$vs
[0]}))

78 
	g$
{
	g$vs
[0]} = '';

80 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

84 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

88 if(!
ist
(
$
{
$vs
[0]}))

90 
	g$
{
	g$vs
[0]} = '';

92 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$cID
);

94 
	g$add_f
 .','.
$vs
[0];

95 
	g$add_v
 ." ,'".
$
{
$vs
[0]}."' ";

101 if(
	g$lpic
!='')

103 
$ag
 = 'p';

105 
	g$body
 = 
HtmlR
(
$body
,-1);

108 
	g$cID
 = 
GIndexKey
(
$k
,
$tyid
,
$s܌k
,
$chlid
,
$ndde
,
$mid
);

109 if(
emy
(
$cID
))

111 
ShowMsg
("无法获得主键，因此无法进行后续操作！","-1");

112 
ex
();

116 
	g$Quy
 = "INSERT INTO `#@__archives`(id,typeid,sortrank,flag,ismake,channel,arcrank,click,money,title,shorttitle,

117 
c
,
	gwr
,
	gsour
,
	glpic
,
	gpubde
,
	gndde
,
	gmid
,
	gdesti
,
	gkeywds
)

118 
VALUES
 ('$arcID','$typeid','$sortrank','$flag','$ismake','$channelid','$arcrank','0','$money','$title','$shorttitle',

120 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

122 
	g$gr
 = 
$dsql
->
GE
();

123 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID' ");

124 
ShowMsg
("把数据保存到数据库主表 `#@__archives` 时出错，请联系管理员。","javascript:;");

125 
ex
();

129 
	g$sou1
 = 
rashes
(
$sou1
);

130 
	g$us
 = '';

131 if(
	g$sou1
!='')

133 
$us
 .= "{dede:link islocal='1'ext='{$servermsg1}'} $softurl1 {/dede:link}\r\n";

135 
	g$i
=2;$i<=12;$i++)

137 if(!
emy
(
$
{'sou'.
$i
}))

139 
	g$rvmsg
 = 
r_a
("'","",
rashes
(
$
{'rvmsg'.
$i
}));

140 
	g$sou
 = 
rashes
(
$
{'sou'.
$i
});

141 if(
	g$rvmsg
=='')

143 
$rvmsg
 = '下载地址'.
$i
;

145 if(
	g$sou
!='' && 
$sou
!='http://')

147 
$us
 .= "{dede:linkext='$servermsg'} $softurl {/dede:link}\r\n";

151 
	g$us
 = 
addashes
(
$us
);

152 
	g$sosize
 = 
$sosize
.
$un
;

155 
	g$edmey
 = @
tv
(
$edmey
);

156 if(
	g$edmey
 > 100) $needmoney = 100;

157 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

158 
	g$addb
 = 
im
(
$s
['addtable']);

159 if(
emy
(
$addb
))

161 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

162 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

163 
ShowMsg
("没找到当前模型[{$channelid}]的主表信息，无法完成操作！。","javascript:;");

164 
ex
();

166 
	g$Quy
 = "INSERT INTO `$addtable`(aid,typeid,filetype,language,softtype,accredit,

167 
os
,
	gsonk
,
	gofficlU
,
	gofficlDemo
,
	gsosize
,
	gsolks
,
	godu
,
	gur
,
	gm
,
	gdeu
,
	gdacss
,
	gedmey
{
	g$add_f
})

168 
VALUES
 ('$arcID','$typeid','$filetype','$language','$softtype','$accredit',

169 '$os','$sonk','$officlU','$officlDemo','$sosize','$us','$body','$ur','','','0','$edmey'{
$add_v
});";

170 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

172 
	g$gr
 = 
$dsql
->
GE
();

173 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__archives` where id='$arcID'");

174 
	g$dsql
->
ExecuNeQuy
("Delete From `#@__arctiny` where id='$arcID'");

175 
echo
 
	g$Quy
;

176 
ex
();

177 
ShowMsg
("把数据保存到数据库附加表 `{$addb}` 时出错，请把相关信息提交给DedeCms官方。".
r_a
('"','',
$gr
),"javascript:;");

178 
ex
();

182 
	g$dsql
->
ExecuNeQuy
("Upd`#@__memb` s sces=sces+{$cfg_ndc_sces} whmid='".
$cfg_ml
->
M_ID
."' ; ");

184 
couArchives
(
$chlid
);

187 
InTags
(
$gs
,
$cID
);

188 
	g$tU
 = 
MakeA
(
$cID
,
ue
);

189 if(
	g$tU
=='')

191 
$tU
 = 
$cfg_phpu
."/view.php?aid=$arcID";

195 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/api/uc.func.php')

198 
	g$ed
['icon'] = 'thread';

199 
	g$ed
['title_template'] = '<b>{username} 在网站共享了一软件</b>';

200 
	g$ed
['t_da'] = 
y
('uame' => 
$cfg_ml
->
M_UrName
);

201 
	g$ed
['body_template'] = '<b>{subject}</b><br>{message}';

202 
	g$u
 = !
rr
(
$tU
,'hp://'? (
	g$cfg_baho
.
	g$tU
) : $artUrl;

203 
	g$ed
['body_da'] = 
y
('subje' => "<hf=\"".
$u
."\">$t</a>", 'mesge' => 
_subr
(
r_gs
(
eg_a
("/\[.+?\]/is", '', 
$desti
)), 150));

204 
	g$ed
['images'][] = 
y
('u' => 
$cfg_baho
.'/images/scores.gif', 'link'=> $cfg_basehost);

205 
uc_ed_ne
(
$cfg_ml
->
M_LogID
,
$ed
);

207 
uc_ed_ne
(
$cfg_ml
->
M_LogID
, 
$cfg_ndc_sces
);

209 #/
a
}}

212 
	g$msg
 = "

214 <
a
 
hf
='so_add.php?cid=$tyid'><
u
>继续发布软件</u></a>

215 &
nb
;&
	gnb
;

216 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看软件</u></a>

217 &
nb
;&
	gnb
;

218 <
a
 
	ghf
='so_ed.php?chlid=$chlid&aid=$cID'><
u
>更改软件</u></a>

219 &
nb
;&
	gnb
;

220 <
a
 
	ghf
='cڋ_li.php?chlid={$chlid}'><
u
>已发布软件管理</u></a>

222 
$wt
 = "成功发布文章！";

223 
	g$wecome_fo
 = "文章管理::发布文章";

224 
	g$w
 = 
w
 
OxWdow
();

225 
	g$w
->
AddT
("成功发布文章：");

226 
	g$w
->
AddMsgIm
(
$msg
);

227 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

228 
	g$w
->
Diy
();

	@member/soft_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/dedetag.class.php");

5 
que_
(
DEDEINC
."/customfields.func.php");

6 
que_
(
DEDEMEMBER
."/inc/inc_catalog_options.php");

7 
que_
(
DEDEMEMBER
."/inc/inc_archives_functions.php");

8 
	g$chlid
 = 
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 3;

9 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

14 if(
	$emy
(
$do
))

17 
$cQuy
 = "Select

18 #@
__chy
.
tyme
 
as
 
chame
,

19 #@
__k
.
membme
 
as
 
nkme
,

20 #@
__chy
.
ca
,

21 #@
__chives
.*

22 
From
 #@
__chives


23 

 
jo
 #@
__chy
 

 #@__chy.
id
=#@
__chives
.
chl


24 

 
jo
 #@
__k
 

 #@__k.
nk
=#@
__chives
.
k


25 
whe
 #@
__chives
.
id
='$aid'";

26 
$dsql
->
	`SQuy
(
$cQuy
);

27 
$row
 = 
$dsql
->
	`GO
(
$cQuy
);

28 if(!
	`is_y
(
$row
))

30 
	`ShowMsg
("读取档案基本信息出错!","-1");

31 
	`ex
();

33 if(
$row
['arcrank']>=0)

35 
$dtime
 = 
	`time
();

36 
$maxtime
 = 
$cfg_mb_edday
 * 24 *3600;

37 if(
$dtime
 - 
$row
['ndde'] > 
$maxtime
)

39 
	`ShowMsg
("这篇文档已经锁定，你不能再修改它！","-1");

40 
	`ex
();

43 
$quy
 = "Se * From `#@__chy` whid='".
$row
['channel']."'";

44 
$cInfos
 = 
$dsql
->
	`GO
(
$quy
);

45 if(!
	`is_y
(
$cInfos
))

47 
	`ShowMsg
("读取频道配置信息出错!","javascript:;");

48 
	`ex
();

50 
$addb
 = 
$cInfos
['addtable'];

51 
$addQuy
 = "Select * From `$addtable` whereid='$aid'";

52 
$addRow
 = 
$dsql
->
	`GO
(
$addQuy
);

53 
$wRowS
 = 1;

54 
$nFm
 = '';

55 if(
$addRow
['softlinks']!='')

57 
$d
 = 
w
 
	`DedeTagP
();

58 
$d
->
	`LdSour
(
$addRow
['softlinks']);

59 if(
	`is_y
(
$d
->
CTags
))

61 
	`fܗch
(
$d
->
CTags
 
as
 
$ag
)

63 if(
$ag
->
	`GName
()=='link')

65 
$nFm
 ."软件地址".
$wRowS
."：<puass='xt'y='xt'ame='sou".$wRowS."' vue='".
	`im
(
$ag
->
	`GIText
())."' />

66 服务器名称：<
put
 
ass
='xt' 
ty
='xt' 
me
='rvmsg".$wRowS."' 
vue
='".$ctag->GetAtt("text")."' />

67 <
br
 />";

68 
$wRowS
++;

72 
$d
->
	`Cˬ
();

74 
$chlid
 = 
$row
['channel'];

75 
$gs
 = 
	`GTags
(
$aid
);

76 
	`ude
(
DEDEMEMBER
."/templets/soft_edit.htm");

77 
	`ex
();

78 
	}
}

83 if(
	g$do
=='save')

85 
$desti
 = '';

86 
ude
(
DEDEMEMBER
.'/inc/archives_check_edit.php');

89 
	g$add_f
 = '';

90 if(!
emy
(
$dede_addflds
))

92 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

93 if(
is_y
(
$addflds
))

95 
fܗch
(
$addflds
 
as
 
$v
)

97 if(
	g$v
=='')

101 
	g$vs
 = 
exode
(',',
$v
);

102 if(!
ist
(
$
{
$vs
[0]}))

104 
	g$
{
	g$vs
[0]} = '';

106 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$aid
);

107 
	g$add_f
 .','.
$vs
[0]." ='".
$
{$vs[0]}."' ";

111 
	g$body
 = 
AlyHtmlBody
(
$body
,
$desti
);

112 
	g$body
 = 
HtmlR
(
$body
,-1);

115 if(
	g$lpic
!='')

117 
$ag
 = 'p';

121 
	g$add_f
 = '';

122 
	g$add_v
 = '';

123 if(!
emy
(
$dede_addflds
))

125 
	g$addflds
 = 
exode
(';',
$dede_addflds
);

126 
	g$add_f
 = '';

127 
	g$add_v
 = '';

128 if(
is_y
(
$addflds
))

130 
fܗch
(
$addflds
 
as
 
$v
)

132 if(
	g$v
=='')

136 
	g$vs
 = 
exode
(',',
$v
);

139 if(
	g$vs
[1]=='htmext'||
$vs
[1]=='textdata')

141 
$
{
$vs
[0]} = 
AlyHtmlBody
(${$vs[0]},
$desti
,
$lpic
,
$keywds
,$vs[1]);

145 if(!
ist
(
$
{
$vs
[0]}))

147 
	g$
{
	g$vs
[0]} = '';

149 
	g$
{
	g$vs
[0]} = 
GFldVueA
(
$
{
$vs
[0]},$vs[1],
$cID
);

151 
	g$add_f
 .",`{$vs[0]}` = '".
$
{
$vs
[0]}."'";

157 
	g$upQuy
 = "Update `#@__archives` set

158 
ismake
='$ismake',

159 
	gk
='$arcrank',

160 
	gtyid
='$typeid',

161 
	gt
='$title',

162 
	glpic
='$litpic',

163 
	gdesti
='$description',

164 
	gkeywds
='$keywords',

165 
	gag
='$flag'

166 
whe
 
id
='$aid' 
And
 
mid
='$mid'; ";

167 if(!
	g$dsql
->
ExecuNeQuy
(
$upQuy
))

169 
ShowMsg
("更新数据库archives表时出错，请检查！","-1");

170 
ex
();

174 
	g$us
 = '';

175 
	g$i
=1;$i<=9;$i++)

177 if(!
emy
(
$
{'sou'.
$i
}))

179 
	g$rvmsg
 = 
r_a
("'",'',
rashes
(
$
{'rvmsg'.
$i
}));

180 
	g$sou
 = 
rashes
(
$
{'sou'.
$i
});

181 if(
	g$rvmsg
=='')

183 
$rvmsg
 = '下载地址'.
$i
;

185 if(
	g$sou
!='' && 
$sou
!='http://')

187 
$us
 .= "{dede:linkext='$servermsg'} $softurl {/dede:link}\r\n";

191 
	g$us
 = 
addashes
(
$us
);

194 
	g$edmey
 = @
tv
(
$edmey
);

195 if(
	g$edmey
 > 100) $needmoney = 100;

196 
	g$s
 = 
$dsql
->
GO
("Selectddtable From `#@__channeltype` where id='$channelid' ");

197 
	g$addb
 = 
im
(
$s
['addtable']);

198 if(
	g$addb
!='')

200 
$Quy
 = "update `$addtable`

201 
t
 
tyid
 ='$typeid',

202 
	gfy
 ='$filetype',

203 
	gnguage
 ='$language',

204 
	gsoty
 ='$softtype',

205 
	gaced
 ='$accredit',

206 
	gos
 ='$os',

207 
	gsonk
 ='$softrank',

208 
	gofficlU
 ='$officialUrl',

209 
	gofficlDemo
 ='$officialDemo',

210 
	gsosize
 ='$softsize',

211 
	gsolks
 ='$urls',

212 
	gur
='$userip',

213 
	gedmey
='$needmoney',

214 
	godu
='$body'{
$add_f
}

215 
whe
 
aid
='$aid'; ";

216 if(!
	g$dsql
->
ExecuNeQuy
(
$Quy
))

218 
ShowMsg
("更新数据库附加表ddonsoft 时出错，请检查原因！","-1");

219 
ex
();

222 
UpIndexKey
(
$aid
,
$k
,
$tyid
,
$s܌k
,
$gs
);

223 
	g$tU
 = 
MakeA
(
$aid
,
ue
);

224 if(
	g$tU
=='')

226 
$tU
 = 
$cfg_phpu
."/view.php?aid=$aid";

230 
	g$msg
 = "　　请选择你的后续操作：

231 <
a
 
hf
='so_add.php?cid=$tyid'><
u
>发布新文章</u></a>

232 &
nb
;&
	gnb
;

233 <
a
 
	ghf
='so_ed.php?chlid=$chlid&aid=".$aid."'><
u
>查看更改</u></a>

234 &
nb
;&
	gnb
;

235 <
a
 
	ghf
='$tU' 
rg
='_bnk'><
u
>查看文章</u></a>

236 &
nb
;&
	gnb
;

237 <
a
 
	ghf
='cڋ_li.php?chlid=$chlid'><
u
>管理文章</u></a>

239 
$wt
 = "成功更改文章！";

240 
	g$wecome_fo
 = "文章管理::更改文章";

241 
	g$w
 = 
w
 
OxWdow
();

242 
	g$w
->
AddT
("成功更改文章：");

243 
	g$w
->
AddMsgIm
(
$msg
);

244 
	g$wfm
 = 
$w
->
GWdow
("hd","&nb;",
l
);

245 
	g$w
->
Diy
();

	@member/spaceskin.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(
	g$cfg_mb_l
=='Y')

6 
ShowMsg
("由于系统开启了精简版会员空间，你访问的功能不可用！","-1");

7 
ex
();

9 if(
	$emy
(
$do
))

11 
$do
 = '';

12 
	}
}

14 if(
	g$do
=="use")

16 
AjaxHd
();

17 
	g$t
 = 
egi_a
("[^a-z0-9-]", "", 
$t
);

18 
	g$dsql
->
ExecuNeQuy
("upd`#@__memb_a` s sy='$t' whmid='".
$cfg_ml
->
M_ID
."';");

19 
ShowMsg
('成功更新空间样式！', 'spaceskin.php');

24 
	g$uow
 = 
$dsql
->
GO
("Se sy From `#@__memb_a` whmid='".
$cfg_ml
->
M_ID
."' ");

25 
que_
(
dme
(
__FILE__
)."/templets/spaceskin.htm");

26 
ex
();

30 
funi
 
	$checku
(
$ty
)

32 
glob
 
$cfg_ml
, 
$uow
;

33 if(
$uow
['ay'] =
$ty
)

39  '<hf="ask.php?t='.
$ty
.'&dopost=use"itle="使用此风格">使用</a>';

41 
	}
}

44 
funi
 
	$showdemic
(
$d
,
$dme
)

46 i(
	`fe_exis
("$dir/$dirname/demo.png")) {

47 
$demic
 = "$dir/$dirname/demo.png";

48 } 
	`if
 (
	`fe_exis
("$dir/$dirname/demo.jpg")) {

49 
$demic
 = "$dir/$dirname/demo.jpg";

50 } 
	`if
 (
	`fe_exis
("$dir/$dirname/demo.jpeg")) {

51 
$demic
 = "$dir/$dirname/demo.jpeg";

52 } 
	`if
 (
	`fe_exis
("$dir/$dirname/demo.gif")) {

53 
$demic
 = "$dir/$dirname/demo.gif";

55  
$demic
;

56 
	}
}

59 
funi
 
	$LiSk
()

61 
glob
 
$cfg_ml
;

62 
$d
 = 'space';

63 
$lsks
 = 
	`y
();

65 if(
	`fe_exis
(
$d
.'/skinlist.inc'))

67 
$ds
 = 
	`fe
(
$d
.'/skinlist.inc');

68 
	`fܗch
(
$ds
 
as
 
$d
)

70 
$d
 = 
	`im
($d);

71 if(
	`emy
(
$d
|| 
	`subr
($d, 0, 2)=='//') ;

72 if(!
	`is_d
(
$d
.'/'.
$d
)) ;

73 
$ds
[] = 
$d
;

78 
$
 = 
	`ݒd
(
$d
);

79 
$syame
 = 
	`add
(
$
))

81 
$ds
[] = 
$syame
;

83 
	`od
(
$dh
);

86 
	`fܗch
(
$ds
 
as
 
$syame
)

88 i(
$syame
=='.' || $sysname=='..' || $sysname=='CVS'

89 || !
	`fe_exis
("$dir/$sysname/info.txt"))

93 
$demic
 = 
	`showdemic
(
$d
, 
$syame
);

94 
$de
 = 
	`MyDe
('Y-m-d', 
	`femtime
("$dir/$sysname"));

95 
$lidb
 = 
	`y
(

96 'sign' => 
$syame
,

97 'demo' => 
$demic
,

102 
$fodas
 = 
	`fe
("$dir/$sysname/info.txt");

103 
	`fܗch
(
$fodas
 
as
 
$d
)

105 
$d
 = 
	`im
($d);

106 if(
	`emy
(
$d
)) ;

107 
$ds
 = 
	`exode
(':', 
$d
);

108 
$lidb
[
	`im
(
$ds
[0])] =rim($ds[1]);

110 if(
$lidb
['ty'] !'deu' && $lidb['ty'] !
$cfg_ml
->
M_MbTy
)

114 
$lsks
[] = 
$lidb
;

117 
$num
 = 0;

118 
t
 '<tr class="head" height="25"><td colspan="2">&nbsp; &nbsp;<b></b></td></tr>';

119 
	`fܗch
 (
$lsks
 
as
 
$vue
)

121 if(
$num
==0{ 
t
 '<tr height="20">'; }

122 
$num
++;

123 
t
 '<td css="b"><img src="'.
$vue
['demo'].'" width="150" height="150" border="0" /><br />';

124 
t
 '风格名称：'.
$vue
['name']."({$value['sign']})".'<br />';

125 
t
 '风格作者：'.
$vue
['author'].'<br />';

127 
t
 '操作：'.
	`checku
(
$vue
['sign']).'';

128 if(
$num
==4)

130 
$num
=0;

131 
t
 '</tr>';

134 if(
$num
 != 0)

136 
$i
=
$num
; $num < 4; $num++)

138 
t
' <td class="b">&nbsp;</td>';

140 
t
 '</tr>';

142 
t
 '</td>';

143 
	}
}

	@member/templets/menu.php

1 <?
php


2 
	g$add_chl_mu
 = 
y
();

4 if(!
emy
(
$cfg_ml
->
M_ID
))

6 
	g$chlInfos
 = 
y
();

7 
	g$dsql
->
Execu
('addmod',"SELECT id,nid,typename,useraddcon,usermancon,issend,issystem,usertype,isshow FROM `#@__channeltype` ");

8 
	g$murow
 = 
$dsql
->
GAay
('addmod'))

10 
$chlInfos
[
$murow
['nid']] = $menurow;

12 if(
	g$murow
['isshow']==0)

17 if(
	g$murow
['isnd']!=1 || 
$murow
['issystem']==1

18 || ( !
eg
(
$cfg_ml
->
M_MbTy
, 
$murow
['uy']&& 
im
($menurow['usertype'])!='' ) )

22 
	g$murow
['ddc'] = 
emy
(
$murow
['useraddcon']) ? 'archives_add.php' : $menurow['useraddcon'];

23 
	g$murow
['li'] = 
emy
(
$murow
['usermancon']) ? 'content_list.php' : $menurow['usermancon'];

24 
	g$add_chl_mu
[] = 
$murow
;

26 
unt
(
$murow
);

28 <
st
 
	gnguage
='javascript'>

29 
funi
 
ShowHideMuD
(
mid
)

31 if(
$
("#"+
mid
).
css
("display") == 'block') {

32 
$
("#"+
mid
).
hide
(200);

35 
$
("#"+
mid
).
show
(200);

38 </
	gst
>

39 <
div
 
	gass
="dedeLeft">

40 <
div
 
ass
='allmenu'>

42 <
div
 
ass
='muT mbccڋ' 
ick
="ShowHideMenuD('mbccontent')"></div>

43 <
ul
 
ass
="Nav" 
id
="mbccontent">

44 <?
php


46 if(
$chlInfos
['article']['issend']==1 && $channelInfos['article']['isshow']==1)

49 <
li
 
ass
="icڇie"><
a
 
hf
="../memb/cڋ_li.php?chlid=1" 
t
="已发布的文章">文章</a><
em
 css="bck"><hf="../memb/tie_add.php"="发表新文章">发表&
quo
;</
	ga
></
	gem
></
	gli
>

50 <?
	gphp


53 if(
	g$chlInfos
['image']['isnd']==1 && 
$cfg_mb_bum
=='Y' && 
$chlInfos
['image']['isshow']==1

54 && (
$chlInfos
['image']['uy']=='' || 
eg
(
$cfg_ml
->
flds
['mtype'], $channelInfos['image']['usertype'])) )

57 <
li
 
	gass
="ic image"><
a
 
hf
="../memb/cڋ_li.php?chlid=2" 
t
="管理图集">图集</a><
em
 
ass
="bck"><hf="../memb/bum_add.php"="新建图集">新建&
quo
;</
	ga
></
	gem
></
	gli
>

58 <?
	gphp


61 if(
	g$chlInfos
['so']['isnd']==1 && 
$chlInfos
['soft']['isshow']==1

62 && (
$chlInfos
['image']['uy']=='' || 
eg
(
$cfg_ml
->
flds
['mtype'], $channelInfos['image']['usertype']))

66 <
li
 
	gass
="ic so"><
a
 
hf
="../memb/cڋ_li.php?chlid=3" 
t
="已发布的软件">软件</a><
em
 
ass
="bck"><hf="../memb/so_add.php"="上传软件">上传&
quo
;</
	ga
></
	gem
></
	gli
>

67 <?
	gphp


70 if(
	g$cfg_mb_ndl
=='Y')

72 
fܗch
(
$add_chl_mu
 
as
 
$¬r
) {

74 <
li
 
ass
="icon channel">

75 <
a
 
hf
="../memb/<?phech$¬r['li'];?>?chlid=<?phech$¬r['id'];?>" 
t
="已发布的<?phech$¬r['tyme'];?>"><?
php
 
echo
 
$¬r
['tyme'];?></
	ga
>

76 </
	gli
>

77 <?
	gphp


80 </
	gul
>

82 <
div
 
	gass
='muT mbccfig' 
ick
="ShowHideMenuD('mbcconfig')"></div>

83 <
ul
 
ass
="Nav" 
id
="mbcconfig">

84 <
li
 
ass
="ic myfo"><
a
 
hf
="../memb/ed_fuΚfo.php"><?
php
 
echo
 
$cfg_ml
->
M_MbTy
; ?>资料</
	ga
></
	gli
>

85 <
li
 
	gass
="ic mycfig"><
a
 
hf
="../member/mtypes.php">空间管理</a></li>

86 </
ul
>

88 <
div
 
ass
='muT mbcmey' 
ick
="ShowHideMenuD('mbcmoney')"></div>

89 <
ul
 
ass
="Nav" 
id
="mbcmoney">

90 <
li
 
ass
="ic csume1"><
a
 
hf
="../member/operation.php">财务管理</a></li>

91 <
li
 
ass
="ic csume"><
a
 
hf
="../member/buy.php">升级/充值</a></li>

92 </
ul
>

94 <
div
 
ass
='muT mb' 
ick
="ShowHideMenuD('mbcapp')"></div>

95 <
ul
 
ass
="Nav" 
id
="mbcapp">

96 <?
php


97 if(
$cfg_edback_fbid
=='N')

101 
$dsql
->
Execu
('nn','Select indexname,indexurl From `#@__sys_module` where ismember=1 ');

102 
	g$¬r
 = 
$dsql
->
GAay
('nn'))

104 @
eg_mch
("/\/(.+?)\//is", 
$¬r
['dexu'],
$mches
);

105 
	g$¬r
['ass'] = 
ist
(
$mches
[1]) ? $matches[1] : 'channel';

107 <
li
 
	gass
="ic <?phech$¬r['ass'];?>"><
a
 
hf
="<?phech$¬r['dexu']; ?>"><?
php
 
echo
 
$¬r
['dexme']; ?>模块</
	ga
></
	gli
>

108 <?
	gphp


111 </
	gul
>

112 <
hr
 
	gwidth
="94%" 
ass
="dotted" />

113 <
bu
 
ass
="bu5 mTB10" 
ick
="location='../member/edit_space_info.php';">空间设置</button>

114 <
hr
 
width
="94%" 
ass
="dotted" />

115 <!--
div
 
ass
="lineB"></div-->

116 </
div
>

117 </
div
>

118 <?
php


	@member/templets/menulit.php

1 <?
php


2 
	g$add_chl_mu
 = 
y
();

3 if(
	g$cfg_mb_ndl
=='Y')

5 
$dsql
->
Execu
('addmod',"SELECT id,nid,typename,useraddcon,usermancon FROM #@__channeltype WHERE issend=1 AND issystem<>1 AND (usertype='' OR usertype LIKE '{$cfg_ml->M_MbType}')");

6 
	g$murow
 = 
$dsql
->
GAay
('addmod'))

8 
$murow
['ddc'] = 
emy
($menurow['useraddcon']) ? 'archives_add.php' : $menurow['useraddcon'];

9 
	g$murow
['li'] = 
emy
(
$murow
['usermancon']) ? 'content_list.php' : $menurow['usermancon'];

10 
	g$add_chl_mu
[] = 
$murow
;

12 
unt
(
$murow
);

15 <
div
 
	gass
="dedeLeft">

16 <
ul
 
ass
="leftNav">

17 <
li
 
ass
="icڇie"><
a
 
hf
="../memb/cڋ_li.php?chlid=1" 
t
="已发布的文章">文章</a><
em
 class="black"><a href="../member/article_add.php"itle="发表新文章">发表</a></em></li>

18 <
li
 
ass
="ic image"><
a
 
hf
="../memb/cڋ_li.php?chlid=2" 
t
="管理图集">图集</a><
em
 class="black"><a href="../member/album_add.php"itle="新建图集">新建</a></em></li>

19 <
li
 
ass
="ic so"><
a
 
hf
="../memb/cڋ_li.php?chlid=3" 
t
="已发布的软件">软件</a><
em
 class="black"><a href="../member/soft_add.php"itle="上传软件">上传</a></em></li>

21 <?
php


22 
$dsql
->
Execu
('nn','Select indexname,indexurl From `#@__sys_module` where ismember=1 ');

23 
	g$¬r
 = 
$dsql
->
GAay
('nn')){

24 @
eg_mch
("/\/(.+?)\//is", 
$¬r
['dexu'],
$mches
);

25 
	g$¬r
['ass'] = 
$mches
[1];

27 <
li
 
	gass
="ic <?phech$¬r['ass'];?>"><
a
 
hf
="<?phech$¬r['dexu']; ?>" 
t
="<?phech$¬r['dexme']; ?>" ><?
php
 
echo
 
$¬r
['dexme']; ?></
	ga
></
	gli
>

28 <?
	gphp
 }?>

30 <?
php
 
	$fܗch
(
$add_chl_mu
 
as
 
$¬r
) { ?>

31 <
li
 
ass
="icon channel">

32 <
a
 
hf
="../memb/<?phech$¬r['li'];?>?chlid=<?phech$¬r['id'];?>" 
t
="已发布的<?phech$¬r['tyme'];?>"><?
php
 
echo
 
$¬r
['typename'];?></a>

33 </
li
>

34 <?
php
 
	}
}?>

36 <
li
 
	gass
="ic csume"><
a
 
hf
="../member/mypay.php">消费管理</a></li>

37 <
li
 
ass
="ic fe"><
a
 
hf
="../member/uploads.php">附件管理</a></li>

38 </
ul
>

39 <
hr
 
width
="94%" 
ass
="dotted" />

40 <
bu
 
ass
="bu2 mTB10" 
ick
="location='edit_fullinfo.php';">设置</button>

41 <
hr
 
width
="94%" 
ass
="dotted" />

42 <
div
 
ass
="lineB"></div>

43 </
div
>

	@member/uploads.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 
	g$keywd
 = 
emy
(
$keywd
? '' : 
FrSrch
($keyword);

7 
	g$addsql
 = " whmid='".
$cfg_ml
->
M_ID
."' Anditleike '%$keyword%' ";

8 if(
	$emy
(
$medty
))

10 
$medty
 = 0;

11 
	}
}

12 
	g$medty
 = 
tv
(
$medty
);

13 if(
	g$medty
>0)

15 
	g$addsql
 .= " And mediatype='$mediatype' ";

17 
	g$sql
 = "Select * From `#@__uploads` $addsql order byid desc";

18 
	g$dli
 = 
w
 
DaLiCP
();

19 
	g$dli
->
	ggeSize
 = 5;

20 
	g$dli
->
SPam
("medty",
$medty
);

21 
	g$dli
->
SPam
("keywd",
$keywd
);

22 
	g$dli
->
STeme
(
DEDEMEMBER
."/templets/uploads.htm");

23 
	g$dli
->
SSour
(
$sql
);

24 
	g$dli
->
Diy
();

26 
funi
 
	$MedTy
(
$tid
,
$nu
)

28 if(
$tid
==1)

32 if(
$tid
==2)

36 if(
$tid
==3)

44 
	}
}

45 
funi
 
	$GFeSize
(
$fs
)

47 
$fs
 = $fs/1024;

48  
	`rtf
("%10.1f",
$fs
)." K";

49 
	}
}

50 
funi
 
	$GImageVw
(
$fu
,
$mty
)

52 if(
$mty
==1)

56 
	}
}

	@member/uploads_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckRk
(0,0);

4 
que_
(
DEDEMEMBER
.'/inc/inc_archives_functions.php');

5 if(
emy
(
$do
)
	g$do
 = '';

6 if(
emy
(
$medty
)
	g$medty
 = 1;

7 if(
	g$do
=='')

9 
ude
(
DEDEMEMBER
."/templets/uploads_add.htm");

11 if(
	g$do
=='save')

13 
$cfg_ml
->
CheckUrS
();

14 if(
	g$medty
==1)

16 
$uty
 = 'image';

18 if(
	g$medty
==2)

20 
$uty
 = 'flash';

22 if(
	g$medty
==3)

24 
$uty
 = 'media';

28 
	g$uty
 = 'addon';

30 
	g$t
 = 
HtmlR
(
$t
,2);

31 
	g$fame
 = 
MembUds
('addfe','',
$cfg_ml
->
M_ID
,
$uty
,'',-1,-1,
ue
);

32 
SaveUdInfo
(
$t
,
$fame
,
$medty
);

33 
	g$bku
 = "uds_.php?f=".
$f
."&medty=".
$medty
."&keywd=".
ucode
(
$keywd
)."&fame=".
$fame
;

34 if(
	g$fame
=='')

36 
ShowMsg
("ϴļʧܣ","-1");

40 
ShowMsg
("ɹϴһļ",
$bku
);

	@member/uploads_edit.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/config.php');

3 
CheckRk
(0,0);

4 
que_
(
DEDEMEMBER
.'/inc/inc_archives_functions.php');

5 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

6 if(
emy
(
$do
)
	g$do
 = '';

7 if(
	g$do
=='')

9 
$ow
 = 
$dsql
->
GO
("Select * From `#@__uploads` whereid='$aid ';");

10 if(!
is_y
(
$ow
))

12 
ShowMsg
('附件不存在', '-1');

13 
ex
();

15 if(
	g$ow
['mid']!=
$cfg_ml
->
M_ID
)

17 
ShowMsg
("你没有修改这个附件的权限！","-1");

18 
ex
();

20 
ude
(
DEDEMEMBER
."/templets/uploads_edit.htm");

21 
ex
();

23 if(
	g$do
=='save')

25 
$t
 = 
HtmlR
($title,2);

26 if(
	g$medty
==1
$uty
 = 'image';

27 if(
	g$medty
==2)

29 
$uty
 = 'flash';

31 if(
	g$medty
==3)

33 
$uty
 = 'media';

37 
	g$uty
 = 'addon';

39 
	g$t
 = 
HtmlR
(
$t
,2);

40 
	g$exme
 = 
eg_a
("(.*)/","",
$du
);

41 
	g$exme
 = 
eg_a
("\.(.*)$","",
$exme
);

42 
	g$fame
 = 
MembUds
('addfe',
$du
,
$cfg_ml
->
M_ID
,
$uty
,
$exme
,-1,-1,
ue
);

43 
SaveUdInfo
(
$t
,
$fame
,
$medty
);

44 
ShowMsg
("成功修改文件！","uploads_edit.php?aid=$aid");

	@member/uploads_select.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 
tcook
("ENV_GOBACK_URL",
$dedeNowu
,
time
()+3600,"/");

6 if(
	$emy
(
$fame
))

8 
$fame
 = '';

9 
	}
}

10 
	g$keywd
 = 
emy
(
$keywd
? '' : 
FrSrch
($keyword);

11 
	g$addsql
 = " whmid='".
$cfg_ml
->
M_ID
."' Anditleike '%$keyword%' ";

12 if(
	$emy
(
$medty
))

14 
$medty
 = 0;

15 
	}
}

16 
	g$medty
 = 
tv
(
$medty
);

17 if(
	g$medty
>0)

19 
	g$addsql
 .= " And mediatype='$mediatype' ";

21 
	g$sql
 = "Select * From `#@__uploads` $addsql order byid desc";

22 
	g$dli
 = 
w
 
DaLiCP
();

23 
	g$dli
->
	ggeSize
 = 5;

24 
	g$dli
->
SPam
("medty",
$medty
);

25 
	g$dli
->
SPam
("keywd",
$keywd
);

26 
	g$dli
->
SPam
("f",
$f
);

27 
	g$dli
->
STeme
(
DEDEMEMBER
."/templets/uploads_select.htm");

28 
	g$dli
->
SSour
(
$sql
);

29 
	g$dli
->
Diy
();

31 
funi
 
	$MedTy
(
$tid
,
$nu
)

33 if(
$tid
==1)

37 if(
$tid
==2)

41 if(
$tid
==3)

49 
	}
}

50 
funi
 
	$GFeSize
(
$fs
)

52 
$fs
 = $fs/1024;

53  
	`rtf
("%10.1f",
$fs
)." K";

54 
	}
}

55 
funi
 
	$GImageVw
(
$fu
,
$mty
)

57 if(
$mty
==1)

61 
	}
}

	@member/visit-history.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/config.php");

3 
CheckRk
(0,0);

4 if(!
	$ist
(
$do
))

6 
$do
 = '';

7 
	}
}

8 
que_
(
DEDEINC
."/datalistcp.class.php");

9 
	g$wsql
 = '';

10 if(
	g$do
=='meview')

12 
$wsql
 = " vid='{$cfg_ml->M_ID}' ";

13 
	g$ame
 = "我最近访问";

17 
	g$wsql
 = " mid='{$cfg_ml->M_ID}' ";

18 
	g$ame
 = "关注我的人";

20 
	g$quy
 = "Select * From `#@__member_vhistory` where $wsql order by vtime desc";

21 
	g$dli
 = 
w
 
DaLiCP
();

22 
	g$dli
->
	ggeSize
 = 20;

23 
	g$dli
->
SPam
("do",
$do
);

24 
	g$dli
->
STeme
(
DEDEMEMBER
.'/templets/visit-history.htm');

25 
	g$dli
->
SSour
(
$quy
);

26 
	g$dli
->
Diy
();

	@plus/ad_js.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

4 if(
ist
(
$cID
)
	g$aid
 = $arcID;

5 
	g$cID
 = 
$aid
 = (
ist
($aid&& 
is_numic
($aid)) ? $aid : 0;

6 if(
	g$aid
==0
d
(' Request Error! ');

8 
	g$cheFe
 = 
DEDEDATA
.'/che/myad-'.
$aid
.'.htm';

9 if
ist
(
$noche
|| !
fe_exis
(
$cheFe
|| 
time
(- 
femtime
($cheFe> 
	g$cfg_pucche_time
 )

11 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__myad` whereid='$aid' ");

12 
	g$adbody
 = '';

13 if(
	g$row
['timeset']==0)

15 
$adbody
 = 
$row
['normbody'];

19 
	g$ime
 = 
time
();

20 if(
	g$ime
>
	g$row
['endtime'] || $ntime < $row['starttime']) {

21 
	g$adbody
 = 
$row
['expbody'];

24 
	g$adbody
 = 
$row
['normbody'];

27 
	g$adbody
 = 
r_a
('"', '\"',
$adbody
);

28 
	g$adbody
 = 
r_a
("\r", "\\r",
$adbody
);

29 
	g$adbody
 = 
r_a
("\n", "\\n",
$adbody
);

30 
	g$adbody
 = "<!--\r\ndocument.write(\"{$adbody}\");\r\n-->\r\n";

31 
	g$
 = 
fݒ
(
$cheFe
, 'w');

32 
fwre
(
$
, 
$adbody
);

33 
fo
(
$
);

35 
ude
 
	g$cheFe
;

	@plus/advancedsearch.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que_
(
DEDEINC
."/datalistcp.class.php");

4 
	g$timeamp
 = 
time
();

7 
	g$timock
 = '../data/time.lock';

8 if(
	g$cfg_lch_lim
 < 1)

10 
	g$cfg_lch_lim
 = 1;

12 if(
	$fe_exis
(
$timock
))

14 if(
$timeamp
 - 
	`femtime
(
$timock
< 
$cfg_lch_lim
)

16 
	`showmsg
('服务器忙，请稍后搜索','-1');

17 
	`ex
();

19 
	}
}

20 @
touch
(
$timock
,
$timeamp
);

21 
	g$mid
 = 
ist
(
$mid
&& 
is_numic
($mid) ? $mid : 0;

22 if(
	g$mid
 == 0)

24 
showmsg
('参数不正确，高级自定义搜索必须指定模型id', 'javascript');

25 
ex
();

27 
	g$quy
 = "select maintable, mainfields,ddontable,ddonfields,emplate from #@__advancedsearch where mid='$mid'";

28 
	g$chfo
 = 
$dsql
->
GO
(
$quy
);

29 if(!
	$is_y
(
$chfo
))

31 
	`showmsg
('自定义搜索模型不存在','-1');

32 
	`ex
();

33 
	}
}

34 
	g$me
 = 
$chfo
['template'] != '' ? $searchinfo['template'] : 'advancedsearch.htm';

35 if(
	$emy
(
$sql
))

38 
$q
 = 
	`rashes
($q);

39 
$q
 = 
	`eg_a
("[\|\"\r\n\t%\*\?\(\)\$;,'%<>]"," ",
	`im
($q));

40 if(
$cfg_nٮlowr
!='' && 
	`egi
($cfg_nٮlowr,
$q
)|| (
$cfg_ar
!='' &&regi($cfg_replacestr,$q)) )

42 
echo
 "你的信息中存在非法内容，被系统禁止！<hf='javast:hiy.go(-1)'>[返回]</a>"; 
	`ex
();

44 
$q
 = 
	`addashes
($q);

45 
$iscommd
 = 
	`ist
($iscommd&& 
	`is_numic
($iscommend) ? $iscommend : 0;

46 
$tyid
 = 
	`ist
($tyid&& 
	`is_numic
($typeid) ? $typeid : 0;

47 
$tyid
 = 
	`max
($typeid, 0);

48 
$udess
 = 
	`ist
($includesons) ? 1 : 0;

49 
$wr
 = 
	`ist
($wr? 
	`im
($writer) : '';

50 
$sour
 = 
	`ist
($sour? 
	`im
($source) : '';

51 
$tde
 = 
	`ist
($tde? 
	`im
($startdate) : '';

52 
$dde
 = 
	`ist
($dde? 
	`im
($enddate) : '';

53 if(
$tde
 != '')

55 
$ime
 = 
	`ime
(
$tde
);

59 
$ime
 = 0;

61 if(
$dde
 != '')

63 
$dtime
 = 
	`ime
(
$dde
);

67 
$dtime
 = 0;

69 
$whe
 = ' where main.arcrank>-1 ';

71 if(
$q
 != '')

73 
$whe
 .= "nd main.titleike '%$q%' ";

75 if(
$iscommd
 == 1)

77 
$whe
 .= "nd FIND_IN_SET('c', main.flag)>0 ";

79 if(!
	`emy
(
$tyid
))

81 if(
$udess
 == 1)

83 
$tids
 = 
	`TyGSunID
(
$tyid
,
$dsql
,'',
$mid
,
ue
);

84 
$whe
 .= "nd main.typeid in ($tids) ";

88 
$whe
 .= "nd main.typeid=$typeid ";

93 
$whe
 .= "nd main.channel=$mid ";

95 if(
$wr
 != '')

97 
$wr
 = 
	`rashes
($writer);

98 
$wr
 = 
	`eg_a
("[\|\"\r\n\t%\*\?\(\)\$;,'%<>]","",
	`im
($writer));

99 
$wr
 = 
	`addashes
($writer);

100 
$whe
 .= "nd main.writer='$writer' ";

102 if(
$sour
 != '')

104 
$sour
 = 
	`rashes
($source);

105 
$sour
 = 
	`eg_a
("[\|\"\r\n\t%\*\?\(\)\$;,'%<>]","",
	`im
($source));

106 
$sour
 = 
	`addashes
($source);

107 
$whe
 .= "nd main.source='$source' ";

109 if(
$ime
 > 0)

111 
$whe
 .= "nd main.senddate>$starttime ";

113 if(
$dtime
 > 0){

114 
$whe
 .= "nd main.senddate<$endtime";

116 
$mab
 = 
$chfo
['maintable'];

117 
$addڏb
 = 
$chfo
['addontable'];

118 
$maflds
 = 
$chfo
['mainfields'];

119 
$addflds
 = 
$chfo
['addonfields'];

120 
$mafld
 = 
	`exode
(',', 
$maflds
);

121 
$addfld
 = 
	`exode
(',', 
$addflds
);

122 
	`y_p
(
$addfld
);

124 
$
 = 
	`y
('int','float');

125 
$x
 = 
	`y
('textdata','textchar','text','htmltext','multitext');

126 
	`fܗch
(
$addfld
 
as
 
$addfld
)

128 
$addfldr
 = 
	`exode
(':', 
$addfld
);

129 
$v
 = 
$addfldr
[0];

130 
$ty
 = 
$addfldr
[1];

131 if(
	`_y
(
$ty
, 
$
))

133 if(
	`ist
(
$
{'t'.
$v
}&& 
	`im
(${'start'.$var})!='')

135 
$
{'t'.
$v
} = 
	`im
(${'start'.$var});

136 
$
{'t'.
$v
} = 
	`tv
(${'start'.$var});

137 
$whe
 .= "ndddon.$var>${'start'.$var} ";

139 if(
	`ist
(
$
{'d'.
$v
}&& 
	`im
(${'end'.$var})!='')

141 
$
{'d'.
$v
} = 
	`im
(${'end'.$var});

142 
$
{'d'.
$v
} = 
	`tv
(${'end'.$var});

143 
$whe
 .= "ndddon.$var<${'end'.$var} ";

146 
	`if
(
	`_y
(
$ty
, 
$x
))

148 if(
	`ist
(
$
{
$v
}&& 
	`im
(${$var})!='')

150 
$
{
$v
} = 
	`rashes
(${$var});

151 
$
{
$v
} = 
	`eg_a
("[\|\"\r\n\t%\*\?\(\)\$;,'%<>]","",
	`im
(${$var}));

152 
$
{
$v
} = 
	`addashes
(${$var});

153 
$whe
 .= "ndddon.$varike '%${$var}%'";

156 
	`if
(
$ty
 == 'select')

158 
$
{
$v
} = 
	`rashes
(${$var});

159 
$
{
$v
} = 
	`eg_a
("[\|\"\r\n\t%\*\?\(\)\$;,'%<>]","",
	`im
(${$var}));

160 
$
{
$v
} = 
	`addashes
(${$var});

161 if(
$
{
$v
} != '')

163 
$whe
 .= "ndddon.$varike '${$var}'";

166 
	`if
(
$ty
 == 'radio')

168 
$
{
$v
} = 
	`rashes
(${$var});

169 
$
{
$v
} = 
	`eg_a
("[\|\"\r\n\t%\*\?\(\)\$;,'%<>]","",
	`im
(${$var}));

170 
$
{
$v
} = 
	`addashes
(${$var});

171 if(
$
{
$v
} != '')

173 
$whe
 .= "ndddon.$varike '${$var}'";

176 
	`if
(
$ty
 == 'checkbox')

178 if(
	`is_y
(
$
{
$v
}&& !
	`emy
(${$var}))

180 
	`fܗch
(
$
{
$v
} 
as
 
$tmpv
)

182 
$tmpv
 = 
	`im
($tmpvar);

183 if(
$tmpv
 != '')

185 
$tmpv
 = 
	`rashes
($tmpvar);

186 
$tmpv
 = 
	`eg_a
("[\|\"\r\n\t%\*\?\(\)\$;,'%<>]","",
	`im
($tmpvar));

187 
$tmpv
 = 
	`addashes
($tmpvar);

188 
$whe
 .= "nd CONCAT(',',addon.$var, ',')ike '%,$tmpvar,%' ";

193 
	`if
(
$ty
 == 'datetime')

195 
$
{'t'.
$v
} = 
	`im
(${'start'.$var});

196 if(
$
{'t'.
$v
} != '')

198 
$
{'t'.
$v
} = 
	`ime
(${'start'.$var});

202 
$
{'t'.
$v
} = 0;

204 
$
{'d'.
$v
} = 
	`im
(${'end'.$var});

205 if(
$
{'d'.
$v
} != '')

207 
$
{'d'.
$v
} = 
	`ime
(${'end'.$var});

211 
$
{'d'.
$v
} = 0;

215 
$dby
 = ' order by main.senddate desc ';

216 if(
$mid
 < -1)

218 
$whe
 = 
	`r_a
('main.', 'addon.', $where);

219 
$dby
 = 
	`r_a
('main.', 'addon.', $orderby);

220 
$quy
 = "selectddon.*,rctype.* from $addontableddon 

221 

 
jo
 #@
__y
 
y
 

ry.
id
=
add
.
tyid


222 
$whe
 
$dby
";

224 
$quy
 = "select main.idsid,main.*,main.descriptions description1,ype.* 

225 
om
 
$mab
 
ma


226 

 
jo
 #@
__y
 
ty
 

y.
id
=
ma
.
tyid


227 

 
jo
 
$addڏb
 
add
 

dd.
aid
=
ma
.
id


228 
$whe
 
$dby
";

230 
$sql
 = 
$quy
;

231 
	}
}

234 
	g$sql
 = 
udecode
(
$sql
);

235 
	g$quy
 = 
$sql
;

238 
	g$sql
 = 
ucode
(
$sql
);

239 
	g$dli
 = 
w
 
DaLiCP
();

240 
	g$dli
->
	ggeSize
 = 20;

241 
	g$dli
->
SPam
("sql", 
$sql
);

242 
	g$dli
->
SPam
("mid", 
$mid
);

243 if(
fe_exis
(
DEDEROOT
."/templets/default/$template"))

245 
	g$mefe
 = 
DEDEROOT
."/templets/default/$template";

249 
	g$mefe
 = 
DEDEROOT
."/templets/default/advancedsearch.htm";

251 
	g$dli
->
STeme
(
$mefe
);

252 
	g$dli
->
SSour
(
$quy
);

253 
que_
(
DEDEINC
."/channelunit.class.php");

256 
funi
 
GArcU
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
=0,
$nk
=0,
$mu
='',
$td
='',
$mey
=0)

258  
GFeU
(
$aid
,
$tyid
,
$timag
,
$t
,
$ismake
,
$nk
,
$mu
,
$td
,
$mey
);

260 
	g$dli
->
Diy
();

	@plus/car.php

1 <?
php


3 
que_
 (
dme
(
__FILE__
) . "/../include/common.inc.php");

4 
defe
('_PLUS_TPL_', 
DEDEROOT
.'/templets/plus');

5 
que_
(
DEDEINC
.'/dedetemplate.class.php');

6 
que_
 
	gDEDEINC
.'/shopcar.class.php';

7 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

8 
	g$
 = 
w
 
MembShs
();

10 if(
ist
(
$do
&& 
	g$do
=='makeid')

12 
AjaxHd
();

13 
	g$
->
MakeOrds
();

14 
echo
 
	g$
->
	gOrdsId
;

15 
	gex
;

17 
	g$cfg_ml
 = 
w
 
MembLog
();

19 
	g$Ims
 = 
$
->
gIms
();

20 if(
	g$
->
Cou
() < 1)

22 
ShowMsg
("购物车中不存在任何商品！", "javast:wdow.o();", 
l
, 5000);

23 
	gex
;

25 @
st
(
$Ims
);

27 
	g$s
 = 
y
(

28 'ds_id' => 
$
->
OrdsId
,

29 '_cou' => 
$
->
Cou
(),

30 'i_cou' => 
$
->
iCou
()

33 
	g$d
 = 
w
 
DedeTeme
();

34 
	g$d
->
Assign
('s',
$s
);

35 
	g$d
->
LdTeme
(
_PLUS_TPL_
.'/car.htm');

36 
	g$d
->
Diy
();

37 
	gex
;

	@plus/carbuyaction.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/../include/common.inc.php");

3 
defe
('_PLUS_TPL_', 
DEDEROOT
.'/templets/plus');

4 
que_
 
	gDEDEINC
.'/dedetemplate.class.php';

5 
que_
 
	gDEDEINC
.'/shopcar.class.php';

6 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

7 
que_
 
	gDEDEROOT
.'/data/sys_pay.cache.php';

9 if(
	g$cfg_mb_ݒ
=='N')

11 
ShowMsg
("系统关闭了会员功能，因此你无法访问此页面！","javascript:;");

12 
ex
();

14 
	g$ymt
 = 'none';

15 if(
ist
(
$pd_code
&& ist(
$pd_vify
&& 
md5
("ymt".$pd_code.
$cfg_cook_code
) == $pd_verify)

17 
r_r
(
mchSCode
(
$pd_code
,'DECODE'),
$mch_Po
);

18 
	g$ymt
 = 'ready';

19 
fܗch
(
$mch_Po
 
as
 
$k
 => 
$v

$$k
 = $v;

22 
	g$_code
 = '';

23 
fܗch
(
$_REQUEST
 
as
 
$key
 => 
$v
)

25 
$_code
 .= $pr_encode ? "&$key=$val" : "$key=$val";

27 
	g$_code
 = 
r_a
('=', '', 
mchSCode
(
$_code
));

28 
	g$_vify
 = 
md5
("ymt".
$_code
.
$cfg_cook_code
);

30 
	g$cfg_ml
 = 
w
 
MembLog
();

31 
	g$
 = 
w
 
MembShs
();

34 
	g$Ims
 = 
$
->
gIms
();

35 if(
	$emy
(
$Ims
))

37 
	`ShowMsg
("抱歉,请不要重复提交!","javascript:;");

38 
	`ex
();

39 
	}
}

41 
	g$OrdsId
 = 
$
->
OrdsId
;

42 
	g$CtCou
 = 
$
->
Cou
();

43 
	g$iCou
 = 
$
->
iCou
();

48 if(!
ist
(
$do
|| 
	$emy
(
$do
))

50 
$shs_divyr
 = 
	`y
();

51 
$dsql
->
	`SQuy
("SELECTid,dname,price,des FROM #@__shops_delivery ORDER BY orders ASC");

52 
$dsql
->
	`Execu
();

53 
$row
 = 
$dsql
->
	`GAay
())

55 
$shs_divyr
[] = 
$row
;

58 
$shs_ytyr
 = 
	`y
();

59 
$dsql
->
	`SQuy
("SELECTid,paytype FROM #@__shops_paytype ORDER BYid ASC");

60 
$dsql
->
	`Execu
();

61 
$i
 = 0 ;

62 
$row
 = 
$dsql
->
	`GAay
())

64 
$row
['checked'] = !
$i
 ? ' checked="checked"' : '';

65 
$row
['dibd'] = ($row['pid'] =5&& (
$cfg_ml
->
M_Mey
 < 
$iCou
) ? ' disabled="disabled"' : '';

66 
$shs_ytyr
[] = 
$row
;

67 
$i
++;

69 
	`unt
(
$row
);

71 
$d
 = 
w
 
	`DedeTeme
();

73 
$s
 = 
	`y
(

74 'ds_id' => 
$
->
OrdsId
,

75 '_cou' => 
$
->
	`Cou
(),

76 'i_cou' => 
$
->
	`iCou
()

78 
$d
->
	`Assign
('s',
$s
);

80 
$d
->
	`LdTeme
(
_PLUS_TPL_
.'/carbuyaction.htm');

81 
$d
->
	`Diy
();

82 
	`ex
();

83 
	}
}

84 
if
(
$do
 == 'clickout')

86 
$svi
 = 
GCkVdVue
();

87 if(
ow
((
$vdcode
)!=
$svi
 || $svi==""&& 
$ymt
 == 'none')

89 
ShowMsg
("验证码错误！","-1");

90 
ex
();

92 if(
emy
(
$addss
))

94 
ShowMsg
("请填写收货地址！","-1");

95 
ex
();

97 if(
emy
(
$pome
))

99 
ShowMsg
("请填写收货人姓名！","-1");

100 
ex
();

102 
	g$yty
 = 
ist
(
$yty
&& 
is_numic
($paytype) ? $paytype : 0;

103 
	g$pid
 = 
ist
(
$pid
&& 
is_numic
($pid) ? $pid : 0;

104 if(
	g$yty
 < 1)

106 
ShowMsg
("请选择支付方式！","-1");

107 
ex
();

109 if(
	g$pid
 < 1)

111 
ShowMsg
("请选择配送方式！","-1");

112 
ex
();

114 
	g$addss
 = 
_subrR
(
im
(
$addss
),200);

115 
	g$des
 = 
_subrR
(
$des
,100);

116 
	g$pome
 = 
_subrR
(
im
(
$pome
),15);

117 
	g$l
 = 
eg_a
("[^-0-9,\/\| ]","",
$l
);

118 
	g$z
 = 
eg_a
("[^0-9]","",
$z
);

119 
	g$ema
 = 
_subrR
(
$ema
,255);

120 if(
emy
(
$l
))

122 
ShowMsg
("请填写正确的收货人联系电话！","-1");

123 
ex
();

125 if(
	g$z
<1 || $zip>999999)

127 
ShowMsg
("请填写正确的收货人邮政编码！","-1");

128 
ex
();

132 if(
	g$cfg_ml
->
IsLog
())

134 
	g$urid
 = 
$cfg_ml
->
M_ID
;

138 
	g$uame
 = 
im
(
$uame
);

139 
	g$sswd
 = 
im
(
$sswd
);

141 if(
emy
(
$uame
|| 
	g$sswd
)

143 
ShowMsg
("请选登录！","-1",0,2000);

144 
ex
();

147 
	g$rs
 = 
$cfg_ml
->
CheckUr
(
$uame
,
$sswd
);

148 if(
	g$rs
==0)

150 
ShowMsg
("用户名不存在！","-1",0,2000);

151 
ex
();

153 if(
	g$rs
==-1)

155 
ShowMsg
("密码错误！","-1",0,2000);

156 
ex
();

158 
	g$urid
 = 
$cfg_ml
->
M_ID
;

162 
	g$rs
 = 
$dsql
->
GO
("SELECT `price` FROM #@__shops_delivery WHEREid='$pid' LIMIT 0,1");

163 
	g$di
 = 
$rs
['price'] > 0 ? $rs['price'] : 0;

164 
unt
(
$rs
);

166 
	g$
 = 
GIP
();

167 
	g$ime
 = 
time
();

169 
	g$ϡiCou
 = 
rtf
("%01.2f", 
$iCou
+
$di
);

171 
	g$rows
 = 
$dsql
->
GO
("SELECT `oid` FROM #@__shops_orders WHERE oid='$OrdersId' LIMIT 0,1");

172 if(
emy
(
$rows
['oid']))

174 
	g$sql
 = "INSERT INTO `#@__shops_orders` (`oid`,`userid`,`cartcount`,`price`,`state`,`ip`,`stime`,`pid`,`paytype`,`dprice`,`priceCount`)

175 
VALUES
 ('$OrdersId','$userid','$CartCount','$priceCount','0','$ip','$stime','$pid','$paytype','$dprice','$lastpriceCount');";

178 if(
	g$dsql
->
ExecuNeQuy
(
$sql
))

180 
fܗch
(
$Ims
 
as
 
$key
=>
$v
)

182 
$v
['i'] = 
r_a
(",","",$val['price']);

183 
	g$dsql
->
ExecuNeQuy
("INSERT INTO `#@__shops_products` (`aid`,`oid`,`userid`,`title`,`price`,`buynum`)

184 
VALUES
 ('$val[id]','$OrdersId','$userid','$val[title]','$val[price]','$val[buynum]');");

186 
$sql
 = "INSERT INTO `#@__shops_userinfo` (`userid`,`oid`,`consignee`,`address`,`zip`,`tel`,`email`,`des`)

187 
VALUES
 ('$userid','$OrdersId','$postname','$address','$zip','$tel','$email','$des');

189 
$dsql
->
ExecuNeQuy
(
$sql
);

193 
ShowMsg
("更新订单时出现错误！".
$dsql
->
GE
(),"-1");

194 
ex
();

199 
$sql
 = "UPDATE `#@__shops_orders`

200 
SET
 `
cou
`='$CtCou',`
i
`='$iCou',`

`='$',`
ime
`='$ime',
pid
='$pid',
yty
='$yty',
di
='$di',
iCou
='$lastpriceCount'

201 
WHERE
 
oid
='$OrdsId' 
AND
 
urid
='$userid' ;";

202 if(
$dsql
->
ExecuNeQuy
(
$sql
))

204 
$sql
 = "UPDATE `#@__shops_userinfo`

205 
SET
 `
csige
`='$pome',`
addss
`='$addss',`
z
`='$z',`
l
`='$l',`
ema
`='$ema',`
des
`='$des'

206 
WHERE
 
oid
='$OrdersId';";

207 
$dsql
->
ExecuNeQuy
(
$sql
);

211 
echo
 
$dsql
->
GE
();

212 
ex
;

214 
unt
(
$sql
);

217 
$iCou
 = 
rtf
("%01.2f", 
$ϡiCou
);

219 
$couOrds
 = 
$dsql
->
GO
("SELECT SUM(couASumFROM #@__shs_dWHERE urid='".
$cfg_ml
->
M_ID
."'");

220 
$dsql
->
ExecuNeQuy
("UPDATE #@__memb_tj SET `sh`='".
$couOrds
['nums']."' WHERE mid='".
$cfg_ml
->
M_ID
."'");

222 
$rs
 = 
$dsql
->
GO
("SELECT `paytype`,`des` FROM `#@__shops_paytype` WHEREid='$paytype' ");

223 if(
$yty
 == 1)

229 if(!
ist
(
$le_ymt
))

231 
$ymt_li
 = 
y
();

232 
fܗch
(
$ymt_
 
as
 
$k
 => 
$v
)

234 
$mp_r
['me'] = 
$cfg_y_fo
['me'][
$k
];

235 
$mp_r
['logo'] = 
$cfg_cmh
.'/memb/images/y/'.
$cfg_y_fo
['logo'][
$k
];

236 
$mp_r
['des'] = 
$cfg_y_fo
['des'][
$k
];

237 
$mp_r
['vue'] = 
$v
;

238 
$mp_r
['exp'] = 
rtf
("%01.2f", 
$iCou
*
$ymt_exp
[
$k
]);

239 
$ymt_li
[] = 
$mp_r
;

241 
$d
 = 
w
 
DedeTeme
();

243 
$s
 = 
y
(

244 'ds_id' => 
$
->
OrdsId
,

245 '_cou' => 
$
->
CtCou
(),

246 'i_cou' => 
$iCou


249 
$d
->
Assign
('s',
$s
);

251 
$d
->
LdTeme
(
_PLUS_TPL_
.'/shops_action_payment.htm');

252 
$d
->
Diy
();

253 
ex
();

255 if(!
_y
(
$le_ymt
,
$ymt_
))

257 
ShowMsg
("支付接口无效,或没开启！", 'javascript:;');

258 
ex
();

261 
$
->
rIm
();

262 
$
->
MakeOrds
();

263 
que_
 
DEDEROOT
.'/us/y/'.
$le_ymt
.'/config_pay_'.$online_payment.'.php';

265 
ex
();

267 
if
(
$yty
 == 2)

274 
$
->
rIm
();

275 
$
->
MakeOrds
();

276 
ShowMsg
("下单成功,等待商家发货！","../memb/shs_odus.php?oid=".
$OrdsId
);

277 
ex
();

279 
if
(
$yty
 == 3)

286 
$
->
rIm
();

287 
$
->
MakeOrds
();

288 
$d
 = 
w
 
DedeTeme
();

289 
$d
->
Assign
('bks',
$rs
);

290 
$d
->
LdTeme
(
_PLUS_TPL_
.'/shops_bank.htm');

291 
$d
->
Diy
();

292 
ex
();

294 
if
(
$yty
 == 4)

301 
$
->
rIm
();

302 
$
->
MakeOrds
();

303 
$d
 = 
w
 
DedeTeme
();

304 
$d
->
Assign
('bks',
$rs
);

305 
$d
->
LdTeme
(
_PLUS_TPL_
.'/shops_bank.htm');

306 
$d
->
Diy
();

307 
ex
();

309 
if
(
$yty
 == 5)

315 
$membs
 = 
$dsql
->
GO
("SELECT `mey` FROM #@__memb WHERE mid='".
$cfg_ml
->
M_ID
."'");

316 if(
$membs
['mey'] < 
$iCou
)

318 
ShowMsg
("支付失败点数不够！","-1");

319 
ex
();

321 if(
$dsql
->
ExecuNeQuy
("UPDATE `#@__shs_ds` SET `e`='1' WHERE `oid`='$OrdsId' AND `urid`='".
$cfg_ml
->
M_ID
."' AND `state`<1"))

324 
$
->
rIm
();

325 
$
->
MakeOrds
();

326 
$s
 = 
$dsql
->
ExecuNeQuy
("UPDATE #@__memb SET mey=mey-$iCou WHERE mid='".
$cfg_ml
->
M_ID
."'");

327 
ShowMsg
("下单,支付成功,等待商家发货！","../memb/shs_odus.php?oid=".
$OrdsId
);

328 
ex
();

332 
ShowMsg
("支付失败,请联系管理员！","-1");

333 
ex
();

336 
ex
();

	@plus/comments_frame.php

1 <?
php


9 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

10 
que_
(
DEDEINC
."/datalistcp.class.php");

12 
	g$ai
 = 
ist
(
$ai
? 
	$im
(
$ai
) : '';

13 
$id
 = (
	`ist
($id&& 
	`is_numic
($id)) ? $id : 0;

15 if(
$id
 < 1)

17 
	`ex
();

18 
	}
}

20 
	g$seu
 = '';

21 
	g$sql
 ="selectrctype.siteurl from #@__archivesrceft join #@__arctyperctype onrctype.id=arc.typeid whererc.id=$id";

22 
	g$row
 = 
$dsql
->
GO
(
$sql
);

23 if(
	$is_y
(
$row
))

25 
$seu
 = 
$row
['siteurl'];

26 
	}
}

28 
	g$sql
 = "SELECT fb.*,mb.userid,mb.faces mface,mb.spacesta,mb.scores

29 
FROM
 `#@
__edback
` 
fb


30 
LEFT
 
JOIN
 `#@
__memb
` 
mb
 
ON
 mb.
mid
 = 
fb
.mid

31 
WHERE
 
fb
.
aid
=
$id
 
d
 fb.
ischeck
='1'

32 
ORDER
 
BY
 
fb
.
id
 
DESC
";

34 
$dli
 = 
w
 
DaLiCP
();

35 
	g$dli
->
	ggeSize
 = 6;

36 
	g$dli
->
SPam
('id', 
$id
);

37 
	g$dli
->
STem
(
DEDETEMPLATE
.'/plus/comments_frame.htm');

38 
	g$dli
->
SSour
(
$sql
);

39 
	g$dli
->
diy
();

	@plus/count.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 if(
	$ist
(
$cID
))

5 
$aid
 = 
$cID
;

6 
	}
}

7 
	g$cID
 = 
$aid
 = (
ist
($aid&& 
is_numic
($aid)) ? $aid : 0;

8 if(
	g$aid
==0)

10 
ex
();

12 
	g$mid
 = (
ist
(
$mid
&& 
is_numic
($mid)) ? $mid : 0;

15 
	g$dsql
->
ExecuNeQuy
(" Update `#@__archives` set click=click+1 where id='$aid' ");

16 if(!
	$emy
(
$mid
))

18 
$dsql
->
	`ExecuNeQuy
(" Update `#@__member_tj` setagecount=pagecount+1 where mid='$mid' ");

19 
	}
}

20 if(!
	$emy
(
$vw
))

22 
$row
 = 
$dsql
->
	`GO
(" Select click From `#@__archives` where id='$aid' ");

23 if(
	`is_y
(
$row
))

25 
echo
 "documt.wre('".
$row
['click']."');\r\n";

27 
	}
}

28 
ex
();

	@plus/digg_ajax.php

1 <?
php


7 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

9 
	g$ai
 = 
ist
(
$ai
? 
	$im
(
$ai
) : '';

10 
$id
 = (
	`ist
($id&& 
	`is_numic
($id)) ? $id : 0;

11 if(
$id
 < 1)

13 
	`ex
();

14 
	}
}

15 
	g$mab
 = '#@__archives';

16 if(
	g$ai
 == 'good')

18 
$dsql
->
ExecuNeQuy
("Upd`$mab` s scesce+ {$cfg_ii_add},goodpo=goodpo+1,ϡpo=".
time
()." where id=$id");

20 if(
	g$ai
=='bad')

22 
$dsql
->
ExecuNeQuy
("Upd`$mab` s scesce- {$cfg_ii_sub},badpo=badpo+1,ϡpo=".
time
()." where id=$id");

24 
	g$digg
 = '';

25 
	g$row
 = 
$dsql
->
GO
("Select goodpost,badpost,scores From `$maintable` where id=$id ");

26 if(!
	$is_y
(
$row
))

28 
	`ex
();

29 
	}
}

30 if(
	g$row
['goodpost']+$row['badpost'] == 0)

32 
$row
['goodper'] = $row['badper'] = 0;

36 
	g$row
['goodr'] = 
numb_fm
(
$row
['goodpost']/($row['goodpost']+$row['badpost']),3)*100;

37 
	g$row
['badr'] = 100-
$row
['goodper'];

40 if(
emy
(
$fmu
)
	g$fmu
 = '';

41 if(
	g$fmu
=='caicai')

43 if(
$ai
 ='good'
$digg
 = 
$row
['goodpost'];

44 if(
	g$ai
 ='bad'
$digg
 = 
$row
['badpost'];

48 
	g$row
['goodr'] = 
im
(
rtf
("%4.2f", 
$row
['goodper']));

49 
	g$row
['badr'] = 
im
(
rtf
("%4.2f", 
$row
['badper']));

50 
	g$digg
 = '<div css="diggbox digg_good" onmoumove="this.y.backgroundPosi=\' btom\';" onmouout="this.y.backgroundPosi=\'\';" onick="poDigg(\'good\','.
$id
.')">

51 <
div
 
ass
="digg_act">顶一下</div>

52 <
div
 
ass
="digg_num">('.$row['
goodpo
'].')</div>

53 <
div
 
ass
="digg_percent">

54 <
div
 
ass
="digg_r_b"><

 
y
="width:'.$row['goodper'].'%"></span></div>

55 <
div
 
ass
="digg_r_num">'.$row['
goodr
'].'%</div>

56 </
div
>

57 </
div
>

58 <
div
 
ass
="diggbox digg_bad" 
moumove
="this.y.backgroundPosi=\'righbtom\';" 
mouout
="this.y.backgroundPosi=\'right\';" 
ick
="postDigg(\'bad\','.$id.')">

59 <
div
 
ass
="digg_act">踩一下</div>

60 <
div
 
ass
="digg_num">('.$row['
badpo
'].')</div>

61 <
div
 
ass
="digg_percent">

62 <
div
 
ass
="digg_r_b"><

 
y
="width:'.$row['badper'].'%"></span></div>

63 <
div
 
ass
="digg_r_num">'.$row['
badr
'].'%</div>

64 </
div
>

65 </
div
>';

67 
AjaxHd
();

68 
echo
 
	g$digg
;

69 
ex
();

	@plus/digg_frame.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

4 
	g$ai
 = 
ist
(
$ai
? 
	$im
(
$ai
) : '';

5 
$id
 = (
	`ist
($id&& 
	`is_numic
($id)) ? $id : 0;

6 
$mab
 = '#@__archives';

7 if(
$ai
 == 'good')

9 
$dsql
->
	`ExecuNeQuy
("Upd`$mab` s scesce+ {$cfg_ii_add},goodpo=goodpo+1,ϡpo=".
	`time
()." where id=$id");

10 
	}
}

11 if(
	g$ai
=='bad')

13 
$dsql
->
ExecuNeQuy
("Upd`$mab` s scesce- {$cfg_ii_sub},badpo=badpo+1,ϡpo=".
time
()." where id=$id");

15 
	g$digg
 = '';

16 
	g$row
 = 
$dsql
->
GO
("Select goodpost,badpost,scores From `$maintable` where id=$id ");

17 if(
	g$row
['goodpost']+$row['badpost'] == 0)

19 
$row
['goodper'] = $row['badper'] = 0;

23 
	g$row
['goodr'] = 
numb_fm
(
$row
['goodpost']/($row['goodpost']+$row['badpost']),3)*100;

24 
	g$row
['badr'] = 100-
$row
['goodper'];

26 
	g$digg
 = '<div css="diggbox digg_good" onmoumove="this.y.backgroundPosi=\' btom\';" onmouout="this.y.backgroundPosi=\'\';" onick="poDigg(\'good\','.
$id
.')">

27 <
div
 
ass
="digg_act">顶一下</div>

28 <
div
 
ass
="digg_num">('.$row['
goodpo
'].')</div>

29 <
div
 
ass
="digg_percent">

30 <
div
 
ass
="digg_r_b"><

 
y
="width:'.$row['goodper'].'%"></span></div>

31 <
div
 
ass
="digg_r_num">'.$row['
goodr
'].'%</div>

32 </
div
>

33 </
div
>

34 <
div
 
ass
="diggbox digg_bad" 
moumove
="this.y.backgroundPosi=\'righbtom\';" 
mouout
="this.y.backgroundPosi=\'right\';" 
ick
="postDigg(\'bad\','.$id.')">

35 <
div
 
ass
="digg_act">踩一下</div>

36 <
div
 
ass
="digg_num">('.$row['
badpo
'].')</div>

37 <
div
 
ass
="digg_percent">

38 <
div
 
ass
="digg_r_b"><

 
y
="width:'.$row['badper'].'%"></span></div>

39 <
div
 
ass
="digg_r_num">'.$row['
badr
'].'%</div>

40 </
div
>

41 </
div
>';

42 
ude
 
DEDEROOT
.'/templets/plus/digg_frame.htm';

	@plus/disdls.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
	g$aid
 = (
ist
(
$aid
&& 
is_numic
($aid)) ? $aid : 0;

4 
	g$row
 = 
$dsql
->
GO
("Select sum(downloads)sotals From `#@__downloads` where id='$aid' ");

5 if(
emy
(
$row
['tٮs'])
	g$row
['totals'] = 0;

6 
	gecho
 "document.write('{$row['totals']}');";

7 
ex
();

	@plus/diy.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

4 
	g$diyid
 = 
ist
(
$diyid
&& 
is_numic
($diyid) ? $diyid : 0;

5 
	g$ai
 = 
ist
(
$ai
&& 
_y
($ai, 
y
('post', 'list', 'view')) ? $action : 'post';

6 
	g$id
 = 
ist
(
$id
&& 
is_numic
($id) ? $id : 0;

8 if(
	$emy
(
$diyid
))

10 
	`showMsg
('非法操作!', 'javascript:;');

11 
	`ex
();

12 
	}
}

14 
que_
 
	gDEDEINC
.'/diyform.cls.php';

16 
	g$diy
 = 
w
 
diyfm
(
$diyid
);

21 if(
	g$ai
 == 'post')

23 if(
emy
(
$do
))

25 
$pofm
 = 
$diy
->
gFm
(
ue
);

26 
ude
 
	gDEDEROOT
."/templets/plus/{$diy->postTemplate}";

27 
ex
();

29 
if
(
$do
 == 2)

31 
$dede_flds
 = 
emy
($dede_flds? '' : 
im
($dede_fields);

32 
	g$dede_fldshash
 = 
emy
(
$dede_fldshash
? '' : 
im
($dede_fieldshash);

33 if(!
emy
(
$dede_flds
))

35 if(
	g$dede_fldshash
 !
md5
(
$dede_flds
.
$cfg_cook_code
))

37 
showMsg
('数据校验不对，程序返回', '-1');

38 
ex
();

41 
	g$diyfm
 = 
$dsql
->
gO
("select * from #@__diyforms where diyid='$diyid' ");

42 if(!
is_y
(
$diyfm
))

44 
showmsg
('自定义表单不存在', '-1');

45 
ex
();

48 
	g$addv
 = 
$addvue
 = '';

50 if(!
emy
(
$dede_flds
))

53 
	g$fldr
 = 
exode
(';', 
$dede_flds
);

54 if(
is_y
(
$fldr
))

56 
fܗch
(
$fldr
 
as
 
$fld
)

58 if(
	g$fld
 == '') ;

59 
	g$fldfo
 = 
exode
(',', 
$fld
);

60 if(
	g$fldfo
[1] == 'textdata')

62 
$
{
$fldfo
[0]} = 
FrSrch
(
rashes
(${$fieldinfo[0]}));

63 
	g$
{
	g$fldfo
[0]} = 
addashes
(
$
{
$fldfo
[0]});

67 
	g$
{
	g$fldfo
[0]} = 
GFldVue
(
$
{
$fldfo
[0]}, $fieldinfo[1],0,'add','','diy', $fieldinfo[0]);

69 
	g$addv
 .', `'.
$fldfo
[0].'`';

70 
	g$addvue
 .", '".
$
{
$fldfo
[0]}."'";

76 
	g$quy
 = "insert into `{$diy->table}` (`id`, `ifcheck` $addvar) values (NULL, 0 $addvalue); ";

78 if(
	g$dsql
->
execunequy
(
$quy
))

80 
	g$id
 = 
$dsql
->
GLaID
();

81 if(
	g$diy
->
	gpublic
 == 2)

84 
$go
 = "diy.php?action=list&diyid={$diy->diyid}";

85 
	g$bkmsg
 = '发布成功，现在转向表单列表页...';

89 
	g$go
 = !
emy
(
$cfg_cmh
) ? $cfg_cmspath : '/';

90 
	g$bkmsg
 = '发布成功，请等待管理员处理...';

92 
showmsg
(
$bkmsg
, 
$go
);

99 
if
(
$ai
 == 'list')

101 if(
emy
(
$diy
->
public
))

103 
showMsg
('后台关闭前台浏览', 'javascript:;');

104 
ex
();

106 
ude_
 
	gDEDEINC
.'/datalistcp.class.php';

107 if(
	g$diy
->
	gpublic
 == 2)

109 
$quy
 = "select * from `{$diy->table}` order by id desc";

113 
	g$quy
 = "select * from `{$diy->table}` where ifcheck=1 order by id desc";

115 
	g$di
 = 
w
 
DaLiCP
();

116 
	g$di
->
	ggeSize
 = 10;

117 
	g$di
->
SPam
('action', 'list');

118 
	g$di
->
SPam
('diyid', 
$diyid
);

119 
	g$di
->
STeme
(
DEDEINC
."/../templets/plus/{$diy->listTemplate}");

120 
	g$di
->
SSour
(
$quy
);

121 
	g$fldli
 = 
$diy
->
gFldLi
();

122 
	g$di
->
Diy
();

124 
if
(
$ai
 == 'view')

126 if(
emy
(
$diy
->
public
))

128 
showMsg
('后台关闭前台浏览' , 'javascript:;');

129 
ex
();

132 if(
emy
(
$id
))

134 
showMsg
('非法操作！未指定id', 'javascript:;');

135 
ex
();

137 if(
	g$diy
->
	gpublic
 == 2)

139 
$quy
 = "select * from {$diy->table} where id='$id' ";

143 
	g$quy
 = "select * from {$diy->table} where id='$id'nd ifcheck=1";

145 
	g$row
 = 
$dsql
->
ge
(
$quy
);

147 if(!
is_y
(
$row
))

149 
showmsg
('你访问的记录不存在或未经审核', '-1');

150 
ex
();

153 
	g$fldli
 = 
$diy
->
gFldLi
();

154 
ude
 
	gDEDEROOT
."/templets/plus/{$diy->viewTemplate}";

	@plus/download.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que_
(
DEDEINC
."/channelunit.class.php");

4 if(!
ist
(
$ݒ
)
	g$ݒ
 = 0;

6 if(
	g$ݒ
==0)

8 
$aid
 = (
ist
($aid&& 
is_numic
($aid)) ? $aid : 0;

9 if(
	g$aid
==0
ex
(' Request Error! ');

11 
	g$cRow
 = 
GOArchive
(
$aid
);

12 if(
	g$cRow
['aid']=='')

14 
ShowMsg
('无法获取未知文档的信息!','-1');

15 
ex
();

17 
exa
(
$cRow
, 
EXTR_SKIP
);

19 
	g$cu
 = 
w
 
ChlUn
(
$cRow
['chl'],
$aid
);

20 if(!
is_y
(
$cu
->
ChlFlds
))

22 
ShowMsg
('获取文档信息失败！','-1');

23 
ex
();

26 
	g$vme
 = '';

27 
fܗch
(
$cu
->
ChlFlds
 
as
 
$k
=>
$v
)

29 if(
$v
['ty']=='solks'){ 
$vme
=
$k
; ; }

31 
	g$row
 = 
$dsql
->
GO
("Se $vmFrom `".
$cu
->
ChlInfos
['addtable']."` whereid='$aid'");

33 
ude_
(
DEDEINC
.'/taglib/channel/softlinks.lib.php');

34 
	g$ag
 = '';

35 
	g$dowƚks
 = 
ch_solks
(
$row
[
$vme
], 
$ag
, 
$cu
, '', 
ue
);

37 
que_
(
DEDETEMPLATE
.'/plus/download_links_templet.htm');

38 
ex
();

44 if(
	g$ݒ
==1)

47 
$id
 = 
ist
($id&& 
is_numic
($id) ? $id : 0;

48 
	g$lk
 = 
ba64_decode
(
udecode
(
$lk
));

49 
	g$hash
 = 
md5
(
$lk
);

50 
	g$rs
 = 
$dsql
->
ExecuNeQuy2
("Update `#@__downloads` set downloads = downloads+1 where hash='$hash' ");

51 if(
	g$rs
 <= 0)

53 
$quy
 = " Insert into `#@__downloads`(`hash`,`id`,`downloads`) values('$hash','$id',1); ";

54 
	g$dsql
->
ExecNeQuy
(
$quy
);

56 
hd
("location:$link");

57 
ex
();

63 if(
	g$ݒ
==2)

65 
$id
 = 
tv
($id);

67 
	g$row
 = 
$dsql
->
GO
("Select ch.addtable,arc.mid From `#@__arctiny`rceft join `#@__channeltype` ch on ch.id=arc.channel whererc.id='$id' ");

68 if(
emy
(
$row
['addtable']))

70 
ShowMsg
('找不到所需要的软件资源！', 'javascript:;');

71 
ex
();

73 
	g$mid
 = 
$row
['mid'];

76 
	g$row
 = 
$dsql
->
GO
("Select softlinks,daccess,needmoney From `{$row['addtable']}` whereid='$id' ");

77 if(
emy
(
$row
['softlinks']))

79 
ShowMsg
('找不到所需要的软件资源！', 'javascript:;');

80 
ex
();

82 
	g$socfig
 = 
$dsql
->
GO
("Select * From `#@__softconfig` ");

83 
	g$edRk
 = 
$socfig
['dfrank'];

84 
	g$edMey
 = 
$socfig
['dfywboy'];

85 if(
	g$socfig
['argrange']==0)

87 
$edRk
 = 
$row
['daccess'];

88 
	g$edMey
 = 
$row
['needmoney'];

92 
que_
(
DEDEINC
.'/dedetag.class.php');

93 
	g$soU
 = '';

94 
	g$iol
 = 0;

95 
	g$d
 = 
w
 
DedeTagP
();

96 
	g$d
->
LdSour
(
$row
['softlinks']);

97 if!
is_y
(
$d
->
CTags
) )

99 
	g$d
->
Cˬ
();

100 
ShowMsg
('找不到所需要的软件资源！', 'javascript:;');

101 
ex
();

103 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

105 if(
	g$ag
->
GName
()=='link')

107 
$lk
 = 
im
(
$ag
->
GIText
());

108 
	g$iol
 = 
$ag
->
GA
('islocal');

110 if(!
ist
(
$fLk
&& 
	g$iol
==1$fLk = 
$lk
;

111 if(
	g$iol
==1 && 
$socfig
['islocal'] != 1) ;

113 if(!
egi
('^hp://|^thund://|^p://|^ashg://', 
$lk
))

115 
	g$lk
 = 
$cfg_mase
.
$lk
;

117 
	g$dbhash
 = 
subr
(
md5
(
$lk
), 0, 24);

118 if(
	g$uhash
==
$dbhash

$soU
 = 
$lk
;

121 
	g$d
->
Cˬ
();

122 if(
	g$soU
=='' && 
$socfig
['ismoresite']==1

123 && 
$socfig
['mesedo']==1 && 
im
($socfig['ses'])!='' && 
ist
(
$fLk
))

125 
$fLk
 = 
egi_a
("http://([^/]*)/", '/', $firstLink);

126 
	g$socfig
['ses'] = 
eg_a
("[\r\n]{1,}", "\n", 
$socfig
['sites']);

127 
	g$ses
 = 
exode
("\n", 
im
(
$socfig
['sites']));

128 
fܗch
(
$ses
 
as
 
$se
)

130 if(
im
(
$se
)=='') ;

131 
li
(
$lk
, 
$rvName

exode
('|', 
$se
);

132 
	g$lk
 = 
im

eg_a
("/$", "", 
$lk
).
	g$fLk
;

133 
	g$dbhash
 = 
subr
(
md5
(
$lk
), 0, 24);

134 if(
	g$uhash
 =
$dbhash

$soU
 = 
$lk
;

137 if
	g$soU
 == '' )

139 
ShowMsg
('找不到所需要的软件资源！', 'javascript:;');

140 
ex
();

145 
	g$cRow
 = 
GOArchive
(
$id
);

146 if(
	g$cRow
['aid']=='')

148 
ShowMsg
('无法获取未知文档的信息!','-1');

149 
ex
();

151 
exa
(
$cRow
, 
EXTR_SKIP
);

154 if(
	g$edRk
>0 || 
	g$edMey
>0)

156 
que_
(
DEDEINC
.'/memberlogin.class.php');

157 
	g$cfg_ml
 = 
w
 
MembLog
();

158 
	g$k
 = 
$cu
;

159 
	g$
 = 
$t
;

160 
	g$cLkt
 = "<hf=\"{$cu}\"><u>".
$
."</u></a>";

161 
	g$pubde
 = 
GDeTimeMk
(
$pubde
);

164 if((
	g$edRk
>1 && 
	g$cfg_ml
->
	gM_Rk
 < $edRk && 
	g$mid
 !
$cfg_ml
->
M_ID
))

166 
$dsql
->
Execu
('me' , "Select * From `#@__arcrank` ");

167 
	g$row
 = 
$dsql
->
GObje
('me'))

169 
$membTys
[
$row
->
nk
] = $row->
membme
;

171 
	g$membTys
[0] = "游客";

172 
	g$msgt
 = "你没有权限下载软件：{$arctitle}！";

173 
	g$memsg
 = "这个软件需要 <fڈc='d'>".
$membTys
[
$edRk
]."</ft> 才能下载，你目前是：<fڈc='d'>".$membTys[
$cfg_ml
->
M_Rk
]."</font> ！";

174 
ude_
(
DEDETEMPLATE
.'/plus/view_msg.htm');

175 
ex
();

180 if(
	g$edMey
 > 0 && 
	g$mid
 !
$cfg_ml
->
M_ID
)

182 
$sql
 = "Seid,mey From `#@__memb_ݔi` whbuyid='ARCHIVE".
$id
."' And mid='".
$cfg_ml
->
M_ID
."'";

183 
	g$row
 = 
$dsql
->
GO
(
$sql
);

185 if!
is_y
(
$row
) )

188 if
	g$edMey
 > 
	g$cfg_ml
->
	gM_Mey
 || $cfg_ml->M_Money=='')

190 
$msgt
 = "你没有权限下载软件：{$arctitle}！";

191 
	g$memsg
 = "这个软件需要 <fڈc='d'>".
$edMey
." 金币</ft> 才能下载，你目前拥有金币：<fڈc='d'>".
$cfg_ml
->
M_Mey
." 个</font> ！";

192 
ude_
(
DEDETEMPLATE
.'/plus/view_msg.htm');

193 
ex
(0);

196 
	g$quy
 = "INSERT INTO `#@__member_operation`(mid,oldinfo,money,mtime,buyid,product,pname,sta)

197 
VALUES
 ('".$cfg_ml->M_ID."','$arctitle','$needMoney','".time()."', 'ARCHIVE".$id."', 'archive','下载软件', 2); ";

199 if!
	g$dsql
->
ExecuNeQuy
(
$quy
) )

201 
ShowMsg
('记录定单失败, 请返回', '-1');

202 
ex
(0);

205 
	g$dsql
->
ExecuNeQuy
("Upd`#@__memb` s mey = mey - $edMey whmid='".
$cfg_ml
->
M_ID
."'");

210 
	g$hash
 = 
md5
(
$soU
);

211 
	g$rs
 = 
$dsql
->
ExecuNeQuy2
("Update `#@__downloads` set downloads = downloads+1 where hash='$hash' ");

212 if(
	g$rs
 <= 0)

214 
$quy
 = " Insert into `#@__downloads`(`hash`, `id`, `downloads`) values('$hash', '$id', 1); ";

215 
	g$dsql
->
ExecNeQuy
(
$quy
);

217 
hd
("location:{$softUrl}");

218 
ex
();

	@plus/erraddsave.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que_
(
DEDEINC
.'/memberlogin.class.php');

5 
	g$htmə
 = "错误提交";

6 
	g$aid
 = 
ist
(
$aid
&& 
is_numic
($aid) ? $aid : 0;

7 if(
	$emy
(
$do
))

9 
$row
 = 
$dsql
->
	`GO
(" SELECT `title` FROM `#@__archives` WHERE `id` ='$aid'");

10 
$t
 = 
$row
['title'];

11 
	`que_
(
DEDEROOT
."/templets/plus/erraddsave.htm");

12 
	}
}

13 
if
(
$do
 == "saveedit")

15 
$cfg_ml
 = 
w
 
MembLog
();

16 
	g$t
 = 
HtmlR
(
$t
);

17 
	g$ty
 = 
ist
(
$ty
&& 
is_numic
($type) ? $type : 0;

18 
	g$mid
 = 
ist
(
$cfg_ml
->
M_ID
) ? $cfg_ml->M_ID : 0;

19 
	g$r
 = 
imMsg
(
_subr
(
$r
,2000),1);

20 
	g$oktxt
 = 
imMsg
(
_subr
(
$dd
,2000),1);

21 
	g$time
 = 
time
();

22 
	g$quy
 = "INSERT INTO `#@__erradd`(aid,mid,title,type,errtxt,oktxt,sendtime)

23 
VALUES
 ('$aid','$mid','$title','$type','$err','$oktxt','$time'); ";

24 
	g$dsql
->
ExecuNeQuy
(
$quy
);

25 
ShowMsg
("谢谢您对本网站的支持，我们会尽快处理您的建议！","javascript:window.close();");

26 
ex
();

	@plus/feedback.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 if(
	g$cfg_edback_fbid
=='Y'
ex
('系统已经禁止评论功能！');

4 
que_
(
DEDEINC
."/filter.inc.php");

5 if(!
	$ist
(
$ai
))

7 
$ai
 = '';

8 
	}
}

10 if(
	g$ai
 ='good' || 
$ai
 == 'bad')

12 if(!
emy
(
$aid
)
$id
 = $aid;

13 
que_
(
dme
(
__FILE__
).'/digg_ajax.php');

14 
ex
();

18 
	g$cfg_fmmemb
 = 
ist
(
$cfg_fmmemb
? 
ue
 : 
l
;

19 
	g$ischeck
 = 
$cfg_edbackcheck
=='Y' ? 0 : 1;

20 
	g$aid
 = (
ist
(
$aid
&& 
is_numic
($aid)) ? $aid : 0;

21 
	g$fid
 = (
ist
(
$fid
&& 
is_numic
($fid)) ? $fid : 0;

22 if(
emy
(
$aid
&& 
	$emy
(
$fid
))

24 
	`ShowMsg
('文档id不能为空!','-1');

25 
	`ex
();

26 
	}
}

28 
ude_
(
DEDEINC
."/memberlogin.class.php");

29 
	g$cfg_ml
 = 
w
 
MembLog
();

32 if(
	g$ai
=='goodfb')

34 
AjaxHd
();

35 
	g$fid
 = 
tv
(
$fid
);

36 
	g$dsql
->
ExecuNeQuy
("Update `#@__feedback` set good = good+1 where id='$fid' ");

37 
	g$row
 = 
$dsql
->
GO
("Select good From `#@__feedback` where id='$fid' ");

38 
	gecho
 "<a onclick=\"postBadGood('goodfb',{$aid})\">支持</a>[{$row['good']}]";

39 
ex
();

41 if(
	g$ai
=='badfb')

43 
AjaxHd
();

44 
	g$fid
 = 
tv
(
$fid
);

45 
	g$dsql
->
ExecuNeQuy
("Update `#@__feedback` set bad = bad+1 where id='$fid' ");

46 
	g$row
 = 
$dsql
->
GO
("Select bad From `#@__feedback` where id='$fid' ");

47 
	gecho
 "<a onclick=\"postBadGood('badfb',{$aid})\">反对</a>[{$row['bad']}]";

48 
ex
();

55 if(
	g$ai
=='' || 
$ai
=='show')

58 
$cRow
 = 
GOArchive
(
$aid
);

59 if(
emy
(
$cRow
['aid']))

61 
ShowMsg
('无法查看未知文档的评论!','-1');

62 
ex
();

64 
exa
(
$cRow
, 
EXTR_SKIP
);

65 
ude_
(
DEDEINC
.'/datalistcp.class.php');

66 
	g$dli
 = 
w
 
DaLiCP
();

67 
	g$dli
->
	ggeSize
 = 20;

69 if(
emy
(
$y
|| (
	g$y
!='good' && $ftype!='bad' && $ftype!='feedback'))

71 
$y
 = '';

73 
	g$wquy
 = 
$y
!='' ? " And ftypeike '$ftype' " : '';

76 
	g$quyrg
 = "select fb.*,mb.userid,mb.faces mface,mb.spacesta,mb.scores from `#@__feedback` fb

77 

 
jo
 `#@
__memb
` 
mb
 

 mb.
mid
 = 
fb
.mid

78 
whe
 
fb
.
aid
='$aid' 
d
 fb.
ischeck
='1' 
$wquy
 
d
 
by
 fb.
id
 
desc
";

79 
$dli
->
SPam
('aid',
$aid
);

80 
	g$dli
->
SPam
('action','show');

81 
	g$dli
->
STeme
(
DEDETEMPLATE
.'/plus/feedback_templet.htm');

82 
	g$dli
->
SSour
(
$quyrg
);

83 
	g$dli
->
Diy
();

84 
ex
();

92 if(
	g$ai
=='quote')

94 
$row
 = 
$dsql
->
GO
("Select * from `#@__feedback` where id ='$fid'");

95 
que_
(
DEDEINC
.'/dedetemplate.class.php');

96 
	g$d
 = 
w
 
DedeTeme
();

97 
	g$d
->
LdTeme
(
DEDETEMPLATE
.'/plus/feedback_quote.htm');

98 
	g$d
->
Diy
();

99 
ex
();

106 if(
	g$ai
=='send')

109 
$cRow
 = 
GOArchive
(
$aid
);

110 if((
emy
(
$cRow
['aid']|| 
	g$cRow
['npo']=='1')&&emy(
$fid
))

112 
ShowMsg
('无法对该文档发表评论!','-1');

113 
ex
();

117 if(
emy
(
$iscfm
))

119 
	g$iscfm
 = '';

121 if(
	g$iscfm
!='yes' && 
$cfg_edback_ck
=='Y')

123 
exa
(
$cRow
, 
EXTR_SKIP
);

124 
que_
(
DEDEINC
.'/dedetemplate.class.php');

125 
	g$d
 = 
w
 
DedeTeme
();

126 
	g$d
->
LdTeme
(
DEDETEMPLATE
.'/plus/feedback_confirm.htm');

127 
	g$d
->
Diy
();

128 
ex
();

131 if(
	g$cfg_edback_ck
=='Y')

133 
$vide
 = 
ist
($vide? 
ow
(
im
($validate)) : '';

134 
	g$svi
 = 
ow
(
im
(
GCkVdVue
()));

135 if(
	g$vide
 !
$svi
 || $svali=='')

137 
RetVdVue
();

138 
ShowMsg
('验证码错误！','-1');

139 
ex
();

144 if(
emy
(
$nur
))

146 
	g$nur
=0;

150 if(
	g$nur
==1)

152 
$uame
 = 
$cfg_ml
->
M_ID
 > 0 ? '匿名' : '游客';

156 if(
	g$cfg_ml
->
	gM_ID
 > 0)

158 
	g$uame
 = 
$cfg_ml
->
M_UrName
;

164 if(
	g$uame
!='' && 
$pwd
!='')

166 
$rs
 = 
$cfg_ml
->
CheckUr
(
$uame
,
$pwd
);

167 if(
	g$rs
==1)

169 
$dsql
->
ExecuNeQuy
("Upd`#@__memb` sogtime='".
time
()."',log='".
GIP
()."' where mid='{$cfg_ml->M_ID}'; ");

173 
	g$uame
 = '游客';

178 
	g$uame
 = '游客';

181 
	g$
 = 
GIP
();

182 
	g$dtime
 = 
time
();

185 if(!
emy
(
$cfg_edback_time
))

188 if(
	g$cfg_ml
->
	gM_ID
 > 0)

190 
	g$whe
 = "WHERE `mid` = '$cfg_ml->M_ID'";

194 
	g$whe
 = "WHERE `ip` = '$ip'";

196 
	g$row
 = 
$dsql
->
GO
("SELECT dtime FROM `#@__feedback` $where ORDER BY `id` DESC ");

197 if(
is_y
(
$row
&& 
	g$dtime
 - 
	g$row
['dtime'] < 
	g$cfg_edback_time
)

199 
RetVdVue
();

200 
ShowMsg
('管理员设置了评论间隔时间，请稍等休息一下！','-1');

201 
ex
();

205 if(
emy
(
$
))

207 
	g$
 = 0;

209 
	g$
 = 
tv
(
$
);

210 
exa
(
$cRow
, 
EXTR_SKIP
);

211 
	g$msg
 = 
_subrR
(
TrimMsg
(
$msg
),1000);

212 
	g$uame
 = 
_subrR
(
HtmlR
(
$uame
,2),20);

213 if(
emy
(
$edbackty
|| (
	g$edbackty
!='good' && $feedbacktype!='bad'))

215 
$edbackty
 = 'feedback';

218 if(
	g$comty
 == 'comments')

220 
$
 = 
addashes
(
$t
);

221 if(
	g$msg
!='')

223 
$quy
 = "INSERT INTO `#@__feedback`(`aid`,`typeid`,`username`,`arctitle`,`ip`,`ischeck`,`dtime`, `mid`,`bad`,`good`,`ftype`,`face`,`msg`)

224 
VALUES
 ('$aid','$typeid','$username','$arctitle','$ip','$ischeck','$dtime', '{$cfg_ml->M_ID}','0','0','$feedbacktype','$face','$msg'); ";

225 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

226 if(!
	g$rs
)

228 
ShowMsg
(' 发表评论错误! ', '-1');

230 
ex
();

235 
if
 (
$comty
 == 'reply')

237 
$row
 = 
$dsql
->
GO
("Select * from `#@__feedback` where id ='$fid'");

238 
	g$
 = 
$row
['arctitle'];

239 
	g$aid
 =
$row
['aid'];

240 
	g$msg
 = 
$quemsg
.
$msg
;

241 
	g$msg
 = 
HtmlR
(
$msg
,2);

242 
	g$quy
 = "INSERT INTO `#@__feedback`(`aid`,`typeid`,`username`,`arctitle`,`ip`,`ischeck`,`dtime`,`mid`,`bad`,`good`,`ftype`,`face`,`msg`)

243 
VALUES
 ('$aid','$typeid','$username','$arctitle','$ip','$ischeck','$dtime','{$cfg_ml->M_ID}','0','0','$feedbacktype','$face','$msg')";

244 
	g$dsql
->
ExecuNeQuy
(
$quy
);

247 if(
	g$edbackty
=='bad')

249 
$dsql
->
ExecuNeQuy
("Update `#@__archives` set scores=scores-{cfg_feedback_sub},badpost=badpost+1,lastpost='$dtime' where id='$aid' ");

251 if(
	g$edbackty
=='good')

253 
$dsql
->
ExecuNeQuy
("Update `#@__archives` set scores=scores+{$cfg_feedback_add},goodpost=goodpost+1,lastpost='$dtime' where id='$aid' ");

257 
	g$dsql
->
ExecuNeQuy
("Update `#@__archives` set scores=scores+1,lastpost='$dtime' where id='$aid' ");

259 if(
	g$cfg_ml
->
	gM_ID
 > 0)

261 
	g$dsql
->
ExecuNeQuy
("Update `#@__member` set scores=scores+{$cfg_sendfb_scores} where mid='{$cfg_ml->M_ID}' ");

264 if(
	g$cfg_ml
->
	gM_ID
 > 0)

267 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/api/uc.func.php')

270 
uc_ed_ne
(
$cfg_ml
->
M_LogID
, 
$cfg_ndfb_sces
);

273 
	g$cRow
 = 
GOArchive
(
$aid
);

274 
	g$ed
['icon'] = 'thread';

275 
	g$ed
['title_template'] = '<b>{username} 在网站发表了评论</b>';

276 
	g$ed
['t_da'] = 
y
('uame' => 
$cfg_ml
->
M_UrName
);

277 
	g$ed
['body_template'] = '<b>{subject}</b><br>{message}';

278 
	g$u
 = !
rr
(
$cRow
['cu'],'hp://'? (
	g$cfg_baho
.
	g$cRow
['arcurl']) : $arcRow['arcurl'];

279 
	g$ed
['body_da'] = 
y
('subje' => "<hf=\"".
$u
."\">$cRow[]</a>", 'mesge' => 
_subr
(
r_gs
(
eg_a
("/\[.+?\]/is", '', 
$msg
)), 150));

280 
	g$ed
['images'][] = 
y
('u' => 
$cfg_baho
.'/images/scores.gif', 'link'=> $cfg_basehost);

281 
uc_ed_ne
(
$cfg_ml
->
M_LogID
,
$ed
); 
unt
(
$cRow
);

283 #/
a
}}

285 
	g$row
 = 
$dsql
->
GO
("SELECT COUNT(*ASumFROM `#@__edback` WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

286 
	g$dsql
->
ExecuNeQuy
("UPDATE `#@__memb_tj` SET `edback`='$row[nums]' WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

288 
	g$_SESSION
['dtime'] = 
time
();

289 if(
emy
(
$uid
&& 
ist
(
$cmtur
)
	g$uid
 = $cmtuser;

290 
	g$backu
 = 
$cfg_fmmemb
 ? "index.php?uid={$uid}&action=viewarchives&aid={$aid}" : "feedback.php?aid=$aid";

291 if(
	g$ischeck
==0)

293 
ShowMsg
('成功发表评论，但需审核后才会显示你的评论!', 
$backu
);

297 
ShowMsg
('成功发表评论，现在转到评论页面!', 
$backu
);

299 
ex
();

	@plus/feedback_ajax.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 
que_
(
DEDEINC
.'/channelunit.func.php');

4 
AjaxHd
();

6 if(
	g$cfg_edback_fbid
=='Y'
ex
('系统已经禁止评论功能！');

8 
	g$aid
 = 
tv
(
$aid
);

9 if(
	$emy
(
$aid
)
	`ex
('没指定评论文档的ID，不能进行操作！');

11 
	`ude_
(
DEDEINC
.'/memberlogin.class.php');

12 
$cfg_ml
 = 
w
 
	`MembLog
();

14 if(
	`emy
(
$do
)) $dopost = '';

15 
$ge
 = 
	`emy
($ge? 1 : 
	`tv
($page);

16 
$gesize
 = 10;

22 if(
$do
=='getlist')

24 
$tٮcou
 = 
	`GLi
(
$ge
);

25 
	`GPageLi
(
$gesize
, 
$tٮcou
);

26 
	`ex
();

27 
	}
}

32 if(
	g$do
=='send')

34 
que_
(
DEDEINC
.'/charset.func.php');

37 if(
	g$cfg_edback_ck
=='Y')

39 
$svi
 = 
ow
(
im
(
GCkVdVue
()));

40 if(
ow
(
$vide
!
$svi
 || $svali=='')

42 
RetVdVue
();

43 
	gecho
 '<font color="red">验证码错误，请点击验证码图片更新验证码！</font>';

44 
ex
();

48 
	g$cRow
 = 
GOArchive
(
$aid
);

49 if(
emy
(
$cRow
['aid']))

51 
	gecho
 '<font color="red">无法查看未知文档的评论!</font>';

52 
ex
();

54 if(
ist
(
$cRow
['npo']&& 
	g$cRow
['notpost']==1)

56 
echo
 '<font color="red">这篇文档禁止评论!</font>';

57 
ex
();

60 if(
	g$cfg_so_ng
 != 'utf8')

62 
$msg
 = 
UnicodeU2Gbk
($msg);

63 if(!
emy
(
$uame
)
	g$uame
 = 
UnicodeU2Gbk
($username);

66 if(
	g$cfg_nٮlowr
 != '')

68 if(
egi
(
$cfg_nٮlowr
, 
$msg
))

70 
echo
 "<font color='red'>评论内容含有禁用词汇！</font>";

71 
ex
();

74 if(
	g$cfg_ar
 != '')

76 
$msg
 = 
egi_a
(
$cfg_ar
, '***', $msg);

78 if(
emy
(
$msg
))

80 
	gecho
 "<font color='red'>评论内容可能不合法或为空！</font>";

81 
ex
();

84 
	g$uame
 = 
emy
(
$uame
) ? '游客' : $username;

85 if(
emy
(
$nur
)
	g$nur
 = 0;

86 if(
	g$nur
==1)

88 
$uame
 = 
$cfg_ml
->
M_ID
 > 0 ? '匿名' : '游客';

90 if(
	g$cfg_ml
->
	gM_ID
 > 0)

92 
	g$uame
 = 
$cfg_ml
->
M_UrName
;

94 if(
	g$uame
!='' && 
$pwd
!='')

96 
$rs
 = 
$cfg_ml
->
CheckUr
(
$uame
, 
$pwd
);

97 if(
	g$rs
==1)

99 
$dsql
->
ExecuNeQuy
("Upd`#@__memb` sogtime='".
time
()."',log='".
GIP
()."' where mid='{$cfg_ml->M_ID}'; ");

101 
	g$cfg_ml
 = 
w
 
MembLog
();

105 
	g$
 = 
GIP
();

106 
	g$dtime
 = 
time
();

107 if(!
emy
(
$cfg_edback_time
))

110 
	g$whe
 = (
$cfg_ml
->
M_ID
 > 0 ? "WHERE `mid` = '$cfg_ml->M_ID' " : "WHERE `ip` = '$ip' ");

111 
	g$row
 = 
$dsql
->
GO
("SELECT dtime FROM `#@__feedback` $where ORDER BY `id` DESC ");

112 if(
is_y
(
$row
&& 
	g$dtime
 - 
	g$row
['dtime'] < 
	g$cfg_edback_time
)

114 
RetVdVue
();

115 
	gecho
 '<font color="red">管理员设置了评论间隔时间，请稍等休息一下！</font>';

116 
ex
();

119 
	g$
 = 
tv
(
$
);

120 
exa
(
$cRow
, 
EXTR_SKIP
);

121 
	g$msg
 = 
_subrR
(
TrimMsg
(
$msg
), 500);

122 
	g$uame
 = 
_subrR
(
HtmlR
(
$uame
,2), 20);

123 if(
emy
(
$edbackty
|| (
	g$edbackty
!='good' && $feedbacktype!='bad'))

125 
$edbackty
 = 'feedback';

128 if(!
emy
(
$fid
))

130 
	g$row
 = 
$dsql
->
GO
("Select username,msg from `#@__feedback` where id ='$fid' ");

131 
	g$qmsg
 = '{que}{t}'.
$row
['username'].' 的原帖：{/title}{content}'.$row['msg'].'{/content}{/quote}';

132 
	g$msg
 = 
addashes
(
$qmsg
).
$msg
;

134 
	g$ischeck
 = (
$cfg_edbackcheck
=='Y' ? 0 : 1);

135 
	g$
 = 
addashes
(
$t
);

136 
	g$quy
 = "INSERT INTO `#@__feedback`(`aid`,`typeid`,`username`,`arctitle`,`ip`,`ischeck`,`dtime`, `mid`,`bad`,`good`,`ftype`,`face`,`msg`)

137 
VALUES
 ('$aid','$typeid','$username','$arctitle','$ip','$ischeck','$dtime', '{$cfg_ml->M_ID}','0','0','$feedbacktype','$face','$msg'); ";

138 
	g$rs
 = 
$dsql
->
ExecuNeQuy
(
$quy
);

139 if!
	g$rs
 )

141 
	gecho
 "<font color='red'>发表评论出错了！</font>";

143 
ex
();

145 
	g$wid
 = 
$dsql
->
GLaID
();

147 if(
	g$edbackty
=='bad')

149 
$dsql
->
ExecuNeQuy
("Update `#@__archives` set scores=scores-{cfg_feedback_sub},badpost=badpost+1,lastpost='$dtime' where id='$aid' ");

151 if(
	g$edbackty
=='good')

153 
$dsql
->
ExecuNeQuy
("Update `#@__archives` set scores=scores+{$cfg_feedback_add},goodpost=goodpost+1,lastpost='$dtime' where id='$aid' ");

157 
	g$dsql
->
ExecuNeQuy
("Update `#@__archives` set scores=scores+1,lastpost='$dtime' where id='$aid' ");

160 if(
	g$cfg_ml
->
	gM_ID
 > 0)

163 if(
defed
('UC_API'&& @
ude_
 
	gDEDEROOT
.'/api/uc.func.php')

166 
uc_ed_ne
(
$cfg_ml
->
M_LogID
, 
$cfg_ndfb_sces
);

169 
	g$cRow
 = 
GOArchive
(
$aid
);

170 
	g$ed
['icon'] = 'thread';

171 
	g$ed
['title_template'] = '<b>{username} 在网站发表了评论</b>';

172 
	g$ed
['t_da'] = 
y
('uame' => 
$cfg_ml
->
M_UrName
);

173 
	g$ed
['body_template'] = '<b>{subject}</b><br>{message}';

174 
	g$u
 = !
rr
(
$cRow
['cu'],'hp://'? (
	g$cfg_baho
.
	g$cRow
['arcurl']) : $arcRow['arcurl'];

175 
	g$ed
['body_da'] = 
y
('subje' => "<hf=\"".
$u
."\">$cRow[]</a>", 'mesge' => 
_subr
(
r_gs
(
eg_a
("/\[.+?\]/is", '', 
$msg
)), 150));

176 
	g$ed
['images'][] = 
y
('u' => 
$cfg_baho
.'/images/scores.gif', 'link'=> $cfg_basehost);

177 
uc_ed_ne
(
$cfg_ml
->
M_LogID
,
$ed
); 
unt
(
$cRow
);

179 #/
a
}}

180 
	g$dsql
->
ExecuNeQuy
("Update `#@__member` set scores=scores+{$cfg_sendfb_scores} where mid='{$cfg_ml->M_ID}' ");

181 
	g$row
 = 
$dsql
->
GO
("SELECT COUNT(*ASumFROM `#@__edback` WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

182 
	g$dsql
->
ExecuNeQuy
("UPDATE `#@__memb_tj` SET `edback`='$row[nums]' WHERE `mid`='".
$cfg_ml
->
M_ID
."'");

184 
	g$_SESSION
['dtime'] = 
time
();

185 if(
	g$ischeck
==0)

187 
echo
 '<font color="red">成功发表评论，但需审核后才会显示你的评论!</font>';

188 
ex
();

192 
	g$au
 = '#';

193 if(
	g$cfg_ml
->
	gM_ID
 > 0
	g$au
 = "{$cfg_membu}/dex.php?uid=".
ucode
(
$cfg_ml
->
M_LogID
);

194 
	g$id
 = 
$wid
;

195 
	g$msg
 = 
rashes
(
$msg
);

196 
	g$msg
 = 
r_a
('<', '&;', 
$msg
);

197 
	g$msg
 = 
r_a
('>', '&gt;', 
$msg
);

198 
	g$msg
 = 
Que_a
(
$msg
);

199 if(
	g$edbackty
=='bad'
$bgimg
 = 'cmt-bad.gif';

200 if(
	g$edbackty
=='good'
$bgimg
 = 'cmt-good.gif';

201 
	g$bgimg
 = 'cmt-neu.gif';

203 <
div
 
	gid
="commmsgs" 
ass
="dede_comment">

204 <
div
 
ass
='decmt-box'>

205 <
div
 
ass
='decmt-title'>

206 <

 
ass
='moodico'><
img
 
c
='<?phpcho $cfg_templeturl; ?>/images/mood/ico-mood-<?phpcho $face; ?>.gif'/></span>

207 <

 
ass
='uame'><
a
 
hf
='<?phech$au; ?>'><?
php
 
echo
 
$uame
; ?></
	ga
></
	g
>

208 <

 
	gass
='de'><?
php
 
echo
 
GDeMk
(
$dtime
); ?></
	g
>

209 <
	g
>发表</span>

210 </
	gdiv
>

211 <
div
 
	gass
='decmt-act'>

212 <

 
id
='goodfb<?phpcho $id; ?>'>

213 <
a
 
hf
='#goodfb<?phech$id; ?>' 
ick
="postBadGood('goodfb',<?phpcho $id; ?>);">支持</a>[0]

214 </

>

215 <

 
id
='badfb<?phpcho $id; ?>'>

216 <
a
 
hf
='#badfb<?phech$id; ?>' 
ick
="postBadGood('badfb',<?phpcho $id; ?>);">反对</a>[0]

217 </

>

218 <

 
ass
='quote'>

219 <
a
 
hf
='#pofm' 
ick
="quoteCommet('<?phpcho $id; ?>');">[引用]</a>

220 </

>

221 </
div
>

222 <
div
 
ass
='decmt-content'>

223 <?
php
 
echo
 
$msg
; ?><
img
 
	gc
='<?phpcho $cfg_templeturl; ?>/images/<?phpcho $bgimg; ?>' />

224 </
div
>

225 </
div
>

226 </
div
>

227 <
br
 
y
='clear:both' />

228 <?
php


230 
ex
();

234 
funi
 
	$GLi
(
$ge
=1)

236 
glob
 
$dsql
, 
$aid
, 
$gesize
, 
$cfg_mu
;

237 
$quyrg
 = "select fb.*,mb.userid,mb.faces mface,mb.spacesta,mb.scores from `#@__feedback` fb

238 

 
jo
 `#@
__memb
` 
mb
 

 mb.
mid
 = 
fb
.mid 
whe
 fb.
aid
='$aid' 
d
 fb.
ischeck
='1' 
d
 
by
 fb.
id
 
desc
";

239 
$row
 = 
$dsql
->
	`GO
("select count(*)s dd from `#@__feedback` whereid='$aid'nd ischeck='1' ");

240 
$tٮcou
 = (
	`emy
(
$row
['dd']) ? 0 : $row['dd']);

241 
$tNum
 = 
$gesize
 * (
$ge
-1);

242 if(
$tNum
 > 
$tٮcou
)

244 
echo
 "参数错误！";

245  
$tٮcou
;

247 
$dsql
->
	`Execu
('fb', 
$quyrg
."imit $startNum, $pagesize ");

248 
$flds
 = 
$dsql
->
	`GAay
('fb'))

250 if(
$flds
['urid']!=''
$au
 = 
$GLOBALS
['cfg_memberurl'].'/index.php?uid='.$fields['userid'];

251 
$au
 = '#';

252 if(
$flds
['uame']=='匿名'
$au
 = '#';

253 
$flds
['bgimg'] = 'cmt-neu.gif';

254 
$flds
['ftypetitle'] = '该用户表示中立';

255 if(
$flds
['ftype']=='bad')

257 
$flds
['bgimg'] = 'cmt-bad.gif';

258 
$flds
['ftypetitle'] = '该用户表示差评';

260 if(
$flds
['ftype']=='good')

262 
$flds
['bgimg'] = 'cmt-good.gif';

263 
$flds
['ftypetitle'] = '该用户表示好评';

265 
$flds
[''] = 
	`emy
($fields['face']) ? 6 : $fields['face'];

266 
$flds
['msg'] = 
	`r_a
('<', '&lt;', $fields['msg']);

267 
$flds
['msg'] = 
	`r_a
('>', '&gt;', $fields['msg']);

268 
$flds
['msg'] = 
	`Que_a
($fields['msg']);

269 
	`exa
(
$flds
, 
EXTR_OVERWRITE
);

271 <
div
 
id
="commmsgs" 
ass
="dede_comment">

272 <
div
 
ass
='decmt-box'>

273 <
div
 
ass
='decmt-title'>

274 <

 
ass
='moodico'><
img
 
c
='<?phpcho $cfg_templeturl; ?>/images/mood/ico-mood-<?phpcho $face; ?>.gif'/></span>

275 <

 
ass
='uame'><
a
 
hf
='<?phech$au; ?>'><?
php
 
echo
 
$uame
; ?></a></span>

276 <

 
ass
='de'><?
php
 
echo
 
	`GDeMk
(
$dtime
); ?></span>

277 <

>发表</span>

278 </
div
>

279 <
div
 
ass
='decmt-act'>

280 <

 
id
='goodfb<?phpcho $id; ?>'>

281 <
a
 
hf
='#goodfb<?phech$id; ?>' 
ick
="poBadGood('goodfb',<?phech$id; ?>);">支持</a>[<?
php
 
echo
 
$good
; ?>]

282 </

>

283 <

 
id
='badfb<?phpcho $id; ?>'>

284 <
a
 
hf
='#badfb<?phech$id; ?>' 
ick
="poBadGood('badfb',<?phech$id; ?>);">反对</a>[<?
php
 
echo
 
$bad
; ?>]

285 </

>

286 <

 
ass
='quote'>

287 <
a
 
hf
='#pofm' 
ick
="quoteCommet('<?phpcho $id; ?>');">[引用]</a>

288 </

>

289 </
div
>

290 <
div
 
ass
='decmt-content'>

291 <?
php
 
echo
 
$msg
; ?><
img
 
c
='<?phech$cfg_mu; ?>/images/<?phech$bgimg; ?>' 
t
='<?phpcho $ftypetitle; ?>' />

292 </
div
>

293 </
div
>

294 </
div
>

295 <?
php


297  
$tٮcou
;

298 
	}
}

301 
funi
 
	$GPageLi
(
$gesize
, 
$tٮcou
)

303 
glob
 
$ge
;

304 
$cuage
 = 
	`emy
(
$ge
? 1 : 
	`tv
($page);

305 
$age
 = 
	`
(
$tٮcou
 / 
$gesize
);

306 if(
$age
 < 2)

308 
echo
 '';

311 
echo
 "<div id='commetpages'>";

312 
echo
 "<span>总: {$allpage} 页/{$totalcount} 条评论</span> ";

313 
$lisize
 = 5;

314 
$tٮ_li
 = 
$lisize
 * 2 + 1;

315 
$tٮge
 = 
$age
;

316 
$lidd
 = '';

317 if(
$cuage
-1 > 0 )

319 
echo
 "<hf='#commt' onick='LdComms(".(
$cuage
-1).");'>上一页</a> ";

321 if(
$cuage
 >
$tٮ_li
)

323 
$j
 = 
$cuage
 - 
$lisize
;

324 
$tٮ_li
 = 
$cuage
 + 
$lisize
;

325 if(
$tٮ_li
 > 
$tٮge
)

327 
$tٮ_li
 = 
$tٮge
;

332 
$j
 = 1;

333 if(
$tٮ_li
 > 
$tٮge
) $total_list = $totalpage;

335 
$j
; $j <
$tٮ_li
; $j++)

337 
	`echo
 (
$j
==
$cuage
 ? "<strong>$j</strong> " : "<a href='#commettop' onclick='LoadCommets($j);'>{$j}</a> ");

339 if(
$cuage
+1 <
$tٮge
 )

341 
echo
 "<hf='#commt' onick='LdComms(".(
$cuage
+1).");'>下一页</a> ";

343 
echo
 "</div>";

344 
	}
}

	@plus/feedback_js.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 if(
	g$cfg_edback_fbid
=='Y'
ex
("document.write('ϵͳѾֹ۹ܣ');\r\n");

4 
que_
(
DEDEINC
."/datalistcp.class.php");

5 if(
	$ist
(
$cID
))

7 
$aid
 = 
$cID
;

8 
	}
}

9 
	g$cID
 = 
$aid
 = (
ist
($aid&& 
is_numic
($aid)) ? $aid : 0;

10 if(
	g$aid
==0)

12 
ex
(" Request Error! ");

15 
	g$quyrg
 = "select fb.*,mb.userid,mb.faces mface,mb.spacesta,mb.scores from `#@__feedback` fb

16 

 
jo
 `#@
__memb
` 
mb
 

 mb.
mid
 = 
fb
.mid

17 
whe
 
fb
.
aid
='$aid' 
d
 fb.
ischeck
='1' 
d
 
by
 fb.
id
 
desc
";

18 
$dli
 = 
w
 
DaLiCP
();

19 
	g$dli
->
	ggeSize
 = 6;

20 
	g$dli
->
STem
(
DEDETEMPLATE
.'/plus/feedback_templet_js.htm');

21 
	g$dli
->
SSour
(
$quyrg
);

22 
	g$dli
->
diy
();

	@plus/flink.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 if(
	$emy
(
$do
))

5 
$do
 = '';

6 
	}
}

8 if(
	g$do
=='save')

10 
$vide
 = 
ist
($vide? 
ow
(
im
($validate)) : '';

11 
	g$svi
 = 
GCkVdVue
();

12 if(
	g$vide
=='' || 
$vide
!=
$svi
)

14 
ShowMsg
('验证码不正确!','-1');

15 
ex
();

17 
	g$msg
 = 
htmleclchs
(
$msg
);

18 
	g$ema
 = 
htmleclchs
(
$ema
);

19 
	g$webme
 = 
htmleclchs
(
$webme
);

20 
	g$u
 = 
htmleclchs
(
$u
);

21 
	g$logo
 = 
htmleclchs
(
$logo
);

22 
	g$tyid
 = 
tv
(
$tyid
);

23 
	g$dtime
 = 
time
();

24 
	g$quy
 = "Insert Into `#@__flink`(sortrank,url,webname,logo,msg,email,typeid,dtime,ischeck)

25 
Vues
('50','$url','$webname','$logo','$msg','$email','$typeid','$dtime','0')";

26 
	g$dsql
->
ExecuNeQuy
(
$quy
);

27 
ShowMsg
('成功增加一个链接，但需要审核后才能显示!','-1',1);

31 
ude_
(
DEDETEMPLATE
.'/plus/flink-list.htm');

	@plus/flink_add.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

4 
ude_
(
DEDETEMPLATE
.'/plus/flink-add.htm');

	@plus/freelist.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que_
(
DEDEINC
."/arc.freelist.class.php");

4 if(!
	$emy
(
$lid
)){

5 
$tid
 = 
$lid
;

6 
	}
}

7 
	g$tid
 = (
ist
(
$tid
&& 
is_numic
($tid) ? $tid : 0);

8 if(
	g$tid
==0
d
(" Request Error! ");

10 
	g$
 = 
w
 
FeLi
(
$tid
);

11 
	g$
->
Diy
();

	@plus/heightsearch.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 
que_
(
DEDEINC
.'/typelink.class.php');

4 
que_
(
DEDETEMPLATE
.'/plus/heightsearch.htm');

	@plus/list.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

4 
	g$t1
 = 
ExecTime
();

6 
	g$tid
 = (
ist
(
$tid
&& 
is_numic
($tid) ? $tid : 0);

8 
	g$chlid
 = (
ist
(
$chlid
&& 
is_numic
($channelid) ? $channelid : 0);

10 if(
	g$tid
==0 && 
$chlid
==0
d
(" Request Error! ");

13 if(!
emy
(
$chlid
&& 
	$emy
(
$tid
))

15 
$tfos
 = 
$dsql
->
	`GO
("Selectp.id,ch.issystem From `#@__arctype`peft join `#@__channeltype` ch on ch.id=tp.channeltype wherep.channeltype='$channelid' Andp.reid=0 order by sortranksc");

16 if(!
	`is_y
(
$tfos
)
	`d
(" No catalogs inhe channel! ");

17 
$tid
 = 
$tfos
['id'];

18 
	}
}

21 
	g$tfos
 = 
$dsql
->
GO
("Select ch.issystem From `#@__arctype`peft join `#@__channeltype` ch on ch.id=tp.channeltype wherep.id='$tid' ");

24 if(
	g$tfos
['issystem']==-1)

26 
$tiv
 = ( (
emy
($tiv|| !
is_numic
($nativeplace)) ? 0 : $nativeplace );

27 
	g$fy
 = ( (
emy
(
$fy
|| !
is_numic
($infotype)) ? 0 : $infotype );

28 if(!
emy
(
$keywd
)
	g$keywd
 = 
FrSrch
($keyword);

29 
	g$cA
 = 
y
();

30 if(!
emy
(
$tiv
)
	g$cA
['nativeplace'] = $nativeplace;

31 if(!
emy
(
$fy
)
	g$cA
['infotype'] = $infotype;

32 if(!
emy
(
$keywd
)
	g$cA
['keyword'] = $keyword;

33 
ude
(
DEDEINC
."/arc.sglistview.class.php");

34 
	g$lv
 = 
w
 
SgLiVw
(
$tid
,
$cA
);

38 
ude
(
DEDEINC
."/arc.listview.class.php");

39 
	g$lv
 = 
w
 
LiVw
(
$tid
);

41 if(
ist
(
$lv
->
Flds
['cܪk']&& 
	g$lv
->
	gFlds
['corank'] > 0)

43 
que_
(
DEDEINC
.'/memberlogin.class.php');

44 
	g$cfg_ml
 = 
w
 
MembLog
();

45 if
	g$cfg_ml
->
	gM_Rk
 < 
	g$lv
->
	gFlds
['corank'] )

47 
	g$dsql
->
Execu
('me' , "Select * From `#@__arcrank` ");

48 
	g$row
 = 
$dsql
->
GObje
('me'))

50 
$membTys
[
$row
->
nk
] = $row->
membme
;

52 
	g$membTys
[0] = "游客或没权限会员";

53 
	g$msgt
 = "你没有权限浏览栏目：{$lv->Fields['typename']} ！";

54 
	g$memsg
 = "这个栏目需要 <fڈc='d'>".
$membTys
[
$lv
->
Flds
['cܪk']]."</ft> 才能访问，你目前是：<fڈc='d'>".$membTys[
$cfg_ml
->
M_Rk
]."</font> ！";

55 
ude_
(
DEDETEMPLATE
.'/plus/view_msg_catalog.htm');

56 
ex
();

61 if(
	g$lv
->
	gIsE
)

63 
PamE
();

66 
	g$lv
->
Diy
();

	@plus/mytag_js.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 
que_
(
DEDEINC
.'/arc.partview.class.php');

5 if(
ist
(
$cID
)
	g$aid
 = $arcID;

6 
	g$cID
 = 
$aid
 = (
ist
($aid&& 
is_numic
($aid)) ? $aid : 0;

7 if(
	g$aid
==0
d
(" document.write('Request Error!'); ");

9 
	g$cheFe
 = 
DEDEDATA
.'/che/myg-'.
$aid
.'.htm';

10 if
ist
(
$noche
|| !
fe_exis
(
$cheFe
|| 
time
(- 
femtime
($cheFe> 
	g$cfg_pucche_time
 )

12 
	g$pv
 = 
w
 
PtVw
();

13 
	g$row
 = 
$pv
->
dsql
->
GO
(" Select * From `#@__mytag` whereid='$aid' ");

14 if(!
is_y
(
$row
))

16 
	g$myvues
 = "<!--\r\ndocument.write('Not found input!');\r\n-->";

20 
	g$gbody
 = '';

21 if(
	g$row
['timeset']==0)

23 
$gbody
 = 
$row
['normbody'];

27 
	g$ime
 = 
time
();

28 if(
	g$ime
>
	g$row
['endtime'] || $ntime < $row['starttime']) {

29 
	g$gbody
 = 
$row
['expbody'];

32 
	g$gbody
 = 
$row
['normbody'];

35 
	g$pv
->
STem
(
$gbody
, 'string');

36 
	g$myvues
 = 
$pv
->
GResu
();

37 
	g$myvues
 = 
r_a
('"','\"',
$myvues
);

38 
	g$myvues
 = 
r_a
("\r","\\r",
$myvues
);

39 
	g$myvues
 = 
r_a
("\n","\\n",
$myvues
);

40 
	g$myvues
 = "<!--\r\ndocument.write(\"{$myvalues}\");\r\n-->\r\n";

41 
	g$
 = 
fݒ
(
$cheFe
, 'w');

42 
fwre
(
$
, 
$myvues
);

43 
fo
(
$
);

46 
ude
 
	g$cheFe
;

	@plus/paycenter/alipay/alipay_config.php

1 <?
php


2 
	g$r
 = 
$ymt_urid
[2];

3 
	g$cury_code
 = 
$ymt_key
[2];

4 
	g$Δ_ema
 = 
$ymt_ema
[2];

5 
	g$_put_cht
 = 
$cfg_so_ng
;

6 
	g$sign_ty
 = "MD5";

7 
	g$t
 = "http";

8 
	g$nify_u
 = 
$cfg_baho
."/plus/paycenter/alipay/notify_url.php";

9 
	g$tu_u
 = 
$cfg_baho
."/plus/paycenter/alipay/return_url.php";

10 
	g$show_u
 = ""

	@plus/paycenter/alipay/alipay_notify.php

1 <?
php


2 as
	cay_nify
 {

3 
v
 
	m$geway
;

4 
v
 
	m$cury_code
;

5 
v
 
	m$r
;

6 
v
 
	m$sign_ty
;

7 
v
 
	m$mysign
;

8 
v
 
	m$_put_cht
 ;

9 
v
 
	m$t
;

10 
funi
 
ay_nify
(
$r
,
$cury_code
,
$sign_ty
 = "MD5",
$_put_cht
 = "GBK",
$t
= "https") {

11 
$this
->
r
 = 
$r
;

12 
	m$this
->
	mcury_code
 = 
$cury_code
;

13 
	m$this
->
	msign_ty
 = 
$sign_ty
;

14 
	m$this
->
	mmysign
 = "";

15 
	m$this
->
	m_put_cht
 = 
$_put_cht
 ;

16 
	m$this
->
	mt
 = 
$t
;

17 if(
	m$this
->
	mt
 == "https") {

18 
$this
->
geway
 = "https://www.alipay.com/cooperate/gateway.do?";

19 } 
	m$this
->
	mgeway
 = "http://notify.alipay.com/trade/notify_query.do?";

22 
funi
 
	$nify_vify
() {

23 if(
$this
->
t
 == "https") {

24 
$vyfy_u
 = 
$this
->
geway
. "rviify_vify" ."&r=" .$this->
r
. "&nify_id=".
$_POST
["notify_id"];

26 
$vyfy_u
 = 
$this
->
geway
. "r=".$this->
r
."&nify_id=".
$_POST
["notify_id"];

28 
$vyfy_su
 = 
$this
->
	`g_vify
(
$vyfy_u
);

29 
$po
 = 
$this
->
	`_fr
(
$_POST
);

30 
$st_po
 = 
$this
->
	`g_st
(
$po
);

31 
	`li
 (
$key
, 
$v

	`ch
 (
$st_po
)) {

32 
$g
.=
$key
."=".
$v
."&";

34 
$er
 = 
	`subr
(
$g
,0,
	`cou
($arg)-2);

35 
$this
->
mysign
 = $this->
	`sign
(
$er
.$this->
cury_code
);

36 i(
	`egi
("ue$",
$vyfy_su
&& 
$this
->
mysign
 =
$_POST
["sign"]) {

37  
ue
;

38 }  
l
;

39 
	}
}

40 
funi
 
	$tu_vify
() {

41 
$st_g

$this
->
	`g_st
(
$_GET
);

42 
	`li
 (
$key
, 
$v

	`ch
 (
$st_g
)) {

43 if(
$key
 != "sign" && $key != "sign_type")

44 
$g
.=
$key
."=".
$v
."&";

46 
$er
 = 
	`subr
(
$g
,0,
	`cou
($arg)-2);

47 
$this
->
mysign
 = $this->
	`sign
(
$er
.$this->
cury_code
);

51 
	`log_su
("tu_u_log=".
$_GET
["sign"]."&".
$this
->
mysign
."&".$this->
	`cht_decode
(
	`imode
(",",$_GET),$this->
_put_cht
 ));

52 i(
$this
->
mysign
 =
$_GET
["sign"] 
ue
;

53  
l
;

54 
	}
}

56 
funi
 
g_vify
(
$u
,
$time_out
 = "60") {

57 
$ur
 = 
r_u
(
$u
);

58 
	g$o
 = "";

59 
	g$rr
 = "";

60 
	g$ts
 = "";

61 if(
	g$ur
["scheme"] == "https") {

62 
$ts
 = "ssl://";

63 
	g$ur
["port"] = "443";

65 
	g$ts
 = "tcp://";

66 
	g$ur
["port"] = "80";

68 
	g$
=@
fsockݒ
(
$ts
 . 
$ur
['ho'],$ur['pt'],
$o
,
$rr
,
$time_out
);

69 if(!
	g$
) {

70 
d
("ERROR: $errno - $errstr<br />\n");

72 
uts
(
$
, "POST ".
$ur
["path"]." HTTP/1.1\r\n");

73 
uts
(
$
, "Ho: ".
$ur
["host"]."\r\n");

74 
uts
(
$
, "Content-type:pplication/x-www-form-urlencoded\r\n");

75 
uts
(
$
, "Cڋ-ngth: ".

(
$ur
["query"])."\r\n");

76 
uts
(
$
, "Connection: close\r\n\r\n");

77 
uts
(
$
, 
$ur
["query"] . "\r\n\r\n");

78 !
of
(
$
)) {

79 
	g$fo
[]=@
fgs
(
$
, 1024);

82 
fo
(
$
);

83 
	g$fo
 = 
imode
(",",
$fo
);

84 
li
 (
$key
, 
$v

ch
 (
$_POST
)) {

85 
$g
.=
$key
."=".
$v
."&";

89 
log_su
("nify_u_log=".
$u
.
$this
->
cht_decode
(
$fo
,$this->
_put_cht
));

90 
log_su
("nify_u_log=".
$this
->
cht_decode
(
$g
,$this->
_put_cht
));

91  
	g$fo
;

96 
funi
 
	$g_st
(
$y
) {

97 
	`kst
(
$y
);

98 
	`t
(
$y
);

99  
$y
;

101 
	}
}

103 
funi
 
	$sign
(
$er
) {

104 
$sign
='';

105 if(
$this
->
sign_ty
 == 'MD5') {

106 
$sign
 = 
	`md5
(
$er
);

107 }
	`if
(
$this
->
sign_ty
 =='DSA') {

109 
	`d
("DSA 签名方法待后续开发，请先使用MD5签名方式");

111 
	`d
("支付宝暂不支持".
$this
->
sign_ty
."类型的签名方式");

113  
$sign
;

115 
	}
}

116 
funi
 
	$_fr
(
$m
) {

117 
$
 = 
	`y
();

118 
	`li
 (
$key
, 
$v

	`ch
 (
$m
)) {

119 if(
$key
 ="sign" || $key ="sign_ty" || 
$v
 == "");

120 
$
[
$key
] = 
$m
[$key];

123  
$
;

124 
	}
}

127 
funi
 
cht_code
(
$put
,
$_ouut_cht
 ,
$_put_cht
 ="GBK" ) {

128 
$ouut
 = "";

129 if(!
ist
(
$_ouut_cht
)
	g$_ouut_cht
 = 
$this
->
m
['_input_charset '];

130 if(
	g$_put_cht
 =
$_ouut_cht
 || 
$put
 ==
nu
 ) {

131 
$ouut
 = 
$put
;

132 } 
if
 (
funi_exis
("mb_convert_encoding")){

133 
	g$ouut
 = 
mb_cvt_codg
(
$put
,
$_ouut_cht
,
$_put_cht
);

134 } 
if
(
funi_exis
("iconv")) {

135 
	g$ouut
 = 
icv
(
$_put_cht
,
$_ouut_cht
,
$put
);

136 } 
d
("sorry, you haveoibs support for charset change.");

137  
	g$ouut
;

140 
funi
 
cht_decode
(
$put
,
$_put_cht
 ,
$_ouut_cht
="GBK" ) {

141 
$ouut
 = "";

142 if(!
ist
(
$_put_cht
)
	g$_put_cht
 = 
$this
->
_put_cht
 ;

143 if(
	g$_put_cht
 =
$_ouut_cht
 || 
$put
 ==
nu
 ) {

144 
$ouut
 = 
$put
;

145 } 
if
 (
funi_exis
("mb_convert_encoding")){

146 
	g$ouut
 = 
mb_cvt_codg
(
$put
,
$_ouut_cht
,
$_put_cht
);

147 } 
if
(
funi_exis
("iconv")) {

148 
	g$ouut
 = 
icv
(
$_put_cht
,
$_ouut_cht
,
$put
);

149 } 
d
("sorry, you haveoibs support for charset changes.");

150  
	g$ouut
;

	@plus/paycenter/alipay/alipay_service.php

1 <?
php


2 as
	cay_rvi
 {

4 
v
 
	m$geway
 = "https://www.alipay.com/cooperate/gateway.do?";

5 
v
 
	m$m
;

6 
v
 
	m$cury_code
;

7 
v
 
	m$mysign
;

10 
funi
 
ay_rvi
(
$m
,
$cury_code
,
$sign_ty
 = "MD5",
$t
= "https") {

11 
$this
->
m
 = $this->
_fr
(
$m
);

12 
	m$this
->
	mcury_code
 = 
$cury_code
;

13 
	m$this
->
	msign_ty
 = 
$sign_ty
;

14 
	m$this
->
	mmysign
 = '';

15 
	m$this
->
	mt
 = 
$t
;

16 if(
	m$m
['_input_charset'] == "")

17 
$this
->
m
['_input_charset']='GBK';

18 if(
	m$this
->
	mt
 == "https") {

19 
$this
->
geway
 = "https://www.alipay.com/cooperate/gateway.do?";

20 } 
	m$this
->
	mgeway
 = "http://www.alipay.com/cooperate/gateway.do?";

21 
	m$st_y
 = 
y
();

22 
	m$g
 = "";

23 
	m$st_y
 = 
$this
->
g_st
($this->
m
);

24 
li
 (
$key
, 
$v

ch
 (
$st_y
)) {

25 
$g
.=
$key
."=".
$this
->
cht_code
(
$v
,$this->
m
['_input_charset'])."&";

27 
	m$er
 = 
subr
(
$g
,0,
cou
($arg)-2);

28 
	m$this
->
	mmysign
 = 
$this
->
sign
(
$er
.$this->
cury_code
);

32 
funi
 
	$_u
() {

33 
$u
 = 
$this
->
geway
;

34 
$st_y
 = 
	`y
();

35 
$g
 = "";

36 
$st_y
 = 
$this
->
	`g_st
($this->
m
);

37 
	`li
 (
$key
, 
$v

	`ch
 (
$st_y
)) {

38 
$g
.=
$key
."=".
	`ucode
(
$this
->
	`cht_code
(
$v
,$this->
m
['_input_charset']))."&";

40 
$u
.
$g
."sign=" .
$this
->
mysign
 ."&sign_ty=".$this->
sign_ty
;

41  
$u
;

43 
	}
}

45 
funi
 
	$g_st
(
$y
) {

46 
	`kst
(
$y
);

47 
	`t
(
$y
);

48  
$y
;

50 
	}
}

52 
funi
 
	$sign
(
$er
) {

53 
$mysign
 = "";

54 if(
$this
->
sign_ty
 == 'MD5') {

55 
$mysign
 = 
	`md5
(
$er
);

56 }
	`if
(
$this
->
sign_ty
 =='DSA') {

58 
	`d
("DSA 签名方法待后续开发，请先使用MD5签名方式");

60 
	`d
("支付宝暂不支持".
$this
->
sign_ty
."类型的签名方式");

62  
$mysign
;

64 
	}
}

65 
funi
 
	$_fr
(
$m
) {

66 
$
 = 
	`y
();

67 
	`li
 (
$key
, 
$v

	`ch
 (
$m
)) {

68 if(
$key
 ="sign" || $key ="sign_ty" || 
$v
 == "");

69 
$
[
$key
] = 
$m
[$key];

72  
$
;

73 
	}
}

75 
funi
 
cht_code
(
$put
,
$_ouut_cht
 ,
$_put_cht
 ="GBK" ) {

76 
$ouut
 = "";

77 if(!
ist
(
$_ouut_cht
)
	g$_ouut_cht
 = 
$this
->
m
['_input_charset '];

78 if(
	g$_put_cht
 =
$_ouut_cht
 || 
$put
 ==
nu
) {

79 
$ouut
 = 
$put
;

80 } 
if
 (
funi_exis
("mb_convert_encoding")){

81 
	g$ouut
 = 
mb_cvt_codg
(
$put
,
$_ouut_cht
,
$_put_cht
);

82 } 
if
(
funi_exis
("iconv")) {

83 
	g$ouut
 = 
icv
(
$_put_cht
,
$_ouut_cht
,
$put
);

84 } 
d
("sorry, you haveoibs support for charset change.");

85  
	g$ouut
;

	@plus/paycenter/alipay/config_pay_alipay.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/alipay_config.php");

3 
que_
(
dme
(
__FILE__
)."/alipay_service.php");

4 if(
	g$ymt_exp
[2] < 0) $payment_exp[2] = 0;

5 
	g$pii_ex
 = 
$iCou
*
$ymt_exp
[2];

6 
	g$i
 = 
rtf
("%01.2f", 
$iCou
);

7 
	g$m
 = 
y
(

9 "r" => 
$r
,

10 "tu_u" => 
$tu_u
,

11 "nify_u" => 
$nify_u
,

12 "_put_cht" => 
$_put_cht
,

13 "subje" => "支付订单号:".
$OrdsId
,

14 "body" => "支付金额:".
$i
."元",

15 "out_ade_no" => 
$OrdsId
,

20 "i" => 
$i
,

23 "show_u" => 
$show_u
,

24 "Δ_ema" => 
$Δ_ema


27 
	g$ay
 = 
w
 
ay_rvi
(
$m
,
$cury_code
,
$sign_ty
);

28 
	g$lk
 = 
$ay
->
_u
();

30 
	gecho
 '<html>

31 <
	ghd
>

32 <
	gt
>转到支付宝支付页面</title>

33 </
	ghd
>

34 <
body
 
	gLd
="document.alipay.submit();">

35 <
fm
 
me
="ay" 
ai
="'.$lk.'" 
mhod
="post">

36 </
fm
>

37 </
body
>

38 </
html
>';

39 
ex
;

	@plus/paycenter/alipay/notify_url.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/../../../include/common.inc.php");

3 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

4 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

5 
que_
(
dme
(
__FILE__
)."/alipay_config.php");

6 
que_
(
dme
(
__FILE__
)."/alipay_notify.php");

8 
	g$cfg_ml
 = 
w
 
MembLog
();

9 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

10 if(
	g$cfg_ml
->
	gM_ID
>0
	g$bu
 = 
$cfg_baho
."/member/control.php";

11 
	g$bu
 = "javascript:;";

12 
	g$ay
 = 
w
 
ay_nify
(
$r
,
$cury_code
,
$sign_ty
,
$_put_cht
,
$t
);

13 
	g$vify_su
 = 
$ay
->
nify_vify
();

14 if(
	g$vify_su
) {

17 
	g$dgd
 = 
$_POST
['out_trade_no'];

18 
	g$tٮ
 = 
$_POST
['total_fee'];

20 
	g$ive_me
 = 
$_POST
['receive_name'];

21 
	g$ive_addss
 = 
$_POST
['receive_address'];

22 
	g$ive_z
 = 
$_POST
['receive_zip'];

23 
	g$ive_phe
 = 
$_POST
['receive_phone'];

24 
	g$ive_mobe
 = 
$_POST
['receive_mobile'];

26 
	g$ade_us
 = 
$_POST
['trade_status'];

30 if(
	g$_POST
['trade_status'] == 'TRADE_FINISHED') {

32 
$dsql
 = 
w
 
DedeSql
(
l
);

33 
	g$sql
 = "UPDATE `#@__shs_ds` SET `e`='1' WHERE `oid`='$dgd' AND `urid`='".
$cfg_ml
->
M_ID
."';";

34 if(
	g$dsql
->
ExecuNeQuy
(
$sql
)){

35 
	g$dsql
->
Clo
();

36 
	gecho
 "success";

38 
	g$dsql
->
Clo
();

39 
	gecho
 "fail";

43 
log_su
("verify_success");

45 
	gecho
 "fail";

47 
log_su
 ("verify_failed");

49 
funi
 
	$log_su
(
$wd
) {

50 
$
 = 
	`fݒ
("log.txt","a");

51 
	`ock
(
$
, 
LOCK_EX
) ;

52 
	`fwre
(
$
,
$wd
."：执行日期：".
	`rime
("%Y%m%d%H%I%S",
	`time
())."\t\n");

53 
	`ock
(
$
, 
LOCK_UN
);

54 
	`fo
(
$
);

55 
	}
}

	@plus/paycenter/alipay/return_url.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/../../../include/common.inc.php");

3 
que_
 
	gDEDEINC
.'/shopcar.class.php';

4 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

5 
que_
 
	gDEDEROOT
.'/data/sys_pay.cache.php';

6 
que_
(
dme
(
__FILE__
)."/alipay_config.php");

7 
que_
(
dme
(
__FILE__
)."/alipay_notify.php");

8 
	g$cfg_ml
 = 
w
 
MembLog
();

9 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

10 if(
	g$cfg_ml
->
	gM_ID
>0
	g$bu
 = 
$cfg_baho
."/member/control.php";

11 
	g$
 = 
w
 
MembShs
();

12 
	g$
->
MakeOrds
();

13 
	g$bu
 = "javascript:;";

14 
	g$ay
 = 
w
 
ay_nify
(
$r
,
$cury_code
,
$sign_ty
,
$_put_cht
,
$t
);

15 
	g$vify_su
 = 
$ay
->
tu_vify
();

18 
	g$dgd
 = 
$_GET
['out_trade_no'];

19 
	g$tٮ_e
 = 
$_GET
['total_fee'];

21 
	g$ive_me
 = 
$_GET
['receive_name'];

22 
	g$ive_addss
 = 
$_GET
['receive_address'];

23 
	g$ive_z
 = 
$_GET
['receive_zip'];

24 
	g$ive_phe
 = 
$_GET
['receive_phone'];

25 
	g$ive_mobe
 = 
$_GET
['receive_mobile'];

27 if(
	g$vify_su
) {

29 
	g$dsql
 = 
w
 
DedeSql
(
l
);

30 
	g$sql
 = "UPDATE `#@__shs_ds` SET `e`='1' WHERE `oid`='$dgd' AND `urid`='".
$cfg_ml
->
M_ID
."';";

31 if(
	g$dsql
->
ExecuNeQuy
(
$sql
)){

32 
	g$dsql
->
Clo
();

33 
ShowMsg
("支付成功!","javascript:;");

34 
log_su
("verify_success");

35 
	gex
;

37 
	g$dsql
->
Clo
();

38 
ShowMsg
("支付失败","javascript:;");

39 
	gex
;

43 
	g$msg
 = "支付失败.";

44 
ShowMsg
(
$msg
,"javascript:;");

46 
log_su
 ("verify_failed");

47 
	gex
;

50 
funi
 
	$log_su
(
$wd
) {

51 
$
 = 
	`fݒ
("log.txt","a");

52 
	`ock
(
$
, 
LOCK_EX
) ;

53 
	`fwre
(
$
,
$wd
."：执行日期：".
	`rime
("%Y%m%d%H%I%S",
	`time
())."\t\n");

54 
	`ock
(
$
, 
LOCK_UN
);

55 
	`fo
(
$
);

56 
	}
}

	@plus/paycenter/cbpayment/autoreceive.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/cbpayment_config.php");

3 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

4 
	g$cfg_ml
 = 
w
 
MembLog
();

5 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

7 
	g$v_oid
 =
im
(
$_POST
['v_oid']);

8 
	g$v_pmode
 =
im
(
$_POST
['v_pmode']);

9 
	g$v_pus
 =
im
(
$_POST
['v_pstatus']);

10 
	g$v_prg
 =
im
(
$_POST
['v_pstring']);

11 
	g$v_amou
 =
im
(
$_POST
['v_amount']);

12 
	g$v_meyty
 =
im
(
$_POST
['v_moneytype']);

13 
	g$mk1
 =
im
(
$_POST
['remark1' ]);

14 
	g$mk2
 =
im
(
$_POST
['remark2' ]);

15 
	g$v_md5r
 =
im
(
$_POST
['v_md5str' ]);

17 
	g$md5rg
=
ou
(
md5
(
$v_oid
.
$v_pus
.
$v_amou
.
$v_meyty
.
$key
));

18 i(
	g$v_md5r
==
$md5rg
)

20 if(
$v_pus
=="20")

22 
$dsql
 = 
w
 
DedeSql
(
l
);

23 
	g$buyid
 = 
$v_oid
;

25 
	g$row
 = 
$dsql
->
GO
("Select * From #@__member_operation where buyid='$buyid' ");

26 if(!
is_y
(
$row
)||
	g$row
['sta']==2){

27 
$dfo
 = 
$row
['oldinfo'];

29 
	g$mid
 = 
$row
['mid'];

30 
	g$pid
 = 
$row
['pid'];

32 
	g$dsql
->
ExecuNeQuy
("Update #@__member_operation set sta=1 where buyid='$buyid' ");

36 if(
	g$row
['product']=='member')

38 
$row
 = 
$dsql
->
GO
(" Selectank,exptime From #@__member_type whereid='{$row['pid']}' ");

39 
	g$nk
 = 
$row
['rank'];

40 
	g$exime
 = 
$row
['exptime'];

41 
	g$equy
 = " Update #@__member set 

42 
membty
='$nk',
	gexime
='$exime',
	guime
='".time()."' 
whe
 
mid
='$mid' ";

43 
$dsql
->
ExecuNeQuy
(
$equy
);

45 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='会员升级成功！' where buyid='$buyid' ");

46 
	g$cfg_ml
->
FushCache
();

47 
	g$dsql
->
Clo
();

50 if(
	g$row
['product']=='card')

52 
$row
 = 
$dsql
->
GO
("Select cardid From #@__moneycard_record where ctid='$pid' And isexp='0' ");

54 if(!
is_y
(
$row
)){

55 
	g$ow
 = 
$dsql
->
GO
("Selectum From #@__moneycard_type whereid='$pid' ");

56 
	g$dnum
 = 
$ow
['num'];

57 
	g$equy
 = " Upd#@__memb s mey=mey+".
$dnum
." where mid='$mid' ";

58 
	g$dsql
->
ExecuNeQuy
(
$equy
);

59 
	g$cfg_ml
->
FushCache
();

61 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='直接充值了 {$dnum} 金币到帐号！' where buyid='$buyid' ");

62 
ex
();

64 
	g$rdid
 = 
$row
['cardid'];

65 
	g$dsql
->
ExecuNeQuy
(" Upd#@__meyrd_cd s uid='$mid',ixp='1',utime='".
time
()."' where cardid='$cardid' ");

67 
	g$dsql
->
ExecuNeQuy
(" Update #@__member_operation set sta=2,oldinfo='充值密码：{$cardid}' where buyid='$buyid' ");

70 
	g$dsql
->
Clo
();

72 
	gecho
 "ok";

74 
	gecho
 "error";

	@plus/paycenter/cbpayment/cbpayment_config.php

1 <?
php


3 
	g$v_mid
 = 
$ymt_urid
[3];

4 
	g$v_u
 = 
$cfg_baho
.'/plus/paycenter/cbpayment/receive.php';

5 
	g$key
 = 
$ymt_key
[3];

6 
	g$v_meyty
 = 'CNY';

7 
	g$v_rcvema
 = 
$ymt_ema
[3];

8 
	g$v_po_u
 = 'https://pay3.chinabank.com.cn/PayGate';

	@plus/paycenter/cbpayment/config_pay_cbpayment.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/cbpayment_config.php");

3 if(
	g$ymt_exp
[3] < 0) $payment_exp[3] = 0;

4 
	g$pii_ex
 = 
$iCou
*
$ymt_exp
[3];

5 
	g$v_oid
 = 
im
(
$OrdsId
);

6 if(
	g$pii_ex
 > 0
	g$iCou
 = 
$iCou
+
$pii_ex
;

7 
	g$v_amou
 = 
rtf
("%01.2f", 
$iCou
);

9 
	g$xt
 = 
$v_amou
.
$v_meyty
.
$v_oid
.
$v_mid
.
$v_u
.
$key
;

10 
	g$v_md5fo
 = 
ou
(
md5
(
$xt
));

12 
	g$mk1
 = "支付订单号:".
$v_oid
;

13 
	g$mk2
 = "订单总价格:".
$v_amou
."元";

15 
	g$v_rcvme
 = '站长';

16 
	g$v_rcvaddr
 = '深圳';

17 
	g$v_rcvl
 = '0755-83791960';

18 
	g$v_rcvpo
 = '100080';

19 
	g$v_rcvmobe
 = '13838384381';

30 
	g$rRequeU
 = 
$v_po_u
.'?v_mid='.
$v_mid
.'&v_oid='.
$v_oid
.'&v_amou='.
$v_amou
.'&v_meyty='.
$v_meyty


31 .'&v_u='.
$v_u
.'&v_md5fo='.
$v_md5fo
.'&mk1='.
$mk1
.'&mk2='.
$mk2
;

33 
	gecho
 '<html>

34 <
	ghd
>

35 <
	gt
>转到网银在线支付页面</title>

36 </
	ghd
>

37 <
body
 
	gLd
="document.cbpayment.submit();">

38 <
fm
 
me
="cbymt" 
ai
="'.$rRequeU.'" 
mhod
="post">

39 </
fm
>

40 </
body
>

41 </
html
>';

42 
ex
;

	@plus/paycenter/cbpayment/receive.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/../../../include/common.inc.php");

3 
que_
 
	gDEDEINC
.'/shopcar.class.php';

4 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

5 
que_
 
	gDEDEROOT
.'/data/sys_pay.cache.php';

6 
que_
(
dme
(
__FILE__
)."/cbpayment_config.php");

7 
	g$cfg_ml
 = 
w
 
MembLog
();

8 
	g$
 = 
w
 
MembShs
();

9 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

10 if(
	g$cfg_ml
->
	gM_ID
>0
	g$bu
 = 
$cfg_baho
."/member/control.php";

11 
	g$bu
 = "javascript:;";

12 
	g$
->
MakeOrds
();

13 
	g$v_oid
 =
im
(
$_POST
['v_oid']);

14 
	g$v_pmode
 =
im
(
$_POST
['v_pmode']);

15 
	g$v_pus
 =
im
(
$_POST
['v_pstatus']);

16 
	g$v_prg
 =
im
(
$_POST
['v_pstring']);

17 
	g$v_amou
 =
im
(
$_POST
['v_amount']);

18 
	g$v_meyty
 =
im
(
$_POST
['v_moneytype']);

19 
	g$mk1
 =
im
(
$_POST
['remark1' ]);

20 
	g$mk2
 =
im
(
$_POST
['remark2' ]);

21 
	g$v_md5r
 =
im
(
$_POST
['v_md5str' ]);

23 
	g$md5rg
=
ou
(
md5
(
$v_oid
.
$v_pus
.
$v_amou
.
$v_meyty
.
$key
));

25 i(
	g$v_md5r
==
$md5rg
)

27 if(
$v_pus
=="20"){

28 
$sql
 = "UPDATE `#@__shs_ds` SET `e`='1' WHERE `oid`='$v_oid' AND `urid`='".
$cfg_ml
->
M_ID
."';";

29 if(
	g$dsql
->
ExecuNeQuy
(
$sql
)){

30 
ShowMsg
("支付成功!","javascript:;");

31 
	gex
;

33 
ShowMsg
("支付失败","javascript:;");

34 
	gex
;

37 
ShowMsg
("支付失败","javascript:;");

38 
	gex
;

41 
ShowMsg
("校验失败,数据可疑!","javascript:;");

42 
	gex
;

	@plus/paycenter/nps/config_pay_nps.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/nps_config.php");

4 if(
	g$ymt_exp
[1] < 0.01) $payment_exp[1] = 0;

5 
	g$pii_ex
 = 
$iCou
*
$ymt_exp
[1];

6 if(
	g$pii_ex
 > 0
	g$i
 = 
$iCou
+
$pii_ex
;

8 
funi
 
	$HexToS
(
$hex
)

10 
$rg
="";

11 
$i
=0;$i<
	`
(
$hex
)-1;$i+=2){ 
$rg
.=
	`chr
(
	`hexdec
($hex[$i].$hex[$i+1])); }

12  
$rg
;

13 
	}
}

15 
funi
 
	$SToHex
(
$rg
)

17 
$hex
="";

18 
$i
=0;$i<
	`
(
$rg
);$i++){ 
$hex
.=
	`dechex
(
	`d
($string[$i])); }

19 
$hex
=
	`ou
($hex);

20  
$hex
;

21 
	}
}

23 if(!
ist
(
$gePos
)
	g$gePos
 = '';

26 
	g$m_nguage
 = 1;

27 
	g$s_me
 = "陈康";

28 
	g$s_addr
 = "深圳";

29 
	g$s_pocode
 = 518000;

30 
	g$s_l
 = "0755-83791960";

31 
	g$s_eml
 = 
$cfg_y_ema
;

32 
	g$r_me
 = 
$pome
;

33 
	g$r_addr
 = 
$addss
;

34 
	g$r_pocode
 = 
$z
;

35 
	g$r_l
 = 
$l
;

36 
	g$r_eml
 = 
$ema
;

37 
	g$m_us
 = 0;

38 
	g$m_ocucy
 = 1;

40 
	g$m_id
 = 
$cfg_mcht
;

41 
	g$m_did
 = 
$OrdsId
;

42 
	g$m_mou
 = 
$i
;

43 
	g$m_u
 = 
$cfg_baho
."/plus/paycenter/nps/pay_back_nps.php";

44 
	g$m_ocommt
 = 
$cfg_ml
->
M_ID
;

45 
	g$mode
 = 
GDeTimeMk
(
$mtime
);

49 
	g$m_fo
 = 
$m_id
."|".
$m_did
."|".
$m_mou
."|".
$m_ocucy
."|".
$m_u
."|".
$m_nguage
;

50 
	g$s_fo
 = 
$s_me
."|".
$s_addr
."|".
$s_pocode
."|".
$s_l
."|".
$s_eml
;

51 
	g$r_fo
 = 
$r_me
."|".
$r_addr
."|".
$r_pocode
."|".
$r_l
."|".
$r_eml
."|".
$m_ocommt
."|".
$m_us
."|".
$mode
;

53 
	g$OrdInfo
 = 
$m_fo
."|".
$s_fo
."|".
$r_fo
;

56 
	g$OrdInfo
 = 
SToHex
(
$OrdInfo
);

57 
	g$dige
 = 
ou
(
md5
(
$OrdInfo
.
$cfg_msswd
));

59 
	g$rRequeU
 = 
$ymt_u
.'?OrdMesge='.
$OrdInfo
.'&dige='.
$dige
.'&M_ID='.
$cfg_mcht
;

62 
	gecho
 '<html>

63 <
	ghd
>

64 <
	gt
>转到
	gNPS
支付页面</title>

65 </
	ghd
>

66 <
body
 
	gld
="document.nps.submit();">

67 <
fm
 
me
="s" 
ai
="'.$rRequeU.'" 
mhod
="post">

68 </
fm
>

69 </
body
>

70 </
html
>';

71 
ex
;

	@plus/paycenter/nps/nps_config.php

1 <?
php


4 
	g$cfg_mcht
 = 
$ymt_urid
[1];

6 
	g$cfg_msswd
 = 
$ymt_key
[1];

8 
	g$s_eml
 = 
$ymt_ema
[1];

10 
	g$ymt_u
 = 'https://payment.nps.cn/PHPReceiveMerchantAction.do';

	@plus/paycenter/nps/pay_back_nps.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/../../../include/common.inc.php");

3 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

4 
que_
 
	gDEDEROOT
.'/data/sys_pay.cache.php';

5 
que_
(
dme
(
__FILE__
)."/nps_config.php");

6 
que_
 
	gDEDEINC
.'/shopcar.class.php';

8 
	g$
 = 
w
 
MembShs
();

9 
	g$
->
MakeOrds
();

10 
	g$cfg_ml
 = 
w
 
MembLog
();

11 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

12 if(
	g$cfg_ml
->
	gM_ID
>0
	g$bu
 = 
$cfg_baho
."/member/control.php";

13 
	g$bu
 = "javascript:;";

14 if(
emy
(
$_POST
['m_orderid'])){

15 
	gecho
 "非法访问！";

16 
ex
();

19 
	g$membid
 = 
$m_ocommt
;

20 
	g$buyid
 = 
eg_a
("[^-0-9A-Za-z]","",
$m_did
);

21 
	g$mS
 = 
$_POST
['m_status'];

22 
	g$OrdInfo
 = 
$OrdMesge
;

23 
	g$signMsg
 = 
$Dige
;

25 
	g$wmd5fo
 = 
$wmd5fo
;

26 
	g$dige
 = 
ou
(
md5
(
$OrdInfo
.
$cfg_msswd
));

29 
	g$wxt
 = 
$m_id
.
$m_did
.
$m_mou
.
$cfg_msswd
.
$mS
;

30 
	g$myDige
 = 
ou
(
md5
(
$wxt
));

31 
	g$mysign
 =
md5
(
$cfg_mcht
.
$buyid
.
$mey
.
$sucss
.
$cfg_msswd
);

35 if(
	g$dige
 =
$signMsg
 && 
$mS
==2){

36 
$OrdInfo
 = 
HexToS
($OrderInfo);

37 if(
	g$wmd5fo
 =
$myDige
)

39 
$dsql
 = 
w
 
DedeSql
(
l
);

41 
	g$row
 = 
$dsql
->
GO
("Select state From #@__shops_orders where oid='$buyid' ");

42 if(
	g$row
['state'] > 0){

43 
	g$msg
 = "付款已经完成！，系统返回信息( $buyid ) <br><br> <a href='control.php'>返回主页</a> ";

44 
ShowMsg
(
$msg
,"javascript:;");

45 
	g$dsql
->
Clo
();

46 
ex
();

48 
	g$sql
 = "UPDATE `#@__shs_ds` SET `e`='1' WHERE `oid`='$buyid' AND `urid`='".
$cfg_ml
->
M_ID
."';";

49 if(
	g$dsql
->
ExecuNeQuy
(
$sql
)){

50 
	g$dsql
->
Clo
();

51 
ShowMsg
("支付成功!","javascript:;");

52 
	gex
;

54 
	g$dsql
->
Clo
();

55 
ShowMsg
("支付失败","javascript:;");

56 
	gex
;

59 
ShowMsg
("交易密钥错误，请与管理员联系！",
$bu
);

60 
ex
();

63 
ShowMsg
("交易密钥错误，请与管理员联系！",
$bu
);

64 
ex
();

	@plus/paycenter/tenpay/config_pay_tenpay.php

1 <?
php


2 
ude_
(
dme
(
__FILE__
).'/tenpay_config.php');

3 
	g$rCmdNo
 = "1";

4 
	g$rBlDe

de
('Ymd');

6 
	g$rDesc
 = 
$OrdsId
;

8 
	g$rBuyId
 = "";

10 
	g$rS
 = 
$rSpid
;

12 if(
	g$ymt_exp
[0] < 0) $payment_exp[0] = 0;

13 
	g$pii_ex
 = 
$iCou
*
$ymt_exp
[0];

14 if(
	g$pii_ex
 > 0
	g$i
 = 
$iCou
+
$pii_ex
;

15 
	g$i
 = 
$iCou
;

17 
	g$rTٮF
 = 
$i
*100;

18 
	g$rSpBlNo
 = 
$OrdsId
;

20 
	g$rTniId
 = 
$rSpid
 . 
$rBlDe
 . 
time
();

22 
	g$rFTy
 = "1";

24 
	g$rRU
 = 
$cfg_baho
."/plus/paycenter/tenpay/notify_handler.php";

26 
	g$rAach
 = "my_magic_string";

28 
	g$rSignText
 = "cmdno=" . 
$rCmdNo
 . "&de=" . 
$rBlDe
 . "&bga_id=" . 
$rS
 .

29 "&i_id=" . 
$rTniId
 . "&_bo=" . 
$rSpBlNo
 .

30 "&tٮ_e=" . 
$rTٮF
 . "&e_ty=" . 
$rFTy
 . "&tu_u=" . 
$rRU
 .

31 "&ch=" . 
$rAach
 . "&key=" . 
$rSpkey
;

32 
	g$rSign
 = 
ou
(
md5
(
$rSignText
));

35 
	g$rReque
 = "cmdno=" . 
$rCmdNo
 . "&de=" . 
$rBlDe
 . "&bga_id=" . 
$rS
 .

36 "&i_id=" . 
$rTniId
 . "&_bo=" . 
$rSpBlNo
 .

37 "&tٮ_e=" . 
$rTٮF
 . "&e_ty=" . 
$rFTy
 . "&tu_u=" . 
$rRU
 .

38 "&ch=" . 
$rAach
 . "&bk_ty=" . 
$rBkTy
 . "&desc=" . 
$rDesc
 .

39 "&purchar_id=" . 
$rBuyId
 .

40 "&sign=" . 
$rSign
 ;

41 
	g$rRequeU
 = "hps://www.ay.com/cgi-b/v1.0/y_ge.cgi?".
$rReque
;

43 if(
	g$cfg_so_ng
 == 'utf-8')

45 
$rRequeU
 = 
utf82gb
($strRequestUrl);

46 
	gecho
 '<html>

47 <
	ghd
>

48 <
	gt
>转到财付通支付页面</title>

49 </
	ghd
>

50 <
body
 
	gLd
="document.tenpay.submit();">

51 <
fm
 
me
="ay" 
ai
="'.$cfg_baho.'/us/y/ay/ay_gbk_ge.php?rReU='.ucode($rRequeU).'" 
mhod
="post">

52 </
fm
>

53 </
body
>

54 </
html
>';

56 
	gecho
 '<html>

57 <
	ghd
>

58 <
	gt
>转到财付通支付页面</title>

59 </
	ghd
>

60 <
body
 
	gLd
="document.tenpay.submit();">

61 <
fm
 
me
="ay" 
ai
="'.$rRequeU.'" 
mhod
="post">

62 </
fm
>

63 </
body
>

64 </
html
>';

66 
	gex
;

	@plus/paycenter/tenpay/notify_handler.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/../../../include/common.inc.php");

3 
que_
 
	gDEDEINC
.'/shopcar.class.php';

4 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

5 
que_
 
	gDEDEROOT
.'/data/sys_pay.cache.php';

6 
ude_
(
dme
(
__FILE__
).'/tenpay_config.php');

8 
impt_que_vbs
("gpc", "frm_");

9 
	g$cfg_ml
 = 
w
 
MembLog
();

10 
	g$
 = 
w
 
MembShs
();

11 
	g$
->
MakeOrds
();

12 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

13 if(
	g$cfg_ml
->
	gM_ID
>0
	g$bu
 = 
$cfg_baho
."/member/control.php";

14 
	g$bu
 = "javascript:;";

16 
	g$rCmdno
 = 
$m_cmdno
;

17 
	g$rPayResu
 = 
$m_y_su
;

18 
	g$rPayInfo
 = 
$m_y_fo
;

19 
	g$rBlDe
 = 
$m_de
;

20 
	g$rBgaId
 = 
$m_bga_id
;

21 
	g$rTniId
 = 
$m_i_id
;

22 
	g$rSpBo
 = 
$m__bo
;

23 
	g$rTٮF
 = 
$m_tٮ_e
;

24 
	g$rFTy
 = 
$m_e_ty
;

25 
	g$rAach
 = 
$m_ch
;

26 
	g$rMd5Sign
 = 
$m_sign
;

28 
	g$iROK
 = 0;

29 
	g$iInvidSpid
 = 1;

30 
	g$iInvidSign
 = 2;

31 
	g$iTyE
 = 3;

34 
	g$rReڣText
 = "cmdno=" . 
$rCmdno
 . "&y_su=" . 
$rPayResu
 .

35 "&de=" . 
$rBlDe
 . "&i_id=" . 
$rTniId
 .

36 "&_bo=" . 
$rSpBo
 . "&tٮ_e=" . 
$rTٮF
 .

37 "&e_ty=" . 
$rFTy
 . "&ch=" . 
$rAach
 .

38 "&key=" . 
$rSpkey
;

39 
	g$rLolSign
 = 
ou
(
md5
(
$rReڣText
));

41 if
	g$rLolSign
 !
$rMd5Sign
)

43 
$msg
 = "验证MD5签名失败.";

44 
ShowMsg
(
$msg
,"javascript:;");

45 
	gex
;

48 if
	g$rSpid
 !
$rBgaId
 )

50 
$msg
 = "错误的商户号.";

51 
ShowMsg
(
$msg
,"javascript:;");

52 
	gex
;

55 if
	g$rPayResu
 != "0" ){

56 
$msg
 = "支付失败.";

57 
ShowMsg
(
$msg
,"javascript:;");

58 
	gex
;

62 
	g$dsql
 = 
w
 
DedeSql
(
l
);

65 
	g$row
 = 
$dsql
->
GO
("Select state From #@__shops_orders where oid='$strSpBillno' ");

66 if(
	g$row
['state'] > 0){

67 
	g$msg
 = "付款已经完成！，系统返回信息( $buyid ) <br><br> <a href='control.php'>返回主页</a> ";

68 
ShowMsg
(
$msg
,"javascript:;");

69 
	g$dsql
->
Clo
();

70 
ex
();

73 
	g$sql
 = "UPDATE `#@__shs_ds` SET `e`='1' WHERE `oid`='$rSpBo' AND `urid`='".
$cfg_ml
->
M_ID
."';";

74 if(
	g$dsql
->
	$ExecuNeQuy
(
$sql
)){

75 
$dsql
->
	`Clo
();

76 
	`ShowMsg
("支付成功!","javascript:;");

77 
ex
;

78 
	}

	g}
{

79 
	g$dsql
->
Clo
();

80 
ShowMsg
("支付失败","javascript:;");

81 
	gex
;

	@plus/paycenter/tenpay/tenpay_config.php

1 <?
php


4 
	g$rSpid
 = 
$ymt_urid
[0];

6 
	g$rSpkey
 = 
$ymt_key
[0];

17 
	g$rBkTy
 = 
$BkTy
 = 0;

	@plus/paycenter/tenpay/tenpay_gbk_page.php

1 <!
DOCTYPE
 
html
 
	gPUBLIC
 "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

2 <
html
 
	gxms
="http://www.w3.org/1999/xhtml">

3 <
hd
>

4 <
ma
 
hp
-
equiv
="Cڋ-Ty" 
cڋ
="text/html; charset=gb2312" />

5 <
t
>ޱĵ</title>

6 </
hd
>

7 <
body
 
ld
="document.tenpay.submit();">

8 <
fm
 
me
="ay" 
ai
="<?phechudecode($_REQUEST['rReU']);?>" 
mhod
="post">

9 </
fm
>

10 </
body
>

11 </
body
>

12 </
html
>

	@plus/paycenter/yeepay/callback.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../../../include/common.inc.php");

3 
que_
 
	gDEDEINC
.'/shopcar.class.php';

4 
que_
 
	gDEDEDATA
.'/sys_pay.cache.php';

5 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

6 
ude_
(
dme
(
__FILE__
).'/yeepay_config.php');

7 
	g$cfg_ml
 = 
w
 
MembLog
();

8 
	g$cfg_ml
->
PutLogInfo
(
$cfg_ml
->
M_ID
);

9 
	g$
 = 
w
 
MembShs
();

10 
	g$
->
MakeOrds
();

12 ##支付成功回调有两次，都会通知到在线支付请求参数中的
p8_U
上：浏览器重定向;服务器点对点通讯.

15 
	g$tu
 = 
gClBackVue
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
,
$hmac
);

17 #判断返回签名是否正确（
True
/
F
）

18 
	g$bR
 = 
CheckHmac
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
,
$hmac
);

21 if(
	g$bR
)

23 if(
	g$r1_Code
=="1")

28 if(
$r9_BTy
=="1")

30 
sucss_db
(
$r6_Ord
);

32 
if
(
$r9_BTy
=="2")

34 #如果需要应答机制则必须回写流,以
sucss
开头,大小写不敏感.

35 
echo
 "success";

36 
sucss_db
(
$r6_Ord
);

38 
if
(
$r9_BTy
=="3")

40 
sucss_db
(
$r6_Ord
);

42 
ShowMsg
('支付成功!',"javascript:;");

43 
	gex
;

49 
ShowMsg
('交易信息被篡!',"javascript:;");

50 
	gex
;

53 
funi
 
	$sucss_db
(
$buyid
)

55 
glob
 
$dsql
,
$cfg_ml
,
$r3_Amt
;

56 
$mey
 = 
	`o
(
$r3_Amt
);

58 
$row
 = 
$dsql
->
	`GO
("Select state From #@__shops_orders where oid='$buyid' ");

59 if(
$row
['state'] > 0)

64 
$sql
 = "UPDATE `#@__shs_ds` SET `e`='1' WHERE `oid`='$buyid' AND `urid`='".
$cfg_ml
->
M_ID
."';";

65 if(
$dsql
->
	`ExecuNeQuy
(
$sql
))

74 
	}
}

	@plus/paycenter/yeepay/config_pay_yeepay.php

1 <?
php


2 
ude_
(
dme
(
__FILE__
).'/yeepay_config.php');

4 if(
	g$ymt_exp
[4] < 0) $payment_exp[4] = 0;

5 
	g$pii_ex
 = 
$iCou
*
$ymt_exp
[4];

7 if(
	g$pii_ex
 > 0
	g$i
 = 
$iCou
+
$pii_ex
;

8 
	g$i
 = 
$iCou
;

10 ##易宝支付平台统一使用
GBK
/
GB2312
编码方式,参数如用到中文，请注意转码

14 
	g$p2_Ord
 = 
im
(
$OrdsId
);

18 
	g$p3_Amt
 = 
$i
;

21 
	g$p4_Cur
 = "CNY";

25 
	g$p5_Pid
 = 
im
(
$OrdsId
);

28 
	g$p6_Pt
 = 'cart';

31 
	g$p7_Pdesc
 = '';

34 
	g$p8_U
 = 
$cfg_baho
.'/plus/paycenter/yeepay/callback.php';

37 ##商户可以任意填写1
K
 的字符串,支付成功时将原样返回.

38 
	g$_MP
 = 'member';

42 
	g$_NdReڣ
 = 1;

46 
	g$pd_FId
 = '';

48 
	g$hmac
 = 
gReqHmacSg
(
$p2_Ord
,
$p3_Amt
,
$p4_Cur
,
$p5_Pid
,
$p6_Pt
,
$p7_Pdesc
,
$p8_U
,
$_MP
,
$pd_FId
,
$_NdReڣ
);

49 
	g$qURL_LeCmd
 = 
$cfg_baho
.'/plus/paycenter/yeepay/yeepay_gbk.php';

50 
	gecho
 '

51 <
	ghtml
>

52 <
	ghd
>

53 <
	gt
>
To
 
YPay
 
	gPage
</title>

54 <
body
 
	gld
="document.yeepay.submit();">

55 <
fm
 
me
="yy" 
ai
="'.$qURL_LeCmd.'" 
mhod
="post">

56 <
put
 
ty
="hidd" 
me
="p0_Cmd" 
vue
="'.$p0_Cmd.'">

57 <
put
 
ty
="hidd" 
me
="p1_MId" 
vue
="'.$p1_MerId.'">

58 <
put
 
ty
="hidd" 
me
="p2_Ord" 
vue
="'.$p2_Order.'">

59 <
put
 
ty
="hidd" 
me
="p3_Amt" 
vue
="'.$p3_Amt.'">

60 <
put
 
ty
="hidd" 
me
="p4_Cur" 
vue
="'.$p4_Cur.'">

61 <
put
 
ty
="hidd" 
me
="p5_Pid" 
vue
="'.$p5_Pid.'">

62 <
put
 
ty
="hidd" 
me
="p6_Pt" 
vue
="'.$p6_Pcat.'">

63 <
put
 
ty
="hidd" 
me
="p7_Pdesc" 
vue
="'.$p7_Pdesc.'">

64 <
put
 
ty
="hidd" 
me
="p8_U" 
vue
="'.$p8_Url.'">

65 <
put
 
ty
="hidd" 
me
="p9_SAF" 
vue
="'.$p9_SAF.'">

66 <
put
 
ty
="hidd" 
me
="_MP" 
vue
="'.$pa_MP.'">

67 <
put
 
ty
="hidd" 
me
="pd_FId" 
vue
="'.$pd_FrpId.'">

68 <
put
 
ty
="hidd" 
me
="_NdReڣ" 
vue
="'.$pr_NeedResponse.'">

69 <
put
 
ty
="hidd" 
me
="hmac" 
vue
="'.$hmac.'">

70 <
put
 
ty
="hidd" 
me
="ng" 
vue
="'.$cfg_soft_lang.'">

71 <
put
 
ty
="hidd" 
me
="qURL_Le" 
vue
="'.$reqURL_onLine.'">

72 </
fm
>

73 </
body
>

74 </
html
>';exit;

	@plus/paycenter/yeepay/yeepay_config.php

1 <?
php


2 
	g$p1_MId
 = 
$ymt_urid
[4];

3 
	g$mchtKey
 = 
$ymt_key
[4];

6 
	g$qURL_Le
 = "https://www.yeepay.com/app-merchant-proxy/node";

11 
	g$p0_Cmd
 = 'Buy';

15 
	g$p9_SAF
 = "0";

19 
funi
 
	$gReqHmacSg
(
$p2_Ord
,
$p3_Amt
,
$p4_Cur
,
$p5_Pid
,
$p6_Pt
,
$p7_Pdesc
,
$p8_U
,
$_MP
,
$pd_FId
,
$_NdReڣ
)

21 
glob
 
$p0_Cmd
,
$p9_SAF
,
$p1_MId
,
$mchtKey
;

24 
$sbOld
 = "";

26 
$sbOld
 = $sbOld.
$p0_Cmd
;

28 
$sbOld
 = $sbOld.
$p1_MId
;

30 
$sbOld
 = $sbOld.
$p2_Ord
;

32 
$sbOld
 = $sbOld.
$p3_Amt
;

34 
$sbOld
 = $sbOld.
$p4_Cur
;

36 
$sbOld
 = $sbOld.
$p5_Pid
;

38 
$sbOld
 = $sbOld.
$p6_Pt
;

40 
$sbOld
 = $sbOld.
$p7_Pdesc
;

42 
$sbOld
 = $sbOld.
$p8_U
;

44 
$sbOld
 = $sbOld.
$p9_SAF
;

46 
$sbOld
 = $sbOld.
$_MP
;

48 
$sbOld
 = $sbOld.
$pd_FId
;

50 
$sbOld
 = $sbOld.
$_NdReڣ
;

52  
	`HmacMd5
(
$sbOld
,
$mchtKey
);

54 
	}
}

56 
funi
 
	$gClbackHmacSg
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
)

58 
glob
 
$p1_MId
,
$mchtKey
,
$qURL_Le
,
$p9_SAF
;

61 
$sbOld
 = "";

62 #加入商家
ID


63 
$sbOld
 = $sbOld.
$p1_MId
;

65 
$sbOld
 = $sbOld.
$r0_Cmd
;

67 
$sbOld
 = $sbOld.
$r1_Code
;

68 #加入交易
ID


69 
$sbOld
 = $sbOld.
$r2_TrxId
;

71 
$sbOld
 = $sbOld.
$r3_Amt
;

73 
$sbOld
 = $sbOld.
$r4_Cur
;

74 #加入产品
Id


75 
$sbOld
 = $sbOld.
$r5_Pid
;

76 #加入订单
ID


77 
$sbOld
 = $sbOld.
$r6_Ord
;

78 #加入用户
ID


79 
$sbOld
 = $sbOld.
$r7_Uid
;

81 
$sbOld
 = $sbOld.
$r8_MP
;

83 
$sbOld
 = $sbOld.
$r9_BTy
;

85  
	`HmacMd5
(
$sbOld
,
$mchtKey
,'gbk');

87 
	}
}

91 
funi
 
	$gClBackVue
(&
$r0_Cmd
,&
$r1_Code
,&
$r2_TrxId
,&
$r3_Amt
,&
$r4_Cur
,&
$r5_Pid
,&
$r6_Ord
,&
$r7_Uid
,&
$r8_MP
,&
$r9_BTy
,&
$hmac
)

93 
$r0_Cmd
 = 
$_REQUEST
['r0_Cmd'];

94 
$r1_Code
 = 
$_REQUEST
['r1_Code'];

95 
$r2_TrxId
 = 
$_REQUEST
['r2_TrxId'];

96 
$r3_Amt
 = 
$_REQUEST
['r3_Amt'];

97 
$r4_Cur
 = 
$_REQUEST
['r4_Cur'];

98 
$r5_Pid
 = 
$_REQUEST
['r5_Pid'];

99 
$r6_Ord
 = 
$_REQUEST
['r6_Order'];

100 
$r7_Uid
 = 
$_REQUEST
['r7_Uid'];

101 
$r8_MP
 = 
$_REQUEST
['r8_MP'];

102 
$r9_BTy
 = 
$_REQUEST
['r9_BType'];

103 
$hmac
 = 
$_REQUEST
['hmac'];

104  
nu
;

105 
	}
}

107 
funi
 
	$CheckHmac
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
,
$hmac
)

109 if(
$hmac
 =
	`gClbackHmacSg
(
$r0_Cmd
,
$r1_Code
,
$r2_TrxId
,
$r3_Amt
,
$r4_Cur
,
$r5_Pid
,
$r6_Ord
,
$r7_Uid
,
$r8_MP
,
$r9_BTy
))

110  
ue
;

112  
l
;

113 
	}
}

115 
funi
 
HmacMd5
(
$da
,
$key
,
$ng
='utf-8')

123 if(
$GLOBALS
['cfg_so_ng'] !'utf-8' || 
$ng
!='utf-8'){

124 if(!
funi_exis
('iconv')){

125 
ex
('Not install iconvib!');

127 
	g$key
 = 
icv
("GB2312","UTF-8//IGNORE",
$key
);

128 
	g$da
 = 
icv
("GB2312","UTF-8//IGNORE",
$da
);

131 
	g$b
 = 64;

132 i(

(
$key
> 
	g$b
) {

133 
	g$key
 = 
ck
("H*",
md5
(
$key
));

135 
	g$key
 = 
r_d
(
$key
, 
$b
, 
chr
(0x00));

136 
	g$ad
 = 
r_d
('', 
$b
, 
chr
(0x36));

137 
	g$ad
 = 
r_d
('', 
$b
, 
chr
(0x5c));

138 
	g$k_ad
 = 
$key
 ^ 
$ad
 ;

139 
	g$k_ad
 = 
$key
 ^ 
$ad
;

141  
md5
(
$k_ad
 . 
ck
("H*",md5(
$k_ad
 . 
$da
)));

	@plus/paycenter/yeepay/yeepay_gbk.php

1 <?
php


3 
unt
(
$GLOBALS
, 
$_ENV
, 
$HTTP_GET_VARS
, 
$HTTP_POST_VARS
, 
$HTTP_COOKIE_VARS
, 
$HTTP_SERVER_VARS
, 
$HTTP_ENV_VARS
);

5 
funi
 
GGPC
(
$k
, 
$v
='R') {

6 
$v
) {

7 'G': 
$v
 = &
$_GET
; ;

8 'P': 
$v
 = &
$_POST
; ;

9 'C': 
$v
 = &
$_COOKIE
; ;

10 'R': 
$v
 = &
$_REQUEST
; ;

12 if(
ist
(
$_POST
['ng']&& 
	g$_POST
['ng'] ='utf-8' && ist(
$v
[
$k
])){

13 if(!
funi_exis
('icv')
ex
('Not install iconvib!');

14 
	g$v
[
$k
] = 
icv
("UTF-8","GB2312//IGNORE",
$v
[$k]);

16  
ist
(
$v
[
$k
]? 
	g$v
[$k] : 
NULL
;

19 
	g$_q
 = 
y
(

23 
fܗch
(
$_q
 
as
 
$k

	g$$k
 = 
GGPC
($k,'P');

26 <
	ghtml
>

27 <
	ghd
>

28 <
	gt
>
To
 
YPay
 
	gPage
</title>

29 <
ma
 
	ghp
-
	gequiv
="Cڋ-Ty" 
cڋ
="text/html; charset=gb2312" />

30 <
body
 
ld
="document.yeepay.submit();">

31 <
fm
 
me
="yy" 
ai
="<?phech$qURL_Le;?>" 
mhod
="post">

32 <
put
 
ty
="hidd" 
me
="p0_Cmd" 
vue
="<?phpcho $p0_Cmd?>">

33 <
put
 
ty
="hidd" 
me
="p1_MId" 
vue
="<?phpcho $p1_MerId?>">

34 <
put
 
ty
="hidd" 
me
="p2_Ord" 
vue
="<?phpcho $p2_Order?>">

35 <
put
 
ty
="hidd" 
me
="p3_Amt" 
vue
="<?phpcho $p3_Amt?>">

36 <
put
 
ty
="hidd" 
me
="p4_Cur" 
vue
="<?phpcho $p4_Cur?>">

37 <
put
 
ty
="hidd" 
me
="p5_Pid" 
vue
="<?phpcho $p5_Pid?>">

38 <
put
 
ty
="hidd" 
me
="p6_Pt" 
vue
="<?phpcho $p6_Pcat?>">

39 <
put
 
ty
="hidd" 
me
="p7_Pdesc" 
vue
="<?phpcho $p7_Pdesc?>">

40 <
put
 
ty
="hidd" 
me
="p8_U" 
vue
="<?phpcho $p8_Url?>">

41 <
put
 
ty
="hidd" 
me
="p9_SAF" 
vue
="<?phpcho $p9_SAF?>">

42 <
put
 
ty
="hidd" 
me
="_MP" 
vue
="<?phpcho $pa_MP?>">

43 <
put
 
ty
="hidd" 
me
="pd_FId" 
vue
="<?phpcho $pd_FrpId?>">

44 <
put
 
ty
="hidd" 
me
="_NdReڣ" 
vue
="<?phpcho $pr_NeedResponse?>">

45 <
put
 
ty
="hidd" 
me
="hmac" 
vue
="<?phpcho $hmac?>">

46 </
fm
>

47 </
body
>

48 </
html
>

	@plus/posttocar.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/../include/common.inc.php");

3 
que_
 
	gDEDEINC
.'/shopcar.class.php';

4 
	g$
 = 
w
 
MembShs
();

6 
	g$do
 = 
ist
(
$do
? 
	$im
(
$do
) : 'add';

8 if(
$do
 == 'add')

13 
$buynum
 = 
	`ist
($buynum&& 
	`is_numic
($buynum) ? $buynum : 1;

14 
$id
 = 
	`tv
($id);

15 
$buynum
 = ($buynum < 1) ? 1 : $buynum;

16 
$rs
 = 
$dsql
->
	`GO
("SELECT id,channel,title FROM #@__archives WHERE id='$id'");

17 if(!
	`is_y
(
$rs
))

19 
	`ShowMsg
("该商品已不存在！","-1");

20 
	`ex
();

22 
$s
 = 
	`GChlTab
(
$rs
['channel']);

23 
$rows
 = 
$dsql
->
	`GO
("SELECTids id,truepricesrice,units FROM `$cts[addtable]` WHEREid='$id'");

24 if(!
	`is_y
(
$rows
))

26 
	`ShowMsg
("该商品已不存在！","-1");

27 
	`ex
();

29 
$rows
['buynum'] = 
$buynum
;

30 
$rows
['t'] = 
$rs
['title'];

31 
$
->
	`addIm
(
$id
, 
$rows
);

32 
	`ShowMsg
("已添加加到购物车,<a href='car.php'>查看购物车</a>","car.php");

33 
	`ex
();

34 
	}
}

35 
if
(
$do
 == 'del')

40 if(!
ist
(
$ids
))

42 
ShowMsg
("请选择要删除的商品！","-1");

43 
	gex
;

45 if(
is_y
(
$ids
))

47 
fܗch
(
$ids
 
as
 
$id
)

49 
	g$id
 = 
tv
(
$id
);

50 
	g$
->
dIm
(
$id
);

55 
	g$ids
 = 
tv
(
$ids
);

56 
	g$
->
dIm
(
$ids
);

58 
ShowMsg
("已成功删除购物车中的商品,<a href='car.php'>查看购物车</a>","car.php");

59 
	gex
;

61 
if
(
$do
 == 'clear')

66 
$
->
rIm
();

67 
ShowMsg
("购物车中商品已全部清空！","car.php");

68 
	gex
;

70 
if
(
$do
 == 'update')

75 if(
ist
(
$ids
&& 
is_y
($ids))

77 
fܗch
(
$ids
 
as
 
$id
){

78 
$id
 = 
tv
($id);

79 
	g$rs
 = 
$dsql
->
GO
("SELECT id,channel,title FROM #@__archives WHERE id='$id'");

80 if(!
is_y
(
$rs
)) ;

81 
	g$s
 = 
GChlTab
(
$rs
['channel']);

82 
	g$rows
 = 
$dsql
->
GO
("SELECTids id,truepricesrice,units FROM `$cts[addtable]` WHEREid='$id'");

83 if(!
is_y
(
$rows
)) ;

84 
	g$rows
['buynum'] = 
tv
(
$
{'buynum'.
$id
});

85 if(
	g$rows
['buynum'] < 1)

88 
	g$
->
dIm
(
$id
);

91 
	g$rows
['t'] = 
$rs
['title'];

92 
	g$
->
addIm
(
$id
, 
$rows
);

95 
ShowMsg
("购物车中商品已全部更新！","car.php");

96 
	gex
;

	@plus/recommend.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que_
(
DEDEINC
."/channelunit.class.php");

4 if(!
ist
(
$ai
)
	g$ai
 = '';

6 if(
ist
(
$cID
)
	g$aid
 = $arcID;

7 
	g$cID
 = 
$aid
 = (
ist
($aid&& 
is_numic
($aid) ? $aid : 0);

9 if(
	$emy
(
$aid
)) {

10 
	`ShowMsg
("文档ID不能为空!","-1");

11 
	`ex
();

12 
	}
}

15 if(
	g$ai
=='')

18 
$cRow
 = 
GOArchive
(
$aid
);

19 if(
	g$cRow
['aid']=='') {

20 
ShowMsg
("无法把未知文档推荐给好友!","-1");

21 
ex
();

23 
exa
(
$cRow
, 
EXTR_SKIP
);

27 if(
	g$ai
=='send')

29 if(!
CheckEma
(
$ema
))

31 
echo
 "<script>alert('Email格式不正确!');history.go(-1);</script>";

32 
ex
();

34 
	g$mabody
 = '';

35 
	g$msg
 = 
htmleclchs
(
$msg
);

36 
	g$mat
 = "你的好友给你推荐了一篇文章";

37 
	g$mabody
 .= "$msg \r\n\r\n";

38 
	g$mabody
 .= "Power by http://www.dedecms.com 织梦内容管理系统！";

40 
	g$hds
 = "From: ".
$cfg_admema
."\r\nReply-To: ".$cfg_adminemail;

42 if(
	g$cfg_ndma_bysm
 ='Y' && !
emy
(
$cfg_sm_rv
))

44 
$maty
 = 'TXT';

45 
que_
(
DEDEINC
.'/mail.class.php');

46 
	g$sm
 = 
w
 
sm
(
$cfg_sm_rv
,
$cfg_sm_pt
,
ue
,
$cfg_sm_urma
,
$cfg_sm_sswd
);

47 
	g$sm
->
	gdebug
 = 
l
;

48 
	g$sm
->
ndma
(
$ema
, 
$cfg_sm_urma
, 
$mat
, 
$mabody
, 
$maty
);

52 @
ma
(
$ema
, 
$mat
, 
$mabody
, 
$hds
);

55 
ShowMsg
("成功推荐一篇文章!",
$cu
);

56 
ex
();

60 
ude
(
DEDETEMPLATE
.'/plus/recommend.htm');

	@plus/rss.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 
que_
(
DEDEINC
."/arc.rssview.class.php");

5 
	g$tid
 = 
ist
(
$tid
&& 
is_numic
($tid) ? $tid : 0;

6 if(
	g$tid
==0
d
(" Request Error! ");

8 
	g$rv
 = 
w
 
RssVw
(
$tid
);

9 
	g$rv
->
Diy
();

	@plus/search.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que_
(
DEDEINC
."/arc.searchview.class.php");

5 
	g$gesize
 = (
ist
(
$gesize
&& 
is_numic
($pagesize)) ? $pagesize : 10;

6 
	g$tyid
 = (
ist
(
$tyid
&& 
is_numic
($typeid)) ? $typeid : 0;

7 
	g$chy
 = (
ist
(
$chy
&& 
is_numic
($channeltype)) ? $channeltype : 0;

8 
	g$kwty
 = (
ist
(
$kwty
&& 
is_numic
($kwtype)) ? $kwtype : 1;

9 
	g$mid
 = (
ist
(
$mid
&& 
is_numic
($mid)) ? $mid : 0;

11 if(!
ist
(
$dby
)
	g$dby
='';

12 
	g$dby
 = 
egi_a
('[^a-z]','',
$dby
);

14 if(!
ist
(
$chty
)
	g$chty
 = 'titlekeyword';

15 
	g$chty
 = 
egi_a
('[^a-z]','',
$chty
);

17 if(!
ist
(
$keywd
)
	g$keywd
 = '';

19 
	g$dkeywd
 = 
$keywd
;

21 
	g$keywd
 = 
FrSrch
(
rashes
(
$keywd
));

24 if(
	$emy
(
$tyid
))

26 
$tymeCacheFe
 = 
DEDEROOT
.'/data/cache/typename.inc';

27 if(!
	`fe_exis
(
$tymeCacheFe
|| 
	`femtime
($tymeCacheFe< 
	`time
()-(3600*24) )

29 
$
 = 
	`fݒ
(
DEDEROOT
.'/data/cache/typename.inc', 'w');

30 
	`fwre
(
$
, "<"."?php\r\n");

31 
$dsql
->
	`SQuy
("Select id,typename From `#@__arctype`");

32 
$dsql
->
	`Execu
();

33 
$row
 = 
$dsql
->
	`GAay
())

35 
	`fwre
(
$
, "\$typeArr[{$row['id']}] = '{$row['typename']}';\r\n");

37 
	`fwre
(
$
, '?'.'>');

38 
	`fo
(
$
);

41 
	`que_
(
$tymeCacheFe
);

42 if(
	`ist
(
$tyA
&& 
	`is_y
($typeArr))

44 
	`fܗch
(
$tyA
 
as
 
$id
=>
$tyme
)

46 
$keywdn
 = 
	`r_a
(
$tyme
, ' ', 
$keywd
);

47 if(
$keywd
 !
$keywdn
)

49 
$keywd
 = 
$keywdn
;

50 
$tyid
 = 
$id
;

55 
	}
}

57 
	g$keywd
 = 
addashes
(
_subr
(
$keywd
,30));

59 if(
	g$cfg_nٮlowr
 !='' && 
	$egi
(
$cfg_nٮlowr
,
$keywd
))

61 
	`ShowMsg
("你的搜索关键字中存在非法内容，被系统禁止！","-1");

62 
	`ex
();

63 
	}
}

65 if((
	g$keywd
=='' || 

(
$keywd
)<2&& 
	$emy
(
$tyid
))

67 
	`ShowMsg
('关键字不能小于2个字节！','-1');

68 
	`ex
();

69 
	}
}

72 
	g$lockfe
 = 
DEDEROOT
.'/data/time.lock.inc';

73 if(!
	$fe_exis
(
$lockfe
)) {

74 
$
 = 
	`fݒ
(
$lockfe
,'w');

75 
	`ock
(
$
,1);

76 
	`fwre
(
$
,
	`time
());

77 
	`fo
(
$
);

78 
	}
}

81 if(
emy
(
$ime
)
	g$ime
 = -1;

84 
	g$ime
 = (
is_numic
(
$ime
) ? $starttime : -1);

85 if(
	g$ime
>0)

87 
	g$day
 = 
GMkTime
("2008-1-2 0:0:0") - GetMkTime("2008-1-1 0:0:0");

88 
	g$ime
 = 
time
(- (
$ime
 * 
$day
);

92 
	g$t1
 = 
ExecTime
();

94 
	g$
 = 
w
 
SrchVw
(
$tyid
,
$keywd
,
$dby
,
$chy
,
$chty
,
$ime
,
$gesize
,
$kwty
,
$mid
);

95 
	g$keywd
 = 
$dkeywd
;

96 
	g$
->
Diy
();

	@plus/shops_buyaction.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/../include/common.inc.php");

3 
defe
('_PLUS_TPL_', 
DEDEROOT
.'/templets/plus');

4 
que_
 
	gDEDEINC
.'/dedetemplate.class.php';

5 
que_
 
	gDEDEINC
.'/shopcar.class.php';

6 
que_
 
	gDEDEINC
.'/memberlogin.class.php';

7 
que_
 
	gDEDEROOT
.'/data/sys_pay.cache.php';

9 if(
	g$cfg_mb_ݒ
=='N')

11 
ShowMsg
("系统关闭了会员功能，因此你无法访问此页面！","javascript:;");

12 
ex
();

15 if(
ist
(
$pd_code
&& ist(
$pd_vify
&& 
md5
("ymt".$pd_code.
$cfg_cook_code
) == $pd_verify)

17 
r_r
(
mchSCode
(
$pd_code
,'DECODE'),
$mch_Po
);

18 
fܗch
(
$mch_Po
 
as
 
$k
 => 
$v

$$k
 = $v;

21 
	g$_code
 = '';

22 
fܗch
(
$_REQUEST
 
as
 
$key
 => 
$v
)

24 
$_code
 .= $pr_encode ? "&$key=$val" : "$key=$val";

26 
	g$_code
 = 
r_a
('=', '', 
mchSCode
(
$_code
));

27 
	g$_vify
 = 
md5
("ymt".
$_code
.
$cfg_cook_code
);

29 
	g$cfg_ml
 = 
w
 
MembLog
();

31 if(!
	g$cfg_ml
->
	$IsLog
())

33 
	`ShowMsg
("未登录不充许操作!","javascript:;");

34 
	`ex
();

35 
	}
}

37 
	g$oid
 = 
eg_a
("[^-0-9A-Z]","",
$oid
);

38 if(
	$emy
(
$oid
))

40 
	`ShowMsg
("无效订单号!","javascript:;");

41 
	`ex
();

42 
	}
}

44 
	g$rs
 = 
$dsql
->
GO
("SELECT `oid`,`i`,`cou`,`iCou` FROM `#@__shs_ds` WHERE `oid`='$oid' AND `e`<1 AND urid='".
$cfg_ml
->
M_ID
."' ANDaytype=1 ");

45 if(!
	$is_y
(
$rs
))

47 
	`ShowMsg
("该订单此操作无效!","javascript:;");

48 
	`ex
();

49 
	}
}

51 
	g$OrdsId
 = 
$row
['OrdsId'] = 
$rs
['oid'];

52 
	g$row
['cou'] = 
$rs
['cartcount'];

53 
	g$row
['i'] = 
$rs
['price'];

54 
	g$row
['iCou']
$rs
['priceCount'];

56 
	g$rs
 = 
$dsql
->
GO
("SELECT `csige`,`z`,`addss`,`l`,`ema`,`des` FROM `#@__shs_urfo` WHERE `oid`='$oid' AND urid='".
$cfg_ml
->
M_ID
."'");

57 if(
emy
(
$rs
['consignee']))

59 
ShowMsg
("无效订单!","javascript:;");

60 
ex
();

63 
	g$row
['addss'] = 
$rs
['address'];

64 
	g$row
['z'] = 
$rs
['zip'];

65 
	g$row
['l'] = 
$rs
['tel'];

66 
	g$row
['ema'] = 
$rs
['email'];

67 
	g$row
['des'] = 
rashes
(
$rs
['des']);

68 
	g$row
['pome'] = 
$rs
['consignee'];

70 
	g$couOrds
 = 
$dsql
->
GO
("SELECT SUM(couASumFROM #@__shs_dWHERE urid='".
$cfg_ml
->
M_ID
."'");

71 
	g$dsql
->
ExecuNeQuy
("UPDATE #@__memb_tj SET `sh`='".
$couOrds
['nums']."' WHERE mid='".
$cfg_ml
->
M_ID
."'");

73 
	g$iCou
 = 
rtf
("%01.2f", 
$row
['priceCount']);

74 if(!
	$ist
(
$le_ymt
))

76 
$ymt_li
 = 
	`y
();

77 
	`fܗch
(
$ymt_
 
as
 
$k
 => 
$v
)

79 
$mp_r
['me'] = 
$cfg_y_fo
['me'][
$k
];

80 
$mp_r
['logo'] = 
$cfg_cmh
.'/memb/images/y/'.
$cfg_y_fo
['logo'][
$k
];

81 
$mp_r
['des'] = 
$cfg_y_fo
['des'][
$k
];

82 
$mp_r
['vue'] = 
$v
;

83 
$mp_r
['exp'] = 
	`rtf
("%01.2f", 
$iCou
*
$ymt_exp
[
$k
]);

84 
$ymt_li
[] = 
$mp_r
;

87 
$d
 = 
w
 
	`DedeTeme
();

88 
$d
->
	`Assign
('s',
$row
);

89 
$d
->
	`LdTeme
(
_PLUS_TPL_
.'/shops_buyaction.htm');

90 
$d
->
	`Diy
();

91 
	`ex
();

92 
	}
}

95 if(!
_y
(
$le_ymt
,
$ymt_
))

97 
ShowMsg
("支付接口无效,或没开启！", 'javascript:;');

98 
ex
();

100 
	g$
 = 
w
 
MembShs
();

102 
	g$
->
rIm
();

103 
	g$
->
MakeOrds
();

104 
que_
 
	gDEDEROOT
.'/us/y/'.
	g$le_ymt
.'/config_pay_'.$online_payment.'.php';

105 
ex
();

	@plus/showphoto.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que_
(
DEDEINC
."/channelunit.class.php");

5 if(
ist
(
$cID
)
	g$aid
 = $arcID;

6 
	g$cID
 = 
$aid
 = (
ist
($aid&& 
is_numic
($aid)) ? $aid : 0;

7 if(
	g$aid
==0
d
(" Request Error! ");

10 
	g$
 = '';

11 
	g$cu
 = '';

12 
	g$tid
 = 0;

13 
	g$cRow
 = 
$dsql
->
GO
("Selectrc.title,arc.senddate,arc.arcrank,arc.ismake,arc.money,arc.typeid,tp.topid,tp.typedir,tp.namerule,

14 

.
mese
,.
seu
,.
sh
 
From
 `#@
__chives
` 
c
 

 
jo
 `#@
__y
`

p.
id
rc.
tyid
 
whe
rc.id='$aid'");

15 if(
	$is_y
(
$cRow
))

17 
$
 = 
$cRow
['title'];

18 
$tid
 = 
$cRow
['topid'];

19 
$cu
 = @
	`GFeU
(
$aid
,
$cRow
['tyid'],$cRow['ndde'],
$
,$arcRow['ismake'],$arcRow['arcrank'],

20 
$cRow
['namerule'],$arcRow['typedir'],$arcRow['money'],$arcRow['filename'],$arcRow['moresite'],$arcRow['siteurl'],$arcRow['sitepath']);

21 
	}
}

24 
ShowMsg
('无法浏览未知文档!','-1');

25 
ex
();

27 if(
	$emy
(
$mx
)){ $mx=
$cfg_bum_width
; 
	}
}

28 
$geGuide
 = "";

30 
$row
 = 
$dsql
->
GO
("Select imgurls From `#@__addonimages` whereid='{$aid}'");

31 
$i
 = 0;

32 
$xtSrc
 = '';

33 
$eSrc
 = '';

34 
$d
 = 
w
 
DedeTagP
();

35 
$d
->
LdSour
(
$row
['imgurls']);

36 
fܗch
(
$d
->
CTags
 
as
 
$ag
)

38 if(
$ag
->
GName
()=="img"){

39 if(
$i
==(
$os
-1)){ 
$eSrc
 = 
im
(
$ag
->
GIText
()); }

40 if(
$i
==(
$os
+1)){ 
$xtSrc
 = 
im
(
$ag
->
GIText
()); }

41 
$i
++;

44 
unt
(
$d
);

45 if(
$cfg_mui_se
=='Y'){

46 if(!
eg_mch
("/^hp:/i",
$eSrc
&& !
emy
$eSrc)$eSr
$cfg_baho
.$preSrc;

47 if(!
eg_mch
("/^hp:/i",
$xtSrc
&& !
emy
($xtSrc)$xtSr
$cfg_baho
.$nextSrc;

49 if(
$eSrc
!='')

51 
$geGuide
 ."<hf='showpho.php?aid={$aid}&c=".
ucode
(
$eSrc
)."&os=".(
$os
-1)."'>&lt;&lt;上一幅图片</a> ";

55 
$geGuide
 .= "这是开始";

57 
$xk
 = 'javascript:;';

58 if(
$xtSrc
!='')

60 
$xk
 = "showpho.php?aid={$aid}&c=".
ucode
(
$xtSrc
)."&os=".(
$os
+1);

61 if(
$geGuide
!="") $pageGuide .= " | ";

62 
$geGuide
 ."<hf='showpho.php?aid={$aid}&c=".
ucode
(
$xtSrc
)."&os=".(
$os
+1)."'>下一幅图片&gt;&gt;</a>";

66 
$geGuide
 .= " | 没有了";

68 
que_
(
DEDETEMPLATE
.'/plus/showphoto.htm');

69 
ex
();

	@plus/stow.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

4 
	g$aid
 = ( 
ist
(
$aid
&& 
is_numic
($aid) ) ? $aid : 0;

5 if(
	g$aid
==0)

7 
ShowMsg
('文档id不能为空!','javascript:window.close();');

8 
ex
();

11 
que_
(
DEDEINC
."/memberlogin.class.php");

12 
	g$ml
 = 
w
 
MembLog
();

14 if(
	g$ml
->
	gM_ID
==0)

16 
ShowMsg
('只有会员才允许收藏操作！','javascript:window.close();');

17 
ex
();

22 
	g$cRow
 = 
GOArchive
(
$aid
);

23 if(
	g$cRow
['aid']=='')

25 
ShowMsg
("无法收藏未知文档!","javascript:window.close();");

26 
ex
();

28 
exa
(
$cRow
, 
EXTR_SKIP
);

30 
	g$addtime
 = 
time
();

31 
	g$row
 = 
$dsql
->
GO
("Select * From `#@__member_stow` whereid='$aid' And mid='{$ml->M_ID}' ");

33 if(!
	$is_y
(
$row
))

35 
$dsql
->
	`ExecuNeQuy
(" INSERT INTO `#@__memb_ow`(mid,aid,t,addtimeVALUES ('".
$ml
->
M_ID
."','$aid','".
	`addashes
(
$
)."','$addtime'); ");

36 
	}
}

39 
	g$row
 = 
$dsql
->
GO
("SELECT COUNT(*) ASums FROM `#@__member_stow` WHERE `mid`='{$ml->M_ID}' ");

40 
	g$dsql
->
ExecuNeQuy
("UPDATE #@__memb_tj SET `ow`='$row[nums]' WHERE `mid`='".
$ml
->
M_ID
."'");

42 
ShowMsg
('成功收藏一篇文档！','javascript:window.close();');

	@plus/task.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

3 
que_
(
DEDEINC
.'/dedetag.class.php');

11 if(
emy
(
$
)
	g$
 = 'dede';

12 if(
emy
(
$pwd
)
	g$pwd
 = '';

13 
	g$cfg_sk_pwd
 = 
im
(
$cfg_sk_pwd
);

16 if(!
emy
(
$cfg_sk_pwd
&& 
	g$pwd
 != $cfg_task_pwd)

18 
echo
 (
$
=='js' ? '' : 'notask');

19 
ex
();

23 
	g$ime
 = 
time
();

24 
	g$nfmtime
 = 
GDeTimeMk
(
$ime
);

25 
li
(
$nde
, 
$ime

exode
(' ', 
$nfmtime
);

26 
li
(
$y
, 
$m
, 
$d

exode
('-', 
$nde
);

27 
li
(
$hh
, 
$mm
, 
$ss

exode
(':', 
$ime
);

29 
	g$daylim
 = 24 * 3600;

31 
	g$dsql
->
Execu
('me', 'Select * From `#@__sys_task` where islock=0 order by idsc ');

32 
	g$r
 = 
$dsql
->
	$GAay
())

34 
$ime
 = 
$r
['starttime'];

35 
$dtime
 = 
$r
['endtime'];

37 if(
$r
['ϡrun'] > 
$ime
 && $arr['runtype']==1) ;

39 if(
$dtime
!=0 && $dtim< 
$ime
) ;

41 if(
$ime
!=0 && 
$ime
 < $starttime) ;

43 
$dime
 = 
	`GMkTime
(
$nde
.' '.
$r
['runtime'].':00');

44 
$limtime
 = 
$daylim
 * 
$r
['freq'];

46 
$iy
 = 
l
;

48 if(
$r
['eq'] > 1 && 
$ime
 - $r['ϡrun'] > 
$limtime
 )

50 
$iy
 = 
ue
;

54 
$ndeI
 = 
	`tv

	`r_a
('-', '', 
$nde
) );

55 
$rdeI
 = 
	`tv

	`r_a
('-', '', 
	`GDeMk
(
$r
['lastrun'])) );

56 
	`li
(
$th
, 
$tm

	`exode
(':', 
$r
['runtime']);

57 if(
$ndeI
 > 
$rdeI


58 && (
$hh
 > 
$th
 || ($hh==$th && 
$mm
 >
$tm
) ) )

60 
$iy
 = 
ue
;

64 if(
$iy
)

66 
$dou
 = 
	`im
(
$r
['dourl']);

67 if(!
	`fe_exis
("task/$dourl"))

69 
	`echo
 (
$
=='js' ? '' : 'notask');

70 
	`ex
();

74 
$gCfigS
 = 
	`im
(
$r
['parameter']);

75 
$gSg
 = '';

76 if(
	`eg
('t:', 
$gCfigS
))

78 
$gSgs
 = 
	`y
();

79 
$d
 = 
w
 
	`DedeTagP
();

80 
$d
->
	`SNameS
('t', '<', '>');

81 
$d
->
	`LdSg
(
$gCfigS
);

82 if(
	`is_y
(
$d
->
CTags
))

84 
	`fܗch
(
$d
->
CTags
 
as
 
$k
=>
$ag
)

86 
$gSg
 .($gSg=='' ? '' : '&').
$ag
->
	`GA
('key').'='.
	`ucode
($ctag->GetAtt('value'));

90 
$dsql
->
	`ExecuNeQuy
("Upd`#@__sys_sk` sarun='".
	`time
()."', sta='运行' where id='{$arr['id']}' ");

91 if(
$gSg
 !='' ) 
$dou
 .= '?'.$getString;

92 if(
$
=='js'
	`hd
("location:{$cfg_phpurl}/task/{$dourl}");

93 
echo
 "{$cfg_phpurl}/task/{$dourl}";

94 
	`ex
();

97 
	}
}

98 
echo
 (
$
=='js' ? '' : 'notask');

99 
ex
();

	@plus/task/dede-maketimehtml.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

7 
	g$dsql
->
ExecuNeQuy
("Update `#@__sys_task` set sta='成功' where dourl='dede-maketimehtml.php' ");

8 
	gecho
 "<!--ok-->";

9 
ex
();

	@plus/task/dede-optimize-table.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

6 
	g$dsql
->
ExecuNeQuy
("Update `#@__sys_task` set sta='成功' where dourl='dede-optimize-table.php' ");

7 
	gecho
 "<!--ok-->";

8 
ex
();

	@plus/task/dede-upcache.php

1 <?
php


2 
que_
(
dme
(
__FILE__
).'/../include/common.inc.php');

7 
	g$dsql
->
ExecuNeQuy
("Update `#@__sys_task` set sta='成功' where dourl='dede-upcache.php' ");

8 
	gecho
 "<!--ok-->";

9 
ex
();

	@plus/view.php

1 <?
php


13 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

14 
que_
(
DEDEINC
.'/arc.archives.class.php');

16 
	g$t1
 = 
ExecTime
();

18 if(
	$emy
(
$okvw
))

20 
$okvw
 = '';

21 
	}
}

23 if(
	$ist
(
$cID
))

25 
$aid
 = 
$cID
;

26 
	}
}

28 
	g$cID
 = 
$aid
 = (
ist
($aid&& 
is_numic
($aid)) ? $aid : 0;

29 if(
	g$aid
==0)

31 
d
(" Request Error! ");

34 
	g$c
 = 
w
 
Archives
(
$aid
);

35 if(
	g$c
->
	gIsE
)

37 
PamE
();

41 
	g$edMey
 = 
$c
->
Flds
['money'];

42 
	g$edRk
 = 
$c
->
Flds
['arcrank'];

46 if(
	g$edMey
>0 || 
	g$edRk
>1)

48 
que_
(
DEDEINC
.'/memberlogin.class.php');

49 
	g$cfg_ml
 = 
w
 
MembLog
();

50 
	g$
 = 
$c
->
Flds
['title'];

55 
	g$k
 = 
$cfg_phpu
.'/vw.php?aid='.
$c
->
ArcID
;

56 
	g$cLkt
 = "<hf=\"{$k}\"><u>".
$
."</u></a>";

58 
	g$desti
 = 
$c
->
Flds
["description"];

59 
	g$pubde
 = 
GDeTimeMk
(
$c
->
Flds
["pubdate"]);

62 if((
	g$edRk
>1 && 
	g$cfg_ml
->
	gM_Rk
 < $edRk && 
	g$c
->
	gFlds
['mid']!=
$cfg_ml
->
M_ID
))

64 
$dsql
->
Execu
('me' , "Select * From `#@__arcrank` ");

65 
	g$row
 = 
$dsql
->
GObje
('me'))

67 
$membTys
[
$row
->
nk
] = $row->
membme
;

69 
	g$membTys
[0] = "游客或没权限会员";

70 
	g$msgt
 = "你没有权限浏览文档：{$arctitle} ！";

71 
	g$memsg
 = "这篇文档需要 <fڈc='d'>".
$membTys
[
$edRk
]."</ft> 才能访问，你目前是：<fڈc='d'>".$membTys[
$cfg_ml
->
M_Rk
]."</font> ！";

72 
ude_
(
DEDETEMPLATE
.'/plus/view_msg.htm');

73 
ex
();

77 if
	g$edMey
 > 0 && 
	g$c
->
	gFlds
['mid'] !
$cfg_ml
->
M_ID
)

79 
$sql
 = "Seid,mey From `#@__memb_ݔi` whbuyid='ARCHIVE".
$aid
."' And mid='".
$cfg_ml
->
M_ID
."'";

80 
	g$row
 = 
$dsql
->
GO
(
$sql
);

82 if(!
is_y
(
$row
))

84 if
	g$cfg_ml
->
	gM_Mey
=='' || 
$edMey
 > 
$cfg_ml
->
M_Mey
)

86 
$msgt
 = "你没有权限浏览文档：{$arctitle} ！";

87 
	g$memsg
 = "这篇文档需要 <fڈc='d'>".
$edMey
." 金币</ft> 才能访问，你目前拥有金币：<fڈc='d'>".
$cfg_ml
->
M_Mey
." 个</font> ！";

88 
ude_
(
DEDETEMPLATE
.'/plus/view_msg.htm');

89 
	g$c
->
Clo
();

90 
ex
();

94 
	g$quy
 = "INSERT INTO `#@__member_operation`(mid,oldinfo,money,mtime,buyid,product,pname,sta)

95 
VALUES
 ('".$cfg_ml->M_ID."','$arctitle','$needMoney','".time()."', 'ARCHIVE".$aid."', 'archive','购买文章', 2); ";

96 if(!
	g$dsql
->
ExecuNeQuy
(
$quy
))

98 
ShowMsg
('保存购买记录失败， 请与管理员联系！', '-1');

99 
	gex
;

101 
	g$dsql
->
ExecuNeQuy
("Upd`#@__memb` s mey=mey-$edMey whmid='".
$cfg_ml
->
M_ID
."'");

107 
	g$c
->
Diy
();

	@plus/vote.php

1 <?
php


2 
que
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que
(
DEDEINC
."/dedevote.class.php");

4 if(
emy
(
$do
)
	g$do
 = '';

6 
	g$aid
 = (
ist
(
$aid
&& 
is_numic
($aid)) ? $aid : 0;

7 if(
	g$aid
==0
d
(" Request Error! ");

9 if(
	g$aid
==0)

11 
ShowMsg
("ûָͶƱĿID","-1");

12 
ex
();

14 
	g$vo
 = 
w
 
DedeVe
(
$aid
);

15 
	g$rsmsg
 = '';

17 if(
	g$do
=='send')

19 if(!
emy
(
$veem
))

21 
$rsmsg
 = "<b/>&nb;㷽ŵͶƱ״̬".
$vo
->
SaveVe
(
$veem
)."<br />";

25 
	g$rsmsg
 = "<br />&nbsp;ղûѡκͶƱĿ<br />";

29 
	g$vame
 = 
$vo
->
VeInfos
['votename'];

30 
	g$tٮcou
 = 
$vo
->
VeInfos
['totalcount'];

31 
	g$ime
 = 
GDeMk
(
$vo
->
VeInfos
['starttime']);

32 
	g$dtime
 = 
GDeMk
(
$vo
->
VeInfos
['endtime']);

33 
	g$vٖi
 = 
$vo
->
GVeResu
("98%",30,"30%");

36 
ude
(
DEDETEMPLATE
.'/plus/vote.htm');

	@special/index.php

1 <?
php


2 
que_
(
dme
(
__FILE__
)."/../include/common.inc.php");

3 
que_
(
DEDEINC
."/arc.specview.class.php");

4 if(

(
$t_sh܊ame
)>6
ex
("art_shortnameooong!");

5 
	g$ecfe
 = 
dme
(
__FILE__
)."ec_1".
$t_sh܊ame
;

7 if(
	$fe_exis
(
$ecfe
))

9 
	`ude
(
$ecfe
);

10 
	`ex
();

11 
	}
}

14 
	g$
 = 
w
 
ScVw
();

15 
	g$
->
Diy
();

	@tags.php

1 <?
php


2 
que_
 (
dme
(
__FILE__
) . "/include/common.inc.php");

3 
que_
 (
DEDEINC
 . "/arc.taglist.class.php");

4 
	g$PageNo
 = 1;

6 if(
ist
(
$_SERVER
['QUERY_STRING']))

8 
	g$g
 = 
im
(
$_SERVER
['QUERY_STRING']);

9 
	g$gs
 = 
exode
('/', 
$g
);

10 if(
ist
(
$gs
[1]))

12 
	g$g
 = 
$gs
[1];

14 if(
ist
(
$gs
[2]))

16 
	g$PageNo
 = 
tv
(
$gs
[2]);

21 
	g$g
 = '';

24 
	g$g
 = 
FrSrch
(
udecode
(
$g
));

26 if(
	g$g
 !
addashes
(
$g
))

27 
$g
 = '';

29 if(
	g$g
 == '')

31 
$dli
 = 
w
 
TagLi
(
$g
, 'tag.htm');

35 
	g$dli
 = 
w
 
TagLi
(
$g
, 'taglist.htm');

38 
	g$dli
->
Diy
();

40 
ex
();

	@
1
.
1
/usr/include
491
12986
data/downmix.data.php
data/enums/area.php
data/enums/blood.php
data/enums/bodytype.php
data/enums/cosize.php
data/enums/datingtype.php
data/enums/drink.php
data/enums/education.php
data/enums/house.php
data/enums/income.php
data/enums/infotype.php
data/enums/marital.php
data/enums/nativeplace.php
data/enums/smoke.php
data/enums/star.php
data/enums/system.php
data/enums/test.php
data/enums/vocation.php
data/mark/inc_photowatermark_config.php
data/module/0cce60bc0238aa03804682c801584991-readme.php
data/module/1f35620fb42d452fa2bdc1dee1690f92-readme.php
data/module/572606600345b1a4bb8c810bbae434cc-readme.php
data/module/72ffa6fabe3c236f9238a2b281bc0f93-readme.php
data/module/acb8b88eb4a6d4bfc375c18534f9439e-readme.php
data/module/b437d85a7a7bc778c9c79b5ec36ab9aa-readme.php
data/module/modulescache.php
data/safequestions.php
data/sys_pay.cache.php
data/template.rand.php
dede/ad_add.php
dede/ad_edit.php
dede/ad_main.php
dede/ajax.php
dede/album_add.php
dede/album_edit.php
dede/album_testhtml.php
dede/api_ucenter.php
dede/archives_add.php
dede/archives_do.php
dede/archives_edit.php
dede/archives_sg_add.php
dede/archives_sg_edit.php
dede/article_add.php
dede/article_coonepage_rule.php
dede/article_description_main.php
dede/article_edit.php
dede/article_keywords_main.php
dede/article_keywords_make.php
dede/article_keywords_select.php
dede/article_select_sw.php
dede/article_source_edit.php
dede/article_string_mix.php
dede/article_template_rand.php
dede/article_test_same.php
dede/article_test_title.php
dede/article_writer_edit.php
dede/baidunews.php
dede/cards_make.php
dede/cards_manage.php
dede/cards_type.php
dede/catalog_add.php
dede/catalog_del.php
dede/catalog_do.php
dede/catalog_edit.php
dede/catalog_main.php
dede/catalog_menu.php
dede/catalog_move.php
dede/co_add.php
dede/co_do.php
dede/co_edit.php
dede/co_edit_text.php
dede/co_export.php
dede/co_export_corule.php
dede/co_gather_start.php
dede/co_gather_start_action.php
dede/co_get_corule.php
dede/co_getsource_url_action.php
dede/co_main.php
dede/co_test_rule.php
dede/co_url.php
dede/co_view.php
dede/config.php
dede/content_att.php
dede/content_batch_up.php
dede/content_batchup_action.php
dede/content_i_list.php
dede/content_list.php
dede/content_s_list.php
dede/content_select_list.php
dede/content_sg_list.php
dede/content_tj.php
dede/diy_add.php
dede/diy_edit.php
dede/diy_field_add.php
dede/diy_field_edit.php
dede/diy_list.php
dede/diy_main.php
dede/erraddsave.php
dede/exit.php
dede/feedback_edit.php
dede/feedback_main.php
dede/file_class.php
dede/file_manage_control.php
dede/file_manage_main.php
dede/file_manage_view.php
dede/file_pic_view.php
dede/freelist_action.php
dede/freelist_add.php
dede/freelist_edit.php
dede/freelist_main.php
dede/freemenu_main.php
dede/friendlink_add.php
dede/friendlink_edit.php
dede/friendlink_main.php
dede/friendlink_type.php
dede/getdedesysmsg.php
dede/imagecut.php
dede/inc/inc_admin_channel.php
dede/inc/inc_archives_all.php
dede/inc/inc_archives_functions.php
dede/inc/inc_batchup.php
dede/inc/inc_catalog_options.php
dede/inc/inc_coonepage.php
dede/inc/inc_list_functions.php
dede/inc/inc_menu.php
dede/inc/inc_menu_func.php
dede/inc/inc_menu_map.php
dede/inc/inc_menu_module.php
dede/index.php
dede/index_body.php
dede/index_menu.php
dede/index_menu_load.php
dede/index_menu_module.php
dede/index_top.php
dede/log_edit.php
dede/log_list.php
dede/login.php
dede/makehtml_all.php
dede/makehtml_archives.php
dede/makehtml_archives_action.php
dede/makehtml_freelist.php
dede/makehtml_freelist_action.php
dede/makehtml_homepage.php
dede/makehtml_js.php
dede/makehtml_js_action.php
dede/makehtml_list.php
dede/makehtml_list_action.php
dede/makehtml_map.php
dede/makehtml_map_guide.php
dede/makehtml_rss.php
dede/makehtml_rss_action.php
dede/makehtml_spec.php
dede/media_add.php
dede/media_edit.php
dede/media_main.php
dede/member_do.php
dede/member_main.php
dede/member_mtype.php
dede/member_operations.php
dede/member_pm.php
dede/member_pmall.php
dede/member_rank.php
dede/member_scores.php
dede/member_type.php
dede/member_view.php
dede/module_main.php
dede/module_make.php
dede/module_upload.php
dede/mychannel_add.php
dede/mychannel_edit.php
dede/mychannel_field_add.php
dede/mychannel_field_edit.php
dede/mychannel_main.php
dede/mytag_add.php
dede/mytag_edit.php
dede/mytag_main.php
dede/mytag_tag_guide.php
dede/mytag_tag_guide_ok.php
dede/pic_view.php
dede/plus_edit.php
dede/plus_main.php
dede/public_guide.php
dede/recycling.php
dede/search_keywords_main.php
dede/shops_bank.php
dede/shops_delivery.php
dede/shops_operations.php
dede/shops_operations_cart.php
dede/shops_operations_userinfo.php
dede/soft_add.php
dede/soft_config.php
dede/soft_edit.php
dede/spec_add.php
dede/spec_edit.php
dede/stepselect_main.php
dede/swfupload.php
dede/sys_admin_user.php
dede/sys_admin_user_add.php
dede/sys_admin_user_edit.php
dede/sys_admin_user_tj.php
dede/sys_cache_up.php
dede/sys_data.php
dede/sys_data_done.php
dede/sys_data_replace.php
dede/sys_data_revert.php
dede/sys_group.php
dede/sys_group_add.php
dede/sys_group_edit.php
dede/sys_info.php
dede/sys_info_mark.php
dede/sys_info_pay.php
dede/sys_passport.php
dede/sys_repair.php
dede/sys_safetest.php
dede/sys_sql_query.php
dede/sys_task.php
dede/sys_task_add.php
dede/sys_task_edit.php
dede/sys_verifies.php
dede/tag_test.php
dede/tag_test_action.php
dede/tags_main.php
dede/task_do.php
dede/templets_main.php
dede/templets_one.php
dede/templets_one_add.php
dede/templets_one_edit.php
dede/templets_tagsource.php
dede/testenv.php
dede/tpl.php
dede/update_guide.php
dede/vote_add.php
dede/vote_edit.php
dede/vote_getcode.php
dede/vote_main.php
include/FCKeditor/editor/dialog/dede_addon.php
include/FCKeditor/editor/dialog/dede_image.php
include/FCKeditor/editor/dialog/dede_imageuser.php
include/FCKeditor/editor/dialog/dede_mycode.php
include/FCKeditor/fckeditor.php
include/FCKeditor/index.php
include/arc.archives.class.php
include/arc.caicai.class.php
include/arc.datalist.class.php
include/arc.freelist.class.php
include/arc.listview.class.php
include/arc.memberlistview.class.php
include/arc.partview.class.php
include/arc.rssview.class.php
include/arc.searchview.class.php
include/arc.sglistview.class.php
include/arc.sgpage.class.php
include/arc.specview.class.php
include/arc.taglist.class.php
include/archives.func.php
include/channelunit.class.php
include/channelunit.func.php
include/charset.func.php
include/common.func.php
include/common.inc.php
include/customfields.func.php
include/datalistcp.class.php
include/dedeatt.class.php
include/dedecollection.class.php
include/dedecollection.func.php
include/dedehtml2.class.php
include/dedehttpdown.class.php
include/dedemodule.class.php
include/dedesql.class.php
include/dedetag.class.php
include/dedetemplate.class.php
include/dedevote.class.php
include/dedevote.inc.php
include/dialog/config.php
include/dialog/select_images.php
include/dialog/select_images_post.php
include/dialog/select_media.php
include/dialog/select_media_post.php
include/dialog/select_soft.php
include/dialog/select_soft_post.php
include/dialog/select_templets.php
include/dialog/select_templets_post.php
include/diyform.cls.php
include/downmix.inc.php
include/enums.func.php
include/filter.inc.php
include/image.class.php
include/image.func.php
include/inc/inc_fun_funAdmin.php
include/inc/inc_fun_funString.php
include/inc/inc_stat.php
include/mail.class.php
include/memberlogin.class.php
include/oxwindow.class.php
include/shopcar.class.php
include/sitemap.class.php
include/splitword.class.php
include/taglib/adminname.lib.php
include/taglib/arclist.lib.php
include/taglib/arclistsg.lib.php
include/taglib/ask.lib.php
include/taglib/autochannel.lib.php
include/taglib/bookcontentlist.lib.php
include/taglib/booklist.lib.php
include/taglib/cattree.lib.php
include/taglib/channel.lib.php
include/taglib/channel/img.lib.php
include/taglib/channel/softlinks.lib.php
include/taglib/channel/specialtopic.lib.php
include/taglib/channel/stepselect.lib.php
include/taglib/channelartlist.lib.php
include/taglib/demotag.lib.php
include/taglib/feedback.lib.php
include/taglib/flink.lib.php
include/taglib/group.lib.php
include/taglib/groupthread.lib.php
include/taglib/hotwords.lib.php
include/taglib/infoguide.lib.php
include/taglib/infolink.lib.php
include/taglib/likearticle.lib.php
include/taglib/likepage.lib.php
include/taglib/likesgpage.lib.php
include/taglib/loop.lib.php
include/taglib/memberinfos.lib.php
include/taglib/memberlist.lib.php
include/taglib/myad.lib.php
include/taglib/mytag.lib.php
include/taglib/php.lib.php
include/taglib/softmsg.lib.php
include/taglib/sonchannel.lib.php
include/taglib/sql.lib.php
include/taglib/tag.lib.php
include/taglib/type.lib.php
include/taglib/vote.lib.php
include/tpllib/plus_ask.php
include/tpllib/plus_channel.php
include/tpllib/plus_memberlist.php
include/tpllib/plus_newvisitor.php
include/tpllib/plus_spacenewart.php
include/typelink.class.php
include/typeunit.class.admin.php
include/typeunit.class.menu.php
include/typeunit.class.selector.php
include/uploadsafe.inc.php
include/userlogin.class.php
include/vdimgck.php
include/zip.class.php
index.php
install/common.inc.php
install/config.cache.inc.php
install/index.php
install/install.inc.php
install/module-install.php
install/modulescache.php
member/ajax_feedback.php
member/ajax_loginsta.php
member/album_add.php
member/album_edit.php
member/archives_add.php
member/archives_do.php
member/archives_edit.php
member/archives_sg_add.php
member/archives_sg_edit.php
member/article_add.php
member/article_edit.php
member/buy.php
member/buy_action.php
member/caicai.php
member/check_card.php
member/config.php
member/content_list.php
member/content_sg_list.php
member/control.php
member/edit_baseinfo.php
member/edit_face.php
member/edit_fullinfo.php
member/edit_space_info.php
member/feedback.php
member/flink_main.php
member/guestbook_admin.php
member/inc/archives_check.php
member/inc/archives_check_edit.php
member/inc/config_pay_alipay.php
member/inc/config_pay_cbpayment.php
member/inc/config_pay_nps.php
member/inc/config_pay_tenpay.php
member/inc/config_pay_yeepay.php
member/inc/config_space.php
member/inc/inc_archives_functions.php
member/inc/inc_batchup.php
member/inc/inc_catalog_options.php
member/inc/inc_list_functions.php
member/inc/inc_pwd_functions.php
member/inc/space_action.php
member/index.php
member/index_do.php
member/login.php
member/mtypes.php
member/myfriend.php
member/mypay.php
member/mystow.php
member/operation.php
member/paycenter/alipay/alipay_config.php
member/paycenter/alipay/alipay_notify.php
member/paycenter/alipay/alipay_service.php
member/paycenter/alipay/notify_url.php
member/paycenter/alipay/return_url.php
member/paycenter/cbpayment/autoreceive.php
member/paycenter/cbpayment/cbpayment_config.php
member/paycenter/cbpayment/receive.php
member/paycenter/nps/nps_config.inc.php
member/paycenter/nps/pay_back_nps.php
member/paycenter/tenpay/notify_handler.php
member/paycenter/tenpay/tenpay_gbk_page.php
member/paycenter/yeepay/callback.php
member/paycenter/yeepay/yeepay_config.php
member/paycenter/yeepay/yeepay_gbk.php
member/pm.php
member/reg_new.php
member/resetpassword.php
member/search.php
member/shops_orders.php
member/shops_point.php
member/shops_products.php
member/soft_add.php
member/soft_edit.php
member/spaceskin.php
member/templets/menu.php
member/templets/menulit.php
member/uploads.php
member/uploads_add.php
member/uploads_edit.php
member/uploads_select.php
member/visit-history.php
plus/ad_js.php
plus/advancedsearch.php
plus/car.php
plus/carbuyaction.php
plus/comments_frame.php
plus/count.php
plus/digg_ajax.php
plus/digg_frame.php
plus/disdls.php
plus/diy.php
plus/download.php
plus/erraddsave.php
plus/feedback.php
plus/feedback_ajax.php
plus/feedback_js.php
plus/flink.php
plus/flink_add.php
plus/freelist.php
plus/heightsearch.php
plus/list.php
plus/mytag_js.php
plus/paycenter/alipay/alipay_config.php
plus/paycenter/alipay/alipay_notify.php
plus/paycenter/alipay/alipay_service.php
plus/paycenter/alipay/config_pay_alipay.php
plus/paycenter/alipay/notify_url.php
plus/paycenter/alipay/return_url.php
plus/paycenter/cbpayment/autoreceive.php
plus/paycenter/cbpayment/cbpayment_config.php
plus/paycenter/cbpayment/config_pay_cbpayment.php
plus/paycenter/cbpayment/receive.php
plus/paycenter/nps/config_pay_nps.php
plus/paycenter/nps/nps_config.php
plus/paycenter/nps/pay_back_nps.php
plus/paycenter/tenpay/config_pay_tenpay.php
plus/paycenter/tenpay/notify_handler.php
plus/paycenter/tenpay/tenpay_config.php
plus/paycenter/tenpay/tenpay_gbk_page.php
plus/paycenter/yeepay/callback.php
plus/paycenter/yeepay/config_pay_yeepay.php
plus/paycenter/yeepay/yeepay_config.php
plus/paycenter/yeepay/yeepay_gbk.php
plus/posttocar.php
plus/recommend.php
plus/rss.php
plus/search.php
plus/shops_buyaction.php
plus/showphoto.php
plus/stow.php
plus/task.php
plus/task/dede-maketimehtml.php
plus/task/dede-optimize-table.php
plus/task/dede-upcache.php
plus/view.php
plus/vote.php
special/index.php
tags.php
